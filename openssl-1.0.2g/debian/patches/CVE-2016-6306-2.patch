Backport of:

From 006a788c84e541c8920dd2ad85fb62b52185c519 Mon Sep 17 00:00:00 2001
From: "Dr. Stephen Henson" <steve@openssl.org>
Date: Wed, 21 Sep 2016 13:26:01 +0100
Subject: [PATCH] Make message buffer slightly larger than message.

Grow TLS/DTLS 16 bytes more than strictly necessary as a precaution against
OOB reads. In most cases this will have no effect because the message buffer
will be large enough already.

Reviewed-by: Matt Caswell <matt@openssl.org>
---
 ssl/d1_both.c | 5 ++++-
 ssl/s3_both.c | 6 +++++-
 2 files changed, 9 insertions(+), 2 deletions(-)

Index: openssl-1.0.2g/ssl/d1_both.c
===================================================================
--- openssl-1.0.2g.orig/ssl/d1_both.c	2016-09-22 08:17:38.670702686 -0400
+++ openssl-1.0.2g/ssl/d1_both.c	2016-09-22 08:17:38.666702640 -0400
@@ -581,9 +581,12 @@
         /*
          * msg_len is limited to 2^24, but is effectively checked against max
          * above
+         *
+         * Make buffer slightly larger than message length as a precaution
+         * against small OOB reads e.g. CVE-2016-6306
          */
         if (!BUF_MEM_grow_clean
-            (s->init_buf, msg_len + DTLS1_HM_HEADER_LENGTH)) {
+            (s->init_buf, msg_len + DTLS1_HM_HEADER_LENGTH + 16)) {
             SSLerr(SSL_F_DTLS1_PREPROCESS_FRAGMENT, ERR_R_BUF_LIB);
             return SSL_AD_INTERNAL_ERROR;
         }
Index: openssl-1.0.2g/ssl/s3_both.c
===================================================================
--- openssl-1.0.2g.orig/ssl/s3_both.c	2016-09-22 08:17:38.670702686 -0400
+++ openssl-1.0.2g/ssl/s3_both.c	2016-09-22 08:21:30.269412365 -0400
@@ -420,7 +420,11 @@
             SSLerr(SSL_F_SSL3_GET_MESSAGE, SSL_R_EXCESSIVE_MESSAGE_SIZE);
             goto f_err;
         }
-        if (l && !BUF_MEM_grow_clean(s->init_buf, (int)l + 4)) {
+        /*
+         * Make buffer slightly larger than message length as a precaution
+         * against small OOB reads e.g. CVE-2016-6306
+         */
+        if (l && !BUF_MEM_grow_clean(s->init_buf, (int)l + 4 + 16)) {
             SSLerr(SSL_F_SSL3_GET_MESSAGE, ERR_R_BUF_LIB);
             goto err;
         }
