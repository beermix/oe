Description: fix Memory corruption in the ASN.1 encoder
Origin: backport, c5e4bc81c5a142cab7f46f69824fa35367999ee8
Origin: backport, ddf29e9b413a12b778ae39d3682b99da201540b1

Index: openssl-1.0.2g/crypto/asn1/a_type.c
===================================================================
--- openssl-1.0.2g.orig/crypto/asn1/a_type.c	2016-04-28 09:07:48.943260538 -0400
+++ openssl-1.0.2g/crypto/asn1/a_type.c	2016-04-28 09:07:48.939260479 -0400
@@ -126,9 +126,7 @@
         result = 0;             /* They do not have content. */
         break;
     case V_ASN1_INTEGER:
-    case V_ASN1_NEG_INTEGER:
     case V_ASN1_ENUMERATED:
-    case V_ASN1_NEG_ENUMERATED:
     case V_ASN1_BIT_STRING:
     case V_ASN1_OCTET_STRING:
     case V_ASN1_SEQUENCE:
Index: openssl-1.0.2g/crypto/asn1/asn1.h
===================================================================
--- openssl-1.0.2g.orig/crypto/asn1/asn1.h	2016-04-28 09:07:48.943260538 -0400
+++ openssl-1.0.2g/crypto/asn1/asn1.h	2016-04-28 09:07:48.939260479 -0400
@@ -96,13 +96,11 @@
 # define V_ASN1_OTHER                    -3/* used in ASN1_TYPE */
 # define V_ASN1_ANY                      -4/* used in ASN1 template code */
 
-# define V_ASN1_NEG                      0x100/* negative flag */
-
 # define V_ASN1_UNDEF                    -1
+/* ASN.1 tag values */
 # define V_ASN1_EOC                      0
 # define V_ASN1_BOOLEAN                  1 /**/
 # define V_ASN1_INTEGER                  2
-# define V_ASN1_NEG_INTEGER              (2 | V_ASN1_NEG)
 # define V_ASN1_BIT_STRING               3
 # define V_ASN1_OCTET_STRING             4
 # define V_ASN1_NULL                     5
@@ -111,7 +109,6 @@
 # define V_ASN1_EXTERNAL                 8
 # define V_ASN1_REAL                     9
 # define V_ASN1_ENUMERATED               10
-# define V_ASN1_NEG_ENUMERATED           (10 | V_ASN1_NEG)
 # define V_ASN1_UTF8STRING               12
 # define V_ASN1_SEQUENCE                 16
 # define V_ASN1_SET                      17
@@ -129,6 +126,17 @@
 # define V_ASN1_GENERALSTRING            27 /**/
 # define V_ASN1_UNIVERSALSTRING          28 /**/
 # define V_ASN1_BMPSTRING                30
+
+/*
+ * NB the constants below are used internally by ASN1_INTEGER
+ * and ASN1_ENUMERATED to indicate the sign. They are *not* on
+ * the wire tag values.
+ */
+
+# define V_ASN1_NEG                      0x100
+# define V_ASN1_NEG_INTEGER              (2 | V_ASN1_NEG)
+# define V_ASN1_NEG_ENUMERATED           (10 | V_ASN1_NEG)
+
 /* For use with d2i_ASN1_type_bytes() */
 # define B_ASN1_NUMERICSTRING    0x0001
 # define B_ASN1_PRINTABLESTRING  0x0002
Index: openssl-1.0.2g/crypto/asn1/tasn_dec.c
===================================================================
--- openssl-1.0.2g.orig/crypto/asn1/tasn_dec.c	2016-04-28 09:07:48.943260538 -0400
+++ openssl-1.0.2g/crypto/asn1/tasn_dec.c	2016-04-28 09:07:48.939260479 -0400
@@ -901,9 +901,7 @@
         break;
 
     case V_ASN1_INTEGER:
-    case V_ASN1_NEG_INTEGER:
     case V_ASN1_ENUMERATED:
-    case V_ASN1_NEG_ENUMERATED:
         tint = (ASN1_INTEGER **)pval;
         if (!c2i_ASN1_INTEGER(tint, &cont, len))
             goto err;
Index: openssl-1.0.2g/crypto/asn1/tasn_enc.c
===================================================================
--- openssl-1.0.2g.orig/crypto/asn1/tasn_enc.c	2016-04-28 09:07:48.943260538 -0400
+++ openssl-1.0.2g/crypto/asn1/tasn_enc.c	2016-04-28 09:07:48.939260479 -0400
@@ -611,9 +611,7 @@
         break;
 
     case V_ASN1_INTEGER:
-    case V_ASN1_NEG_INTEGER:
     case V_ASN1_ENUMERATED:
-    case V_ASN1_NEG_ENUMERATED:
         /*
          * These are all have the same content format as ASN1_INTEGER
          */
