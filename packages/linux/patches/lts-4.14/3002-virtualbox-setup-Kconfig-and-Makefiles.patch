From 2418d622309353097625b6cbe57e6c5f253d8e95 Mon Sep 17 00:00:00 2001
From: Miguel Bernal Marin <miguel.bernal.marin@linux.intel.com>
Date: Sun, 15 Apr 2018 12:13:43 -0500
Subject: [PATCH 3002/3002] virtualbox: setup Kconfig and Makefiles

---
 drivers/misc/Kconfig                          | 31 +++++++++++++++++++
 drivers/misc/Makefile                         |  3 ++
 drivers/misc/vboxguest/Makefile               |  1 +
 .../misc/vboxguest/Makefile.include.header    |  6 ++--
 drivers/misc/vboxsf/Makefile                  |  1 +
 drivers/misc/vboxsf/Makefile.include.header   |  6 ++--
 drivers/misc/vboxvideo/Makefile               |  1 +
 .../misc/vboxvideo/Makefile.include.header    |  6 ++--
 8 files changed, 46 insertions(+), 9 deletions(-)

diff --git a/drivers/misc/Kconfig b/drivers/misc/Kconfig
index 8136dc7e863d..251334f909d3 100644
--- a/drivers/misc/Kconfig
+++ b/drivers/misc/Kconfig
@@ -506,6 +506,37 @@ config PCI_ENDPOINT_TEST
            Enable this configuration option to enable the host side test driver
            for PCI Endpoint.
 
+config VBOXGUEST
+	tristate "VirtualBox Guest Addition driver"
+	depends on X86
+	default m
+	help
+	  This is the main driver from VirtualBox Guest Additions.
+
+	  To compile this driver as a module, choose M here: the
+	  module will be called vboxguest.
+
+config VBOXSF
+	tristate "VirtualBox Share Folder driver"
+	depends on X86 && VBOXGUEST
+	default m
+	help
+	  This is the driver to share folders between guest and
+	  host.
+
+	  To compile this driver as a module, choose M here: the
+	  module will be called vboxsf.
+
+config VBOXVIDEO
+	tristate "VirtualBox Video driver"
+	depends on X86 && VBOXGUEST
+	default m
+	help
+	  This is the video driver for VirtualBox VM.
+
+	  To compile this driver as a module, choose M here: the
+	  module will be called vboxvideo.
+
 source "drivers/misc/c2port/Kconfig"
 source "drivers/misc/eeprom/Kconfig"
 source "drivers/misc/cb710/Kconfig"
diff --git a/drivers/misc/Makefile b/drivers/misc/Makefile
index ad0e64fdba34..1372be11ce8e 100644
--- a/drivers/misc/Makefile
+++ b/drivers/misc/Makefile
@@ -53,6 +53,9 @@ obj-$(CONFIG_GENWQE)		+= genwqe/
 obj-$(CONFIG_ECHO)		+= echo/
 obj-$(CONFIG_VEXPRESS_SYSCFG)	+= vexpress-syscfg.o
 obj-$(CONFIG_CXL_BASE)		+= cxl/
+obj-$(CONFIG_VBOXGUEST)		+= vboxguest/
+obj-$(CONFIG_VBOXSF)		+= vboxsf/
+obj-$(CONFIG_VBOXVIDEO)		+= vboxvideo/
 obj-$(CONFIG_ASPEED_LPC_CTRL)	+= aspeed-lpc-ctrl.o
 obj-$(CONFIG_ASPEED_LPC_SNOOP)	+= aspeed-lpc-snoop.o
 obj-$(CONFIG_PCI_ENDPOINT_TEST)	+= pci_endpoint_test.o
diff --git a/drivers/misc/vboxguest/Makefile b/drivers/misc/vboxguest/Makefile
index fdb72b36e761..c6e0e4279db0 100644
--- a/drivers/misc/vboxguest/Makefile
+++ b/drivers/misc/vboxguest/Makefile
@@ -27,6 +27,7 @@
 # Linux kbuild sets this to our source directory if we are called from there
 obj ?= $(CURDIR)
 include $(obj)/Makefile.include.header
+KBUILD_EXTMOD=$(obj)
 
 MOD_NAME = vboxguest
 
diff --git a/drivers/misc/vboxguest/Makefile.include.header b/drivers/misc/vboxguest/Makefile.include.header
index 1ceebec41848..fd7b9656fc29 100644
--- a/drivers/misc/vboxguest/Makefile.include.header
+++ b/drivers/misc/vboxguest/Makefile.include.header
@@ -86,7 +86,7 @@ ifeq ($(USERNAME),)
  USERNAME := noname
 endif
 
-ifeq ($(KERNELRELEASE),)
+ifeq ($(KERNELVERSION),)
 
  #
  # building from this directory
@@ -131,12 +131,12 @@ else # neq($(KERNELRELEASE),)
   KERN_VERSION := 26
  endif
 
- KERN_VER := $(KERNELRELEASE)
+ KERN_VER := $(KERNELVERSION)
 
 endif # neq($(KERNELRELEASE),)
 
 # Kernel build folder
-KERN_DIR := /lib/modules/$(KERN_VER)/build
+KERN_DIR := $(KBUILD_SRC)
 ifneq ($(shell if test -d $(KERN_DIR); then echo yes; fi),yes)
  $(error Error: unable to find the headers of the Linux kernel to build against. \
           Specify KERN_VER=<version> (currently $(KERN_VER)) and run Make again)
diff --git a/drivers/misc/vboxsf/Makefile b/drivers/misc/vboxsf/Makefile
index 8ba17c7b5008..04ca20d4d256 100644
--- a/drivers/misc/vboxsf/Makefile
+++ b/drivers/misc/vboxsf/Makefile
@@ -20,6 +20,7 @@
 # Linux kbuild sets this to our source directory if we are called from there
 obj ?= $(CURDIR)
 include $(obj)/Makefile.include.header
+KBUILD_EXTMOD=$(obj)
 
 MOD_NAME = vboxsf
 MOD_OBJS   = \
diff --git a/drivers/misc/vboxsf/Makefile.include.header b/drivers/misc/vboxsf/Makefile.include.header
index 1ceebec41848..fd7b9656fc29 100644
--- a/drivers/misc/vboxsf/Makefile.include.header
+++ b/drivers/misc/vboxsf/Makefile.include.header
@@ -86,7 +86,7 @@ ifeq ($(USERNAME),)
  USERNAME := noname
 endif
 
-ifeq ($(KERNELRELEASE),)
+ifeq ($(KERNELVERSION),)
 
  #
  # building from this directory
@@ -131,12 +131,12 @@ else # neq($(KERNELRELEASE),)
   KERN_VERSION := 26
  endif
 
- KERN_VER := $(KERNELRELEASE)
+ KERN_VER := $(KERNELVERSION)
 
 endif # neq($(KERNELRELEASE),)
 
 # Kernel build folder
-KERN_DIR := /lib/modules/$(KERN_VER)/build
+KERN_DIR := $(KBUILD_SRC)
 ifneq ($(shell if test -d $(KERN_DIR); then echo yes; fi),yes)
  $(error Error: unable to find the headers of the Linux kernel to build against. \
           Specify KERN_VER=<version> (currently $(KERN_VER)) and run Make again)
diff --git a/drivers/misc/vboxvideo/Makefile b/drivers/misc/vboxvideo/Makefile
index ae0b57a8b316..ff8d913f9f7f 100755
--- a/drivers/misc/vboxvideo/Makefile
+++ b/drivers/misc/vboxvideo/Makefile
@@ -20,6 +20,7 @@
 # Linux kbuild sets this to our source directory if we are called from there
 obj ?= $(CURDIR)
 include $(obj)/Makefile.include.header
+KBUILD_EXTMOD=$(obj)
 
 BUILD =
 
diff --git a/drivers/misc/vboxvideo/Makefile.include.header b/drivers/misc/vboxvideo/Makefile.include.header
index 1ceebec41848..fd7b9656fc29 100755
--- a/drivers/misc/vboxvideo/Makefile.include.header
+++ b/drivers/misc/vboxvideo/Makefile.include.header
@@ -86,7 +86,7 @@ ifeq ($(USERNAME),)
  USERNAME := noname
 endif
 
-ifeq ($(KERNELRELEASE),)
+ifeq ($(KERNELVERSION),)
 
  #
  # building from this directory
@@ -131,12 +131,12 @@ else # neq($(KERNELRELEASE),)
   KERN_VERSION := 26
  endif
 
- KERN_VER := $(KERNELRELEASE)
+ KERN_VER := $(KERNELVERSION)
 
 endif # neq($(KERNELRELEASE),)
 
 # Kernel build folder
-KERN_DIR := /lib/modules/$(KERN_VER)/build
+KERN_DIR := $(KBUILD_SRC)
 ifneq ($(shell if test -d $(KERN_DIR); then echo yes; fi),yes)
  $(error Error: unable to find the headers of the Linux kernel to build against. \
           Specify KERN_VER=<version> (currently $(KERN_VER)) and run Make again)
-- 
2.18.0

