From 57e68674e8412ef623c80c20f0e17b48a420297a Mon Sep 17 00:00:00 2001
From: William Douglas <william.douglas@intel.com>
Date: Tue, 12 Mar 2019 11:26:52 -0700
Subject: [PATCH] Check for 32bit linker flag when creating resource file

When gio builds a test resource file with ld, it will use the
build_machine arch for linking but in the case of the 32bit build this
will cause build failures. Instead check to see if the -m32 linker
flag has been passed and if it has, add an argument to ld to create
the elf_i386 object.
---
 gio/tests/meson.build | 13 ++++++++-----
 1 file changed, 8 insertions(+), 5 deletions(-)

diff --git a/gio/tests/meson.build b/gio/tests/meson.build
index 5c0e033..2b74500 100644
--- a/gio/tests/meson.build
+++ b/gio/tests/meson.build
@@ -566,6 +566,13 @@
   # (https://reviews.llvm.org/D58234). FIXME: This test could be enabled for
   # LLVM once that support is in a stable release.
   if build_machine.system() == 'linux' and cc.get_id() == 'gcc'
+    ld_subcommand = ['ld', '-r', '-b', 'binary']
+    pym = import('python3')
+    py3 = pym.find_python()
+    res = run_command(py3, '-c', 'import os; print(os.environ["LDFLAGS"])').stdout()
+    if res.contains('-m32')
+      ld_subcommand += ['-m', 'elf_i386']
+    endif
     test_gresource_binary = custom_target('test5.gresource',
       input : 'test5.gresource.xml',
       output : 'test5.gresource',
@@ -582,11 +589,7 @@ if not meson.is_cross_build() or meson.has_exe_wrapper()
     test_resources_binary = custom_target('test_resources.o',
       input : test_gresource_binary,
       output : 'test_resources.o',
-      command : ['ld',
-                 '-r',
-                 '-b','binary',
-                 '@INPUT@',
-                 '-o','@OUTPUT@'])
+      command : ld_subcommand + ['@INPUT@', '-o', '@OUTPUT@'])
 
 	# Rename symbol to match the one in the C file
     test_resources_binary2 = custom_target('test_resources2.o',
-- 
2.20.1

