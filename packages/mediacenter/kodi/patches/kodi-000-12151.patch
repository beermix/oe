From bb64f5584dec2d5b48c16f3516dd45e5938aa0fc Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Tue, 23 May 2017 15:00:00 +0200
Subject: [PATCH 1/3] AEEncoderFFmpeg: Deprecate avcodec_encode_audio2

---
 xbmc/cores/AudioEngine/Encoders/AEEncoderFFmpeg.cpp | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/xbmc/cores/AudioEngine/Encoders/AEEncoderFFmpeg.cpp b/xbmc/cores/AudioEngine/Encoders/AEEncoderFFmpeg.cpp
index b3cbffdd99c4..ab34814cec74 100644
--- a/xbmc/cores/AudioEngine/Encoders/AEEncoderFFmpeg.cpp
+++ b/xbmc/cores/AudioEngine/Encoders/AEEncoderFFmpeg.cpp
@@ -258,7 +258,7 @@ unsigned int CAEEncoderFFmpeg::GetFrames()
 
 int CAEEncoderFFmpeg::Encode(uint8_t *in, int in_size, uint8_t *out, int out_size)
 {
-  int got_output;
+  int got_output = 0;
   AVFrame *frame;
 
   if (!m_CodecCtx)
@@ -285,7 +285,13 @@ int CAEEncoderFFmpeg::Encode(uint8_t *in, int in_size, uint8_t *out, int out_siz
   m_Pkt.data = out;
 
   /* encode it */
-  int ret = avcodec_encode_audio2(m_CodecCtx, &m_Pkt, frame, &got_output);
+  int ret = avcodec_send_frame(m_CodecCtx, frame);
+
+  if (ret >= 0)
+    ret = avcodec_receive_packet(m_CodecCtx, &m_Pkt);
+
+  if (ret >= 0)
+    got_output = 1;
 
   /* free temporary data */
   av_frame_free(&frame);

From 19394e750139cf55b22c4e4ed962d6c90402eed4 Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Tue, 23 May 2017 15:00:00 +0200
Subject: [PATCH 2/3] EncoderFFmpeg: Deprecate avcodec_encode_audio2

---
 xbmc/cdrip/EncoderFFmpeg.cpp | 15 +++++++++++----
 1 file changed, 11 insertions(+), 4 deletions(-)

diff --git a/xbmc/cdrip/EncoderFFmpeg.cpp b/xbmc/cdrip/EncoderFFmpeg.cpp
index 1fb3c4b893d6..e4df2aa9b37c 100644
--- a/xbmc/cdrip/EncoderFFmpeg.cpp
+++ b/xbmc/cdrip/EncoderFFmpeg.cpp
@@ -288,7 +288,8 @@ int CEncoderFFmpeg::Encode(int nNumBytesRead, uint8_t* pbtStream)
 
 bool CEncoderFFmpeg::WriteFrame()
 {
-  int encoded, got_output;
+  int ret = 0;
+  int got_output = 0;
   AVFrame* frame;
 
   av_init_packet(&m_Pkt);
@@ -306,12 +307,18 @@ bool CEncoderFFmpeg::WriteFrame()
   }
   else frame = m_BufferFrame;
 
-  encoded = avcodec_encode_audio2(m_CodecCtx, &m_Pkt, frame, &got_output);
+  ret = avcodec_send_frame(m_CodecCtx, frame);
+
+  if (ret >= 0)
+    ret = avcodec_receive_packet(m_CodecCtx, &m_Pkt);
+
+  if (ret >= 0)
+    got_output = 1;
 
   m_BufferSize = 0;
 
-  if (encoded < 0) {
-    CLog::Log(LOGERROR, "CEncoderFFmpeg::WriteFrame - Error encoding audio: %i", encoded);
+  if (ret < 0) {
+    CLog::Log(LOGERROR, "CEncoderFFmpeg::WriteFrame - Error encoding audio: %i", ret);
     return false;
   }
 

From e06ecb63cdf3eab61099f1b09b50d8a6ae68ab60 Mon Sep 17 00:00:00 2001
From: fritsch <Peter.Fruehberger@gmail.com>
Date: Tue, 23 May 2017 15:00:00 +0200
Subject: [PATCH 3/3] ActiveAE: Deprecate stream's codec access

---
 xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp b/xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp
index e3c5dbd6d23f..6f8e69eeb48b 100644
--- a/xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp
+++ b/xbmc/cores/AudioEngine/Engines/ActiveAE/ActiveAE.cpp
@@ -3013,11 +3013,10 @@ IAESound *CActiveAE::MakeSound(const std::string& file)
     fmt_ctx->flags |= AVFMT_FLAG_NOPARSE;
     if (avformat_find_stream_info(fmt_ctx, NULL) >= 0)
     {
-      dec_ctx = fmt_ctx->streams[0]->codec;
-      dec = avcodec_find_decoder(dec_ctx->codec_id);
-      config.sample_rate = dec_ctx->sample_rate;
-      config.channels = dec_ctx->channels;
-      config.channel_layout = dec_ctx->channel_layout;
+      dec = avcodec_find_decoder(fmt_ctx->streams[0]->codecpar->codec_id);
+      config.sample_rate = fmt_ctx->streams[0]->codecpar->sample_rate;
+      config.channels = fmt_ctx->streams[0]->codecpar->channels;
+      config.channel_layout = fmt_ctx->streams[0]->codecpar->channel_layout;
     }
   }
   if (dec == NULL)
