From 5bef6d5d5b6c7de5ec2f3db182660ef60f96e4f2 Mon Sep 17 00:00:00 2001
From: MilhouseVH <milhouseVH.github@nmacleod.com>
Date: Sun, 8 Sep 2019 22:36:43 +0100
Subject: [PATCH] rsync: build for host, needed to install 5.3 headers. use
 rsyncx for addons.

---
 .../network-tools-depends/rsyncx/package.mk       | 15 +++++++++++++++
 packages/addons/tools/network-tools/package.mk    |  6 +++---
 packages/linux/package.mk                         |  2 +-
 .../network-tools-depends => }/rsync/package.mk   |  9 +++------
 4 files changed, 22 insertions(+), 10 deletions(-)
 create mode 100644 packages/addons/addon-depends/network-tools-depends/rsyncx/package.mk
 rename packages/{addons/addon-depends/network-tools-depends => }/rsync/package.mk (72%)

diff --git a/packages/addons/addon-depends/network-tools-depends/rsyncx/package.mk b/packages/addons/addon-depends/network-tools-depends/rsyncx/package.mk
new file mode 100644
index 00000000000..277ab8edf2a
--- /dev/null
+++ b/packages/addons/addon-depends/network-tools-depends/rsyncx/package.mk
@@ -0,0 +1,15 @@
+# SPDX-License-Identifier: GPL-2.0
+# Copyright (C) 2016-present Team LibreELEC (https://libreelec.tv)
+
+. $(get_pkg_directory rsync)/package.mk
+
+PKG_NAME="rsyncx"
+PKG_DEPENDS_TARGET="toolchain"
+
+PKG_CONFIGURE_OPTS_TARGET="--disable-acl-support \
+                           --disable-xattr-support \
+                           --with-included-popt"
+
+makeinstall_target() {
+  :
+}
diff --git a/packages/addons/tools/network-tools/package.mk b/packages/addons/tools/network-tools/package.mk
index ea230985fbf..37403335cbf 100644
--- a/packages/addons/tools/network-tools/package.mk
+++ b/packages/addons/tools/network-tools/package.mk
@@ -28,7 +28,7 @@ PKG_DEPENDS_TARGET="toolchain \
                     ngrep \
                     nmap \
                     rar2fs \
-                    rsync \
+                    rsyncx \
                     sshfs \
                     tcpdump \
                     udpxy \
@@ -72,8 +72,8 @@ addon() {
     cp -P $(get_build_dir rar2fs)/.$TARGET_NAME/mkr2i $ADDON_BUILD/$PKG_ADDON_ID/bin
     cp -P $(get_build_dir rar2fs)/.$TARGET_NAME/rar2fs $ADDON_BUILD/$PKG_ADDON_ID/bin
 
-    # rsync
-    cp -P $(get_build_dir rsync)/.$TARGET_NAME/rsync $ADDON_BUILD/$PKG_ADDON_ID/bin
+    # rsyncx
+    cp -P $(get_build_dir rsyncx)/.$TARGET_NAME/rsync $ADDON_BUILD/$PKG_ADDON_ID/bin
 
     # sshfs
     cp -P $(get_build_dir sshfs)/.$TARGET_NAME/sshfs $ADDON_BUILD/$PKG_ADDON_ID/bin
diff --git a/packages/linux/package.mk b/packages/linux/package.mk
index c003e6d1437..a9ba062c82f 100644
--- a/packages/linux/package.mk
+++ b/packages/linux/package.mk
@@ -5,7 +5,7 @@
 PKG_NAME="linux"
 PKG_LICENSE="GPL"
 PKG_SITE="http://www.kernel.org"
-PKG_DEPENDS_HOST="ccache:host openssl:host"
+PKG_DEPENDS_HOST="ccache:host rsync:host openssl:host"
 PKG_DEPENDS_TARGET="toolchain linux:host cpio:host kmod:host xz:host wireless-regdb keyutils $KERNEL_EXTRA_DEPENDS_TARGET"
 PKG_DEPENDS_INIT="toolchain"
 PKG_NEED_UNPACK="$LINUX_DEPENDS"
diff --git a/packages/addons/addon-depends/network-tools-depends/rsync/package.mk b/packages/rsync/package.mk
similarity index 72%
rename from packages/addons/addon-depends/network-tools-depends/rsync/package.mk
rename to packages/rsync/package.mk
index e430e716c24..64abf9e677c 100644
--- a/packages/addons/addon-depends/network-tools-depends/rsync/package.mk
+++ b/packages/rsync/package.mk
@@ -7,13 +7,10 @@ PKG_SHA256="55cc554efec5fdaad70de921cd5a5eeb6c29a95524c715f3bbf849235b0800c0"
 PKG_LICENSE="GPLv3"
 PKG_SITE="http://www.samba.org/ftp/rsync/rsync.html"
 PKG_URL="https://download.samba.org/pub/rsync/src/$PKG_NAME-$PKG_VERSION.tar.gz"
+PKG_DEPENDS_HOST="autotools:host"
 PKG_DEPENDS_TARGET="toolchain"
 PKG_LONGDESC="A very fast method for bringing remote files into sync."
 
-PKG_CONFIGURE_OPTS_TARGET="--disable-acl-support \
-                           --disable-xattr-support \
-                           --with-included-popt"
+PKG_CONFIGURE_OPTS_HOST="--with-included-popt \
+                         --with-included-zlib"
 
-makeinstall_target() {
-  :
-}
