<!DOCTYPE html>
<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Create Stream</title>

<script type="text/javascript" src="javascript/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="javascript/jquery-ui.min.js"></script>
<script type="text/javascript" src="javascript/json2.js"></script>
<link rel="stylesheet" href="css/jquery-ui.css" />

<script type="text/javascript">
function sendRequest(data, onsuccess, onerror) {

    var ajaxSettings = {
        url: '/webui/json/',
        type: 'GET',
        contentType: 'json',
        dataType: 'json',
        cache: false,
        data: {'q': JSON.stringify(data)},
        error: function(request, error_string, exception) {
            alert("request failed");
        },
        success: function(response) {
            console.log("response: " + response);
            
            if(typeof response != 'object') {
                alert("Malformed response");
            }
            
            if(response.success === "true") {
                if(typeof onsuccess === 'function') {
                    onsuccess.call(null, response);
                }
            }
            else {
                var errmsg;
                if(response.error) {
                    errmsg = response.error;
                }
                else {
                    errmsg = "Unknown error";
                }
                
                if(typeof onerror === 'function') {
                    onerror.call(null, errmsg);
                }
                else {
                    alert(errmsg);
                }
            }
        },
        async: true
    };

    $.ajax(ajaxSettings);
}

function reload_broadcast_list() {
    var request = {
        method: "broadcast_list_get",
        };
    sendRequest(request,
        // onsuccess
        function(response) {
            show_broadcast_list(response.response.broadcast_list);
        },
        // onfailure
        function(error) {
            showNotification(error, 5);
        }
    );
}

function clear_broadcast_list()
{
    if(window.confirm("Clear the whole broadcast list?")) {
        if(window.confirm("Are you sure? The broadcast list cannot be recovered after clearing.")) {
            sendRequest({
                method: "broadcast_list_clear",
                },
                // onsuccess
                function(response) {
                    reload_broadcast_list();
                }
            );
        }
    }
}

function delete_broadcast_list_item(infohash)
{
    if(!window.confirm("Delete broadcast from the list?")) {
        return false;
    }
    sendRequest({
            method: "broadcast_list_delete_item",
            arguments: {
                infohash: infohash
                }
            },
            // onsuccess
            function(response) {
                reload_broadcast_list();
            }
        );
    return true;
}

function show_broadcast_list_item(infohash)
{
    sendRequest({
            method: "broadcast_list_show_item",
            arguments: {
                infohash: infohash
                }
            }
        );
    return true;
}

function show_broadcast_list(data)
{
    if(data.length == 0) {
        $("#broadcast_list").empty().html("The broadcast list is empty");
        return;
    }
    
    var html = '<table cellspacing="0" cellpadding="0" border="0"><tr><th>Type</th><th>Title</th><th>Content ID</th><th>Path</th><th>&nbsp;</th></tr>';
    for(var i=0; i < data.length; i++) {
        var url;
        var type_names = {
            'p2p': 'P2P',
            'hls': 'HLS+P2P'
        };
        
        html += '<tr>';
        html += '<td>'+type_names[data[i].type]+'</td>';
        html += '<td>'+data[i].title+'</td>';
        html += '<td>'+data[i].content_id+'</td>';
        html += '<td>'+data[i].path+' <a href="#" onclick="show_broadcast_list_item(&quot;'+data[i].infohash+'&quot;); return false;">show</a></td>';
        
        html += '<td><a href="#" style="text-decoration:none;color:black;" onclick="delete_broadcast_list_item(&quot;'+data[i].infohash+'&quot;); return false;" title="Delete">&times;</a></td>';
        html += '</tr>';
    }
    html += '</table>';
    $("#broadcast_list").html(html);
}

$(document).ready(function() {
        $("#tabs").tabs();
        reload_broadcast_list();
        
        $("#button-create-stream").click(function() {
                var name = $("#p2p_name").val(),
                    quality = $("#p2p_quality").val(),
                    category = $("#p2p_category").val(),
                    source = $("#p2p_source").val(),
                    cache_dir = $("#p2p_cache_dir").val(),
                    publish_dir = $("#p2p_publish_dir").val(),
                    bitrate = $("#p2p_bitrate").val(),
                    trackers = $("#p2p_trackers").val(),
                    maxConnections = $("#p2p_max_connections").val(),
                    maxPeers = $("#p2p_max_peers").val();
                    
                if(name.length == 0) {
                    alert("Empty name");
                    return false;
                }
                
                if(quality.length == 0) {
                    alert("Empty quality");
                    return false;
                }
                
                if(category.length == 0) {
                    alert("Empty category");
                    return false;
                }
                
                if(cache_dir.length == 0) {
                    alert("Cache directory must be specified");
                    return false;
                }
                
                if(publish_dir.length == 0) {
                    alert("Publish directory must be specified");
                    return false;
                }
                
                if(source.length == 0) {
                    alert("Empty source");
                    return false;
                }
                
                bitrate = parseInt(bitrate);
                if(!bitrate) {
                    alert("Empty bitrate");
                    return false;
                }
                
                sendRequest({
                        method: "create_stream",
                        arguments: {
                            name: name,
                            cache_dir: cache_dir,
                            publish_dir: publish_dir,
                            source: source,
                            bitrate: bitrate,
                            host: $("#p2p_host").val(),
                            port: $("#p2p_port").val(),
                            piecesize: $("#p2p_piecesize").val(),
                            trackers: trackers,
                            max_connections: maxConnections,
                            max_peers: maxPeers,
                            quality: quality,
                            category: category,
                        }
                },
                // onsuccess
                function(response) {
                    window.location.href = "http://127.0.0.1:" + response.port + "/app/stream";
                }
                );
        });
        
        $("#button-create-hls-transport-file").click(function() {
                var manifest_url = $("#hls_manifest_url").val(),
                    title = $("#hls_title").val(),
                    category = $("#hls_category").val(),
                    publish_dir = $("#hls_publish_dir").val(),
                    trackers = $("#hls_trackers").val();
                    
                if(manifest_url.length == 0) {
                    alert("Empty manifest URL");
                    return false;
                }
                
                if(!/^https?:\/\//.test(manifest_url)) {
                    alert("Manifest URL must start with http:// or https://");
                    return false;
                }
                    
                if(title.length == 0) {
                    alert("Empty title");
                    return false;
                }
                
                if(category.length == 0) {
                    alert("Empty category");
                    return false;
                }
                
                if(publish_dir.length == 0) {
                    alert("Publish directory must be specified");
                    return false;
                }
                
                sendRequest({
                        method: "create_hls_transport_file",
                        arguments: {
                            manifest_url: manifest_url,
                            title: title,
                            publish_dir: publish_dir,
                            trackers: trackers,
                            category: category
                        }
                },
                // onsuccess
                function(response) {
                    reload_broadcast_list();
                    // show "broadcast list" tab
                    $("#tabs").tabs("option", "active", 2);
                }
                );
        });
});

function showNotification(msg, timeout) {
    $("#notification").html(msg).show();
    if(timeout) {
        // hide after |timeout| seconds
        setTimeout(hideNotification, timeout*1000);
    }
}

function hideNotification() {
    $("#notification").html("").hide();
}
</script>

<style>
html {
    font-family: Tahoma;
    font-size: 12px;
}

textarea, select, input[type=text] {
    width: 500px;
}

#notification {
    position: fixed;
    width: 100%;
    background-color: rgba(238, 238, 238, 0.8);
    font-size: 16px;
    text-align: center;
    padding: 4px;
    left: 0;
    top: 0;
}

#broadcast_list th, #broadcast_list td {
    text-align: left;
    vertical-align: top;
    border-bottom: 1px solid #888;
    padding: 6px 10px;
}
#broadcast_list th {
    border-top: 1px solid #888;
}
</style>

</head>

<body>

<div id="notification" style="display:none;"></div>

<div id="tabs">
    <ul>
        <li><a href="#tab-create-p2p-broadcast">P2P Broadcast</a></li>
        <li><a href="#tab-create-hls-transport-file">Hybrid broadcast (HLS+P2P)</a></li>
        <li><a href="#tab-my-broadcasts">My broadcasts</a></li>
    </ul>
    
    <!-- Create P2P broadcast -->
    <div id="tab-create-p2p-broadcast">
        <table border="0" cellspacing="0" cellpadding="5">
            <tr>
                <td>Name:<td>
                <td><input type="text" id="p2p_name" value="" /></td>
            </tr>
            <tr>
                <td>Publish directory:<td>
                <td><input type="text" id="p2p_publish_dir" value="{publish_dir}" /></td>
            </tr>
            <tr>
                <td>Cache directory:<td>
                <td><input type="text" id="p2p_cache_dir" value="{cache_dir}" /></td>
            </tr>
            <tr>
                <td>Source (MPEG-TS HTTP stream):<td>
                <td><input type="text" id="p2p_source" value="" /></td>
            </tr>
            <tr>
                <td>Bitrate (kbit/s):<td>
                <td><input type="text" id="p2p_bitrate" value="" /></td>
            </tr>
            <tr>
                <td>Quality:<td>
                <td>
                    <select id="p2p_quality">
                        <option value="">Select quality</option>
                        <option value="SD">SD</option>
                        <option value="HD">HD</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Category:<td>
                <td>
                    <select id="p2p_category">
                        <option value="">Select category</option>
                        <option value="informational">Informational</option>
                        <option value="entertaining">Entertaining</option>
                        <option value="educational">Educational</option>
                        <option value="movies">Movies</option>
                        <option value="documentaries">Documentaries</option>
                        <option value="sport">Sport</option>
                        <option value="fashion">Fashion</option>
                        <option value="music">Music</option>
                        <option value="regional">Regional</option>
                        <option value="ethnic">Ethnic</option>
                        <option value="religion">Religion</option>
                        <option value="teleshop">Teleshop</option>
                        <option value="erotic_18_plus">Erotic 18+</option>
                        <option value="other_18_plus">Other 18+</option>
                        <option value="cyber_games">Cyber games</option>
                        <option value="amateur">Amateur</option>
                        <option value="webcam">Webcam</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Max connections:<td>
                <td><input type="text" id="p2p_max_connections" value="1000" /></td>
            </tr>
            <tr>
                <td>Max peers:<td>
                <td><input type="text" id="p2p_max_peers" value="50" /></td>
            </tr>
            <tr>
                <td>Piece length:<td>
                <td>
                    <select id="p2p_piecesize">
                        <option value="auto">Auto</option>
                        <option value="16384">16K</option>
                        <option value="32768">32K</option>
                        <option value="65536">64K</option>
                        <option value="131072">128K</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Trackers:<td>
                <td><textarea id="p2p_trackers"></textarea></td>
            </tr>
            <tr>
                <td>Port:<td>
                <td><input type="text" id="p2p_port" value="7764" /></td>
            </tr>
            <tr>
                <td>Host:<td>
                <td><input type="text" id="p2p_host" value="" /></td>
            </tr>
            <tr>
                <td>&nbsp;<td>
                <td><input type="button" id="button-create-stream" value="Create stream" /></td>
            </tr>
        </table>
    </div>
    
    <!-- Create HLS transport file -->
    <div id="tab-create-hls-transport-file">
        <table border="0" cellspacing="0" cellpadding="5">
            <tr>
                <td>Source (HTTP link to HLS stream):<td>
                <td><input type="text" id="hls_manifest_url" value="" /></td>
            </tr>
            <tr>
                <td>Title:<td>
                <td><input type="text" id="hls_title" value="" /></td>
            </tr>
            <tr>
                <td>Publish directory:<td>
                <td><input type="text" id="hls_publish_dir" value="{publish_dir}" /></td>
            </tr>
            <tr>
                <td>Category:<td>
                <td>
                    <select id="hls_category">
                        <option value="">Select category</option>
                        <option value="informational">Informational</option>
                        <option value="entertaining">Entertaining</option>
                        <option value="educational">Educational</option>
                        <option value="movies">Movies</option>
                        <option value="documentaries">Documentaries</option>
                        <option value="sport">Sport</option>
                        <option value="fashion">Fashion</option>
                        <option value="music">Music</option>
                        <option value="regional">Regional</option>
                        <option value="ethnic">Ethnic</option>
                        <option value="religion">Religion</option>
                        <option value="teleshop">Teleshop</option>
                        <option value="erotic_18_plus">Erotic 18+</option>
                        <option value="other_18_plus">Other 18+</option>
                        <option value="cyber_games">Cyber games</option>
                        <option value="amateur">Amateur</option>
                        <option value="webcam">Webcam</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>Trackers:<td>
                <td><textarea id="hls_trackers">udp://tracker.publicbt.com:80/announce
udp://tracker.openbittorrent.com:80/announce
udp://tracker.istole.it:80/announce
http://announce.torrentsmd.com:6969/announce
udp://open.demonii.com:1337/announce
udp://tracker.prq.to/announce
udp://open.demonii.com:1337/announce
udp://9.rarbg.me:2710/announce</textarea></td>
            </tr>
            <tr>
                <td>&nbsp;<td>
                <td><input type="button" id="button-create-hls-transport-file" value="Create transport file" /></td>
            </tr>
        </table>
    </div>
    
    <!-- My broadcasts -->
    <div id="tab-my-broadcasts">
        <div id="broadcast_list">
        </div>
    </div>
</div>

</body>

</html>