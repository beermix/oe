<!DOCTYPE html>
<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Ace Stream Server</title>

<script type="text/javascript" src="/webui/javascript/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="/webui/javascript/json2.js"></script>

<script type="text/javascript">
function sendRequest(data, onsuccess, onfailure, notificationMessage) {
    data = data || {};
    data.token = params.access_token;
    var ajaxSettings = {
        url: '/server/api/',
        type: 'GET',
        dataType: 'json',
        cache: false,
        data: data,
        complete: function() {
            if(notificationMessage) {
                hideNotification();
            }
        },
        error: function(request, error_string, exception) {
            console.log("request failed", error_string);
        },
        success: function(response) {
            if(typeof response != 'object') {
                alert("Malformed response");
            }
            
            if(response.result) {
                if(typeof onsuccess === 'function') {
                    onsuccess.call(null, response.result);
                }
            }
            else {
                if(typeof onfailure === 'function') {
                    onfailure.call(null, response.error);
                }
            }
        }
    };
    
    if(notificationMessage) {
        showNotification(notificationMessage);
    }
    $.ajax(ajaxSettings);
}

function update_subcategories()
{
    var category = $("#filter-category").val(),
        $container = $("#filter-subcategory");
    
    $container.empty();
    $container.append('<option value="_all_">Show all</option>');
    
    if(category != "_all_") {
        sendRequest({
                method: "get_subcategories",
                category: category,
            },
            // onsuccess
            function(response) {
                for(var i=0; i < response.length; i++) {
                    var item = response[i];
                    $container.append('<option value="'+item+'">'+item+'</option>');
                }
            }
            );
    }
}

function update_background_tasks()
{
    sendRequest({
        method: "get_background_tasks",
        },
        // onsuccess
        function(response) {
            var i, msg, messages = [], task, interval = 1000;
            for(i=0; i<response.length; i++) {
                task = response[i];
                if(task.error) {
                    msg = task.name + ": " + task.error;
                    interval = 5000;
                }
                else {
                    if(task.max_progress) {
                        msg = task.name + ": " + task.progress + "/" + task.max_progress;
                    }
                    else {
                        msg = task.name + ": wait...";
                    }
                }
                messages.push(msg);
                
                if(task.name == "Importing playlist") {
                    if(task.finished) {
                        reload_playlist();
                    }
                }
            }
            
            if(messages.length) {
                showNotification(messages.join("<br/>"));
            }
            else {
                hideNotification();
            }
            setTimeout(update_background_tasks, interval);
        },
        // onfailure
        function(error) {
            showNotification(error, 5);
            setTimeout(update_background_tasks, 1000);
        }
    );
}

function reload_playlist() {
    var category = $("#filter-category").val(),
        subcategory = $("#filter-subcategory").val();

    if(category == "_all_") {
        category = "";
    }
    var request = {
        method: "playlist_get",
        category: category,
        };
        
    if(subcategory && subcategory != "_all_") {
        request['subcategory'] = subcategory;
    }
    sendRequest(request,
        // onsuccess
        function(response) {
            show_playlist(response.playlist);
        },
        // onfailure
        function(error) {
            showNotification(error, 5);
        }
    );
}

function clear_playlist()
{
    if(window.confirm("Clear the whole playlist?")) {
        if(window.confirm("Are you sure? The playlist cannot be recovered after clearing.")) {
            sendRequest({
                method: "playlist_clear",
                },
                // onsuccess
                function(response) {
                    reload_playlist();
                }
            );
        }
    }
}

function delete_playlist_item(item_id)
{
    if(!window.confirm("Delete playlist item?")) {
        return false;
    }
    sendRequest({
            method: "playlist_delete_item",
            id: item_id
            },
            // onsuccess
            function(response) {
                reload_playlist();
            }
        );
    return true;
}

function show_playlist(data)
{
    var allow_remote_access = !!$("#allow_remote_access").attr("checked");
    
    if(data.length == 0) {
        $("#playlist").empty().html("Playlist is empty");
        return;
    }
    
    var html = '<table cellspacing="0" cellpadding="0" border="0"><tr><th>Category</th><th>Subcategory</th><th>Title</th><th>Content ID</th><th>Type</th><th>Playback URL</th><th>&nbsp;</th></tr>';
    for(var i=0; i < data.length; i++) {
        var url;
        var type_names = {
            'live': 'Live',
            'vod': 'VOD'
        };
        
        if(!data[i].category) {
            data[i].category = "other";
        }
        
        html += '<tr>';
        html += '<td>'+data[i].category+'</td>';
        html += '<td>'+data[i].subcategory+'</td>';
        html += '<td>'+data[i].title+'</td>';
        html += '<td>';
        html += data[i].content_id;
        if(params.dev_mode) {
            html += "<br/>" + data[i].infohash;
        }
        html += '</td>';
        html += '<td>'+type_names[data[i].content_type]+'</td>';
        
        html += '<td>';
        
        if(params.client_ip == "127.0.0.1") {
            // add localhost
            url = "http://127.0.0.1:"+params.http_port+"/play/"+params.playlist_id+"/"+data[i].id;
            html += '<div><a href="'+url+'" target="_blank">'+url+'</a></div>';
        }
        
        if(allow_remote_access) {
            if(params.ip_is_local) {
                // local ip list
                for(var j=0; j<params.ip_list.length; j++) {
                    url = "http://"+params.ip_list[j]+":"+params.http_port+"/play/"+params.playlist_id+"/"+data[i].id;
                    html += '<div><a href="'+url+'" target="_blank">'+url+'</a></div>';
                }
            }
            if(params.external_ip) {
                // external ip
                url = "http://"+params.external_ip+":"+params.http_port+"/play/"+params.playlist_id+"/"+data[i].id;
                html += '<div><a href="'+url+'" target="_blank">'+url+'</a></div>';
            }
        }
        
        html += '</td>';
        html += '<td><a href="#" style="text-decoration:none;color:black;" onclick="delete_playlist_item('+data[i].id+'); return false;" title="Delete">&times;</a></td>';
        html += '</tr>';
    }
    html += '</table>';
    $("#playlist").html(html);
}

function reload_playlist_url(ip_list)
{
    var url, allow_remote_access = !!$("#allow_remote_access").attr("checked");
    
    $("#playlist_url").empty();
    
    if(params.client_ip == "127.0.0.1") {
        // add localhost
        url = "http://127.0.0.1:"+params.http_port+"/playlist/"+params.playlist_id;
        $("#playlist_url").append('<div><a href="'+url+'" target="_blank">'+url+'</a> (localhost)</div>');
    }
    
    if(allow_remote_access) {
        if(params.ip_is_local) {
            // local ip list
            for(var i=0; i<ip_list.length; i++) {
                url = "http://"+ip_list[i]+":"+params.http_port+"/playlist/"+params.playlist_id;
                $("#playlist_url").append('<div><a href="'+url+'" target="_blank">'+url+'</a> (local network)</div>');
            }
        }
        if(params.external_ip) {
            // external ip
            check_port_html = (params.locale == "ru_RU") ? ', check port <a href="http://2ip.ru/check-port/?port='+params.http_port+'" target="_blank">here</a>' : '';
            url = "http://"+params.external_ip+":"+params.http_port+"/playlist/"+params.playlist_id;
            $("#playlist_url").append('<div><a href="'+url+'" target="_blank">'+url+'</a> (external ip'+check_port_html+')</div>');
        }
    }
}

function showNotification(msg, timeout) {
    $("#notification").html(msg).show();
    if(timeout) {
        // hide after |timeout| seconds
        setTimeout(hideNotification, timeout*1000);
    }
}

function hideNotification() {
    $("#notification").html("").hide();
}
</script>

<style>
#notification {
    position: fixed;
    width: 100%;
    background-color: rgba(238, 238, 238, 0.8);
    font-size: 16px;
    text-align: center;
    padding: 4px;
    left: 0;
    top: 0;
}
textarea, select, input[type=text] {
    width: 500px;
}
#playlist th, #playlist td {
    text-align: left;
    vertical-align: top;
    border-bottom: 1px solid #888;
    padding: 6px 10px;
}
#playlist th {
    border-top: 1px solid #888;
}
</style>

</head>

<body>

<div id="notification" style="display:none;"></div>

<h2>Server settings</h2>
<table border="0" cellspacing="0" cellpadding="5">
    <tr>
        <td>HTTP Port:</td>
        <td><span id="http_port"></span></td>
    </tr>
    <tr>
        <td>Personal Key:</td>
        <td><span id="personal_key"></span></td>
    </tr>
    <tr>
        <td>Allow remote access:</td>
        <td><input type="checkbox" id="allow_remote_access" value="1" /></td>
    </tr>
    <tr>
        <td>Use info messages:</td>
        <td><input type="checkbox" id="use_info_messages" value="1" /></td>
    </tr>
    <tr>
        <td>Live stream type:</td>
        <td>
            <input type="radio" class="output_stream_format_live" name="output_stream_format_live" id="output_stream_format_live_hls" value="hls" /><label for="output_stream_format_live_hls">HLS</label>
            <br/>
            <input type="radio" class="output_stream_format_live" name="output_stream_format_live" id="output_stream_format_live_http" value="http" /><label for="output_stream_format_live_http">HTTP</label>
        </td>
    </tr>
    <tr>
        <td>VOD stream type:</td>
        <td>
            <input type="radio" class="output_stream_format_vod" name="output_stream_format_vod" id="output_stream_format_vod_hls" value="hls" /><label for="output_stream_format_vod_hls">HLS</label>
            <br/>
            <input type="radio" class="output_stream_format_vod" name="output_stream_format_vod" id="output_stream_format_vod_http" value="http" /><label for="output_stream_format_vod_http">HTTP</label>
        </td>
    </tr>
    <tr>
        <td>Audio transcoding:</td>
        <td>
            <input type="checkbox" id="transcode_audio" value="1" /><label for="transcode_audio">transcode audio to AAC</label>
            <br/>
            <input type="checkbox" id="skip_transcode_mp3" value="1" /><label for="transcode_mp3">do not transcode MP3</label>
        </td>
    </tr>
    <tr>
        <td>Preferred audio language:</td>
        <td>
            <select id="preferred_audio_language">
                <option value="eng">English</option>
                <option value="rus">Russian</option>
                <option value="ukr">Ukrainian</option>
                <option value="ara">Arabic</option>
                <option value="bul">Bulgarian</option>
                <option value="chi">Chinese</option>
                <option value="cze">Czech</option>
                <option value="dan">Danish</option>
                <option value="dut">Dutch</option>
                <option value="egy">Egyptian</option>
                <option value="fin">Finnish</option>
                <option value="fre">French</option>
                <option value="ger">German</option>
                <option value="gre">Greek</option>
                <option value="heb">Hebrew</option>
                <option value="hun">Hungarian</option>
                <option value="ind">Indonesian</option>
                <option value="ita">Italian</option>
                <option value="jpn">Japanese</option>
                <option value="kor">Korean</option>
                <option value="nor">Norwegian</option>
                <option value="pol">Polish</option>
                <option value="por">Portuguese</option>
                <option value="rum">Romanian</option>
                <option value="spa">Spanish</option>
                <option value="tha">Thai</option>
                <option value="tur">Turkish</option>
                <option value="vie">Vietnamese</option>
            </select>
        </td>
    </tr>
    <tr>
        <td>Playlist url (M3U format):</td>
        <td><div id="playlist_url"></div></td>
    </tr>
</table>

<hr/>
<h2>Add an item to the playlist</h2>
<form action="/server/api?method=playlist_add_item" method="post" enctype="multipart/form-data">
    <input type="hidden" name="redirect" class="redirect-url" value="" />
    <input type="hidden" name="token" class="form-token" value="" />
    <table border="0" cellspacing="0" cellpadding="5">
        <tr>
            <td>Category:</td>
            <td>
                <select name="category" id="category">
                    <option value="Movies">Movies</option>
                    <option value="TV">TV</option>
                    <option value="Music">Music</option>
                    <option value="Other">Other</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>Subcategory:</td>
            <td><input type="text" id="subcategory" name="subcategory" value="" /></td>
        </tr>
        <tr>
            <td>Title:</td>
            <td><input type="text" id="title" name="title" value="" /></td>
        </tr>
        <tr>
            <td>Content ID:</td>
            <td><input type="text" id="content_id" name="id" value="" /></td>
        </tr>
        <tr id="infohash-input" style="display: none;">
            <td>Magnet link or infohash:</td>
            <td><input type="text" id="infohash" name="infohash" value="" /></td>
        </tr>
        <tr>
            <td>Select file:</td>
            <td><input type="file" name="file" /></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td><input type="submit" value="Add to playlist" /></td>
        </tr>
    </table>
</form>

<hr/>
<h2>Import playlist</h2>
<form action="/server/api?method=playlist_import" method="post" enctype="multipart/form-data">
    <input type="hidden" name="redirect" class="redirect-url" value="" />
    <input type="hidden" name="token" class="form-token" value="" />
    <input type="hidden" name="background" value="1" />
    <table border="0" cellspacing="0" cellpadding="5">
        <tr>
            <td>Category:</td>
            <td>
                <select name="category">
                    <option value="Movies">Movies</option>
                    <option value="TV" selected="selected">TV</option>
                    <option value="Music">Music</option>
                    <option value="Other">Other</option>
                </select>
            </td>
        </tr>
        <tr>
            <td>Playlist URL:</td>
            <td><input type="text" id="import_playlist_url" name="url" value="" /></td>
        </tr>
        <tr>
            <td>Playlist file:</td>
            <td><input type="file" name="file" /></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td><input type="submit" value="Import playlist" /></td>
        </tr>
    </table>
</form>

<hr/>

<h2>Playlist <a href="#" id="btn-playlist-clear" style="display:none;text-decoration:underline;color:black;font-size:10px;font-weight:normal;" onclick="clear_playlist(); return false;" title="Clear playlist">clear</a></h2>
<table border="0" cellspacing="0" cellpadding="5">
    <tr>
        <td>Filter by category:</td>
        <td>
            <select id="filter-category">
                <option value="_all_">Show all</option>
                <option value="Movies">Movies</option>
                <option value="TV">TV</option>
                <option value="Music">Music</option>
                <option value="Other">Other</option>
            </select>
        </td>
    </tr>
    <tr>
        <td>Filter by subcategory:</td>
        <td>
            <select id="filter-subcategory">
            </select>
        </td>
    </tr>
    <tr>
        <td>&nbsp;</td>
        <td><input type="button" id="btn-filter-apply" value="Apply" /></td>
    </tr>
</table>

<div id="playlist">
</div>

<script>
var params = {{params}};
$("#playlist_url").html(params.playlist_url);
$("#http_port").html(params.http_port);
$("#personal_key").html(params.access_token);
if(params.allow_remote_access) {
    $("#allow_remote_access").attr("checked", true);
}
if(params.hls_special_video) {
    $("#use_info_messages").attr("checked", true);
}
if(params.transcode_audio) {
    $("#transcode_audio").attr("checked", true);
    if(!params.transcode_mp3) {
        $("#skip_transcode_mp3").attr("checked", true);
    }
}
if(params.preferred_audio_language) {
    $("#preferred_audio_language option[value='"+params.preferred_audio_language+"']").prop('selected', true);
}
$("#output_stream_format_live_" + params.playlist_output_format_live).attr("checked", true);
$("#output_stream_format_vod_" + params.playlist_output_format_vod).attr("checked", true);
$(".redirect-url").val(window.location.pathname);
$(".form-token").val(params.access_token);

if(params.client_ip != "127.0.0.1") {
    $("#allow_remote_access").attr("disabled", true);
}
if(params.allow_infohash_input) {
    $("#infohash-input").show();
}
$("#btn-playlist-clear").show();
if(params.error) {
    alert(params.error);
}

reload_playlist_url(params.ip_list);
reload_playlist();
update_background_tasks();
update_subcategories();

$("#filter-category").change(function() {
        update_subcategories();
});
$("#btn-filter-apply").click(function() {
        reload_playlist();
});

$("#use_info_messages").change(function() {
        var value = !!$(this).attr("checked");
        sendRequest({
                method: "set_playlist_hls_special_video",
                value: value ? 1 : 0,
        });
});

$("#transcode_audio").change(function() {
        var value = !!$(this).attr("checked");
        
        if(value) {
            $("#transcode_mp3").attr("disabled", false);
        }
        else {
            $("#transcode_mp3").attr("disabled", true);
        }
        
        sendRequest({
                method: "set_transcode_audio",
                value: value ? 1 : 0,
        });
});

$("#preferred_audio_language").change(function() {
        sendRequest({
                method: "set_preferred_audio_language",
                value: $("#preferred_audio_language").val()
        });
});

$("#skip_transcode_mp3").change(function() {
        var value = !!$(this).attr("checked");
        sendRequest({
                method: "set_transcode_mp3",
                value: value ? 0 : 1,
        });
});

$(".output_stream_format_live").change(function() {
        var value = $(".output_stream_format_live:checked").val();
        sendRequest({
                method: "set_playlist_output_format_live",
                value: value
        });
});

$(".output_stream_format_vod").change(function() {
        var value = $(".output_stream_format_vod:checked").val();
        sendRequest({
                method: "set_playlist_output_format_vod",
                value: value
        });
});

$("#allow_remote_access").change(function() {
        var value = !!$(this).attr("checked");
        reload_playlist_url(params.ip_list);
        sendRequest({
                method: "set_allow_remote_access",
                value: value ? 1 : 0
        });
});

$("#btn_add").click(function() {
        var category = $("#category").val(),
            title = $("#title").val(),
            content_id = $("#content_id").val(),
            use_info_messages = !!$("#use_info_messages").attr("checked");
            
        if(title.length == 0) {
            alert("Empty title");
            return false;
        }
        if(content_id.length == 0) {
            alert("Empty content id");
            return false;
        }
        sendRequest({
            method: "playlist_add_item",
            category: category,
            title: title,
            content_id: content_id
            },
            // onsuccess
            function(response) {
                $("#title").val("");
                $("#content_id").val("");
                reload_playlist();
            },
            // failure
            function(error) {
                alert(error);
            }
        );
});
</script>

</body>

</html>