From c7d2c0a8b390f7114a82647c673f6348d859bbe2 Mon Sep 17 00:00:00 2001
From: "Sascha Kuehndel (InuSasha)" <dev@inusasha.de>
Date: Mon, 18 Mar 2019 09:19:19 +0100
Subject: [PATCH] buildsystem: activate hardening flags - based on the flags
 used in ubuntu: https://wiki.ubuntu.com/ToolChain/CompilerFlags - drop PIE,
 because it require PIC

---
 config/optimize                                             | 6 +++---
 distributions/LibreELEC/options                             | 2 +-
 .../addons/addon-depends/ffmpegx-depends/libvpx/package.mk  | 1 +
 .../addon-depends/system-tools-depends/htop/package.mk      | 1 +
 packages/compress/unzip/package.mk                          | 1 +
 packages/compress/zip/package.mk                            | 1 +
 packages/emulation/libretro-fbalpha/package.mk              | 1 +
 packages/emulation/libretro-uae/package.mk                  | 2 +-
 packages/emulation/libretro-uae4arm/package.mk              | 1 +
 packages/linux-driver-addons/dvb/crazycat/package.mk        | 1 +
 packages/linux-driver-addons/dvb/digital_devices/package.mk | 1 +
 packages/linux-driver-addons/dvb/dvb-latest/package.mk      | 1 +
 packages/network/avahi/package.mk                           | 1 +
 packages/network/iptables/package.mk                        | 1 +
 packages/sysutils/keyutils/package.mk                       | 2 +-
 15 files changed, 17 insertions(+), 6 deletions(-)

diff --git a/config/optimize b/config/optimize
index 9c57fcaa92d..4d6e2cec34a 100644
--- a/config/optimize
+++ b/config/optimize
@@ -59,10 +59,10 @@ LDFLAGS_OPTIM_PIC="-fPIC"
 
 # hardening support
 # TODO: basiclly copied from debian 9, should adjust for LE
-CFLAGS_OPTIM_HARDENING="-fstack-protector-strong -Wformat -Werror=format-security -fPIE"
-CXXFLAGS_OPTIM_HARDENING="-fstack-protector-strong -Wformat -Werror=format-security -fPIE"
+CFLAGS_OPTIM_HARDENING="-fstack-protector-strong -Wformat -Werror=format-security"
+CXXFLAGS_OPTIM_HARDENING="-fstack-protector-strong -Wformat -Werror=format-security"
 CPPFLAGS_OPTIM_HARDENING="-D_FORTIFY_SOURCE=2"
-LDFLAGS_OPTIM_HARDENING="-Wl,-z,relro -Wl,-z,now"
+LDFLAGS_OPTIM_HARDENING="-Wl,-z,relro -Wl,-z,now -Wl,--hash-style=gnu -Wl,--no-copy-dt-needed-entries -Wl,--as-needed"
 
 # add distro specific library dirs
 if [ -z "$HOST_LIBDIR" ]; then
diff --git a/distributions/LibreELEC/options b/distributions/LibreELEC/options
index 32c42d5689c..f1280c11458 100644
--- a/distributions/LibreELEC/options
+++ b/distributions/LibreELEC/options
@@ -5,7 +5,7 @@
   GOLD_SUPPORT="yes"
 
 # HARDENING (security relevant linker and compiler flags) support
-  HARDENING_SUPPORT="no"
+  HARDENING_SUPPORT="yes"
 
 # Name of the Distro to build (full name, without special characters)
   DISTRONAME="LibreELEC"
diff --git a/packages/addons/addon-depends/ffmpegx-depends/libvpx/package.mk b/packages/addons/addon-depends/ffmpegx-depends/libvpx/package.mk
index f11d9882625..8c039750464 100644
--- a/packages/addons/addon-depends/ffmpegx-depends/libvpx/package.mk
+++ b/packages/addons/addon-depends/ffmpegx-depends/libvpx/package.mk
@@ -9,6 +9,7 @@ PKG_SITE="https://www.webmproject.org"
 PKG_URL="https://github.com/webmproject/libvpx/archive/v${PKG_VERSION}.tar.gz"
 PKG_DEPENDS_TARGET="toolchain"
 PKG_LONGDESC="WebM VP8/VP9 Codec"
+PKG_BUILD_FLAGS="-hardening"
 
 if [ "$TARGET_ARCH" = "x86_64" ]; then
   PKG_DEPENDS_TARGET+=" nasm:host"
diff --git a/packages/addons/addon-depends/system-tools-depends/htop/package.mk b/packages/addons/addon-depends/system-tools-depends/htop/package.mk
index fffd0dfc539..733eb704ef6 100644
--- a/packages/addons/addon-depends/system-tools-depends/htop/package.mk
+++ b/packages/addons/addon-depends/system-tools-depends/htop/package.mk
@@ -10,6 +10,7 @@ PKG_URL="https://github.com/hishamhm/htop/archive/$PKG_VERSION.tar.gz"
 PKG_DEPENDS_TARGET="toolchain ncurses"
 PKG_LONGDESC="An interactive process viewer for Unix."
 PKG_TOOLCHAIN="autotools"
+PKG_BUILD_FLAGS="-hardening"
 
 PKG_CONFIGURE_OPTS_TARGET="--disable-unicode \
                            HTOP_NCURSES_CONFIG_SCRIPT=ncurses-config"
diff --git a/packages/compress/unzip/package.mk b/packages/compress/unzip/package.mk
index 0ddca31edb5..4b870ae72a0 100644
--- a/packages/compress/unzip/package.mk
+++ b/packages/compress/unzip/package.mk
@@ -10,6 +10,7 @@ PKG_URL="http://ftp.uk.i-scream.org/sites/www.ibiblio.org/gentoo/distfiles/$PKG_
 PKG_DEPENDS_TARGET="toolchain"
 PKG_LONGDESC="UnZip is an extraction utility for archives compressed in .zip format."
 PKG_TOOLCHAIN="manual"
+PKG_BUILD_FLAGS="-hardening"
 
 make_target() {
     make CC=$CC RANLIB=$RANLIB AR=$AR STRIP=$STRIP \
diff --git a/packages/compress/zip/package.mk b/packages/compress/zip/package.mk
index ce3b160422d..6ccab0243b6 100644
--- a/packages/compress/zip/package.mk
+++ b/packages/compress/zip/package.mk
@@ -10,6 +10,7 @@ PKG_URL="$SOURCEFORGE_SRC/infozip/Zip%203.x%20%28latest%29/3.0/${PKG_NAME}${PKG_
 PKG_DEPENDS_TARGET="toolchain bzip2"
 PKG_LONGDESC="A compression and file packaging utility."
 PKG_TOOLCHAIN="manual"
+PKG_BUILD_FLAGS="-hardening"
 
 make_target() {
   make CC=$CC CPP=$CPP RANLIB=$RANLIB AR=$AR STRIP=$STRIP LOCAL_ZIP="$CFLAGS" \
diff --git a/packages/emulation/libretro-fbalpha/package.mk b/packages/emulation/libretro-fbalpha/package.mk
index abc268c96a5..4fce4b0a1c5 100644
--- a/packages/emulation/libretro-fbalpha/package.mk
+++ b/packages/emulation/libretro-fbalpha/package.mk
@@ -10,6 +10,7 @@ PKG_URL="https://github.com/libretro/fbalpha/archive/$PKG_VERSION.tar.gz"
 PKG_DEPENDS_TARGET="toolchain kodi-platform"
 PKG_LONGDESC="game.libretro.fba: fba for Kodi"
 PKG_TOOLCHAIN="make"
+PKG_BUILD_FLAGS="-hardening"
 
 PKG_LIBNAME="fbalpha_libretro.so"
 PKG_LIBPATH="$PKG_LIBNAME"
diff --git a/packages/emulation/libretro-uae/package.mk b/packages/emulation/libretro-uae/package.mk
index a51eaf14421..1b1036daa49 100644
--- a/packages/emulation/libretro-uae/package.mk
+++ b/packages/emulation/libretro-uae/package.mk
@@ -9,7 +9,7 @@ PKG_SITE="https://github.com/libretro/libretro-uae"
 PKG_URL="https://github.com/libretro/libretro-uae/archive/$PKG_VERSION.tar.gz"
 PKG_DEPENDS_TARGET="toolchain kodi-platform"
 PKG_LONGDESC="libretro wrapper for UAE emulator."
-PKG_BUILD_FLAGS="-lto"
+PKG_BUILD_FLAGS="-lto -hardening"
 
 PKG_LIBNAME="puae_libretro.so"
 PKG_LIBPATH="$PKG_LIBNAME"
diff --git a/packages/emulation/libretro-uae4arm/package.mk b/packages/emulation/libretro-uae4arm/package.mk
index 28394b7e6ad..2058f813e1f 100644
--- a/packages/emulation/libretro-uae4arm/package.mk
+++ b/packages/emulation/libretro-uae4arm/package.mk
@@ -10,6 +10,7 @@ PKG_SITE="https://github.com/libretro/uae4arm-libretro"
 PKG_URL="https://github.com/libretro/uae4arm-libretro/archive/$PKG_VERSION.tar.gz"
 PKG_DEPENDS_TARGET="toolchain zlib"
 PKG_LONGDESC="UAE4ARM amiga emulator."
+PKG_BUILD_FLAGS="-hardening"
 
 PKG_LIBNAME="uae4arm_libretro.so"
 PKG_LIBPATH="$PKG_LIBNAME"
diff --git a/packages/linux-driver-addons/dvb/crazycat/package.mk b/packages/linux-driver-addons/dvb/crazycat/package.mk
index 2cc34987de8..06327e88588 100644
--- a/packages/linux-driver-addons/dvb/crazycat/package.mk
+++ b/packages/linux-driver-addons/dvb/crazycat/package.mk
@@ -11,6 +11,7 @@ PKG_DEPENDS_TARGET="toolchain linux media_tree_cc"
 PKG_NEED_UNPACK="$LINUX_DEPENDS $(get_pkg_directory media_tree_cc)"
 PKG_SECTION="driver.dvb"
 PKG_LONGDESC="DVB driver for TBS cards with CrazyCats additions"
+PKG_BUILD_FLAGS="-hardening"
 
 PKG_IS_ADDON="embedded"
 PKG_IS_KERNEL_PKG="yes"
diff --git a/packages/linux-driver-addons/dvb/digital_devices/package.mk b/packages/linux-driver-addons/dvb/digital_devices/package.mk
index 1834ca491b0..80379a901f8 100644
--- a/packages/linux-driver-addons/dvb/digital_devices/package.mk
+++ b/packages/linux-driver-addons/dvb/digital_devices/package.mk
@@ -13,6 +13,7 @@ PKG_BUILD_DEPENDS_TARGET="toolchain linux"
 PKG_NEED_UNPACK="$LINUX_DEPENDS"
 PKG_SECTION="driver.dvb"
 PKG_LONGDESC="DVB driver for Digital Devices cards"
+PKG_BUILD_FLAGS="-hardening"
 
 PKG_IS_ADDON="embedded"
 PKG_ADDON_IS_STANDALONE="yes"
diff --git a/packages/linux-driver-addons/dvb/dvb-latest/package.mk b/packages/linux-driver-addons/dvb/dvb-latest/package.mk
index 6a58f3a1eab..0f202af66b5 100644
--- a/packages/linux-driver-addons/dvb/dvb-latest/package.mk
+++ b/packages/linux-driver-addons/dvb/dvb-latest/package.mk
@@ -11,6 +11,7 @@ PKG_DEPENDS_TARGET="toolchain linux media_tree"
 PKG_NEED_UNPACK="$LINUX_DEPENDS $(get_pkg_directory media_tree)"
 PKG_SECTION="driver.dvb"
 PKG_LONGDESC="DVB drivers from the latest kernel (media_build)"
+PKG_BUILD_FLAGS="-hardening"
 
 PKG_IS_ADDON="embedded"
 PKG_IS_KERNEL_PKG="yes"
diff --git a/packages/network/avahi/package.mk b/packages/network/avahi/package.mk
index cb4876df921..59ca51ed2d3 100644
--- a/packages/network/avahi/package.mk
+++ b/packages/network/avahi/package.mk
@@ -10,6 +10,7 @@ PKG_URL="https://github.com/lathiat/avahi/archive/v$PKG_VERSION.tar.gz"
 PKG_DEPENDS_TARGET="toolchain expat libdaemon dbus connman"
 PKG_LONGDESC="Service Discovery for Linux using mDNS/DNS-SD, compatible with Bonjour."
 PKG_TOOLCHAIN="configure"
+PKG_BUILD_FLAGS="-hardening"
 
 PKG_CONFIGURE_OPTS_TARGET="py_cv_mod_gtk_=yes \
                            py_cv_mod_dbus_=yes \
diff --git a/packages/network/iptables/package.mk b/packages/network/iptables/package.mk
index 366eec5bdb5..29833fa40d2 100644
--- a/packages/network/iptables/package.mk
+++ b/packages/network/iptables/package.mk
@@ -11,6 +11,7 @@ PKG_URL="http://www.netfilter.org/projects/iptables/files/$PKG_NAME-$PKG_VERSION
 PKG_DEPENDS_TARGET="toolchain linux libmnl libnftnl"
 PKG_LONGDESC="IP packet filter administration."
 PKG_TOOLCHAIN="autotools"
+PKG_BUILD_FLAGS="-hardening"
 
 PKG_CONFIGURE_OPTS_TARGET="--with-kernel=$(kernel_path)"
 
diff --git a/packages/sysutils/keyutils/package.mk b/packages/sysutils/keyutils/package.mk
index e8a2160daf3..0ef614b4d89 100644
--- a/packages/sysutils/keyutils/package.mk
+++ b/packages/sysutils/keyutils/package.mk
@@ -10,7 +10,7 @@ PKG_SITE="http://people.redhat.com/~dhowells/keyutils/"
 PKG_URL="http://people.redhat.com/~dhowells/keyutils/$PKG_NAME-$PKG_VERSION.tar.bz2"
 PKG_DEPENDS_TARGET="toolchain"
 PKG_LONGDESC="Keyutils is a set of utilities for managing the key retention facility in the kernel."
-PKG_BUILD_FLAGS="+pic"
+PKG_BUILD_FLAGS="+pic -hardening"
 
 PKG_MAKE_OPTS_TARGET="NO_ARLIB=0 NO_SOLIB=1 BINDIR=/usr/bin SBINDIR=/usr/sbin LIBDIR=/usr/lib USRLIBDIR=/usr/lib"
 PKG_MAKEINSTALL_OPTS_TARGET="$PKG_MAKE_OPTS_TARGET"
