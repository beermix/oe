From 54adef00203e128818635b52f60f0834b6bfd9f6 Mon Sep 17 00:00:00 2001
From: MilhouseVH <milhouseVH.github@nmacleod.com>
Date: Thu, 21 Sep 2017 04:35:39 +0100
Subject: [PATCH 1/7] linux: update to linux-4.14-rc1

---
 packages/linux/package.mk | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/packages/linux/package.mk b/packages/linux/package.mk
index 8aa07912cb3..0de09fa2509 100644
--- a/packages/linux/package.mk
+++ b/packages/linux/package.mk
@@ -63,9 +63,9 @@ case "$LINUX" in
     PKG_DEPENDS_TARGET="$PKG_DEPENDS_TARGET imx6-status-led imx6-soc-fan irqbalanced"
     ;;
   *)
-    PKG_VERSION="4.13"
-    PKG_SHA256="2db3d6066c3ad93eb25b973a3d2951e022a7e975ee2fa7cbe5bddf84d9a49a2c"
-    PKG_URL="https://www.kernel.org/pub/linux/kernel/v4.x/$PKG_NAME-$PKG_VERSION.tar.xz"
+    PKG_VERSION="4.14-rc1"
+    PKG_SHA256="f18d4227e00b249bbc88f4aa49c4587c89748541400bc7bff71709cf9ed40c36"
+    PKG_URL="https://git.kernel.org/torvalds/t/$PKG_NAME-$PKG_VERSION.tar.gz"
     PKG_PATCH_DIRS="default"
     ;;
 esac

From 8a95fbd7454f8cd2ec231e7360a8fb87ac9136dd Mon Sep 17 00:00:00 2001
From: MilhouseVH <milhouseVH.github@nmacleod.com>
Date: Thu, 21 Sep 2017 04:35:39 +0100
Subject: [PATCH 2/7] RPi: update linux support patch for linux 4.14-rc1

---
 .../RPi/patches/linux/linux-01-RPi_support.patch   | 9945 ++++++++------------
 1 file changed, 3695 insertions(+), 6250 deletions(-)

diff --git a/projects/RPi/patches/linux/linux-01-RPi_support.patch b/projects/RPi/patches/linux/linux-01-RPi_support.patch
index 34e42117fb4..dca9750c403 100644
--- a/projects/RPi/patches/linux/linux-01-RPi_support.patch
+++ b/projects/RPi/patches/linux/linux-01-RPi_support.patch
@@ -1,7 +1,7 @@
-From 4d31e91165e50dab3ce5b4b78bc589d67bd70e0b Mon Sep 17 00:00:00 2001
+From 2c6d82a3f5e0aadd118ad2b2c1f2437b01291e67 Mon Sep 17 00:00:00 2001
 From: Steve Glendinning <steve.glendinning@smsc.com>
 Date: Thu, 19 Feb 2015 18:47:12 +0000
-Subject: [PATCH 001/173] smsx95xx: fix crimes against truesize
+Subject: [PATCH 001/126] smsx95xx: fix crimes against truesize
 
 smsc95xx is adjusting truesize when it shouldn't, and following a recent patch from Eric this is now triggering warnings.
 
@@ -13,7 +13,7 @@ Signed-off-by: Steve Glendinning <steve.glendinning@smsc.com>
  1 file changed, 8 insertions(+), 2 deletions(-)
 
 diff --git a/drivers/net/usb/smsc95xx.c b/drivers/net/usb/smsc95xx.c
-index 340c13484e5cc7dd5001577b7522d5a4318bd5b6..7d3d98f0405ad948f9ab3e035a70e15c667e4fa1 100644
+index 309b88acd3d0b6ca1528dde7b27a23926f9be952..25e37195ceb00cfc0ced7638e8b571a1b0b8e6f1 100644
 --- a/drivers/net/usb/smsc95xx.c
 +++ b/drivers/net/usb/smsc95xx.c
 @@ -82,6 +82,10 @@ static bool turbo_mode = true;
@@ -27,7 +27,7 @@ index 340c13484e5cc7dd5001577b7522d5a4318bd5b6..7d3d98f0405ad948f9ab3e035a70e15c
  static int __must_check __smsc95xx_read_reg(struct usbnet *dev, u32 index,
  					    u32 *data, int in_pm)
  {
-@@ -1960,7 +1964,8 @@ static int smsc95xx_rx_fixup(struct usbnet *dev, struct sk_buff *skb)
+@@ -1959,7 +1963,8 @@ static int smsc95xx_rx_fixup(struct usbnet *dev, struct sk_buff *skb)
  				if (dev->net->features & NETIF_F_RXCSUM)
  					smsc95xx_rx_csum_offload(skb);
  				skb_trim(skb, skb->len - 4); /* remove fcs */
@@ -37,7 +37,7 @@ index 340c13484e5cc7dd5001577b7522d5a4318bd5b6..7d3d98f0405ad948f9ab3e035a70e15c
  
  				return 1;
  			}
-@@ -1978,7 +1983,8 @@ static int smsc95xx_rx_fixup(struct usbnet *dev, struct sk_buff *skb)
+@@ -1977,7 +1982,8 @@ static int smsc95xx_rx_fixup(struct usbnet *dev, struct sk_buff *skb)
  			if (dev->net->features & NETIF_F_RXCSUM)
  				smsc95xx_rx_csum_offload(ax_skb);
  			skb_trim(ax_skb, ax_skb->len - 4); /* remove fcs */
@@ -48,10 +48,10 @@ index 340c13484e5cc7dd5001577b7522d5a4318bd5b6..7d3d98f0405ad948f9ab3e035a70e15c
  			usbnet_skb_return(dev, ax_skb);
  		}
 
-From 54fc9336b4a858bf7833f4549f96b16e187192b2 Mon Sep 17 00:00:00 2001
+From eebed5915a40f74b012d85945fed8c30ede36a81 Mon Sep 17 00:00:00 2001
 From: Sam Nazarko <email@samnazarko.co.uk>
 Date: Fri, 1 Apr 2016 17:27:21 +0100
-Subject: [PATCH 002/173] smsc95xx: Experimental: Enable turbo_mode and
+Subject: [PATCH 002/126] smsc95xx: Experimental: Enable turbo_mode and
  packetsize=2560 by default
 
 See: http://forum.kodi.tv/showthread.php?tid=285288
@@ -60,7 +60,7 @@ See: http://forum.kodi.tv/showthread.php?tid=285288
  1 file changed, 9 insertions(+), 5 deletions(-)
 
 diff --git a/drivers/net/usb/smsc95xx.c b/drivers/net/usb/smsc95xx.c
-index 7d3d98f0405ad948f9ab3e035a70e15c667e4fa1..8d34e517db08d895e6135f785c42bf639671815c 100644
+index 25e37195ceb00cfc0ced7638e8b571a1b0b8e6f1..09c7d4a07299e70b1cdc9df2c2c4cb39d2207c37 100644
 --- a/drivers/net/usb/smsc95xx.c
 +++ b/drivers/net/usb/smsc95xx.c
 @@ -86,6 +86,10 @@ static bool truesize_mode = false;
@@ -74,7 +74,7 @@ index 7d3d98f0405ad948f9ab3e035a70e15c667e4fa1..8d34e517db08d895e6135f785c42bf63
  static int __must_check __smsc95xx_read_reg(struct usbnet *dev, u32 index,
  					    u32 *data, int in_pm)
  {
-@@ -1107,13 +1111,13 @@ static int smsc95xx_reset(struct usbnet *dev)
+@@ -1106,13 +1110,13 @@ static int smsc95xx_reset(struct usbnet *dev)
  
  	if (!turbo_mode) {
  		burst_cap = 0;
@@ -94,10 +94,10 @@ index 7d3d98f0405ad948f9ab3e035a70e15c667e4fa1..8d34e517db08d895e6135f785c42bf63
  
  	netif_dbg(dev, ifup, dev->net, "rx_urb_size=%ld\n",
 
-From 9c3373c84a4a3740f9e502e256b6cf6b75499e53 Mon Sep 17 00:00:00 2001
+From 45bf110535b0c4c737fe0f06333efa7142f59bfe Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Tue, 26 Mar 2013 17:26:38 +0000
-Subject: [PATCH 003/173] Allow mac address to be set in smsc95xx
+Subject: [PATCH 003/126] Allow mac address to be set in smsc95xx
 
 Signed-off-by: popcornmix <popcornmix@gmail.com>
 ---
@@ -105,7 +105,7 @@ Signed-off-by: popcornmix <popcornmix@gmail.com>
  1 file changed, 56 insertions(+)
 
 diff --git a/drivers/net/usb/smsc95xx.c b/drivers/net/usb/smsc95xx.c
-index 8d34e517db08d895e6135f785c42bf639671815c..5df7e105c41532c3185e46ee54f43a371b787caa 100644
+index 09c7d4a07299e70b1cdc9df2c2c4cb39d2207c37..4d9704d0b184df9bd7ddbe6769e40a7584f22a42 100644
 --- a/drivers/net/usb/smsc95xx.c
 +++ b/drivers/net/usb/smsc95xx.c
 @@ -60,6 +60,7 @@
@@ -127,7 +127,7 @@ index 8d34e517db08d895e6135f785c42bf639671815c..5df7e105c41532c3185e46ee54f43a37
  static int __must_check __smsc95xx_read_reg(struct usbnet *dev, u32 index,
  					    u32 *data, int in_pm)
  {
-@@ -919,6 +924,53 @@ static int smsc95xx_ioctl(struct net_device *netdev, struct ifreq *rq, int cmd)
+@@ -918,6 +923,53 @@ static int smsc95xx_ioctl(struct net_device *netdev, struct ifreq *rq, int cmd)
  	return generic_mii_ioctl(&dev->mii, if_mii(rq), cmd, NULL);
  }
  
@@ -181,7 +181,7 @@ index 8d34e517db08d895e6135f785c42bf639671815c..5df7e105c41532c3185e46ee54f43a37
  static void smsc95xx_init_mac_address(struct usbnet *dev)
  {
  	const u8 *mac_addr;
-@@ -940,6 +992,10 @@ static void smsc95xx_init_mac_address(struct usbnet *dev)
+@@ -939,6 +991,10 @@ static void smsc95xx_init_mac_address(struct usbnet *dev)
  		}
  	}
  
@@ -193,10 +193,10 @@ index 8d34e517db08d895e6135f785c42bf639671815c..5df7e105c41532c3185e46ee54f43a37
  	eth_hw_addr_random(dev->net);
  	netif_dbg(dev, ifup, dev->net, "MAC address set to eth_random_addr\n");
 
-From 4733376458500aefc53f7bb02e16c6fd57439295 Mon Sep 17 00:00:00 2001
+From 34031692ec7ff852b9e07cba03f912d0a5308e68 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Fri, 13 Mar 2015 12:43:36 +0000
-Subject: [PATCH 004/173] Protect __release_resource against resources without
+Subject: [PATCH 004/126] Protect __release_resource against resources without
  parents
 
 Without this patch, removing a device tree overlay can crash here.
@@ -224,10 +224,10 @@ index 9b5f04404152c296af3a96132f27cfc80ffa9af9..f8a9af6e6b915812be2ba2c1c2b40106
  	for (;;) {
  		tmp = *p;
 
-From 6ae5f9ee8ed27f0a0646a8949b27747a60df627e Mon Sep 17 00:00:00 2001
+From 9092689dbaef48a0be3e599067943aa6fc7e894a Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Fri, 4 Dec 2015 17:41:50 +0000
-Subject: [PATCH 005/173] irq-bcm2836: Prevent spurious interrupts, and trap
+Subject: [PATCH 005/126] irq-bcm2836: Prevent spurious interrupts, and trap
  them early
 
 The old arch-specific IRQ macros included a dsb to ensure the
@@ -242,7 +242,7 @@ though, so trap them early.
  1 file changed, 1 insertion(+)
 
 diff --git a/drivers/irqchip/irq-bcm2836.c b/drivers/irqchip/irq-bcm2836.c
-index e7463e3c08143acae3e8cc5682f918c6a0b07ebd..a8db33b50ad9ff83d284fa54fe4d3b65f859df0f 100644
+index dc8c1e3eafe794a3af83dd987a6d6362d14dd5ee..e8204d9af58f1b893505c06902a83390c2ea8509 100644
 --- a/drivers/irqchip/irq-bcm2836.c
 +++ b/drivers/irqchip/irq-bcm2836.c
 @@ -175,6 +175,7 @@ __exception_irq_entry bcm2836_arm_irqchip_handle_irq(struct pt_regs *regs)
@@ -254,10 +254,10 @@ index e7463e3c08143acae3e8cc5682f918c6a0b07ebd..a8db33b50ad9ff83d284fa54fe4d3b65
  #endif
  	} else if (stat) {
 
-From df9ca00f2536bd3c258fd212fbc50f0388ec0051 Mon Sep 17 00:00:00 2001
+From 6d222670741dd194bfa2423045ffff852324029d Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Thu, 9 Feb 2017 14:33:30 +0000
-Subject: [PATCH 006/173] irq-bcm2836: Avoid "Invalid trigger warning"
+Subject: [PATCH 006/126] irq-bcm2836: Avoid "Invalid trigger warning"
 
 Initialise the level for each IRQ to avoid a warning from the
 arm arch timer code.
@@ -268,7 +268,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  1 file changed, 1 insertion(+), 1 deletion(-)
 
 diff --git a/drivers/irqchip/irq-bcm2836.c b/drivers/irqchip/irq-bcm2836.c
-index a8db33b50ad9ff83d284fa54fe4d3b65f859df0f..c4e151451cf8c8ebde5225515eac2786d6f61d46 100644
+index e8204d9af58f1b893505c06902a83390c2ea8509..6e3fab9587b782e026c01fa6b6e40338ef0c8d0a 100644
 --- a/drivers/irqchip/irq-bcm2836.c
 +++ b/drivers/irqchip/irq-bcm2836.c
 @@ -157,7 +157,7 @@ static void bcm2836_arm_irqchip_register_irq(int hwirq, struct irq_chip *chip)
@@ -281,10 +281,10 @@ index a8db33b50ad9ff83d284fa54fe4d3b65f859df0f..c4e151451cf8c8ebde5225515eac2786
  
  static void
 
-From 738c1a7eac3f687fc2e828be2ab02a173367afe3 Mon Sep 17 00:00:00 2001
+From 4a6ae291c0d82491eaeaeab09703fb484070a6dc Mon Sep 17 00:00:00 2001
 From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
 Date: Fri, 12 Jun 2015 19:01:05 +0200
-Subject: [PATCH 007/173] irqchip: bcm2835: Add FIQ support
+Subject: [PATCH 007/126] irqchip: bcm2835: Add FIQ support
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -314,7 +314,7 @@ index 73be3d5788510e953a460c76437db3f22c3d7bda..3c7d01eaa341b03ced0ba9aadb705463
  	select PINCTRL_BCM2835
  	help
 diff --git a/drivers/irqchip/irq-bcm2835.c b/drivers/irqchip/irq-bcm2835.c
-index 44d7c38dde479d771f3552e914bf8c1c1f5019f7..42ff5e6a8e0d532f5b60a1e7af7cc4d941bd5008 100644
+index d2da8a1e6b1b71381e382d034e7a94e865a6c3da..c4903360eabc2bef04f8e745782cea268fb22897 100644
 --- a/drivers/irqchip/irq-bcm2835.c
 +++ b/drivers/irqchip/irq-bcm2835.c
 @@ -54,7 +54,7 @@
@@ -381,9 +381,9 @@ index 44d7c38dde479d771f3552e914bf8c1c1f5019f7..42ff5e6a8e0d532f5b60a1e7af7cc4d9
  }
  
  static struct irq_chip armctrl_chip = {
-@@ -150,8 +178,9 @@ static int __init armctrl_of_init(struct device_node *node,
- 		panic("%s: unable to map IC registers\n",
- 			node->full_name);
+@@ -149,8 +177,9 @@ static int __init armctrl_of_init(struct device_node *node,
+ 	if (!base)
+ 		panic("%pOF: unable to map IC registers\n", node);
  
 -	intc.domain = irq_domain_add_linear(node, MAKE_HWIRQ(NR_BANKS, 0),
 -			&armctrl_ops, NULL);
@@ -391,9 +391,9 @@ index 44d7c38dde479d771f3552e914bf8c1c1f5019f7..42ff5e6a8e0d532f5b60a1e7af7cc4d9
 +	intc.domain = irq_domain_add_linear(node, NUMBER_IRQS * 2,
 +					    &armctrl_ops, NULL);
  	if (!intc.domain)
- 		panic("%s: unable to create IRQ domain\n", node->full_name);
+ 		panic("%pOF: unable to create IRQ domain\n", node);
  
-@@ -181,6 +210,18 @@ static int __init armctrl_of_init(struct device_node *node,
+@@ -180,6 +209,18 @@ static int __init armctrl_of_init(struct device_node *node,
  		set_handle_irq(bcm2835_handle_irq);
  	}
  
@@ -413,10 +413,10 @@ index 44d7c38dde479d771f3552e914bf8c1c1f5019f7..42ff5e6a8e0d532f5b60a1e7af7cc4d9
  }
  
 
-From 2088067b398e00f0fb16984d0723193853ebe910 Mon Sep 17 00:00:00 2001
+From 36fdfbb634818bc601224919e360a58da3d8be5c Mon Sep 17 00:00:00 2001
 From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
 Date: Fri, 23 Oct 2015 16:26:55 +0200
-Subject: [PATCH 008/173] irqchip: irq-bcm2835: Add 2836 FIQ support
+Subject: [PATCH 008/126] irqchip: irq-bcm2835: Add 2836 FIQ support
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -427,7 +427,7 @@ Signed-off-by: Noralf Trønnes <noralf@tronnes.org>
  1 file changed, 41 insertions(+), 2 deletions(-)
 
 diff --git a/drivers/irqchip/irq-bcm2835.c b/drivers/irqchip/irq-bcm2835.c
-index 42ff5e6a8e0d532f5b60a1e7af7cc4d941bd5008..eccf6ed025299cb480884f5bcbe77abf55a6bbb1 100644
+index c4903360eabc2bef04f8e745782cea268fb22897..13356d3b7bcd508f058c6a9e3c4b0b385d478ef4 100644
 --- a/drivers/irqchip/irq-bcm2835.c
 +++ b/drivers/irqchip/irq-bcm2835.c
 @@ -50,8 +50,11 @@
@@ -498,7 +498,7 @@ index 42ff5e6a8e0d532f5b60a1e7af7cc4d941bd5008..eccf6ed025299cb480884f5bcbe77abf
  }
  
  static struct irq_chip armctrl_chip = {
-@@ -210,6 +240,15 @@ static int __init armctrl_of_init(struct device_node *node,
+@@ -209,6 +239,15 @@ static int __init armctrl_of_init(struct device_node *node,
  		set_handle_irq(bcm2835_handle_irq);
  	}
  
@@ -515,10 +515,49 @@ index 42ff5e6a8e0d532f5b60a1e7af7cc4d941bd5008..eccf6ed025299cb480884f5bcbe77abf
  	for (b = 0; b < NR_BANKS; b++) {
  		for (i = 0; i < bank_irqs[b]; i++) {
 
-From 5f9a37381bb18029137e2d8e6c269a15586f82a8 Mon Sep 17 00:00:00 2001
+From f7965650d51f8e13a1ac0aa49c6cf7fb5dee493d Mon Sep 17 00:00:00 2001
+From: Phil Elwell <phil@raspberrypi.org>
+Date: Mon, 8 May 2017 16:43:40 +0100
+Subject: [PATCH 009/126] irq_bcm2836: Send event when onlining sleeping cores
+
+In order to reduce power consumption and bus traffic, it is sensible
+for secondary cores to enter a low-power idle state when waiting to
+be started. The wfe instruction causes a core to wait until an event
+or interrupt arrives before continuing to the next instruction.
+The sev instruction sends a wakeup event to the other cores, so call
+it from bcm2836_smp_boot_secondary, the function that wakes up the
+waiting cores during booting.
+
+It is harmless to use this patch without the corresponding change
+adding wfe to the ARMv7/ARMv8-32 stubs, but if the stubs are updated
+and this patch is not applied then the other cores will sleep forever.
+
+See: https://github.com/raspberrypi/linux/issues/1989
+
+Signed-off-by: Phil Elwell <phil@raspberrypi.org>
+---
+ drivers/irqchip/irq-bcm2836.c | 3 +++
+ 1 file changed, 3 insertions(+)
+
+diff --git a/drivers/irqchip/irq-bcm2836.c b/drivers/irqchip/irq-bcm2836.c
+index 6e3fab9587b782e026c01fa6b6e40338ef0c8d0a..86b357ae027bf8ba1ac32cd150a8cf21e36597e2 100644
+--- a/drivers/irqchip/irq-bcm2836.c
++++ b/drivers/irqchip/irq-bcm2836.c
+@@ -227,6 +227,9 @@ static int __init bcm2836_smp_boot_secondary(unsigned int cpu,
+ 	writel(secondary_startup_phys,
+ 	       intc.base + LOCAL_MAILBOX3_SET0 + 16 * cpu);
+ 
++	dsb(sy); /* Ensure write has completed before waking the other CPUs */
++	sev();
++
+ 	return 0;
+ }
+ 
+
+From e4a86aedb1f222b4822240e1deb092002c6579b2 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Tue, 14 Jul 2015 10:26:09 +0100
-Subject: [PATCH 009/173] spidev: Add "spidev" compatible string to silence
+Subject: [PATCH 010/126] spidev: Add "spidev" compatible string to silence
  warning
 
 See: https://github.com/raspberrypi/linux/issues/1054
@@ -539,367 +578,10 @@ index cda10719d1d1b21b32866d2b79363faa461ab8e1..4f3779d3aa0960640506725bde918075
  };
  MODULE_DEVICE_TABLE(of, spidev_dt_ids);
 
-From da0f0b0a74f2827634a1914ac8fa0460a611d722 Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Tue, 3 Jan 2017 18:25:01 +0000
-Subject: [PATCH 010/173] Revert "pinctrl: bcm2835: switch to GPIOLIB_IRQCHIP"
-
-This reverts commit 85ae9e512f437cd09bf61564bdba29ab88bab3e3.
----
- drivers/pinctrl/bcm/Kconfig           |   1 -
- drivers/pinctrl/bcm/pinctrl-bcm2835.c | 144 ++++++++++++++++++----------------
- 2 files changed, 76 insertions(+), 69 deletions(-)
-
-diff --git a/drivers/pinctrl/bcm/Kconfig b/drivers/pinctrl/bcm/Kconfig
-index e8c4e4f934a6d388bef3e77b89dc19d1e3a6db66..5691311b93991043e9074c330646d0b4837d296e 100644
---- a/drivers/pinctrl/bcm/Kconfig
-+++ b/drivers/pinctrl/bcm/Kconfig
-@@ -20,7 +20,6 @@ config PINCTRL_BCM2835
- 	bool
- 	select PINMUX
- 	select PINCONF
--	select GPIOLIB_IRQCHIP
- 
- config PINCTRL_IPROC_GPIO
- 	bool "Broadcom iProc GPIO (with PINCONF) driver"
-diff --git a/drivers/pinctrl/bcm/pinctrl-bcm2835.c b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-index 230883168e99a1a3fecc7916ef0a7e0de7e8b3f1..ff3789a11b3c36b922b9d08035abb638187c2f5a 100644
---- a/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-+++ b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-@@ -24,10 +24,12 @@
- #include <linux/device.h>
- #include <linux/err.h>
- #include <linux/gpio/driver.h>
-+#include <linux/interrupt.h>
- #include <linux/io.h>
- #include <linux/irq.h>
- #include <linux/irqdesc.h>
- #include <linux/init.h>
-+#include <linux/irqdomain.h>
- #include <linux/of_address.h>
- #include <linux/of.h>
- #include <linux/of_irq.h>
-@@ -79,6 +81,11 @@ enum bcm2835_pinconf_param {
- #define BCM2835_PINCONF_UNPACK_PARAM(_conf_) ((_conf_) >> 16)
- #define BCM2835_PINCONF_UNPACK_ARG(_conf_) ((_conf_) & 0xffff)
- 
-+struct bcm2835_gpio_irqdata {
-+	struct bcm2835_pinctrl *pc;
-+	int irqgroup;
-+};
-+
- struct bcm2835_pinctrl {
- 	struct device *dev;
- 	void __iomem *base;
-@@ -89,13 +96,16 @@ struct bcm2835_pinctrl {
- 	unsigned int irq_type[BCM2835_NUM_GPIOS];
- 
- 	struct pinctrl_dev *pctl_dev;
-+	struct irq_domain *irq_domain;
- 	struct gpio_chip gpio_chip;
- 	struct pinctrl_gpio_range gpio_range;
- 
--	int irq_group[BCM2835_NUM_IRQS];
-+	struct bcm2835_gpio_irqdata irq_data[BCM2835_NUM_IRQS];
- 	spinlock_t irq_lock[BCM2835_NUM_BANKS];
- };
- 
-+static struct lock_class_key gpio_lock_class;
-+
- /* pins are just named GPIO0..GPIO53 */
- #define BCM2835_GPIO_PIN(a) PINCTRL_PIN(a, "gpio" #a)
- static struct pinctrl_pin_desc bcm2835_gpio_pins[] = {
-@@ -353,6 +363,13 @@ static int bcm2835_gpio_direction_output(struct gpio_chip *chip,
- 	return pinctrl_gpio_direction_output(chip->base + offset);
- }
- 
-+static int bcm2835_gpio_to_irq(struct gpio_chip *chip, unsigned offset)
-+{
-+	struct bcm2835_pinctrl *pc = gpiochip_get_data(chip);
-+
-+	return irq_linear_revmap(pc->irq_domain, offset);
-+}
-+
- static struct gpio_chip bcm2835_gpio_chip = {
- 	.label = MODULE_NAME,
- 	.owner = THIS_MODULE,
-@@ -363,13 +380,14 @@ static struct gpio_chip bcm2835_gpio_chip = {
- 	.get_direction = bcm2835_gpio_get_direction,
- 	.get = bcm2835_gpio_get,
- 	.set = bcm2835_gpio_set,
-+	.to_irq = bcm2835_gpio_to_irq,
- 	.base = -1,
- 	.ngpio = BCM2835_NUM_GPIOS,
- 	.can_sleep = false,
- };
- 
--static void bcm2835_gpio_irq_handle_bank(struct bcm2835_pinctrl *pc,
--					 unsigned int bank, u32 mask)
-+static int bcm2835_gpio_irq_handle_bank(struct bcm2835_pinctrl *pc,
-+					unsigned int bank, u32 mask)
- {
- 	unsigned long events;
- 	unsigned offset;
-@@ -381,49 +399,34 @@ static void bcm2835_gpio_irq_handle_bank(struct bcm2835_pinctrl *pc,
- 	events &= pc->enabled_irq_map[bank];
- 	for_each_set_bit(offset, &events, 32) {
- 		gpio = (32 * bank) + offset;
--		/* FIXME: no clue why the code looks up the type here */
- 		type = pc->irq_type[gpio];
- 
--		generic_handle_irq(irq_linear_revmap(pc->gpio_chip.irqdomain,
--						     gpio));
-+		generic_handle_irq(irq_linear_revmap(pc->irq_domain, gpio));
- 	}
-+
-+	return (events != 0);
- }
- 
--static void bcm2835_gpio_irq_handler(struct irq_desc *desc)
-+static irqreturn_t bcm2835_gpio_irq_handler(int irq, void *dev_id)
- {
--	struct gpio_chip *chip = irq_desc_get_handler_data(desc);
--	struct bcm2835_pinctrl *pc = gpiochip_get_data(chip);
--	struct irq_chip *host_chip = irq_desc_get_chip(desc);
--	int irq = irq_desc_get_irq(desc);
--	int group;
--	int i;
--
--	for (i = 0; i < ARRAY_SIZE(pc->irq); i++) {
--		if (pc->irq[i] == irq) {
--			group = pc->irq_group[i];
--			break;
--		}
--	}
--	/* This should not happen, every IRQ has a bank */
--	if (i == ARRAY_SIZE(pc->irq))
--		BUG();
--
--	chained_irq_enter(host_chip, desc);
-+	struct bcm2835_gpio_irqdata *irqdata = dev_id;
-+	struct bcm2835_pinctrl *pc = irqdata->pc;
-+	int handled = 0;
- 
--	switch (group) {
-+	switch (irqdata->irqgroup) {
- 	case 0: /* IRQ0 covers GPIOs 0-27 */
--		bcm2835_gpio_irq_handle_bank(pc, 0, 0x0fffffff);
-+		handled = bcm2835_gpio_irq_handle_bank(pc, 0, 0x0fffffff);
- 		break;
- 	case 1: /* IRQ1 covers GPIOs 28-45 */
--		bcm2835_gpio_irq_handle_bank(pc, 0, 0xf0000000);
--		bcm2835_gpio_irq_handle_bank(pc, 1, 0x00003fff);
-+		handled = bcm2835_gpio_irq_handle_bank(pc, 0, 0xf0000000) |
-+			  bcm2835_gpio_irq_handle_bank(pc, 1, 0x00003fff);
- 		break;
- 	case 2: /* IRQ2 covers GPIOs 46-53 */
--		bcm2835_gpio_irq_handle_bank(pc, 1, 0x003fc000);
-+		handled = bcm2835_gpio_irq_handle_bank(pc, 1, 0x003fc000);
- 		break;
- 	}
- 
--	chained_irq_exit(host_chip, desc);
-+	return handled ? IRQ_HANDLED : IRQ_NONE;
- }
- 
- static inline void __bcm2835_gpio_irq_config(struct bcm2835_pinctrl *pc,
-@@ -469,8 +472,7 @@ static void bcm2835_gpio_irq_config(struct bcm2835_pinctrl *pc,
- 
- static void bcm2835_gpio_irq_enable(struct irq_data *data)
- {
--	struct gpio_chip *chip = irq_data_get_irq_chip_data(data);
--	struct bcm2835_pinctrl *pc = gpiochip_get_data(chip);
-+	struct bcm2835_pinctrl *pc = irq_data_get_irq_chip_data(data);
- 	unsigned gpio = irqd_to_hwirq(data);
- 	unsigned offset = GPIO_REG_SHIFT(gpio);
- 	unsigned bank = GPIO_REG_OFFSET(gpio);
-@@ -484,8 +486,7 @@ static void bcm2835_gpio_irq_enable(struct irq_data *data)
- 
- static void bcm2835_gpio_irq_disable(struct irq_data *data)
- {
--	struct gpio_chip *chip = irq_data_get_irq_chip_data(data);
--	struct bcm2835_pinctrl *pc = gpiochip_get_data(chip);
-+	struct bcm2835_pinctrl *pc = irq_data_get_irq_chip_data(data);
- 	unsigned gpio = irqd_to_hwirq(data);
- 	unsigned offset = GPIO_REG_SHIFT(gpio);
- 	unsigned bank = GPIO_REG_OFFSET(gpio);
-@@ -591,8 +592,7 @@ static int __bcm2835_gpio_irq_set_type_enabled(struct bcm2835_pinctrl *pc,
- 
- static int bcm2835_gpio_irq_set_type(struct irq_data *data, unsigned int type)
- {
--	struct gpio_chip *chip = irq_data_get_irq_chip_data(data);
--	struct bcm2835_pinctrl *pc = gpiochip_get_data(chip);
-+	struct bcm2835_pinctrl *pc = irq_data_get_irq_chip_data(data);
- 	unsigned gpio = irqd_to_hwirq(data);
- 	unsigned offset = GPIO_REG_SHIFT(gpio);
- 	unsigned bank = GPIO_REG_OFFSET(gpio);
-@@ -618,8 +618,7 @@ static int bcm2835_gpio_irq_set_type(struct irq_data *data, unsigned int type)
- 
- static void bcm2835_gpio_irq_ack(struct irq_data *data)
- {
--	struct gpio_chip *chip = irq_data_get_irq_chip_data(data);
--	struct bcm2835_pinctrl *pc = gpiochip_get_data(chip);
-+	struct bcm2835_pinctrl *pc = irq_data_get_irq_chip_data(data);
- 	unsigned gpio = irqd_to_hwirq(data);
- 
- 	bcm2835_gpio_set_bit(pc, GPEDS0, gpio);
-@@ -662,11 +661,10 @@ static void bcm2835_pctl_pin_dbg_show(struct pinctrl_dev *pctldev,
- 		unsigned offset)
- {
- 	struct bcm2835_pinctrl *pc = pinctrl_dev_get_drvdata(pctldev);
--	struct gpio_chip *chip = &pc->gpio_chip;
- 	enum bcm2835_fsel fsel = bcm2835_pinctrl_fsel_get(pc, offset);
- 	const char *fname = bcm2835_functions[fsel];
- 	int value = bcm2835_gpio_get_bit(pc, GPLEV0, offset);
--	int irq = irq_find_mapping(chip->irqdomain, offset);
-+	int irq = irq_find_mapping(pc->irq_domain, offset);
- 
- 	seq_printf(s, "function %s in %s; irq %d (%s)",
- 		fname, value ? "hi" : "lo",
-@@ -1012,6 +1010,21 @@ static int bcm2835_pinctrl_probe(struct platform_device *pdev)
- 	pc->gpio_chip.parent = dev;
- 	pc->gpio_chip.of_node = np;
- 
-+	pc->irq_domain = irq_domain_add_linear(np, BCM2835_NUM_GPIOS,
-+			&irq_domain_simple_ops, NULL);
-+	if (!pc->irq_domain) {
-+		dev_err(dev, "could not create IRQ domain\n");
-+		return -ENOMEM;
-+	}
-+
-+	for (i = 0; i < BCM2835_NUM_GPIOS; i++) {
-+		int irq = irq_create_mapping(pc->irq_domain, i);
-+		irq_set_lockdep_class(irq, &gpio_lock_class);
-+		irq_set_chip_and_handler(irq, &bcm2835_gpio_irq_chip,
-+				handle_level_irq);
-+		irq_set_chip_data(irq, pc);
-+	}
-+
- 	for (i = 0; i < BCM2835_NUM_BANKS; i++) {
- 		unsigned long events;
- 		unsigned offset;
-@@ -1032,39 +1045,34 @@ static int bcm2835_pinctrl_probe(struct platform_device *pdev)
- 		spin_lock_init(&pc->irq_lock[i]);
- 	}
- 
--	err = gpiochip_add_data(&pc->gpio_chip, pc);
--	if (err) {
--		dev_err(dev, "could not add GPIO chip\n");
--		return err;
-+	for (i = 0; i < BCM2835_NUM_IRQS; i++) {
-+		int len;
-+		char *name;
-+		pc->irq[i] = irq_of_parse_and_map(np, i);
-+		pc->irq_data[i].pc = pc;
-+		pc->irq_data[i].irqgroup = i;
-+
-+		len = strlen(dev_name(pc->dev)) + 16;
-+		name = devm_kzalloc(pc->dev, len, GFP_KERNEL);
-+		if (!name)
-+			return -ENOMEM;
-+		snprintf(name, len, "%s:bank%d", dev_name(pc->dev), i);
-+
-+		err = devm_request_irq(dev, pc->irq[i],
-+			bcm2835_gpio_irq_handler, IRQF_SHARED,
-+			name, &pc->irq_data[i]);
-+		if (err) {
-+			dev_err(dev, "unable to request IRQ %d\n", pc->irq[i]);
-+			return err;
-+		}
- 	}
- 
--	err = gpiochip_irqchip_add(&pc->gpio_chip, &bcm2835_gpio_irq_chip,
--				   0, handle_level_irq, IRQ_TYPE_NONE);
-+	err = gpiochip_add_data(&pc->gpio_chip, pc);
- 	if (err) {
--		dev_info(dev, "could not add irqchip\n");
-+		dev_err(dev, "could not add GPIO chip\n");
- 		return err;
- 	}
- 
--	for (i = 0; i < BCM2835_NUM_IRQS; i++) {
--		pc->irq[i] = irq_of_parse_and_map(np, i);
--		pc->irq_group[i] = i;
--
--		if (pc->irq[i] == 0)
--			continue;
--
--		/*
--		 * Use the same handler for all groups: this is necessary
--		 * since we use one gpiochip to cover all lines - the
--		 * irq handler then needs to figure out which group and
--		 * bank that was firing the IRQ and look up the per-group
--		 * and bank data.
--		 */
--		gpiochip_set_chained_irqchip(&pc->gpio_chip,
--					     &bcm2835_gpio_irq_chip,
--					     pc->irq[i],
--					     bcm2835_gpio_irq_handler);
--	}
--
- 	pc->pctl_dev = devm_pinctrl_register(dev, &bcm2835_pinctrl_desc, pc);
- 	if (IS_ERR(pc->pctl_dev)) {
- 		gpiochip_remove(&pc->gpio_chip);
-
-From 0c433b8e5412030ca229b85830abdda47c841eed Mon Sep 17 00:00:00 2001
-From: notro <notro@tronnes.org>
-Date: Thu, 10 Jul 2014 13:59:47 +0200
-Subject: [PATCH 011/173] pinctrl-bcm2835: Set base to 0 give expected gpio
- numbering
-
-Signed-off-by: Noralf Tronnes <notro@tronnes.org>
----
- drivers/pinctrl/bcm/pinctrl-bcm2835.c | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
-diff --git a/drivers/pinctrl/bcm/pinctrl-bcm2835.c b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-index ff3789a11b3c36b922b9d08035abb638187c2f5a..d2b537572095c86576f78536f737c102487f99f4 100644
---- a/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-+++ b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-@@ -381,7 +381,7 @@ static struct gpio_chip bcm2835_gpio_chip = {
- 	.get = bcm2835_gpio_get,
- 	.set = bcm2835_gpio_set,
- 	.to_irq = bcm2835_gpio_to_irq,
--	.base = -1,
-+	.base = 0,
- 	.ngpio = BCM2835_NUM_GPIOS,
- 	.can_sleep = false,
- };
-
-From d9319a075ad9a562fcd70597768b0f52d5c88a4e Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Thu, 26 Feb 2015 09:58:22 +0000
-Subject: [PATCH 012/173] pinctrl-bcm2835: Only request the interrupts listed
- in the DTB
-
-Although the GPIO controller can generate three interrupts (four counting
-the common one), the device tree files currently only specify two. In the
-absence of the third, simply don't register that interrupt (as opposed to
-registering 0), which has the effect of making it impossible to generate
-interrupts for GPIOs 46-53 which, since they share pins with the SD card
-interface, is unlikely to be a problem.
----
- drivers/pinctrl/bcm/pinctrl-bcm2835.c | 2 ++
- 1 file changed, 2 insertions(+)
-
-diff --git a/drivers/pinctrl/bcm/pinctrl-bcm2835.c b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-index d2b537572095c86576f78536f737c102487f99f4..a9d480df32562defbf8be0faf0a39bfe06ff71f9 100644
---- a/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-+++ b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-@@ -1049,6 +1049,8 @@ static int bcm2835_pinctrl_probe(struct platform_device *pdev)
- 		int len;
- 		char *name;
- 		pc->irq[i] = irq_of_parse_and_map(np, i);
-+		if (pc->irq[i] == 0)
-+			break;
- 		pc->irq_data[i].pc = pc;
- 		pc->irq_data[i].irqgroup = i;
- 
-
-From 81ba2330c131e7da3bca1b59f01cd254d11d5fa4 Mon Sep 17 00:00:00 2001
+From 02298bf05e981ff1db4733969b6ecc77f28babd8 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Wed, 24 Jun 2015 14:10:44 +0100
-Subject: [PATCH 013/173] spi-bcm2835: Support pin groups other than 7-11
+Subject: [PATCH 011/126] spi-bcm2835: Support pin groups other than 7-11
 
 The spi-bcm2835 driver automatically uses GPIO chip-selects due to
 some unreliability of the native ones. In doing so it chooses the
@@ -980,10 +662,10 @@ index f35cc10772f6670397ea923ad30158270dd68578..5dfe20ffc2866fa6789825016c585175
  	/* and set up the "mode" and level */
  	dev_info(&spi->dev, "setting up native-CS%i as GPIO %i\n",
 
-From 26b6abf66e4e353b6d308fcf6d50e36053b16db0 Mon Sep 17 00:00:00 2001
+From 55ddb6740815aaf8963b0c006d0bd837c028eee7 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Fri, 1 Jul 2016 22:09:24 +0100
-Subject: [PATCH 014/173] spi-bcm2835: Disable forced software CS
+Subject: [PATCH 012/126] spi-bcm2835: Disable forced software CS
 
 Select software CS in bcm2708_common.dtsi, and disable the automatic
 conversion in the driver to allow hardware CS to be re-enabled with an
@@ -1017,10 +699,10 @@ index 5dfe20ffc2866fa6789825016c585175a29705b6..8493474d286f7a1ac6454a22c61c8c2c
  	return 0;
  }
 
-From f9164bc59cb04046bd40a67c7779b0cfc6075d5f Mon Sep 17 00:00:00 2001
+From 8f2bbfe1d1ce86c8641af37a40177fbd999c34ae Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Tue, 8 Nov 2016 21:35:38 +0000
-Subject: [PATCH 015/173] spi-bcm2835: Remove unused code
+Subject: [PATCH 013/126] spi-bcm2835: Remove unused code
 
 ---
  drivers/spi/spi-bcm2835.c | 61 -----------------------------------------------
@@ -1108,10 +790,10 @@ index 8493474d286f7a1ac6454a22c61c8c2cef9121bf..33d75ad38a7f77d085321ace9101900a
  }
  
 
-From 6f25ff462e75767582fdace353a5408fe684ab04 Mon Sep 17 00:00:00 2001
+From 2ae475ea79f35f0341bc92cc4d8ffc39a101eb12 Mon Sep 17 00:00:00 2001
 From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
 Date: Wed, 3 Jun 2015 12:26:13 +0200
-Subject: [PATCH 016/173] ARM: bcm2835: Set Serial number and Revision
+Subject: [PATCH 014/126] ARM: bcm2835: Set Serial number and Revision
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -1164,10 +846,10 @@ index 0c1edfc98696da0e0bb7f4a18cdfbcdd27a9795d..8f152266ba9b470df2eaaed9ebcf158e
  
  static const char * const bcm2835_compat[] = {
 
-From de38cbe1a0cb31cc4fe4e0768dd0be0b92183907 Mon Sep 17 00:00:00 2001
+From d6563fcf780109ef549b45219a0f513f5b740673 Mon Sep 17 00:00:00 2001
 From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
 Date: Sat, 3 Oct 2015 22:22:55 +0200
-Subject: [PATCH 017/173] dmaengine: bcm2835: Load driver early and support
+Subject: [PATCH 015/126] dmaengine: bcm2835: Load driver early and support
  legacy API
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
@@ -1185,10 +867,10 @@ Signed-off-by: Noralf Trønnes <noralf@tronnes.org>
  2 files changed, 26 insertions(+), 2 deletions(-)
 
 diff --git a/drivers/dma/Kconfig b/drivers/dma/Kconfig
-index fa8f9c07ce73f712c02de35c40c6a7ee2c42fd5f..f8883e93c4d89a3ae62a585329c8d5edb5c23058 100644
+index fadc4d8783bd8a48817867eeb0640e49b193d922..e5244c1f9318bd4dbd98111394113b3e9f8596c3 100644
 --- a/drivers/dma/Kconfig
 +++ b/drivers/dma/Kconfig
-@@ -125,7 +125,7 @@ config COH901318
+@@ -131,7 +131,7 @@ config COH901318
  
  config DMA_BCM2835
  	tristate "BCM2835 DMA engine support"
@@ -1270,10 +952,10 @@ index 6204cc32d09c5096df8aec304c3c37b3bcb6be44..599c218dc8a73172dd4bd4a058fc8f95
  MODULE_ALIAS("platform:bcm2835-dma");
  MODULE_DESCRIPTION("BCM2835 DMA engine driver");
 
-From d7df3482e5e76edbf7f4d6847b8823cd1743535c Mon Sep 17 00:00:00 2001
+From 18d9d0b89f30c59181ff5636255710983eeacf0d Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Mon, 25 Jan 2016 17:25:12 +0000
-Subject: [PATCH 018/173] firmware: Updated mailbox header
+Subject: [PATCH 016/126] firmware: Updated mailbox header
 
 ---
  include/soc/bcm2835/raspberrypi-firmware.h | 9 +++++++++
@@ -1334,10 +1016,10 @@ index cb979ad90401e299344dd5fae38d09c489d8bd58..30fb37fe175df604a738258a2a632bca
  	RPI_FIRMWARE_VCHIQ_INIT =                             0x00048010,
  
 
-From 8b0d445303d35756ce6bcc859ab12a70d589c291 Mon Sep 17 00:00:00 2001
+From 3f4ebab0930bd203ff1520b56ed21cef77cc2c57 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Wed, 15 Jun 2016 16:48:41 +0100
-Subject: [PATCH 019/173] rtc: Add SPI alias for pcf2123 driver
+Subject: [PATCH 017/126] rtc: Add SPI alias for pcf2123 driver
 
 Without this alias, Device Tree won't cause the driver
 to be loaded.
@@ -1357,10 +1039,10 @@ index 8895f77726e8da5444afcd602dceff8f25a9b3fd..1833b8853ceb0e6147cceb93a00e558c
  MODULE_LICENSE("GPL");
 +MODULE_ALIAS("spi:rtc-pcf2123");
 
-From d635eba91a9931609ed9295098d577eb01c3608e Mon Sep 17 00:00:00 2001
+From 349105ce6dd70b64250a3d9d686ea3ddf6c3885d Mon Sep 17 00:00:00 2001
 From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
 Date: Fri, 7 Oct 2016 16:50:59 +0200
-Subject: [PATCH 020/173] watchdog: bcm2835: Support setting reboot partition
+Subject: [PATCH 018/126] watchdog: bcm2835: Support setting reboot partition
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -1462,10 +1144,10 @@ index b339e0e67b4c1275fd4992fea4f1e24c0575b783..26b7177573fac2af1cd4ab5488d2686f
  
  static int bcm2835_wdt_probe(struct platform_device *pdev)
 
-From e011b348aadd95d8a1fe0169305a1e50ce1fc480 Mon Sep 17 00:00:00 2001
+From 8a0f4761e731ad693347aebf729aa872d69c1b27 Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Tue, 5 Apr 2016 19:40:12 +0100
-Subject: [PATCH 021/173] reboot: Use power off rather than busy spinning when
+Subject: [PATCH 019/126] reboot: Use power off rather than busy spinning when
  halt is requested
 
 ---
@@ -1488,10 +1170,10 @@ index 3b2aa9a9fe268d45335f781c4aa22cf573753a1b..0180d89a34af45c56243fe0f17fbe209
  
  /*
 
-From 4b568920b166692346db6adf3a8aa94a76b5a0ed Mon Sep 17 00:00:00 2001
+From 15f5ff1db0527c471328ee9157e1cd374421faa9 Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Wed, 9 Nov 2016 13:02:52 +0000
-Subject: [PATCH 022/173] bcm: Make RASPBERRYPI_POWER depend on PM
+Subject: [PATCH 020/126] bcm: Make RASPBERRYPI_POWER depend on PM
 
 ---
  drivers/soc/bcm/Kconfig | 1 +
@@ -1510,10 +1192,10 @@ index 49f1e2a75d614bc21db152327c7b425ae2504f8d..dccd2374ed00631abd441e3e9d78ee74
  	help
  	  This enables support for the RPi power domains which can be enabled
 
-From bb1668bb395ef4cc0ece7b7ac18fbfa7b7c5b642 Mon Sep 17 00:00:00 2001
+From 5a996ec4e608762ac630fa664d33efe1c87333db Mon Sep 17 00:00:00 2001
 From: Martin Sperl <kernel@martin.sperl.org>
 Date: Fri, 2 Sep 2016 16:45:27 +0100
-Subject: [PATCH 023/173] Register the clocks early during the boot process, so
+Subject: [PATCH 021/126] Register the clocks early during the boot process, so
  that special/critical clocks can get enabled early on in the boot process
  avoiding the risk of disabling a clock, pll_divider or pll when a claiming
  driver fails to install propperly - maybe it needs to defer.
@@ -1558,10 +1240,10 @@ index 58ce6af8452db9ca8b4d3c380a06e448919f6a8d..11d89d106026f15719ea25047d6f357b
  MODULE_AUTHOR("Eric Anholt <eric@anholt.net>");
  MODULE_DESCRIPTION("BCM2835 clock driver");
 
-From 198027c8f72b1c11e435eddf7c81e02dde1ec2aa Mon Sep 17 00:00:00 2001
+From f5872dfc0a07a095778b55e64a5e2380142b5b6a Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Tue, 6 Dec 2016 17:05:39 +0000
-Subject: [PATCH 024/173] bcm2835-rng: Avoid initialising if already enabled
+Subject: [PATCH 022/126] bcm2835-rng: Avoid initialising if already enabled
 
 Avoids the 0x40000 cycles of warmup again if firmware has already used it
 ---
@@ -1587,10 +1269,10 @@ index 574211a495491d9d6021dcaefe4274a63ed02055..e66c0fca8c6090e32f72796c0877a1cf
  	err = hwrng_register(&bcm2835_rng_ops);
  	if (err) {
 
-From 1b4b16d21a4bcf96dc625ad9444c69c28eeef072 Mon Sep 17 00:00:00 2001
+From e07009206a9c838561eaccf9afa298ace8b6c22e Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Wed, 24 Aug 2016 16:28:44 +0100
-Subject: [PATCH 025/173] kbuild: Ignore dtco targets when filtering symbols
+Subject: [PATCH 023/126] kbuild: Ignore dtco targets when filtering symbols
 
 ---
  scripts/Kbuild.include | 2 +-
@@ -1610,10 +1292,10 @@ index 9ffd3dda3889c56a7a72229bed21ff5c49d62856..00da6c9bacbf33334233e22ca5209ade
  	esac | tr ";" "\n" | sed -rn 's/^.*=== __KSYM_(.*) ===.*$$/KSYM_\1/p'
  
 
-From 1b013838bed35a7ba38be239e8590414ab5bfa08 Mon Sep 17 00:00:00 2001
+From be5523f7e6c88d4f040946ae408429bfa3e2f3ed Mon Sep 17 00:00:00 2001
 From: Robert Tiemann <rtie@gmx.de>
 Date: Mon, 20 Jul 2015 11:01:25 +0200
-Subject: [PATCH 026/173] BCM2835_DT: Fix I2S register map
+Subject: [PATCH 024/126] BCM2835_DT: Fix I2S register map
 
 ---
  Documentation/devicetree/bindings/dma/brcm,bcm2835-dma.txt   | 4 ++--
@@ -1651,10 +1333,10 @@ index 65783de0aedf3da79adc36fd077b7a89954ddb6b..a89fe4220fdc3f26f75ee66daf187554
  	dmas = <&dma 2>,
  	       <&dma 3>;
 
-From 3541d2299cb53a29213bd9a653fa4c4c636a251c Mon Sep 17 00:00:00 2001
+From 761bd42a0a2b9507bec7e1956ca1d711510601c0 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Mon, 13 Feb 2017 17:20:08 +0000
-Subject: [PATCH 027/173] clk-bcm2835: Mark used PLLs and dividers CRITICAL
+Subject: [PATCH 025/126] clk-bcm2835: Mark used PLLs and dividers CRITICAL
 
 The VPU configures and relies on several PLLs and dividers. Mark all
 enabled dividers and their PLLs as CRITICAL to prevent the kernel from
@@ -1682,10 +1364,10 @@ index 11d89d106026f15719ea25047d6f357b4bfcb2c5..fe8f5d65f2749cb3ddc878df61664826
  	divider->data = data;
  
 
-From ef265510cf7bcb062ecf5026e9d916ef0ab58dd4 Mon Sep 17 00:00:00 2001
+From f082f32a4b9f9937616740efecb459c499cfc7e4 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Mon, 13 Feb 2017 17:20:08 +0000
-Subject: [PATCH 028/173] clk-bcm2835: Add claim-clocks property
+Subject: [PATCH 026/126] clk-bcm2835: Add claim-clocks property
 
 The claim-clocks property can be used to prevent PLLs and dividers
 from being marked as critical. It contains a vector of clock IDs,
@@ -1787,10 +1469,10 @@ index fe8f5d65f2749cb3ddc878df616648267441e0ee..92b5e0f5145b32d3bfc3592fe381e8be
  	       sizeof(cprman_parent_names));
  	of_clk_parent_fill(dev->of_node, cprman->real_parent_names,
 
-From b0cd805d9a43ad2112f2cb57ac6e417b3d7423b1 Mon Sep 17 00:00:00 2001
+From bff698d5176af4dfb53830d7aaea02fd7f789b67 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Mon, 6 Mar 2017 09:06:18 +0000
-Subject: [PATCH 029/173] clk-bcm2835: Read max core clock from firmware
+Subject: [PATCH 027/126] clk-bcm2835: Read max core clock from firmware
 
 The VPU is responsible for managing the core clock, usually under
 direction from the bcm2835-cpufreq driver but not via the clk-bcm2835
@@ -1905,10 +1587,51 @@ index 92b5e0f5145b32d3bfc3592fe381e8be3cd90c72..336f8c9c44325d0a94e591a8557f7af2
  	for (i = 0;
  	     !of_property_read_u32_index(pdev->dev.of_node, "claim-clocks",
 
-From d61da4f3762793e7d7a28dd51ca8505110f679ba Mon Sep 17 00:00:00 2001
+From 36868958777e773b12b4873a158632b30b620b78 Mon Sep 17 00:00:00 2001
+From: Eric Anholt <eric@anholt.net>
+Date: Mon, 9 May 2016 17:28:18 -0700
+Subject: [PATCH 028/126] clk: bcm2835: Mark GPIO clocks enabled at boot as
+ critical.
+
+These divide off of PLLD_PER and are used for the ethernet and wifi
+PHYs source PLLs.  Neither of them is currently represented by a phy
+device that would grab the clock for us.
+
+This keeps other drivers from killing the networking PHYs when they
+disable their own clocks and trigger PLLD_PER's refcount going to 0.
+
+v2: Skip marking as critical if they aren't on at boot.
+
+Signed-off-by: Eric Anholt <eric@anholt.net>
+---
+ drivers/clk/bcm/clk-bcm2835.c | 9 +++++++++
+ 1 file changed, 9 insertions(+)
+
+diff --git a/drivers/clk/bcm/clk-bcm2835.c b/drivers/clk/bcm/clk-bcm2835.c
+index 336f8c9c44325d0a94e591a8557f7af246adc857..caa05e5ad0b7b5cd683e04fb3591a3dfcb40823f 100644
+--- a/drivers/clk/bcm/clk-bcm2835.c
++++ b/drivers/clk/bcm/clk-bcm2835.c
+@@ -1484,6 +1484,15 @@ static struct clk_hw *bcm2835_register_clock(struct bcm2835_cprman *cprman,
+ 	init.flags = data->flags | CLK_IGNORE_UNUSED;
+ 
+ 	/*
++	 * Some GPIO clocks for ethernet/wifi PLLs are marked as
++	 * critical (since some platforms use them), but if the
++	 * firmware didn't have them turned on then they clearly
++	 * aren't actually critical.
++	 */
++	if ((cprman_read(cprman, data->ctl_reg) & CM_ENABLE) == 0)
++		init.flags &= ~CLK_IS_CRITICAL;
++
++	/*
+ 	 * Pass the CLK_SET_RATE_PARENT flag if we are allowed to propagate
+ 	 * rate changes on at least of the parents.
+ 	 */
+
+From 360ae64a346d177744f4dcd4573af03dc7ddbfd7 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Thu, 9 Feb 2017 14:36:44 +0000
-Subject: [PATCH 030/173] sound: Demote deferral errors to INFO level
+Subject: [PATCH 029/126] sound: Demote deferral errors to INFO level
 
 At present there is no mechanism to specify driver load order,
 which can lead to deferrals and repeated retries until successful.
@@ -1921,10 +1644,10 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  1 file changed, 2 insertions(+), 2 deletions(-)
 
 diff --git a/sound/soc/soc-core.c b/sound/soc/soc-core.c
-index 13c875e2392a40ec5651d7c12a28b9ac9f3aab85..23d56057e49b5ff6b6c3c352c150fee8cf7d8752 100644
+index fee4b0ef5566cf9e8de0bf5c568706da9cab2ea2..c728a4148903e983d61b6ae65765ba11d54c8638 100644
 --- a/sound/soc/soc-core.c
 +++ b/sound/soc/soc-core.c
-@@ -1072,7 +1072,7 @@ static int soc_bind_dai_link(struct snd_soc_card *card,
+@@ -1124,7 +1124,7 @@ static int soc_bind_dai_link(struct snd_soc_card *card,
  	cpu_dai_component.dai_name = dai_link->cpu_dai_name;
  	rtd->cpu_dai = snd_soc_find_dai(&cpu_dai_component);
  	if (!rtd->cpu_dai) {
@@ -1933,7 +1656,7 @@ index 13c875e2392a40ec5651d7c12a28b9ac9f3aab85..23d56057e49b5ff6b6c3c352c150fee8
  			dai_link->cpu_dai_name);
  		goto _err_defer;
  	}
-@@ -1084,7 +1084,7 @@ static int soc_bind_dai_link(struct snd_soc_card *card,
+@@ -1137,7 +1137,7 @@ static int soc_bind_dai_link(struct snd_soc_card *card,
  	for (i = 0; i < rtd->num_codecs; i++) {
  		codec_dais[i] = snd_soc_find_dai(&codecs[i]);
  		if (!codec_dais[i]) {
@@ -1943,10 +1666,10 @@ index 13c875e2392a40ec5651d7c12a28b9ac9f3aab85..23d56057e49b5ff6b6c3c352c150fee8
  			goto _err_defer;
  		}
 
-From f933329702240c201e0b4e4fbc18243d2e81f144 Mon Sep 17 00:00:00 2001
+From 75ba87de1ec11099dac87b9036f4f258140f8da3 Mon Sep 17 00:00:00 2001
 From: Claggy3 <stephen.maclagan@hotmail.com>
 Date: Sat, 11 Feb 2017 14:00:30 +0000
-Subject: [PATCH 031/173] Update vfpmodule.c
+Subject: [PATCH 030/126] Update vfpmodule.c
 
 Christopher Alexander Tobias Schulze - May 2, 2015, 11:57 a.m.
 This patch fixes a problem with VFP state save and restore related
@@ -2083,10 +1806,10 @@ index a71a48e71fffa8626fe90106815376c44bbe679b..d6c0a5a0a5ae3510db3ace5e3f5d3410
  	/*
  	 * Save the userland NEON/VFP state. Under UP,
 
-From 281224342f791bcaa650dd6112a313ce76b13f92 Mon Sep 17 00:00:00 2001
+From 64452daded3b501f9be7ddcfccce3f1445804888 Mon Sep 17 00:00:00 2001
 From: Matt Flax <flatmax@flatmax.org>
 Date: Wed, 8 Mar 2017 21:13:24 +1100
-Subject: [PATCH 032/173] ASoC: bcm2835_i2s.c: relax the ch2 register setting
+Subject: [PATCH 031/126] ASoC: bcm2835_i2s.c: relax the ch2 register setting
  for 8 channels
 
 This patch allows ch2 registers to be set for 8 channels of audio.
@@ -2107,10 +1830,10 @@ index 6ba20498202ed36906b52096893a88867a79269f..56df7d8a43d0aac055a91b0d24aca8e1
  		format |= BCM2835_I2S_CH1(BCM2835_I2S_CHPOS(ch1pos));
  		format |= BCM2835_I2S_CH2(BCM2835_I2S_CHPOS(ch2pos));
 
-From 1d225fa894026b0a705f35363b18fed51fd6b977 Mon Sep 17 00:00:00 2001
+From 9f76dc7a504389b6bb008bf9a96c3b1faa9914ba Mon Sep 17 00:00:00 2001
 From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
 Date: Tue, 1 Nov 2016 15:15:41 +0100
-Subject: [PATCH 033/173] i2c: bcm2835: Add debug support
+Subject: [PATCH 032/126] i2c: bcm2835: Add debug support
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -2299,10 +2022,104 @@ index cd07a69e2e9355540442785f95e90823b05c9d10..47167f403cc8329bd811b47c7011c299
  	if (i2c_dev->msg_err & BCM2835_I2C_S_ERR)
  		return -EREMOTEIO;
 
-From 4f96629b6c09bc6d99e205e145e8398611183658 Mon Sep 17 00:00:00 2001
+From c22386d7629d9bda8e7d49e0630b8b6034ed49ad Mon Sep 17 00:00:00 2001
+From: Eric Anholt <eric@anholt.net>
+Date: Thu, 18 Dec 2014 16:07:15 -0800
+Subject: [PATCH 033/126] mm: Remove the PFN busy warning
+
+See commit dae803e165a11bc88ca8dbc07a11077caf97bbcb -- the warning is
+expected sometimes when using CMA.  However, that commit still spams
+my kernel log with these warnings.
+
+Signed-off-by: Eric Anholt <eric@anholt.net>
+---
+ mm/page_alloc.c | 2 --
+ 1 file changed, 2 deletions(-)
+
+diff --git a/mm/page_alloc.c b/mm/page_alloc.c
+index c841af88836ad63d548a2f007220203e4a8ddf9a..9bbca2b7597fdc9a29ddbb714938501021994963 100644
+--- a/mm/page_alloc.c
++++ b/mm/page_alloc.c
+@@ -7632,8 +7632,6 @@ int alloc_contig_range(unsigned long start, unsigned long end,
+ 
+ 	/* Make sure the range is really isolated. */
+ 	if (test_pages_isolated(outer_start, end, false)) {
+-		pr_info_ratelimited("%s: [%lx, %lx) PFNs busy\n",
+-			__func__, outer_start, end);
+ 		ret = -EBUSY;
+ 		goto done;
+ 	}
+
+From aade3bbf37cd09d06374f96425527b8866b4e221 Mon Sep 17 00:00:00 2001
+From: Phil Elwell <phil@raspberrypi.org>
+Date: Thu, 23 Mar 2017 10:06:56 +0000
+Subject: [PATCH 034/126] ASoC: Add prompt for ICS43432 codec
+
+Without a prompt string, a config setting can't be included in a
+defconfig. Give CONFIG_SND_SOC_ICS43432 a prompt so that Pi soundcards
+can use the driver.
+
+Signed-off-by: Phil Elwell <phil@raspberrypi.org>
+---
+ sound/soc/codecs/Kconfig | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/sound/soc/codecs/Kconfig b/sound/soc/codecs/Kconfig
+index c367d11079bc90feec2ad0fa748d7ffc3035faba..91d5b531b69b49db97f7febbc60d33a20991cb0f 100644
+--- a/sound/soc/codecs/Kconfig
++++ b/sound/soc/codecs/Kconfig
+@@ -579,7 +579,7 @@ config SND_SOC_HDAC_HDMI
+ 	select HDMI
+ 
+ config SND_SOC_ICS43432
+-	tristate
++	tristate "InvenSense ICS43432 I2S microphone codec"
+ 
+ config SND_SOC_INNO_RK3036
+ 	tristate "Inno codec driver for RK3036 SoC"
+
+From 7322c26bb87606500069bb6d833ddd7350a941f0 Mon Sep 17 00:00:00 2001
+From: Phil Elwell <phil@raspberrypi.org>
+Date: Thu, 18 May 2017 15:36:46 +0100
+Subject: [PATCH 035/126] staging: bcm2835-audio: Fix memory corruption
+
+I'm all for fixing memory leaks, but freeing a block while it is still
+being used is a recipe for hard-to-debug kernel exeptions.
+
+1) There is already a vchi method for freeing the instance, so use it.
+2) Only call it on error, and then only before initted is false.
+
+Signed-off-by: Phil Elwell <phil@raspberrypi.org>
+Fixes: 0adbfd4694c2 ("staging: bcm2835-audio: fix memory leak in bcm2835_audio_open_connection()")
+---
+ drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c b/drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c
+index 5f3d8f2339e34834d11edfa8de1d5819e3e32b4f..89f96f3c02805f4114ec9b488e18d00e1f348239 100644
+--- a/drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c
++++ b/drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c
+@@ -409,6 +409,7 @@ static int bcm2835_audio_open_connection(struct bcm2835_alsa_stream *alsa_stream
+ 			LOG_ERR("%s: failed to connect VCHI instance (ret=%d)\n",
+ 				__func__, ret);
+ 
++			vchi_disconnect(vchi_instance);
+ 			ret = -EIO;
+ 			goto err_free_mem;
+ 		}
+@@ -431,7 +432,6 @@ static int bcm2835_audio_open_connection(struct bcm2835_alsa_stream *alsa_stream
+ 	LOG_DBG(" success !\n");
+ 	ret = 0;
+ err_free_mem:
+-	kfree(vchi_instance);
+ 
+ 	return ret;
+ }
+
+From ce49639b3ff8ae7384977f0946bda66aff23189f Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Sun, 12 May 2013 12:24:19 +0100
-Subject: [PATCH 034/173] Main bcm2708/bcm2709 linux port
+Subject: [PATCH 036/126] Main bcm2708/bcm2709 linux port
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -2405,7 +2222,7 @@ index 06d890a2342b1600e2eae6e350994ad59f5c3a08..30d96e81c0e052c725bdb00bb3df5619
  
  ENTRY(cpu_v6_dcache_clean_area)
 diff --git a/drivers/irqchip/irq-bcm2835.c b/drivers/irqchip/irq-bcm2835.c
-index eccf6ed025299cb480884f5bcbe77abf55a6bbb1..8ed457fd74bd23bee27b64a2c9e3828ce0e4fb87 100644
+index 13356d3b7bcd508f058c6a9e3c4b0b385d478ef4..fee691736c124c57ede4ab47a7c6bfa3b7c3b681 100644
 --- a/drivers/irqchip/irq-bcm2835.c
 +++ b/drivers/irqchip/irq-bcm2835.c
 @@ -54,7 +54,9 @@
@@ -2426,7 +2243,7 @@ index eccf6ed025299cb480884f5bcbe77abf55a6bbb1..8ed457fd74bd23bee27b64a2c9e3828c
  #define FIQ_START		(NR_IRQS_BANK0 + MAKE_HWIRQ(NR_BANKS - 1, 0))
  
  static const int reg_pending[] __initconst = { 0x00, 0x04, 0x08 };
-@@ -256,10 +259,12 @@ static int __init armctrl_of_init(struct device_node *node,
+@@ -255,10 +258,12 @@ static int __init armctrl_of_init(struct device_node *node,
  					MAKE_HWIRQ(b, i) + NUMBER_IRQS);
  			BUG_ON(irq <= 0);
  			irq_set_chip(irq, &armctrl_chip);
@@ -2490,10 +2307,10 @@ index cfb4b4496dd9f61362dea012176c146120fada07..d9c6c217c4d6a2408abe2665bf7f2700
  MODULE_AUTHOR("Lubomir Rintel <lkundrak@v3.sk>");
  MODULE_DESCRIPTION("BCM2835 mailbox IPC driver");
 
-From 2cf89e248c1f9d4fe0cbc6721141d9aadd427187 Mon Sep 17 00:00:00 2001
+From 814e3af926c15ea4fc967d266d72e3d11c2bb8d9 Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Wed, 1 May 2013 19:46:17 +0100
-Subject: [PATCH 035/173] Add dwc_otg driver
+Subject: [PATCH 037/126] Add dwc_otg driver
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -3069,6 +2886,47 @@ in hcd->free_hc_list becoming corrupted.
 dwcotg: Allow to build without FIQ on ARM64
 
 Signed-off-by: popcornmix <popcornmix@gmail.com>
+
+dwc_otg: make periodic scheduling behave properly for FS buses
+
+If the root port is in full-speed mode, transfer times at 12mbit/s
+would be calculated but matched against high-speed quotas.
+
+Reinitialise hcd->frame_usecs[i] on each port enable event so that
+full-speed bandwidth can be tracked sensibly.
+
+Also, don't bother using the FIQ for transfers when in full-speed
+mode - at the slower bus speed, interrupt frequency is reduced by
+an order of magnitude.
+
+Related issue: https://github.com/raspberrypi/linux/issues/2020
+
+dwc_otg: fiq_fsm: Make isochronous compatibility checks work properly
+
+Get rid of the spammy printk and local pointer mangling.
+Also, there is a nominal benefit for using fiq_fsm for isochronous
+transfers in FS mode (~1.1k IRQs per second vs 2.1k IRQs per second)
+so remove the root port speed check.
+
+dwc_otg: add module parameter int_ep_interval_min
+
+Add a module parameter (defaulting to ignored) that clamps the polling rate
+of high-speed Interrupt endpoints to a minimum microframe interval.
+
+The parameter is modifiable at runtime as it is used when activating new
+endpoints (such as on device connect).
+
+dwc_otg: fiq_fsm: Add non-periodic TT exclusivity constraints
+
+Certain hub types do not discriminate between pipe direction (IN or OUT)
+when considering non-periodic transfers. Therefore these hubs get confused
+if multiple transfers are issued in different directions with the same
+device address and endpoint number.
+
+Constrain queuing non-periodic split transactions so they are performed
+serially in such cases.
+
+Related: https://github.com/raspberrypi/linux/issues/2024
 ---
  arch/arm/include/asm/irqflags.h                    |   16 +-
  arch/arm/kernel/fiqasm.S                           |    4 +
@@ -3117,18 +2975,18 @@ Signed-off-by: popcornmix <popcornmix@gmail.com>
  drivers/usb/host/dwc_otg/dwc_otg_cil_intr.c        | 1596 +++++
  drivers/usb/host/dwc_otg/dwc_otg_core_if.h         |  705 ++
  drivers/usb/host/dwc_otg/dwc_otg_dbg.h             |  117 +
- drivers/usb/host/dwc_otg/dwc_otg_driver.c          | 1757 +++++
+ drivers/usb/host/dwc_otg/dwc_otg_driver.c          | 1761 +++++
  drivers/usb/host/dwc_otg/dwc_otg_driver.h          |   86 +
- drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c         | 1358 ++++
- drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h         |  370 +
+ drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c         | 1389 ++++
+ drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h         |  372 +
  drivers/usb/host/dwc_otg/dwc_otg_fiq_stub.S        |   80 +
- drivers/usb/host/dwc_otg/dwc_otg_hcd.c             | 4242 ++++++++++++
- drivers/usb/host/dwc_otg/dwc_otg_hcd.h             |  867 +++
+ drivers/usb/host/dwc_otg/dwc_otg_hcd.c             | 4284 ++++++++++++
+ drivers/usb/host/dwc_otg/dwc_otg_hcd.h             |  870 +++
  drivers/usb/host/dwc_otg/dwc_otg_hcd_ddma.c        | 1134 ++++
  drivers/usb/host/dwc_otg/dwc_otg_hcd_if.h          |  417 ++
- drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c        | 2749 ++++++++
+ drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c        | 2753 ++++++++
  drivers/usb/host/dwc_otg/dwc_otg_hcd_linux.c       | 1007 +++
- drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c       |  967 +++
+ drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c       |  971 +++
  drivers/usb/host/dwc_otg/dwc_otg_os_dep.h          |  188 +
  drivers/usb/host/dwc_otg/dwc_otg_pcd.c             | 2725 ++++++++
  drivers/usb/host/dwc_otg/dwc_otg_pcd.h             |  273 +
@@ -3140,7 +2998,7 @@ Signed-off-by: popcornmix <popcornmix@gmail.com>
  drivers/usb/host/dwc_otg/test/dwc_otg_test.pm      |  337 +
  drivers/usb/host/dwc_otg/test/test_mod_param.pl    |  133 +
  drivers/usb/host/dwc_otg/test/test_sysfs.pl        |  193 +
- 70 files changed, 59917 insertions(+), 16 deletions(-)
+ 70 files changed, 60007 insertions(+), 16 deletions(-)
  create mode 100644 drivers/usb/gadget/file_storage.c
  create mode 100644 drivers/usb/host/dwc_common_port/Makefile
  create mode 100644 drivers/usb/host/dwc_common_port/Makefile.fbsd
@@ -3271,10 +3129,10 @@ index bd3e0c5a6db25e7a162d922c6508de1ad0b68025..15c80079c97bb9eeec478932af88a293
  	return i;
  }
 diff --git a/drivers/usb/core/hub.c b/drivers/usb/core/hub.c
-index 822f8c50e4233c70d159a4e374ad66b49502c0c1..2b0a828258fd46e05e9dea9a23168cd746b4fe54 100644
+index 41eaf0b5251800c570736baf4775c35072e4d9fc..4aff5f417af7902a6505dbdd110f4e5009a3c1b0 100644
 --- a/drivers/usb/core/hub.c
 +++ b/drivers/usb/core/hub.c
-@@ -5039,7 +5039,7 @@ static void port_event(struct usb_hub *hub, int port1)
+@@ -5052,7 +5052,7 @@ static void port_event(struct usb_hub *hub, int port1)
  	if (portchange & USB_PORT_STAT_C_OVERCURRENT) {
  		u16 status = 0, unused;
  
@@ -35260,10 +35118,10 @@ index 0000000000000000000000000000000000000000..ccc24e010e449cbda488050d901e9a39
 +#endif
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_driver.c b/drivers/usb/host/dwc_otg/dwc_otg_driver.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..cb060a7179a3eec791506ed2779b553cad9841b0
+index 0000000000000000000000000000000000000000..95943e07528276b26b51ea2d57a1f433f280aaef
 --- /dev/null
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_driver.c
-@@ -0,0 +1,1757 @@
+@@ -0,0 +1,1761 @@
 +/* ==========================================================================
 + * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_driver.c $
 + * $Revision: #92 $
@@ -35515,6 +35373,7 @@ index 0000000000000000000000000000000000000000..cb060a7179a3eec791506ed2779b553c
 +
 +unsigned short fiq_fsm_mask = 0x0F;
 +
++unsigned short int_ep_interval_min = 0;
 +/**
 + * This function shows the Driver Version.
 + */
@@ -36664,7 +36523,10 @@ index 0000000000000000000000000000000000000000..cb060a7179a3eec791506ed2779b553c
 +					"Bit 1 : Periodic split transactions\n"
 +					"Bit 2 : High-speed multi-transfer isochronous\n"
 +					"All other bits should be set 0.");
-+
++module_param(int_ep_interval_min, ushort, 0644);
++MODULE_PARM_DESC(int_ep_interval_min, "Clamp high-speed Interrupt endpoints to a minimum polling interval.\n"
++					"0..1 = Use endpoint default\n"
++					"2..n = Minimum interval n microframes. Use powers of 2.\n");
 +
 +/** @page "Module Parameters"
 + *
@@ -37115,10 +36977,10 @@ index 0000000000000000000000000000000000000000..6a8be63a0ab20f4e1c56251b85648aa2
 +#endif
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..2035e0762dc6d60673c8fbc47a90b72254f50b69
+index 0000000000000000000000000000000000000000..96fd44eb6414a2b70d8be307e9dcd4c4804cef2d
 --- /dev/null
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c
-@@ -0,0 +1,1358 @@
+@@ -0,0 +1,1389 @@
 +/*
 + * dwc_otg_fiq_fsm.c - The finite state machine FIQ
 + *
@@ -37205,7 +37067,6 @@ index 0000000000000000000000000000000000000000..2035e0762dc6d60673c8fbc47a90b722
 +	unsigned long tmp;
 +	uint32_t newval;
 +	fiq_lock_t lockval;
-+	smp_mb__before_spinlock();
 +	/* Nested locking, yay. If we are on the same CPU as the fiq, then the disable
 +	 * will be sufficient. If we are on a different CPU, then the lock protects us. */
 +	prefetchw(&lock->slock);
@@ -37295,6 +37156,32 @@ index 0000000000000000000000000000000000000000..2035e0762dc6d60673c8fbc47a90b722
 +	mb();
 +}
 +
++/**
++ * fiq_fsm_restart_np_pending() - Restart a single non-periodic contended transfer
++ * @st: Pointer to the channel's state
++ * @num_channels: Total number of host channels
++ * @orig_channel: Channel index of completed transfer
++ *
++ * In the case where an IN and OUT transfer are simultaneously scheduled to the
++ * same device/EP, inadequate hub implementations will misbehave. Once the first
++ * transfer is complete, a pending non-periodic split can then be issued.
++ */
++static void notrace fiq_fsm_restart_np_pending(struct fiq_state *st, int num_channels, int orig_channel)
++{
++	int i;
++	int dev_addr = st->channel[orig_channel].hcchar_copy.b.devaddr;
++	int ep_num = st->channel[orig_channel].hcchar_copy.b.epnum;
++	for (i = 0; i < num_channels; i++) {
++		if (st->channel[i].fsm == FIQ_NP_SSPLIT_PENDING &&
++			st->channel[i].hcchar_copy.b.devaddr == dev_addr &&
++			st->channel[i].hcchar_copy.b.epnum == ep_num) {
++			st->channel[i].fsm = FIQ_NP_SSPLIT_STARTED;
++			fiq_fsm_restart_channel(st, i, 0);
++			break;
++		}
++	}
++}
++
 +static inline int notrace fiq_get_xfer_len(struct fiq_state *st, int n)
 +{
 +	/* The xfersize register is a bit wonky. For IN transfers, it decrements by the packet size. */
@@ -37974,6 +37861,9 @@ index 0000000000000000000000000000000000000000..2035e0762dc6d60673c8fbc47a90b722
 +				st->fsm = FIQ_NP_SPLIT_HS_ABORTED;
 +			}
 +		}
++		if (st->fsm != FIQ_NP_IN_CSPLIT_RETRY) {
++			fiq_fsm_restart_np_pending(state, num_channels, n);
++		}
 +		break;
 +
 +	case FIQ_NP_OUT_CSPLIT_RETRY:
@@ -38023,6 +37913,9 @@ index 0000000000000000000000000000000000000000..2035e0762dc6d60673c8fbc47a90b722
 +				st->fsm = FIQ_NP_SPLIT_HS_ABORTED;
 +			}
 +		}
++		if (st->fsm != FIQ_NP_OUT_CSPLIT_RETRY) {
++			fiq_fsm_restart_np_pending(state, num_channels, n);
++		}
 +		break;
 +
 +	/* Periodic split states (except isoc out) */
@@ -38479,10 +38372,10 @@ index 0000000000000000000000000000000000000000..2035e0762dc6d60673c8fbc47a90b722
 +}
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h
 new file mode 100644
-index 0000000000000000000000000000000000000000..f9fddfbcffb37f32c808fd78f222b676378398b1
+index 0000000000000000000000000000000000000000..8340041ce65665c094e2ad49fd5e8eb1751506f3
 --- /dev/null
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h
-@@ -0,0 +1,370 @@
+@@ -0,0 +1,372 @@
 +/*
 + * dwc_otg_fiq_fsm.h - Finite state machine FIQ header definitions
 + *
@@ -38655,6 +38548,8 @@ index 0000000000000000000000000000000000000000..f9fddfbcffb37f32c808fd78f222b676
 +	/* Nonperiodic state groups */
 +	FIQ_NP_SSPLIT_STARTED = 1,
 +	FIQ_NP_SSPLIT_RETRY = 2,
++	/* TT contention - working around hub bugs */
++	FIQ_NP_SSPLIT_PENDING = 33,
 +	FIQ_NP_OUT_CSPLIT_RETRY = 3,
 +	FIQ_NP_IN_CSPLIT_RETRY = 4,
 +	FIQ_NP_SPLIT_DONE = 5,
@@ -38941,10 +38836,10 @@ index 0000000000000000000000000000000000000000..ffa8d21bc61e893fee86ba04955587e7
 +END(_dwc_otg_fiq_stub)
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df0de772a8
+index 0000000000000000000000000000000000000000..60464acab588a1e189f39b268ffc25766c13dc85
 --- /dev/null
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-@@ -0,0 +1,4242 @@
+@@ -0,0 +1,4284 @@
 +
 +/* ==========================================================================
 + * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_hcd.c $
@@ -39873,8 +39768,6 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 +	DWC_FREE(dwc_otg_hcd);
 +}
 +
-+int init_hcd_usecs(dwc_otg_hcd_t *_hcd);
-+
 +int dwc_otg_hcd_init(dwc_otg_hcd_t * hcd, dwc_otg_core_if_t * core_if)
 +{
 +	struct device *dev = dwc_otg_hcd_to_dev(hcd);
@@ -40372,6 +40265,7 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 +
 +/**
 + * fiq_fsm_transaction_suitable() - Test a QH for compatibility with the FIQ
++ * @hcd:	Pointer to the dwc_otg_hcd struct
 + * @qh:	pointer to the endpoint's queue head
 + *
 + * Transaction start/end control flow is grafted onto the existing dwc_otg
@@ -40381,7 +40275,7 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 + * Returns: 0 for unsuitable, 1 implies the FIQ can be enabled for this transaction.
 + */
 +
-+int fiq_fsm_transaction_suitable(dwc_otg_qh_t *qh)
++int fiq_fsm_transaction_suitable(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh)
 +{
 +	if (qh->do_split) {
 +		switch (qh->ep_type) {
@@ -40400,28 +40294,22 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 +		}
 +	} else if (qh->ep_type == UE_ISOCHRONOUS) {
 +		if (fiq_fsm_mask & (1 << 2)) {
-+			/* HS ISOCH support. We test for compatibility:
++			/* ISOCH support. We test for compatibility:
 +			 * - DWORD aligned buffers
 +			 * - Must be at least 2 transfers (otherwise pointless to use the FIQ)
 +			 * If yes, then the fsm enqueue function will handle the state machine setup.
 +			 */
 +			dwc_otg_qtd_t *qtd = DWC_CIRCLEQ_FIRST(&qh->qtd_list);
 +			dwc_otg_hcd_urb_t *urb = qtd->urb;
-+			struct dwc_otg_hcd_iso_packet_desc (*iso_descs)[0] = &urb->iso_descs;
-+			int nr_iso_frames = urb->packet_count;
++			dwc_dma_t ptr;
 +			int i;
-+			uint32_t ptr;
 +
-+			if (nr_iso_frames < 2)
++			if (urb->packet_count < 2)
 +				return 0;
-+			for (i = 0; i < nr_iso_frames; i++) {
-+				ptr = urb->dma + iso_descs[i]->offset;
-+				if (ptr & 0x3) {
-+					printk_ratelimited("%s: Non-Dword aligned isochronous frame offset."
-+							" Cannot queue FIQ-accelerated transfer to device %d endpoint %d\n",
-+							__FUNCTION__, qh->channel->dev_addr, qh->channel->ep_num);
++			for (i = 0; i < urb->packet_count; i++) {
++				ptr = urb->dma + urb->iso_descs[i].offset;
++				if (ptr & 0x3)
 +					return 0;
-+				}
 +			}
 +			return 1;
 +		}
@@ -40522,6 +40410,45 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 +	}
 +}
 +
++/**
++ * fiq_fsm_np_tt_contended() - Avoid performing contended non-periodic transfers
++ * @hcd: Pointer to the dwc_otg_hcd struct
++ * @qh: Pointer to the endpoint's queue head
++ *
++ * Certain hub chips don't differentiate between IN and OUT non-periodic pipes
++ * with the same endpoint number. If transfers get completed out of order
++ * (disregarding the direction token) then the hub can lock up
++ * or return erroneous responses.
++ *
++ * Returns 1 if initiating the transfer would cause contention, 0 otherwise.
++ */
++int fiq_fsm_np_tt_contended(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh)
++{
++	int i;
++	struct fiq_channel_state *st;
++	int dev_addr = qh->channel->dev_addr;
++	int ep_num = qh->channel->ep_num;
++	for (i = 0; i < hcd->core_if->core_params->host_channels; i++) {
++		if (i == qh->channel->hc_num)
++			continue;
++		st = &hcd->fiq_state->channel[i];
++		switch (st->fsm) {
++		case FIQ_NP_SSPLIT_STARTED:
++		case FIQ_NP_SSPLIT_RETRY:
++		case FIQ_NP_SSPLIT_PENDING:
++		case FIQ_NP_OUT_CSPLIT_RETRY:
++		case FIQ_NP_IN_CSPLIT_RETRY:
++			if (st->hcchar_copy.b.devaddr == dev_addr &&
++				st->hcchar_copy.b.epnum == ep_num)
++				return 1;
++			break;
++		default:
++			break;
++		}
++	}
++	return 0;
++}
++
 +/*
 + * Pushing a periodic request into the queue near the EOF1 point
 + * in a microframe causes erroneous behaviour (frmovrun) interrupt.
@@ -40844,7 +40771,12 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 +	switch (hc->ep_type) {
 +		case UE_CONTROL:
 +		case UE_BULK:
-+			st->fsm = FIQ_NP_SSPLIT_STARTED;
++			if (fiq_fsm_np_tt_contended(hcd, qh)) {
++				st->fsm = FIQ_NP_SSPLIT_PENDING;
++				start_immediate = 0;
++			} else {
++				st->fsm = FIQ_NP_SSPLIT_STARTED;
++			}
 +			break;
 +		case UE_ISOCHRONOUS:
 +			if (hc->ep_is_in) {
@@ -40868,7 +40800,12 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 +			break;
 +		case UE_INTERRUPT:
 +			if (fiq_fsm_mask & 0x8) {
-+				st->fsm = FIQ_NP_SSPLIT_STARTED;
++				if (fiq_fsm_np_tt_contended(hcd, qh)) {
++					st->fsm = FIQ_NP_SSPLIT_PENDING;
++					start_immediate = 0;
++				} else {
++					st->fsm = FIQ_NP_SSPLIT_STARTED;
++				}
 +			} else if (start_immediate) {
 +					st->fsm = FIQ_PER_SSPLIT_STARTED;
 +			} else {
@@ -41161,7 +41098,7 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 +			continue;
 +		}
 +
-+		if (fiq_fsm_enable && fiq_fsm_transaction_suitable(qh)) {
++		if (fiq_fsm_enable && fiq_fsm_transaction_suitable(hcd, qh)) {
 +			if (qh->do_split)
 +				fiq_fsm_queue_split_transaction(hcd, qh);
 +			else
@@ -41298,7 +41235,7 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 +		qh = DWC_LIST_ENTRY(hcd->non_periodic_qh_ptr, dwc_otg_qh_t,
 +				    qh_list_entry);
 +
-+		if(fiq_fsm_enable && fiq_fsm_transaction_suitable(qh)) {
++		if(fiq_fsm_enable && fiq_fsm_transaction_suitable(hcd, qh)) {
 +			fiq_fsm_queue_split_transaction(hcd, qh);
 +		} else {
 +			status = queue_transaction(hcd, qh->channel,
@@ -43189,10 +43126,10 @@ index 0000000000000000000000000000000000000000..5e4d4ffe7966486d40a5b5e2423ac4df
 +#endif /* DWC_DEVICE_ONLY */
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd.h b/drivers/usb/host/dwc_otg/dwc_otg_hcd.h
 new file mode 100644
-index 0000000000000000000000000000000000000000..7f7e9eaffd6a3c3d898855562fbec11289f77f53
+index 0000000000000000000000000000000000000000..5ed8dccf03959a610849aa6c8946ca745dbae207
 --- /dev/null
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd.h
-@@ -0,0 +1,867 @@
+@@ -0,0 +1,870 @@
 +/* ==========================================================================
 + * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_hcd.h $
 + * $Revision: #58 $
@@ -43605,7 +43542,8 @@ index 0000000000000000000000000000000000000000..7f7e9eaffd6a3c3d898855562fbec112
 +			unsigned port_suspend_change:1;
 +			unsigned port_over_current_change:1;
 +			unsigned port_l1_change:1;
-+			unsigned reserved:26;
++			unsigned port_speed:2;
++			unsigned reserved:24;
 +		} b;
 +	} flags;
 +
@@ -43824,7 +43762,7 @@ index 0000000000000000000000000000000000000000..7f7e9eaffd6a3c3d898855562fbec112
 +void dwc_otg_hcd_release_port(dwc_otg_hcd_t * dwc_otg_hcd, dwc_otg_qh_t *qh);
 +
 +extern int fiq_fsm_queue_transaction(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh);
-+extern int fiq_fsm_transaction_suitable(dwc_otg_qh_t *qh);
++extern int fiq_fsm_transaction_suitable(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh);
 +extern void dwc_otg_cleanup_fiq_channel(dwc_otg_hcd_t *hcd, uint32_t num);
 +
 +/** @} */
@@ -44018,6 +43956,8 @@ index 0000000000000000000000000000000000000000..7f7e9eaffd6a3c3d898855562fbec112
 +	return frame & 0x7;
 +}
 +
++extern void init_hcd_usecs(dwc_otg_hcd_t *_hcd);
++
 +void dwc_otg_hcd_save_data_toggle(dwc_hc_t * hc,
 +				  dwc_otg_hc_regs_t * hc_regs,
 +				  dwc_otg_qtd_t * qtd);
@@ -45625,10 +45565,10 @@ index 0000000000000000000000000000000000000000..fb57db09378f4ab95d57cb58aa570a91
 +#endif /* DWC_DEVICE_ONLY */
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..fc52495e4749f45dcf270c1c22960f163b6dc86d
+index 0000000000000000000000000000000000000000..ed855eb9c3b64d54e93c5aa7e06212e779400dfd
 --- /dev/null
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c
-@@ -0,0 +1,2749 @@
+@@ -0,0 +1,2753 @@
 +/* ==========================================================================
 + * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_hcd_intr.c $
 + * $Revision: #89 $
@@ -46145,6 +46085,10 @@ index 0000000000000000000000000000000000000000..fc52495e4749f45dcf270c1c22960f16
 +			dwc_otg_host_if_t *host_if =
 +			    dwc_otg_hcd->core_if->host_if;
 +
++			dwc_otg_hcd->flags.b.port_speed = hprt0.b.prtspd;
++			if (microframe_schedule)
++				init_hcd_usecs(dwc_otg_hcd);
++
 +			/* Every time when port enables calculate
 +			 * HFIR.FrInterval
 +			 */
@@ -49393,10 +49337,10 @@ index 0000000000000000000000000000000000000000..96ec6338bbcb8ebe69a233d21a4b9d24
 +#endif /* DWC_DEVICE_ONLY */
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..85a6d431ca54b47dc10573aa72d1ad69d06f2e36
+index 0000000000000000000000000000000000000000..fe8e8f841f03660c2ad49ab8e66193bec62558d3
 --- /dev/null
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c
-@@ -0,0 +1,967 @@
+@@ -0,0 +1,971 @@
 +/* ==========================================================================
 + * $File: //dwh/usb_iip/dev/software/otg/linux/drivers/dwc_otg_hcd_queue.c $
 + * $Revision: #44 $
@@ -49442,6 +49386,7 @@ index 0000000000000000000000000000000000000000..85a6d431ca54b47dc10573aa72d1ad69
 +#include "dwc_otg_regs.h"
 +
 +extern bool microframe_schedule;
++extern unsigned short int_ep_interval_min;
 +
 +/**
 + * Free each QTD in the QH's QTD-list then free the QH.  QH should already be
@@ -49617,21 +49562,19 @@ index 0000000000000000000000000000000000000000..85a6d431ca54b47dc10573aa72d1ad69
 +						    SCHEDULE_SLOP);
 +		qh->interval = urb->interval;
 +
-+#if 0
-+		/* Increase interrupt polling rate for debugging. */
-+		if (qh->ep_type == UE_INTERRUPT) {
-+			qh->interval = 8;
-+		}
-+#endif
 +		hprt.d32 = DWC_READ_REG32(hcd->core_if->host_if->hprt0);
-+		if ((hprt.b.prtspd == DWC_HPRT0_PRTSPD_HIGH_SPEED) &&
-+		    ((dev_speed == USB_SPEED_LOW) ||
-+		     (dev_speed == USB_SPEED_FULL))) {
-+			qh->interval *= 8;
-+			qh->sched_frame |= 0x7;
-+			qh->start_split_frame = qh->sched_frame;
++		if (hprt.b.prtspd == DWC_HPRT0_PRTSPD_HIGH_SPEED) {
++			if (dev_speed == USB_SPEED_LOW ||
++					dev_speed == USB_SPEED_FULL) {
++				qh->interval *= 8;
++				qh->sched_frame |= 0x7;
++				qh->start_split_frame = qh->sched_frame;
++			} else if (int_ep_interval_min >= 2 &&
++					qh->interval < int_ep_interval_min &&
++					qh->ep_type == UE_INTERRUPT) {
++				qh->interval = int_ep_interval_min;
++			}
 +		}
-+
 +	}
 +
 +	DWC_DEBUGPL(DBG_HCD, "DWC OTG HCD QH Initialized\n");
@@ -49807,13 +49750,17 @@ index 0000000000000000000000000000000000000000..85a6d431ca54b47dc10573aa72d1ad69
 +/*
 + * called from dwc_otg_hcd.c:dwc_otg_hcd_init
 + */
-+int init_hcd_usecs(dwc_otg_hcd_t *_hcd)
++void init_hcd_usecs(dwc_otg_hcd_t *_hcd)
 +{
 +	int i;
-+	for (i=0; i<8; i++) {
-+		_hcd->frame_usecs[i] = max_uframe_usecs[i];
++	if (_hcd->flags.b.port_speed == DWC_HPRT0_PRTSPD_FULL_SPEED) {
++		_hcd->frame_usecs[0] = 900;
++		for (i = 1; i < 8; i++)
++			_hcd->frame_usecs[i] = 0;
++	} else {
++		for (i = 0; i < 8; i++)
++			_hcd->frame_usecs[i] = max_uframe_usecs[i];
 +	}
-+	return 0;
 +}
 +
 +static int find_single_uframe(dwc_otg_hcd_t * _hcd, dwc_otg_qh_t * _qh)
@@ -49940,8 +49887,9 @@ index 0000000000000000000000000000000000000000..85a6d431ca54b47dc10573aa72d1ad69
 +	int ret;
 +	ret = -1;
 +
-+	if (_qh->speed == USB_SPEED_HIGH) {
-+		/* if this is a hs transaction we need a full frame */
++	if (_qh->speed == USB_SPEED_HIGH ||
++		_hcd->flags.b.port_speed == DWC_HPRT0_PRTSPD_FULL_SPEED) {
++		/* if this is a hs transaction we need a full frame - or account for FS usecs */
 +		ret = find_single_uframe(_hcd, _qh);
 +	} else {
 +		/* if this is a fs transaction we may need a sequence of frames */
@@ -50026,7 +49974,7 @@ index 0000000000000000000000000000000000000000..85a6d431ca54b47dc10573aa72d1ad69
 +	if (status) {
 +		DWC_INFO("%s: Insufficient periodic bandwidth for "
 +			    "periodic transfer.\n", __func__);
-+		return status;
++		return -DWC_E_NO_SPACE;
 +	}
 +	status = check_max_xfer_size(hcd, qh);
 +	if (status) {
@@ -63635,10 +63583,10 @@ index 0000000000000000000000000000000000000000..cdc9963176e5a4a0d5250613b61e26c5
 +test_main();
 +0;
 
-From a40d36f39959c4f362ac2358c81a024725e44f94 Mon Sep 17 00:00:00 2001
+From def8163cd70fb2a1a8284999d0425bfd6503f95b Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Wed, 17 Jun 2015 17:06:34 +0100
-Subject: [PATCH 036/173] bcm2708 framebuffer driver
+Subject: [PATCH 038/126] bcm2708 framebuffer driver
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -63720,7 +63668,7 @@ Signed-off-by: Noralf Trønnes <noralf@tronnes.org>
  create mode 100644 drivers/video/fbdev/bcm2708_fb.c
 
 diff --git a/drivers/video/fbdev/Kconfig b/drivers/video/fbdev/Kconfig
-index 5c6696bb56da89d1ca86f00f16c3c408303ca5ad..7b44601d1c58007cdb3adafdf5f3c33a0801b8c6 100644
+index 5e58f5ec0a28e449afa8813a652b1aa3469e0721..127978982287bf04b6ea215433bd905ed432aa2f 100644
 --- a/drivers/video/fbdev/Kconfig
 +++ b/drivers/video/fbdev/Kconfig
 @@ -236,6 +236,20 @@ config FB_TILEBLITTING
@@ -67097,10 +67045,10 @@ index 3c14e43b82fefe1d32f591d1b2f61d2cd28d0fa8..7626beb6a5bb8df601ddf0f6e6909d1f
 +0 0 0  0 0 0  0 0 0  0 0 0  0 0 0  0 0 0
 +0 0 0  0 0 0  0 0 0
 
-From 1753129c47da9aadf7041d176407003fc466d9df Mon Sep 17 00:00:00 2001
+From fc95e1c758c4df4b1df63b69867eb303427a9996 Mon Sep 17 00:00:00 2001
 From: Florian Meier <florian.meier@koalo.de>
 Date: Fri, 22 Nov 2013 14:22:53 +0100
-Subject: [PATCH 037/173] dmaengine: Add support for BCM2708
+Subject: [PATCH 039/126] dmaengine: Add support for BCM2708
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -67259,10 +67207,10 @@ bcm2708-dmaengine - Fix arm64 portability/build issues
  create mode 100644 include/linux/platform_data/dma-bcm2708.h
 
 diff --git a/drivers/dma/Kconfig b/drivers/dma/Kconfig
-index f8883e93c4d89a3ae62a585329c8d5edb5c23058..ec67ffad5415015512958f1b76ccc181ce0cfa33 100644
+index e5244c1f9318bd4dbd98111394113b3e9f8596c3..845fb2ff22a243e8ca9bef585dc20b8dd200b77f 100644
 --- a/drivers/dma/Kconfig
 +++ b/drivers/dma/Kconfig
-@@ -125,7 +125,7 @@ config COH901318
+@@ -131,7 +131,7 @@ config COH901318
  
  config DMA_BCM2835
  	tristate "BCM2835 DMA engine support"
@@ -67271,7 +67219,7 @@ index f8883e93c4d89a3ae62a585329c8d5edb5c23058..ec67ffad5415015512958f1b76ccc181
  	select DMA_ENGINE
  	select DMA_VIRTUAL_CHANNELS
  
-@@ -529,6 +529,10 @@ config TIMB_DMA
+@@ -535,6 +535,10 @@ config TIMB_DMA
  	help
  	  Enable support for the Timberdale FPGA DMA engine.
  
@@ -67283,10 +67231,10 @@ index f8883e93c4d89a3ae62a585329c8d5edb5c23058..ec67ffad5415015512958f1b76ccc181
  	tristate "CPPI 4.1 DMA support"
  	depends on (ARCH_OMAP || ARCH_DAVINCI_DA8XX)
 diff --git a/drivers/dma/Makefile b/drivers/dma/Makefile
-index d12ab2985ed121e20a6351ec4c23604c50111339..8013779881d1a9442bdc26b12af8c1740b342a99 100644
+index f08f8de1b567c1f4911cd4216be85cf203debd36..cb884f5403a2c873fed5d9e24b2ff9cbe564f4b6 100644
 --- a/drivers/dma/Makefile
 +++ b/drivers/dma/Makefile
-@@ -19,6 +19,7 @@ obj-$(CONFIG_AT_XDMAC) += at_xdmac.o
+@@ -20,6 +20,7 @@ obj-$(CONFIG_AT_XDMAC) += at_xdmac.o
  obj-$(CONFIG_AXI_DMAC) += dma-axi-dmac.o
  obj-$(CONFIG_BCM_SBA_RAID) += bcm-sba-raid.o
  obj-$(CONFIG_COH901318) += coh901318.o coh901318_lli.o
@@ -67731,10 +67679,10 @@ index 0000000000000000000000000000000000000000..c5bfff2765be4606077e6c8af73040ec
 +
 +#endif /* _PLAT_BCM2708_DMA_H */
 
-From c9c5b3c903a77dbef477d199e2a5916d056fe4ed Mon Sep 17 00:00:00 2001
+From aab0a9271ac3b47d4d3e1df7e5d6fbc0298824d5 Mon Sep 17 00:00:00 2001
 From: gellert <gellert@raspberrypi.org>
 Date: Fri, 15 Aug 2014 16:35:06 +0100
-Subject: [PATCH 038/173] MMC: added alternative MMC driver
+Subject: [PATCH 040/126] MMC: added alternative MMC driver
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -67817,21 +67765,156 @@ See: https://github.com/raspberrypi/linux/issues/1327
 
 Signed-off-by: Phil Elwell <phil@raspberrypi.org>
 ---
+ drivers/mmc/core/block.c       |   28 +-
+ drivers/mmc/core/core.c        |    3 +-
+ drivers/mmc/core/host.c        |   17 +-
+ drivers/mmc/core/quirks.h      |    8 +
  drivers/mmc/host/Kconfig       |   29 +
  drivers/mmc/host/Makefile      |    1 +
- drivers/mmc/host/bcm2835-mmc.c | 1574 ++++++++++++++++++++++++++++++++++++++++
- 3 files changed, 1604 insertions(+)
+ drivers/mmc/host/bcm2835-mmc.c | 1584 ++++++++++++++++++++++++++++++++++++++++
+ include/linux/mmc/card.h       |    2 +
+ 8 files changed, 1667 insertions(+), 5 deletions(-)
  create mode 100644 drivers/mmc/host/bcm2835-mmc.c
 
+diff --git a/drivers/mmc/core/block.c b/drivers/mmc/core/block.c
+index 29fc1e662891d7bc2157ff55740bd2f110f4e14d..6bc17be504192e2e06760913e33033643c974f3d 100644
+--- a/drivers/mmc/core/block.c
++++ b/drivers/mmc/core/block.c
+@@ -126,6 +126,13 @@ static DEFINE_MUTEX(open_lock);
+ module_param(perdev_minors, int, 0444);
+ MODULE_PARM_DESC(perdev_minors, "Minors numbers to allocate per device");
+ 
++/*
++ * Allow quirks to be overridden for the current card
++ */
++static char *card_quirks;
++module_param(card_quirks, charp, 0644);
++MODULE_PARM_DESC(card_quirks, "Force the use of the indicated quirks (a bitfield)");
++
+ static inline int mmc_blk_part_switch(struct mmc_card *card,
+ 				      unsigned int part_type);
+ 
+@@ -2437,6 +2444,7 @@ static int mmc_blk_probe(struct mmc_card *card)
+ {
+ 	struct mmc_blk_data *md, *part_md;
+ 	char cap_str[10];
++	char quirk_str[24];
+ 
+ 	/*
+ 	 * Check that the card supports the command class(es) we need.
+@@ -2444,7 +2452,16 @@ static int mmc_blk_probe(struct mmc_card *card)
+ 	if (!(card->csd.cmdclass & CCC_BLOCK_READ))
+ 		return -ENODEV;
+ 
+-	mmc_fixup_device(card, mmc_blk_fixups);
++	if (card_quirks) {
++		unsigned long quirks;
++		if (kstrtoul(card_quirks, 0, &quirks) == 0)
++			card->quirks = (unsigned int)quirks;
++		else
++			pr_err("mmc_block: Invalid card_quirks parameter '%s'\n",
++			       card_quirks);
++	}
++	else
++		mmc_fixup_device(card, mmc_blk_fixups);
+ 
+ 	md = mmc_blk_alloc(card);
+ 	if (IS_ERR(md))
+@@ -2452,9 +2469,14 @@ static int mmc_blk_probe(struct mmc_card *card)
+ 
+ 	string_get_size((u64)get_capacity(md->disk), 512, STRING_UNITS_2,
+ 			cap_str, sizeof(cap_str));
+-	pr_info("%s: %s %s %s %s\n",
++	if (card->quirks)
++		snprintf(quirk_str, sizeof(quirk_str),
++			 " (quirks 0x%08x)", card->quirks);
++	else
++		quirk_str[0] = '\0';
++	pr_info("%s: %s %s %s%s%s\n",
+ 		md->disk->disk_name, mmc_card_id(card), mmc_card_name(card),
+-		cap_str, md->read_only ? "(ro)" : "");
++		cap_str, md->read_only ? " (ro)" : "", quirk_str);
+ 
+ 	if (mmc_blk_alloc_parts(card, md))
+ 		goto out;
+diff --git a/drivers/mmc/core/core.c b/drivers/mmc/core/core.c
+index 66c9cf49ad2f11fe59de05eae716b6b797766cc4..d970bdaadb96b31ee1727425523af4b3d2010e32 100644
+--- a/drivers/mmc/core/core.c
++++ b/drivers/mmc/core/core.c
+@@ -2210,7 +2210,8 @@ EXPORT_SYMBOL(mmc_erase);
+ int mmc_can_erase(struct mmc_card *card)
+ {
+ 	if ((card->host->caps & MMC_CAP_ERASE) &&
+-	    (card->csd.cmdclass & CCC_ERASE) && card->erase_size)
++	    (card->csd.cmdclass & CCC_ERASE) && card->erase_size &&
++	    !(card->quirks & MMC_QUIRK_ERASE_BROKEN))
+ 		return 1;
+ 	return 0;
+ }
+diff --git a/drivers/mmc/core/host.c b/drivers/mmc/core/host.c
+index ad88deb2e8f3b046838a3539841717951c33a6c6..2b424604e17161400b9002eeb2e836e4b7c6737e 100644
+--- a/drivers/mmc/core/host.c
++++ b/drivers/mmc/core/host.c
+@@ -350,15 +350,30 @@ struct mmc_host *mmc_alloc_host(int extra, struct device *dev)
+ {
+ 	int err;
+ 	struct mmc_host *host;
++	int id;
+ 
+ 	host = kzalloc(sizeof(struct mmc_host) + extra, GFP_KERNEL);
+ 	if (!host)
+ 		return NULL;
+ 
++	/* If OF aliases exist, start dynamic assignment after highest */
++	id = of_alias_get_highest_id("mmc");
++	id = (id < 0) ? 0 : id + 1;
++
++	/* If this devices has OF node, maybe it has an alias */
++	if (dev->of_node) {
++		int of_id = of_alias_get_id(dev->of_node, "mmc");
++
++		if (of_id < 0)
++			dev_warn(dev, "/aliases ID not available\n");
++		else
++			id = of_id;
++	}
++
+ 	/* scanning will be enabled when we're ready */
+ 	host->rescan_disable = 1;
+ 
+-	err = ida_simple_get(&mmc_host_ida, 0, 0, GFP_KERNEL);
++	err = ida_simple_get(&mmc_host_ida, id, 0, GFP_KERNEL);
+ 	if (err < 0) {
+ 		kfree(host);
+ 		return NULL;
+diff --git a/drivers/mmc/core/quirks.h b/drivers/mmc/core/quirks.h
+index fb725934fa21cee1b98fd7bc08227bf6d0317549..c9d5d644688c1509d7febcff0322fbaba0a842d6 100644
+--- a/drivers/mmc/core/quirks.h
++++ b/drivers/mmc/core/quirks.h
+@@ -90,6 +90,14 @@ static const struct mmc_fixup mmc_blk_fixups[] = {
+ 	MMC_FIXUP("V10016", CID_MANFID_KINGSTON, CID_OEMID_ANY, add_quirk_mmc,
+ 		  MMC_QUIRK_TRIM_BROKEN),
+ 
++	/*
++	 *  On some Kingston SD cards, multiple erases of less than 64
++	 *  sectors can cause corruption.
++	 */
++	MMC_FIXUP("SD16G", 0x41, 0x3432, add_quirk, MMC_QUIRK_ERASE_BROKEN),
++	MMC_FIXUP("SD32G", 0x41, 0x3432, add_quirk, MMC_QUIRK_ERASE_BROKEN),
++	MMC_FIXUP("SD64G", 0x41, 0x3432, add_quirk, MMC_QUIRK_ERASE_BROKEN),
++
+ 	END_FIXUP
+ };
+ 
 diff --git a/drivers/mmc/host/Kconfig b/drivers/mmc/host/Kconfig
-index 5755b69f2f728ffb829f257c2016a8965ce19c93..d657e99b7b5a9218cd37dd529ca08eef8c681981 100644
+index 02179ed2a40d7a87d0d1ae7ed43e95388ef36a72..1e5e64e5df56d08fa865231eb01187f61526bef5 100644
 --- a/drivers/mmc/host/Kconfig
 +++ b/drivers/mmc/host/Kconfig
 @@ -4,6 +4,35 @@
  
  comment "MMC/SD/SDIO Host Controller Drivers"
  
-+config MMC_BCM2835
++config MMC_BCM2835_MMC
 +	tristate "MMC support on BCM2835"
 +	depends on MACH_BCM2708 || MACH_BCM2709 || ARCH_BCM2835
 +	help
@@ -67843,7 +67926,7 @@ index 5755b69f2f728ffb829f257c2016a8965ce19c93..d657e99b7b5a9218cd37dd529ca08eef
 +
 +config MMC_BCM2835_DMA
 +	bool "DMA support on BCM2835 Arasan controller"
-+	depends on MMC_BCM2835
++	depends on MMC_BCM2835_MMC
 +	help
 +	  Enable DMA support on the Arasan SDHCI controller in Broadcom 2708
 +	  based chips.
@@ -67852,7 +67935,7 @@ index 5755b69f2f728ffb829f257c2016a8965ce19c93..d657e99b7b5a9218cd37dd529ca08eef
 +
 +config MMC_BCM2835_PIO_DMA_BARRIER
 +	int "Block count limit for PIO transfers"
-+	depends on MMC_BCM2835 && MMC_BCM2835_DMA
++	depends on MMC_BCM2835_MMC && MMC_BCM2835_DMA
 +	range 0 256
 +	default 2
 +	help
@@ -67860,27 +67943,27 @@ index 5755b69f2f728ffb829f257c2016a8965ce19c93..d657e99b7b5a9218cd37dd529ca08eef
 +
 +	  If unsure, say 2 here.
 +
- config MMC_ARMMMCI
- 	tristate "ARM AMBA Multimedia Card Interface support"
- 	depends on ARM_AMBA
+ config MMC_DEBUG
+ 	bool "MMC host drivers debugginG"
+ 	depends on MMC != n
 diff --git a/drivers/mmc/host/Makefile b/drivers/mmc/host/Makefile
-index 4d454711631158559c99a4df7953b17f3b1330d6..b8815fc623d7bba9f1375778daa274febeb32769 100644
+index 303f5cd46cd9092171117639fcb2da5733dde146..854d1a8f4addd298a2a752d89b9a710befd55783 100644
 --- a/drivers/mmc/host/Makefile
 +++ b/drivers/mmc/host/Makefile
-@@ -18,6 +18,7 @@ obj-$(CONFIG_MMC_SDHCI_S3C)	+= sdhci-s3c.o
+@@ -19,6 +19,7 @@ obj-$(CONFIG_MMC_SDHCI_S3C)	+= sdhci-s3c.o
  obj-$(CONFIG_MMC_SDHCI_SIRF)   	+= sdhci-sirf.o
  obj-$(CONFIG_MMC_SDHCI_F_SDH30)	+= sdhci_f_sdh30.o
  obj-$(CONFIG_MMC_SDHCI_SPEAR)	+= sdhci-spear.o
-+obj-$(CONFIG_MMC_BCM2835)	+= bcm2835-mmc.o
++obj-$(CONFIG_MMC_BCM2835_MMC)	+= bcm2835-mmc.o
  obj-$(CONFIG_MMC_WBSD)		+= wbsd.o
  obj-$(CONFIG_MMC_AU1X)		+= au1xmmc.o
  obj-$(CONFIG_MMC_MTK)		+= mtk-sd.o
 diff --git a/drivers/mmc/host/bcm2835-mmc.c b/drivers/mmc/host/bcm2835-mmc.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..4fe8d1fe44578fbefcd48f8c327ba3d03f3d0a2a
+index 0000000000000000000000000000000000000000..c4a5e992c6fb4a40b933239350ed4bfc8fb40155
 --- /dev/null
 +++ b/drivers/mmc/host/bcm2835-mmc.c
-@@ -0,0 +1,1574 @@
+@@ -0,0 +1,1584 @@
 +/*
 + * BCM2835 MMC host driver.
 + *
@@ -67998,6 +68081,7 @@ index 0000000000000000000000000000000000000000..4fe8d1fe44578fbefcd48f8c327ba3d0
 +
 +	bool					have_dma;
 +	bool					use_dma;
++	bool					wait_for_dma;
 +	/*end of DMA part*/
 +
 +	int						max_delay;	/* maximum length of time spent waiting */
@@ -68224,6 +68308,8 @@ index 0000000000000000000000000000000000000000..4fe8d1fe44578fbefcd48f8c327ba3d0
 +
 +	spin_lock_irqsave(&host->lock, flags);
 +
++	host->use_dma = false;
++
 +	if (host->data && !(host->data->flags & MMC_DATA_WRITE)) {
 +		/* otherwise handled in SDHCI IRQ */
 +		dma_chan = host->dma_chan_rxtx;
@@ -68234,6 +68320,9 @@ index 0000000000000000000000000000000000000000..4fe8d1fe44578fbefcd48f8c327ba3d0
 +		     dir_data);
 +
 +		bcm2835_mmc_finish_data(host);
++	} else if (host->wait_for_dma) {
++		host->wait_for_dma = false;
++		tasklet_schedule(&host->finish_tasklet);
 +	}
 +
 +	spin_unlock_irqrestore(&host->lock, flags);
@@ -68573,6 +68662,7 @@ index 0000000000000000000000000000000000000000..4fe8d1fe44578fbefcd48f8c327ba3d0
 +	mod_timer(&host->timer, timeout);
 +
 +	host->cmd = cmd;
++	host->use_dma = false;
 +
 +	bcm2835_mmc_prepare_data(host, cmd);
 +
@@ -68642,8 +68732,11 @@ index 0000000000000000000000000000000000000000..4fe8d1fe44578fbefcd48f8c327ba3d0
 +		}
 +
 +		bcm2835_mmc_send_command(host, data->stop);
-+	} else
++	} else if (host->use_dma) {
++		host->wait_for_dma = true;
++	} else {
 +		tasklet_schedule(&host->finish_tasklet);
++	}
 +}
 +
 +static void bcm2835_mmc_finish_command(struct bcm2835_host *host)
@@ -69237,14 +69330,14 @@ index 0000000000000000000000000000000000000000..4fe8d1fe44578fbefcd48f8c327ba3d0
 +		if (ret == 0) {
 +			host->dma_cfg_rx = cfg;
 +
-+			host->use_dma = true;
++			host->have_dma = true;
 +		} else {
 +			pr_err("%s: unable to configure DMA channel. "
-+			       "Faling back to PIO\n",
++			       "Falling back to PIO\n",
 +			       mmc_hostname(mmc));
 +			dma_release_channel(host->dma_chan_rxtx);
 +			host->dma_chan_rxtx = NULL;
-+			host->use_dma = false;
++			host->have_dma = false;
 +		}
 +	}
 +#endif
@@ -69455,11 +69548,24 @@ index 0000000000000000000000000000000000000000..4fe8d1fe44578fbefcd48f8c327ba3d0
 +MODULE_DESCRIPTION("BCM2835 SDHCI driver");
 +MODULE_LICENSE("GPL v2");
 +MODULE_AUTHOR("Gellert Weisz");
+diff --git a/include/linux/mmc/card.h b/include/linux/mmc/card.h
+index 279b39008a33bb68745d9ea55ea5dd7ed522fd1c..49bdea5791a289251019a89419804dde97dbd2d0 100644
+--- a/include/linux/mmc/card.h
++++ b/include/linux/mmc/card.h
+@@ -269,6 +269,8 @@ struct mmc_card {
+ #define MMC_QUIRK_TRIM_BROKEN	(1<<12)		/* Skip trim */
+ #define MMC_QUIRK_BROKEN_HPI	(1<<13)		/* Disable broken HPI support */
+ 
++#define MMC_QUIRK_ERASE_BROKEN	(1<<31)		/* Skip erase */
++
+ 	bool			reenable_cmdq;	/* Re-enable Command Queue */
+ 
+ 	unsigned int		erase_size;	/* erase size in sectors */
 
-From 7c111fc21e11126c810c8dd325ae4334bd54b9b2 Mon Sep 17 00:00:00 2001
+From 68ab1bd9c276aea2aa98b73bc2f7c91635fa02c0 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Wed, 25 Mar 2015 17:49:47 +0000
-Subject: [PATCH 039/173] Adding bcm2835-sdhost driver, and an overlay to
+Subject: [PATCH 041/126] Adding bcm2835-sdhost driver, and an overlay to
  enable it
 
 BCM2835 has two SD card interfaces. This driver uses the other one.
@@ -69633,7 +69739,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  create mode 100644 drivers/mmc/host/bcm2835-sdhost.c
 
 diff --git a/drivers/mmc/host/Kconfig b/drivers/mmc/host/Kconfig
-index d657e99b7b5a9218cd37dd529ca08eef8c681981..64bd7825131d3dcb003e7ece581b8d599a717b31 100644
+index 1e5e64e5df56d08fa865231eb01187f61526bef5..b40e7507fe8846c408798288f1e7ef6f6728de2f 100644
 --- a/drivers/mmc/host/Kconfig
 +++ b/drivers/mmc/host/Kconfig
 @@ -33,6 +33,16 @@ config MMC_BCM2835_PIO_DMA_BARRIER
@@ -69650,17 +69756,17 @@ index d657e99b7b5a9218cd37dd529ca08eef8c681981..64bd7825131d3dcb003e7ece581b8d59
 +
 +	  If unsure, say N.
 +
- config MMC_ARMMMCI
- 	tristate "ARM AMBA Multimedia Card Interface support"
- 	depends on ARM_AMBA
+ config MMC_DEBUG
+ 	bool "MMC host drivers debugginG"
+ 	depends on MMC != n
 diff --git a/drivers/mmc/host/Makefile b/drivers/mmc/host/Makefile
-index b8815fc623d7bba9f1375778daa274febeb32769..cd3a47d8965958ccf3ac3d186a05bbd437494154 100644
+index 854d1a8f4addd298a2a752d89b9a710befd55783..0d9808eadb2a714d29fdccae74445df5794ed2fc 100644
 --- a/drivers/mmc/host/Makefile
 +++ b/drivers/mmc/host/Makefile
-@@ -19,6 +19,7 @@ obj-$(CONFIG_MMC_SDHCI_SIRF)   	+= sdhci-sirf.o
+@@ -20,6 +20,7 @@ obj-$(CONFIG_MMC_SDHCI_SIRF)   	+= sdhci-sirf.o
  obj-$(CONFIG_MMC_SDHCI_F_SDH30)	+= sdhci_f_sdh30.o
  obj-$(CONFIG_MMC_SDHCI_SPEAR)	+= sdhci-spear.o
- obj-$(CONFIG_MMC_BCM2835)	+= bcm2835-mmc.o
+ obj-$(CONFIG_MMC_BCM2835_MMC)	+= bcm2835-mmc.o
 +obj-$(CONFIG_MMC_BCM2835_SDHOST)	+= bcm2835-sdhost.o
  obj-$(CONFIG_MMC_WBSD)		+= wbsd.o
  obj-$(CONFIG_MMC_AU1X)		+= au1xmmc.o
@@ -71865,10 +71971,10 @@ index 0000000000000000000000000000000000000000..9c6f199a7830959f31012d86bc1f8b1a
 +MODULE_LICENSE("GPL v2");
 +MODULE_AUTHOR("Phil Elwell");
 
-From ea3ad2b086d049e17be572c35e6c5bba86ebe6e4 Mon Sep 17 00:00:00 2001
+From 43815cbb870a02b9bdd15757340682319138b7e8 Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Fri, 28 Oct 2016 15:36:43 +0100
-Subject: [PATCH 040/173] vc_mem: Add vc_mem driver for querying firmware
+Subject: [PATCH 042/126] vc_mem: Add vc_mem driver for querying firmware
  memory addresses
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
@@ -72393,10 +72499,10 @@ index 0000000000000000000000000000000000000000..20a475377eb3078ea1ecaef2b24efc35
 +
 +#endif  /* _VC_MEM_H */
 
-From 5d1c473f557525d28a8b9f4a29330f6d8b746a1f Mon Sep 17 00:00:00 2001
+From 9acdc2d35c3bc4d9657cd5601f351dd78515e56f Mon Sep 17 00:00:00 2001
 From: Tim Gover <tgover@broadcom.com>
 Date: Tue, 22 Jul 2014 15:41:04 +0100
-Subject: [PATCH 041/173] vcsm: VideoCore shared memory service for BCM2835
+Subject: [PATCH 043/126] vcsm: VideoCore shared memory service for BCM2835
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -72445,19 +72551,32 @@ and the other VM_FAULT_SIGBUS crashing the user code.
 Also report when mapping fails.
 
 Signed-off-by: popcornmix <popcornmix@gmail.com>
+
+vcsm: Provide new ioctl to clean/invalidate a 2D block
+
+vcsm: Convert to loading via device tree.
+
+Signed-off-by: Dave Stevenson <dave.stevenson@raspberrypi.org>
+
+VCSM: New option to import a DMABUF for VPU use
+
+Takes a dmabuf, and then calls over to the VPU to wrap
+it into a suitable handle.
+
+Signed-off-by: Dave Stevenson <dave.stevenson@raspberrypi.org>
 ---
  drivers/char/Kconfig                     |    2 +
  drivers/char/Makefile                    |    1 +
  drivers/char/broadcom/Kconfig            |    9 +
  drivers/char/broadcom/Makefile           |    1 +
  drivers/char/broadcom/vc_sm/Makefile     |    9 +
- drivers/char/broadcom/vc_sm/vc_sm_defs.h |  181 ++
- drivers/char/broadcom/vc_sm/vc_sm_knl.h  |   55 +
- drivers/char/broadcom/vc_sm/vc_vchi_sm.c |  499 +++++
- drivers/char/broadcom/vc_sm/vc_vchi_sm.h |   82 +
- drivers/char/broadcom/vc_sm/vmcs_sm.c    | 3222 ++++++++++++++++++++++++++++++
- include/linux/broadcom/vmcs_sm_ioctl.h   |  248 +++
- 11 files changed, 4309 insertions(+)
+ drivers/char/broadcom/vc_sm/vc_sm_defs.h |  237 ++
+ drivers/char/broadcom/vc_sm/vc_sm_knl.h  |   53 +
+ drivers/char/broadcom/vc_sm/vc_vchi_sm.c |  516 +++++
+ drivers/char/broadcom/vc_sm/vc_vchi_sm.h |  102 +
+ drivers/char/broadcom/vc_sm/vmcs_sm.c    | 3505 ++++++++++++++++++++++++++++++
+ include/linux/broadcom/vmcs_sm_ioctl.h   |  280 +++
+ 11 files changed, 4715 insertions(+)
  create mode 100644 drivers/char/broadcom/vc_sm/Makefile
  create mode 100644 drivers/char/broadcom/vc_sm/vc_sm_defs.h
  create mode 100644 drivers/char/broadcom/vc_sm/vc_sm_knl.h
@@ -72467,7 +72586,7 @@ Signed-off-by: popcornmix <popcornmix@gmail.com>
  create mode 100644 include/linux/broadcom/vmcs_sm_ioctl.h
 
 diff --git a/drivers/char/Kconfig b/drivers/char/Kconfig
-index ccd239ab879ff326a1c7a85c2fd66fb8021d0f29..7cab65d4e530a701844bc4c3d65df2b4137b150d 100644
+index 6237143446002767402ba8af1f30a968e297d8c0..0aeb4d62816cc5421b9bb2d37fb3d9e39411b40a 100644
 --- a/drivers/char/Kconfig
 +++ b/drivers/char/Kconfig
 @@ -4,6 +4,8 @@
@@ -72529,23 +72648,25 @@ index 0000000000000000000000000000000000000000..19ce263bc273dcdb24ea2b4431e4cafc
 +    vc_vchi_sm.o
 diff --git a/drivers/char/broadcom/vc_sm/vc_sm_defs.h b/drivers/char/broadcom/vc_sm/vc_sm_defs.h
 new file mode 100644
-index 0000000000000000000000000000000000000000..c4d5ff718a5ba9071ef87fa4c6cf632486c4d36f
+index 0000000000000000000000000000000000000000..de6afe9f65af45582c79a62abd41c688274ad8f2
 --- /dev/null
 +++ b/drivers/char/broadcom/vc_sm/vc_sm_defs.h
-@@ -0,0 +1,181 @@
-+/*****************************************************************************
-+* Copyright 2011 Broadcom Corporation.  All rights reserved.
-+*
-+* Unless you and Broadcom execute a separate written software license
-+* agreement governing use of this software, this software is licensed to you
-+* under the terms of the GNU General Public License version 2, available at
-+* http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
-+*
-+* Notwithstanding the above, under no circumstances may you combine this
-+* software in any way with any other Broadcom software provided under a
-+* license other than the GPL, without Broadcom's express prior written
-+* consent.
-+*****************************************************************************/
+@@ -0,0 +1,237 @@
++/*
++ ****************************************************************************
++ * Copyright 2011 Broadcom Corporation.  All rights reserved.
++ *
++ * Unless you and Broadcom execute a separate written software license
++ * agreement governing use of this software, this software is licensed to you
++ * under the terms of the GNU General Public License version 2, available at
++ * http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
++ *
++ * Notwithstanding the above, under no circumstances may you combine this
++ * software in any way with any other Broadcom software provided under a
++ * license other than the GPL, without Broadcom's express prior written
++ * consent.
++ ****************************************************************************
++ */
 +
 +#ifndef __VC_SM_DEFS_H__INCLUDED__
 +#define __VC_SM_DEFS_H__INCLUDED__
@@ -72554,15 +72675,16 @@ index 0000000000000000000000000000000000000000..c4d5ff718a5ba9071ef87fa4c6cf6324
 +#define VC_SM_SERVER_NAME MAKE_FOURCC("SMEM")
 +
 +/* Maximum message length */
-+#define VC_SM_MAX_MSG_LEN (sizeof(VC_SM_MSG_UNION_T) + \
-+	sizeof(VC_SM_MSG_HDR_T))
-+#define VC_SM_MAX_RSP_LEN (sizeof(VC_SM_MSG_UNION_T))
++#define VC_SM_MAX_MSG_LEN (sizeof(union vc_sm_msg_union_t) + \
++	sizeof(struct vc_sm_msg_hdr_t))
++#define VC_SM_MAX_RSP_LEN (sizeof(union vc_sm_msg_union_t))
 +
 +/* Resource name maximum size */
 +#define VC_SM_RESOURCE_NAME 32
 +
-+/* All message types supported for HOST->VC direction */
-+typedef enum {
++enum vc_sm_msg_type {
++	/* Message types supported for HOST->VC direction */
++
 +	/* Allocate shared memory block */
 +	VC_SM_MSG_TYPE_ALLOC,
 +	/* Lock allocated shared memory block */
@@ -72580,28 +72702,42 @@ index 0000000000000000000000000000000000000000..c4d5ff718a5ba9071ef87fa4c6cf6324
 +
 +	/* A previously applied action will need to be reverted */
 +	VC_SM_MSG_TYPE_ACTION_CLEAN,
++
++	/*
++	 * Import a physical address and wrap into a MEM_HANDLE_T.
++	 * Release with VC_SM_MSG_TYPE_FREE.
++	 */
++	VC_SM_MSG_TYPE_IMPORT,
++
++	/* Message types supported for VC->HOST direction */
++
++	/*
++	 * VC has finished with an imported memory allocation.
++	 * Release any Linux reference counts on the underlying block.
++	 */
++	VC_SM_MSG_TYPE_RELEASED,
++
 +	VC_SM_MSG_TYPE_MAX
-+} VC_SM_MSG_TYPE;
++};
 +
 +/* Type of memory to be allocated */
-+typedef enum {
++enum vc_sm_alloc_type_t {
 +	VC_SM_ALLOC_CACHED,
 +	VC_SM_ALLOC_NON_CACHED,
-+
-+} VC_SM_ALLOC_TYPE_T;
++};
 +
 +/* Message header for all messages in HOST->VC direction */
-+typedef struct {
++struct vc_sm_msg_hdr_t {
 +	int32_t type;
 +	uint32_t trans_id;
 +	uint8_t body[0];
 +
-+} VC_SM_MSG_HDR_T;
++};
 +
 +/* Request to allocate memory (HOST->VC) */
-+typedef struct {
++struct vc_sm_alloc_t {
 +	/* type of memory to allocate */
-+	VC_SM_ALLOC_TYPE_T type;
++	enum vc_sm_alloc_type_t type;
 +	/* byte amount of data to allocate per unit */
 +	uint32_t base_unit;
 +	/* number of unit to allocate */
@@ -72613,126 +72749,167 @@ index 0000000000000000000000000000000000000000..c4d5ff718a5ba9071ef87fa4c6cf6324
 +	/* resource name (for easier tracking on vc side) */
 +	char name[VC_SM_RESOURCE_NAME];
 +
-+} VC_SM_ALLOC_T;
++};
 +
 +/* Result of a requested memory allocation (VC->HOST) */
-+typedef struct {
++struct vc_sm_alloc_result_t {
 +	/* Transaction identifier */
 +	uint32_t trans_id;
 +
 +	/* Resource handle */
 +	uint32_t res_handle;
 +	/* Pointer to resource buffer */
-+	void *res_mem;
++	uint32_t res_mem;
 +	/* Resource base size (bytes) */
 +	uint32_t res_base_size;
 +	/* Resource number */
 +	uint32_t res_num;
 +
-+} VC_SM_ALLOC_RESULT_T;
++};
 +
 +/* Request to free a previously allocated memory (HOST->VC) */
-+typedef struct {
++struct vc_sm_free_t {
 +	/* Resource handle (returned from alloc) */
 +	uint32_t res_handle;
 +	/* Resource buffer (returned from alloc) */
-+	void *res_mem;
++	uint32_t res_mem;
 +
-+} VC_SM_FREE_T;
++};
 +
 +/* Request to lock a previously allocated memory (HOST->VC) */
-+typedef struct {
++struct vc_sm_lock_unlock_t {
 +	/* Resource handle (returned from alloc) */
 +	uint32_t res_handle;
 +	/* Resource buffer (returned from alloc) */
-+	void *res_mem;
++	uint32_t res_mem;
 +
-+} VC_SM_LOCK_UNLOCK_T;
++};
 +
 +/* Request to resize a previously allocated memory (HOST->VC) */
-+typedef struct {
++struct vc_sm_resize_t {
 +	/* Resource handle (returned from alloc) */
 +	uint32_t res_handle;
 +	/* Resource buffer (returned from alloc) */
-+	void *res_mem;
++	uint32_t res_mem;
 +	/* Resource *new* size requested (bytes) */
 +	uint32_t res_new_size;
 +
-+} VC_SM_RESIZE_T;
++};
 +
 +/* Result of a requested memory lock (VC->HOST) */
-+typedef struct {
++struct vc_sm_lock_result_t {
 +	/* Transaction identifier */
 +	uint32_t trans_id;
 +
 +	/* Resource handle */
 +	uint32_t res_handle;
 +	/* Pointer to resource buffer */
-+	void *res_mem;
-+	/* Pointer to former resource buffer if the memory
-+	 * was reallocated */
-+	void *res_old_mem;
++	uint32_t res_mem;
++	/*
++	 * Pointer to former resource buffer if the memory
++	 * was reallocated
++	 */
++	uint32_t res_old_mem;
 +
-+} VC_SM_LOCK_RESULT_T;
++};
 +
 +/* Generic result for a request (VC->HOST) */
-+typedef struct {
++struct vc_sm_result_t {
 +	/* Transaction identifier */
 +	uint32_t trans_id;
 +
 +	int32_t success;
 +
-+} VC_SM_RESULT_T;
++};
 +
 +/* Request to revert a previously applied action (HOST->VC) */
-+typedef struct {
++struct vc_sm_action_clean_t {
 +	/* Action of interest */
-+	VC_SM_MSG_TYPE res_action;
++	enum vc_sm_msg_type res_action;
 +	/* Transaction identifier for the action of interest */
 +	uint32_t action_trans_id;
 +
-+} VC_SM_ACTION_CLEAN_T;
++};
 +
 +/* Request to remove all data associated with a given allocator (HOST->VC) */
-+typedef struct {
++struct vc_sm_free_all_t {
 +	/* Allocator identifier */
 +	uint32_t allocator;
++};
 +
-+} VC_SM_FREE_ALL_T;
++/* Request to import memory (HOST->VC) */
++struct vc_sm_import {
++	/* type of memory to allocate */
++	enum vc_sm_alloc_type_t type;
++	/* pointer to the VC (ie physical) address of the allocated memory */
++	uint32_t addr;
++	/* size of buffer */
++	uint32_t size;
++	/* opaque handle returned in RELEASED messages */
++	int32_t  kernel_id;
++	/* Allocator identifier */
++	uint32_t allocator;
++	/* resource name (for easier tracking on vc side) */
++	char     name[VC_SM_RESOURCE_NAME];
++};
++
++/* Result of a requested memory import (VC->HOST) */
++struct vc_sm_import_result {
++	/* Transaction identifier */
++	uint32_t trans_id;
++
++	/* Resource handle */
++	uint32_t res_handle;
++};
++
++/* Notification that VC has finished with an allocation (VC->HOST) */
++struct vc_sm_released {
++	/* pointer to the VC (ie physical) address of the allocated memory */
++	uint32_t addr;
++	/* size of buffer */
++	uint32_t size;
++	/* opaque handle returned in RELEASED messages */
++	int32_t  kernel_id;
++};
 +
 +/* Union of ALL messages */
-+typedef union {
-+	VC_SM_ALLOC_T alloc;
-+	VC_SM_ALLOC_RESULT_T alloc_result;
-+	VC_SM_FREE_T free;
-+	VC_SM_ACTION_CLEAN_T action_clean;
-+	VC_SM_RESIZE_T resize;
-+	VC_SM_LOCK_RESULT_T lock_result;
-+	VC_SM_RESULT_T result;
-+	VC_SM_FREE_ALL_T free_all;
-+
-+} VC_SM_MSG_UNION_T;
++union vc_sm_msg_union_t {
++	struct vc_sm_alloc_t alloc;
++	struct vc_sm_alloc_result_t alloc_result;
++	struct vc_sm_free_t free;
++	struct vc_sm_lock_unlock_t lock_unlock;
++	struct vc_sm_action_clean_t action_clean;
++	struct vc_sm_resize_t resize;
++	struct vc_sm_lock_result_t lock_result;
++	struct vc_sm_result_t result;
++	struct vc_sm_free_all_t free_all;
++	struct vc_sm_import import;
++	struct vc_sm_import_result import_result;
++	struct vc_sm_released released;
++};
 +
 +#endif /* __VC_SM_DEFS_H__INCLUDED__ */
 diff --git a/drivers/char/broadcom/vc_sm/vc_sm_knl.h b/drivers/char/broadcom/vc_sm/vc_sm_knl.h
 new file mode 100644
-index 0000000000000000000000000000000000000000..965f9a209a025202fea8065d3947c36f4fa43d0a
+index 0000000000000000000000000000000000000000..f7f74750d8358779c61dfcd6fc841aa1789a2c5e
 --- /dev/null
 +++ b/drivers/char/broadcom/vc_sm/vc_sm_knl.h
-@@ -0,0 +1,55 @@
-+/*****************************************************************************
-+* Copyright 2011 Broadcom Corporation.  All rights reserved.
-+*
-+* Unless you and Broadcom execute a separate written software license
-+* agreement governing use of this software, this software is licensed to you
-+* under the terms of the GNU General Public License version 2, available at
-+* http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
-+*
-+* Notwithstanding the above, under no circumstances may you combine this
-+* software in any way with any other Broadcom software provided under a
-+* license other than the GPL, without Broadcom's express prior written
-+* consent.
-+*****************************************************************************/
+@@ -0,0 +1,53 @@
++/*
++ ****************************************************************************
++ * Copyright 2011 Broadcom Corporation.  All rights reserved.
++ *
++ * Unless you and Broadcom execute a separate written software license
++ * agreement governing use of this software, this software is licensed to you
++ * under the terms of the GNU General Public License version 2, available at
++ * http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
++ *
++ * Notwithstanding the above, under no circumstances may you combine this
++ * software in any way with any other Broadcom software provided under a
++ * license other than the GPL, without Broadcom's express prior written
++ * consent.
++ ****************************************************************************
++ */
 +
 +#ifndef __VC_SM_KNL_H__INCLUDED__
 +#define __VC_SM_KNL_H__INCLUDED__
@@ -72742,58 +72919,56 @@ index 0000000000000000000000000000000000000000..965f9a209a025202fea8065d3947c36f
 +#endif
 +
 +/* Type of memory to be locked (ie mapped) */
-+typedef enum {
++enum vc_sm_lock_cache_mode {
 +	VC_SM_LOCK_CACHED,
 +	VC_SM_LOCK_NON_CACHED,
++};
 +
-+} VC_SM_LOCK_CACHE_MODE_T;
-+
-+/* Allocate a shared memory handle and block.
-+*/
-+int vc_sm_alloc(VC_SM_ALLOC_T *alloc, int *handle);
++/* Allocate a shared memory handle and block. */
++int vc_sm_alloc(struct vc_sm_alloc_t *alloc, int *handle);
 +
-+/* Free a previously allocated shared memory handle and block.
-+*/
++/* Free a previously allocated shared memory handle and block. */
 +int vc_sm_free(int handle);
 +
-+/* Lock a memory handle for use by kernel.
-+*/
-+int vc_sm_lock(int handle, VC_SM_LOCK_CACHE_MODE_T mode,
-+	       long unsigned int *data);
++/* Lock a memory handle for use by kernel. */
++int vc_sm_lock(int handle, enum vc_sm_lock_cache_mode mode,
++	       unsigned long *data);
 +
-+/* Unlock a memory handle in use by kernel.
-+*/
++/* Unlock a memory handle in use by kernel. */
 +int vc_sm_unlock(int handle, int flush, int no_vc_unlock);
 +
-+/* Get an internal resource handle mapped from the external one.
-+*/
++/* Get an internal resource handle mapped from the external one. */
 +int vc_sm_int_handle(int handle);
 +
-+/* Map a shared memory region for use by kernel.
-+*/
-+int vc_sm_map(int handle, unsigned int sm_addr, VC_SM_LOCK_CACHE_MODE_T mode,
-+	      long unsigned int *data);
++/* Map a shared memory region for use by kernel. */
++int vc_sm_map(int handle, unsigned int sm_addr,
++	      enum vc_sm_lock_cache_mode mode, unsigned long *data);
++
++/* Import a block of memory into the GPU space. */
++int vc_sm_import_dmabuf(struct dma_buf *dmabuf, int *handle);
 +
 +#endif /* __VC_SM_KNL_H__INCLUDED__ */
 diff --git a/drivers/char/broadcom/vc_sm/vc_vchi_sm.c b/drivers/char/broadcom/vc_sm/vc_vchi_sm.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f73a18a70
+index 0000000000000000000000000000000000000000..f8b909a09adb0743ed5d55dadf8fbf2fef055197
 --- /dev/null
 +++ b/drivers/char/broadcom/vc_sm/vc_vchi_sm.c
-@@ -0,0 +1,499 @@
-+/*****************************************************************************
-+* Copyright 2011-2012 Broadcom Corporation.  All rights reserved.
-+*
-+* Unless you and Broadcom execute a separate written software license
-+* agreement governing use of this software, this software is licensed to you
-+* under the terms of the GNU General Public License version 2, available at
-+* http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
-+*
-+* Notwithstanding the above, under no circumstances may you combine this
-+* software in any way with any other Broadcom software provided under a
-+* license other than the GPL, without Broadcom's express prior written
-+* consent.
-+*****************************************************************************/
+@@ -0,0 +1,516 @@
++/*
++ ****************************************************************************
++ * Copyright 2011-2012 Broadcom Corporation.  All rights reserved.
++ *
++ * Unless you and Broadcom execute a separate written software license
++ * agreement governing use of this software, this software is licensed to you
++ * under the terms of the GNU General Public License version 2, available at
++ * http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
++ *
++ * Notwithstanding the above, under no circumstances may you combine this
++ * software in any way with any other Broadcom software provided under a
++ * license other than the GPL, without Broadcom's express prior written
++ * consent.
++ ****************************************************************************
++ */
 +
 +/* ---- Include Files ----------------------------------------------------- */
 +#include <linux/types.h>
@@ -72866,11 +73041,11 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +
 +static struct
 +sm_cmd_rsp_blk *vc_vchi_cmd_create(struct sm_instance *instance,
-+		VC_SM_MSG_TYPE id, void *msg,
++		enum vc_sm_msg_type id, void *msg,
 +		uint32_t size, int wait)
 +{
 +	struct sm_cmd_rsp_blk *blk;
-+	VC_SM_MSG_HDR_T *hdr;
++	struct vc_sm_msg_hdr_t *hdr;
 +
 +	if (down_interruptible(&instance->free_sema)) {
 +		blk = kmalloc(sizeof(*blk), GFP_KERNEL);
@@ -72892,7 +73067,7 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +	blk->wait = wait;
 +	blk->length = sizeof(*hdr) + size;
 +
-+	hdr = (VC_SM_MSG_HDR_T *) blk->msg;
++	hdr = (struct vc_sm_msg_hdr_t *) blk->msg;
 +	hdr->type = id;
 +	mutex_lock(&instance->lock);
 +	hdr->trans_id = blk->id = ++instance->trans_id;
@@ -72922,7 +73097,7 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +{
 +	struct sm_instance *instance = arg;
 +	struct sm_cmd_rsp_blk *cmd = NULL, *cmd_tmp;
-+	VC_SM_RESULT_T *reply;
++	struct vc_sm_result_t *reply;
 +	uint32_t reply_len;
 +	int32_t status;
 +	int svc_use = 1;
@@ -73038,7 +73213,7 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +	}
 +}
 +
-+VC_VCHI_SM_HANDLE_T vc_vchi_sm_init(VCHI_INSTANCE_T vchi_instance,
++struct sm_instance *vc_vchi_sm_init(VCHI_INSTANCE_T vchi_instance,
 +				    VCHI_CONNECTION_T **vchi_connections,
 +				    uint32_t num_connections)
 +{
@@ -73108,7 +73283,8 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +	set_user_nice(instance->io_thread, -10);
 +	wake_up_process(instance->io_thread);
 +
-+	pr_debug("%s: success - instance 0x%x", __func__, (unsigned)instance);
++	pr_debug("%s: success - instance 0x%x", __func__,
++		 (unsigned int)instance);
 +	return instance;
 +
 +err_close_services:
@@ -73122,7 +73298,7 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +	return NULL;
 +}
 +
-+int vc_vchi_sm_stop(VC_VCHI_SM_HANDLE_T *handle)
++int vc_vchi_sm_stop(struct sm_instance **handle)
 +{
 +	struct sm_instance *instance;
 +	uint32_t i;
@@ -73142,6 +73318,7 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +	/* Close all VCHI service connections */
 +	for (i = 0; i < instance->num_connections; i++) {
 +		int32_t success;
++
 +		vchi_service_use(instance->vchi_handle[i]);
 +
 +		success = vchi_service_close(instance->vchi_handle[i]);
@@ -73156,8 +73333,8 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +	return -EINVAL;
 +}
 +
-+int vc_vchi_sm_send_msg(VC_VCHI_SM_HANDLE_T handle,
-+			VC_SM_MSG_TYPE msg_id,
++int vc_vchi_sm_send_msg(struct sm_instance *handle,
++			enum vc_sm_msg_type msg_id,
 +			void *msg, uint32_t msg_size,
 +			void *result, uint32_t result_size,
 +			uint32_t *cur_trans_id, uint8_t wait_reply)
@@ -73216,7 +73393,8 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +	if (result && result_size) {
 +		memcpy(result, cmd_blk->msg, result_size);
 +	} else {
-+		VC_SM_RESULT_T *res = (VC_SM_RESULT_T *) cmd_blk->msg;
++		struct vc_sm_result_t *res =
++			(struct vc_sm_result_t *) cmd_blk->msg;
 +		status = (res->success == 0) ? 0 : -ENXIO;
 +	}
 +
@@ -73227,32 +73405,34 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +	return status;
 +}
 +
-+int vc_vchi_sm_alloc(VC_VCHI_SM_HANDLE_T handle, VC_SM_ALLOC_T *msg,
-+		VC_SM_ALLOC_RESULT_T *result, uint32_t *cur_trans_id)
++int vc_vchi_sm_alloc(struct sm_instance *handle, struct vc_sm_alloc_t *msg,
++		     struct vc_sm_alloc_result_t *result,
++		     uint32_t *cur_trans_id)
 +{
 +	return vc_vchi_sm_send_msg(handle, VC_SM_MSG_TYPE_ALLOC,
 +				   msg, sizeof(*msg), result, sizeof(*result),
 +				   cur_trans_id, 1);
 +}
 +
-+int vc_vchi_sm_free(VC_VCHI_SM_HANDLE_T handle,
-+		    VC_SM_FREE_T *msg, uint32_t *cur_trans_id)
++int vc_vchi_sm_free(struct sm_instance *handle,
++		    struct vc_sm_free_t *msg, uint32_t *cur_trans_id)
 +{
 +	return vc_vchi_sm_send_msg(handle, VC_SM_MSG_TYPE_FREE,
 +				   msg, sizeof(*msg), 0, 0, cur_trans_id, 0);
 +}
 +
-+int vc_vchi_sm_lock(VC_VCHI_SM_HANDLE_T handle,
-+		    VC_SM_LOCK_UNLOCK_T *msg,
-+		    VC_SM_LOCK_RESULT_T *result, uint32_t *cur_trans_id)
++int vc_vchi_sm_lock(struct sm_instance *handle,
++		    struct vc_sm_lock_unlock_t *msg,
++		    struct vc_sm_lock_result_t *result,
++		    uint32_t *cur_trans_id)
 +{
 +	return vc_vchi_sm_send_msg(handle, VC_SM_MSG_TYPE_LOCK,
 +				   msg, sizeof(*msg), result, sizeof(*result),
 +				   cur_trans_id, 1);
 +}
 +
-+int vc_vchi_sm_unlock(VC_VCHI_SM_HANDLE_T handle,
-+		      VC_SM_LOCK_UNLOCK_T *msg,
++int vc_vchi_sm_unlock(struct sm_instance *handle,
++		      struct vc_sm_lock_unlock_t *msg,
 +		      uint32_t *cur_trans_id, uint8_t wait_reply)
 +{
 +	return vc_vchi_sm_send_msg(handle, wait_reply ?
@@ -73262,43 +73442,55 @@ index 0000000000000000000000000000000000000000..76abd126c4617b6310fcf0ebd7ab1d5f
 +				   wait_reply);
 +}
 +
-+int vc_vchi_sm_resize(VC_VCHI_SM_HANDLE_T handle, VC_SM_RESIZE_T *msg,
-+		uint32_t *cur_trans_id)
++int vc_vchi_sm_resize(struct sm_instance *handle, struct vc_sm_resize_t *msg,
++		      uint32_t *cur_trans_id)
 +{
 +	return vc_vchi_sm_send_msg(handle, VC_SM_MSG_TYPE_RESIZE,
 +				   msg, sizeof(*msg), 0, 0, cur_trans_id, 1);
 +}
 +
-+int vc_vchi_sm_walk_alloc(VC_VCHI_SM_HANDLE_T handle)
++int vc_vchi_sm_walk_alloc(struct sm_instance *handle)
 +{
 +	return vc_vchi_sm_send_msg(handle, VC_SM_MSG_TYPE_WALK_ALLOC,
 +				   0, 0, 0, 0, 0, 0);
 +}
 +
-+int vc_vchi_sm_clean_up(VC_VCHI_SM_HANDLE_T handle, VC_SM_ACTION_CLEAN_T *msg)
++int vc_vchi_sm_clean_up(struct sm_instance *handle,
++			struct vc_sm_action_clean_t *msg)
 +{
 +	return vc_vchi_sm_send_msg(handle, VC_SM_MSG_TYPE_ACTION_CLEAN,
 +				   msg, sizeof(*msg), 0, 0, 0, 0);
 +}
++
++int vc_vchi_sm_import(struct sm_instance *handle, struct vc_sm_import *msg,
++		      struct vc_sm_import_result *result,
++		      uint32_t *cur_trans_id)
++{
++	return vc_vchi_sm_send_msg(handle, VC_SM_MSG_TYPE_IMPORT,
++				   msg, sizeof(*msg), result, sizeof(*result),
++				   cur_trans_id, 1);
++}
 diff --git a/drivers/char/broadcom/vc_sm/vc_vchi_sm.h b/drivers/char/broadcom/vc_sm/vc_vchi_sm.h
 new file mode 100644
-index 0000000000000000000000000000000000000000..5e279f5a95fac7227cea15941bf0570ddc2b0886
+index 0000000000000000000000000000000000000000..abe4ed15836f2be756083d3fdb4edb544dacc1a6
 --- /dev/null
 +++ b/drivers/char/broadcom/vc_sm/vc_vchi_sm.h
-@@ -0,0 +1,82 @@
-+/*****************************************************************************
-+* Copyright 2011 Broadcom Corporation.  All rights reserved.
-+*
-+* Unless you and Broadcom execute a separate written software license
-+* agreement governing use of this software, this software is licensed to you
-+* under the terms of the GNU General Public License version 2, available at
-+* http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
-+*
-+* Notwithstanding the above, under no circumstances may you combine this
-+* software in any way with any other Broadcom software provided under a
-+* license other than the GPL, without Broadcom's express prior written
-+* consent.
-+*****************************************************************************/
+@@ -0,0 +1,102 @@
++/*
++ ****************************************************************************
++ * Copyright 2011 Broadcom Corporation.  All rights reserved.
++ *
++ * Unless you and Broadcom execute a separate written software license
++ * agreement governing use of this software, this software is licensed to you
++ * under the terms of the GNU General Public License version 2, available at
++ * http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
++ *
++ * Notwithstanding the above, under no circumstances may you combine this
++ * software in any way with any other Broadcom software provided under a
++ * license other than the GPL, without Broadcom's express prior written
++ * consent.
++ ****************************************************************************
++ */
 +
 +#ifndef __VC_VCHI_SM_H__INCLUDED__
 +#define __VC_VCHI_SM_H__INCLUDED__
@@ -73307,86 +73499,106 @@ index 0000000000000000000000000000000000000000..5e279f5a95fac7227cea15941bf0570d
 +
 +#include "vc_sm_defs.h"
 +
-+/* Forward declare.
-+*/
-+typedef struct sm_instance *VC_VCHI_SM_HANDLE_T;
++/*
++ * Forward declare.
++ */
++struct sm_instance;
 +
-+/* Initialize the shared memory service, opens up vchi connection to talk to it.
-+*/
-+VC_VCHI_SM_HANDLE_T vc_vchi_sm_init(VCHI_INSTANCE_T vchi_instance,
++/*
++ * Initialize the shared memory service, opens up vchi connection to talk to it.
++ */
++struct sm_instance *vc_vchi_sm_init(VCHI_INSTANCE_T vchi_instance,
 +				    VCHI_CONNECTION_T **vchi_connections,
 +				    uint32_t num_connections);
 +
-+/* Terminates the shared memory service.
-+*/
-+int vc_vchi_sm_stop(VC_VCHI_SM_HANDLE_T *handle);
++/*
++ * Terminates the shared memory service.
++ */
++int vc_vchi_sm_stop(struct sm_instance **handle);
 +
-+/* Ask the shared memory service to allocate some memory on videocre and
-+** return the result of this allocation (which upon success will be a pointer
-+** to some memory in videocore space).
-+*/
-+int vc_vchi_sm_alloc(VC_VCHI_SM_HANDLE_T handle,
-+		     VC_SM_ALLOC_T *alloc,
-+		     VC_SM_ALLOC_RESULT_T *alloc_result, uint32_t *trans_id);
++/*
++ * Ask the shared memory service to allocate some memory on videocre and
++ * return the result of this allocation (which upon success will be a pointer
++ * to some memory in videocore space).
++ */
++int vc_vchi_sm_alloc(struct sm_instance *handle, struct vc_sm_alloc_t *alloc,
++		     struct vc_sm_alloc_result_t *alloc_result,
++		     uint32_t *trans_id);
 +
-+/* Ask the shared memory service to free up some memory that was previously
-+** allocated by the vc_vchi_sm_alloc function call.
-+*/
-+int vc_vchi_sm_free(VC_VCHI_SM_HANDLE_T handle,
-+		    VC_SM_FREE_T *free, uint32_t *trans_id);
++/*
++ * Ask the shared memory service to free up some memory that was previously
++ * allocated by the vc_vchi_sm_alloc function call.
++ */
++int vc_vchi_sm_free(struct sm_instance *handle,
++		    struct vc_sm_free_t *free, uint32_t *trans_id);
 +
-+/* Ask the shared memory service to lock up some memory that was previously
-+** allocated by the vc_vchi_sm_alloc function call.
-+*/
-+int vc_vchi_sm_lock(VC_VCHI_SM_HANDLE_T handle,
-+		    VC_SM_LOCK_UNLOCK_T *lock_unlock,
-+		    VC_SM_LOCK_RESULT_T *lock_result, uint32_t *trans_id);
++/*
++ * Ask the shared memory service to lock up some memory that was previously
++ * allocated by the vc_vchi_sm_alloc function call.
++ */
++int vc_vchi_sm_lock(struct sm_instance *handle,
++		    struct vc_sm_lock_unlock_t *lock_unlock,
++		    struct vc_sm_lock_result_t *lock_result,
++		    uint32_t *trans_id);
 +
-+/* Ask the shared memory service to unlock some memory that was previously
-+** allocated by the vc_vchi_sm_alloc function call.
-+*/
-+int vc_vchi_sm_unlock(VC_VCHI_SM_HANDLE_T handle,
-+		      VC_SM_LOCK_UNLOCK_T *lock_unlock,
++/*
++ * Ask the shared memory service to unlock some memory that was previously
++ * allocated by the vc_vchi_sm_alloc function call.
++ */
++int vc_vchi_sm_unlock(struct sm_instance *handle,
++		      struct vc_sm_lock_unlock_t *lock_unlock,
 +		      uint32_t *trans_id, uint8_t wait_reply);
 +
-+/* Ask the shared memory service to resize some memory that was previously
-+** allocated by the vc_vchi_sm_alloc function call.
-+*/
-+int vc_vchi_sm_resize(VC_VCHI_SM_HANDLE_T handle,
-+		      VC_SM_RESIZE_T *resize, uint32_t *trans_id);
++/*
++ * Ask the shared memory service to resize some memory that was previously
++ * allocated by the vc_vchi_sm_alloc function call.
++ */
++int vc_vchi_sm_resize(struct sm_instance *handle,
++		      struct vc_sm_resize_t *resize, uint32_t *trans_id);
 +
-+/* Walk the allocated resources on the videocore side, the allocation will
-+** show up in the log.  This is purely for debug/information and takes no
-+** specific actions.
-+*/
-+int vc_vchi_sm_walk_alloc(VC_VCHI_SM_HANDLE_T handle);
++/*
++ * Walk the allocated resources on the videocore side, the allocation will
++ * show up in the log.  This is purely for debug/information and takes no
++ * specific actions.
++ */
++int vc_vchi_sm_walk_alloc(struct sm_instance *handle);
 +
-+/* Clean up following a previously interrupted action which left the system
-+** in a bad state of some sort.
-+*/
-+int vc_vchi_sm_clean_up(VC_VCHI_SM_HANDLE_T handle,
-+			VC_SM_ACTION_CLEAN_T *action_clean);
++/*
++ * Clean up following a previously interrupted action which left the system
++ * in a bad state of some sort.
++ */
++int vc_vchi_sm_clean_up(struct sm_instance *handle,
++			struct vc_sm_action_clean_t *action_clean);
++
++/*
++ * Import a contiguous block of memory and wrap it in a GPU MEM_HANDLE_T.
++ */
++int vc_vchi_sm_import(struct sm_instance *handle, struct vc_sm_import *msg,
++		      struct vc_sm_import_result *result,
++		      uint32_t *cur_trans_id);
 +
 +#endif /* __VC_VCHI_SM_H__INCLUDED__ */
 diff --git a/drivers/char/broadcom/vc_sm/vmcs_sm.c b/drivers/char/broadcom/vc_sm/vmcs_sm.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd4203179500
+index 0000000000000000000000000000000000000000..034ae2f27f870621af9f49453501f1cde051f32a
 --- /dev/null
 +++ b/drivers/char/broadcom/vc_sm/vmcs_sm.c
-@@ -0,0 +1,3222 @@
-+/*****************************************************************************
-+* Copyright 2011-2012 Broadcom Corporation.  All rights reserved.
-+*
-+* Unless you and Broadcom execute a separate written software license
-+* agreement governing use of this software, this software is licensed to you
-+* under the terms of the GNU General Public License version 2, available at
-+* http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
-+*
-+* Notwithstanding the above, under no circumstances may you combine this
-+* software in any way with any other Broadcom software provided under a
-+* license other than the GPL, without Broadcom's express prior written
-+* consent.
-+*****************************************************************************/
+@@ -0,0 +1,3505 @@
++/*
++ ****************************************************************************
++ * Copyright 2011-2012 Broadcom Corporation.  All rights reserved.
++ *
++ * Unless you and Broadcom execute a separate written software license
++ * agreement governing use of this software, this software is licensed to you
++ * under the terms of the GNU General Public License version 2, available at
++ * http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
++ *
++ * Notwithstanding the above, under no circumstances may you combine this
++ * software in any way with any other Broadcom software provided under a
++ * license other than the GPL, without Broadcom's express prior written
++ * consent.
++ ****************************************************************************
++ */
 +
 +/* ---- Include Files ----------------------------------------------------- */
 +
@@ -73395,6 +73607,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +#include <linux/device.h>
 +#include <linux/debugfs.h>
 +#include <linux/dma-mapping.h>
++#include <linux/dma-buf.h>
 +#include <linux/errno.h>
 +#include <linux/fs.h>
 +#include <linux/hugetlb.h>
@@ -73403,6 +73616,8 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +#include <linux/list.h>
 +#include <linux/module.h>
 +#include <linux/mm.h>
++#include <linux/of.h>
++#include <linux/platform_device.h>
 +#include <linux/pfn.h>
 +#include <linux/proc_fs.h>
 +#include <linux/pagemap.h>
@@ -73421,6 +73636,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +/* ---- Private Constants and Types --------------------------------------- */
 +
 +#define DEVICE_NAME              "vcsm"
++#define DRIVER_NAME		 "bcm2835-vcsm"
 +#define DEVICE_MINOR             0
 +
 +#define VC_SM_DIR_ROOT_NAME       "vc-smem"
@@ -73431,9 +73647,8 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +#define VC_SM_DEBUG               "debug"
 +#define VC_SM_WRITE_BUF_SIZE      128
 +
-+/* Statistics tracked per resource and globally.
-+*/
-+enum SM_STATS_T {
++/* Statistics tracked per resource and globally. */
++enum sm_stats_t {
 +	/* Attempt. */
 +	ALLOC,
 +	FREE,
@@ -73442,6 +73657,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	MAP,
 +	FLUSH,
 +	INVALID,
++	IMPORT,
 +
 +	END_ATTEMPT,
 +
@@ -73453,6 +73669,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	MAP_FAIL,
 +	FLUSH_FAIL,
 +	INVALID_FAIL,
++	IMPORT_FAIL,
 +
 +	END_ALL,
 +
@@ -73466,38 +73683,37 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	"Map",
 +	"Cache Flush",
 +	"Cache Invalidate",
++	"Import",
 +};
 +
 +typedef int (*VC_SM_SHOW) (struct seq_file *s, void *v);
-+struct SM_PDE_T {
++struct sm_pde_t {
 +	VC_SM_SHOW show;          /* Debug fs function hookup. */
 +	struct dentry *dir_entry; /* Debug fs directory entry. */
 +	void *priv_data;          /* Private data */
 +
 +};
 +
-+/* Single resource allocation tracked for all devices.
-+*/
++/* Single resource allocation tracked for all devices. */
 +struct sm_mmap {
 +	struct list_head map_list;	/* Linked list of maps. */
 +
-+	struct SM_RESOURCE_T *resource;	/* Pointer to the resource. */
++	struct sm_resource_t *resource;	/* Pointer to the resource. */
 +
-+	pid_t res_pid;		/* PID owning that resource. */
++	pid_t res_pid;			/* PID owning that resource. */
 +	unsigned int res_vc_hdl;	/* Resource handle (videocore). */
 +	unsigned int res_usr_hdl;	/* Resource handle (user). */
 +
-+	long unsigned int res_addr;	/* Mapped virtual address. */
++	unsigned long res_addr;	/* Mapped virtual address. */
 +	struct vm_area_struct *vma;	/* VM area for this mapping. */
-+	unsigned int ref_count;	/* Reference count to this vma. */
++	unsigned int ref_count;		/* Reference count to this vma. */
 +
 +	/* Used to link maps associated with a resource. */
 +	struct list_head resource_map_list;
 +};
 +
-+/* Single resource allocation tracked for each opened device.
-+*/
-+struct SM_RESOURCE_T {
++/* Single resource allocation tracked for each opened device. */
++struct sm_resource_t {
 +	struct list_head resource_list;	/* List of resources. */
 +	struct list_head global_resource_list;	/* Global list of resources. */
 +
@@ -73510,49 +73726,55 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	void *res_base_mem;	/* Resource base memory address. */
 +	uint32_t res_size;	/* Resource size allocated. */
 +	enum vmcs_sm_cache_e res_cached;	/* Resource cache type. */
-+	struct SM_RESOURCE_T *res_shared;	/* Shared resource */
++	struct sm_resource_t *res_shared;	/* Shared resource */
 +
-+	enum SM_STATS_T res_stats[END_ALL];	/* Resource statistics. */
++	enum sm_stats_t res_stats[END_ALL];	/* Resource statistics. */
 +
 +	uint8_t map_count;	/* Counter of mappings for this resource. */
 +	struct list_head map_list;	/* Maps associated with a resource. */
 +
-+	struct SM_PRIV_DATA_T *private;
++	/* DMABUF related fields */
++	struct dma_buf *dma_buf;
++	struct dma_buf_attachment *attach;
++	struct sg_table *sgt;
++	dma_addr_t dma_addr;
++
++	struct sm_priv_data_t *private;
++	bool map;		/* whether to map pages up front */
 +};
 +
-+/* Private file data associated with each opened device.
-+*/
-+struct SM_PRIV_DATA_T {
++/* Private file data associated with each opened device. */
++struct sm_priv_data_t {
 +	struct list_head resource_list; /* List of resources. */
 +
 +	pid_t pid;                      /* PID of creator. */
 +
 +	struct dentry *dir_pid;	   /* Debug fs entries root. */
-+	struct SM_PDE_T dir_stats; /* Debug fs entries statistics sub-tree. */
-+	struct SM_PDE_T dir_res;   /* Debug fs resource sub-tree. */
++	struct sm_pde_t dir_stats; /* Debug fs entries statistics sub-tree. */
++	struct sm_pde_t dir_res;   /* Debug fs resource sub-tree. */
 +
 +	int restart_sys;           /* Tracks restart on interrupt. */
-+	VC_SM_MSG_TYPE int_action; /* Interrupted action. */
++	enum vc_sm_msg_type int_action; /* Interrupted action. */
 +	uint32_t int_trans_id;     /* Interrupted transaction. */
 +
 +};
 +
-+/* Global state information.
-+*/
-+struct SM_STATE_T {
-+	VC_VCHI_SM_HANDLE_T sm_handle;	/* Handle for videocore service. */
++/* Global state information. */
++struct sm_state_t {
++	struct platform_device *pdev;
++	struct sm_instance *sm_handle;	/* Handle for videocore service. */
 +	struct dentry *dir_root;   /* Debug fs entries root. */
 +	struct dentry *dir_alloc;  /* Debug fs entries allocations. */
-+	struct SM_PDE_T dir_stats; /* Debug fs entries statistics sub-tree. */
-+	struct SM_PDE_T dir_state; /* Debug fs entries state sub-tree. */
++	struct sm_pde_t dir_stats; /* Debug fs entries statistics sub-tree. */
++	struct sm_pde_t dir_state; /* Debug fs entries state sub-tree. */
 +	struct dentry *debug;      /* Debug fs entries debug. */
 +
 +	struct mutex map_lock;          /* Global map lock. */
 +	struct list_head map_list;      /* List of maps. */
 +	struct list_head resource_list;	/* List of resources. */
 +
-+	enum SM_STATS_T deceased[END_ALL];    /* Natural termination stats. */
-+	enum SM_STATS_T terminated[END_ALL];  /* Forced termination stats. */
++	enum sm_stats_t deceased[END_ALL];    /* Natural termination stats. */
++	enum sm_stats_t terminated[END_ALL];  /* Forced termination stats. */
 +	uint32_t res_deceased_cnt;	      /* Natural termination counter. */
 +	uint32_t res_terminated_cnt;	      /* Forced termination counter. */
 +
@@ -73561,7 +73783,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	struct class *sm_class;	/* Class. */
 +	struct device *sm_dev;	/* Device. */
 +
-+	struct SM_PRIV_DATA_T *data_knl;    /* Kernel internal data tracking. */
++	struct sm_priv_data_t *data_knl;    /* Kernel internal data tracking. */
 +
 +	struct mutex lock;	/* Global lock. */
 +	uint32_t guid;		/* GUID (next) tracker. */
@@ -73570,7 +73792,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +/* ---- Private Variables ----------------------------------------------- */
 +
-+static struct SM_STATE_T *sm_state;
++static struct sm_state_t *sm_state;
 +static int sm_inited;
 +
 +#if 0
@@ -73582,22 +73804,50 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +};
 +#endif
 +
++typedef void cache_flush_op_fn(const void *, const void *);
++
++#if defined(CONFIG_CPU_CACHE_V7)
++extern cache_flush_op_fn v7_dma_inv_range;
++extern cache_flush_op_fn v7_dma_clean_range;
++static cache_flush_op_fn * const flushops[4] =
++{
++	0,
++	v7_dma_inv_range,
++	v7_dma_clean_range,
++	v7_dma_flush_range,
++};
++#elif defined(CONFIG_CPU_CACHE_V6)
++extern cache_flush_op_fn v6_dma_inv_range;
++extern cache_flush_op_fn v6_dma_clean_range;
++static cache_flush_op_fn * const flushops[4] =
++{
++	0,
++	v6_dma_inv_range,
++	v6_dma_clean_range,
++	v6_dma_flush_range,
++};
++#else
++#error Unknown cache config
++#endif
++
 +/* ---- Private Function Prototypes -------------------------------------- */
 +
 +/* ---- Private Functions ------------------------------------------------ */
 +
-+static inline unsigned vcaddr_to_pfn(unsigned long vc_addr)
++static inline unsigned int vcaddr_to_pfn(unsigned long vc_addr)
 +{
 +	unsigned long pfn = vc_addr & 0x3FFFFFFF;
++
 +	pfn += mm_vc_mem_phys_addr;
 +	pfn >>= PAGE_SHIFT;
 +	return pfn;
 +}
 +
-+/* Carries over to the state statistics the statistics once owned by a deceased
-+** resource.
-+*/
-+static void vc_sm_resource_deceased(struct SM_RESOURCE_T *p_res, int terminated)
++/*
++ * Carries over to the state statistics the statistics once owned by a deceased
++ * resource.
++ */
++static void vc_sm_resource_deceased(struct sm_resource_t *p_res, int terminated)
 +{
 +	if (sm_state != NULL) {
 +		if (p_res != NULL) {
@@ -73620,9 +73870,10 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	}
 +}
 +
-+/* Fetch a videocore handle corresponding to a mapping of the pid+address
-+** returns 0 (ie NULL) if no such handle exists in the global map.
-+*/
++/*
++ * Fetch a videocore handle corresponding to a mapping of the pid+address
++ * returns 0 (ie NULL) if no such handle exists in the global map.
++ */
 +static unsigned int vmcs_sm_vc_handle_from_pid_and_address(unsigned int pid,
 +							   unsigned int addr)
 +{
@@ -73634,8 +73885,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	mutex_lock(&(sm_state->map_lock));
 +
-+	/* Lookup the resource.
-+	 */
++	/* Lookup the resource. */
 +	if (!list_empty(&sm_state->map_list)) {
 +		list_for_each_entry(map, &sm_state->map_list, map_list) {
 +			if (map->res_pid != pid || map->res_addr != addr)
@@ -73653,13 +73903,14 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	mutex_unlock(&(sm_state->map_lock));
 +
 +out:
-+	/* Use a debug log here as it may be a valid situation that we query
-+	 ** for something that is not mapped, we do not want a kernel log each
-+	 ** time around.
-+	 **
-+	 ** There are other error log that would pop up accordingly if someone
-+	 ** subsequently tries to use something invalid after being told not to
-+	 ** use it...
++	/*
++	 * Use a debug log here as it may be a valid situation that we query
++	 * for something that is not mapped, we do not want a kernel log each
++	 * time around.
++	 *
++	 * There are other error log that would pop up accordingly if someone
++	 * subsequently tries to use something invalid after being told not to
++	 * use it...
 +	 */
 +	if (handle == 0) {
 +		pr_debug("[%s]: not a valid map (pid %u, addr %x)\n",
@@ -73669,9 +73920,10 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return handle;
 +}
 +
-+/* Fetch a user handle corresponding to a mapping of the pid+address
-+** returns 0 (ie NULL) if no such handle exists in the global map.
-+*/
++/*
++ * Fetch a user handle corresponding to a mapping of the pid+address
++ * returns 0 (ie NULL) if no such handle exists in the global map.
++ */
 +static unsigned int vmcs_sm_usr_handle_from_pid_and_address(unsigned int pid,
 +							    unsigned int addr)
 +{
@@ -73683,8 +73935,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	mutex_lock(&(sm_state->map_lock));
 +
-+	/* Lookup the resource.
-+	 */
++	/* Lookup the resource. */
 +	if (!list_empty(&sm_state->map_list)) {
 +		list_for_each_entry(map, &sm_state->map_list, map_list) {
 +			if (map->res_pid != pid || map->res_addr != addr)
@@ -73702,7 +73953,8 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	mutex_unlock(&(sm_state->map_lock));
 +
 +out:
-+	/* Use a debug log here as it may be a valid situation that we query
++	/*
++	 * Use a debug log here as it may be a valid situation that we query
 +	 * for something that is not mapped yet.
 +	 *
 +	 * There are other error log that would pop up accordingly if someone
@@ -73717,9 +73969,10 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +}
 +
 +#if defined(DO_NOT_USE)
-+/* Fetch an address corresponding to a mapping of the pid+handle
-+** returns 0 (ie NULL) if no such address exists in the global map.
-+*/
++/*
++ * Fetch an address corresponding to a mapping of the pid+handle
++ * returns 0 (ie NULL) if no such address exists in the global map.
++ */
 +static unsigned int vmcs_sm_usr_address_from_pid_and_vc_handle(unsigned int pid,
 +							       unsigned int hdl)
 +{
@@ -73731,8 +73984,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	mutex_lock(&(sm_state->map_lock));
 +
-+	/* Lookup the resource.
-+	 */
++	/* Lookup the resource. */
 +	if (!list_empty(&sm_state->map_list)) {
 +		list_for_each_entry(map, &sm_state->map_list, map_list) {
 +			if (map->res_pid != pid || map->res_vc_hdl != hdl)
@@ -73750,13 +74002,14 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	mutex_unlock(&(sm_state->map_lock));
 +
 +out:
-+	/* Use a debug log here as it may be a valid situation that we query
-+	 ** for something that is not mapped, we do not want a kernel log each
-+	 ** time around.
-+	 **
-+	 ** There are other error log that would pop up accordingly if someone
-+	 ** subsequently tries to use something invalid after being told not to
-+	 ** use it...
++	/*
++	 * Use a debug log here as it may be a valid situation that we query
++	 * for something that is not mapped, we do not want a kernel log each
++	 * time around.
++	 *
++	 * There are other error log that would pop up accordingly if someone
++	 * subsequently tries to use something invalid after being told not to
++	 * use it...
 +	 */
 +	if (addr == 0)
 +		pr_debug("[%s]: not a valid map (pid %u, hdl %x)\n",
@@ -73766,9 +74019,10 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +}
 +#endif
 +
-+/* Fetch an address corresponding to a mapping of the pid+handle
-+** returns 0 (ie NULL) if no such address exists in the global map.
-+*/
++/*
++ * Fetch an address corresponding to a mapping of the pid+handle
++ * returns 0 (ie NULL) if no such address exists in the global map.
++ */
 +static unsigned int vmcs_sm_usr_address_from_pid_and_usr_handle(unsigned int
 +								pid,
 +								unsigned int
@@ -73782,8 +74036,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	mutex_lock(&(sm_state->map_lock));
 +
-+	/* Lookup the resource.
-+	 */
++	/* Lookup the resource. */
 +	if (!list_empty(&sm_state->map_list)) {
 +		list_for_each_entry(map, &sm_state->map_list, map_list) {
 +			if (map->res_pid != pid || map->res_usr_hdl != hdl)
@@ -73801,7 +74054,8 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	mutex_unlock(&(sm_state->map_lock));
 +
 +out:
-+	/* Use a debug log here as it may be a valid situation that we query
++	/*
++	 * Use a debug log here as it may be a valid situation that we query
 +	 * for something that is not mapped, we do not want a kernel log each
 +	 * time around.
 +	 *
@@ -73816,19 +74070,16 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return addr;
 +}
 +
-+/* Adds a resource mapping to the global data list.
-+*/
-+static void vmcs_sm_add_map(struct SM_STATE_T *state,
-+			    struct SM_RESOURCE_T *resource, struct sm_mmap *map)
++/* Adds a resource mapping to the global data list. */
++static void vmcs_sm_add_map(struct sm_state_t *state,
++			    struct sm_resource_t *resource, struct sm_mmap *map)
 +{
 +	mutex_lock(&(state->map_lock));
 +
-+	/* Add to the global list of mappings
-+	 */
++	/* Add to the global list of mappings */
 +	list_add(&map->map_list, &state->map_list);
 +
-+	/* Add to the list of mappings for this resource
-+	 */
++	/* Add to the list of mappings for this resource */
 +	list_add(&map->resource_map_list, &resource->map_list);
 +	resource->map_count++;
 +
@@ -73839,20 +74090,17 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		map->res_usr_hdl, map->res_addr);
 +}
 +
-+/* Removes a resource mapping from the global data list.
-+*/
-+static void vmcs_sm_remove_map(struct SM_STATE_T *state,
-+			       struct SM_RESOURCE_T *resource,
++/* Removes a resource mapping from the global data list. */
++static void vmcs_sm_remove_map(struct sm_state_t *state,
++			       struct sm_resource_t *resource,
 +			       struct sm_mmap *map)
 +{
 +	mutex_lock(&(state->map_lock));
 +
-+	/* Remove from the global list of mappings
-+	 */
++	/* Remove from the global list of mappings */
 +	list_del(&map->map_list);
 +
-+	/* Remove from the list of mapping for this resource
-+	 */
++	/* Remove from the list of mapping for this resource */
 +	list_del(&map->resource_map_list);
 +	if (resource->map_count > 0)
 +		resource->map_count--;
@@ -73866,12 +74114,13 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	kfree(map);
 +}
 +
-+/* Read callback for the global state proc entry.
-+*/
++/* Read callback for the global state proc entry. */
 +static int vc_sm_global_state_show(struct seq_file *s, void *v)
 +{
 +	struct sm_mmap *map = NULL;
++	struct sm_resource_t *resource = NULL;
 +	int map_count = 0;
++	int resource_count = 0;
 +
 +	if (sm_state == NULL)
 +		return 0;
@@ -73879,11 +74128,44 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	seq_printf(s, "\nVC-ServiceHandle     0x%x\n",
 +		   (unsigned int)sm_state->sm_handle);
 +
-+	/* Log all applicable mapping(s).
-+	 */
++	/* Log all applicable mapping(s). */
 +
 +	mutex_lock(&(sm_state->map_lock));
++	seq_puts(s, "\nResources\n");
++	if (!list_empty(&sm_state->resource_list)) {
++		list_for_each_entry(resource, &sm_state->resource_list,
++				    global_resource_list) {
++			resource_count++;
++
++			seq_printf(s, "\nResource                %p\n",
++				   resource);
++			seq_printf(s, "           PID          %u\n",
++				   resource->pid);
++			seq_printf(s, "           RES_GUID     0x%x\n",
++				   resource->res_guid);
++			seq_printf(s, "           LOCK_COUNT   %u\n",
++				   resource->lock_count);
++			seq_printf(s, "           REF_COUNT    %u\n",
++				   resource->ref_count);
++			seq_printf(s, "           res_handle   0x%X\n",
++				   resource->res_handle);
++			seq_printf(s, "           res_base_mem %p\n",
++				   resource->res_base_mem);
++			seq_printf(s, "           SIZE         %d\n",
++				   resource->res_size);
++			seq_printf(s, "           DMABUF       %p\n",
++				   resource->dma_buf);
++			seq_printf(s, "           ATTACH       %p\n",
++				   resource->attach);
++			seq_printf(s, "           SGT          %p\n",
++				   resource->sgt);
++			seq_printf(s, "           DMA_ADDR     0x%08X\n",
++				   resource->dma_addr);
++		}
++	}
++	seq_printf(s, "\n\nTotal resource count:   %d\n\n", resource_count);
 +
++	seq_puts(s, "\nMappings\n");
 +	if (!list_empty(&sm_state->map_list)) {
 +		list_for_each_entry(map, &sm_state->map_list, map_list) {
 +			map_count++;
@@ -73898,6 +74180,8 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				   map->res_usr_hdl);
 +			seq_printf(s, "           USR-ADDR    0x%lx\n",
 +				   map->res_addr);
++			seq_printf(s, "           SIZE        %d\n",
++				   map->resource->res_size);
 +		}
 +	}
 +
@@ -73911,8 +74195,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +{
 +	int ix;
 +
-+	/* Global state tracked statistics.
-+	 */
++	/* Global state tracked statistics. */
 +	if (sm_state != NULL) {
 +		seq_puts(s, "\nDeceased Resources Statistics\n");
 +
@@ -73958,24 +74241,22 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +}
 +
 +#if 0
-+/* Read callback for the statistics proc entry.
-+*/
++/* Read callback for the statistics proc entry. */
 +static int vc_sm_statistics_show(struct seq_file *s, void *v)
 +{
 +	int ix;
-+	struct SM_PRIV_DATA_T *file_data;
-+	struct SM_RESOURCE_T *resource;
++	struct sm_priv_data_t *file_data;
++	struct sm_resource_t *resource;
 +	int res_count = 0;
-+	struct SM_PDE_T *p_pde;
++	struct sm_pde_t *p_pde;
 +
-+	p_pde = (struct SM_PDE_T *)(s->private);
-+	file_data = (struct SM_PRIV_DATA_T *)(p_pde->priv_data);
++	p_pde = (struct sm_pde_t *)(s->private);
++	file_data = (struct sm_priv_data_t *)(p_pde->priv_data);
 +
 +	if (file_data == NULL)
 +		return 0;
 +
-+	/* Per process statistics.
-+	 */
++	/* Per process statistics. */
 +
 +	seq_printf(s, "\nStatistics for TGID %d\n", file_data->pid);
 +
@@ -74021,13 +74302,13 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +/* Read callback for the allocation proc entry.  */
 +static int vc_sm_alloc_show(struct seq_file *s, void *v)
 +{
-+	struct SM_PRIV_DATA_T *file_data;
-+	struct SM_RESOURCE_T *resource;
++	struct sm_priv_data_t *file_data;
++	struct sm_resource_t *resource;
 +	int alloc_count = 0;
-+	struct SM_PDE_T *p_pde;
++	struct sm_pde_t *p_pde;
 +
-+	p_pde = (struct SM_PDE_T *)(s->private);
-+	file_data = (struct SM_PRIV_DATA_T *)(p_pde->priv_data);
++	p_pde = (struct sm_pde_t *)(s->private);
++	file_data = (struct sm_priv_data_t *)(p_pde->priv_data);
 +
 +	if (!file_data)
 +		return 0;
@@ -74069,9 +74350,9 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +static int vc_sm_seq_file_show(struct seq_file *s, void *v)
 +{
-+	struct SM_PDE_T *sm_pde;
++	struct sm_pde_t *sm_pde;
 +
-+	sm_pde = (struct SM_PDE_T *)(s->private);
++	sm_pde = (struct sm_pde_t *)(s->private);
 +
 +	if (sm_pde && sm_pde->show)
 +		sm_pde->show(s, v);
@@ -74091,11 +74372,12 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	.release = single_release,
 +};
 +
-+/* Adds a resource to the private data list which tracks all the allocated
-+** data.
-+*/
-+static void vmcs_sm_add_resource(struct SM_PRIV_DATA_T *privdata,
-+				 struct SM_RESOURCE_T *resource)
++/*
++ * Adds a resource to the private data list which tracks all the allocated
++ * data.
++ */
++static void vmcs_sm_add_resource(struct sm_priv_data_t *privdata,
++				 struct sm_resource_t *resource)
 +{
 +	mutex_lock(&(sm_state->map_lock));
 +	list_add(&resource->resource_list, &privdata->resource_list);
@@ -74107,14 +74389,15 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		resource->res_handle, resource->res_size, resource->res_cached);
 +}
 +
-+/* Locates a resource and acquire a reference on it.
-+** The resource won't be deleted while there is a reference on it.
-+*/
-+static struct SM_RESOURCE_T *vmcs_sm_acquire_resource(struct SM_PRIV_DATA_T
++/*
++ * Locates a resource and acquire a reference on it.
++ * The resource won't be deleted while there is a reference on it.
++ */
++static struct sm_resource_t *vmcs_sm_acquire_resource(struct sm_priv_data_t
 +						      *private,
 +						      unsigned int res_guid)
 +{
-+	struct SM_RESOURCE_T *resource, *ret = NULL;
++	struct sm_resource_t *resource, *ret = NULL;
 +
 +	mutex_lock(&(sm_state->map_lock));
 +
@@ -74136,13 +74419,14 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Locates a resource and acquire a reference on it.
-+** The resource won't be deleted while there is a reference on it.
-+*/
-+static struct SM_RESOURCE_T *vmcs_sm_acquire_first_resource(
-+		struct SM_PRIV_DATA_T *private)
++/*
++ * Locates a resource and acquire a reference on it.
++ * The resource won't be deleted while there is a reference on it.
++ */
++static struct sm_resource_t *vmcs_sm_acquire_first_resource(
++		struct sm_priv_data_t *private)
 +{
-+	struct SM_RESOURCE_T *resource, *ret = NULL;
++	struct sm_resource_t *resource, *ret = NULL;
 +
 +	mutex_lock(&(sm_state->map_lock));
 +
@@ -74161,13 +74445,14 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Locates a resource and acquire a reference on it.
-+** The resource won't be deleted while there is a reference on it.
-+*/
-+static struct SM_RESOURCE_T *vmcs_sm_acquire_global_resource(unsigned int
++/*
++ * Locates a resource and acquire a reference on it.
++ * The resource won't be deleted while there is a reference on it.
++ */
++static struct sm_resource_t *vmcs_sm_acquire_global_resource(unsigned int
 +							     res_guid)
 +{
-+	struct SM_RESOURCE_T *resource, *ret = NULL;
++	struct sm_resource_t *resource, *ret = NULL;
 +
 +	mutex_lock(&(sm_state->map_lock));
 +
@@ -74190,14 +74475,15 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Release a previously acquired resource.
-+** The resource will be deleted when its refcount reaches 0.
-+*/
-+static void vmcs_sm_release_resource(struct SM_RESOURCE_T *resource, int force)
++/*
++ * Release a previously acquired resource.
++ * The resource will be deleted when its refcount reaches 0.
++ */
++static void vmcs_sm_release_resource(struct sm_resource_t *resource, int force)
 +{
-+	struct SM_PRIV_DATA_T *private = resource->private;
++	struct sm_priv_data_t *private = resource->private;
 +	struct sm_mmap *map, *map_tmp;
-+	struct SM_RESOURCE_T *res_tmp;
++	struct sm_resource_t *res_tmp;
 +	int ret;
 +
 +	mutex_lock(&(sm_state->map_lock));
@@ -74214,7 +74500,8 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	list_del(&resource->resource_list);
 +	list_del(&resource->global_resource_list);
 +
-+	/* Walk the global resource list, find out if the resource is used
++	/*
++	 * Walk the global resource list, find out if the resource is used
 +	 * somewhere else. In which case we don't want to delete it.
 +	 */
 +	list_for_each_entry(res_tmp, &sm_state->resource_list,
@@ -74248,11 +74535,10 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		up_write(&current->mm->mmap_sem);
 +	}
 +
-+	/* Free up the videocore allocated resource.
-+	 */
++	/* Free up the videocore allocated resource. */
 +	if (resource->res_handle) {
-+		VC_SM_FREE_T free = {
-+			resource->res_handle, resource->res_base_mem
++		struct vc_sm_free_t free = {
++			resource->res_handle, (uint32_t)resource->res_base_mem
 +		};
 +		int status = vc_vchi_sm_free(sm_state->sm_handle, &free,
 +					     &private->int_trans_id);
@@ -74264,27 +74550,33 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		}
 +	}
 +
-+	/* Free up the shared resource.
-+	 */
++	if (resource->sgt)
++		dma_buf_unmap_attachment(resource->attach, resource->sgt,
++					 DMA_BIDIRECTIONAL);
++	if (resource->attach)
++		dma_buf_detach(resource->dma_buf, resource->attach);
++	if (resource->dma_buf)
++		dma_buf_put(resource->dma_buf);
++
++	/* Free up the shared resource. */
 +	if (resource->res_shared)
 +		vmcs_sm_release_resource(resource->res_shared, 0);
 +
-+	/* Free up the local resource tracking this allocation.
-+	 */
++	/* Free up the local resource tracking this allocation. */
 +	vc_sm_resource_deceased(resource, force);
 +	kfree(resource);
 +}
 +
-+/* Dump the map table for the driver.  If process is -1, dumps the whole table,
-+** if process is a valid pid (non -1) dump only the entries associated with the
-+** pid of interest.
-+*/
++/*
++ * Dump the map table for the driver.  If process is -1, dumps the whole table,
++ * if process is a valid pid (non -1) dump only the entries associated with the
++ * pid of interest.
++ */
 +static void vmcs_sm_host_walk_map_per_pid(int pid)
 +{
 +	struct sm_mmap *map = NULL;
 +
-+	/* Make sure the device was started properly.
-+	 */
++	/* Make sure the device was started properly. */
 +	if (sm_state == NULL) {
 +		pr_err("[%s]: invalid device\n", __func__);
 +		return;
@@ -74292,8 +74584,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	mutex_lock(&(sm_state->map_lock));
 +
-+	/* Log all applicable mapping(s).
-+	 */
++	/* Log all applicable mapping(s). */
 +	if (!list_empty(&sm_state->map_list)) {
 +		list_for_each_entry(map, &sm_state->map_list, map_list) {
 +			if (pid == -1 || map->res_pid == pid) {
@@ -74305,19 +74596,17 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	}
 +
 +	mutex_unlock(&(sm_state->map_lock));
-+
-+	return;
 +}
 +
-+/* Dump the allocation table from host side point of view.  This only dumps the
-+** data allocated for this process/device referenced by the file_data.
-+*/
-+static void vmcs_sm_host_walk_alloc(struct SM_PRIV_DATA_T *file_data)
++/*
++ * Dump the allocation table from host side point of view.  This only dumps the
++ * data allocated for this process/device referenced by the file_data.
++ */
++static void vmcs_sm_host_walk_alloc(struct sm_priv_data_t *file_data)
 +{
-+	struct SM_RESOURCE_T *resource = NULL;
++	struct sm_resource_t *resource = NULL;
 +
-+	/* Make sure the device was started properly.
-+	 */
++	/* Make sure the device was started properly. */
 +	if ((sm_state == NULL) || (file_data == NULL)) {
 +		pr_err("[%s]: invalid device\n", __func__);
 +		return;
@@ -74336,16 +74625,13 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	}
 +
 +	mutex_unlock(&(sm_state->map_lock));
-+
-+	return;
 +}
 +
-+/* Create support for private data tracking.
-+*/
-+static struct SM_PRIV_DATA_T *vc_sm_create_priv_data(pid_t id)
++/* Create support for private data tracking. */
++static struct sm_priv_data_t *vc_sm_create_priv_data(pid_t id)
 +{
 +	char alloc_name[32];
-+	struct SM_PRIV_DATA_T *file_data = NULL;
++	struct sm_priv_data_t *file_data = NULL;
 +
 +	/* Allocate private structure. */
 +	file_data = kzalloc(sizeof(*file_data), GFP_KERNEL);
@@ -74369,7 +74655,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	} else {
 +		struct dentry *dir_entry;
 +
-+		dir_entry = debugfs_create_file(VC_SM_RESOURCES, S_IRUGO,
++		dir_entry = debugfs_create_file(VC_SM_RESOURCES, 0444,
 +				file_data->dir_pid, file_data,
 +				vc_sm_debug_fs_fops);
 +
@@ -74377,7 +74663,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		file_data->dir_res.priv_data = file_data;
 +		file_data->dir_res.show = &vc_sm_alloc_show;
 +
-+		dir_entry = debugfs_create_file(VC_SM_STATS, S_IRUGO,
++		dir_entry = debugfs_create_file(VC_SM_STATS, 0444,
 +				file_data->dir_pid, file_data,
 +				vc_sm_debug_fs_fops);
 +
@@ -74392,15 +74678,15 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return file_data;
 +}
 +
-+/* Open the device.  Creates a private state to help track all allocation
-+** associated with this device.
-+*/
++/*
++ * Open the device.  Creates a private state to help track all allocation
++ * associated with this device.
++ */
 +static int vc_sm_open(struct inode *inode, struct file *file)
 +{
 +	int ret = 0;
 +
-+	/* Make sure the device was started properly.
-+	 */
++	/* Make sure the device was started properly. */
 +	if (!sm_state) {
 +		pr_err("[%s]: invalid device\n", __func__);
 +		ret = -EPERM;
@@ -74419,18 +74705,18 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Close the device.  Free up all resources still associated with this device
-+** at the time.
-+*/
++/*
++ * Close the device.  Free up all resources still associated with this device
++ * at the time.
++ */
 +static int vc_sm_release(struct inode *inode, struct file *file)
 +{
-+	struct SM_PRIV_DATA_T *file_data =
-+	    (struct SM_PRIV_DATA_T *)file->private_data;
-+	struct SM_RESOURCE_T *resource;
++	struct sm_priv_data_t *file_data =
++	    (struct sm_priv_data_t *)file->private_data;
++	struct sm_resource_t *resource;
 +	int ret = 0;
 +
-+	/* Make sure the device was started properly.
-+	 */
++	/* Make sure the device was started properly. */
 +	if (sm_state == NULL || file_data == NULL) {
 +		pr_err("[%s]: invalid device\n", __func__);
 +		ret = -EPERM;
@@ -74440,7 +74726,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	pr_debug("[%s]: using private data %p\n", __func__, file_data);
 +
 +	if (file_data->restart_sys == -EINTR) {
-+		VC_SM_ACTION_CLEAN_T action_clean;
++		struct vc_sm_action_clean_t action_clean;
 +
 +		pr_debug("[%s]: releasing following EINTR on %u (trans_id: %u) (likely due to signal)...\n",
 +			__func__, file_data->int_action,
@@ -74460,8 +74746,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	/* Remove the corresponding proc entry. */
 +	debugfs_remove_recursive(file_data->dir_pid);
 +
-+	/* Terminate the private data.
-+	 */
++	/* Terminate the private data. */
 +	kfree(file_data);
 +
 +out:
@@ -74489,8 +74774,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	map->ref_count--;
 +
-+	/* Remove from the map table.
-+	 */
++	/* Remove from the map table. */
 +	if (map->ref_count == 0)
 +		vmcs_sm_remove_map(sm_state, map->resource, map);
 +}
@@ -74498,30 +74782,28 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +static int vcsm_vma_fault(struct vm_fault *vmf)
 +{
 +	struct sm_mmap *map = (struct sm_mmap *)vmf->vma->vm_private_data;
-+	struct SM_RESOURCE_T *resource = map->resource;
++	struct sm_resource_t *resource = map->resource;
 +	pgoff_t page_offset;
 +	unsigned long pfn;
 +	int ret = 0;
 +
-+	/* Lock the resource if necessary.
-+	 */
++	/* Lock the resource if necessary. */
 +	if (!resource->lock_count) {
-+		VC_SM_LOCK_UNLOCK_T lock_unlock;
-+		VC_SM_LOCK_RESULT_T lock_result;
++		struct vc_sm_lock_unlock_t lock_unlock;
++		struct vc_sm_lock_result_t lock_result;
 +		int status;
 +
 +		lock_unlock.res_handle = resource->res_handle;
-+		lock_unlock.res_mem = resource->res_base_mem;
++		lock_unlock.res_mem = (uint32_t)resource->res_base_mem;
 +
 +		pr_debug("[%s]: attempt to lock data - hdl %x, base address %p\n",
-+			__func__, lock_unlock.res_handle, lock_unlock.res_mem);
++			__func__, lock_unlock.res_handle,
++			(void *)lock_unlock.res_mem);
 +
-+		/* Lock the videocore allocated resource.
-+		 */
++		/* Lock the videocore allocated resource. */
 +		status = vc_vchi_sm_lock(sm_state->sm_handle,
 +					 &lock_unlock, &lock_result, 0);
-+		if ((status != 0) ||
-+		    ((status == 0) && (lock_result.res_mem == NULL))) {
++		if (status || !lock_result.res_mem) {
 +			pr_err("[%s]: failed to lock memory on videocore (status: %u)\n",
 +					__func__, status);
 +			resource->res_stats[LOCK_FAIL]++;
@@ -74535,12 +74817,11 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		resource->res_stats[LOCK]++;
 +		resource->lock_count++;
 +
-+		/* Keep track of the new base memory.
-+		 */
-+		if ((lock_result.res_mem != NULL) &&
-+		    (lock_result.res_old_mem != NULL) &&
++		/* Keep track of the new base memory. */
++		if (lock_result.res_mem &&
++		    lock_result.res_old_mem &&
 +		    (lock_result.res_mem != lock_result.res_old_mem)) {
-+			resource->res_base_mem = lock_result.res_mem;
++			resource->res_base_mem = (void *)lock_result.res_mem;
 +		}
 +	}
 +
@@ -74558,9 +74839,9 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	case 0:
 +	case -ERESTARTSYS:
 +	/*
-+	* EBUSY is ok: this just means that another thread
-+	* already did the job.
-+	*/
++	 * EBUSY is ok: this just means that another thread
++	 * already did the job.
++	 */
 +	case -EBUSY:
 +		return VM_FAULT_NOPAGE;
 +	case -ENOMEM:
@@ -74575,7 +74856,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	}
 +}
 +
-+static struct vm_operations_struct vcsm_vm_ops = {
++static const struct vm_operations_struct vcsm_vm_ops = {
 +	.open = vcsm_vma_open,
 +	.close = vcsm_vma_close,
 +	.fault = vcsm_vma_fault,
@@ -74638,18 +74919,16 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	} while (pgd++, addr = pgd_next, addr != end);
 +}
 +
-+/* Map an allocated data into something that the user space.
-+*/
++/* Map an allocated data into something that the user space. */
 +static int vc_sm_mmap(struct file *file, struct vm_area_struct *vma)
 +{
 +	int ret = 0;
-+	struct SM_PRIV_DATA_T *file_data =
-+	    (struct SM_PRIV_DATA_T *)file->private_data;
-+	struct SM_RESOURCE_T *resource = NULL;
++	struct sm_priv_data_t *file_data =
++	    (struct sm_priv_data_t *)file->private_data;
++	struct sm_resource_t *resource = NULL;
 +	struct sm_mmap *map = NULL;
 +
-+	/* Make sure the device was started properly.
-+	 */
++	/* Make sure the device was started properly. */
 +	if ((sm_state == NULL) || (file_data == NULL)) {
 +		pr_err("[%s]: invalid device\n", __func__);
 +		return -EPERM;
@@ -74658,11 +74937,12 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	pr_debug("[%s]: private data %p, guid %x\n", __func__, file_data,
 +		((unsigned int)vma->vm_pgoff << PAGE_SHIFT));
 +
-+	/* We lookup to make sure that the data we are being asked to mmap is
-+	 ** something that we allocated.
-+	 **
-+	 ** We use the offset information as the key to tell us which resource
-+	 ** we are mapping.
++	/*
++	 * We lookup to make sure that the data we are being asked to mmap is
++	 * something that we allocated.
++	 *
++	 * We use the offset information as the key to tell us which resource
++	 * we are mapping.
 +	 */
 +	resource = vmcs_sm_acquire_resource(file_data,
 +					    ((unsigned int)vma->vm_pgoff <<
@@ -74677,8 +74957,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		__func__, resource->res_guid, current->tgid, resource->pid,
 +		file_data->pid);
 +
-+	/* Check permissions.
-+	 */
++	/* Check permissions. */
 +	if (resource->pid && (resource->pid != current->tgid)) {
 +		pr_err("[%s]: current tgid %u != %u owner\n",
 +			__func__, current->tgid, resource->pid);
@@ -74686,8 +74965,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto error;
 +	}
 +
-+	/* Verify that what we are asked to mmap is proper.
-+	 */
++	/* Verify that what we are asked to mmap is proper. */
 +	if (resource->res_size != (unsigned int)(vma->vm_end - vma->vm_start)) {
 +		pr_err("[%s]: size inconsistency (resource: %u - mmap: %u)\n",
 +			__func__,
@@ -74698,7 +74976,8 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto error;
 +	}
 +
-+	/* Keep track of the tuple in the global resource list such that one
++	/*
++	 * Keep track of the tuple in the global resource list such that one
 +	 * can do a mapping lookup for address/memory handle.
 +	 */
 +	map = kzalloc(sizeof(*map), GFP_KERNEL);
@@ -74712,13 +74991,14 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	map->res_pid = current->tgid;
 +	map->res_vc_hdl = resource->res_handle;
 +	map->res_usr_hdl = resource->res_guid;
-+	map->res_addr = (long unsigned int)vma->vm_start;
++	map->res_addr = (unsigned long)vma->vm_start;
 +	map->resource = resource;
 +	map->vma = vma;
 +	vmcs_sm_add_map(sm_state, resource, map);
 +
-+	/* We are not actually mapping the pages, we just provide a fault
-+	 ** handler to allow pages to be mapped when accessed
++	/*
++	 * We are not actually mapping the pages, we just provide a fault
++	 * handler to allow pages to be mapped when accessed
 +	 */
 +	vma->vm_flags |=
 +	    VM_IO | VM_PFNMAP | VM_DONTCOPY | VM_DONTEXPAND;
@@ -74732,8 +75012,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	if ((resource->res_cached == VMCS_SM_CACHE_NONE) ||
 +	    (resource->res_cached == VMCS_SM_CACHE_VC)) {
-+		/* Allocated non host cached memory, honour it.
-+		 */
++		/* Allocated non host cached memory, honour it. */
 +		vma->vm_page_prot = pgprot_noncached(vma->vm_page_prot);
 +	}
 +
@@ -74752,6 +75031,22 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	vcsm_vma_open(vma);
 +	resource->res_stats[MAP]++;
 +	vmcs_sm_release_resource(resource, 0);
++
++	if (resource->map) {
++		/* We don't use vmf->pgoff since that has the fake offset */
++		unsigned long addr;
++
++		for (addr = vma->vm_start; addr < vma->vm_end; addr += PAGE_SIZE) {
++			/* Finally, remap it */
++			unsigned long pfn = (unsigned long)resource->res_base_mem & 0x3FFFFFFF;
++
++			pfn += mm_vc_mem_phys_addr;
++			pfn += addr - vma->vm_start;
++			pfn >>= PAGE_SHIFT;
++			ret = vm_insert_pfn(vma, addr, pfn);
++		}
++	}
++
 +	return 0;
 +
 +error:
@@ -74760,20 +75055,27 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Allocate a shared memory handle and block.
-+*/
-+int vc_sm_ioctl_alloc(struct SM_PRIV_DATA_T *private,
++/* Allocate a shared memory handle and block. */
++int vc_sm_ioctl_alloc(struct sm_priv_data_t *private,
 +		      struct vmcs_sm_ioctl_alloc *ioparam)
 +{
 +	int ret = 0;
 +	int status;
-+	struct SM_RESOURCE_T *resource;
-+	VC_SM_ALLOC_T alloc = { 0 };
-+	VC_SM_ALLOC_RESULT_T result = { 0 };
++	struct sm_resource_t *resource;
++	struct vc_sm_alloc_t alloc = { 0 };
++	struct vc_sm_alloc_result_t result = { 0 };
++	enum vmcs_sm_cache_e cached = ioparam->cached;
++	bool map = false;
++
++	/* flag to requst buffer is mapped up front, rather than lazily */
++	if (cached & 0x80) {
++		map = true;
++		cached &= ~0x80;
++	}
 +
 +	/* Setup our allocation parameters */
-+	alloc.type = ((ioparam->cached == VMCS_SM_CACHE_VC)
-+		      || (ioparam->cached ==
++	alloc.type = ((cached == VMCS_SM_CACHE_VC)
++		      || (cached ==
 +			  VMCS_SM_CACHE_BOTH)) ? VC_SM_ALLOC_CACHED :
 +	    VC_SM_ALLOC_NON_CACHED;
 +	alloc.base_unit = ioparam->size;
@@ -74795,8 +75097,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		__func__, alloc.name, alloc.type, ioparam->size,
 +		alloc.base_unit, alloc.num_unit, alloc.alignement);
 +
-+	/* Allocate local resource to track this allocation.
-+	 */
++	/* Allocate local resource to track this allocation. */
 +	resource = kzalloc(sizeof(*resource), GFP_KERNEL);
 +	if (!resource) {
 +		ret = -ENOMEM;
@@ -74806,8 +75107,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	resource->ref_count++;
 +	resource->pid = current->tgid;
 +
-+	/* Allocate the videocore resource.
-+	 */
++	/* Allocate the videocore resource. */
 +	status = vc_vchi_sm_alloc(sm_state->sm_handle, &alloc, &result,
 +				  &private->int_trans_id);
 +	if (status == -EINTR) {
@@ -74817,7 +75117,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		private->restart_sys = -EINTR;
 +		private->int_action = VC_SM_MSG_TYPE_ALLOC;
 +		goto error;
-+	} else if (status != 0 || (status == 0 && result.res_mem == NULL)) {
++	} else if (status != 0 || !result.res_mem) {
 +		pr_err("[%s]: failed to allocate memory on videocore (status: %u, trans_id: %u)\n",
 +		     __func__, status, private->int_trans_id);
 +		ret = -ENOMEM;
@@ -74825,15 +75125,16 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto error;
 +	}
 +
-+	/* Keep track of the resource we created.
-+	 */
++	/* Keep track of the resource we created. */
 +	resource->private = private;
 +	resource->res_handle = result.res_handle;
-+	resource->res_base_mem = result.res_mem;
++	resource->res_base_mem = (void *)result.res_mem;
 +	resource->res_size = alloc.base_unit * alloc.num_unit;
-+	resource->res_cached = ioparam->cached;
++	resource->res_cached = cached;
++	resource->map = map;
 +
-+	/* Kernel/user GUID.  This global identifier is used for mmap'ing the
++	/*
++	 * Kernel/user GUID.  This global identifier is used for mmap'ing the
 +	 * allocated region from user space, it is passed as the mmap'ing
 +	 * offset, we use it to 'hide' the videocore handle/address.
 +	 */
@@ -74865,12 +75166,11 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Share an allocate memory handle and block.
-+*/
-+int vc_sm_ioctl_alloc_share(struct SM_PRIV_DATA_T *private,
++/* Share an allocate memory handle and block.*/
++int vc_sm_ioctl_alloc_share(struct sm_priv_data_t *private,
 +			    struct vmcs_sm_ioctl_alloc_share *ioparam)
 +{
-+	struct SM_RESOURCE_T *resource, *shared_resource;
++	struct sm_resource_t *resource, *shared_resource;
 +	int ret = 0;
 +
 +	pr_debug("[%s]: attempt to share resource %u\n", __func__,
@@ -74882,8 +75182,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto error;
 +	}
 +
-+	/* Allocate local resource to track this allocation.
-+	 */
++	/* Allocate local resource to track this allocation. */
 +	resource = kzalloc(sizeof(*resource), GFP_KERNEL);
 +	if (resource == NULL) {
 +		pr_err("[%s]: failed to allocate local tracking resource\n",
@@ -74895,8 +75194,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	resource->ref_count++;
 +	resource->pid = current->tgid;
 +
-+	/* Keep track of the resource we created.
-+	 */
++	/* Keep track of the resource we created. */
 +	resource->private = private;
 +	resource->res_handle = shared_resource->res_handle;
 +	resource->res_base_mem = shared_resource->res_base_mem;
@@ -74930,12 +75228,11 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Free a previously allocated shared memory handle and block.
-+*/
-+static int vc_sm_ioctl_free(struct SM_PRIV_DATA_T *private,
++/* Free a previously allocated shared memory handle and block.*/
++static int vc_sm_ioctl_free(struct sm_priv_data_t *private,
 +			    struct vmcs_sm_ioctl_free *ioparam)
 +{
-+	struct SM_RESOURCE_T *resource =
++	struct sm_resource_t *resource =
 +	    vmcs_sm_acquire_resource(private, ioparam->handle);
 +
 +	if (resource == NULL) {
@@ -74944,8 +75241,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		return -EINVAL;
 +	}
 +
-+	/* Check permissions.
-+	 */
++	/* Check permissions. */
 +	if (resource->pid && (resource->pid != current->tgid)) {
 +		pr_err("[%s]: current tgid %u != %u owner\n",
 +			__func__, current->tgid, resource->pid);
@@ -74958,18 +75254,16 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return 0;
 +}
 +
-+/* Resize a previously allocated shared memory handle and block.
-+*/
-+static int vc_sm_ioctl_resize(struct SM_PRIV_DATA_T *private,
++/* Resize a previously allocated shared memory handle and block. */
++static int vc_sm_ioctl_resize(struct sm_priv_data_t *private,
 +			      struct vmcs_sm_ioctl_resize *ioparam)
 +{
 +	int ret = 0;
 +	int status;
-+	VC_SM_RESIZE_T resize;
-+	struct SM_RESOURCE_T *resource;
++	struct vc_sm_resize_t resize;
++	struct sm_resource_t *resource;
 +
-+	/* Locate resource from GUID.
-+	 */
++	/* Locate resource from GUID. */
 +	resource = vmcs_sm_acquire_resource(private, ioparam->handle);
 +	if (!resource) {
 +		pr_err("[%s]: failed resource - guid %x\n",
@@ -74978,9 +75272,10 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto error;
 +	}
 +
-+	/* If the resource is locked, its reference count will be not NULL,
-+	 ** in which case we will not be allowed to resize it anyways, so
-+	 ** reject the attempt here.
++	/*
++	 * If the resource is locked, its reference count will be not NULL,
++	 * in which case we will not be allowed to resize it anyways, so
++	 * reject the attempt here.
 +	 */
 +	if (resource->lock_count != 0) {
 +		pr_err("[%s]: cannot resize - guid %x, ref-cnt %d\n",
@@ -74989,8 +75284,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto error;
 +	}
 +
-+	/* Check permissions.
-+	 */
++	/* Check permissions. */
 +	if (resource->pid && (resource->pid != current->tgid)) {
 +		pr_err("[%s]: current tgid %u != %u owner\n", __func__,
 +				current->tgid, resource->pid);
@@ -75006,14 +75300,14 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	}
 +
 +	resize.res_handle = resource->res_handle;
-+	resize.res_mem = resource->res_base_mem;
++	resize.res_mem = (uint32_t)resource->res_base_mem;
 +	resize.res_new_size = ioparam->new_size;
 +
 +	pr_debug("[%s]: attempt to resize data - guid %x, hdl %x, base address %p\n",
-+		__func__, ioparam->handle, resize.res_handle, resize.res_mem);
++		__func__, ioparam->handle, resize.res_handle,
++		(void *)resize.res_mem);
 +
-+	/* Resize the videocore allocated resource.
-+	 */
++	/* Resize the videocore allocated resource. */
 +	status = vc_vchi_sm_resize(sm_state->sm_handle, &resize,
 +				   &private->int_trans_id);
 +	if (status == -EINTR) {
@@ -75023,7 +75317,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		private->restart_sys = -EINTR;
 +		private->int_action = VC_SM_MSG_TYPE_RESIZE;
 +		goto error;
-+	} else if (status != 0) {
++	} else if (status) {
 +		pr_err("[%s]: failed to resize memory on videocore (status: %u, trans_id: %u)\n",
 +		     __func__, status, private->int_trans_id);
 +		ret = -EPERM;
@@ -75034,8 +75328,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		__func__, resize.res_handle, resource->res_size,
 +		resize.res_new_size);
 +
-+	/* Successfully resized, save the information and inform the user.
-+	 */
++	/* Successfully resized, save the information and inform the user. */
 +	ioparam->old_size = resource->res_size;
 +	resource->res_size = resize.res_new_size;
 +
@@ -75046,33 +75339,30 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Lock a previously allocated shared memory handle and block.
-+*/
-+static int vc_sm_ioctl_lock(struct SM_PRIV_DATA_T *private,
++/* Lock a previously allocated shared memory handle and block. */
++static int vc_sm_ioctl_lock(struct sm_priv_data_t *private,
 +			    struct vmcs_sm_ioctl_lock_unlock *ioparam,
 +			    int change_cache, enum vmcs_sm_cache_e cache_type,
 +			    unsigned int vc_addr)
 +{
 +	int status;
-+	VC_SM_LOCK_UNLOCK_T lock;
-+	VC_SM_LOCK_RESULT_T result;
-+	struct SM_RESOURCE_T *resource;
++	struct vc_sm_lock_unlock_t lock;
++	struct vc_sm_lock_result_t result;
++	struct sm_resource_t *resource;
 +	int ret = 0;
 +	struct sm_mmap *map, *map_tmp;
-+	long unsigned int phys_addr;
++	unsigned long phys_addr;
 +
 +	map = NULL;
 +
-+	/* Locate resource from GUID.
-+	 */
++	/* Locate resource from GUID. */
 +	resource = vmcs_sm_acquire_resource(private, ioparam->handle);
 +	if (resource == NULL) {
 +		ret = -EINVAL;
 +		goto error;
 +	}
 +
-+	/* Check permissions.
-+	 */
++	/* Check permissions. */
 +	if (resource->pid && (resource->pid != current->tgid)) {
 +		pr_err("[%s]: current tgid %u != %u owner\n", __func__,
 +				current->tgid, resource->pid);
@@ -75081,17 +75371,15 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	}
 +
 +	lock.res_handle = resource->res_handle;
-+	lock.res_mem = resource->res_base_mem;
++	lock.res_mem = (uint32_t)resource->res_base_mem;
 +
-+	/* Take the lock and get the address to be mapped.
-+	 */
++	/* Take the lock and get the address to be mapped. */
 +	if (vc_addr == 0) {
 +		pr_debug("[%s]: attempt to lock data - guid %x, hdl %x, base address %p\n",
 +			__func__, ioparam->handle, lock.res_handle,
-+			lock.res_mem);
++			(void *)lock.res_mem);
 +
-+		/* Lock the videocore allocated resource.
-+		 */
++		/* Lock the videocore allocated resource. */
 +		status = vc_vchi_sm_lock(sm_state->sm_handle, &lock, &result,
 +					 &private->int_trans_id);
 +		if (status == -EINTR) {
@@ -75101,8 +75389,8 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +			private->restart_sys = -EINTR;
 +			private->int_action = VC_SM_MSG_TYPE_LOCK;
 +			goto error;
-+		} else if (status != 0 ||
-+			   (status == 0 && result.res_mem == NULL)) {
++		} else if (status ||
++			   (!status && !(void *)result.res_mem)) {
 +			pr_err("[%s]: failed to lock memory on videocore (status: %u, trans_id: %u)\n",
 +			     __func__, status, private->int_trans_id);
 +			ret = -EPERM;
@@ -75111,27 +75399,24 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		}
 +
 +		pr_debug("[%s]: succeed to lock data - hdl %x, base address %p (%p), ref-cnt %d\n",
-+			__func__, lock.res_handle, result.res_mem,
-+			lock.res_mem, resource->lock_count);
++			__func__, lock.res_handle, (void *)result.res_mem,
++			(void *)lock.res_mem, resource->lock_count);
 +	}
-+	/* Lock assumed taken already, address to be mapped is known.
-+	 */
++	/* Lock assumed taken already, address to be mapped is known. */
 +	else
 +		resource->res_base_mem = (void *)vc_addr;
 +
 +	resource->res_stats[LOCK]++;
 +	resource->lock_count++;
 +
-+	/* Keep track of the new base memory allocation if it has changed.
-+	 */
++	/* Keep track of the new base memory allocation if it has changed. */
 +	if ((vc_addr == 0) &&
-+	    (result.res_mem != NULL) &&
-+	    (result.res_old_mem != NULL) &&
++	    ((void *)result.res_mem) &&
++	    ((void *)result.res_old_mem) &&
 +	    (result.res_mem != result.res_old_mem)) {
-+		resource->res_base_mem = result.res_mem;
++		resource->res_base_mem = (void *)result.res_mem;
 +
-+		/* Kernel allocated resources.
-+		 */
++		/* Kernel allocated resources. */
 +		if (resource->pid == 0) {
 +			if (!list_empty(&resource->map_list)) {
 +				list_for_each_entry_safe(map, map_tmp,
@@ -75163,8 +75448,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +			__func__, resource->map_count, private->pid,
 +			current->tgid, ioparam->handle, ioparam->addr);
 +	} else {
-+		/* Kernel allocated resources.
-+		 */
++		/* Kernel allocated resources. */
 +		if (resource->pid == 0) {
 +			pr_debug("[%s]: attempt mapping kernel resource - guid %x, hdl %x\n",
 +				__func__, ioparam->handle, lock.res_handle);
@@ -75183,7 +75467,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				phys_addr += mm_vc_mem_phys_addr;
 +				if (resource->res_cached
 +						== VMCS_SM_CACHE_HOST) {
-+					ioparam->addr = (long unsigned int)
++					ioparam->addr = (unsigned long)
 +					/* TODO - make cached work */
 +					    ioremap_nocache(phys_addr,
 +							   resource->res_size);
@@ -75192,7 +75476,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +						__func__, ioparam->handle,
 +						lock.res_handle, ioparam->addr);
 +				} else {
-+					ioparam->addr = (long unsigned int)
++					ioparam->addr = (unsigned long)
 +					    ioremap_nocache(phys_addr,
 +							    resource->res_size);
 +
@@ -75221,30 +75505,27 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Unlock a previously allocated shared memory handle and block.
-+*/
-+static int vc_sm_ioctl_unlock(struct SM_PRIV_DATA_T *private,
++/* Unlock a previously allocated shared memory handle and block.*/
++static int vc_sm_ioctl_unlock(struct sm_priv_data_t *private,
 +			      struct vmcs_sm_ioctl_lock_unlock *ioparam,
 +			      int flush, int wait_reply, int no_vc_unlock)
 +{
 +	int status;
-+	VC_SM_LOCK_UNLOCK_T unlock;
++	struct vc_sm_lock_unlock_t unlock;
 +	struct sm_mmap *map, *map_tmp;
-+	struct SM_RESOURCE_T *resource;
++	struct sm_resource_t *resource;
 +	int ret = 0;
 +
 +	map = NULL;
 +
-+	/* Locate resource from GUID.
-+	 */
++	/* Locate resource from GUID. */
 +	resource = vmcs_sm_acquire_resource(private, ioparam->handle);
 +	if (resource == NULL) {
 +		ret = -EINVAL;
 +		goto error;
 +	}
 +
-+	/* Check permissions.
-+	 */
++	/* Check permissions. */
 +	if (resource->pid && (resource->pid != current->tgid)) {
 +		pr_err("[%s]: current tgid %u != %u owner\n",
 +			__func__, current->tgid, resource->pid);
@@ -75253,17 +75534,18 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	}
 +
 +	unlock.res_handle = resource->res_handle;
-+	unlock.res_mem = resource->res_base_mem;
++	unlock.res_mem = (uint32_t)resource->res_base_mem;
 +
 +	pr_debug("[%s]: attempt to unlock data - guid %x, hdl %x, base address %p\n",
-+		__func__, ioparam->handle, unlock.res_handle, unlock.res_mem);
++		__func__, ioparam->handle, unlock.res_handle,
++		(void *)unlock.res_mem);
 +
-+	/* User space allocated resources.
-+	 */
++	/* User space allocated resources. */
 +	if (resource->pid) {
 +		/* Flush if requested */
 +		if (resource->res_cached && flush) {
 +			dma_addr_t phys_addr = 0;
++
 +			resource->res_stats[FLUSH]++;
 +
 +			phys_addr =
@@ -75278,6 +75560,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				if (map->vma) {
 +					unsigned long start;
 +					unsigned long end;
++
 +					start = map->vma->vm_start;
 +					end = map->vma->vm_end;
 +
@@ -75320,7 +75603,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +						if (flush &&
 +								(resource->res_cached ==
 +									VMCS_SM_CACHE_HOST)) {
-+							long unsigned int
++							unsigned long
 +								phys_addr;
 +							phys_addr = (uint32_t)
 +								resource->res_base_mem & 0x3FFFFFFF;
@@ -75356,12 +75639,10 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	}
 +
 +	if (resource->lock_count) {
-+		/* Bypass the videocore unlock.
-+		 */
++		/* Bypass the videocore unlock. */
 +		if (no_vc_unlock)
 +			status = 0;
-+		/* Unlock the videocore allocated resource.
-+		 */
++		/* Unlock the videocore allocated resource. */
 +		else {
 +			status =
 +			    vc_vchi_sm_unlock(sm_state->sm_handle, &unlock,
@@ -75391,7 +75672,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	}
 +
 +	pr_debug("[%s]: success to unlock data - hdl %x, base address %p, ref-cnt %d\n",
-+		__func__, unlock.res_handle, unlock.res_mem,
++		__func__, unlock.res_handle, (void *)unlock.res_mem,
 +		resource->lock_count);
 +
 +error:
@@ -75401,14 +75682,143 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
++/* Import a contiguous block of memory to be shared with VC. */
++int vc_sm_ioctl_import_dmabuf(struct sm_priv_data_t *private,
++			      struct vmcs_sm_ioctl_import_dmabuf *ioparam,
++			      struct dma_buf *src_dma_buf)
++{
++	int ret = 0;
++	int status;
++	struct sm_resource_t *resource = NULL;
++	struct vc_sm_import import = { 0 };
++	struct vc_sm_import_result result = { 0 };
++	struct dma_buf *dma_buf;
++	struct dma_buf_attachment *attach = NULL;
++	struct sg_table *sgt = NULL;
++
++	/* Setup our allocation parameters */
++	if (src_dma_buf) {
++		get_dma_buf(src_dma_buf);
++		dma_buf = src_dma_buf;
++	} else {
++		dma_buf = dma_buf_get(ioparam->dmabuf_fd);
++	}
++	if (IS_ERR(dma_buf))
++		return PTR_ERR(dma_buf);
++
++	attach = dma_buf_attach(dma_buf, &sm_state->pdev->dev);
++	if (IS_ERR(attach)) {
++		ret = PTR_ERR(attach);
++		goto error;
++	}
++
++	sgt = dma_buf_map_attachment(attach, DMA_BIDIRECTIONAL);
++	if (IS_ERR(sgt)) {
++		ret = PTR_ERR(sgt);
++		goto error;
++	}
++
++	/* Verify that the address block is contiguous */
++	if (sgt->nents != 1) {
++		ret = -ENOMEM;
++		goto error;
++	}
++
++	import.type = ((ioparam->cached == VMCS_SM_CACHE_VC) ||
++		       (ioparam->cached == VMCS_SM_CACHE_BOTH)) ?
++				VC_SM_ALLOC_CACHED : VC_SM_ALLOC_NON_CACHED;
++	import.addr = (uint32_t)sg_dma_address(sgt->sgl);
++	import.size = sg_dma_len(sgt->sgl);
++	import.allocator = current->tgid;
++
++	if (*ioparam->name)
++		memcpy(import.name, ioparam->name, sizeof(import.name) - 1);
++	else
++		memcpy(import.name, VMCS_SM_RESOURCE_NAME_DEFAULT,
++		       sizeof(VMCS_SM_RESOURCE_NAME_DEFAULT));
++
++	pr_debug("[%s]: attempt to import \"%s\" data - type %u, addr %p, size %u\n",
++		 __func__, import.name, import.type,
++		 (void *)import.addr, import.size);
++
++	/* Allocate local resource to track this allocation. */
++	resource = kzalloc(sizeof(*resource), GFP_KERNEL);
++	if (!resource) {
++		ret = -ENOMEM;
++		goto error;
++	}
++	INIT_LIST_HEAD(&resource->map_list);
++	resource->ref_count++;
++	resource->pid = current->tgid;
++
++	/* Allocate the videocore resource. */
++	status = vc_vchi_sm_import(sm_state->sm_handle, &import, &result,
++				   &private->int_trans_id);
++	if (status == -EINTR) {
++		pr_debug("[%s]: requesting import memory action restart (trans_id: %u)\n",
++			 __func__, private->int_trans_id);
++		ret = -ERESTARTSYS;
++		private->restart_sys = -EINTR;
++		private->int_action = VC_SM_MSG_TYPE_IMPORT;
++		goto error;
++	} else if (status || !result.res_handle) {
++		pr_debug("[%s]: failed to import memory on videocore (status: %u, trans_id: %u)\n",
++			 __func__, status, private->int_trans_id);
++		ret = -ENOMEM;
++		resource->res_stats[ALLOC_FAIL]++;
++		goto error;
++	}
++
++	/* Keep track of the resource we created. */
++	resource->private = private;
++	resource->res_handle = result.res_handle;
++	resource->res_size = import.size;
++	resource->res_cached = ioparam->cached;
++
++	resource->dma_buf = dma_buf;
++	resource->attach = attach;
++	resource->sgt = sgt;
++	resource->dma_addr = sg_dma_address(sgt->sgl);
++
++	/*
++	 * Kernel/user GUID.  This global identifier is used for mmap'ing the
++	 * allocated region from user space, it is passed as the mmap'ing
++	 * offset, we use it to 'hide' the videocore handle/address.
++	 */
++	mutex_lock(&sm_state->lock);
++	resource->res_guid = ++sm_state->guid;
++	mutex_unlock(&sm_state->lock);
++	resource->res_guid <<= PAGE_SHIFT;
++
++	vmcs_sm_add_resource(private, resource);
++
++	/* We're done */
++	resource->res_stats[IMPORT]++;
++	ioparam->handle = resource->res_guid;
++	return 0;
++
++error:
++	resource->res_stats[IMPORT_FAIL]++;
++	if (resource) {
++		vc_sm_resource_deceased(resource, 1);
++		kfree(resource);
++	}
++	if (sgt)
++		dma_buf_unmap_attachment(attach, sgt, DMA_BIDIRECTIONAL);
++	if (attach)
++		dma_buf_detach(dma_buf, attach);
++	dma_buf_put(dma_buf);
++	return ret;
++}
++
 +/* Handle control from host. */
 +static long vc_sm_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
 +{
 +	int ret = 0;
 +	unsigned int cmdnr = _IOC_NR(cmd);
-+	struct SM_PRIV_DATA_T *file_data =
-+	    (struct SM_PRIV_DATA_T *)file->private_data;
-+	struct SM_RESOURCE_T *resource = NULL;
++	struct sm_priv_data_t *file_data =
++	    (struct sm_priv_data_t *)file->private_data;
++	struct sm_resource_t *resource = NULL;
 +
 +	/* Validate we can work with this device. */
 +	if ((sm_state == NULL) || (file_data == NULL)) {
@@ -75422,7 +75832,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	/* Action is a re-post of a previously interrupted action? */
 +	if (file_data->restart_sys == -EINTR) {
-+		VC_SM_ACTION_CLEAN_T action_clean;
++		struct vc_sm_action_clean_t action_clean;
 +
 +		pr_debug("[%s]: clean up of action %u (trans_id: %u) following EINTR\n",
 +			__func__, file_data->int_action,
@@ -75436,8 +75846,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		file_data->restart_sys = 0;
 +	}
 +
-+	/* Now process the command.
-+	 */
++	/* Now process the command. */
 +	switch (cmdnr) {
 +		/* New memory allocation.
 +		 */
@@ -75445,8 +75854,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		{
 +			struct vmcs_sm_ioctl_alloc ioparam;
 +
-+			/* Get the parameter data.
-+			 */
++			/* Get the parameter data. */
 +			if (copy_from_user
 +			    (&ioparam, (void *)arg, sizeof(ioparam)) != 0) {
 +				pr_err("[%s]: failed to copy-from-user for cmd %x\n",
@@ -75468,20 +75876,17 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				ret = -EFAULT;
 +			}
 +
-+			/* Done.
-+			 */
++			/* Done. */
 +			goto out;
 +		}
 +		break;
 +
-+		/* Share existing memory allocation.
-+		 */
++		/* Share existing memory allocation. */
 +	case VMCS_SM_CMD_ALLOC_SHARE:
 +		{
 +			struct vmcs_sm_ioctl_alloc_share ioparam;
 +
-+			/* Get the parameter data.
-+			 */
++			/* Get the parameter data. */
 +			if (copy_from_user
 +			    (&ioparam, (void *)arg, sizeof(ioparam)) != 0) {
 +				pr_err("[%s]: failed to copy-from-user for cmd %x\n",
@@ -75492,8 +75897,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +			ret = vc_sm_ioctl_alloc_share(file_data, &ioparam);
 +
-+			/* Copy result back to user.
-+			 */
++			/* Copy result back to user. */
 +			if (!ret
 +			    && copy_to_user((void *)arg, &ioparam,
 +					    sizeof(ioparam)) != 0) {
@@ -75506,21 +75910,50 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				ret = -EFAULT;
 +			}
 +
-+			/* Done.
-+			 */
++			/* Done. */
 +			goto out;
 +		}
 +		break;
 +
-+		/* Lock (attempt to) *and* register a cache behavior change.
-+		 */
++	case VMCS_SM_CMD_IMPORT_DMABUF:
++		{
++			struct vmcs_sm_ioctl_import_dmabuf ioparam;
++
++			/* Get the parameter data. */
++			if (copy_from_user
++			    (&ioparam, (void *)arg, sizeof(ioparam)) != 0) {
++				pr_err("[%s]: failed to copy-from-user for cmd %x\n",
++				       __func__, cmdnr);
++				ret = -EFAULT;
++				goto out;
++			}
++
++			ret = vc_sm_ioctl_import_dmabuf(file_data, &ioparam,
++							NULL);
++			if (!ret &&
++			    (copy_to_user((void *)arg,
++					  &ioparam, sizeof(ioparam)) != 0)) {
++				struct vmcs_sm_ioctl_free freeparam = {
++					ioparam.handle
++				};
++				pr_err("[%s]: failed to copy-to-user for cmd %x\n",
++				       __func__, cmdnr);
++				vc_sm_ioctl_free(file_data, &freeparam);
++				ret = -EFAULT;
++			}
++
++			/* Done. */
++			goto out;
++		}
++		break;
++
++		/* Lock (attempt to) *and* register a cache behavior change. */
 +	case VMCS_SM_CMD_LOCK_CACHE:
 +		{
 +			struct vmcs_sm_ioctl_lock_cache ioparam;
 +			struct vmcs_sm_ioctl_lock_unlock lock;
 +
-+			/* Get parameter data.
-+			 */
++			/* Get parameter data. */
 +			if (copy_from_user
 +			    (&ioparam, (void *)arg, sizeof(ioparam)) != 0) {
 +				pr_err("[%s]: failed to copy-from-user for cmd %x\n",
@@ -75534,20 +75967,17 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +			    vc_sm_ioctl_lock(file_data, &lock, 1,
 +					     ioparam.cached, 0);
 +
-+			/* Done.
-+			 */
++			/* Done. */
 +			goto out;
 +		}
 +		break;
 +
-+		/* Lock (attempt to) existing memory allocation.
-+		 */
++		/* Lock (attempt to) existing memory allocation. */
 +	case VMCS_SM_CMD_LOCK:
 +		{
 +			struct vmcs_sm_ioctl_lock_unlock ioparam;
 +
-+			/* Get parameter data.
-+			 */
++			/* Get parameter data. */
 +			if (copy_from_user
 +			    (&ioparam, (void *)arg, sizeof(ioparam)) != 0) {
 +				pr_err("[%s]: failed to copy-from-user for cmd %x\n",
@@ -75558,8 +75988,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +			ret = vc_sm_ioctl_lock(file_data, &ioparam, 0, 0, 0);
 +
-+			/* Copy result back to user.
-+			 */
++			/* Copy result back to user. */
 +			if (copy_to_user((void *)arg, &ioparam, sizeof(ioparam))
 +			    != 0) {
 +				pr_err("[%s]: failed to copy-to-user for cmd %x\n",
@@ -75567,20 +75996,17 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				ret = -EFAULT;
 +			}
 +
-+			/* Done.
-+			 */
++			/* Done. */
 +			goto out;
 +		}
 +		break;
 +
-+		/* Unlock (attempt to) existing memory allocation.
-+		 */
++		/* Unlock (attempt to) existing memory allocation. */
 +	case VMCS_SM_CMD_UNLOCK:
 +		{
 +			struct vmcs_sm_ioctl_lock_unlock ioparam;
 +
-+			/* Get parameter data.
-+			 */
++			/* Get parameter data. */
 +			if (copy_from_user
 +			    (&ioparam, (void *)arg, sizeof(ioparam)) != 0) {
 +				pr_err("[%s]: failed to copy-from-user for cmd %x\n",
@@ -75591,20 +76017,17 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +			ret = vc_sm_ioctl_unlock(file_data, &ioparam, 0, 1, 0);
 +
-+			/* Done.
-+			 */
++			/* Done. */
 +			goto out;
 +		}
 +		break;
 +
-+		/* Resize (attempt to) existing memory allocation.
-+		 */
++		/* Resize (attempt to) existing memory allocation. */
 +	case VMCS_SM_CMD_RESIZE:
 +		{
 +			struct vmcs_sm_ioctl_resize ioparam;
 +
-+			/* Get parameter data.
-+			 */
++			/* Get parameter data. */
 +			if (copy_from_user
 +			    (&ioparam, (void *)arg, sizeof(ioparam)) != 0) {
 +				pr_err("[%s]: failed to copy-from-user for cmd %x\n",
@@ -75615,17 +76038,13 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +			ret = vc_sm_ioctl_resize(file_data, &ioparam);
 +
-+			/* Copy result back to user.
-+			 */
++			/* Copy result back to user. */
 +			if (copy_to_user((void *)arg, &ioparam, sizeof(ioparam))
 +			    != 0) {
 +				pr_err("[%s]: failed to copy-to-user for cmd %x\n",
 +				     __func__, cmdnr);
 +				ret = -EFAULT;
 +			}
-+
-+			/* Done.
-+			 */
 +			goto out;
 +		}
 +		break;
@@ -75670,7 +76089,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +			goto out;
 +		}
 +		break;
-+/* Walk mapping table on host, information shows up in the
++		/* Walk mapping table on host, information shows up in the
 +		 ** kernel log.
 +		 */
 +	case VMCS_SM_CMD_HOST_WALK_MAP:
@@ -75709,7 +76128,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		{
 +			struct vmcs_sm_ioctl_walk ioparam;
 +
-+			/* Get parameter data.  */
++			/* Get parameter data. */
 +			if (copy_from_user(&ioparam,
 +					   (void *)arg, sizeof(ioparam)) != 0) {
 +				pr_err("[%s]: failed to copy-from-user for cmd %x\n",
@@ -75766,8 +76185,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		{
 +			struct vmcs_sm_ioctl_chk ioparam;
 +
-+			/* Get parameter data.
-+			 */
++			/* Get parameter data. */
 +			if (copy_from_user(&ioparam,
 +					   (void *)arg, sizeof(ioparam)) != 0) {
 +				pr_err("[%s]: failed to copy-from-user for cmd %x\n",
@@ -75782,7 +76200,8 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +			    vmcs_sm_acquire_resource(file_data, ioparam.handle);
 +			if (resource == NULL)
 +				ret = -EINVAL;
-+			/* If the resource is cacheable, return additional
++			/*
++			 * If the resource is cacheable, return additional
 +			 * information that may be needed to flush the cache.
 +			 */
 +			else if ((resource->res_cached == VMCS_SM_CACHE_HOST) ||
@@ -75808,8 +76227,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				ret = -EFAULT;
 +			}
 +
-+			/* Done.
-+			 */
++			/* Done. */
 +			goto out;
 +		}
 +		break;
@@ -75888,8 +76306,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				ret = -EFAULT;
 +			}
 +
-+			/* Done.
-+			 */
++			/* Done. */
 +			goto out;
 +		}
 +		break;
@@ -75971,8 +76388,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		}
 +		break;
 +
-+		/* Maps a user address given process and vc handle.
-+		 */
++		/* Maps a user address given process and vc handle. */
 +	case VMCS_SM_CMD_MAPPED_USR_ADDRESS:
 +		{
 +			struct vmcs_sm_ioctl_map ioparam;
@@ -76075,8 +76491,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				goto out;
 +			}
 +
-+			/* Locate resource from GUID.
-+			 */
++			/* Locate resource from GUID. */
 +			resource =
 +			    vmcs_sm_acquire_resource(file_data, ioparam.handle);
 +
@@ -76112,8 +76527,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +			if (resource)
 +				vmcs_sm_release_resource(resource, 0);
 +
-+			/* Done.
-+			 */
++			/* Done. */
 +			goto out;
 +		}
 +		break;
@@ -76132,40 +76546,92 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +				ret = -EFAULT;
 +				goto out;
 +			}
-+			for (i=0; i<sizeof ioparam.s/sizeof *ioparam.s; i++) {
++			for (i = 0; i < sizeof(ioparam.s) / sizeof(*ioparam.s); i++) {
 +				switch (ioparam.s[i].cmd) {
-+					default: case 0: break; /* NOOP */
-+					case 1:	/* L1/L2 invalidate virtual range */
-+					case 2: /* L1/L2 clean physical range */
-+					case 3: /* L1/L2 clean+invalidate all */
-+					{
-+						/* Locate resource from GUID.
-+						 */
-+						resource =
-+						    vmcs_sm_acquire_resource(file_data, ioparam.s[i].handle);
-+
-+						if ((resource != NULL) && resource->res_cached) {
-+							unsigned long base = ioparam.s[i].addr & ~(PAGE_SIZE-1);
-+							unsigned long end = (ioparam.s[i].addr + ioparam.s[i].size + PAGE_SIZE-1) & ~(PAGE_SIZE-1);
-+							resource->res_stats[ioparam.s[i].cmd == 1 ? INVALID:FLUSH]++;
-+
-+							/* L1/L2 cache flush */
-+							down_read(&current->mm->mmap_sem);
-+							vcsm_vma_cache_clean_page_range(base, end);
-+							up_read(&current->mm->mmap_sem);
-+						} else if (resource == NULL) {
-+							ret = -EINVAL;
-+							goto out;
-+						}
-+
-+						if (resource)
-+							vmcs_sm_release_resource(resource, 0);
++				default:
++				case 0:
++					break; /* NOOP */
++				case 1:	/* L1/L2 invalidate virtual range */
++				case 2: /* L1/L2 clean physical range */
++				case 3: /* L1/L2 clean+invalidate all */
++					/* Locate resource from GUID. */
++					resource =
++					    vmcs_sm_acquire_resource(file_data, ioparam.s[i].handle);
++
++					if ((resource != NULL) && resource->res_cached) {
++						unsigned long base = ioparam.s[i].addr & ~(PAGE_SIZE - 1);
++						unsigned long end = (ioparam.s[i].addr + ioparam.s[i].size + PAGE_SIZE - 1) & ~(PAGE_SIZE - 1);
++
++						resource->res_stats[ioparam.s[i].cmd == 1 ? INVALID : FLUSH]++;
++
++						/* L1/L2 cache flush */
++						down_read(&current->mm->mmap_sem);
++						vcsm_vma_cache_clean_page_range(base, end);
++						up_read(&current->mm->mmap_sem);
++					} else if (resource == NULL) {
++						ret = -EINVAL;
++						goto out;
 +					}
++
++					if (resource)
++						vmcs_sm_release_resource(resource, 0);
++
 +					break;
 +				}
 +			}
 +		}
 +		break;
++	/* Flush/Invalidate the cache for a given mapping. */
++	case VMCS_SM_CMD_CLEAN_INVALID2:
++		{
++				int i, j;
++				struct vmcs_sm_ioctl_clean_invalid2 ioparam;
++				struct vmcs_sm_ioctl_clean_invalid_block *block = NULL;
++
++				/* Get parameter data. */
++				if (copy_from_user(&ioparam,
++						   (void *)arg, sizeof(ioparam)) != 0) {
++					pr_err("[%s]: failed to copy-from-user header for cmd %x\n",
++							__func__, cmdnr);
++					ret = -EFAULT;
++					goto out;
++				}
++				block = kmalloc(ioparam.op_count *
++						sizeof(struct vmcs_sm_ioctl_clean_invalid_block),
++						GFP_KERNEL);
++				if (!block) {
++					ret = -EFAULT;
++					goto out;
++				}
++				if (copy_from_user(block,
++						   (void *)(arg + sizeof(ioparam)), ioparam.op_count * sizeof(struct vmcs_sm_ioctl_clean_invalid_block)) != 0) {
++					pr_err("[%s]: failed to copy-from-user payload for cmd %x\n",
++							__func__, cmdnr);
++					ret = -EFAULT;
++					goto out;
++				}
++
++				for (i = 0; i < ioparam.op_count; i++) {
++					const struct vmcs_sm_ioctl_clean_invalid_block * const op = block + i;
++					cache_flush_op_fn * const op_fn = flushops[op->invalidate_mode & 3];
++
++					if ((op->invalidate_mode & ~3) != 0) {
++						ret = -EINVAL;
++						break;
++					}
++
++					if (op_fn == 0)
++						continue;
++
++					for (j = 0; j < op->block_count; ++j) {
++						const char * const base = (const char *)op->start_address + j * op->inter_block_stride;
++						const char * const end = base + op->block_size;
++						op_fn(base, end);
++					}
++				}
++				kfree(block);
++			}
++		break;
 +
 +	default:
 +		{
@@ -76179,8 +76645,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Device operations that we managed in this driver.
-+*/
++/* Device operations that we managed in this driver. */
 +static const struct file_operations vmcs_sm_ops = {
 +	.owner = THIS_MODULE,
 +	.unlocked_ioctl = vc_sm_ioctl,
@@ -76189,8 +76654,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	.mmap = vc_sm_mmap,
 +};
 +
-+/* Creation of device.
-+*/
++/* Creation of device. */
 +static int vc_sm_create_sharedmemory(void)
 +{
 +	int ret;
@@ -76200,8 +76664,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto out;
 +	}
 +
-+	/* Create a device class for creating dev nodes.
-+	 */
++	/* Create a device class for creating dev nodes. */
 +	sm_state->sm_class = class_create(THIS_MODULE, "vc-sm");
 +	if (IS_ERR(sm_state->sm_class)) {
 +		pr_err("[%s]: unable to create device class\n", __func__);
@@ -76209,8 +76672,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto out;
 +	}
 +
-+	/* Create a character driver.
-+	 */
++	/* Create a character driver. */
 +	ret = alloc_chrdev_region(&sm_state->sm_devid,
 +				  DEVICE_MINOR, 1, DEVICE_NAME);
 +	if (ret != 0) {
@@ -76225,8 +76687,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto out_chrdev_unreg;
 +	}
 +
-+	/* Create a device node.
-+	 */
++	/* Create a device node. */
 +	sm_state->sm_dev = device_create(sm_state->sm_class,
 +					 NULL,
 +					 MKDEV(MAJOR(sm_state->sm_devid),
@@ -76251,25 +76712,21 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +
-+/* Termination of the device.
-+*/
++/* Termination of the device. */
 +static int vc_sm_remove_sharedmemory(void)
 +{
 +	int ret;
 +
 +	if (sm_state == NULL) {
-+		/* Nothing to do.
-+		 */
++		/* Nothing to do. */
 +		ret = 0;
 +		goto out;
 +	}
 +
-+	/* Remove the sharedmemory character driver.
-+	 */
++	/* Remove the sharedmemory character driver. */
 +	cdev_del(&sm_state->sm_cdev);
 +
-+	/* Unregister region.
-+	 */
++	/* Unregister region. */
 +	unregister_chrdev_region(sm_state->sm_devid, 1);
 +
 +	ret = 0;
@@ -76288,20 +76745,9 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	pr_info("[%s]: start\n", __func__);
 +
-+	/* Allocate memory for the state structure.
-+	 */
-+	sm_state = kzalloc(sizeof(struct SM_STATE_T), GFP_KERNEL);
-+	if (sm_state == NULL) {
-+		pr_err("[%s]: failed to allocate memory\n", __func__);
-+		ret = -ENOMEM;
-+		goto out;
-+	}
-+
-+	mutex_init(&sm_state->lock);
-+	mutex_init(&sm_state->map_lock);
-+
-+	/* Initialize and create a VCHI connection for the shared memory service
-+	 ** running on videocore.
++	/*
++	 * Initialize and create a VCHI connection for the shared memory service
++	 * running on videocore.
 +	 */
 +	ret = vchi_initialise(&vchi_instance);
 +	if (ret != 0) {
@@ -76344,12 +76790,12 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +
 +	sm_state->dir_state.show = &vc_sm_global_state_show;
 +	sm_state->dir_state.dir_entry = debugfs_create_file(VC_SM_STATE,
-+			S_IRUGO, sm_state->dir_root, &sm_state->dir_state,
++			0444, sm_state->dir_root, &sm_state->dir_state,
 +			&vc_sm_debug_fs_fops);
 +
 +	sm_state->dir_stats.show = &vc_sm_global_statistics_show;
 +	sm_state->dir_stats.dir_entry = debugfs_create_file(VC_SM_STATS,
-+			S_IRUGO, sm_state->dir_root, &sm_state->dir_stats,
++			0444, sm_state->dir_root, &sm_state->dir_stats,
 +			&vc_sm_debug_fs_fops);
 +
 +	/* Create the proc entry children. */
@@ -76374,8 +76820,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +		goto err_remove_shared_memory;
 +	}
 +
-+	/* Done!
-+	 */
++	/* Done! */
 +	sm_inited = 1;
 +	goto out;
 +
@@ -76392,49 +76837,53 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +}
 +
 +/* Driver loading. */
-+static int __init vc_sm_init(void)
++static int bcm2835_vcsm_probe(struct platform_device *pdev)
 +{
 +	pr_info("vc-sm: Videocore shared memory driver\n");
++
++	sm_state = kzalloc(sizeof(*sm_state), GFP_KERNEL);
++	if (!sm_state)
++		return -ENOMEM;
++	sm_state->pdev = pdev;
++	mutex_init(&sm_state->lock);
++	mutex_init(&sm_state->map_lock);
++
 +	vchiq_add_connected_callback(vc_sm_connected_init);
 +	return 0;
 +}
 +
 +/* Driver unloading. */
-+static void __exit vc_sm_exit(void)
++static int bcm2835_vcsm_remove(struct platform_device *pdev)
 +{
 +	pr_debug("[%s]: start\n", __func__);
 +	if (sm_inited) {
-+		/* Remove shared memory device.
-+		 */
++		/* Remove shared memory device. */
 +		vc_sm_remove_sharedmemory();
 +
-+		/* Remove all proc entries.
-+		 */
++		/* Remove all proc entries. */
 +		debugfs_remove_recursive(sm_state->dir_root);
 +
-+		/* Stop the videocore shared memory service.
-+		 */
++		/* Stop the videocore shared memory service. */
 +		vc_vchi_sm_stop(&sm_state->sm_handle);
 +
-+		/* Free the memory for the state structure.
-+		 */
++		/* Free the memory for the state structure. */
 +		mutex_destroy(&(sm_state->map_lock));
 +		kfree(sm_state);
 +	}
 +
 +	pr_debug("[%s]: end\n", __func__);
++	return 0;
 +}
 +
 +#if defined(__KERNEL__)
 +/* Allocate a shared memory handle and block. */
-+int vc_sm_alloc(VC_SM_ALLOC_T *alloc, int *handle)
++int vc_sm_alloc(struct vc_sm_alloc_t *alloc, int *handle)
 +{
 +	struct vmcs_sm_ioctl_alloc ioparam = { 0 };
 +	int ret;
-+	struct SM_RESOURCE_T *resource;
++	struct sm_resource_t *resource;
 +
-+	/* Validate we can work with this device.
-+	 */
++	/* Validate we can work with this device. */
 +	if (sm_state == NULL || alloc == NULL || handle == NULL) {
 +		pr_err("[%s]: invalid input\n", __func__);
 +		return -EPERM;
@@ -76455,8 +76904,7 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +			resource->pid = 0;
 +			vmcs_sm_release_resource(resource, 0);
 +
-+			/* Assign valid handle at this time.
-+			 */
++			/* Assign valid handle at this time. */
 +			*handle = ioparam.handle;
 +		} else {
 +			ret = -ENOMEM;
@@ -76467,22 +76915,19 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +}
 +EXPORT_SYMBOL_GPL(vc_sm_alloc);
 +
-+/* Get an internal resource handle mapped from the external one.
-+*/
++/* Get an internal resource handle mapped from the external one. */
 +int vc_sm_int_handle(int handle)
 +{
-+	struct SM_RESOURCE_T *resource;
++	struct sm_resource_t *resource;
 +	int ret = 0;
 +
-+	/* Validate we can work with this device.
-+	 */
++	/* Validate we can work with this device. */
 +	if (sm_state == NULL || handle == 0) {
 +		pr_err("[%s]: invalid input\n", __func__);
 +		return 0;
 +	}
 +
-+	/* Locate resource from GUID.
-+	 */
++	/* Locate resource from GUID. */
 +	resource = vmcs_sm_acquire_resource(sm_state->data_knl, handle);
 +	if (resource) {
 +		ret = resource->res_handle;
@@ -76493,14 +76938,12 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +}
 +EXPORT_SYMBOL_GPL(vc_sm_int_handle);
 +
-+/* Free a previously allocated shared memory handle and block.
-+*/
++/* Free a previously allocated shared memory handle and block. */
 +int vc_sm_free(int handle)
 +{
 +	struct vmcs_sm_ioctl_free ioparam = { handle };
 +
-+	/* Validate we can work with this device.
-+	 */
++	/* Validate we can work with this device. */
 +	if (sm_state == NULL || handle == 0) {
 +		pr_err("[%s]: invalid input\n", __func__);
 +		return -EPERM;
@@ -76510,16 +76953,14 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +}
 +EXPORT_SYMBOL_GPL(vc_sm_free);
 +
-+/* Lock a memory handle for use by kernel.
-+*/
-+int vc_sm_lock(int handle, VC_SM_LOCK_CACHE_MODE_T mode,
-+	       long unsigned int *data)
++/* Lock a memory handle for use by kernel. */
++int vc_sm_lock(int handle, enum vc_sm_lock_cache_mode mode,
++	       unsigned long *data)
 +{
 +	struct vmcs_sm_ioctl_lock_unlock ioparam;
 +	int ret;
 +
-+	/* Validate we can work with this device.
-+	 */
++	/* Validate we can work with this device. */
 +	if (sm_state == NULL || handle == 0 || data == NULL) {
 +		pr_err("[%s]: invalid input\n", __func__);
 +		return -EPERM;
@@ -76540,14 +76981,12 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +}
 +EXPORT_SYMBOL_GPL(vc_sm_lock);
 +
-+/* Unlock a memory handle in use by kernel.
-+*/
++/* Unlock a memory handle in use by kernel. */
 +int vc_sm_unlock(int handle, int flush, int no_vc_unlock)
 +{
 +	struct vmcs_sm_ioctl_lock_unlock ioparam;
 +
-+	/* Validate we can work with this device.
-+	 */
++	/* Validate we can work with this device. */
 +	if (sm_state == NULL || handle == 0) {
 +		pr_err("[%s]: invalid input\n", __func__);
 +		return -EPERM;
@@ -76559,16 +76998,14 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +}
 +EXPORT_SYMBOL_GPL(vc_sm_unlock);
 +
-+/* Map a shared memory region for use by kernel.
-+*/
-+int vc_sm_map(int handle, unsigned int sm_addr, VC_SM_LOCK_CACHE_MODE_T mode,
-+	      long unsigned int *data)
++/* Map a shared memory region for use by kernel. */
++int vc_sm_map(int handle, unsigned int sm_addr,
++	      enum vc_sm_lock_cache_mode mode, unsigned long *data)
 +{
 +	struct vmcs_sm_ioctl_lock_unlock ioparam;
 +	int ret;
 +
-+	/* Validate we can work with this device.
-+	 */
++	/* Validate we can work with this device. */
 +	if (sm_state == NULL || handle == 0 || data == NULL || sm_addr == 0) {
 +		pr_err("[%s]: invalid input\n", __func__);
 +		return -EPERM;
@@ -76588,20 +77025,76 @@ index 0000000000000000000000000000000000000000..fd2ca788dcd56b1702454d71b7bedd42
 +	return ret;
 +}
 +EXPORT_SYMBOL_GPL(vc_sm_map);
++
++/* Import a dmabuf to be shared with VC. */
++int vc_sm_import_dmabuf(struct dma_buf *dmabuf, int *handle)
++{
++	struct vmcs_sm_ioctl_import_dmabuf ioparam = { 0 };
++	int ret;
++	struct sm_resource_t *resource;
++
++	/* Validate we can work with this device. */
++	if (!sm_state || !dmabuf || !handle) {
++		pr_err("[%s]: invalid input\n", __func__);
++		return -EPERM;
++	}
++
++	ioparam.cached = 0;
++	strcpy(ioparam.name, "KRNL DMABUF");
++
++	ret = vc_sm_ioctl_import_dmabuf(sm_state->data_knl, &ioparam, dmabuf);
++
++	if (!ret) {
++		resource = vmcs_sm_acquire_resource(sm_state->data_knl,
++						    ioparam.handle);
++		if (resource) {
++			resource->pid = 0;
++			vmcs_sm_release_resource(resource, 0);
++
++			/* Assign valid handle at this time.*/
++			*handle = ioparam.handle;
++		} else {
++			ret = -ENOMEM;
++		}
++	}
++
++	return ret;
++}
++EXPORT_SYMBOL_GPL(vc_sm_import_dmabuf);
 +#endif
 +
-+late_initcall(vc_sm_init);
-+module_exit(vc_sm_exit);
++/*
++ *   Register the driver with device tree
++ */
++
++static const struct of_device_id bcm2835_vcsm_of_match[] = {
++	{.compatible = "raspberrypi,bcm2835-vcsm",},
++	{ /* sentinel */ },
++};
++
++MODULE_DEVICE_TABLE(of, bcm2835_vcsm_of_match);
++
++static struct platform_driver bcm2835_vcsm_driver = {
++	.probe = bcm2835_vcsm_probe,
++	.remove = bcm2835_vcsm_remove,
++	.driver = {
++		   .name = DRIVER_NAME,
++		   .owner = THIS_MODULE,
++		   .of_match_table = bcm2835_vcsm_of_match,
++		   },
++};
++
++module_platform_driver(bcm2835_vcsm_driver);
 +
 +MODULE_AUTHOR("Broadcom");
 +MODULE_DESCRIPTION("VideoCore SharedMemory Driver");
 +MODULE_LICENSE("GPL v2");
 diff --git a/include/linux/broadcom/vmcs_sm_ioctl.h b/include/linux/broadcom/vmcs_sm_ioctl.h
 new file mode 100644
-index 0000000000000000000000000000000000000000..334f36d0d697b047df2922b5f2db67f38cf76564
+index 0000000000000000000000000000000000000000..b75729d762f25aace133f7a008633b4094ae2de2
 --- /dev/null
 +++ b/include/linux/broadcom/vmcs_sm_ioctl.h
-@@ -0,0 +1,248 @@
+@@ -0,0 +1,280 @@
 +/*****************************************************************************
 +*  Copyright 2011 Broadcom Corporation.  All rights reserved.
 +*
@@ -76666,8 +77159,11 @@ index 0000000000000000000000000000000000000000..334f36d0d697b047df2922b5f2db67f3
 +	VMCS_SM_CMD_HOST_WALK_PID_MAP,
 +
 +	VMCS_SM_CMD_CLEAN_INVALID,
++	VMCS_SM_CMD_CLEAN_INVALID2,
++
++	VMCS_SM_CMD_IMPORT_DMABUF,
 +
-+	VMCS_SM_CMD_LAST	/* Do no delete */
++	VMCS_SM_CMD_LAST	/* Do not delete */
 +};
 +
 +/* Cache type supported, conveniently matches the user space definition in
@@ -76779,6 +77275,28 @@ index 0000000000000000000000000000000000000000..334f36d0d697b047df2922b5f2db67f3
 +	} s[8];
 +};
 +
++struct vmcs_sm_ioctl_clean_invalid2 {
++	uint8_t op_count;
++	uint8_t zero[3];
++	struct vmcs_sm_ioctl_clean_invalid_block {
++		uint16_t invalidate_mode;
++		uint16_t block_count;
++		void *   start_address;
++		uint32_t block_size;
++		uint32_t inter_block_stride;
++	} s[0];
++};
++
++struct vmcs_sm_ioctl_import_dmabuf {
++	/* user -> kernel */
++	int dmabuf_fd;
++	enum vmcs_sm_cache_e cached;
++	char name[VMCS_SM_RESOURCE_NAME];
++
++	/* kernel -> user */
++	unsigned int handle;
++};
++
 +/* IOCTL numbers */
 +#define VMCS_SM_IOCTL_MEM_ALLOC\
 +	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_ALLOC,\
@@ -76810,6 +77328,9 @@ index 0000000000000000000000000000000000000000..334f36d0d697b047df2922b5f2db67f3
 +#define VMCS_SM_IOCTL_MEM_CLEAN_INVALID\
 +	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_CLEAN_INVALID,\
 +	 struct vmcs_sm_ioctl_clean_invalid)
++#define VMCS_SM_IOCTL_MEM_CLEAN_INVALID2\
++	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_CLEAN_INVALID2,\
++	 struct vmcs_sm_ioctl_clean_invalid2)
 +
 +#define VMCS_SM_IOCTL_SIZE_USR_HDL\
 +	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_SIZE_USR_HANDLE,\
@@ -76845,16 +77366,20 @@ index 0000000000000000000000000000000000000000..334f36d0d697b047df2922b5f2db67f3
 +	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_HOST_WALK_PID_MAP,\
 +	 struct vmcs_sm_ioctl_walk)
 +
++#define VMCS_SM_IOCTL_MEM_IMPORT_DMABUF\
++	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_IMPORT_DMABUF,\
++	 struct vmcs_sm_ioctl_import_dmabuf)
++
 +/* ---- Variable Externs ------------------------------------------------- */
 +
 +/* ---- Function Prototypes ---------------------------------------------- */
 +
 +#endif /* __VMCS_SM_IOCTL_H__INCLUDED__ */
 
-From 7b75205c2cd9672a52e657b0075ffa7355bf5093 Mon Sep 17 00:00:00 2001
+From e75eabc0faf3c8f3a5d256b6e299335b79ca8ecd Mon Sep 17 00:00:00 2001
 From: Luke Wren <luke@raspberrypi.org>
 Date: Fri, 21 Aug 2015 23:14:48 +0100
-Subject: [PATCH 042/173] Add /dev/gpiomem device for rootless user GPIO access
+Subject: [PATCH 044/126] Add /dev/gpiomem device for rootless user GPIO access
 
 Signed-off-by: Luke Wren <luke@raspberrypi.org>
 
@@ -77162,10 +77687,10 @@ index 0000000000000000000000000000000000000000..f5e7f1ba8fb6f18dee77fad06a17480c
 +MODULE_DESCRIPTION("gpiomem driver for accessing GPIO from userspace");
 +MODULE_AUTHOR("Luke Wren <luke@raspberrypi.org>");
 
-From 2c20cabf60049a431c4946d2c8bbbd940dc43355 Mon Sep 17 00:00:00 2001
+From b7744cfa0d0d4969cfb50f03a507d92949f1f783 Mon Sep 17 00:00:00 2001
 From: Luke Wren <wren6991@gmail.com>
 Date: Sat, 5 Sep 2015 01:14:45 +0100
-Subject: [PATCH 043/173] Add SMI driver
+Subject: [PATCH 045/126] Add SMI driver
 
 Signed-off-by: Luke Wren <wren6991@gmail.com>
 ---
@@ -77716,7 +78241,7 @@ index 8136dc7e863d7166a64c5ac8bddfa7f606e8c1fa..3db74632766eaacfe7a98d6cf4cf39db
  	tristate "Analog Devices Digital Potentiometers"
  	depends on (I2C || SPI) && SYSFS
 diff --git a/drivers/misc/Makefile b/drivers/misc/Makefile
-index b0b766416306e2e9ab4ffed550cb2a89b9f94280..fa5cba718065e656a29d7c9be0497e871a67d13f 100644
+index d84819dc2468c556228e486e2166005dccb731a5..f2d3afd0646071d74f343d1b21a45efd7bf3c676 100644
 --- a/drivers/misc/Makefile
 +++ b/drivers/misc/Makefile
 @@ -9,6 +9,7 @@ obj-$(CONFIG_AD525X_DPOT_SPI)	+= ad525x_dpot-spi.o
@@ -79116,10 +79641,10 @@ index 0000000000000000000000000000000000000000..ee3a75edfc033eeb0d90a687ffb68b10
 +
 +#endif /* BCM2835_SMI_H */
 
-From 674631fb6af7dc61e7c2d2d9b50d96e29b46a72a Mon Sep 17 00:00:00 2001
+From 9f1b4cba1ac37f6f2c3b4309a0dac493f02bfac9 Mon Sep 17 00:00:00 2001
 From: Martin Sperl <kernel@martin.sperl.org>
 Date: Tue, 26 Apr 2016 14:59:21 +0000
-Subject: [PATCH 044/173] MISC: bcm2835: smi: use clock manager and fix reload
+Subject: [PATCH 046/126] MISC: bcm2835: smi: use clock manager and fix reload
  issues
 
 Use clock manager instead of self-made clockmanager.
@@ -79289,10 +79814,10 @@ index 63a4ea08b9930a3a31a985f0a1d969b488ed49ec..1261540703127d1d63b9f3c87042c6e5
  	return 0;
  }
 
-From 437fba9ae6f282ea8d2fd7e568358f529640e222 Mon Sep 17 00:00:00 2001
+From 96f1fe17d1d0bf37cc6ec3649c8f95813c2aaa04 Mon Sep 17 00:00:00 2001
 From: Luke Wren <wren6991@gmail.com>
 Date: Sat, 5 Sep 2015 01:16:10 +0100
-Subject: [PATCH 045/173] Add SMI NAND driver
+Subject: [PATCH 047/126] Add SMI NAND driver
 
 Signed-off-by: Luke Wren <wren6991@gmail.com>
 ---
@@ -79354,7 +79879,7 @@ index 0000000000000000000000000000000000000000..159544d6579070d376d146bd24a86653
 +};
 \ No newline at end of file
 diff --git a/drivers/mtd/nand/Kconfig b/drivers/mtd/nand/Kconfig
-index dbfa72d61d5aa7b955e6d0728b127f69e79b3012..cb0e36dd772e8babb15f1a5f71797401f7153eb9 100644
+index 3f2036f31da47ae7209365c31aab0bb363b6940f..0534944728b7535b3b8324e9d91598c9b0c95dea 100644
 --- a/drivers/mtd/nand/Kconfig
 +++ b/drivers/mtd/nand/Kconfig
 @@ -40,6 +40,13 @@ config MTD_SM_COMMON
@@ -79385,7 +79910,7 @@ index ade5fc4c3819a79ffd575119ed6bbf5607bd8b7f..4312f9ac34ed8f3ae5d73dd1973a07e9
  obj-$(CONFIG_MTD_NAND_TANGO)		+= tango_nand.o
 diff --git a/drivers/mtd/nand/bcm2835_smi_nand.c b/drivers/mtd/nand/bcm2835_smi_nand.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..02adda6da18bd0ba9ab19a104975b79de58bfdce
+index 0000000000000000000000000000000000000000..c4826ea1c2bae555ce780e61f1076dddc1fa80db
 --- /dev/null
 +++ b/drivers/mtd/nand/bcm2835_smi_nand.c
 @@ -0,0 +1,267 @@
@@ -79430,7 +79955,7 @@ index 0000000000000000000000000000000000000000..02adda6da18bd0ba9ab19a104975b79d
 +#include <linux/of.h>
 +#include <linux/platform_device.h>
 +#include <linux/slab.h>
-+#include <linux/mtd/nand.h>
++#include <linux/mtd/rawnand.h>
 +#include <linux/mtd/partitions.h>
 +
 +#include <linux/broadcom/bcm2835_smi.h>
@@ -79657,10 +80182,10 @@ index 0000000000000000000000000000000000000000..02adda6da18bd0ba9ab19a104975b79d
 +	("Driver for NAND chips using Broadcom Secondary Memory Interface");
 +MODULE_AUTHOR("Luke Wren <luke@raspberrypi.org>");
 
-From 2ac4a21d9ef42dd54a9e532cffef4cac2ee31750 Mon Sep 17 00:00:00 2001
+From 4e98c8b70451af0c06201c839e37d074ffcbbdbe Mon Sep 17 00:00:00 2001
 From: Aron Szabo <aron@aron.ws>
 Date: Sat, 16 Jun 2012 12:15:55 +0200
-Subject: [PATCH 046/173] lirc: added support for RaspberryPi GPIO
+Subject: [PATCH 048/126] lirc: added support for RaspberryPi GPIO
 
 lirc_rpi: Use read_current_timer to determine transmitter delay. Thanks to jjmz and others
 See: https://github.com/raspberrypi/linux/issues/525
@@ -80520,26 +81045,31 @@ index 0000000000000000000000000000000000000000..fb69624ccef00ddbdccf8256d6baf1b1
 +
 +#endif
 
-From 751fe8b7692ced63db9d9e88a5e079ca9f3f632b Mon Sep 17 00:00:00 2001
+From b0c3236fd97324c7db26cd4d00f7ead13fc56b83 Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Wed, 3 Jul 2013 00:49:20 +0100
-Subject: [PATCH 047/173] Add cpufreq driver
+Subject: [PATCH 049/126] Add cpufreq driver
 
 Signed-off-by: popcornmix <popcornmix@gmail.com>
+
+bcm2835-cpufreq: Change licence to GPLv2
+
+Signed-off-by: Eben Upton <eben.upton@broadcom.com>
+Signed-off-by: Dom Cobley <dom@raspberrypi.com>
 ---
  drivers/cpufreq/Kconfig.arm       |   9 ++
  drivers/cpufreq/Makefile          |   1 +
- drivers/cpufreq/bcm2835-cpufreq.c | 218 ++++++++++++++++++++++++++++++++++++++
- 3 files changed, 228 insertions(+)
+ drivers/cpufreq/bcm2835-cpufreq.c | 210 ++++++++++++++++++++++++++++++++++++++
+ 3 files changed, 220 insertions(+)
  create mode 100644 drivers/cpufreq/bcm2835-cpufreq.c
 
 diff --git a/drivers/cpufreq/Kconfig.arm b/drivers/cpufreq/Kconfig.arm
-index 2011fec2d6ad9d5b4ad1b089c38a1be23baeb509..32caf32c8b247244930cbe27e8e5981728b8f3ac 100644
+index bdce4488ded1709b40282e8b14c614ee14e35ac8..e6e43bb9b51a9693932ce293195805a747f91f12 100644
 --- a/drivers/cpufreq/Kconfig.arm
 +++ b/drivers/cpufreq/Kconfig.arm
-@@ -242,6 +242,15 @@ config ARM_STI_CPUFREQ
- 	  this config option if you wish to add CPUFreq support for STi based
- 	  SoCs.
+@@ -237,6 +237,15 @@ config ARM_TANGO_CPUFREQ
+ 	depends on CPUFREQ_DT && ARCH_TANGO
+ 	default y
  
 +config ARM_BCM2835_CPUFREQ
 +	depends on RASPBERRYPI_FIRMWARE
@@ -80554,45 +81084,37 @@ index 2011fec2d6ad9d5b4ad1b089c38a1be23baeb509..32caf32c8b247244930cbe27e8e59817
  	bool "Tegra20 CPUFreq support"
  	depends on ARCH_TEGRA
 diff --git a/drivers/cpufreq/Makefile b/drivers/cpufreq/Makefile
-index ab3a42cd29ef210bcf0cad2ee48c74cb954b14f2..f81761612a9bef474090a868305bb86ee57cd930 100644
+index c7af9b2a255e1914fafd89d5bcfe2032c8db5b07..1e572daefc43b65d718012cbf273266097255be9 100644
 --- a/drivers/cpufreq/Makefile
 +++ b/drivers/cpufreq/Makefile
-@@ -75,6 +75,7 @@ obj-$(CONFIG_ARM_SA1110_CPUFREQ)	+= sa1110-cpufreq.o
- obj-$(CONFIG_ARM_SCPI_CPUFREQ)		+= scpi-cpufreq.o
+@@ -75,6 +75,7 @@ obj-$(CONFIG_ARM_SCPI_CPUFREQ)		+= scpi-cpufreq.o
  obj-$(CONFIG_ARM_SPEAR_CPUFREQ)		+= spear-cpufreq.o
  obj-$(CONFIG_ARM_STI_CPUFREQ)		+= sti-cpufreq.o
+ obj-$(CONFIG_ARM_TANGO_CPUFREQ)		+= tango-cpufreq.o
 +obj-$(CONFIG_ARM_BCM2835_CPUFREQ)	+= bcm2835-cpufreq.o
  obj-$(CONFIG_ARM_TEGRA20_CPUFREQ)	+= tegra20-cpufreq.o
  obj-$(CONFIG_ARM_TEGRA124_CPUFREQ)	+= tegra124-cpufreq.o
  obj-$(CONFIG_ARM_TEGRA186_CPUFREQ)	+= tegra186-cpufreq.o
 diff --git a/drivers/cpufreq/bcm2835-cpufreq.c b/drivers/cpufreq/bcm2835-cpufreq.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..414fbdc10dfbfc6e4bb47870a7af3fd5780f9c9a
+index 0000000000000000000000000000000000000000..99345969b0e4d651fd9033d67de2febb13fc0892
 --- /dev/null
 +++ b/drivers/cpufreq/bcm2835-cpufreq.c
-@@ -0,0 +1,218 @@
-+/*****************************************************************************
-+* Copyright 2011 Broadcom Corporation.  All rights reserved.
-+*
-+* Unless you and Broadcom execute a separate written software license
-+* agreement governing use of this software, this software is licensed to you
-+* under the terms of the GNU General Public License version 2, available at
-+* http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
-+*
-+* Notwithstanding the above, under no circumstances may you combine this
-+* software in any way with any other Broadcom software provided under a
-+* license other than the GPL, without Broadcom's express prior written
-+* consent.
-+*****************************************************************************/
-+
-+/*****************************************************************************
-+* FILENAME: bcm2835-cpufreq.h
-+* DESCRIPTION: This driver dynamically manages the CPU Frequency of the ARM
-+* processor. Messages are sent to Videocore either setting or requesting the
-+* frequency of the ARM in order to match an appropiate frequency to the current
-+* usage of the processor. The policy which selects the frequency to use is
-+* defined in the kernel .config file, but can be changed during runtime.
-+*****************************************************************************/
+@@ -0,0 +1,210 @@
++/*
++ * Copyright 2011 Broadcom Corporation.
++ *
++ * This program is free software; you can redistribute it and/or
++ * modify it under the terms of the GNU General Public License
++ * as published by the Free Software Foundation; version 2
++ * of the License.
++ *
++ * This driver dynamically manages the CPU Frequency of the ARM
++ * processor. Messages are sent to Videocore either setting or requesting the
++ * frequency of the ARM in order to match an appropiate frequency to the current
++ * usage of the processor. The policy which selects the frequency to use is
++ * defined in the kernel .config file, but can be changed during runtime.
++ */
 +
 +/* ---------- INCLUDES ---------- */
 +#include <linux/kernel.h>
@@ -80790,10 +81312,10 @@ index 0000000000000000000000000000000000000000..414fbdc10dfbfc6e4bb47870a7af3fd5
 +module_init(bcm2835_cpufreq_module_init);
 +module_exit(bcm2835_cpufreq_module_exit);
 
-From 5ce7c9c8296f76830f0674046a97234e5a8c66e4 Mon Sep 17 00:00:00 2001
+From 387dd5c62231c157fef11057e2ebbb40063e16fd Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Wed, 17 Jun 2015 15:44:08 +0100
-Subject: [PATCH 048/173] Add Chris Boot's i2c driver
+Subject: [PATCH 050/126] Add Chris Boot's i2c driver
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -80897,7 +81419,7 @@ both bcm2708_bsc_fifo_fill and ~drain are changed as well.
  create mode 100644 drivers/i2c/busses/i2c-bcm2708.c
 
 diff --git a/drivers/i2c/busses/Kconfig b/drivers/i2c/busses/Kconfig
-index 65fa29591d21641fd1bd4e4484d8daeef56f9bdb..82991e8031053ccca64798f079a8962ab1933873 100644
+index c06dce2c1da745fab9727715f5ffaa01a40d4d04..0e994077db9c2d8fd9d58c73d8377bac349d652b 100644
 --- a/drivers/i2c/busses/Kconfig
 +++ b/drivers/i2c/busses/Kconfig
 @@ -8,6 +8,25 @@ menu "I2C Hardware Bus support"
@@ -80927,7 +81449,7 @@ index 65fa29591d21641fd1bd4e4484d8daeef56f9bdb..82991e8031053ccca64798f079a8962a
  	tristate "ALI 1535"
  	depends on PCI
 diff --git a/drivers/i2c/busses/Makefile b/drivers/i2c/busses/Makefile
-index 1b2fc815a4d838fffd96f8f40234092752477f31..68cfa5bbc26b1ea89ec0212559fadc10fa437346 100644
+index 47f3ac9a695ad21066fc5ab47df40a564913e024..d0d755cee1a28408a53a9f92b140dd8a431a6a5c 100644
 --- a/drivers/i2c/busses/Makefile
 +++ b/drivers/i2c/busses/Makefile
 @@ -2,6 +2,8 @@
@@ -81458,10 +81980,10 @@ index 0000000000000000000000000000000000000000..962f2e5c7455d91bf32925d785f5f16b
 +MODULE_LICENSE("GPL v2");
 +MODULE_ALIAS("platform:" DRV_NAME);
 
-From 15fbd36ded7f781a25e607281877489e64d157b9 Mon Sep 17 00:00:00 2001
+From 514707f38d61469c5b479d27fadb0602cb8e10c9 Mon Sep 17 00:00:00 2001
 From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
 Date: Fri, 26 Jun 2015 14:27:06 +0200
-Subject: [PATCH 049/173] char: broadcom: Add vcio module
+Subject: [PATCH 051/126] char: broadcom: Add vcio module
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -81686,10 +82208,10 @@ index 0000000000000000000000000000000000000000..c19bc2075c77879563ef5e59038b5a14
 +MODULE_DESCRIPTION("Mailbox userspace access");
 +MODULE_LICENSE("GPL");
 
-From 4d25c2b0be3edd7396a0b22a2e793c32a31e9f49 Mon Sep 17 00:00:00 2001
+From 562b7efb1b21dceb65bb258aeaec77f2cf12da52 Mon Sep 17 00:00:00 2001
 From: =?UTF-8?q?Noralf=20Tr=C3=B8nnes?= <noralf@tronnes.org>
 Date: Fri, 26 Jun 2015 14:25:01 +0200
-Subject: [PATCH 050/173] firmware: bcm2835: Support ARCH_BCM270x
+Subject: [PATCH 052/126] firmware: bcm2835: Support ARCH_BCM270x
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -81772,10 +82294,10 @@ index dd506cd3a5b874f9e1acd07efb8cd151bb6145d1..3f070bd38a91511c986e3fb114b15bd4
  MODULE_AUTHOR("Eric Anholt <eric@anholt.net>");
  MODULE_DESCRIPTION("Raspberry Pi firmware driver");
 
-From 121799ce3c68fd5c4982dab632114b83ef46f27d Mon Sep 17 00:00:00 2001
+From e38f72b1b0fb822bacba07693ac38c23974d54ad Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Mon, 11 May 2015 09:00:42 +0100
-Subject: [PATCH 051/173] scripts: Add mkknlimg and knlinfo scripts from tools
+Subject: [PATCH 053/126] scripts: Add mkknlimg and knlinfo scripts from tools
  repo
 
 The Raspberry Pi firmware looks for a trailer on the kernel image to
@@ -82302,10 +82824,10 @@ index 0000000000000000000000000000000000000000..84be2593ec1de8f97b0167ff06b3e05d
 +	return $trailer;
 +}
 
-From a5e82c204eb88de5fa9f1ea33cf39bf57f28c09b Mon Sep 17 00:00:00 2001
+From 6b8863aa533590e05903dea482bdceb30302553b Mon Sep 17 00:00:00 2001
 From: notro <notro@tronnes.org>
 Date: Wed, 9 Jul 2014 14:46:08 +0200
-Subject: [PATCH 052/173] BCM2708: Add core Device Tree support
+Subject: [PATCH 054/126] BCM2708: Add core Device Tree support
 MIME-Version: 1.0
 Content-Type: text/plain; charset=UTF-8
 Content-Transfer-Encoding: 8bit
@@ -82505,12 +83027,12 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  arch/arm/Makefile                                  |    2 +
  arch/arm/boot/.gitignore                           |    2 +-
  arch/arm/boot/dts/Makefile                         |   20 +
- arch/arm/boot/dts/bcm2708-rpi-0-w.dts              |  162 +++
+ arch/arm/boot/dts/bcm2708-rpi-0-w.dts              |  162 ++
  arch/arm/boot/dts/bcm2708-rpi-b-plus.dts           |  122 ++
  arch/arm/boot/dts/bcm2708-rpi-b.dts                |  112 ++
  arch/arm/boot/dts/bcm2708-rpi-cm.dts               |   95 ++
  arch/arm/boot/dts/bcm2708-rpi-cm.dtsi              |   17 +
- arch/arm/boot/dts/bcm2708-rpi.dtsi                 |  174 +++
+ arch/arm/boot/dts/bcm2708-rpi.dtsi                 |  162 ++
  arch/arm/boot/dts/bcm2708.dtsi                     |   20 +
  arch/arm/boot/dts/bcm2709-rpi-2-b.dts              |  122 ++
  arch/arm/boot/dts/bcm2709.dtsi                     |   22 +
@@ -82519,8 +83041,8 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  arch/arm/boot/dts/bcm2710-rpi-cm3.dts              |  129 ++
  arch/arm/boot/dts/bcm2710.dtsi                     |  148 ++
  arch/arm/boot/dts/bcm283x.dtsi                     |   13 +-
- arch/arm/boot/dts/overlays/Makefile                |  118 ++
- arch/arm/boot/dts/overlays/README                  | 1517 ++++++++++++++++++++
+ arch/arm/boot/dts/overlays/Makefile                |  125 ++
+ arch/arm/boot/dts/overlays/README                  | 1620 ++++++++++++++++++++
  .../arm/boot/dts/overlays/adau1977-adc-overlay.dts |   40 +
  .../boot/dts/overlays/adau7002-simple-overlay.dts  |   52 +
  arch/arm/boot/dts/overlays/ads1015-overlay.dts     |   98 ++
@@ -82528,6 +83050,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  arch/arm/boot/dts/overlays/ads7846-overlay.dts     |   89 ++
  .../dts/overlays/akkordion-iqdacplus-overlay.dts   |   49 +
  .../allo-boss-dac-pcm512x-audio-overlay.dts        |   59 +
+ .../arm/boot/dts/overlays/allo-digione-overlay.dts |   44 +
  .../allo-piano-dac-pcm512x-audio-overlay.dts       |   54 +
  .../allo-piano-dac-plus-pcm512x-audio-overlay.dts  |   55 +
  arch/arm/boot/dts/overlays/at86rf233-overlay.dts   |   57 +
@@ -82545,9 +83068,11 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  arch/arm/boot/dts/overlays/enc28j60-overlay.dts    |   53 +
  .../boot/dts/overlays/enc28j60-spi2-overlay.dts    |   47 +
  arch/arm/boot/dts/overlays/fe-pi-audio-overlay.dts |   70 +
+ arch/arm/boot/dts/overlays/goodix-overlay.dts      |   46 +
  .../overlays/googlevoicehat-soundcard-overlay.dts  |   49 +
  arch/arm/boot/dts/overlays/gpio-ir-overlay.dts     |   44 +
  .../boot/dts/overlays/gpio-poweroff-overlay.dts    |   34 +
+ .../boot/dts/overlays/gpio-shutdown-overlay.dts    |   80 +
  .../boot/dts/overlays/hifiberry-amp-overlay.dts    |   39 +
  .../boot/dts/overlays/hifiberry-dac-overlay.dts    |   34 +
  .../dts/overlays/hifiberry-dacplus-overlay.dts     |   59 +
@@ -82559,10 +83084,11 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  arch/arm/boot/dts/overlays/i2c-gpio-overlay.dts    |   43 +
  arch/arm/boot/dts/overlays/i2c-mux-overlay.dts     |  139 ++
  .../boot/dts/overlays/i2c-pwm-pca9685a-overlay.dts |   26 +
- arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts     |   83 ++
- arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts  |   49 +
+ .../arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts |  183 +++
+ arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts     |  164 ++
+ arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts  |  142 ++
  .../arm/boot/dts/overlays/i2c0-bcm2708-overlay.dts |   61 +
- .../arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts |   37 +
+ .../arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts |   34 +
  .../boot/dts/overlays/i2s-gpio28-31-overlay.dts    |   18 +
  arch/arm/boot/dts/overlays/iqaudio-dac-overlay.dts |   46 +
  .../boot/dts/overlays/iqaudio-dacplus-overlay.dts  |   49 +
@@ -82571,12 +83097,14 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  .../boot/dts/overlays/justboom-digi-overlay.dts    |   41 +
  arch/arm/boot/dts/overlays/lirc-rpi-overlay.dts    |   57 +
  arch/arm/boot/dts/overlays/mcp23017-overlay.dts    |   54 +
- arch/arm/boot/dts/overlays/mcp23s17-overlay.dts    |  732 ++++++++++
+ arch/arm/boot/dts/overlays/mcp23s17-overlay.dts    |  732 +++++++++
  .../arm/boot/dts/overlays/mcp2515-can0-overlay.dts |   73 +
  .../arm/boot/dts/overlays/mcp2515-can1-overlay.dts |   73 +
  arch/arm/boot/dts/overlays/mcp3008-overlay.dts     |  205 +++
  arch/arm/boot/dts/overlays/midi-uart0-overlay.dts  |   36 +
+ arch/arm/boot/dts/overlays/midi-uart1-overlay.dts  |   43 +
  arch/arm/boot/dts/overlays/mmc-overlay.dts         |   39 +
+ arch/arm/boot/dts/overlays/mpu6050-overlay.dts     |   28 +
  arch/arm/boot/dts/overlays/mz61581-overlay.dts     |  117 ++
  arch/arm/boot/dts/overlays/pi3-act-led-overlay.dts |   27 +
  .../boot/dts/overlays/pi3-disable-bt-overlay.dts   |   46 +
@@ -82594,6 +83122,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  arch/arm/boot/dts/overlays/pwm-overlay.dts         |   43 +
  arch/arm/boot/dts/overlays/qca7000-overlay.dts     |   52 +
  arch/arm/boot/dts/overlays/raspidac3-overlay.dts   |   49 +
+ .../boot/dts/overlays/rotary-encoder-overlay.dts   |   43 +
  .../boot/dts/overlays/rpi-backlight-overlay.dts    |   21 +
  .../dts/overlays/rpi-cirrus-wm5102-overlay.dts     |  146 ++
  arch/arm/boot/dts/overlays/rpi-dac-overlay.dts     |   34 +
@@ -82618,10 +83147,10 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  arch/arm/boot/dts/overlays/spi0-hw-cs-overlay.dts  |   26 +
  arch/arm/boot/dts/overlays/spi1-1cs-overlay.dts    |   57 +
  arch/arm/boot/dts/overlays/spi1-2cs-overlay.dts    |   69 +
- arch/arm/boot/dts/overlays/spi1-3cs-overlay.dts    |   81 ++
+ arch/arm/boot/dts/overlays/spi1-3cs-overlay.dts    |   81 +
  arch/arm/boot/dts/overlays/spi2-1cs-overlay.dts    |   57 +
  arch/arm/boot/dts/overlays/spi2-2cs-overlay.dts    |   69 +
- arch/arm/boot/dts/overlays/spi2-3cs-overlay.dts    |   81 ++
+ arch/arm/boot/dts/overlays/spi2-3cs-overlay.dts    |   81 +
  arch/arm/boot/dts/overlays/tinylcd35-overlay.dts   |  224 +++
  arch/arm/boot/dts/overlays/uart1-overlay.dts       |   38 +
  .../arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts |   89 ++
@@ -82632,7 +83161,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  arch/arm/boot/dts/overlays/wittypi-overlay.dts     |   44 +
  scripts/Makefile.dtbinst                           |    8 +-
  scripts/Makefile.lib                               |   11 +
- 130 files changed, 10133 insertions(+), 6 deletions(-)
+ 137 files changed, 10869 insertions(+), 6 deletions(-)
  create mode 100644 arch/arm/boot/dts/bcm2708-rpi-0-w.dts
  create mode 100644 arch/arm/boot/dts/bcm2708-rpi-b-plus.dts
  create mode 100644 arch/arm/boot/dts/bcm2708-rpi-b.dts
@@ -82655,6 +83184,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  create mode 100644 arch/arm/boot/dts/overlays/ads7846-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/akkordion-iqdacplus-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/allo-boss-dac-pcm512x-audio-overlay.dts
+ create mode 100644 arch/arm/boot/dts/overlays/allo-digione-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/allo-piano-dac-pcm512x-audio-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/allo-piano-dac-plus-pcm512x-audio-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/at86rf233-overlay.dts
@@ -82672,9 +83202,11 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  create mode 100644 arch/arm/boot/dts/overlays/enc28j60-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/enc28j60-spi2-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/fe-pi-audio-overlay.dts
+ create mode 100644 arch/arm/boot/dts/overlays/goodix-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/googlevoicehat-soundcard-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/gpio-ir-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/gpio-poweroff-overlay.dts
+ create mode 100644 arch/arm/boot/dts/overlays/gpio-shutdown-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/hifiberry-amp-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/hifiberry-dac-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/hifiberry-dacplus-overlay.dts
@@ -82686,6 +83218,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  create mode 100644 arch/arm/boot/dts/overlays/i2c-gpio-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/i2c-mux-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/i2c-pwm-pca9685a-overlay.dts
+ create mode 100644 arch/arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/i2c0-bcm2708-overlay.dts
@@ -82703,7 +83236,9 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  create mode 100644 arch/arm/boot/dts/overlays/mcp2515-can1-overlay.dts
  create mode 100755 arch/arm/boot/dts/overlays/mcp3008-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/midi-uart0-overlay.dts
+ create mode 100644 arch/arm/boot/dts/overlays/midi-uart1-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/mmc-overlay.dts
+ create mode 100644 arch/arm/boot/dts/overlays/mpu6050-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/mz61581-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/pi3-act-led-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/pi3-disable-bt-overlay.dts
@@ -82721,6 +83256,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  create mode 100644 arch/arm/boot/dts/overlays/pwm-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/qca7000-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/raspidac3-overlay.dts
+ create mode 100644 arch/arm/boot/dts/overlays/rotary-encoder-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/rpi-backlight-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/rpi-cirrus-wm5102-overlay.dts
  create mode 100644 arch/arm/boot/dts/overlays/rpi-dac-overlay.dts
@@ -82782,7 +83318,7 @@ index 3c79f85975aaa26c7c2e353fefc54d71d89bc5bf..eaaeb17e5986e5f7178b2851169444ac
 -*.dtb
 +*.dtb*
 diff --git a/arch/arm/boot/dts/Makefile b/arch/arm/boot/dts/Makefile
-index 4b17f35dc9a7167bcce9b5c9c9b35b7375add15c..7dd76e2bce867092846ce9bf5131d1a37ca965eb 100644
+index faf46abaa4a2773721a0c30b012a2ae52308daae..29914dd3a7723c462b4d62b37a0c467db1480404 100644
 --- a/arch/arm/boot/dts/Makefile
 +++ b/arch/arm/boot/dts/Makefile
 @@ -1,5 +1,14 @@
@@ -82800,7 +83336,7 @@ index 4b17f35dc9a7167bcce9b5c9c9b35b7375add15c..7dd76e2bce867092846ce9bf5131d1a3
  dtb-$(CONFIG_ARCH_ALPINE) += \
  	alpine-db.dtb
  dtb-$(CONFIG_MACH_ARTPEC6) += \
-@@ -1056,10 +1065,21 @@ dtb-$(CONFIG_ARCH_ZX) += zx296702-ad1.dtb
+@@ -1068,10 +1077,21 @@ dtb-$(CONFIG_ARCH_ZX) += zx296702-ad1.dtb
  dtb-$(CONFIG_ARCH_ASPEED) += aspeed-bmc-opp-palmetto.dtb \
  	aspeed-bmc-opp-romulus.dtb \
  	aspeed-ast2500-evb.dtb
@@ -83362,10 +83898,10 @@ index 0000000000000000000000000000000000000000..d0299e3d9a09ddcdad80cb0957b30b14
 +};
 diff --git a/arch/arm/boot/dts/bcm2708-rpi.dtsi b/arch/arm/boot/dts/bcm2708-rpi.dtsi
 new file mode 100644
-index 0000000000000000000000000000000000000000..29dde110e769082a24640d3c7284afb8e99b226c
+index 0000000000000000000000000000000000000000..f88b844f0aff82742966fd820f6f69cf25c2dfab
 --- /dev/null
 +++ b/arch/arm/boot/dts/bcm2708-rpi.dtsi
-@@ -0,0 +1,174 @@
+@@ -0,0 +1,162 @@
 +/* Downstream version of bcm2835-rpi.dtsi */
 +
 +#include <dt-bindings/power/raspberrypi-power.h>
@@ -83442,6 +83978,12 @@ index 0000000000000000000000000000000000000000..29dde110e769082a24640d3c7284afb8
 +			firmware = <&firmware>;
 +		};
 +
++		vcsm: vcsm {
++			compatible = "raspberrypi,bcm2835-vcsm";
++			firmware = <&firmware>;
++			status = "okay";
++		};
++
 +		thermal: thermal@7e212000 {
 +			#thermal-sensor-cells = <0>;
 +			status = "okay";
@@ -83458,30 +84000,6 @@ index 0000000000000000000000000000000000000000..29dde110e769082a24640d3c7284afb8
 +		sound: sound {
 +			status = "disabled";
 +		};
-+
-+		thermal-zones {
-+			cpu_thermal: cpu-thermal {
-+				polling-delay-passive = <0>;
-+				polling-delay = <1000>;
-+
-+				thermal-sensors = <&thermal>;
-+
-+				/* No trips
-+				trips {
-+					cpu-crit {
-+						temperature	= <80000>;
-+						hysteresis	= <0>;
-+						type		= "critical";
-+					};
-+				};
-+				*/
-+
-+				coefficients = <(-538)	407000>;
-+
-+				cooling-maps {
-+				};
-+			};
-+		};
 +	};
 +
 +	__overrides__ {
@@ -83540,6 +84058,12 @@ index 0000000000000000000000000000000000000000..29dde110e769082a24640d3c7284afb8
 +&fb {
 +	status = "okay";
 +};
++
++&cpu_thermal {
++	coefficients = <(-538)	407000>;
++
++	/delete-node/ trips;
++};
 diff --git a/arch/arm/boot/dts/bcm2708.dtsi b/arch/arm/boot/dts/bcm2708.dtsi
 new file mode 100644
 index 0000000000000000000000000000000000000000..756bd3687b488da98f749b27ddfe098693990045
@@ -84411,10 +84935,10 @@ index 431dcfc900c024d85a88231d1df007916dafdfeb..6a119d30c5f8c2d13deacea646af8c30
  			#size-cells = <0>;
 diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
 new file mode 100644
-index 0000000000000000000000000000000000000000..e2f66a55dc5afe13d690c2c17827054ac94b7168
+index 0000000000000000000000000000000000000000..c50b1dfa9d7334df47ce087f9d2a7a816afa05ba
 --- /dev/null
 +++ b/arch/arm/boot/dts/overlays/Makefile
-@@ -0,0 +1,118 @@
+@@ -0,0 +1,125 @@
 +# Overlays for the Raspberry Pi platform
 +
 +dtbo-$(CONFIG_ARCH_BCM2835) += \
@@ -84425,6 +84949,7 @@ index 0000000000000000000000000000000000000000..e2f66a55dc5afe13d690c2c17827054a
 +	ads7846.dtbo \
 +	akkordion-iqdacplus.dtbo \
 +	allo-boss-dac-pcm512x-audio.dtbo \
++	allo-digione.dtbo \
 +	allo-piano-dac-pcm512x-audio.dtbo \
 +	allo-piano-dac-plus-pcm512x-audio.dtbo \
 +	at86rf233.dtbo \
@@ -84442,9 +84967,11 @@ index 0000000000000000000000000000000000000000..e2f66a55dc5afe13d690c2c17827054a
 +	enc28j60.dtbo \
 +	enc28j60-spi2.dtbo \
 +	fe-pi-audio.dtbo \
++	goodix.dtbo \
 +	googlevoicehat-soundcard.dtbo \
 +	gpio-ir.dtbo \
 +	gpio-poweroff.dtbo \
++	gpio-shutdown.dtbo \
 +	hifiberry-amp.dtbo \
 +	hifiberry-dac.dtbo \
 +	hifiberry-dacplus.dtbo \
@@ -84457,6 +84984,7 @@ index 0000000000000000000000000000000000000000..e2f66a55dc5afe13d690c2c17827054a
 +	i2c-mux.dtbo \
 +	i2c-pwm-pca9685a.dtbo \
 +	i2c-rtc.dtbo \
++	i2c-rtc-gpio.dtbo \
 +	i2c-sensor.dtbo \
 +	i2c0-bcm2708.dtbo \
 +	i2c1-bcm2708.dtbo \
@@ -84473,7 +85001,9 @@ index 0000000000000000000000000000000000000000..e2f66a55dc5afe13d690c2c17827054a
 +	mcp2515-can1.dtbo \
 +	mcp3008.dtbo \
 +	midi-uart0.dtbo \
++	midi-uart1.dtbo \
 +	mmc.dtbo \
++	mpu6050.dtbo \
 +	mz61581.dtbo \
 +	pi3-act-led.dtbo \
 +	pi3-disable-bt.dtbo \
@@ -84491,6 +85021,7 @@ index 0000000000000000000000000000000000000000..e2f66a55dc5afe13d690c2c17827054a
 +	pwm-2chan.dtbo \
 +	qca7000.dtbo \
 +	raspidac3.dtbo \
++	rotary-encoder.dtbo \
 +	rpi-backlight.dtbo \
 +	rpi-cirrus-wm5102.dtbo \
 +	rpi-dac.dtbo \
@@ -84535,10 +85066,10 @@ index 0000000000000000000000000000000000000000..e2f66a55dc5afe13d690c2c17827054a
 +clean-files	:= *.dtbo
 diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
 new file mode 100644
-index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b2b54e53b
+index 0000000000000000000000000000000000000000..e6d777a601c91d192bc5713f9a73e1a2d4d708ef
 --- /dev/null
 +++ b/arch/arm/boot/dts/overlays/README
-@@ -0,0 +1,1517 @@
+@@ -0,0 +1,1620 @@
 +Introduction
 +============
 +
@@ -84828,6 +85359,12 @@ index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b
 +                                slave"
 +
 +
++Name:   allo-digione
++Info:   Configures the Allo Digione audio card
++Load:   dtoverlay=allo-digione
++Params: <None>
++
++
 +Name:   allo-piano-dac-pcm512x-audio
 +Info:   Configures the Allo Piano DAC (2.0/2.1) audio cards.
 +        (NB. This initial support is for 2.0 channel audio ONLY! ie. stereo.
@@ -85000,6 +85537,14 @@ index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b
 +Params: <None>
 +
 +
++Name:   goodix
++Info:   Enables I2C connected Goodix gt9271 multiple touch controller using
++        GPIOs 4 and 17 (pins 7 and 11 on GPIO header) for interrupt and reset.
++Load:   dtoverlay=goodix,<param>=<val>
++Params: interrupt               GPIO used for interrupt (default 4)
++        reset                   GPIO used for reset (default 17)
++
++
 +Name:   googlevoicehat-soundcard
 +Info:   Configures the Google voiceHAT soundcard
 +Load:   dtoverlay=googlevoicehat-soundcard
@@ -85035,6 +85580,38 @@ index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b
 +                                will also cause the pin to go low.
 +
 +
++Name:   gpio-shutdown
++Info:   Initiates a shutdown when GPIO pin changes. The given GPIO pin
++        is configured as an input key that generates KEY_POWER events.
++        This event is handled by systemd-logind by initiating a
++        shutdown. Systemd versions older than 225 need an udev rule
++        enable listening to the input device:
++
++                ACTION!="REMOVE", SUBSYSTEM=="input", KERNEL=="event*", \
++                        SUBSYSTEMS=="platform", DRIVERS=="gpio-keys", \
++                        ATTRS{keys}=="116", TAG+="power-switch"
++
++        This overlay only handles shutdown. After shutdown, the system
++        can be powered up again by driving GPIO3 low. The default
++        configuration uses GPIO3 with a pullup, so if you connect a
++        button between GPIO3 and GND (pin 5 and 6 on the 40-pin header),
++        you get a shutdown and power-up button.
++Load:   dtoverlay=gpio-shutdown,<param>=<val>
++Params: gpio_pin                GPIO pin to trigger on (default 3)
++
++        active_low              When this is 1 (active low), a falling
++                                edge generates a key down event and a
++                                rising edge generates a key up event.
++                                When this is 0 (active high), this is
++                                reversed. The default is 1 (active low).
++
++        gpio_pull               Desired pull-up/down state (off, down, up)
++                                Default is "up".
++
++                                Note that the default pin (GPIO3) has an
++                                external pullup.
++
++
 +Name:   hifiberry-amp
 +Info:   Configures the HifiBerry Amp and Amp+ audio cards
 +Load:   dtoverlay=hifiberry-amp
@@ -85189,22 +85766,77 @@ index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b
 +                                source
 +
 +
++Name:   i2c-rtc-gpio
++Info:   Adds support for a number of I2C Real Time Clock devices
++        using the software i2c controller
++Load:   dtoverlay=i2c-rtc-gpio,<param>=<val>
++Params: abx80x                  Select one of the ABx80x family:
++                                  AB0801, AB0803, AB0804, AB0805,
++                                  AB1801, AB1803, AB1804, AB1805
++
++        ds1307                  Select the DS1307 device
++
++        ds1339                  Select the DS1339 device
++
++        ds3231                  Select the DS3231 device
++
++        mcp7940x                Select the MCP7940x device
++
++        mcp7941x                Select the MCP7941x device
++
++        pcf2127                 Select the PCF2127 device
++
++        pcf8523                 Select the PCF8523 device
++
++        pcf8563                 Select the PCF8563 device
++
++        trickle-diode-type      Diode type for trickle charge - "standard" or
++                                "schottky" (ABx80x only)
++
++        trickle-resistor-ohms   Resistor value for trickle charge (DS1339,
++                                ABx80x)
++
++        wakeup-source           Specify that the RTC can be used as a wakeup
++                                source
++
++        i2c_gpio_sda            GPIO used for I2C data (default "23")
++
++        i2c_gpio_scl            GPIO used for I2C clock (default "24")
++
++        i2c_gpio_delay_us       Clock delay in microseconds
++                                (default "2" = ~100kHz)
++
++
 +Name:   i2c-sensor
 +Info:   Adds support for a number of I2C barometric pressure and temperature
 +        sensors on i2c_arm
 +Load:   dtoverlay=i2c-sensor,<param>=<val>
-+Params: bmp085                  Select the Bosch sensortronic BMP085
++Params: addr                    Set the address for the BME280, BMP280, TMP102
++                                or LM75
++
++        bme280                  Select the Bosch Sensortronic BME280
++                                Valid addresses 0x76-0x77, default 0x76
 +
-+        bmp280                  Select the Bosch sensortronic BMP280
++        bmp085                  Select the Bosch Sensortronic BMP085
++
++        bmp180                  Select the Bosch Sensortronic BMP180
++
++        bmp280                  Select the Bosch Sensortronic BMP280
++                                Valid addresses 0x76-0x77, default 0x76
++
++        htu21                   Select the HTU21 temperature and humidity sensor
 +
 +        lm75                    Select the Maxim LM75 temperature sensor
++                                Valid addresses 0x48-0x4f, default 0x4f
 +
-+        lm75addr                Choose the address for the LM75 (0x48-0x4f -
-+                                default 0x4f)
++        lm75addr                Deprecated - use addr parameter instead
 +
 +        si7020                  Select the Silicon Labs Si7013/20/21 humidity/
 +                                temperature sensor
 +
++        tmp102                  Select the Texas Instruments TMP102 temp sensor
++                                Valid addresses 0x48-0x4b, default 0x48
++
 +
 +Name:   i2c0-bcm2708
 +Info:   Enable the i2c_bcm2708 driver for the i2c0 bus. Not all pin combinations
@@ -85405,6 +86037,13 @@ index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b
 +Params: <None>
 +
 +
++Name:   midi-uart1
++Info:   Configures UART1 (ttyS0) so that a requested 38.4kbaud actually gets
++        31.25kbaud, the frequency required for MIDI
++Load:   dtoverlay=midi-uart1
++Params: <None>
++
++
 +Name:   mmc
 +Info:   Selects the bcm2835-mmc SD/MMC driver, optionally with overclock
 +Load:   dtoverlay=mmc,<param>=<val>
@@ -85412,6 +86051,12 @@ index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b
 +                                requests 50MHz
 +
 +
++Name:   mpu6050
++Info:   Overlay for i2c connected mpu6050 imu
++Load:   dtoverlay=mpu6050,<param>=<val>
++Params: interrupt               GPIO pin for interrupt (default 4)
++
++
 +Name:   mz61581
 +Info:   MZ61581 display by Tontec
 +Load:   dtoverlay=mz61581,<param>=<val>
@@ -85636,6 +86281,15 @@ index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b
 +Params: <None>
 +
 +
++Name:   rotary-encoder
++Info:   Overlay for GPIO connected rotary encoder.
++Load:   dtoverlay=rotary-encoder,<param>=<val>
++Params: rotary0_pin_a           GPIO connected to rotary encoder channel A
++                                (default 4).
++        rotary0_pin_b           GPIO connected to rotary encoder channel B
++                                (default 17).
++
++
 +Name:   rpi-backlight
 +Info:   Raspberry Pi official display backlight driver
 +Load:   dtoverlay=rpi-backlight
@@ -85737,19 +86391,9 @@ index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b
 +Info:   Selects the bcm2835-sdhost SD/MMC driver, optionally with overclock,
 +        and enables SDIO via GPIOs 22-27.
 +Load:   dtoverlay=sdio,<param>=<val>
-+Params: overclock_50            SD Clock (in MHz) to use when the MMC framework
-+                                requests 50MHz
-+
-+        sdio_overclock          SDIO Clock (in MHz) to use when the MMC
++Params: sdio_overclock          SDIO Clock (in MHz) to use when the MMC
 +                                framework requests 50MHz
 +
-+        force_pio               Disable DMA support (default off)
-+
-+        pio_limit               Number of blocks above which to use DMA
-+                                (default 1)
-+
-+        debug                   Enable debug output (default off)
-+
 +        poll_once               Disable SDIO-device polling every second
 +                                (default on: polling once at boot-time)
 +
@@ -85760,19 +86404,9 @@ index 0000000000000000000000000000000000000000..e2a803e5180cf78d67b6723cfd2f6d3b
 +Info:   Selects the bcm2835-sdhost SD/MMC driver, optionally with overclock,
 +        and enables 1-bit SDIO via GPIOs 22-25.
 +Load:   dtoverlay=sdio-1bit,<param>=<val>
-+Params: overclock_50            SD Clock (in MHz) to use when the MMC framework
-+                                requests 50MHz
-+
-+        sdio_overclock          SDIO Clock (in MHz) to use when the MMC
++Params: sdio_overclock          SDIO Clock (in MHz) to use when the MMC
 +                                framework requests 50MHz
 +
-+        force_pio               Disable DMA support (default off)
-+
-+        pio_limit               Number of blocks above which to use DMA
-+                                (default 1)
-+
-+        debug                   Enable debug output (default off)
-+
 +        poll_once               Disable SDIO-device polling every second
 +                                (default on: polling once at boot-time)
 +
@@ -86588,6 +87222,56 @@ index 0000000000000000000000000000000000000000..ac1cfe093d9aa8a77ef25cc62a9d8100
 +		slave = <&boss_dac>,"allo,slave?";
 +	};
 +};
+diff --git a/arch/arm/boot/dts/overlays/allo-digione-overlay.dts b/arch/arm/boot/dts/overlays/allo-digione-overlay.dts
+new file mode 100644
+index 0000000000000000000000000000000000000000..101277a11a24e9b3eb441c44c3f19c61836fe77c
+--- /dev/null
++++ b/arch/arm/boot/dts/overlays/allo-digione-overlay.dts
+@@ -0,0 +1,44 @@
++// Definitions for Allo DigiOne
++/dts-v1/;
++/plugin/;
++
++/ {
++	compatible = "brcm,bcm2708";
++
++	fragment@0 {
++		target = <&i2s>;
++		__overlay__ {
++			status = "okay";
++		};
++	};
++
++	fragment@1 {
++		target = <&i2c1>;
++		__overlay__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			wm8804@3b {
++				#sound-dai-cells = <0>;
++				compatible = "wlf,wm8804";
++				reg = <0x3b>;
++				PVDD-supply = <&vdd_3v3_reg>;
++				DVDD-supply = <&vdd_3v3_reg>;
++				status = "okay";
++				wlf,reset-gpio = <&gpio 17 0>;
++			};
++		};
++	};
++
++	fragment@2 {
++		target = <&sound>;
++		__overlay__ {
++			compatible = "allo,allo-digione";
++			i2s-controller = <&i2s>;
++			status = "okay";
++			clock44-gpio = <&gpio 5 0>;
++			clock48-gpio = <&gpio 6 0>;
++		};
++	};
++};
 diff --git a/arch/arm/boot/dts/overlays/allo-piano-dac-pcm512x-audio-overlay.dts b/arch/arm/boot/dts/overlays/allo-piano-dac-pcm512x-audio-overlay.dts
 new file mode 100644
 index 0000000000000000000000000000000000000000..a5468d850a911cd509365cf25f8ffa6ad071b90a
@@ -87399,6 +88083,58 @@ index 0000000000000000000000000000000000000000..81a07ed5a8c7594e65f0df2176418cac
 +		};
 +	};
 +};
+diff --git a/arch/arm/boot/dts/overlays/goodix-overlay.dts b/arch/arm/boot/dts/overlays/goodix-overlay.dts
+new file mode 100644
+index 0000000000000000000000000000000000000000..084f74042ed6379ebd9281374d5391a7e23a431e
+--- /dev/null
++++ b/arch/arm/boot/dts/overlays/goodix-overlay.dts
+@@ -0,0 +1,46 @@
++// Device tree overlay for I2C connected Goodix gt9271 multiple touch controller
++/dts-v1/;
++/plugin/;
++
++/ {
++	compatible = "brcm,bcm2708";
++
++	fragment@0 {
++		target = <&gpio>;
++		__overlay__ {
++			goodix_pins: goodix_pins {
++				brcm,pins = <4 17>; // interrupt and reset
++				brcm,function = <0 0>; // in
++				brcm,pull = <2 2>; // pull-up
++			};
++		};
++	};
++
++	fragment@1 {
++		target = <&i2c1>;
++		__overlay__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			gt9271: gt9271@14 {
++				compatible = "goodix,gt9271";
++				reg = <0x14>;
++				pinctrl-names = "default";
++				pinctrl-0 = <&goodix_pins>;
++				interrupt-parent = <&gpio>;
++				interrupts = <4 2>; // high-to-low edge triggered
++				irq-gpios = <&gpio 4 0>; // Pin7 on GPIO header
++				reset-gpios = <&gpio 17 0>; // Pin11 on GPIO header
++			};
++		};
++	};
++
++	__overrides__ {
++		interrupt = <&goodix_pins>,"brcm,pins:0",
++			<&gt9271>,"interrupts:0",
++			<&gt9271>,"irq-gpios:4";
++		reset = <&goodix_pins>,"brcm,pins:4",
++			<&gt9271>,"reset-gpios:4";
++	};
++};
 diff --git a/arch/arm/boot/dts/overlays/googlevoicehat-soundcard-overlay.dts b/arch/arm/boot/dts/overlays/googlevoicehat-soundcard-overlay.dts
 new file mode 100644
 index 0000000000000000000000000000000000000000..9a9e9a0ca28cf774a868b2882ae57b00de1cf7b7
@@ -87544,6 +88280,92 @@ index 0000000000000000000000000000000000000000..ff8cb36d94d4940d5151ace24afc4ad1
 +		active_low =    <&power_ctrl>,"gpios:8";
 +	};
 +};
+diff --git a/arch/arm/boot/dts/overlays/gpio-shutdown-overlay.dts b/arch/arm/boot/dts/overlays/gpio-shutdown-overlay.dts
+new file mode 100644
+index 0000000000000000000000000000000000000000..863fb395c8539734b658682b900e1fbd96c9443e
+--- /dev/null
++++ b/arch/arm/boot/dts/overlays/gpio-shutdown-overlay.dts
+@@ -0,0 +1,80 @@
++// Definitions for gpio-poweroff module
++/dts-v1/;
++/plugin/;
++
++// This overlay sets up an input device that generates KEY_POWER events
++// when a given GPIO pin changes. It defaults to using GPIO3, which can
++// also be used to wake up (start) the Rpi again after shutdown. Since
++// wakeup is active-low, this defaults to active-low with a pullup
++// enabled, but all of this can be changed using overlay parameters (but
++// note that GPIO3 has an external pullup on at least some boards).
++
++/ {
++	compatible = "brcm,bcm2708";
++
++	fragment@0 {
++		// Configure the gpio pin controller
++		target = <&gpio>;
++		__overlay__ {
++			// Define a pinctrl state, that sets up the gpio
++			// as an input with a pullup enabled. This does
++			// not take effect by itself, only when referenced
++			// by a "pinctrl client", as is done below. See:
++			//   https://www.kernel.org/doc/Documentation/devicetree/bindings/pinctrl/pinctrl-bindings.txt
++			//   https://www.kernel.org/doc/Documentation/devicetree/bindings/pinctrl/brcm,bcm2835-gpio.txt
++			pin_state: shutdown_button_pins {
++				brcm,pins = <3>; // gpio number
++				brcm,function = <0>; // 0 = input, 1 = output
++				brcm,pull = <2>; // 0 = none, 1 = pull down, 2 = pull up
++			};
++		};
++	};
++	fragment@1 {
++		// Add a new device to the /soc devicetree node
++		target-path = "/soc";
++		__overlay__ {
++			shutdown_button {
++				// Let the gpio-keys driver handle this device. See:
++				// https://www.kernel.org/doc/Documentation/devicetree/bindings/input/gpio-keys.txt
++				compatible = "gpio-keys";
++
++				// Declare a single pinctrl state (referencing the one declared above) and name it
++				// default, so it is activated automatically.
++				pinctrl-names = "default";
++				pinctrl-0 = <&pin_state>;
++
++				// Enable this device
++				status = "okay";
++
++				// Define a single key, called "shutdown" that monitors the gpio and sends KEY_POWER
++				// (keycode 116, see
++				// https://github.com/torvalds/linux/blob/v4.12/include/uapi/linux/input-event-codes.h#L190)
++				button: shutdown {
++					label = "shutdown";
++					linux,code = <116>; // KEY_POWER
++					gpios = <&gpio 3 1>;
++				};
++			};
++		};
++	};
++
++	// This defines parameters that can be specified when loading
++	// the overlay. Each foo = line specifies one parameter, named
++	// foo. The rest of the specification gives properties where the
++	// parameter value is inserted into (changing the values above
++	// or adding new ones).
++	__overrides__ {
++		// Allow overriding the GPIO number.
++		gpio_pin = <&button>,"gpios:4",
++		           <&pin_state>,"brcm,pins:0";
++
++		// Allow changing the internal pullup/down state. 0 = none, 1 = pulldown, 2 = pullup
++		// Note that GPIO3 and GPIO2 are the I2c pins and have an external pullup (at least
++                // on some boards).
++		gpio_pull = <&pin_state>,"brcm,pull:0";
++
++		// Allow setting the active_low flag. 0 = active high, 1 = active low
++		active_low = <&button>,"gpios:8";
++	};
++
++};
 diff --git a/arch/arm/boot/dts/overlays/hifiberry-amp-overlay.dts b/arch/arm/boot/dts/overlays/hifiberry-amp-overlay.dts
 new file mode 100644
 index 0000000000000000000000000000000000000000..5f5785534fd3d9a97309796f842c8881e2d6979a
@@ -88288,13 +89110,14 @@ index 0000000000000000000000000000000000000000..d1ffd2326669e46ad68939f94713cc99
 +		addr = <&pca>,"reg:0";
 +	};
 +};
-diff --git a/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts b/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts
+diff --git a/arch/arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts b/arch/arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts
 new file mode 100644
-index 0000000000000000000000000000000000000000..1efcf0b712c9c5c19210545002ac1f0931db58f5
+index 0000000000000000000000000000000000000000..8415e6081428fba9a47682964174fc023cfd2b0c
 --- /dev/null
-+++ b/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts
-@@ -0,0 +1,83 @@
++++ b/arch/arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts
+@@ -0,0 +1,183 @@
 +// Definitions for several I2C based Real Time Clocks
++// Available through i2c-gpio
 +/dts-v1/;
 +/plugin/;
 +
@@ -88302,8 +89125,23 @@ index 0000000000000000000000000000000000000000..1efcf0b712c9c5c19210545002ac1f09
 +	compatible = "brcm,bcm2708";
 +
 +	fragment@0 {
-+		target = <&i2c_arm>;
++		target-path = "/";
 +		__overlay__ {
++			i2c_gpio: i2c-gpio-rtc@0 {
++				compatible = "i2c-gpio";
++				gpios = <&gpio 23 0 /* sda */
++					 &gpio 24 0 /* scl */
++					>;
++				i2c-gpio,delay-us = <2>;        /* ~100 kHz */
++				#address-cells = <1>;
++				#size-cells = <0>;
++			};
++		};
++	};
++
++	fragment@1 {
++		target = <&i2c_gpio>;
++		__dormant__ {
 +			#address-cells = <1>;
 +			#size-cells = <0>;
 +			status = "okay";
@@ -88313,61 +89151,315 @@ index 0000000000000000000000000000000000000000..1efcf0b712c9c5c19210545002ac1f09
 +				reg = <0x69>;
 +				abracon,tc-diode = "standard";
 +				abracon,tc-resistor = <0>;
-+				status = "disable";
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@2 {
++		target = <&i2c_gpio>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
 +			ds1307: ds1307@68 {
 +				compatible = "maxim,ds1307";
 +				reg = <0x68>;
-+				status = "disable";
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@3 {
++		target = <&i2c_gpio>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
 +			ds1339: ds1339@68 {
 +				compatible = "dallas,ds1339";
 +				trickle-resistor-ohms = <0>;
 +				reg = <0x68>;
-+				status = "disable";
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@4 {
++		target = <&i2c_gpio>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			ds3231: ds3231@68 {
++				compatible = "maxim,ds3231";
++				reg = <0x68>;
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@5 {
++		target = <&i2c_gpio>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
 +			mcp7940x: mcp7940x@6f {
 +				compatible = "microchip,mcp7940x";
 +				reg = <0x6f>;
-+				status = "disable";
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@6 {
++		target = <&i2c_gpio>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
 +			mcp7941x: mcp7941x@6f {
 +				compatible = "microchip,mcp7941x";
 +				reg = <0x6f>;
-+				status = "disable";
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@7 {
++		target = <&i2c_gpio>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			pcf2127: pcf2127@51 {
++				compatible = "nxp,pcf2127";
++				reg = <0x51>;
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@8 {
++		target = <&i2c_gpio>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			pcf8523: pcf8523@68 {
++				compatible = "nxp,pcf8523";
++				reg = <0x68>;
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@9 {
++		target = <&i2c_gpio>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			pcf8563: pcf8563@51 {
++				compatible = "nxp,pcf8563";
++				reg = <0x51>;
++				status = "okay";
 +			};
++		};
++	};
++
++	__overrides__ {
++		abx80x = <0>,"+1";
++		ds1307 = <0>,"+2";
++		ds1339 = <0>,"+3";
++		ds3231 = <0>,"+4";
++		mcp7940x = <0>,"+5";
++		mcp7941x = <0>,"+6";
++		pcf2127 = <0>,"+7";
++		pcf8523 = <0>,"+8";
++		pcf8563 = <0>,"+9";
++		trickle-diode-type = <&abx80x>,"abracon,tc-diode";
++		trickle-resistor-ohms = <&ds1339>,"trickle-resistor-ohms:0",
++					<&abx80x>,"abracon,tc-resistor";
++		wakeup-source = <&ds1339>,"wakeup-source?",
++				<&ds3231>,"wakeup-source?",
++				<&mcp7940x>,"wakeup-source?",
++					<&mcp7941x>,"wakeup-source?";
++		i2c_gpio_sda = <&i2c_gpio>,"gpios:4";
++		i2c_gpio_scl = <&i2c_gpio>,"gpios:16";
++		i2c_gpio_delay_us = <&i2c_gpio>,"i2c-gpio,delay-us:0";
++	};
++};
+diff --git a/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts b/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts
+new file mode 100644
+index 0000000000000000000000000000000000000000..6140f172a86b8731782f938f76cb5dac9f28b662
+--- /dev/null
++++ b/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts
+@@ -0,0 +1,164 @@
++// Definitions for several I2C based Real Time Clocks
++/dts-v1/;
++/plugin/;
++
++/ {
++	compatible = "brcm,bcm2708";
++
++	fragment@0 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			abx80x: abx80x@69 {
++				compatible = "abracon,abx80x";
++				reg = <0x69>;
++				abracon,tc-diode = "standard";
++				abracon,tc-resistor = <0>;
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@1 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			ds1307: ds1307@68 {
++				compatible = "maxim,ds1307";
++				reg = <0x68>;
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@2 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			ds1339: ds1339@68 {
++				compatible = "dallas,ds1339";
++				trickle-resistor-ohms = <0>;
++				reg = <0x68>;
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@3 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
 +			ds3231: ds3231@68 {
 +				compatible = "maxim,ds3231";
 +				reg = <0x68>;
-+				status = "disable";
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@4 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			mcp7940x: mcp7940x@6f {
++				compatible = "microchip,mcp7940x";
++				reg = <0x6f>;
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@5 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			mcp7941x: mcp7941x@6f {
++				compatible = "microchip,mcp7941x";
++				reg = <0x6f>;
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@6 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
 +			pcf2127: pcf2127@51 {
 +				compatible = "nxp,pcf2127";
 +				reg = <0x51>;
-+				status = "disable";
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@7 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
 +			pcf8523: pcf8523@68 {
 +				compatible = "nxp,pcf8523";
 +				reg = <0x68>;
-+				status = "disable";
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@8 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
 +			pcf8563: pcf8563@51 {
 +				compatible = "nxp,pcf8563";
 +				reg = <0x51>;
-+				status = "disable";
++				status = "okay";
 +			};
 +		};
 +	};
++
 +	__overrides__ {
-+		abx80x = <&abx80x>,"status";
-+		ds1307 = <&ds1307>,"status";
-+		ds1339 = <&ds1339>,"status";
-+		ds3231 = <&ds3231>,"status";
-+		mcp7940x = <&mcp7940x>,"status";
-+		mcp7941x = <&mcp7941x>,"status";
-+		pcf2127 = <&pcf2127>,"status";
-+		pcf8523 = <&pcf8523>,"status";
-+		pcf8563 = <&pcf8563>,"status";
++		abx80x = <0>,"+0";
++		ds1307 = <0>,"+1";
++		ds1339 = <0>,"+2";
++		ds3231 = <0>,"+3";
++		mcp7940x = <0>,"+4";
++		mcp7941x = <0>,"+5";
++		pcf2127 = <0>,"+6";
++		pcf8523 = <0>,"+7";
++		pcf8563 = <0>,"+8";
 +		trickle-diode-type = <&abx80x>,"abracon,tc-diode";
 +		trickle-resistor-ohms = <&ds1339>,"trickle-resistor-ohms:0",
 +					<&abx80x>,"abracon,tc-resistor";
@@ -88379,11 +89471,11 @@ index 0000000000000000000000000000000000000000..1efcf0b712c9c5c19210545002ac1f09
 +};
 diff --git a/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
 new file mode 100644
-index 0000000000000000000000000000000000000000..606b2d5012abf2e85712be631c42ea40a0b512c5
+index 0000000000000000000000000000000000000000..17c27e3b666a7a83619471b50c63bb93836653c5
 --- /dev/null
 +++ b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-@@ -0,0 +1,49 @@
-+// Definitions for I2C based sensors using the Industrial IO interface.
+@@ -0,0 +1,142 @@
++// Definitions for I2C based sensors using the Industrial IO or HWMON interface.
 +/dts-v1/;
 +/plugin/;
 +
@@ -88392,7 +89484,22 @@ index 0000000000000000000000000000000000000000..606b2d5012abf2e85712be631c42ea40
 +
 +	fragment@0 {
 +		target = <&i2c_arm>;
-+		__overlay__ {
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			bme280: bme280@76 {
++				compatible = "bosch,bme280";
++				reg = <0x76>;
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@1 {
++		target = <&i2c_arm>;
++		__dormant__ {
 +			#address-cells = <1>;
 +			#size-cells = <0>;
 +			status = "okay";
@@ -88401,35 +89508,113 @@ index 0000000000000000000000000000000000000000..606b2d5012abf2e85712be631c42ea40
 +				compatible = "bosch,bmp085";
 +				reg = <0x77>;
 +				default-oversampling = <3>;
-+				status = "disable";
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@2 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			bmp180: bmp180@77 {
++				compatible = "bosch,bmp180";
++				reg = <0x77>;
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@3 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
 +
 +			bmp280: bmp280@76 {
 +				compatible = "bosch,bmp280";
 +				reg = <0x76>;
-+				status = "disable";
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@4 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			htu21: htu21@40 {
++				compatible = "htu21";
++				reg = <0x40>;
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@5 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
 +
 +			lm75: lm75@4f {
 +				compatible = "lm75";
 +				reg = <0x4f>;
-+				status = "disable";
++				status = "okay";
 +			};
++		};
++	};
++
++	fragment@6 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
 +
 +			si7020: si7020@40 {
 +				compatible = "si7020";
 +				reg = <0x40>;
-+				status = "disable";
++				status = "okay";
++			};
++		};
++	};
++
++	fragment@7 {
++		target = <&i2c_arm>;
++		__dormant__ {
++			#address-cells = <1>;
++			#size-cells = <0>;
++			status = "okay";
++
++			tmp102: tmp102@48 {
++				compatible = "ti,tmp102";
++				reg = <0x48>;
++				status = "okay";
 +			};
 +		};
 +	};
 +
 +	__overrides__ {
-+		bmp085 = <&bmp085>,"status";
-+		bmp280 = <&bmp280>,"status";
-+		lm75 = <&lm75>,"status";
++		addr =  <&bme280>,"reg:0", <&bmp280>,"reg:0", <&tmp102>,"reg:0",
++			<&lm75>,"reg:0";
++		bme280 = <0>,"+0";
++		bmp085 = <0>,"+1";
++		bmp180 = <0>,"+2";
++		bmp280 = <0>,"+3";
++		htu21 = <0>,"+4";
++		lm75 = <0>,"+5";
 +		lm75addr = <&lm75>,"reg:0";
-+		si7020 = <&si7020>,"status";
++		si7020 = <0>,"+6";
++		tmp102 = <0>,"+7";
 +	};
 +};
 diff --git a/arch/arm/boot/dts/overlays/i2c0-bcm2708-overlay.dts b/arch/arm/boot/dts/overlays/i2c0-bcm2708-overlay.dts
@@ -88501,10 +89686,10 @@ index 0000000000000000000000000000000000000000..1f4fc7b570604a50ff6d3f6d676c3c46
 +};
 diff --git a/arch/arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts b/arch/arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts
 new file mode 100644
-index 0000000000000000000000000000000000000000..e303b9c61c82a28eab7b48f6b085661574d5a849
+index 0000000000000000000000000000000000000000..7c69047bcd88a5c900dddd08e60ad0750b96d785
 --- /dev/null
 +++ b/arch/arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts
-@@ -0,0 +1,37 @@
+@@ -0,0 +1,34 @@
 +/*
 + * Device tree overlay for i2c_bcm2708, i2c1 bus
 + *
@@ -88527,19 +89712,16 @@ index 0000000000000000000000000000000000000000..e303b9c61c82a28eab7b48f6b0856615
 +   };
 +
 +   fragment@1 {
-+      target = <&gpio>;
-+      __overlay__ {
-+         i2c1_pins: i2c1 {
-+            brcm,pins = <2 3>;
-+            brcm,function = <4>; /* alt0 */
-+         };
++      target = <&i2c1_pins>;
++         pins: __overlay__ {
++         brcm,pins = <2 3>;
++         brcm,function = <4>; /* alt 0 */
 +      };
 +   };
-+
 +   __overrides__ {
-+      sda1_pin = <&i2c1_pins>,"brcm,pins:0";
-+      scl1_pin = <&i2c1_pins>,"brcm,pins:4";
-+      pin_func = <&i2c1_pins>,"brcm,function:0";
++      sda1_pin = <&pins>,"brcm,pins:0";
++      scl1_pin = <&pins>,"brcm,pins:4";
++      pin_func = <&pins>,"brcm,function:0";
 +   };
 +};
 diff --git a/arch/arm/boot/dts/overlays/i2s-gpio28-31-overlay.dts b/arch/arm/boot/dts/overlays/i2s-gpio28-31-overlay.dts
@@ -90097,6 +91279,55 @@ index 0000000000000000000000000000000000000000..565af7cf79d761877be3bd06191f31aa
 +		};
 +	};
 +};
+diff --git a/arch/arm/boot/dts/overlays/midi-uart1-overlay.dts b/arch/arm/boot/dts/overlays/midi-uart1-overlay.dts
+new file mode 100644
+index 0000000000000000000000000000000000000000..e0bc410acbff3a7a175dd5d53b3ab0d0802e8239
+--- /dev/null
++++ b/arch/arm/boot/dts/overlays/midi-uart1-overlay.dts
+@@ -0,0 +1,43 @@
++/dts-v1/;
++/plugin/;
++
++#include <dt-bindings/clock/bcm2835-aux.h>
++
++/*
++ * Fake a higher clock rate to get a larger divisor, and thereby a lower
++ * baudrate. The real clock is 48MHz, which we scale so that requesting
++ * 38.4kHz results in an actual 31.25kHz.
++ *
++ *   48000000*38400/31250 = 58982400
++ */
++
++/{
++	compatible = "brcm,bcm2835";
++
++	fragment@0 {
++		target-path = "/clocks";
++		__overlay__ {
++			midi_clk: clock@5 {
++				compatible = "fixed-factor-clock";
++				#clock-cells = <0>;
++				clocks = <&aux BCM2835_AUX_CLOCK_UART>;
++				clock-mult = <38400>;
++				clock-div  = <31250>;
++			};
++		};
++	};
++
++	fragment@1 {
++		target = <&uart1>;
++		__overlay__ {
++			clocks = <&midi_clk>;
++		};
++	};
++
++	fragment@2 {
++		target = <&aux>;
++		__overlay__ {
++			clock-output-names = "aux_uart", "aux_spi1", "aux_spi2";
++		};
++	};
++};
 diff --git a/arch/arm/boot/dts/overlays/mmc-overlay.dts b/arch/arm/boot/dts/overlays/mmc-overlay.dts
 new file mode 100644
 index 0000000000000000000000000000000000000000..88251ad653917674f80c2975de2e425fca00b71f
@@ -90142,6 +91373,40 @@ index 0000000000000000000000000000000000000000..88251ad653917674f80c2975de2e425f
 +		overclock_50     = <&frag0>,"brcm,overclock-50:0";
 +	};
 +};
+diff --git a/arch/arm/boot/dts/overlays/mpu6050-overlay.dts b/arch/arm/boot/dts/overlays/mpu6050-overlay.dts
+new file mode 100644
+index 0000000000000000000000000000000000000000..06037969c3abba270b3cad45875342f3c730506e
+--- /dev/null
++++ b/arch/arm/boot/dts/overlays/mpu6050-overlay.dts
+@@ -0,0 +1,28 @@
++// Definitions for MPU6050
++/dts-v1/;
++/plugin/;
++
++/ {
++        compatible = "brcm,bcm2708";
++
++        fragment@0 {
++                target = <&i2c1>;
++                __overlay__ {
++                        #address-cells = <1>;
++                        #size-cells = <0>;
++                        status = "okay";
++                        clock-frequency = <400000>;
++
++                        mpu6050: mpu6050@68 {
++                                compatible = "invensense,mpu6050";
++                                reg = <0x68>;
++                                interrupt-parent = <&gpio>;
++                                interrupts = <4 1>;
++                        };
++                };
++        };
++
++        __overrides__ {
++                interrupt = <&mpu6050>,"interrupts:0";
++        };
++};
 diff --git a/arch/arm/boot/dts/overlays/mz61581-overlay.dts b/arch/arm/boot/dts/overlays/mz61581-overlay.dts
 new file mode 100644
 index 0000000000000000000000000000000000000000..2c29aaed44c5959d7f0df2a3baf2af052b24b6b4
@@ -91467,6 +92732,55 @@ index 0000000000000000000000000000000000000000..2c3c97813f22c94eff6da2193aff0920
 +		};
 +	};
 +};
+diff --git a/arch/arm/boot/dts/overlays/rotary-encoder-overlay.dts b/arch/arm/boot/dts/overlays/rotary-encoder-overlay.dts
+new file mode 100644
+index 0000000000000000000000000000000000000000..c0c6bccff60cc15d9a9bf59d2c7cba41eb9c1cdc
+--- /dev/null
++++ b/arch/arm/boot/dts/overlays/rotary-encoder-overlay.dts
+@@ -0,0 +1,43 @@
++// Device tree overlay for GPIO connected rotary encoder.
++/dts-v1/;
++/plugin/;
++
++/ {
++	compatible = "brcm,bcm2708";
++
++	fragment@0 {
++		target = <&gpio>;
++		__overlay__ {
++			rotary0_pins: rotary0_pins {
++				brcm,pins = <4 17>; /* gpio 4 17 */
++				brcm,function = <0 0>; /* input */
++				brcm,pull = <2 2>; /* pull-up */
++			};
++
++		};
++	};
++
++	fragment@1 {
++		target-path = "/";
++		__overlay__ {
++			rotary0: rotary@0 {
++					compatible = "rotary-encoder";
++					status = "okay";
++					pinctrl-names = "default";
++					pinctrl-0 = <&rotary0_pins>;
++					gpios = <&gpio 4 0>, <&gpio 17 0>;
++					linux,axis = <0>; /* REL_X */
++					rotary-encoder,encoding = "gray";
++					rotary-encoder,relative-axis;
++			};
++		};
++
++	};  
++
++	__overrides__ {
++		rotary0_pin_a = <&rotary0>,"gpios:4",
++				<&rotary0_pins>,"brcm,pins:0";
++		rotary0_pin_b = <&rotary0>,"gpios:16",
++				<&rotary0_pins>,"brcm,pins:4";
++	};  
++};
 diff --git a/arch/arm/boot/dts/overlays/rpi-backlight-overlay.dts b/arch/arm/boot/dts/overlays/rpi-backlight-overlay.dts
 new file mode 100644
 index 0000000000000000000000000000000000000000..c021d02bb75ff5ceb5c5066d00e4bca942554032
@@ -93267,7 +94581,7 @@ index 0000000000000000000000000000000000000000..fa73e1feaeb1bf53a6755e81a998e71c
 +};
 diff --git a/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts b/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts
 new file mode 100644
-index 0000000000000000000000000000000000000000..95a595a35cb4fbb707bf4b18161f6a46860aa4ae
+index 0000000000000000000000000000000000000000..36fbf6c8c2e612a6dc5aa02d77cc8173098c16ca
 --- /dev/null
 +++ b/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts
 @@ -0,0 +1,89 @@
@@ -93284,35 +94598,35 @@ index 0000000000000000000000000000000000000000..95a595a35cb4fbb707bf4b18161f6a46
 +	fragment@0 {
 +		target-path = "/chosen";
 +		__overlay__ {
-+			bootargs = "cma=256M@256M";
++			bootargs = "cma=256M";
 +		};
 +	};
 +
 +	fragment@1 {
 +		target-path = "/chosen";
 +		__dormant__ {
-+			bootargs = "cma=192M@256M";
++			bootargs = "cma=192M";
 +		};
 +	};
 +
 +	fragment@2 {
 +		target-path = "/chosen";
 +		__dormant__ {
-+			bootargs = "cma=128M@128M";
++			bootargs = "cma=128M";
 +		};
 +	};
 +
 +	fragment@3 {
 +		target-path = "/chosen";
 +		__dormant__ {
-+			bootargs = "cma=96M@128M";
++			bootargs = "cma=96M";
 +		};
 +	};
 +
 +	fragment@4 {
 +		target-path = "/chosen";
 +		__dormant__ {
-+			bootargs = "cma=64M@64M";
++			bootargs = "cma=64M";
 +		};
 +	};
 +
@@ -93728,10 +95042,10 @@ index 993fb85982df2df2a7f8e20780d0cfbe3cb732e8..b44d8c993f1d347908b0a97525c8ff60
  
  .PHONY: $(PHONY)
 diff --git a/scripts/Makefile.lib b/scripts/Makefile.lib
-index 58c05e5d9870b6c18a72da7dc44ff3112994946d..9842523b225a88505d796cc689c04f40359eaf3d 100644
+index 5e975fee0f5b44343807d2f4e92954cb521497dc..3cf3f3eef6abdac2695d321c3d1bbc94fbe6f2da 100644
 --- a/scripts/Makefile.lib
 +++ b/scripts/Makefile.lib
-@@ -324,6 +324,17 @@ cmd_dtc = mkdir -p $(dir ${dtc-tmp}) ; \
+@@ -315,6 +315,17 @@ cmd_dtc = mkdir -p $(dir ${dtc-tmp}) ; \
  $(obj)/%.dtb: $(src)/%.dts FORCE
  	$(call if_changed_dep,dtc)
  
@@ -93750,10 +95064,10 @@ index 58c05e5d9870b6c18a72da7dc44ff3112994946d..9842523b225a88505d796cc689c04f40
  
  # Bzip2
 
-From 6b4c72c0307a6de6dda6ffae1eae88bf174ccd52 Mon Sep 17 00:00:00 2001
+From 4ddd349728b2a193e05c1249d483d6f17e95c868 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Fri, 6 Feb 2015 13:50:57 +0000
-Subject: [PATCH 053/173] BCM270x_DT: Add pwr_led, and the required "input"
+Subject: [PATCH 055/126] BCM270x_DT: Add pwr_led, and the required "input"
  trigger
 
 The "input" trigger makes the associated GPIO an input.  This is to support
@@ -93783,7 +95097,7 @@ See: https://github.com/raspberrypi/linux/issues/1064
  create mode 100644 drivers/leds/trigger/ledtrig-input.c
 
 diff --git a/drivers/leds/leds-gpio.c b/drivers/leds/leds-gpio.c
-index e753ba93ba1e544986f1774d9c33c45aab23a996..809a63b02443b25113f5f134150972d280c49bc5 100644
+index 764c31301f903cef5d785a4adf49b4056df0dc2d..9544067cafa5553a4396b68c568838f271a3d105 100644
 --- a/drivers/leds/leds-gpio.c
 +++ b/drivers/leds/leds-gpio.c
 @@ -50,8 +50,15 @@ static void gpio_led_set(struct led_classdev *led_cdev,
@@ -93914,13 +95228,13 @@ index 0000000000000000000000000000000000000000..27f8ebea43d86fc51c98db5c953da05b
 +MODULE_DESCRIPTION("Set LED GPIO to Input \"trigger\"");
 +MODULE_LICENSE("GPL");
 diff --git a/include/linux/leds.h b/include/linux/leds.h
-index 64c56d454f7df9f864a5242ce4212df586f66886..3fd74c8737871cb56f0355c858fc135e1188c1f8 100644
+index bf6db4fe895bcd67e04ee65e8f76ea104af6299f..8741dca6dba65e2d72fbdbc1702139c2c09981f2 100644
 --- a/include/linux/leds.h
 +++ b/include/linux/leds.h
-@@ -49,6 +49,9 @@ struct led_classdev {
- #define LED_HW_PLUGGABLE	(1 << 19)
+@@ -50,6 +50,9 @@ struct led_classdev {
  #define LED_PANIC_INDICATOR	(1 << 20)
  #define LED_BRIGHT_HW_CHANGED	(1 << 21)
+ #define LED_RETAIN_AT_SHUTDOWN	(1 << 22)
 +	/* Additions for Raspberry Pi PWR LED */
 +#define SET_GPIO_INPUT		(1 << 30)
 +#define SET_GPIO_OUTPUT		(1 << 31)
@@ -93928,10 +95242,10 @@ index 64c56d454f7df9f864a5242ce4212df586f66886..3fd74c8737871cb56f0355c858fc135e
  	/* set_brightness_work / blink_timer flags, atomic, private. */
  	unsigned long		work_flags;
 
-From d1c26c42c63b3606fd7951c008b83864621ffc3f Mon Sep 17 00:00:00 2001
+From dc5d5f55601228b7d15316b5f3f351cad1ca7231 Mon Sep 17 00:00:00 2001
 From: Siarhei Siamashka <siarhei.siamashka@gmail.com>
 Date: Mon, 17 Jun 2013 13:32:11 +0300
-Subject: [PATCH 054/173] fbdev: add FBIOCOPYAREA ioctl
+Subject: [PATCH 056/126] fbdev: add FBIOCOPYAREA ioctl
 
 Based on the patch authored by Ali Gholami Rudi at
     https://lkml.org/lkml/2009/7/13/153
@@ -94101,10 +95415,10 @@ index 37f60813fe1dd95d9f5f725c07ec2e75c09857bf..a048c964b11508042ffc582f452f2a4c
  	if (ret == 0) {
  		platform_set_drvdata(dev, fb);
 diff --git a/drivers/video/fbdev/core/fbmem.c b/drivers/video/fbdev/core/fbmem.c
-index 7a42238db446b0093323505b710963ac94a53e15..6e3be5680f33a564cebec408d1e15ffddbe0f890 100644
+index f741ba8df01b8e28f4331f988d2b04219bb103b6..be8c43d62698a426504642a2b51ffd71b2ac90e8 100644
 --- a/drivers/video/fbdev/core/fbmem.c
 +++ b/drivers/video/fbdev/core/fbmem.c
-@@ -1084,6 +1084,31 @@ fb_blank(struct fb_info *info, int blank)
+@@ -1086,6 +1086,31 @@ fb_blank(struct fb_info *info, int blank)
  }
  EXPORT_SYMBOL(fb_blank);
  
@@ -94136,7 +95450,7 @@ index 7a42238db446b0093323505b710963ac94a53e15..6e3be5680f33a564cebec408d1e15ffd
  static long do_fb_ioctl(struct fb_info *info, unsigned int cmd,
  			unsigned long arg)
  {
-@@ -1094,6 +1119,7 @@ static long do_fb_ioctl(struct fb_info *info, unsigned int cmd,
+@@ -1096,6 +1121,7 @@ static long do_fb_ioctl(struct fb_info *info, unsigned int cmd,
  	struct fb_cmap cmap_from;
  	struct fb_cmap_user cmap;
  	struct fb_event event;
@@ -94144,7 +95458,7 @@ index 7a42238db446b0093323505b710963ac94a53e15..6e3be5680f33a564cebec408d1e15ffd
  	void __user *argp = (void __user *)arg;
  	long ret = 0;
  
-@@ -1211,6 +1237,15 @@ static long do_fb_ioctl(struct fb_info *info, unsigned int cmd,
+@@ -1213,6 +1239,15 @@ static long do_fb_ioctl(struct fb_info *info, unsigned int cmd,
  		unlock_fb_info(info);
  		console_unlock();
  		break;
@@ -94160,7 +95474,7 @@ index 7a42238db446b0093323505b710963ac94a53e15..6e3be5680f33a564cebec408d1e15ffd
  	default:
  		if (!lock_fb_info(info))
  			return -ENODEV;
-@@ -1356,6 +1391,7 @@ static long fb_compat_ioctl(struct file *file, unsigned int cmd,
+@@ -1358,6 +1393,7 @@ static long fb_compat_ioctl(struct file *file, unsigned int cmd,
  	case FBIOPAN_DISPLAY:
  	case FBIOGET_CON2FBMAP:
  	case FBIOPUT_CON2FBMAP:
@@ -94199,10 +95513,10 @@ index fb795c3b3c178ad3cd7c9e9e4547ffd492bac181..703fa8a70574323abe2fb32599254582
  	__u32 dx;	/* screen-relative */
  	__u32 dy;
 
-From 9c7384a03b7b1f487a69293d8dc3b1a3b70ddb9d Mon Sep 17 00:00:00 2001
+From 7182d90559f9d9a5a912de8fba3263c13f09b43c Mon Sep 17 00:00:00 2001
 From: Harm Hanemaaijer <fgenfb@yahoo.com>
 Date: Thu, 20 Jun 2013 20:21:39 +0200
-Subject: [PATCH 055/173] Speed up console framebuffer imageblit function
+Subject: [PATCH 057/126] Speed up console framebuffer imageblit function
 
 Especially on platforms with a slower CPU but a relatively high
 framebuffer fill bandwidth, like current ARM devices, the existing
@@ -94411,10 +95725,10 @@ index a2bb276a8b2463eee98eb237c4647bc00cd93601..436494fba15abecb400ef28688466faf
  					start_index, pitch_index);
  	} else
 
-From d0718fee7b3a522e9660f108423528f001c88049 Mon Sep 17 00:00:00 2001
+From f0af3ff1cc08b1926b72a27cd5394824c3df1de1 Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Wed, 8 May 2013 11:46:50 +0100
-Subject: [PATCH 056/173] enabling the realtime clock 1-wire chip DS1307 and
+Subject: [PATCH 058/126] enabling the realtime clock 1-wire chip DS1307 and
  1-wire on GPIO4 (as a module)
 
 1-wire: Add support for configuring pin for w1-gpio kernel module
@@ -94647,10 +95961,10 @@ index d58594a3232492e33f1dd4babd3798b03e0f0203..feae94256256316fd9d850c3d83325af
  	unsigned int ext_pullup_enable_pin;
  	unsigned int pullup_duration;
 diff --git a/include/linux/w1.h b/include/linux/w1.h
-index 90cbe7e65059f6b604a87c6bf39cd9bbeae7684c..a52be51ee0a5511a75d4eaa8dacaec5e131ebdcf 100644
+index 5b2972946dda5f9ad415f1eaeaab67743a5cc0f0..b3558b7c9efb2484b40e31312aee197b824b9306 100644
 --- a/include/linux/w1.h
 +++ b/include/linux/w1.h
-@@ -155,6 +155,12 @@ struct w1_bus_master {
+@@ -157,6 +157,12 @@ struct w1_bus_master {
  
  	u8		(*set_pullup)(void *, int);
  
@@ -94664,10 +95978,10 @@ index 90cbe7e65059f6b604a87c6bf39cd9bbeae7684c..a52be51ee0a5511a75d4eaa8dacaec5e
  		u8, w1_slave_found_callback);
  };
 
-From be35652a05671e3011baea91e94db18e7ea6a384 Mon Sep 17 00:00:00 2001
+From b09e73358fa9c869db4dd0f0ece58d5c0ca5674b Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Mon, 14 Jul 2014 22:02:09 +0100
-Subject: [PATCH 057/173] hid: Reduce default mouse polling interval to 60Hz
+Subject: [PATCH 059/126] hid: Reduce default mouse polling interval to 60Hz
 
 Reduces overhead when using X
 ---
@@ -94675,7 +95989,7 @@ Reduces overhead when using X
  1 file changed, 4 insertions(+), 2 deletions(-)
 
 diff --git a/drivers/hid/usbhid/hid-core.c b/drivers/hid/usbhid/hid-core.c
-index c008847e0b20a2accb00451b10fb1c648f67925b..4a86428a3b4e3d51e9ac6ce9c9c1109773a10da9 100644
+index 089bad8a9a21d6b35742df8819fabb4da5036730..c18a6e634e5f0760339990554d7905029dc3644f 100644
 --- a/drivers/hid/usbhid/hid-core.c
 +++ b/drivers/hid/usbhid/hid-core.c
 @@ -48,7 +48,7 @@
@@ -94699,10 +96013,10 @@ index c008847e0b20a2accb00451b10fb1c648f67925b..4a86428a3b4e3d51e9ac6ce9c9c11097
  			break;
  		case HID_GD_JOYSTICK:
 
-From 2ed02be91b7155dbe5d0c0a850bf761d8150806a Mon Sep 17 00:00:00 2001
+From ee65f476e9ec757930f6f82e5824c8088a961028 Mon Sep 17 00:00:00 2001
 From: Gordon Hollingworth <gordon@raspberrypi.org>
 Date: Tue, 12 May 2015 14:47:56 +0100
-Subject: [PATCH 058/173] rpi-ft5406: Add touchscreen driver for pi LCD display
+Subject: [PATCH 060/126] rpi-ft5406: Add touchscreen driver for pi LCD display
 
 Fix driver detection failure Check that the buffer response is non-zero meaning the touchscreen was detected
 
@@ -95060,10 +96374,10 @@ index 30fb37fe175df604a738258a2a632bca3bfff33f..4a3d79d3b48eb483a4e4bf498f617515
  	RPI_FIRMWARE_FRAMEBUFFER_SET_BACKLIGHT =              0x0004800f,
  
 
-From 9c0b94406c5c1ec11a41bf9b2710051c36ce70e8 Mon Sep 17 00:00:00 2001
+From afbffe8b319ba45bf223849ae2a0f28f18e078c4 Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Mon, 28 Nov 2016 16:50:04 +0000
-Subject: [PATCH 059/173] Improve __copy_to_user and __copy_from_user
+Subject: [PATCH 061/126] Improve __copy_to_user and __copy_from_user
  performance
 
 Provide a __copy_from_user that uses memcpy. On BCM2708, use
@@ -95105,12 +96419,12 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  create mode 100644 arch/arm/lib/memset_rpi.S
 
 diff --git a/arch/arm/include/asm/string.h b/arch/arm/include/asm/string.h
-index cf4f3aad0fc1c2154c6cf3839ff21bb1c46d6499..d69b70a6007dfc647ad164d1ee90d253c0686dee 100644
+index fe1c6af3a1b1a4cab35c6d125b43262d3d21fd85..54b40c9cc5f091a7aa77515321782bb2adedbc57 100644
 --- a/arch/arm/include/asm/string.h
 +++ b/arch/arm/include/asm/string.h
-@@ -24,6 +24,11 @@ extern void * memchr(const void *, int, __kernel_size_t);
- #define __HAVE_ARCH_MEMSET
- extern void * memset(void *, int, __kernel_size_t);
+@@ -38,6 +38,11 @@ static inline void *memset64(uint64_t *p, uint64_t v, __kernel_size_t n)
+ 	return __memset64(p, v, n * 8, v >> 32);
+ }
  
 +#ifdef CONFIG_BCM2835_FAST_MEMCPY
 +#define __HAVE_ARCH_MEMCMP
@@ -95121,10 +96435,10 @@ index cf4f3aad0fc1c2154c6cf3839ff21bb1c46d6499..d69b70a6007dfc647ad164d1ee90d253
  
  #define memset(p,v,n)							\
 diff --git a/arch/arm/include/asm/uaccess.h b/arch/arm/include/asm/uaccess.h
-index 0bf2347495f13e4db7fdc1c560b0976ec1fbd619..6c7927ab1a47a0bd24241772ed1dcb3e37827e61 100644
+index 87936dd5d1510572993d4bcc9b4fa1222a4dd3b2..17da428d0574b11de7551956b2896ea04d5d4273 100644
 --- a/arch/arm/include/asm/uaccess.h
 +++ b/arch/arm/include/asm/uaccess.h
-@@ -447,6 +447,9 @@ do {									\
+@@ -449,6 +449,9 @@ do {									\
  extern unsigned long __must_check
  arm_copy_from_user(void *to, const void __user *from, unsigned long n);
  
@@ -96638,10 +97952,10 @@ index 17ec37811c32f09126ed42753037e055c5cec115..c08f81812d0d56a0d90c1eb6777d0622
  	bool "Broadcom BCM63xx DSL SoC"
  	depends on ARCH_MULTI_V7
 
-From 348a5e09f4bb1417fe37049c1334664d6dc4b5f3 Mon Sep 17 00:00:00 2001
+From 7a7b3ed1de8b25ddb176d96d5d58b5225220f11a Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Thu, 25 Jun 2015 12:16:11 +0100
-Subject: [PATCH 060/173] gpio-poweroff: Allow it to work on Raspberry Pi
+Subject: [PATCH 062/126] gpio-poweroff: Allow it to work on Raspberry Pi
 
 The Raspberry Pi firmware manages the power-down and reboot
 process. To do this it installs a pm_power_off handler, causing
@@ -96676,10 +97990,10 @@ index be3d81ff51cc3f510d85e4eed7a52960e51e7bc1..a030ae9fb1fca325061c093696e82186
  			"%s: pm_power_off function already registered",
  		       __func__);
 
-From 90f2efe61b9ba3c4a3bb0aed6c5aa76484b6d899 Mon Sep 17 00:00:00 2001
+From 6433f2b13ea88f151e33d0ce633f915c05fc4b44 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <pelwell@users.noreply.github.com>
 Date: Tue, 14 Jul 2015 14:32:47 +0100
-Subject: [PATCH 061/173] mfd: Add Raspberry Pi Sense HAT core driver
+Subject: [PATCH 063/126] mfd: Add Raspberry Pi Sense HAT core driver
 
 ---
  drivers/input/joystick/Kconfig           |   8 +
@@ -96889,7 +98203,7 @@ index 0000000000000000000000000000000000000000..6a416769065d2198344792eb02d8e38d
 +MODULE_AUTHOR("Serge Schneider <serge@raspberrypi.org>");
 +MODULE_LICENSE("GPL");
 diff --git a/drivers/mfd/Kconfig b/drivers/mfd/Kconfig
-index 94ad2c1c3d9055df0b245e58db6dc4c9e9d9c2b2..19e45c8a6755d720b097c64bcb68c62747d54a22 100644
+index fc5e4fef89d222aa587473634bf056d9dee39578..ec1c7585650756c431538b78be7b6643831600e1 100644
 --- a/drivers/mfd/Kconfig
 +++ b/drivers/mfd/Kconfig
 @@ -10,6 +10,14 @@ config MFD_CORE
@@ -96908,11 +98222,11 @@ index 94ad2c1c3d9055df0b245e58db6dc4c9e9d9c2b2..19e45c8a6755d720b097c64bcb68c627
  	tristate "AMD CS5535 and CS5536 southbridge core functions"
  	select MFD_CORE
 diff --git a/drivers/mfd/Makefile b/drivers/mfd/Makefile
-index 080793b3fd0ed7dc8a903ebef3c1b05dbf5822c4..0dc5c6d0d3cf54d7b26ccedb33cb4d8f21dcf37f 100644
+index c3d0a1b39bb6512505814882c4fedbd04687e057..3c5c15accadefac5c1a799be01d95ba079627752 100644
 --- a/drivers/mfd/Makefile
 +++ b/drivers/mfd/Makefile
-@@ -223,3 +223,4 @@ obj-$(CONFIG_MFD_SUN4I_GPADC)	+= sun4i-gpadc.o
- 
+@@ -226,3 +226,4 @@ obj-$(CONFIG_MFD_SUN4I_GPADC)	+= sun4i-gpadc.o
+ obj-$(CONFIG_MFD_STM32_LPTIMER)	+= stm32-lptimer.o
  obj-$(CONFIG_MFD_STM32_TIMERS) 	+= stm32-timers.o
  obj-$(CONFIG_MFD_MXS_LRADC)     += mxs-lradc.o
 +obj-$(CONFIG_MFD_RPISENSE_CORE)	+= rpisense-core.o
@@ -97080,7 +98394,7 @@ index 0000000000000000000000000000000000000000..eea9312dc96a496ce846b0c5a83e6e4f
 +MODULE_LICENSE("GPL");
 +
 diff --git a/drivers/video/fbdev/Kconfig b/drivers/video/fbdev/Kconfig
-index 7b44601d1c58007cdb3adafdf5f3c33a0801b8c6..98f8998239199f01374f93260aeafa51c85bbb86 100644
+index 127978982287bf04b6ea215433bd905ed432aa2f..c20eade6598ba421633fabf03090691d32298393 100644
 --- a/drivers/video/fbdev/Kconfig
 +++ b/drivers/video/fbdev/Kconfig
 @@ -2510,3 +2510,16 @@ config FB_SM712
@@ -97544,10 +98858,10 @@ index 0000000000000000000000000000000000000000..56196dc2af10e464a1e3f98b028dca1c
 +
 +#endif
 
-From 0d38f30ad88b8ad88309340e9171341ce8e98831 Mon Sep 17 00:00:00 2001
+From eb6e9d1574195e3bcae06b33f937cf073f188f61 Mon Sep 17 00:00:00 2001
 From: Florian Meier <florian.meier@koalo.de>
 Date: Fri, 22 Nov 2013 19:19:08 +0100
-Subject: [PATCH 062/173] ASoC: Add support for HifiBerry DAC
+Subject: [PATCH 064/126] ASoC: Add support for HifiBerry DAC
 
 This adds a machine driver for the HifiBerry DAC.
 It is a sound card that can
@@ -97722,10 +99036,10 @@ index 0000000000000000000000000000000000000000..ee9f133953544629282631e5ef3f73fe
 +MODULE_DESCRIPTION("ASoC Driver for HifiBerry DAC");
 +MODULE_LICENSE("GPL v2");
 
-From 95d9c85a641399f9d3a569db4ea02029f9bf12c8 Mon Sep 17 00:00:00 2001
+From b9998485698b16cf9db4fcc113e9677706cc29c6 Mon Sep 17 00:00:00 2001
 From: Florian Meier <florian.meier@koalo.de>
 Date: Mon, 25 Jan 2016 15:48:59 +0000
-Subject: [PATCH 063/173] ASoC: Add support for Rpi-DAC
+Subject: [PATCH 065/126] ASoC: Add support for Rpi-DAC
 
 ---
  sound/soc/bcm/Kconfig       |   7 +++
@@ -97891,10 +99205,10 @@ index 0000000000000000000000000000000000000000..38224467cbab7d5be3be731e73e2cf78
 +MODULE_DESCRIPTION("ASoC Driver for RPi-DAC");
 +MODULE_LICENSE("GPL v2");
 diff --git a/sound/soc/codecs/Kconfig b/sound/soc/codecs/Kconfig
-index 6c78b0b49b8145c24740d93c4174c059d91ddae9..d8b8cf059e8730432c692e8ce4e4fb9f1269550a 100644
+index 91d5b531b69b49db97f7febbc60d33a20991cb0f..f81a4ee69d1c97d8ff8d04db567c057865a8805b 100644
 --- a/sound/soc/codecs/Kconfig
 +++ b/sound/soc/codecs/Kconfig
-@@ -108,6 +108,7 @@ config SND_SOC_ALL_CODECS
+@@ -109,6 +109,7 @@ config SND_SOC_ALL_CODECS
  	select SND_SOC_PCM1681 if I2C
  	select SND_SOC_PCM179X_I2C if I2C
  	select SND_SOC_PCM179X_SPI if SPI_MASTER
@@ -97902,7 +99216,7 @@ index 6c78b0b49b8145c24740d93c4174c059d91ddae9..d8b8cf059e8730432c692e8ce4e4fb9f
  	select SND_SOC_PCM3008
  	select SND_SOC_PCM3168A_I2C if I2C
  	select SND_SOC_PCM3168A_SPI if SPI_MASTER
-@@ -739,6 +740,10 @@ config SND_SOC_RT5616
+@@ -753,6 +754,10 @@ config SND_SOC_RT5616
  	tristate "Realtek RT5616 CODEC"
  	depends on I2C
  
@@ -97914,10 +99228,10 @@ index 6c78b0b49b8145c24740d93c4174c059d91ddae9..d8b8cf059e8730432c692e8ce4e4fb9f
  	tristate "Realtek ALC5631/RT5631 CODEC"
  	depends on I2C
 diff --git a/sound/soc/codecs/Makefile b/sound/soc/codecs/Makefile
-index 1755a54e3dc9379668de08326ed14b724fe4e4da..f1af18c2847a6c1bd3e0d97bcd42cc13aed24268 100644
+index 77c18189c9adb72244b91a5e657fb0393afc9117..b372c0ce9c77cf64eaa3e3878398bec565e3028f 100644
 --- a/sound/soc/codecs/Makefile
 +++ b/sound/soc/codecs/Makefile
-@@ -103,6 +103,7 @@ snd-soc-pcm1681-objs := pcm1681.o
+@@ -104,6 +104,7 @@ snd-soc-pcm1681-objs := pcm1681.o
  snd-soc-pcm179x-codec-objs := pcm179x.o
  snd-soc-pcm179x-i2c-objs := pcm179x-i2c.o
  snd-soc-pcm179x-spi-objs := pcm179x-spi.o
@@ -97925,14 +99239,14 @@ index 1755a54e3dc9379668de08326ed14b724fe4e4da..f1af18c2847a6c1bd3e0d97bcd42cc13
  snd-soc-pcm3008-objs := pcm3008.o
  snd-soc-pcm3168a-objs := pcm3168a.o
  snd-soc-pcm3168a-i2c-objs := pcm3168a-i2c.o
-@@ -347,6 +348,7 @@ obj-$(CONFIG_SND_SOC_PCM5102A)	+= snd-soc-pcm5102a.o
+@@ -352,6 +353,7 @@ obj-$(CONFIG_SND_SOC_PCM5102A)	+= snd-soc-pcm5102a.o
  obj-$(CONFIG_SND_SOC_PCM512x)	+= snd-soc-pcm512x.o
  obj-$(CONFIG_SND_SOC_PCM512x_I2C)	+= snd-soc-pcm512x-i2c.o
  obj-$(CONFIG_SND_SOC_PCM512x_SPI)	+= snd-soc-pcm512x-spi.o
 +obj-$(CONFIG_SND_SOC_PCM1794A)	+= snd-soc-pcm1794a.o
  obj-$(CONFIG_SND_SOC_RL6231)	+= snd-soc-rl6231.o
  obj-$(CONFIG_SND_SOC_RL6347A)	+= snd-soc-rl6347a.o
- obj-$(CONFIG_SND_SOC_RT286)	+= snd-soc-rt286.o
+ obj-$(CONFIG_SND_SOC_RT274)	+= snd-soc-rt274.o
 diff --git a/sound/soc/codecs/pcm1794a.c b/sound/soc/codecs/pcm1794a.c
 new file mode 100644
 index 0000000000000000000000000000000000000000..afe1b419582aa40c4b2729d242bb13cd843e17f4
@@ -98009,10 +99323,10 @@ index 0000000000000000000000000000000000000000..afe1b419582aa40c4b2729d242bb13cd
 +MODULE_AUTHOR("Florian Meier <florian.meier@koalo.de>");
 +MODULE_LICENSE("GPL v2");
 
-From 9fc26baae7c35ba5d07b9a95827d3228680c0705 Mon Sep 17 00:00:00 2001
+From a0ba62489cc9c14ed92fa987f4112ec74291cc05 Mon Sep 17 00:00:00 2001
 From: Daniel Matuschek <info@crazy-audio.com>
 Date: Wed, 15 Jan 2014 21:41:23 +0100
-Subject: [PATCH 064/173] ASoC: wm8804: Implement MCLK configuration options,
+Subject: [PATCH 066/126] ASoC: wm8804: Implement MCLK configuration options,
  add 32bit support WM8804 can run with PLL frequencies of 256xfs and 128xfs
  for most sample rates. At 192kHz only 128xfs is supported. The existing
  driver selects 128xfs automatically for some lower samples rates. By using an
@@ -98031,7 +99345,7 @@ Signed-off-by: Daniel Matuschek <daniel@matuschek.net>
  1 file changed, 3 insertions(+), 2 deletions(-)
 
 diff --git a/sound/soc/codecs/wm8804.c b/sound/soc/codecs/wm8804.c
-index af95d648265b3e92e345101542b332aee35191d4..513f56ba132929662802d15cdc653af3d059a39c 100644
+index fc69b87443d80489382b97332de6d5ad12a58ec8..d8fdce81b297dcf02e144bdead0c6193c0f5c24b 100644
 --- a/sound/soc/codecs/wm8804.c
 +++ b/sound/soc/codecs/wm8804.c
 @@ -304,6 +304,7 @@ static int wm8804_hw_params(struct snd_pcm_substream *substream,
@@ -98061,10 +99375,10 @@ index af95d648265b3e92e345101542b332aee35191d4..513f56ba132929662802d15cdc653af3
  	.component_driver = {
  		.dapm_widgets		= wm8804_dapm_widgets,
 
-From 37aa9704aff6efd6cb8c9593dab934a0896efa7b Mon Sep 17 00:00:00 2001
+From 21d5e7a1eb98d85b5c5ef7a6300585e961ed9e4c Mon Sep 17 00:00:00 2001
 From: Daniel Matuschek <info@crazy-audio.com>
 Date: Wed, 15 Jan 2014 21:42:08 +0100
-Subject: [PATCH 065/173] ASoC: BCM:Add support for HiFiBerry Digi. Driver is
+Subject: [PATCH 067/126] ASoC: BCM:Add support for HiFiBerry Digi. Driver is
  based on the patched WM8804 driver.
 
 Signed-off-by: Daniel Matuschek <daniel@matuschek.net>
@@ -98408,10 +99722,10 @@ index 0000000000000000000000000000000000000000..7620dd02de40b6d644ff038b445d375d
 +MODULE_DESCRIPTION("ASoC Driver for HifiBerry Digi");
 +MODULE_LICENSE("GPL v2");
 
-From 133a00f5a6cd57787cca59ab2f7913ba5e362517 Mon Sep 17 00:00:00 2001
+From 5ae24d6bf4f664e20c9bddac612b005c11549964 Mon Sep 17 00:00:00 2001
 From: Gordon Garrity <gordon@iqaudio.com>
 Date: Sat, 8 Mar 2014 16:56:57 +0000
-Subject: [PATCH 066/173] Add IQaudIO Sound Card support for Raspberry Pi
+Subject: [PATCH 068/126] Add IQaudIO Sound Card support for Raspberry Pi
 
 Set a limit of 0dB on Digital Volume Control
 
@@ -98746,10 +100060,10 @@ index 0000000000000000000000000000000000000000..1ee4097c846376666775272ed692ca33
 +MODULE_DESCRIPTION("ASoC Driver for IQAudio DAC");
 +MODULE_LICENSE("GPL v2");
 
-From b87d532365fca2082ac3b45e057010e60eb09bf9 Mon Sep 17 00:00:00 2001
+From f2ba03411f0b1952c343cb9a79053a0aafd7de3b Mon Sep 17 00:00:00 2001
 From: Daniel Matuschek <info@crazy-audio.com>
 Date: Mon, 4 Aug 2014 10:06:56 +0200
-Subject: [PATCH 067/173] Added support for HiFiBerry DAC+
+Subject: [PATCH 069/126] Added support for HiFiBerry DAC+
 
 The driver is based on the HiFiBerry DAC driver. However HiFiBerry DAC+ uses
 a different codec chip (PCM5122), therefore a new driver is necessary.
@@ -98786,17 +100100,17 @@ Signed-off-by: DigitalDreamtime <clive.messer@digitaldreamtime.co.uk>
  create mode 100644 sound/soc/bcm/hifiberry_dacplus.c
 
 diff --git a/drivers/clk/Makefile b/drivers/clk/Makefile
-index cd376b3fb47adc2bd87c64dddb7ec775e51f8e21..9f85909bcf0a17b9b575833ccf011cb0878b4147 100644
+index c99f363826f02f683c6018ddf02a0d4d3a58033f..4a6afc6403f737a977c6aab1647adf6a8fe69d4e 100644
 --- a/drivers/clk/Makefile
 +++ b/drivers/clk/Makefile
-@@ -27,6 +27,7 @@ obj-$(CONFIG_COMMON_CLK_CS2000_CP)	+= clk-cs2000-cp.o
- obj-$(CONFIG_ARCH_EFM32)		+= clk-efm32gg.o
+@@ -28,6 +28,7 @@ obj-$(CONFIG_ARCH_EFM32)		+= clk-efm32gg.o
  obj-$(CONFIG_COMMON_CLK_GEMINI)		+= clk-gemini.o
  obj-$(CONFIG_ARCH_HIGHBANK)		+= clk-highbank.o
+ obj-$(CONFIG_CLK_HSDK)			+= clk-hsdk-pll.o
 +obj-$(CONFIG_SND_BCM2708_SOC_HIFIBERRY_DACPLUS) += clk-hifiberry-dacpro.o
  obj-$(CONFIG_COMMON_CLK_MAX77686)	+= clk-max77686.o
- obj-$(CONFIG_ARCH_MB86S7X)		+= clk-mb86s7x.o
  obj-$(CONFIG_ARCH_MOXART)		+= clk-moxart.o
+ obj-$(CONFIG_ARCH_NOMADIK)		+= clk-nomadik.o
 diff --git a/drivers/clk/clk-hifiberry-dacpro.c b/drivers/clk/clk-hifiberry-dacpro.c
 new file mode 100644
 index 0000000000000000000000000000000000000000..99cee2b1706c43170b4fc35c0023349b9019606c
@@ -99365,10 +100679,10 @@ index 0000000000000000000000000000000000000000..b7b401cbe2b0d510d8b12d2dda6d5ff1
 +MODULE_DESCRIPTION("ASoC Driver for HiFiBerry DAC+");
 +MODULE_LICENSE("GPL v2");
 diff --git a/sound/soc/codecs/pcm512x.c b/sound/soc/codecs/pcm512x.c
-index 72b19e62f6267698aea45d2410d616d91c1825cb..c6839ef6e16754ed9de2698507b8986addd822fe 100644
+index 68feae262476492ae3a0b30855dbb09e96fa187e..f7b0977017ed5a6c02eafa0147d49d66876537bf 100644
 --- a/sound/soc/codecs/pcm512x.c
 +++ b/sound/soc/codecs/pcm512x.c
-@@ -854,7 +854,8 @@ static int pcm512x_set_dividers(struct snd_soc_dai *dai,
+@@ -851,7 +851,8 @@ static int pcm512x_set_dividers(struct snd_soc_dai *dai,
  	int fssp;
  	int gpio;
  
@@ -99379,10 +100693,10 @@ index 72b19e62f6267698aea45d2410d616d91c1825cb..c6839ef6e16754ed9de2698507b8986a
  		dev_err(dev, "No LRCLK?\n");
  		return -EINVAL;
 
-From 563426f03b8ebee2e70b8b1d0027329348b5d05c Mon Sep 17 00:00:00 2001
+From ec8cd527456da750b7f208e5fec74d5f5848c99f Mon Sep 17 00:00:00 2001
 From: Daniel Matuschek <info@crazy-audio.com>
 Date: Mon, 4 Aug 2014 11:09:58 +0200
-Subject: [PATCH 068/173] Added driver for HiFiBerry Amp amplifier add-on board
+Subject: [PATCH 070/126] Added driver for HiFiBerry Amp amplifier add-on board
 
 The driver contains a low-level hardware driver for the TAS5713 and the
 drivers for the Raspberry Pi I2S subsystem.
@@ -99582,10 +100896,10 @@ index 0000000000000000000000000000000000000000..221c6c38e6465ffe5d5ad77fa80a0b14
 +MODULE_DESCRIPTION("ASoC driver for HiFiBerry-AMP");
 +MODULE_LICENSE("GPL v2");
 diff --git a/sound/soc/codecs/Kconfig b/sound/soc/codecs/Kconfig
-index d8b8cf059e8730432c692e8ce4e4fb9f1269550a..aca3a53f08dba8762307f7c25a5d7c5561b9cf71 100644
+index f81a4ee69d1c97d8ff8d04db567c057865a8805b..b3c63d86e5ef67c9f98031fcbf423ca16b3700ca 100644
 --- a/sound/soc/codecs/Kconfig
 +++ b/sound/soc/codecs/Kconfig
-@@ -150,6 +150,7 @@ config SND_SOC_ALL_CODECS
+@@ -152,6 +152,7 @@ config SND_SOC_ALL_CODECS
  	select SND_SOC_TFA9879 if I2C
  	select SND_SOC_TLV320AIC23_I2C if I2C
  	select SND_SOC_TLV320AIC23_SPI if SPI_MASTER
@@ -99593,7 +100907,7 @@ index d8b8cf059e8730432c692e8ce4e4fb9f1269550a..aca3a53f08dba8762307f7c25a5d7c55
  	select SND_SOC_TLV320AIC26 if SPI_MASTER
  	select SND_SOC_TLV320AIC31XX if I2C
  	select SND_SOC_TLV320AIC32X4_I2C if I2C
-@@ -874,6 +875,9 @@ config SND_SOC_TFA9879
+@@ -888,6 +889,9 @@ config SND_SOC_TFA9879
  	tristate "NXP Semiconductors TFA9879 amplifier"
  	depends on I2C
  
@@ -99604,10 +100918,10 @@ index d8b8cf059e8730432c692e8ce4e4fb9f1269550a..aca3a53f08dba8762307f7c25a5d7c55
  	tristate
  
 diff --git a/sound/soc/codecs/Makefile b/sound/soc/codecs/Makefile
-index f1af18c2847a6c1bd3e0d97bcd42cc13aed24268..fc50753457b791eec4f369fd1d021330cd1857ee 100644
+index b372c0ce9c77cf64eaa3e3878398bec565e3028f..ce80fc03dc1429c6b2c06bbb0db7bdc81a930d7c 100644
 --- a/sound/soc/codecs/Makefile
 +++ b/sound/soc/codecs/Makefile
-@@ -155,6 +155,7 @@ snd-soc-tas5086-objs := tas5086.o
+@@ -157,6 +157,7 @@ snd-soc-tas5086-objs := tas5086.o
  snd-soc-tas571x-objs := tas571x.o
  snd-soc-tas5720-objs := tas5720.o
  snd-soc-tfa9879-objs := tfa9879.o
@@ -99615,7 +100929,7 @@ index f1af18c2847a6c1bd3e0d97bcd42cc13aed24268..fc50753457b791eec4f369fd1d021330
  snd-soc-tlv320aic23-objs := tlv320aic23.o
  snd-soc-tlv320aic23-i2c-objs := tlv320aic23-i2c.o
  snd-soc-tlv320aic23-spi-objs := tlv320aic23-spi.o
-@@ -389,6 +390,7 @@ obj-$(CONFIG_SND_SOC_TAS5086)	+= snd-soc-tas5086.o
+@@ -396,6 +397,7 @@ obj-$(CONFIG_SND_SOC_TAS5086)	+= snd-soc-tas5086.o
  obj-$(CONFIG_SND_SOC_TAS571X)	+= snd-soc-tas571x.o
  obj-$(CONFIG_SND_SOC_TAS5720)	+= snd-soc-tas5720.o
  obj-$(CONFIG_SND_SOC_TFA9879)	+= snd-soc-tfa9879.o
@@ -100217,10 +101531,10 @@ index 0000000000000000000000000000000000000000..8f019e04898754d2f87e9630137be9e8
 +
 +#endif  /* _TAS5713_H */
 
-From 554deb30893bb040bd210b2caf2cf4011b85acfd Mon Sep 17 00:00:00 2001
+From daf296e472206fd17c847823bcee42e8799d1a4e Mon Sep 17 00:00:00 2001
 From: Waldemar Brodkorb <wbrodkorb@conet.de>
 Date: Wed, 25 Mar 2015 09:26:17 +0100
-Subject: [PATCH 069/173] Add driver for rpi-proto
+Subject: [PATCH 071/126] Add driver for rpi-proto
 
 Forward port of 3.10.x driver from https://github.com/koalo
 We are using a custom board and would like to use rpi 3.18.x
@@ -100435,10 +101749,10 @@ index 0000000000000000000000000000000000000000..fadbfade100228aaafabb0d3bdf35c01
 +MODULE_DESCRIPTION("ASoC Driver for Raspberry Pi connected to PROTO board (WM8731)");
 +MODULE_LICENSE("GPL");
 
-From 1db46d8581da2dc1918791cf285b358f61915072 Mon Sep 17 00:00:00 2001
+From fb6a32c3a21e0791c3f7051efd2bc6db47257619 Mon Sep 17 00:00:00 2001
 From: Jan Grulich <jan@grulich.eu>
 Date: Mon, 24 Aug 2015 16:03:47 +0100
-Subject: [PATCH 070/173] RaspiDAC3 support
+Subject: [PATCH 072/126] RaspiDAC3 support
 
 Signed-off-by: Jan Grulich <jan@grulich.eu>
 
@@ -100681,10 +101995,10 @@ index 0000000000000000000000000000000000000000..ad2b5b89bc8213dc2e277306ef50d6e3
 +MODULE_DESCRIPTION("ASoC Driver for RaspiDAC Rev.3x");
 +MODULE_LICENSE("GPL v2");
 
-From 3e9ea889a1832600d5d85e95ca8f9e1208636aca Mon Sep 17 00:00:00 2001
+From e58a2f3eaac2f441075508c03cd083e8780b113d Mon Sep 17 00:00:00 2001
 From: Aaron Shaw <shawaj@gmail.com>
 Date: Thu, 7 Apr 2016 21:26:21 +0100
-Subject: [PATCH 071/173] Add Support for JustBoom Audio boards
+Subject: [PATCH 073/126] Add Support for JustBoom Audio boards
 
 justboom-dac: Adjust for ALSA API change
 
@@ -101140,10 +102454,10 @@ index 0000000000000000000000000000000000000000..909cf8928f2f4313982316f9c5b8a709
 +MODULE_DESCRIPTION("ASoC Driver for JustBoom PI Digi HAT Sound Card");
 +MODULE_LICENSE("GPL v2");
 
-From f9f3c49616174451761f9650eeb54a7cd3d0c4a7 Mon Sep 17 00:00:00 2001
+From 1b322c60274697d8b2ca69d3d42e1fb422f7f9ea Mon Sep 17 00:00:00 2001
 From: Andrey Grodzovsky <andrey2805@gmail.com>
 Date: Tue, 3 May 2016 22:10:59 -0400
-Subject: [PATCH 072/173] ARM: adau1977-adc: Add basic machine driver for
+Subject: [PATCH 074/126] ARM: adau1977-adc: Add basic machine driver for
  adau1977 codec driver.
 
 This commit adds basic support for the codec usage including: Device tree overlay,
@@ -101325,10 +102639,10 @@ index 0000000000000000000000000000000000000000..f3d7e5db7bb912e1d7ca6f8e8d42df5f
 +MODULE_DESCRIPTION("ASoC Driver for ADAU1977 ADC");
 +MODULE_LICENSE("GPL v2");
 
-From 89146d6df7d2f1f0ac537dc1a6fab18d45745bac Mon Sep 17 00:00:00 2001
+From c59b1e5bdd7c5c3524ffb51893f75675a8b1ac51 Mon Sep 17 00:00:00 2001
 From: Matt Flax <flatmax@flatmax.org>
 Date: Mon, 16 May 2016 21:36:31 +1000
-Subject: [PATCH 073/173] New AudioInjector.net Pi soundcard with low jitter
+Subject: [PATCH 075/126] New AudioInjector.net Pi soundcard with low jitter
  audio in and out.
 
 Contains the sound/soc/bcm ALSA machine driver and necessary alterations to the Kconfig and Makefile.
@@ -101381,7 +102695,7 @@ index 8c20ce506f2b0d653be39ceb9224503a0ef63c39..4d4189b6d0c57645c5ec19554f1e77d4
 +
 diff --git a/sound/soc/bcm/audioinjector-pi-soundcard.c b/sound/soc/bcm/audioinjector-pi-soundcard.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..ef54e0f07ea03f59e9957b5d98f3e7fdc998e469
+index 0000000000000000000000000000000000000000..491906bbf446826e55dd843f28e4860f48e908b8
 --- /dev/null
 +++ b/sound/soc/bcm/audioinjector-pi-soundcard.c
 @@ -0,0 +1,193 @@
@@ -101564,7 +102878,7 @@ index 0000000000000000000000000000000000000000..ef54e0f07ea03f59e9957b5d98f3e7fd
 +
 +static struct platform_driver audioinjector_pi_soundcard_driver = {
 +       .driver         = {
-+		.name   = "audioinjector-audio",
++		.name   = "audioinjector-stereo",
 +		.owner  = THIS_MODULE,
 +		.of_match_table = audioinjector_pi_soundcard_of_match,
 +       },
@@ -101579,10 +102893,10 @@ index 0000000000000000000000000000000000000000..ef54e0f07ea03f59e9957b5d98f3e7fd
 +MODULE_ALIAS("platform:audioinjector-pi-soundcard");
 +
 
-From d2152e820d65214d326d86028f5e58f35b329688 Mon Sep 17 00:00:00 2001
+From 98f83fbdf22d0ab8915df3055ed920cdbc289615 Mon Sep 17 00:00:00 2001
 From: DigitalDreamtime <clive.messer@digitaldreamtime.co.uk>
 Date: Thu, 30 Jun 2016 18:38:42 +0100
-Subject: [PATCH 074/173] Add IQAudIO Digi WM8804 board support
+Subject: [PATCH 076/126] Add IQAudIO Digi WM8804 board support
 
 Support IQAudIO Digi board with iqaudio_digi machine driver and
  iqaudio-digi-wm8804-audio overlay.
@@ -101882,10 +103196,10 @@ index 0000000000000000000000000000000000000000..33aa2be8a43a12a12cfb5d844dd9732c
 +MODULE_DESCRIPTION("ASoC Driver for IQAudIO WM8804 Digi");
 +MODULE_LICENSE("GPL v2");
 
-From 1660ae420d3e1bf946ab26d857a3efa44ed18399 Mon Sep 17 00:00:00 2001
+From 304e4c7414fc75ead9d57d065edcb1cce7a0653c Mon Sep 17 00:00:00 2001
 From: escalator2015 <jmtasende@gmail.com>
 Date: Tue, 24 May 2016 16:20:09 +0100
-Subject: [PATCH 075/173] New driver for RRA DigiDAC1 soundcard using WM8741 +
+Subject: [PATCH 077/126] New driver for RRA DigiDAC1 soundcard using WM8741 +
  WM8804
 
 ---
@@ -102358,10 +103672,10 @@ index 0000000000000000000000000000000000000000..f200688bb4ae32b90a0ced555aed94b0
 +MODULE_DESCRIPTION("ASoC Driver for RRA DigiDAC1");
 +MODULE_LICENSE("GPL v2");
 
-From 314dc26021276267e532ae3a6695b3c730d670ca Mon Sep 17 00:00:00 2001
+From eb8dc8dcf36a7d05df4139b05fd092d5420f0cd5 Mon Sep 17 00:00:00 2001
 From: DigitalDreamtime <clive.messer@digitaldreamtime.co.uk>
 Date: Sat, 2 Jul 2016 16:26:19 +0100
-Subject: [PATCH 076/173] Add support for Dion Audio LOCO DAC-AMP HAT
+Subject: [PATCH 078/126] Add support for Dion Audio LOCO DAC-AMP HAT
 
 Using dedicated machine driver and pcm5102a codec driver.
 
@@ -102534,10 +103848,10 @@ index 0000000000000000000000000000000000000000..65e03741d349a2dc5bd91f69855ea952
 +MODULE_DESCRIPTION("ASoC Driver for DionAudio LOCO");
 +MODULE_LICENSE("GPL v2");
 
-From 5f645d53ff8cd061433ae75986e3c29d672d413f Mon Sep 17 00:00:00 2001
+From 34f56e0f2e6b6512988d9c34eefcba04ce492f35 Mon Sep 17 00:00:00 2001
 From: Clive Messer <clive.m.messer@gmail.com>
 Date: Mon, 19 Sep 2016 14:01:04 +0100
-Subject: [PATCH 077/173] Allo Piano DAC boards: Initial 2 channel (stereo)
+Subject: [PATCH 079/126] Allo Piano DAC boards: Initial 2 channel (stereo)
  support (#1645)
 
 Add initial 2 channel (stereo) support for Allo Piano DAC (2.0/2.1) boards,
@@ -102744,10 +104058,10 @@ index 0000000000000000000000000000000000000000..eaf50fb6dbca1970ae1c6f8662088b0f
 +MODULE_DESCRIPTION("ALSA ASoC Machine Driver for Allo Piano DAC");
 +MODULE_LICENSE("GPL v2");
 
-From 9122ceca49ddb8ce8a648cd5181e8bdd9c582086 Mon Sep 17 00:00:00 2001
+From 4e5cb39aea0adf8131f7cc371d0030e96febaf78 Mon Sep 17 00:00:00 2001
 From: Raashid Muhammed <raashidmuhammed@zilogic.com>
 Date: Mon, 27 Mar 2017 12:35:00 +0530
-Subject: [PATCH 078/173] Add support for Allo Piano DAC 2.1 plus add-on board
+Subject: [PATCH 080/126] Add support for Allo Piano DAC 2.1 plus add-on board
  for Raspberry Pi.
 
 The Piano DAC 2.1 has support for 4 channels with subwoofer.
@@ -102763,11 +104077,13 @@ Also improve code style and adhere to ALSA coding conventions.
 Signed-off-by: Baswaraj K <jaikumar@cem-solutions.net>
 Reviewed-by: Vijay Kumar B. <vijaykumar@zilogic.com>
 Reviewed-by: Raashid Muhammed <raashidmuhammed@zilogic.com>
+
+PianoPlus: Dual Mono & Dual Stereo features added (#2069)
 ---
  sound/soc/bcm/Kconfig               |   7 +
  sound/soc/bcm/Makefile              |   2 +
- sound/soc/bcm/allo-piano-dac-plus.c | 683 ++++++++++++++++++++++++++++++++++++
- 3 files changed, 692 insertions(+)
+ sound/soc/bcm/allo-piano-dac-plus.c | 805 ++++++++++++++++++++++++++++++++++++
+ 3 files changed, 814 insertions(+)
  create mode 100644 sound/soc/bcm/allo-piano-dac-plus.c
 
 diff --git a/sound/soc/bcm/Kconfig b/sound/soc/bcm/Kconfig
@@ -102804,10 +104120,10 @@ index 64f007f8ba38276a42e0bd8db92544db9412544b..023b2c17098b4e64bb188a598f0b4923
 +obj-$(CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC_PLUS) += snd-soc-allo-piano-dac-plus.o
 diff --git a/sound/soc/bcm/allo-piano-dac-plus.c b/sound/soc/bcm/allo-piano-dac-plus.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3c08517eb
+index 0000000000000000000000000000000000000000..d4e99e3c6a383d92fb0cf9e8c1cd1e7657358d49
 --- /dev/null
 +++ b/sound/soc/bcm/allo-piano-dac-plus.c
-@@ -0,0 +1,683 @@
+@@ -0,0 +1,805 @@
 +/*
 + * ALSA ASoC Machine Driver for Allo Piano DAC Plus Subwoofer
 + *
@@ -102846,6 +104162,7 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +
 +struct glb_pool {
 +	struct mutex lock;
++	unsigned int dual_mode;
 +	unsigned int set_lowpass;
 +	unsigned int set_mode;
 +	unsigned int set_rate;
@@ -102857,8 +104174,8 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +
 +static struct gpio_desc *mute_gpio[2];
 +
-+
 +static const char * const allo_piano_mode_texts[] = {
++	"None",
 +	"2.0",
 +	"2.1",
 +	"2.2",
@@ -102867,6 +104184,15 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +static const SOC_ENUM_SINGLE_DECL(allo_piano_mode_enum,
 +		0, 0, allo_piano_mode_texts);
 +
++static const char * const allo_piano_dual_mode_texts[] = {
++	"None",
++	"Dual-Mono",
++	"Dual-Stereo",
++};
++
++static const SOC_ENUM_SINGLE_DECL(allo_piano_dual_mode_enum,
++		0, 0, allo_piano_dual_mode_texts);
++
 +static const char * const allo_piano_dsp_low_pass_texts[] = {
 +	"60",
 +	"70",
@@ -102892,10 +104218,10 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +		unsigned int mode, unsigned int rate, unsigned int lowpass)
 +{
 +	const struct firmware *fw;
-+	char firmware_name[60];
-+	int ret = 0, dac = 0;
 +	struct snd_soc_card *card = rtd->card;
 +	struct glb_pool *glb_ptr = card->drvdata;
++	char firmware_name[60];
++	int ret = 0, dac = 0;
 +
 +	if (rate <= 46000)
 +		rate = 44100;
@@ -102910,26 +104236,35 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +	else
 +		rate = 192000;
 +
-+	if ((lowpass > 14) || (lowpass < 0))
-+		lowpass = 3;
-+	if ((mode > 2) || (mode < 0))
-+		mode = 0;
++	if (lowpass > 14)
++		glb_ptr->set_lowpass = lowpass = 3;
++
++	if (mode > 3)
++		glb_ptr->set_mode = mode = 0;
++
++	if (mode > 0)
++		glb_ptr->dual_mode = 0;
 +
 +	/* same configuration loaded */
 +	if ((rate == glb_ptr->set_rate) && (lowpass == glb_ptr->set_lowpass)
 +			&& (mode == glb_ptr->set_mode))
 +		return 0;
 +
-+	if (mode == 0) { /* 2.0 */
-+		snd_soc_write(rtd->codec_dais[1]->codec,
-+				PCM512x_MUTE, 0x11);
++	switch (mode) {
++	case 0: /* None */
++		return 1;
++
++	case 1: /* 2.0 */
++		snd_soc_write(rtd->codec_dais[0]->codec, PCM512x_MUTE, 0x00);
++		snd_soc_write(rtd->codec_dais[1]->codec, PCM512x_MUTE, 0x11);
 +		glb_ptr->set_rate = rate;
 +		glb_ptr->set_mode = mode;
 +		glb_ptr->set_lowpass = lowpass;
 +		return 1;
-+	} else {
-+		snd_soc_write(rtd->codec_dais[1]->codec,
-+				PCM512x_MUTE, 0x00);
++
++	default:
++		snd_soc_write(rtd->codec_dais[0]->codec, PCM512x_MUTE, 0x00);
++		snd_soc_write(rtd->codec_dais[1]->codec, PCM512x_MUTE, 0x00);
 +	}
 +
 +	for (dac = 0; dac < rtd->num_codecs; dac++) {
@@ -102938,13 +104273,13 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +		int i = 1;
 +
 +		if (dac == 0) { /* high */
-+			sprintf(firmware_name,
++			snprintf(firmware_name, sizeof(firmware_name),
 +				"allo/piano/2.2/allo-piano-dsp-%d-%d-%d.bin",
 +				rate, ((lowpass * 10) + 60), dac);
 +		} else { /* low */
-+			sprintf(firmware_name,
++			snprintf(firmware_name, sizeof(firmware_name),
 +				"allo/piano/2.%d/allo-piano-dsp-%d-%d-%d.bin",
-+				mode, rate, ((lowpass * 10) + 60), dac);
++				(mode - 1), rate, ((lowpass * 10) + 60), dac);
 +		}
 +
 +		dev_info(codec->dev, "Dsp Firmware File Name: %s\n",
@@ -103009,6 +104344,80 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +	return ret;
 +}
 +
++static int snd_allo_piano_dual_mode_get(struct snd_kcontrol *kcontrol,
++		struct snd_ctl_elem_value *ucontrol)
++{
++	struct snd_soc_card *card = snd_kcontrol_chip(kcontrol);
++	struct glb_pool *glb_ptr = card->drvdata;
++
++	ucontrol->value.integer.value[0] = glb_ptr->dual_mode;
++
++	return 0;
++}
++
++static int snd_allo_piano_dual_mode_put(struct snd_kcontrol *kcontrol,
++		struct snd_ctl_elem_value *ucontrol)
++{
++	struct snd_soc_card *card = snd_kcontrol_chip(kcontrol);
++	struct glb_pool *glb_ptr = card->drvdata;
++	struct snd_soc_pcm_runtime *rtd;
++	struct snd_card *snd_card_ptr = card->snd_card;
++	struct snd_kcontrol *kctl;
++	struct soc_mixer_control *mc;
++	unsigned int left_val = 0;
++
++	rtd = snd_soc_get_pcm_runtime(card, card->dai_link[0].name);
++
++	if (ucontrol->value.integer.value[0] > 0) {
++		glb_ptr->dual_mode = ucontrol->value.integer.value[0];
++		glb_ptr->set_mode = 0;
++	} else if (ucontrol->value.integer.value[0] <= 0) {
++		if (glb_ptr->set_mode <= 0) {
++			glb_ptr->dual_mode = 1;
++			glb_ptr->set_mode = 0;
++		}
++	} else {
++		glb_ptr->dual_mode = 0;
++		return 0;
++	}
++
++	if (glb_ptr->dual_mode == 1) {
++		snd_soc_write(rtd->codec_dais[0]->codec, PCM512x_MUTE, 0x01);
++		snd_soc_write(rtd->codec_dais[1]->codec, PCM512x_MUTE, 0x10);
++		snd_soc_write(rtd->codec_dais[0]->codec,
++				PCM512x_DIGITAL_VOLUME_3, 0xff);
++
++		list_for_each_entry(kctl, &snd_card_ptr->controls, list) {
++			if (!strncmp(kctl->id.name, "Digital Playback Volume",
++					sizeof(kctl->id.name))) {
++				mc = (struct soc_mixer_control *)
++					kctl->private_value;
++				mc->rreg = mc->reg;
++				break;
++			}
++		}
++	} else {
++		left_val = snd_soc_read(rtd->codec_dais[0]->codec,
++						PCM512x_DIGITAL_VOLUME_2);
++		list_for_each_entry(kctl, &snd_card_ptr->controls, list) {
++			if (!strncmp(kctl->id.name, "Digital Playback Volume",
++					sizeof(kctl->id.name))) {
++				mc = (struct soc_mixer_control *)
++					kctl->private_value;
++				mc->rreg = PCM512x_DIGITAL_VOLUME_3;
++				break;
++			}
++		}
++
++		snd_soc_write(rtd->codec_dais[0]->codec,
++				PCM512x_DIGITAL_VOLUME_3, left_val);
++		snd_soc_write(rtd->codec_dais[0]->codec, PCM512x_MUTE, 0x00);
++		snd_soc_write(rtd->codec_dais[1]->codec, PCM512x_MUTE, 0x00);
++	}
++
++	return 0;
++}
++
 +static int snd_allo_piano_mode_get(struct snd_kcontrol *kcontrol,
 +		struct snd_ctl_elem_value *ucontrol)
 +{
@@ -103025,8 +104434,30 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +	struct snd_soc_card *card = snd_kcontrol_chip(kcontrol);
 +	struct snd_soc_pcm_runtime *rtd;
 +	struct glb_pool *glb_ptr = card->drvdata;
++	struct snd_card *snd_card_ptr = card->snd_card;
++	struct snd_kcontrol *kctl;
++	struct soc_mixer_control *mc;
++	unsigned int left_val = 0;
 +
 +	rtd = snd_soc_get_pcm_runtime(card, card->dai_link[0].name);
++
++	if ((glb_ptr->dual_mode == 1) &&
++			(ucontrol->value.integer.value[0] > 0)) {
++		left_val = snd_soc_read(rtd->codec_dais[0]->codec,
++						PCM512x_DIGITAL_VOLUME_2);
++		list_for_each_entry(kctl, &snd_card_ptr->controls, list) {
++			if (!strncmp(kctl->id.name, "Digital Playback Volume",
++					sizeof(kctl->id.name))) {
++				mc = (struct soc_mixer_control *)
++					kctl->private_value;
++				mc->rreg = PCM512x_DIGITAL_VOLUME_3;
++				break;
++			}
++		}
++		snd_soc_write(rtd->codec_dais[0]->codec,
++				PCM512x_DIGITAL_VOLUME_3, left_val);
++	}
++
 +	return(snd_allo_piano_dsp_program(rtd,
 +				ucontrol->value.integer.value[0],
 +				glb_ptr->set_rate, glb_ptr->set_lowpass));
@@ -103154,6 +104585,11 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +			snd_allo_piano_mode_get,
 +			snd_allo_piano_mode_put),
 +
++	SOC_ENUM_EXT("Dual Mode Route",
++			allo_piano_dual_mode_enum,
++			snd_allo_piano_dual_mode_get,
++			snd_allo_piano_dual_mode_put),
++
 +	SOC_ENUM_EXT("Lowpass Route", allo_piano_enum,
 +			snd_allo_piano_lowpass_get,
 +			snd_allo_piano_lowpass_put),
@@ -103282,7 +104718,7 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +					PCM512x_RATE_DET_4);
 +		if (val < 0) {
 +			dev_err(rtd->codec_dais[dac]->codec->dev,
-+					"Failed to read register PCM512x_RATE_DET_4\n");
++				"Failed to read register PCM512x_RATE_DET_4\n");
 +			return val;
 +		}
 +
@@ -103292,7 +104728,7 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +					PCM512x_SREF_BCK);
 +
 +			dev_info(rtd->codec_dais[dac]->codec->dev,
-+					"Setting BCLK as input clock & Enable PLL\n");
++				"Setting BCLK as input clock & Enable PLL\n");
 +		} else {
 +			snd_soc_write(rtd->codec_dais[dac]->codec,
 +					PCM512x_PLL_EN,
@@ -103303,7 +104739,7 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +					PCM512x_SREF_SCK);
 +
 +			dev_info(rtd->codec_dais[dac]->codec->dev,
-+					"Setting SCLK as input clock & disabled PLL\n");
++				"Setting SCLK as input clock & disabled PLL\n");
 +		}
 +	}
 +
@@ -103314,6 +104750,7 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +			dev_warn(card->dev, "Failed to set volume limit: %d\n",
 +				ret);
 +	}
++
 +	ret = snd_allo_piano_dsp_program(rtd, glb_ptr->set_mode, rate,
 +						glb_ptr->set_lowpass);
 +	if (ret < 0)
@@ -103331,6 +104768,7 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +	struct snd_soc_card *card = rtd->card;
 +
 +	snd_allo_piano_gpio_unmute(card);
++
 +	return 0;
 +}
 +
@@ -103492,11 +104930,11 @@ index 0000000000000000000000000000000000000000..56e43f98846b41e487b3089813f7edc3
 +MODULE_DESCRIPTION("ALSA ASoC Machine Driver for Allo Piano DAC Plus");
 +MODULE_LICENSE("GPL v2");
 
-From 74245f043c6887e406fe0a5cb7c75074985b8ca5 Mon Sep 17 00:00:00 2001
+From 05faa9b0c8454c4a3a392ee6f0815c24e7ef65b3 Mon Sep 17 00:00:00 2001
 From: BabuSubashChandar <babuenir@gmail.com>
 Date: Tue, 28 Mar 2017 20:04:42 +0530
-Subject: [PATCH 079/173]  Add support for Allo Boss DAC add-on board for
- Raspberry Pi.  (#1924)
+Subject: [PATCH 081/126] Add support for Allo Boss DAC add-on board for
+ Raspberry Pi. (#1924)
 
 Signed-off-by: Baswaraj K <jaikumar@cem-solutions.net>
 Reviewed-by: Deepak <deepak@zilogic.com>
@@ -103518,7 +104956,7 @@ Reviewed-by: BabuSubashChandar <babusubashchandar@zilogic.com>
  create mode 100644 sound/soc/bcm/allo-boss-dac.c
 
 diff --git a/drivers/clk/Makefile b/drivers/clk/Makefile
-index 9f85909bcf0a17b9b575833ccf011cb0878b4147..1df694cf247220c7af1a770aec10811a8fb51fed 100644
+index 4a6afc6403f737a977c6aab1647adf6a8fe69d4e..f2967f0a357bf6c1843885eff5fc2efacbb3426c 100644
 --- a/drivers/clk/Makefile
 +++ b/drivers/clk/Makefile
 @@ -17,6 +17,7 @@ endif
@@ -104198,10 +105636,10 @@ index 0000000000000000000000000000000000000000..203ab76c7045b081578e23bda1099dd1
 +MODULE_DESCRIPTION("ALSA ASoC Machine Driver for Allo Boss DAC");
 +MODULE_LICENSE("GPL v2");
 
-From 73c0d15d727f497ee7df6fa6f9e0829e04fe1d70 Mon Sep 17 00:00:00 2001
+From dcfb0be38297b086f31770c6cf1ef68a1a50d953 Mon Sep 17 00:00:00 2001
 From: gtrainavicius <gtrainavicius@users.noreply.github.com>
 Date: Sun, 23 Oct 2016 12:06:53 +0300
-Subject: [PATCH 080/173] Support for Blokas Labs pisound board
+Subject: [PATCH 082/126] Support for Blokas Labs pisound board
 
 Pisound dynamic overlay (#1760)
 
@@ -104228,13 +105666,13 @@ Signed-off-by: Giedrius Trainavicius <giedrius@blokas.io>
  create mode 100644 sound/soc/bcm/pisound.c
 
 diff --git a/Documentation/devicetree/bindings/vendor-prefixes.txt b/Documentation/devicetree/bindings/vendor-prefixes.txt
-index daf465bef75898c1b1960d456c82b666c4f9dca6..538fce10a103a7c3abae1ffbb9b431730eb935d6 100644
+index 1ea1fd4232ab2ac9c0e736169ef98a02e05ccf8b..51abcdb9f975b3c6e5ce85d0af48989d7ca9bec3 100644
 --- a/Documentation/devicetree/bindings/vendor-prefixes.txt
 +++ b/Documentation/devicetree/bindings/vendor-prefixes.txt
-@@ -47,6 +47,7 @@ avic	Shanghai AVIC Optoelectronics Co., Ltd.
- axentia	Axentia Technologies AB
+@@ -49,6 +49,7 @@ axentia	Axentia Technologies AB
  axis	Axis Communications AB
  bananapi BIPAI KEJI LIMITED
+ bhf	Beckhoff Automation GmbH & Co. KG
 +blokaslabs	Vilniaus Blokas UAB
  boe	BOE Technology Group Co., Ltd.
  bosch	Bosch Sensortec GmbH
@@ -105400,10 +106838,10 @@ index 0000000000000000000000000000000000000000..06ff1e53dc9d860946965b6303577762
 +MODULE_DESCRIPTION("ASoC Driver for pisound, http://blokas.io/pisound");
 +MODULE_LICENSE("GPL v2");
 
-From 3dd54e337ec7f50b718a63db94550d7f3bced8e7 Mon Sep 17 00:00:00 2001
+From 6b80d30ffba55c03285d02ca781ae3e91b24c9bb Mon Sep 17 00:00:00 2001
 From: Matthias Reichl <hias@horus.com>
 Date: Sun, 22 Jan 2017 12:49:37 +0100
-Subject: [PATCH 081/173] ASoC: Add driver for Cirrus Logic Audio Card
+Subject: [PATCH 083/126] ASoC: Add driver for Cirrus Logic Audio Card
 
 Note: due to problems with deferred probing of regulators
 the following softdep should be added to a modprobe.d file
@@ -106468,10 +107906,10 @@ index 0000000000000000000000000000000000000000..ac8651ddff7bd3701dffe22c7fb88352
 +MODULE_DESCRIPTION("ASoC driver for Cirrus Logic Audio Card");
 +MODULE_LICENSE("GPL");
 
-From bc36160418de7ebd7bf4c4d2a52f0d769194954b Mon Sep 17 00:00:00 2001
+From 7b27a8a6c443044b8b761f3682ccbd4564426bb5 Mon Sep 17 00:00:00 2001
 From: Miquel <miquelblauw@hotmail.com>
 Date: Fri, 24 Feb 2017 20:51:06 +0100
-Subject: [PATCH 082/173] sound: Support for Dion Audio LOCO-V2 DAC-AMP HAT
+Subject: [PATCH 084/126] sound: Support for Dion Audio LOCO-V2 DAC-AMP HAT
 
 Signed-off-by: Miquel Blauw <info@dionaudio.nl>
 ---
@@ -106666,10 +108104,10 @@ index 0000000000000000000000000000000000000000..a009c49477972a9832175d86f201b035
 +MODULE_DESCRIPTION("ASoC Driver for DionAudio LOCO-V2");
 +MODULE_LICENSE("GPL v2");
 
-From 314df407eb4bf4166ab8b91da5e3f73609946f50 Mon Sep 17 00:00:00 2001
+From 94ba67923eaa3dbadbe0ab1f6073cae4f234979d Mon Sep 17 00:00:00 2001
 From: Fe-Pi <fe-pi@cox.net>
 Date: Wed, 1 Mar 2017 04:42:43 -0700
-Subject: [PATCH 083/173] Add support for Fe-Pi audio sound card. (#1867)
+Subject: [PATCH 085/126] Add support for Fe-Pi audio sound card. (#1867)
 
 Fe-Pi Audio Sound Card is based on NXP SGTL5000 codec.
 Mechanical specification of the board is the same the Raspberry Pi Zero.
@@ -106883,10 +108321,10 @@ index 0000000000000000000000000000000000000000..015b56fd73cc36be5b5eecd17548fd03
 +MODULE_DESCRIPTION("ASoC Driver for Fe-Pi Audio");
 +MODULE_LICENSE("GPL v2");
 
-From e3ee86733ec6df9188b0d64d70877adb452c9ad6 Mon Sep 17 00:00:00 2001
+From 56ec90731e9d92803a6cf472eeffb7adcf1c2e95 Mon Sep 17 00:00:00 2001
 From: Matt Flax <flatmax@flatmax.org>
 Date: Wed, 8 Mar 2017 20:04:13 +1100
-Subject: [PATCH 084/173] Add support for the AudioInjector.net Octo sound card
+Subject: [PATCH 086/126] Add support for the AudioInjector.net Octo sound card
 
 AudioInjector Octo: sample rates, regulators, reset
 
@@ -106897,11 +108335,16 @@ new supported rates are (in kHz) :
 Reference the bcm270x DT regulators in the overlay.
 
 This patch adds a reset GPIO for the AudioInjector.net octo sound card.
+
+Audioinjector octo : Make the playback and capture symmetric
+
+This patch ensures that the sample rate and channel count of the audioinjector
+octo sound card are symmetric.
 ---
  sound/soc/bcm/Kconfig                        |   7 +
  sound/soc/bcm/Makefile                       |   2 +
- sound/soc/bcm/audioinjector-octo-soundcard.c | 339 +++++++++++++++++++++++++++
- 3 files changed, 348 insertions(+)
+ sound/soc/bcm/audioinjector-octo-soundcard.c | 341 +++++++++++++++++++++++++++
+ 3 files changed, 350 insertions(+)
  create mode 100644 sound/soc/bcm/audioinjector-octo-soundcard.c
 
 diff --git a/sound/soc/bcm/Kconfig b/sound/soc/bcm/Kconfig
@@ -106944,10 +108387,10 @@ index c3feaf198d997935fdf6815f9f8555d8704e53af..113b6899dd9fd6c4a6f706f57e32201d
  obj-$(CONFIG_SND_BCM2708_SOC_DIONAUDIO_LOCO_V2) += snd-soc-dionaudio-loco-v2.o
 diff --git a/sound/soc/bcm/audioinjector-octo-soundcard.c b/sound/soc/bcm/audioinjector-octo-soundcard.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..dcf403ab37639ba79e38278d7e4b1ade452c292a
+index 0000000000000000000000000000000000000000..5e79f4eff93a21ed3495c77a90f73525695cb3d5
 --- /dev/null
 +++ b/sound/soc/bcm/audioinjector-octo-soundcard.c
-@@ -0,0 +1,339 @@
+@@ -0,0 +1,341 @@
 +/*
 + * ASoC Driver for AudioInjector Pi octo channel soundcard (hat)
 + *
@@ -107154,6 +108597,8 @@ index 0000000000000000000000000000000000000000..dcf403ab37639ba79e38278d7e4b1ade
 +		.codec_dai_name = "cs42448",
 +		.ops = &audioinjector_octo_ops,
 +		.init = audioinjector_octo_dai_init,
++		.symmetric_rates = 1,
++		.symmetric_channels = 1,
 +	},
 +};
 +
@@ -107274,7 +108719,7 @@ index 0000000000000000000000000000000000000000..dcf403ab37639ba79e38278d7e4b1ade
 +
 +static struct platform_driver audioinjector_octo_driver = {
 +	.driver	= {
-+		.name			= "audioinjector-audio",
++		.name			= "audioinjector-octo",
 +		.owner			= THIS_MODULE,
 +		.of_match_table = audioinjector_octo_of_match,
 +	},
@@ -107288,10 +108733,10 @@ index 0000000000000000000000000000000000000000..dcf403ab37639ba79e38278d7e4b1ade
 +MODULE_LICENSE("GPL v2");
 +MODULE_ALIAS("platform:audioinjector-octo-soundcard");
 
-From 87a8a2b436a1694ede168fa77994e29c16fec183 Mon Sep 17 00:00:00 2001
+From 0969d307ca0e0709db8afb7b6b065490aab8554e Mon Sep 17 00:00:00 2001
 From: Peter Malkin <petermalkin@google.com>
 Date: Mon, 27 Mar 2017 16:38:21 -0700
-Subject: [PATCH 085/173] Driver support for Google voiceHAT soundcard.
+Subject: [PATCH 087/126] Driver support for Google voiceHAT soundcard.
 
 ---
  sound/soc/bcm/Kconfig                    |   7 ++
@@ -107682,10 +109127,335 @@ index 0000000000000000000000000000000000000000..225854b8e5298b3c3018f59a49404354
 +MODULE_DESCRIPTION("ASoC Driver for Google voiceHAT SoundCard");
 +MODULE_LICENSE("GPL v2");
 
-From ef2d4677dbd95942ef4b799dc343411183e53f5b Mon Sep 17 00:00:00 2001
+From 76bc44b8408b32829403b0dbcb3a5e3dc22dfd01 Mon Sep 17 00:00:00 2001
+From: sandeepal <alsandeep@cem-solutions.net>
+Date: Fri, 2 Jun 2017 18:59:46 +0530
+Subject: [PATCH 088/126] Allo Digione Driver (#2048)
+
+Driver for the Allo Digione soundcard
+---
+ sound/soc/bcm/Kconfig        |   7 ++
+ sound/soc/bcm/Makefile       |   2 +
+ sound/soc/bcm/allo-digione.c | 268 +++++++++++++++++++++++++++++++++++++++++++
+ 3 files changed, 277 insertions(+)
+ create mode 100644 sound/soc/bcm/allo-digione.c
+
+diff --git a/sound/soc/bcm/Kconfig b/sound/soc/bcm/Kconfig
+index 355bdeb25f81d15593f78df0e87a48404908ca4b..381d32bb9deb3cf2c531e2a4563418cd6eb9d505 100644
+--- a/sound/soc/bcm/Kconfig
++++ b/sound/soc/bcm/Kconfig
+@@ -176,6 +176,13 @@ config SND_BCM2708_SOC_ALLO_BOSS_DAC
+ 	help
+ 	  Say Y or M if you want to add support for Allo Boss DAC.
+ 
++config SND_BCM2708_SOC_ALLO_DIGIONE 
++        tristate "Support for Allo DigiOne"
++	depends on SND_BCM2708_SOC_I2S || SND_BCM2835_SOC_I2S
++	select SND_SOC_PCM512x_I2C
++	help
++	  Say Y or M if you want to add support for Allo DigiOne.
++
+ config SND_BCM2708_SOC_FE_PI_AUDIO
+ 	tristate "Support for Fe-Pi-Audio"
+ 	depends on SND_BCM2708_SOC_I2S || SND_BCM2835_SOC_I2S
+diff --git a/sound/soc/bcm/Makefile b/sound/soc/bcm/Makefile
+index 72e1620fa4038035804cf3b2a09c6b12e7ae0fe1..53ea8229d7ac2065176983385dd7ba85ee3915ea 100644
+--- a/sound/soc/bcm/Makefile
++++ b/sound/soc/bcm/Makefile
+@@ -34,6 +34,7 @@ snd-soc-dionaudio-loco-v2-objs := dionaudio_loco-v2.o
+ snd-soc-allo-boss-dac-objs := allo-boss-dac.o
+ snd-soc-allo-piano-dac-objs := allo-piano-dac.o
+ snd-soc-allo-piano-dac-plus-objs := allo-piano-dac-plus.o
++snd-soc-allo-digione-objs := allo-digione.o
+ snd-soc-pisound-objs := pisound.o
+ snd-soc-fe-pi-audio-objs := fe-pi-audio.o
+ 
+@@ -60,5 +61,6 @@ obj-$(CONFIG_SND_BCM2708_SOC_DIONAUDIO_LOCO_V2) += snd-soc-dionaudio-loco-v2.o
+ obj-$(CONFIG_SND_BCM2708_SOC_ALLO_BOSS_DAC) += snd-soc-allo-boss-dac.o
+ obj-$(CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC) += snd-soc-allo-piano-dac.o
+ obj-$(CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC_PLUS) += snd-soc-allo-piano-dac-plus.o
++obj-$(CONFIG_SND_BCM2708_SOC_ALLO_DIGIONE) += snd-soc-allo-digione.o
+ obj-$(CONFIG_SND_PISOUND) += snd-soc-pisound.o
+ obj-$(CONFIG_SND_BCM2708_SOC_FE_PI_AUDIO) += snd-soc-fe-pi-audio.o
+diff --git a/sound/soc/bcm/allo-digione.c b/sound/soc/bcm/allo-digione.c
+new file mode 100644
+index 0000000000000000000000000000000000000000..e3664e44c699d0102120ecf99e8b780a4505ebad
+--- /dev/null
++++ b/sound/soc/bcm/allo-digione.c
+@@ -0,0 +1,268 @@
++/*
++ * ASoC Driver for Allo DigiOne
++ *
++ * Author: Baswaraj <jaikumar@cemsolutions.net>
++ *	   Copyright 2017
++ * based on code by Daniel Matuschek <info@crazy-audio.com>
++ * based on code by Florian Meier <florian.meier@koalo.de>
++ *
++ * This program is free software; you can redistribute it and/or
++ * modify it under the terms of the GNU General Public License
++ * version 2 as published by the Free Software Foundation.
++ *
++ * This program is distributed in the hope that it will be useful, but
++ * WITHOUT ANY WARRANTY; without even the implied warranty of
++ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
++ * General Public License for more details.
++ */
++
++#include <linux/module.h>
++#include <linux/platform_device.h>
++
++#include <sound/core.h>
++#include <sound/pcm.h>
++#include <sound/pcm_params.h>
++#include <sound/soc.h>
++#include <sound/jack.h>
++#include <linux/gpio/consumer.h>
++
++#include "../codecs/wm8804.h"
++
++static short int auto_shutdown_output = 0;
++module_param(auto_shutdown_output, short,
++		S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
++MODULE_PARM_DESC(auto_shutdown_output, "Shutdown SP/DIF output if playback is stopped");
++
++#define CLK_44EN_RATE 22579200UL
++#define CLK_48EN_RATE 24576000UL
++
++static struct gpio_desc *snd_allo_clk44gpio;
++static struct gpio_desc *snd_allo_clk48gpio;
++
++static int samplerate = 44100;
++
++static uint32_t snd_allo_digione_enable_clock(int sample_rate)
++{
++	switch (sample_rate) {
++	case 11025:
++	case 22050:
++	case 44100:
++	case 88200:
++	case 176400:
++		gpiod_set_value_cansleep(snd_allo_clk44gpio, 1);
++		gpiod_set_value_cansleep(snd_allo_clk48gpio, 0);
++		return CLK_44EN_RATE;
++	default:
++		gpiod_set_value_cansleep(snd_allo_clk48gpio, 1);
++		gpiod_set_value_cansleep(snd_allo_clk44gpio, 0);
++		return CLK_48EN_RATE;
++	}
++}
++
++
++static int snd_allo_digione_init(struct snd_soc_pcm_runtime *rtd)
++{
++	struct snd_soc_codec *codec = rtd->codec;
++
++	/* enable TX output */
++	snd_soc_update_bits(codec, WM8804_PWRDN, 0x4, 0x0);
++
++	return 0;
++}
++
++static int snd_allo_digione_startup(struct snd_pcm_substream *substream)
++{
++	/* turn on digital output */
++	struct snd_soc_pcm_runtime *rtd = substream->private_data;
++	struct snd_soc_codec *codec = rtd->codec;
++	snd_soc_update_bits(codec, WM8804_PWRDN, 0x3c, 0x00);
++	return 0;
++}
++
++static void snd_allo_digione_shutdown(struct snd_pcm_substream *substream)
++{
++	/* turn off output */
++	if (auto_shutdown_output) {
++		/* turn off output */
++		struct snd_soc_pcm_runtime *rtd = substream->private_data;
++		struct snd_soc_codec *codec = rtd->codec;
++		snd_soc_update_bits(codec, WM8804_PWRDN, 0x3c, 0x3c);
++	}
++}
++
++static int snd_allo_digione_hw_params(struct snd_pcm_substream *substream,
++				       struct snd_pcm_hw_params *params)
++{
++	struct snd_soc_pcm_runtime *rtd = substream->private_data;
++	struct snd_soc_dai *codec_dai = rtd->codec_dai;
++	struct snd_soc_codec *codec = rtd->codec;
++	struct snd_soc_dai *cpu_dai = rtd->cpu_dai;
++
++	int sysclk = 27000000; /* This is fixed on this board */
++
++	long mclk_freq = 0;
++	int mclk_div = 1;
++	int sampling_freq = 1;
++
++	int ret;
++
++	samplerate = params_rate(params);
++
++	if (samplerate <= 96000) {
++		mclk_freq = samplerate * 256;
++		mclk_div = WM8804_MCLKDIV_256FS;
++	} else {
++		mclk_freq = samplerate * 128;
++		mclk_div = WM8804_MCLKDIV_128FS;
++	}
++
++	sysclk = snd_allo_digione_enable_clock(samplerate);
++	
++	switch (samplerate) {
++		case 32000:
++			sampling_freq=0x03;
++			break;
++		case 44100:
++			sampling_freq=0x00;
++			break;
++		case 48000:
++			sampling_freq=0x02;
++			break;
++		case 88200:
++			sampling_freq=0x08;
++			break;
++		case 96000:
++			sampling_freq=0x0a;
++			break;
++		case 176400:
++			sampling_freq=0x0c;
++			break;
++		case 192000:
++			sampling_freq=0x0e;
++			break;
++		default:
++			dev_err(codec->dev,
++			"Failed to set WM8804 SYSCLK, unsupported samplerate %d\n",
++			samplerate);
++	}
++
++	snd_soc_dai_set_clkdiv(codec_dai, WM8804_MCLK_DIV, mclk_div);
++	snd_soc_dai_set_pll(codec_dai, 0, 0, sysclk, mclk_freq);
++
++	ret = snd_soc_dai_set_sysclk(codec_dai, WM8804_TX_CLKSRC_PLL,
++					sysclk, SND_SOC_CLOCK_OUT);
++
++	if (ret < 0) {
++		dev_err(codec->dev,
++		"Failed to set WM8804 SYSCLK: %d\n", ret);
++		return ret;
++	}
++
++	/* Enable TX output */
++	snd_soc_update_bits(codec, WM8804_PWRDN, 0x4, 0x0);
++
++	/* Power on */
++	snd_soc_update_bits(codec, WM8804_PWRDN, 0x9, 0);
++
++	/* set sampling frequency status bits */
++	snd_soc_update_bits(codec, WM8804_SPDTX4, 0x0f, sampling_freq);
++
++	return snd_soc_dai_set_bclk_ratio(cpu_dai, 64);
++}
++
++/* machine stream operations */
++static struct snd_soc_ops snd_allo_digione_ops = {
++	.hw_params	= snd_allo_digione_hw_params,
++        .startup	= snd_allo_digione_startup,
++        .shutdown	= snd_allo_digione_shutdown,
++};
++
++static struct snd_soc_dai_link snd_allo_digione_dai[] = {
++{
++	.name		= "Allo DigiOne",
++	.stream_name	= "Allo DigiOne HiFi",
++	.cpu_dai_name	= "bcm2708-i2s.0",
++	.codec_dai_name	= "wm8804-spdif",
++	.platform_name	= "bcm2708-i2s.0",
++	.codec_name	= "wm8804.1-003b",
++	.dai_fmt	= SND_SOC_DAIFMT_I2S |
++			  SND_SOC_DAIFMT_NB_NF |
++			  SND_SOC_DAIFMT_CBM_CFM,
++	.ops		= &snd_allo_digione_ops,
++	.init		= snd_allo_digione_init,
++},
++};
++
++/* audio machine driver */
++static struct snd_soc_card snd_allo_digione = {
++	.name         = "snd_allo_digione",
++	.driver_name  = "AlloDigiOne",
++	.owner        = THIS_MODULE,
++	.dai_link     = snd_allo_digione_dai,
++	.num_links    = ARRAY_SIZE(snd_allo_digione_dai),
++};
++
++static int snd_allo_digione_probe(struct platform_device *pdev)
++{
++	int ret = 0;
++
++	snd_allo_digione.dev = &pdev->dev;
++
++	if (pdev->dev.of_node) {
++	    struct device_node *i2s_node;
++	    struct snd_soc_dai_link *dai = &snd_allo_digione_dai[0];
++	    i2s_node = of_parse_phandle(pdev->dev.of_node,
++					"i2s-controller", 0);
++
++	    if (i2s_node) {
++		dai->cpu_dai_name = NULL;
++		dai->cpu_of_node = i2s_node;
++		dai->platform_name = NULL;
++		dai->platform_of_node = i2s_node;
++	    }
++
++	    snd_allo_clk44gpio =
++		devm_gpiod_get(&pdev->dev, "clock44", GPIOD_OUT_LOW);
++	    if (IS_ERR(snd_allo_clk44gpio))
++		dev_err(&pdev->dev, "devm_gpiod_get() failed\n");
++
++	    snd_allo_clk48gpio =
++		devm_gpiod_get(&pdev->dev, "clock48", GPIOD_OUT_LOW);
++	    if (IS_ERR(snd_allo_clk48gpio))
++		dev_err(&pdev->dev, "devm_gpiod_get() failed\n");
++	}
++
++	ret = snd_soc_register_card(&snd_allo_digione);
++	if (ret && ret != -EPROBE_DEFER)
++		dev_err(&pdev->dev, "snd_soc_register_card() failed: %d\n",
++			ret);
++
++	return ret;
++}
++
++static int snd_allo_digione_remove(struct platform_device *pdev)
++{
++	return snd_soc_unregister_card(&snd_allo_digione);
++}
++
++static const struct of_device_id snd_allo_digione_of_match[] = {
++	{ .compatible = "allo,allo-digione", },
++	{},
++};
++MODULE_DEVICE_TABLE(of, snd_allo_digione_of_match);
++
++static struct platform_driver snd_allo_digione_driver = {
++	.driver = {
++		.name		= "snd-allo-digione",
++		.owner		= THIS_MODULE,
++		.of_match_table	= snd_allo_digione_of_match,
++	},
++	.probe  = snd_allo_digione_probe,
++	.remove = snd_allo_digione_remove,
++};
++
++module_platform_driver(snd_allo_digione_driver);
++
++MODULE_AUTHOR("Baswaraj <jaikumar@cem-solutions.net>");
++MODULE_DESCRIPTION("ASoC Driver for Allo DigiOne");
++MODULE_LICENSE("GPL v2");
+
+From b7684a070234f08d1285006f092fb41b8415b786 Mon Sep 17 00:00:00 2001
 From: P33M <P33M@github.com>
 Date: Wed, 21 Oct 2015 14:55:21 +0100
-Subject: [PATCH 086/173] rpi_display: add backlight driver and overlay
+Subject: [PATCH 089/126] rpi_display: add backlight driver and overlay
 
 Add a mailbox-driven backlight controller for the Raspberry Pi DSI
 touchscreen display. Requires updated GPU firmware to recognise the
@@ -107854,10 +109624,10 @@ index 0000000000000000000000000000000000000000..14a0d9b037395497c1fdae2961feccd5
 +MODULE_DESCRIPTION("Raspberry Pi mailbox based Backlight Driver");
 +MODULE_LICENSE("GPL");
 
-From 80071abd1a5757097e30e3474d7945df9e5e1540 Mon Sep 17 00:00:00 2001
+From 7317f65d71654c1e8df08b2847cb7079e90a458c Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Tue, 23 Feb 2016 19:56:04 +0000
-Subject: [PATCH 087/173] bcm2835-virtgpio: Virtual GPIO driver
+Subject: [PATCH 090/126] bcm2835-virtgpio: Virtual GPIO driver
 
 Add a virtual GPIO driver that uses the firmware mailbox interface to
 request that the VPU toggles LEDs.
@@ -107870,7 +109640,7 @@ request that the VPU toggles LEDs.
  create mode 100644 drivers/gpio/gpio-bcm-virt.c
 
 diff --git a/drivers/gpio/Kconfig b/drivers/gpio/Kconfig
-index 461d6fc3688b61128f280a84c8ed3e1073488ab0..b1aa6966056b75c940d7fb12dd0ea278dd1449d2 100644
+index 3388d54ba11468a0ab013f1160b1ea2a258ca354..a18eca231879705937c3b5d9cf80a3224e40c1e4 100644
 --- a/drivers/gpio/Kconfig
 +++ b/drivers/gpio/Kconfig
 @@ -134,6 +134,12 @@ config GPIO_BCM_KONA
@@ -107887,7 +109657,7 @@ index 461d6fc3688b61128f280a84c8ed3e1073488ab0..b1aa6966056b75c940d7fb12dd0ea278
  	tristate "BRCMSTB GPIO support"
  	default y if (ARCH_BRCMSTB || BMIPS_GENERIC)
 diff --git a/drivers/gpio/Makefile b/drivers/gpio/Makefile
-index a9fda6c55113c7b472863de7f412f69d72de602d..78ad9e06466ed7ed57622444e19e729a2ca8d669 100644
+index aeb70e9de6f2192fc678a279b59483bd9aa0eb17..74b4acc997153499e5bdf975815a5cfc8a93023f 100644
 --- a/drivers/gpio/Makefile
 +++ b/drivers/gpio/Makefile
 @@ -34,6 +34,7 @@ obj-$(CONFIG_GPIO_ASPEED)	+= gpio-aspeed.o
@@ -108131,10 +109901,10 @@ index 4a3d79d3b48eb483a4e4bf498f617515e3ad158f..5f34e1257117fb48013c9926a8a223d6
  	RPI_FIRMWARE_FRAMEBUFFER_SET_BACKLIGHT =              0x0004800f,
  
 
-From 8bda6e9cef790aab89b07d56fbbea72db787bc32 Mon Sep 17 00:00:00 2001
+From 5944e8b41eedbe72d65454e3af18ab160d97bfbc Mon Sep 17 00:00:00 2001
 From: Dave Stevenson <dave.stevenson@raspberrypi.org>
 Date: Mon, 20 Feb 2017 17:01:21 +0000
-Subject: [PATCH 088/173] bcm2835-gpio-exp: Driver for GPIO expander via
+Subject: [PATCH 091/126] bcm2835-gpio-exp: Driver for GPIO expander via
  mailbox service
 
 Pi3 and Compute Module 3 have a GPIO expander that the
@@ -108154,7 +109924,7 @@ Signed-off-by: Dave Stevenson <dave.stevenson@raspberrypi.org>
  create mode 100644 drivers/gpio/gpio-bcm-exp.c
 
 diff --git a/drivers/gpio/Kconfig b/drivers/gpio/Kconfig
-index b1aa6966056b75c940d7fb12dd0ea278dd1449d2..cf6d5b503c96911eb3acac6c2cde1bd1556ed6a7 100644
+index a18eca231879705937c3b5d9cf80a3224e40c1e4..21736685b44d916c5b50098feeaa9b06c12c7588 100644
 --- a/drivers/gpio/Kconfig
 +++ b/drivers/gpio/Kconfig
 @@ -128,6 +128,13 @@ config GPIO_AXP209
@@ -108172,7 +109942,7 @@ index b1aa6966056b75c940d7fb12dd0ea278dd1449d2..cf6d5b503c96911eb3acac6c2cde1bd1
  	bool "Broadcom Kona GPIO"
  	depends on OF_GPIO && (ARCH_BCM_MOBILE || COMPILE_TEST)
 diff --git a/drivers/gpio/Makefile b/drivers/gpio/Makefile
-index 78ad9e06466ed7ed57622444e19e729a2ca8d669..dd55b7879c844305ef39375ae551c30c272cf96e 100644
+index 74b4acc997153499e5bdf975815a5cfc8a93023f..83935169e32aa3ec2da2d2819abb9f6a9cfb234e 100644
 --- a/drivers/gpio/Makefile
 +++ b/drivers/gpio/Makefile
 @@ -32,6 +32,7 @@ obj-$(CONFIG_GPIO_ARIZONA)	+= gpio-arizona.o
@@ -108460,10 +110230,10 @@ index 5f34e1257117fb48013c9926a8a223d64a598ab7..c819c21b0158a59c1308882e5a40e3f3
  	/* Dispmanx TAGS */
  	RPI_FIRMWARE_FRAMEBUFFER_ALLOCATE =                   0x00040001,
 
-From 4982ff8f2f3780a6d82f03da3f52375b602e0d28 Mon Sep 17 00:00:00 2001
+From 9ea2c550c16114347ee0dce3bb235e1605745a04 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Tue, 23 Feb 2016 17:26:48 +0000
-Subject: [PATCH 089/173] amba_pl011: Don't use DT aliases for numbering
+Subject: [PATCH 092/126] amba_pl011: Don't use DT aliases for numbering
 
 The pl011 driver looks for DT aliases of the form "serial<n>",
 and if found uses <n> as the device ID. This can cause
@@ -108475,7 +110245,7 @@ use the same logic.
  1 file changed, 5 insertions(+)
 
 diff --git a/drivers/tty/serial/amba-pl011.c b/drivers/tty/serial/amba-pl011.c
-index 1888d168a41c87c605962da2605df8ab1c02bd20..e22b9e79836a6aeef4c8f9fb618b9595c551500f 100644
+index 111e6a95077978c2c30bfe2a2de4a0d095e8d76e..584471add0962c0e26eb814fc0ef43eea99b2d29 100644
 --- a/drivers/tty/serial/amba-pl011.c
 +++ b/drivers/tty/serial/amba-pl011.c
 @@ -2582,7 +2582,12 @@ static int pl011_setup_port(struct device *dev, struct uart_amba_port *uap,
@@ -108492,10 +110262,10 @@ index 1888d168a41c87c605962da2605df8ab1c02bd20..e22b9e79836a6aeef4c8f9fb618b9595
  	uap->old_cr = 0;
  	uap->port.dev = dev;
 
-From a9fa581c618a4ad0f041e7ff6f82e5fad0f7cdb4 Mon Sep 17 00:00:00 2001
+From cbd689bc530960b3204554e9b0801e122e06274d Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Wed, 1 Mar 2017 16:07:39 +0000
-Subject: [PATCH 090/173] amba_pl011: Round input clock up
+Subject: [PATCH 093/126] amba_pl011: Round input clock up
 
 The UART clock is initialised to be as close to the requested
 frequency as possible without exceeding it. Now that there is a
@@ -108519,7 +110289,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  1 file changed, 21 insertions(+), 2 deletions(-)
 
 diff --git a/drivers/tty/serial/amba-pl011.c b/drivers/tty/serial/amba-pl011.c
-index e22b9e79836a6aeef4c8f9fb618b9595c551500f..4b815abbf9913075885ee60f4d9ad49d89ec96b2 100644
+index 584471add0962c0e26eb814fc0ef43eea99b2d29..bfbc845d7be9ef804468d0a82da18d9b67857216 100644
 --- a/drivers/tty/serial/amba-pl011.c
 +++ b/drivers/tty/serial/amba-pl011.c
 @@ -1672,6 +1672,23 @@ static void pl011_put_poll_char(struct uart_port *port,
@@ -108581,10 +110351,10 @@ index e22b9e79836a6aeef4c8f9fb618b9595c551500f..4b815abbf9913075885ee60f4d9ad49d
  /* unregisters the driver also if no more ports are left */
  static void pl011_unregister_port(struct uart_amba_port *uap)
 
-From 7bae3b057de6271cc60c5fb58df61de79ba11ff5 Mon Sep 17 00:00:00 2001
+From 3a791f786d89b35d64909d15c78e47a0337be891 Mon Sep 17 00:00:00 2001
 From: Pantelis Antoniou <pantelis.antoniou@konsulko.com>
 Date: Wed, 3 Dec 2014 13:23:28 +0200
-Subject: [PATCH 091/173] OF: DT-Overlay configfs interface
+Subject: [PATCH 094/126] OF: DT-Overlay configfs interface
 
 This is a port of Pantelis Antoniou's v3 port that makes use of the
 new upstreamed configfs support for binary attributes.
@@ -109016,10 +110786,10 @@ index 0000000000000000000000000000000000000000..0037e6868a6cda8706c88194c6a4454b
 +}
 +late_initcall(of_cfs_init);
 
-From ee744cbd4f413ecab6f664274972c3807c9d606e Mon Sep 17 00:00:00 2001
+From db129abb9af7dd2c0bdfa72a27ec4346218081d8 Mon Sep 17 00:00:00 2001
 From: Cheong2K <cheong@redbear.cc>
 Date: Fri, 26 Feb 2016 18:20:10 +0800
-Subject: [PATCH 092/173] brcm: adds support for BCM43341 wifi
+Subject: [PATCH 095/126] brcm: adds support for BCM43341 wifi
 
 brcmfmac: Disable power management
 
@@ -109065,7 +110835,7 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  3 files changed, 20 insertions(+), 7 deletions(-)
 
 diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c
-index 7e689c86d56576cf96ca755b16107216470fccdf..508cab2d0817914d454958f92167d350c74d9a5d 100644
+index aaed4ab503ad16c6f4de0e3ccec5b83c3f85c6a1..5e08f1c56bce96c695491cb769f20d498d501332 100644
 --- a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c
 +++ b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c
 @@ -2821,6 +2821,8 @@ brcmf_cfg80211_set_power_mgmt(struct wiphy *wiphy, struct net_device *ndev,
@@ -109077,7 +110847,7 @@ index 7e689c86d56576cf96ca755b16107216470fccdf..508cab2d0817914d454958f92167d350
  	cfg->pwr_save = enabled;
  	if (!check_vif_up(ifp->vif)) {
  
-@@ -6851,12 +6853,18 @@ static s32 brcmf_translate_country_code(struct brcmf_pub *drvr, char alpha2[2],
+@@ -6861,12 +6863,18 @@ static s32 brcmf_translate_country_code(struct brcmf_pub *drvr, char alpha2[2],
  	struct brcmfmac_pd_cc *country_codes;
  	struct brcmfmac_pd_cc_entry *cc;
  	s32 found_index;
@@ -109098,7 +110868,7 @@ index 7e689c86d56576cf96ca755b16107216470fccdf..508cab2d0817914d454958f92167d350
  	}
  
  	if ((alpha2[0] == ccreq->country_abbrev[0]) &&
-@@ -6880,10 +6888,14 @@ static s32 brcmf_translate_country_code(struct brcmf_pub *drvr, char alpha2[2],
+@@ -6890,10 +6898,14 @@ static s32 brcmf_translate_country_code(struct brcmf_pub *drvr, char alpha2[2],
  		brcmf_dbg(TRACE, "No country code match found\n");
  		return -EINVAL;
  	}
@@ -109130,7 +110900,7 @@ index 7a2b49587b4d32dde1af56a2979d4e1818500f84..df138305217384de2359313bc7d00528
  MODULE_PARM_DESC(roamoff, "Do not use internal roaming engine");
  
 diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
-index f3556122c6ace17c419e13023057861957a507fa..f8d4647016a1cde3d51dd43da07a46ce9771fa18 100644
+index 613caca7dc020a78985b22521422700022c37473..971c68a261f2d041806655dd66636aee2c28a6bc 100644
 --- a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
 +++ b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/sdio.c
 @@ -609,6 +609,7 @@ BRCMF_FW_NVRAM_DEF(4329, "brcmfmac4329-sdio.bin", "brcmfmac4329-sdio.txt");
@@ -109141,7 +110911,7 @@ index f3556122c6ace17c419e13023057861957a507fa..f8d4647016a1cde3d51dd43da07a46ce
  BRCMF_FW_NVRAM_DEF(4335, "brcmfmac4335-sdio.bin", "brcmfmac4335-sdio.txt");
  BRCMF_FW_NVRAM_DEF(43362, "brcmfmac43362-sdio.bin", "brcmfmac43362-sdio.txt");
  BRCMF_FW_NVRAM_DEF(4339, "brcmfmac4339-sdio.bin", "brcmfmac4339-sdio.txt");
-@@ -628,7 +629,7 @@ static struct brcmf_firmware_mapping brcmf_sdio_fwnames[] = {
+@@ -629,7 +630,7 @@ static struct brcmf_firmware_mapping brcmf_sdio_fwnames[] = {
  	BRCMF_FW_NVRAM_ENTRY(BRCM_CC_4330_CHIP_ID, 0xFFFFFFFF, 4330),
  	BRCMF_FW_NVRAM_ENTRY(BRCM_CC_4334_CHIP_ID, 0xFFFFFFFF, 4334),
  	BRCMF_FW_NVRAM_ENTRY(BRCM_CC_43340_CHIP_ID, 0xFFFFFFFF, 43340),
@@ -109151,10 +110921,10 @@ index f3556122c6ace17c419e13023057861957a507fa..f8d4647016a1cde3d51dd43da07a46ce
  	BRCMF_FW_NVRAM_ENTRY(BRCM_CC_43362_CHIP_ID, 0xFFFFFFFE, 43362),
  	BRCMF_FW_NVRAM_ENTRY(BRCM_CC_4339_CHIP_ID, 0xFFFFFFFF, 4339),
 
-From 862219e4c44154cb99abcdd78281a2082de3d53f Mon Sep 17 00:00:00 2001
+From 38c8779c9bf1b78935767d232dff5191a9e0e0c2 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Fri, 17 Feb 2017 15:26:13 +0000
-Subject: [PATCH 093/173] brcmfmac: Mute expected startup 'errors'
+Subject: [PATCH 096/126] brcmfmac: Mute expected startup 'errors'
 
 The brcmfmac WiFi driver always complains about the '00' country code.
 Modify the driver to ignore '00' silently.
@@ -109165,10 +110935,10 @@ Signed-off-by: Phil Elwell <phil@raspberrypi.org>
  1 file changed, 2 insertions(+)
 
 diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c
-index 508cab2d0817914d454958f92167d350c74d9a5d..987b1f5b999b0ecb68b6ce741b8e3ddbfab2bcc0 100644
+index 5e08f1c56bce96c695491cb769f20d498d501332..9fefcceb16a761bd319e4fc81ac4355da43ce98b 100644
 --- a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c
 +++ b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c
-@@ -6919,6 +6919,8 @@ static void brcmf_cfg80211_reg_notifier(struct wiphy *wiphy,
+@@ -6929,6 +6929,8 @@ static void brcmf_cfg80211_reg_notifier(struct wiphy *wiphy,
  	/* ignore non-ISO3166 country codes */
  	for (i = 0; i < sizeof(req->alpha2); i++)
  		if (req->alpha2[i] < 'A' || req->alpha2[i] > 'Z') {
@@ -109178,10 +110948,10 @@ index 508cab2d0817914d454958f92167d350c74d9a5d..987b1f5b999b0ecb68b6ce741b8e3ddb
  				  req->alpha2[0], req->alpha2[1]);
  			return;
 
-From 1c5d4e984dc9d4729c336c7d56f41507f0973806 Mon Sep 17 00:00:00 2001
+From 8f8ba97c34be4dd58c0e5a272030f5891510d0fa Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Thu, 17 Dec 2015 13:37:07 +0000
-Subject: [PATCH 094/173] hci_h5: Don't send conf_req when ACTIVE
+Subject: [PATCH 097/126] hci_h5: Don't send conf_req when ACTIVE
 
 Without this patch, a modem and kernel can continuously bombard each
 other with conf_req and conf_rsp messages, in a demented game of tag.
@@ -109204,24 +110974,24 @@ index c0e4e26dc30d7c3c6a771b7b86df88c8cf763646..7308287259eedcaf229f8a496a0e3826
  		if (H5_HDR_LEN(hdr) > 2)
  			h5->tx_win = (data[2] & 0x07);
 
-From 3de80acbf475780288c867ec9b885da847d90d4a Mon Sep 17 00:00:00 2001
+From ed09de680482f932ead40931aacf2f45035eaf95 Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Mon, 13 Apr 2015 17:16:29 +0100
-Subject: [PATCH 095/173] config: Add default configs
+Subject: [PATCH 098/126] config: Add default configs
 
 ---
- arch/arm/configs/bcm2709_defconfig | 1312 +++++++++++++++++++++++++++++++++++
- arch/arm/configs/bcmrpi_defconfig  | 1318 ++++++++++++++++++++++++++++++++++++
- 2 files changed, 2630 insertions(+)
+ arch/arm/configs/bcm2709_defconfig | 1326 +++++++++++++++++++++++++++++++++++
+ arch/arm/configs/bcmrpi_defconfig  | 1331 ++++++++++++++++++++++++++++++++++++
+ 2 files changed, 2657 insertions(+)
  create mode 100644 arch/arm/configs/bcm2709_defconfig
  create mode 100644 arch/arm/configs/bcmrpi_defconfig
 
 diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
 new file mode 100644
-index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf4b895a20
+index 0000000000000000000000000000000000000000..62909413e1d625a1d33559d965ee8707ca57ba91
 --- /dev/null
 +++ b/arch/arm/configs/bcm2709_defconfig
-@@ -0,0 +1,1312 @@
+@@ -0,0 +1,1326 @@
 +CONFIG_LOCALVERSION="-v7"
 +# CONFIG_LOCALVERSION_AUTO is not set
 +CONFIG_SYSVIPC=y
@@ -109327,9 +111097,11 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_TCP_CONG_BBR=m
 +CONFIG_IPV6=m
 +CONFIG_IPV6_ROUTER_PREF=y
++CONFIG_IPV6_ROUTE_INFO=y
 +CONFIG_INET6_AH=m
 +CONFIG_INET6_ESP=m
 +CONFIG_INET6_IPCOMP=m
++CONFIG_IPV6_SIT_6RD=y
 +CONFIG_IPV6_TUNNEL=m
 +CONFIG_IPV6_MULTIPLE_TABLES=y
 +CONFIG_IPV6_SUBTREES=y
@@ -109584,6 +111356,7 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_CAN_VCAN=m
 +CONFIG_CAN_SLCAN=m
 +CONFIG_CAN_MCP251X=m
++CONFIG_CAN_GS_USB=m
 +CONFIG_IRDA=m
 +CONFIG_IRLAN=m
 +CONFIG_IRNET=m
@@ -109789,6 +111562,7 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_INPUT_TOUCHSCREEN=y
 +CONFIG_TOUCHSCREEN_ADS7846=m
 +CONFIG_TOUCHSCREEN_EGALAX=m
++CONFIG_TOUCHSCREEN_GOODIX=m
 +CONFIG_TOUCHSCREEN_EDT_FT5X06=m
 +CONFIG_TOUCHSCREEN_RPI_FT5406=m
 +CONFIG_TOUCHSCREEN_USB_COMPOSITE=m
@@ -109838,6 +111612,7 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_I2C_BCM2708=m
 +CONFIG_I2C_BCM2835=m
 +CONFIG_I2C_GPIO=m
++CONFIG_I2C_ROBOTFUZZ_OSIF=m
 +CONFIG_SPI=y
 +CONFIG_SPI_BCM2835=m
 +CONFIG_SPI_BCM2835AUX=m
@@ -109873,11 +111648,13 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_POWER_RESET_GPIO=y
 +CONFIG_BATTERY_DS2760=m
 +CONFIG_HWMON=m
++CONFIG_SENSORS_JC42=m
 +CONFIG_SENSORS_LM75=m
 +CONFIG_SENSORS_SHT21=m
 +CONFIG_SENSORS_SHTC1=m
 +CONFIG_SENSORS_ADS1015=m
 +CONFIG_SENSORS_INA2XX=m
++CONFIG_SENSORS_TMP102=m
 +CONFIG_THERMAL=y
 +CONFIG_BCM2835_THERMAL=y
 +CONFIG_WATCHDOG=y
@@ -109889,6 +111666,8 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_MFD_WM5102=y
 +CONFIG_REGULATOR=y
 +CONFIG_REGULATOR_FIXED_VOLTAGE=m
++CONFIG_REGULATOR_ARIZONA_LDO1=m
++CONFIG_REGULATOR_ARIZONA_MICSUPP=m
 +CONFIG_MEDIA_SUPPORT=m
 +CONFIG_MEDIA_CAMERA_SUPPORT=y
 +CONFIG_MEDIA_ANALOG_TV_SUPPORT=y
@@ -110107,13 +111886,16 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC=m
 +CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC_PLUS=m
 +CONFIG_SND_BCM2708_SOC_ALLO_BOSS_DAC=m
++CONFIG_SND_BCM2708_SOC_ALLO_DIGIONE=m
 +CONFIG_SND_BCM2708_SOC_FE_PI_AUDIO=m
 +CONFIG_SND_PISOUND=m
 +CONFIG_SND_SOC_ADAU1701=m
 +CONFIG_SND_SOC_ADAU7002=m
 +CONFIG_SND_SOC_AK4554=m
++CONFIG_SND_SOC_SPDIF=m
 +CONFIG_SND_SOC_WM8804_I2C=m
 +CONFIG_SND_SIMPLE_CARD=m
++CONFIG_HID_BATTERY_STRENGTH=y
 +CONFIG_HIDRAW=y
 +CONFIG_UHID=m
 +CONFIG_HID_A4TECH=m
@@ -110156,6 +111938,7 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_HID_ROCCAT=m
 +CONFIG_HID_SAMSUNG=m
 +CONFIG_HID_SONY=m
++CONFIG_SONY_FF=y
 +CONFIG_HID_SPEEDLINK=m
 +CONFIG_HID_SUNPLUS=m
 +CONFIG_HID_GREENASIA=m
@@ -110361,6 +112144,7 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_FB_TFT_SSD1331=m
 +CONFIG_FB_TFT_SSD1351=m
 +CONFIG_FB_TFT_ST7735R=m
++CONFIG_FB_TFT_ST7789V=m
 +CONFIG_FB_TFT_TINYLCD=m
 +CONFIG_FB_TFT_TLS8204=m
 +CONFIG_FB_TFT_UC1701=m
@@ -110379,13 +112163,13 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_EXTCON=m
 +CONFIG_EXTCON_ARIZONA=m
 +CONFIG_IIO=m
-+CONFIG_IIO_BUFFER=y
 +CONFIG_IIO_BUFFER_CB=m
-+CONFIG_IIO_KFIFO_BUF=m
 +CONFIG_MCP320X=m
 +CONFIG_MCP3422=m
 +CONFIG_DHT11=m
 +CONFIG_HTU21=m
++CONFIG_INV_MPU6050_I2C=m
++CONFIG_BMP280=m
 +CONFIG_PWM_BCM2835=m
 +CONFIG_PWM_PCA9685=m
 +CONFIG_RASPBERRYPI_FIRMWARE=y
@@ -110536,10 +112320,10 @@ index 0000000000000000000000000000000000000000..93cdfa4ce3e7d3ff9f437a05a9ee6bcf
 +CONFIG_LIBCRC32C=y
 diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
 new file mode 100644
-index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5b4994f6e
+index 0000000000000000000000000000000000000000..e0dd8723047ff488e81a03ef42fdbc68c43dc721
 --- /dev/null
 +++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -0,0 +1,1318 @@
+@@ -0,0 +1,1331 @@
 +# CONFIG_LOCALVERSION_AUTO is not set
 +CONFIG_SYSVIPC=y
 +CONFIG_POSIX_MQUEUE=y
@@ -110640,9 +112424,11 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_TCP_CONG_BBR=m
 +CONFIG_IPV6=m
 +CONFIG_IPV6_ROUTER_PREF=y
++CONFIG_IPV6_ROUTE_INFO=y
 +CONFIG_INET6_AH=m
 +CONFIG_INET6_ESP=m
 +CONFIG_INET6_IPCOMP=m
++CONFIG_IPV6_SIT_6RD=y
 +CONFIG_IPV6_TUNNEL=m
 +CONFIG_IPV6_MULTIPLE_TABLES=y
 +CONFIG_IPV6_SUBTREES=y
@@ -110897,6 +112683,7 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_CAN_VCAN=m
 +CONFIG_CAN_SLCAN=m
 +CONFIG_CAN_MCP251X=m
++CONFIG_CAN_GS_USB=m
 +CONFIG_IRDA=m
 +CONFIG_IRLAN=m
 +CONFIG_IRNET=m
@@ -111102,8 +112889,8 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_INPUT_TOUCHSCREEN=y
 +CONFIG_TOUCHSCREEN_ADS7846=m
 +CONFIG_TOUCHSCREEN_EGALAX=m
-+CONFIG_TOUCHSCREEN_EDT_FT5X06=m
 +CONFIG_TOUCHSCREEN_GOODIX=m
++CONFIG_TOUCHSCREEN_EDT_FT5X06=m
 +CONFIG_TOUCHSCREEN_RPI_FT5406=m
 +CONFIG_TOUCHSCREEN_USB_COMPOSITE=m
 +CONFIG_TOUCHSCREEN_STMPE=m
@@ -111152,6 +112939,7 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_I2C_BCM2708=m
 +CONFIG_I2C_BCM2835=m
 +CONFIG_I2C_GPIO=m
++CONFIG_I2C_ROBOTFUZZ_OSIF=m
 +CONFIG_SPI=y
 +CONFIG_SPI_BCM2835=m
 +CONFIG_SPI_BCM2835AUX=m
@@ -111185,11 +112973,13 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_POWER_RESET_GPIO=y
 +CONFIG_BATTERY_DS2760=m
 +CONFIG_HWMON=m
++CONFIG_SENSORS_JC42=m
 +CONFIG_SENSORS_LM75=m
 +CONFIG_SENSORS_SHT21=m
 +CONFIG_SENSORS_SHTC1=m
 +CONFIG_SENSORS_ADS1015=m
 +CONFIG_SENSORS_INA2XX=m
++CONFIG_SENSORS_TMP102=m
 +CONFIG_THERMAL=y
 +CONFIG_BCM2835_THERMAL=y
 +CONFIG_WATCHDOG=y
@@ -111201,6 +112991,8 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_MFD_WM5102=y
 +CONFIG_REGULATOR=y
 +CONFIG_REGULATOR_FIXED_VOLTAGE=m
++CONFIG_REGULATOR_ARIZONA_LDO1=m
++CONFIG_REGULATOR_ARIZONA_MICSUPP=m
 +CONFIG_MEDIA_SUPPORT=m
 +CONFIG_MEDIA_CAMERA_SUPPORT=y
 +CONFIG_MEDIA_ANALOG_TV_SUPPORT=y
@@ -111419,13 +113211,16 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC=m
 +CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC_PLUS=m
 +CONFIG_SND_BCM2708_SOC_ALLO_BOSS_DAC=m
++CONFIG_SND_BCM2708_SOC_ALLO_DIGIONE=m
 +CONFIG_SND_BCM2708_SOC_FE_PI_AUDIO=m
 +CONFIG_SND_PISOUND=m
 +CONFIG_SND_SOC_ADAU1701=m
 +CONFIG_SND_SOC_ADAU7002=m
 +CONFIG_SND_SOC_AK4554=m
++CONFIG_SND_SOC_SPDIF=m
 +CONFIG_SND_SOC_WM8804_I2C=m
 +CONFIG_SND_SIMPLE_CARD=m
++CONFIG_HID_BATTERY_STRENGTH=y
 +CONFIG_HIDRAW=y
 +CONFIG_UHID=m
 +CONFIG_HID_A4TECH=m
@@ -111468,6 +113263,7 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_HID_ROCCAT=m
 +CONFIG_HID_SAMSUNG=m
 +CONFIG_HID_SONY=m
++CONFIG_SONY_FF=y
 +CONFIG_HID_SPEEDLINK=m
 +CONFIG_HID_SUNPLUS=m
 +CONFIG_HID_GREENASIA=m
@@ -111686,6 +113482,7 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_FB_TFT_SSD1331=m
 +CONFIG_FB_TFT_SSD1351=m
 +CONFIG_FB_TFT_ST7735R=m
++CONFIG_FB_TFT_ST7789V=m
 +CONFIG_FB_TFT_TINYLCD=m
 +CONFIG_FB_TFT_TLS8204=m
 +CONFIG_FB_TFT_UC1701=m
@@ -111704,13 +113501,13 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_EXTCON=m
 +CONFIG_EXTCON_ARIZONA=m
 +CONFIG_IIO=m
-+CONFIG_IIO_BUFFER=y
 +CONFIG_IIO_BUFFER_CB=m
-+CONFIG_IIO_KFIFO_BUF=m
 +CONFIG_MCP320X=m
 +CONFIG_MCP3422=m
 +CONFIG_DHT11=m
 +CONFIG_HTU21=m
++CONFIG_INV_MPU6050_I2C=m
++CONFIG_BMP280=m
 +CONFIG_PWM_BCM2835=m
 +CONFIG_PWM_PCA9685=m
 +CONFIG_RASPBERRYPI_FIRMWARE=y
@@ -111859,10 +113656,10 @@ index 0000000000000000000000000000000000000000..29fd2abc2cbfcaed37cb630b5edffaa5
 +CONFIG_CRC_ITU_T=y
 +CONFIG_LIBCRC32C=y
 
-From aa0d7e5a28f52a73aa338d6460da265ff880861b Mon Sep 17 00:00:00 2001
+From e9cfa59ac0a3391083c99bd22d5ab187a5f6debf Mon Sep 17 00:00:00 2001
 From: Michael Zoran <mzoran@crowfest.net>
 Date: Wed, 24 Aug 2016 03:35:56 -0700
-Subject: [PATCH 096/173] Add arm64 configuration and device tree differences.
+Subject: [PATCH 099/126] Add arm64 configuration and device tree differences.
  Disable MMC_BCM2835_SDHOST and MMC_BCM2835 since these drivers are crashing
  at the moment.
 
@@ -111884,7 +113681,7 @@ Tested with raspbian-jessie 2016-09-23.
  create mode 100644 arch/arm64/configs/bcmrpi3_defconfig
 
 diff --git a/arch/arm64/Kconfig.platforms b/arch/arm64/Kconfig.platforms
-index f5f0c813dfecc56cf21e0ae18b8b0c34197aad86..d8550598e3403e7d35050e48e71bac17ed8dc493 100644
+index 6b54ee8c1262dd1587b9081ef8894166b0c14211..e262127db967d63c751acb3bd09f1631963a1a6f 100644
 --- a/arch/arm64/Kconfig.platforms
 +++ b/arch/arm64/Kconfig.platforms
 @@ -1,5 +1,27 @@
@@ -111916,16 +113713,15 @@ index f5f0c813dfecc56cf21e0ae18b8b0c34197aad86..d8550598e3403e7d35050e48e71bac17
  	bool "Actions Semi Platforms"
  	select OWL_TIMER
 diff --git a/arch/arm64/boot/dts/broadcom/Makefile b/arch/arm64/boot/dts/broadcom/Makefile
-index f11bdd6689ea96b2fce04404ae2166349c7d2c26..1046bed8bf1509eaf3127733b9263fa39a166895 100644
+index 3eaef3895d663b150fcbe4b2974c8548620cbf12..306221c738c3854946ecc40a4842219734b86235 100644
 --- a/arch/arm64/boot/dts/broadcom/Makefile
 +++ b/arch/arm64/boot/dts/broadcom/Makefile
-@@ -1,5 +1,6 @@
+@@ -1,4 +1,5 @@
  dtb-$(CONFIG_ARCH_BCM2835) += bcm2837-rpi-3-b.dtb
- dtb-$(CONFIG_ARCH_BCM_IPROC) += ns2-svk.dtb ns2-xmc.dtb
 +dtb-$(CONFIG_ARCH_BCM2709) += bcm2710-rpi-3-b.dtb
  
- dts-dirs	:= stingray
- always		:= $(dtb-y)
+ dts-dirs	+= northstar2
+ dts-dirs	+= stingray
 diff --git a/arch/arm64/boot/dts/broadcom/bcm2710-rpi-3-b.dts b/arch/arm64/boot/dts/broadcom/bcm2710-rpi-3-b.dts
 new file mode 100644
 index 0000000000000000000000000000000000000000..deb33441da95220db0ed672e41639626fba682a5
@@ -113276,10 +115072,10 @@ index 0000000000000000000000000000000000000000..e6b09fafa27eed2b762e3d53b55041f7
 +CONFIG_LIBCRC32C=y
 +CONFIG_BCM2835_VCHIQ=n
 
-From 8e2219a0baafc84fd4d99777767c2fb2af678d61 Mon Sep 17 00:00:00 2001
+From c8b3c7e7e5562ff5ce2858b72fb66189c631a299 Mon Sep 17 00:00:00 2001
 From: Electron752 <mzoran@crowfest.net>
 Date: Thu, 12 Jan 2017 07:07:08 -0800
-Subject: [PATCH 097/173] ARM64: Make it work again on 4.9 (#1790)
+Subject: [PATCH 100/126] ARM64: Make it work again on 4.9 (#1790)
 
 * Invoke the dtc compiler with the same options used in arm mode.
 * ARM64 now uses the bcm2835 platform just like ARM32.
@@ -113288,14 +115084,14 @@ Subject: [PATCH 097/173] ARM64: Make it work again on 4.9 (#1790)
 Signed-off-by: Michael Zoran <mzoran@crowfest.net>
 ---
  arch/arm64/Kconfig.platforms          |  28 --------
- arch/arm64/boot/dts/broadcom/Makefile |   9 +++
+ arch/arm64/boot/dts/broadcom/Makefile |  10 ++-
  arch/arm64/boot/dts/overlays          |   1 +
  arch/arm64/configs/bcmrpi3_defconfig  | 125 +++++++++++-----------------------
- 4 files changed, 48 insertions(+), 115 deletions(-)
+ 4 files changed, 48 insertions(+), 116 deletions(-)
  create mode 120000 arch/arm64/boot/dts/overlays
 
 diff --git a/arch/arm64/Kconfig.platforms b/arch/arm64/Kconfig.platforms
-index d8550598e3403e7d35050e48e71bac17ed8dc493..1b7f6ea1171f5cc7a1df649d146520c1c77eada9 100644
+index e262127db967d63c751acb3bd09f1631963a1a6f..e57169584af075eca0e0a2c1900fd64fe886bbb3 100644
 --- a/arch/arm64/Kconfig.platforms
 +++ b/arch/arm64/Kconfig.platforms
 @@ -1,33 +1,5 @@
@@ -113333,10 +115129,10 @@ index d8550598e3403e7d35050e48e71bac17ed8dc493..1b7f6ea1171f5cc7a1df649d146520c1
  	bool "Allwinner sunxi 64-bit SoC Family"
  	select ARCH_HAS_RESET_CONTROLLER
 diff --git a/arch/arm64/boot/dts/broadcom/Makefile b/arch/arm64/boot/dts/broadcom/Makefile
-index 1046bed8bf1509eaf3127733b9263fa39a166895..97af2ececc52ca3aad7b84dc2fdb5c269a45bde0 100644
+index 306221c738c3854946ecc40a4842219734b86235..f39cc2acf78ff2a10242ad89a2fc17acacc33e03 100644
 --- a/arch/arm64/boot/dts/broadcom/Makefile
 +++ b/arch/arm64/boot/dts/broadcom/Makefile
-@@ -1,6 +1,15 @@
+@@ -1,7 +1,15 @@
 +# Enable fixups to support overlays on BCM2835 platforms
 +
 +ifeq ($(CONFIG_ARCH_BCM2835),y)
@@ -113344,14 +115140,15 @@ index 1046bed8bf1509eaf3127733b9263fa39a166895..97af2ececc52ca3aad7b84dc2fdb5c26
 +endif
 +
  dtb-$(CONFIG_ARCH_BCM2835) += bcm2837-rpi-3-b.dtb
- dtb-$(CONFIG_ARCH_BCM_IPROC) += ns2-svk.dtb ns2-xmc.dtb
  dtb-$(CONFIG_ARCH_BCM2709) += bcm2710-rpi-3-b.dtb
 +dtb-$(CONFIG_ARCH_BCM2835) += bcm2710-rpi-3-b.dtb
 +
 +dts-dirs += ../overlays
  
- dts-dirs	:= stingray
+-dts-dirs	+= northstar2
+ dts-dirs	+= stingray
  always		:= $(dtb-y)
+ subdir-y	:= $(dts-dirs)
 diff --git a/arch/arm64/boot/dts/overlays b/arch/arm64/boot/dts/overlays
 new file mode 120000
 index 0000000000000000000000000000000000000000..ded08646b6f66cdf734f8bf9c1be3a2e3a7103d7
@@ -113688,10 +115485,10 @@ index e6b09fafa27eed2b762e3d53b55041f793683d27..c7e891d72969a388d9b135a36dbfc9c9
  CONFIG_LIBCRC32C=y
 -CONFIG_BCM2835_VCHIQ=n
 
-From 22c1d2230b0a3c24579468f54d01fa5de1596eb4 Mon Sep 17 00:00:00 2001
+From b0da1ce6471fffb9fc5414ad4ed9b33ff12fc11e Mon Sep 17 00:00:00 2001
 From: Michael Zoran <mzoran@crowfest.net>
 Date: Thu, 12 Jan 2017 19:10:07 -0800
-Subject: [PATCH 098/173] ARM64: Enable HDMI audio and vc04_services in
+Subject: [PATCH 101/126] ARM64: Enable HDMI audio and vc04_services in
  bcmrpi3_defconfig
 
 Signed-off-by: Michael Zoran <mzoran@crowfest.net>
@@ -113720,10 +115517,10 @@ index c7e891d72969a388d9b135a36dbfc9c9cb609bf8..4b90f9b64abe9f089ba56b13d5a00de3
  CONFIG_BCM2835_MBOX=y
  # CONFIG_IOMMU_SUPPORT is not set
 
-From 7b4499e2b9552b0b365016240a16c8072bb5f627 Mon Sep 17 00:00:00 2001
+From 43170ca7c5e6d419343a338d886b417ffc6f9ab6 Mon Sep 17 00:00:00 2001
 From: Michael Zoran <mzoran@crowfest.net>
 Date: Thu, 12 Jan 2017 19:14:03 -0800
-Subject: [PATCH 099/173] ARM64: Run bcmrpi3_defconfig through savedefconfig.
+Subject: [PATCH 102/126] ARM64: Run bcmrpi3_defconfig through savedefconfig.
 
 Signed-off-by: Michael Zoran <mzoran@crowfest.net>
 ---
@@ -113768,10 +115565,10 @@ index 4b90f9b64abe9f089ba56b13d5a00de33343bfb9..dac962ca1634662ce7d966f1ffb53b5b
  CONFIG_FB_TFT_AGM1264K_FL=m
  CONFIG_FB_TFT_BD663474=m
 
-From 17093b0945689c18b8695f59f9994313671ab152 Mon Sep 17 00:00:00 2001
+From 6dccefc831adfd8b69529d4983121ab7955afa4c Mon Sep 17 00:00:00 2001
 From: Electron752 <mzoran@crowfest.net>
 Date: Sat, 14 Jan 2017 02:54:26 -0800
-Subject: [PATCH 100/173] ARM64: Enable Kernel Address Space Randomization
+Subject: [PATCH 103/126] ARM64: Enable Kernel Address Space Randomization
  (#1792)
 
 Randomization allows the mapping between virtual addresses and physical
@@ -113803,10 +115600,10 @@ index dac962ca1634662ce7d966f1ffb53b5bfa27c506..aae33b4b3c3e736ea7cd3ca242158ad6
  CONFIG_BINFMT_MISC=y
  CONFIG_COMPAT=y
 
-From 4e8ce0d9fe85bd01daead09f28aa2be3cbce7edb Mon Sep 17 00:00:00 2001
+From 9f49c5f13a9478a434b0e138e75fab8563365a7e Mon Sep 17 00:00:00 2001
 From: Michael Zoran <mzoran@crowfest.net>
 Date: Sun, 15 Jan 2017 07:31:59 -0800
-Subject: [PATCH 101/173] ARM64: Enable RTL8187/RTL8192CU wifi in build config
+Subject: [PATCH 104/126] ARM64: Enable RTL8187/RTL8192CU wifi in build config
 
 These drivers build now, so they can be enabled back
 in the build configuration just like they are for
@@ -113831,10 +115628,10 @@ index aae33b4b3c3e736ea7cd3ca242158ad6ba558aff..b7d762df19b85e369a32cd823dfd0621
  CONFIG_ZD1211RW=m
  CONFIG_MAC80211_HWSIM=m
 
-From 5144c8dd8cfdaecf22c4bc4b7aabbae11faa034f Mon Sep 17 00:00:00 2001
+From 5579aec0dcca5f42656021324b702fb4bfa33601 Mon Sep 17 00:00:00 2001
 From: Michael Zoran <mzoran@crowfest.net>
 Date: Sat, 14 Jan 2017 21:33:51 -0800
-Subject: [PATCH 102/173] ARM64/DWC_OTG: Port dwc_otg driver to ARM64
+Subject: [PATCH 105/126] ARM64/DWC_OTG: Port dwc_otg driver to ARM64
 
 In ARM64, the FIQ mechanism used by this driver is not current
 implemented.   As a workaround, reqular IRQ is used instead
@@ -113891,7 +115688,7 @@ index e7bdd12015fee1727a7956ae3e3b2786e88892c1..4872b8113b68bc9087cf5e128657c580
  dwc_otg-objs	+= dwc_otg_cfi.o
  endif
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c
-index 2035e0762dc6d60673c8fbc47a90b72254f50b69..208252645c09d1d17bf07673989f91b7f4b3ef7a 100644
+index 96fd44eb6414a2b70d8be307e9dcd4c4804cef2d..e47d5b6de3ada73896ff9a81abd223d345e0de4f 100644
 --- a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c
 @@ -74,6 +74,21 @@ void notrace _fiq_print(enum fiq_debug_level dbg_lvl, volatile struct fiq_state
@@ -113916,7 +115713,7 @@ index 2035e0762dc6d60673c8fbc47a90b72254f50b69..208252645c09d1d17bf07673989f91b7
  /**
   * fiq_fsm_spin_lock() - ARMv6+ bare bones spinlock
   * Must be called with local interrupts and FIQ disabled.
-@@ -122,6 +137,8 @@ inline void fiq_fsm_spin_unlock(fiq_lock_t *lock)
+@@ -121,6 +136,8 @@ inline void fiq_fsm_spin_unlock(fiq_lock_t *lock)
  inline void fiq_fsm_spin_unlock(fiq_lock_t *lock) { }
  #endif
  
@@ -113926,7 +115723,7 @@ index 2035e0762dc6d60673c8fbc47a90b72254f50b69..208252645c09d1d17bf07673989f91b7
   * fiq_fsm_restart_channel() - Poke channel enable bit for a split transaction
   * @channel: channel to re-enable
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h
-index f9fddfbcffb37f32c808fd78f222b676378398b1..0a1ddf3f89f45ca75b8880722fbc22cbdc9f4a2f 100644
+index 8340041ce65665c094e2ad49fd5e8eb1751506f3..ed088f34f210e9a337ab9b80fff0cf9e9b0241ea 100644
 --- a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h
 @@ -127,6 +127,12 @@ enum fiq_debug_level {
@@ -113951,7 +115748,7 @@ index f9fddfbcffb37f32c808fd78f222b676378398b1..0a1ddf3f89f45ca75b8880722fbc22cb
  struct fiq_state;
  
  extern void _fiq_print (enum fiq_debug_level dbg_lvl, volatile struct fiq_state *state, char *fmt, ...);
-@@ -355,6 +363,22 @@ struct fiq_state {
+@@ -357,6 +365,22 @@ struct fiq_state {
  	struct fiq_channel_state channel[0];
  };
  
@@ -113975,10 +115772,10 @@ index f9fddfbcffb37f32c808fd78f222b676378398b1..0a1ddf3f89f45ca75b8880722fbc22cb
  
  extern void fiq_fsm_spin_unlock(fiq_lock_t *lock);
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-index 5e4d4ffe7966486d40a5b5e2423ac4df0de772a8..a2dc6337836b2719f4c954edeeb2a71301931b04 100644
+index 60464acab588a1e189f39b268ffc25766c13dc85..7710370b30363e3170bf9bf522597c5f41dfb908 100644
 --- a/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-@@ -1002,6 +1002,10 @@ int dwc_otg_hcd_init(dwc_otg_hcd_t * hcd, dwc_otg_core_if_t * core_if)
+@@ -1000,6 +1000,10 @@ int dwc_otg_hcd_init(dwc_otg_hcd_t * hcd, dwc_otg_core_if_t * core_if)
  		}
  		DWC_MEMSET(hcd->fiq_state, 0, (sizeof(struct fiq_state) + (sizeof(struct fiq_channel_state) * num_channels)));
  
@@ -114006,7 +115803,7 @@ index fb57db09378f4ab95d57cb58aa570a915ccb61c3..a384db5e7ac219936ace65e5616e68c8
  /**
   * Returns private data set by
 diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c
-index fc52495e4749f45dcf270c1c22960f163b6dc86d..a4355afc77b68718fdaba6c5d4be257dadc75036 100644
+index ed855eb9c3b64d54e93c5aa7e06212e779400dfd..c8f52709a7d24974c0a38dcf1708f91073e96b0e 100644
 --- a/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c
 +++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c
 @@ -36,8 +36,9 @@
@@ -114177,10 +115974,10 @@ index 6b2c7d0c93f36a63863ff4b0ecc1f3eab77e058b..d7b700ff17821ad1944e36721fe6b2db
  /** The OS page size */
  #define DWC_OS_PAGE_SIZE	PAGE_SIZE
 
-From 1776d57f4d2d9e1241edd81b0f94b54d44d911bd Mon Sep 17 00:00:00 2001
+From 125d85e1fa84edc5dbcbc1585db3d8cb295f41e1 Mon Sep 17 00:00:00 2001
 From: Michael Zoran <mzoran@crowfest.net>
 Date: Sat, 14 Jan 2017 21:43:57 -0800
-Subject: [PATCH 103/173] ARM64: Round-Robin dispatch IRQs between CPUs.
+Subject: [PATCH 106/126] ARM64: Round-Robin dispatch IRQs between CPUs.
 
 IRQ-CPU mapping is round robined on ARM64 to increase
 concurrency and allow multiple interrupts to be serviced
@@ -114193,7 +115990,7 @@ Signed-off-by: Michael Zoran <mzoran@crowfest.net>
  2 files changed, 35 insertions(+), 1 deletion(-)
 
 diff --git a/drivers/irqchip/irq-bcm2835.c b/drivers/irqchip/irq-bcm2835.c
-index 8ed457fd74bd23bee27b64a2c9e3828ce0e4fb87..a035e1ceacc0494fa293e6811ff8f7e3ea05e362 100644
+index fee691736c124c57ede4ab47a7c6bfa3b7c3b681..2a11c648cb2fdd5b2ddf4afd1b7e4fc20eee4f4a 100644
 --- a/drivers/irqchip/irq-bcm2835.c
 +++ b/drivers/irqchip/irq-bcm2835.c
 @@ -168,10 +168,23 @@ static void armctrl_unmask_irq(struct irq_data *d)
@@ -114222,7 +116019,7 @@ index 8ed457fd74bd23bee27b64a2c9e3828ce0e4fb87..a035e1ceacc0494fa293e6811ff8f7e3
  
  static int armctrl_xlate(struct irq_domain *d, struct device_node *ctrlr,
 diff --git a/drivers/irqchip/irq-bcm2836.c b/drivers/irqchip/irq-bcm2836.c
-index c4e151451cf8c8ebde5225515eac2786d6f61d46..9a7ee04ee0d9b7aa734cf3159ed59c19a338de0d 100644
+index 86b357ae027bf8ba1ac32cd150a8cf21e36597e2..05b17ca993f405c4c8e61a782ec58149038069c2 100644
 --- a/drivers/irqchip/irq-bcm2836.c
 +++ b/drivers/irqchip/irq-bcm2836.c
 @@ -145,6 +145,27 @@ static void bcm2836_arm_irqchip_unmask_gpu_irq(struct irq_data *d)
@@ -114254,10 +116051,10 @@ index c4e151451cf8c8ebde5225515eac2786d6f61d46..9a7ee04ee0d9b7aa734cf3159ed59c19
  	.name		= "bcm2836-gpu",
  	.irq_mask	= bcm2836_arm_irqchip_mask_gpu_irq,
 
-From 32cdec81d123f94e87194e77a0e45b639880b130 Mon Sep 17 00:00:00 2001
+From 94a9a7da5190cae5f8d1f83a748dba114643f586 Mon Sep 17 00:00:00 2001
 From: Michael Zoran <mzoran@crowfest.net>
 Date: Sat, 14 Jan 2017 21:45:03 -0800
-Subject: [PATCH 104/173] ARM64: Enable DWC_OTG Driver In ARM64 Build
+Subject: [PATCH 107/126] ARM64: Enable DWC_OTG Driver In ARM64 Build
  Config(bcmrpi3_defconfig)
 
 Signed-off-by: Michael Zoran <mzoran@crowfest.net>
@@ -114278,10 +116075,10 @@ index b7d762df19b85e369a32cd823dfd062145bdefa7..4d85c231c5ea0244e1b05fb4a5e3c8fd
  CONFIG_USB_STORAGE=y
  CONFIG_USB_STORAGE_REALTEK=m
 
-From 3503301d0f63751ed4be814d6bf4c9c4e0cc0148 Mon Sep 17 00:00:00 2001
+From a94036ac67b6e8ad05fe34e97ce4ee2a661093a7 Mon Sep 17 00:00:00 2001
 From: Michael Zoran <mzoran@crowfest.net>
 Date: Sat, 11 Feb 2017 01:18:31 -0800
-Subject: [PATCH 105/173] ARM64: Force hardware emulation of deprecated
+Subject: [PATCH 108/126] ARM64: Force hardware emulation of deprecated
  instructions.
 
 ---
@@ -114309,10 +116106,10 @@ index f0e6d717885b1fcf3b22f64c10c38f19c25f809d..0cb830d30fb6d2bd26ab572efe893649
  	case INSN_OBSOLETE:
  		insn->current_mode = INSN_UNDEF;
 
-From c75fea4314f25493f1a4fa41c0495dccb07d45a2 Mon Sep 17 00:00:00 2001
+From d7ca8aaf05db6ecc6d03ccfea897aa6dbedc43f1 Mon Sep 17 00:00:00 2001
 From: Khem Raj <raj.khem@gmail.com>
 Date: Fri, 10 Feb 2017 17:57:08 -0800
-Subject: [PATCH 106/173] build/arm64: Add rules for .dtbo files for dts
+Subject: [PATCH 109/126] build/arm64: Add rules for .dtbo files for dts
  overlays
 
 We now create overlays as .dtbo files.
@@ -114337,115 +116134,41 @@ index 9b41f1e3b1a039cd45fe842e10abff0181186fdf..dc2859b8eed168ed52e95c503e7a5ce3
  
  dtbs: prepare scripts
 
-From 2f1efd7d3d0b00d0ee8d633a19534ac7442f3de4 Mon Sep 17 00:00:00 2001
-From: Eric Anholt <eric@anholt.net>
-Date: Mon, 9 May 2016 17:28:18 -0700
-Subject: [PATCH 107/173] clk: bcm2835: Mark GPIO clocks enabled at boot as
- critical.
-
-These divide off of PLLD_PER and are used for the ethernet and wifi
-PHYs source PLLs.  Neither of them is currently represented by a phy
-device that would grab the clock for us.
-
-This keeps other drivers from killing the networking PHYs when they
-disable their own clocks and trigger PLLD_PER's refcount going to 0.
-
-v2: Skip marking as critical if they aren't on at boot.
-
-Signed-off-by: Eric Anholt <eric@anholt.net>
----
- drivers/clk/bcm/clk-bcm2835.c | 9 +++++++++
- 1 file changed, 9 insertions(+)
-
-diff --git a/drivers/clk/bcm/clk-bcm2835.c b/drivers/clk/bcm/clk-bcm2835.c
-index 336f8c9c44325d0a94e591a8557f7af246adc857..caa05e5ad0b7b5cd683e04fb3591a3dfcb40823f 100644
---- a/drivers/clk/bcm/clk-bcm2835.c
-+++ b/drivers/clk/bcm/clk-bcm2835.c
-@@ -1484,6 +1484,15 @@ static struct clk_hw *bcm2835_register_clock(struct bcm2835_cprman *cprman,
- 	init.flags = data->flags | CLK_IGNORE_UNUSED;
- 
- 	/*
-+	 * Some GPIO clocks for ethernet/wifi PLLs are marked as
-+	 * critical (since some platforms use them), but if the
-+	 * firmware didn't have them turned on then they clearly
-+	 * aren't actually critical.
-+	 */
-+	if ((cprman_read(cprman, data->ctl_reg) & CM_ENABLE) == 0)
-+		init.flags &= ~CLK_IS_CRITICAL;
-+
-+	/*
- 	 * Pass the CLK_SET_RATE_PARENT flag if we are allowed to propagate
- 	 * rate changes on at least of the parents.
- 	 */
-
-From 3fc8182fc7a7b27f4867368e5ded2b76f9deefa6 Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Tue, 24 Feb 2015 13:40:50 +0000
-Subject: [PATCH 108/173] pinctrl-bcm2835: Fix interrupt handling for GPIOs
- 28-31 and 46-53
-
-Contrary to the documentation, the BCM2835 GPIO controller actually has
-four interrupt lines - one each for the three IRQ groups and one common. Rather
-confusingly, the GPIO interrupt groups don't correspond directly with the GPIO
-control banks. Instead, GPIOs 0-27 generate IRQ GPIO0, 28-45 GPIO1 and
-46-53 GPIO2.
-
-Awkwardly, the GPIOS for IRQ GPIO1 straddle two 32-entry GPIO banks, so it is
-cleaner to split out a function to process the interrupts for a single GPIO
-bank.
-
-This bug has only just been observed because GPIOs above 27 can only be
-accessed on an old Raspberry Pi with the optional P5 header fitted, where
-the pins are often used for I2S instead.
----
- drivers/pinctrl/bcm/pinctrl-bcm2835.c | 1 +
- 1 file changed, 1 insertion(+)
-
-diff --git a/drivers/pinctrl/bcm/pinctrl-bcm2835.c b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-index a9d480df32562defbf8be0faf0a39bfe06ff71f9..18c92bae3b2e7e9f8208ca0d4487b08b8ba61575 100644
---- a/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-+++ b/drivers/pinctrl/bcm/pinctrl-bcm2835.c
-@@ -1098,6 +1098,7 @@ static struct platform_driver bcm2835_pinctrl_driver = {
- 	.probe = bcm2835_pinctrl_probe,
- 	.driver = {
- 		.name = MODULE_NAME,
-+		.owner = THIS_MODULE,
- 		.of_match_table = bcm2835_pinctrl_match,
- 		.suppress_bind_attrs = true,
- 	},
-
-From 8d5d79c2d7ee7973c9901827d6a192b248f2a2eb Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Thu, 23 Mar 2017 10:06:56 +0000
-Subject: [PATCH 109/173] ASoC: Add prompt for ICS43432 codec
-
-Without a prompt string, a config setting can't be included in a
-defconfig. Give CONFIG_SND_SOC_ICS43432 a prompt so that Pi soundcards
-can use the driver.
+From bed3fc3bd8c50319c2c0b45b0667a487880887b2 Mon Sep 17 00:00:00 2001
+From: Bilal Amarni <bamarni@users.noreply.github.com>
+Date: Wed, 24 May 2017 10:52:50 +0200
+Subject: [PATCH 110/126] enable drivers for GPIO expander and vcio
 
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
 ---
- sound/soc/codecs/Kconfig | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
+ arch/arm64/configs/bcmrpi3_defconfig | 3 +++
+ 1 file changed, 3 insertions(+)
 
-diff --git a/sound/soc/codecs/Kconfig b/sound/soc/codecs/Kconfig
-index aca3a53f08dba8762307f7c25a5d7c5561b9cf71..a3be6e005a895b995897cc007bb85c780a42de8b 100644
---- a/sound/soc/codecs/Kconfig
-+++ b/sound/soc/codecs/Kconfig
-@@ -573,7 +573,7 @@ config SND_SOC_HDAC_HDMI
- 	select HDMI
- 
- config SND_SOC_ICS43432
--	tristate
-+	tristate "InvenSense ICS43432 I2S microphone codec"
- 
- config SND_SOC_INNO_RK3036
- 	tristate "Inno codec driver for RK3036 SoC"
+diff --git a/arch/arm64/configs/bcmrpi3_defconfig b/arch/arm64/configs/bcmrpi3_defconfig
+index 4d85c231c5ea0244e1b05fb4a5e3c8fd3e651ddf..9dcb58a519d041fadae99c81a7bda621b2a49f12 100644
+--- a/arch/arm64/configs/bcmrpi3_defconfig
++++ b/arch/arm64/configs/bcmrpi3_defconfig
+@@ -575,6 +575,8 @@ CONFIG_SERIO_RAW=m
+ CONFIG_GAMEPORT=m
+ CONFIG_GAMEPORT_NS558=m
+ CONFIG_GAMEPORT_L4=m
++CONFIG_BRCM_CHAR_DRIVERS=y
++CONFIG_BCM_VCIO=y
+ # CONFIG_BCM2835_DEVGPIOMEM is not set
+ # CONFIG_BCM2835_SMI_DEV is not set
+ # CONFIG_LEGACY_PTYS is not set
+@@ -609,6 +611,7 @@ CONFIG_PPS=m
+ CONFIG_PPS_CLIENT_LDISC=m
+ CONFIG_PPS_CLIENT_GPIO=m
+ CONFIG_GPIO_SYSFS=y
++CONFIG_GPIO_BCM_EXP=y
+ CONFIG_GPIO_BCM_VIRT=y
+ CONFIG_GPIO_ARIZONA=m
+ CONFIG_GPIO_STMPE=y
 
-From cacb59c057cd62127e01ef15603e71ddb7fcc7ce Mon Sep 17 00:00:00 2001
+From aa357815a03631654b585a795a8983609f6cdfc7 Mon Sep 17 00:00:00 2001
 From: Phil Elwell <phil@raspberrypi.org>
 Date: Thu, 23 Mar 2017 16:34:46 +0000
-Subject: [PATCH 110/173] bcm2835-aux: Add aux interrupt controller
+Subject: [PATCH 111/126] bcm2835-aux: Add aux interrupt controller
 
 The AUX block has a shared interrupt line with a register indicating
 which devices have active IRQs. Expose this as a nested interrupt
@@ -114609,213 +116332,10 @@ index bd750cf2238d61489811e7d7bd3b5f9950ed53c8..41e0702fae4692221980b0d02aed1ba6
  			       BCM2835_AUX_CLOCK_COUNT, GFP_KERNEL);
  	if (!onecell)
 
-From f2512ac2b55b875a24a50e59b889afc8140c254e Mon Sep 17 00:00:00 2001
-From: Stefan Agner <stefan@agner.ch>
-Date: Fri, 29 Apr 2016 10:32:17 -0700
-Subject: [PATCH 111/173] mmc: read mmc alias from device tree
-
-To get the SD/MMC host device ID, read the alias from the device
-tree.
-
-This is useful in case a SoC has multipe SD/MMC host controllers while
-the second controller should logically be the first device (e.g. if
-the second controller is connected to an internal eMMC). Combined
-with block device numbering using MMC/SD host device ID, this
-results in predictable name assignment of the internal eMMC block
-device.
-
-Signed-off-by: Stefan Agner <stefan@agner.ch>
-Signed-off-by: Dmitry Torokhov <dtor@chromium.org>
-[dianders: rebase + roll in http://crosreview.com/259916]
-Signed-off-by: Douglas Anderson <dianders@chromium.org>
----
- drivers/mmc/core/host.c | 17 ++++++++++++++++-
- 1 file changed, 16 insertions(+), 1 deletion(-)
-
-diff --git a/drivers/mmc/core/host.c b/drivers/mmc/core/host.c
-index 1503412f826cd0e0e9ad37a0554b31596a49eb77..2f5b3cf86293b96b104eac7c6d48a5839d7e974b 100644
---- a/drivers/mmc/core/host.c
-+++ b/drivers/mmc/core/host.c
-@@ -344,15 +344,30 @@ struct mmc_host *mmc_alloc_host(int extra, struct device *dev)
- {
- 	int err;
- 	struct mmc_host *host;
-+	int id;
- 
- 	host = kzalloc(sizeof(struct mmc_host) + extra, GFP_KERNEL);
- 	if (!host)
- 		return NULL;
- 
-+	/* If OF aliases exist, start dynamic assignment after highest */
-+	id = of_alias_get_highest_id("mmc");
-+	id = (id < 0) ? 0 : id + 1;
-+
-+	/* If this devices has OF node, maybe it has an alias */
-+	if (dev->of_node) {
-+		int of_id = of_alias_get_id(dev->of_node, "mmc");
-+
-+		if (of_id < 0)
-+			dev_warn(dev, "/aliases ID not available\n");
-+		else
-+			id = of_id;
-+	}
-+
- 	/* scanning will be enabled when we're ready */
- 	host->rescan_disable = 1;
- 
--	err = ida_simple_get(&mmc_host_ida, 0, 0, GFP_KERNEL);
-+	err = ida_simple_get(&mmc_host_ida, id, 0, GFP_KERNEL);
- 	if (err < 0) {
- 		kfree(host);
- 		return NULL;
-
-From ecf97118ac5de61d3bf2d83b466280ee29a63822 Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Wed, 11 May 2016 12:50:33 +0100
-Subject: [PATCH 112/173] mmc: Add MMC_QUIRK_ERASE_BROKEN for some cards
-
-Some SD cards have been found that corrupt data when small blocks
-are erased. Add a quirk to indicate that ERASE should not be used,
-and set it for cards of that type.
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
-
-mmc: Apply QUIRK_BROKEN_ERASE to other capacities
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
-
-mmc: Add card_quirks module parameter, log quirks
-
-Use mmc_block.card_quirks to override the quirks for all SD or MMC
-cards. The value is a bitfield using the bit positions defined in
-include/linux/mmc/card.h. If the module parameter is placed in the
-kernel command line (or bootargs) stored on the card then, assuming the
-device only has one SD card interface, the override effectively becomes
-card-specific.
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- drivers/mmc/core/block.c  | 28 +++++++++++++++++++++++++---
- drivers/mmc/core/core.c   |  3 ++-
- drivers/mmc/core/quirks.h | 11 +++++++++++
- include/linux/mmc/card.h  |  2 ++
- 4 files changed, 40 insertions(+), 4 deletions(-)
-
-diff --git a/drivers/mmc/core/block.c b/drivers/mmc/core/block.c
-index 8bd7aba811e969a3b7cfdc6cf12e685f25e8c37e..cd1eb5cf73358a0104fbf4b6ed8e72dd491d658d 100644
---- a/drivers/mmc/core/block.c
-+++ b/drivers/mmc/core/block.c
-@@ -125,6 +125,13 @@ static DEFINE_MUTEX(open_lock);
- module_param(perdev_minors, int, 0444);
- MODULE_PARM_DESC(perdev_minors, "Minors numbers to allocate per device");
- 
-+/*
-+ * Allow quirks to be overridden for the current card
-+ */
-+static char *card_quirks;
-+module_param(card_quirks, charp, 0644);
-+MODULE_PARM_DESC(card_quirks, "Force the use of the indicated quirks (a bitfield)");
-+
- static inline int mmc_blk_part_switch(struct mmc_card *card,
- 				      struct mmc_blk_data *md);
- 
-@@ -2287,6 +2294,7 @@ static int mmc_blk_probe(struct mmc_card *card)
- {
- 	struct mmc_blk_data *md, *part_md;
- 	char cap_str[10];
-+	char quirk_str[24];
- 
- 	/*
- 	 * Check that the card supports the command class(es) we need.
-@@ -2294,7 +2302,16 @@ static int mmc_blk_probe(struct mmc_card *card)
- 	if (!(card->csd.cmdclass & CCC_BLOCK_READ))
- 		return -ENODEV;
- 
--	mmc_fixup_device(card, mmc_blk_fixups);
-+	if (card_quirks) {
-+		unsigned long quirks;
-+		if (kstrtoul(card_quirks, 0, &quirks) == 0)
-+			card->quirks = (unsigned int)quirks;
-+		else
-+			pr_err("mmc_block: Invalid card_quirks parameter '%s'\n",
-+			       card_quirks);
-+	}
-+	else
-+		mmc_fixup_device(card, mmc_blk_fixups);
- 
- 	md = mmc_blk_alloc(card);
- 	if (IS_ERR(md))
-@@ -2302,9 +2319,14 @@ static int mmc_blk_probe(struct mmc_card *card)
- 
- 	string_get_size((u64)get_capacity(md->disk), 512, STRING_UNITS_2,
- 			cap_str, sizeof(cap_str));
--	pr_info("%s: %s %s %s %s\n",
-+	if (card->quirks)
-+		snprintf(quirk_str, sizeof(quirk_str),
-+			 " (quirks 0x%08x)", card->quirks);
-+	else
-+		quirk_str[0] = '\0';
-+	pr_info("%s: %s %s %s%s%s\n",
- 		md->disk->disk_name, mmc_card_id(card), mmc_card_name(card),
--		cap_str, md->read_only ? "(ro)" : "");
-+		cap_str, md->read_only ? " (ro)" : "", quirk_str);
- 
- 	if (mmc_blk_alloc_parts(card, md))
- 		goto out;
-diff --git a/drivers/mmc/core/core.c b/drivers/mmc/core/core.c
-index 26431267a3e2d790d4eae99e65881ca60bd2047d..0ec589ace762a27f3c5ea39226fef3a67442675f 100644
---- a/drivers/mmc/core/core.c
-+++ b/drivers/mmc/core/core.c
-@@ -2211,7 +2211,8 @@ EXPORT_SYMBOL(mmc_erase);
- int mmc_can_erase(struct mmc_card *card)
- {
- 	if ((card->host->caps & MMC_CAP_ERASE) &&
--	    (card->csd.cmdclass & CCC_ERASE) && card->erase_size)
-+	    (card->csd.cmdclass & CCC_ERASE) && card->erase_size &&
-+	    !(card->quirks & MMC_QUIRK_ERASE_BROKEN))
- 		return 1;
- 	return 0;
- }
-diff --git a/drivers/mmc/core/quirks.h b/drivers/mmc/core/quirks.h
-index fb725934fa21cee1b98fd7bc08227bf6d0317549..05c8d7381fff5ae88531129d9a5ddd554bddb43e 100644
---- a/drivers/mmc/core/quirks.h
-+++ b/drivers/mmc/core/quirks.h
-@@ -90,6 +90,17 @@ static const struct mmc_fixup mmc_blk_fixups[] = {
- 	MMC_FIXUP("V10016", CID_MANFID_KINGSTON, CID_OEMID_ANY, add_quirk_mmc,
- 		  MMC_QUIRK_TRIM_BROKEN),
- 
-+	/*
-+	 *  On some Kingston SD cards, multiple erases of less than 64
-+	 *  sectors can cause corruption.
-+	 */
-+	MMC_FIXUP("SD16G", 0x41, 0x3432, add_quirk_mmc,
-+		  MMC_QUIRK_ERASE_BROKEN),
-+	MMC_FIXUP("SD32G", 0x41, 0x3432, add_quirk_mmc,
-+		  MMC_QUIRK_ERASE_BROKEN),
-+	MMC_FIXUP("SD64G", 0x41, 0x3432, add_quirk_mmc,
-+		  MMC_QUIRK_ERASE_BROKEN),
-+
- 	END_FIXUP
- };
- 
-diff --git a/include/linux/mmc/card.h b/include/linux/mmc/card.h
-index 46c73e97e61f08a41d9753079345f5965caebbc5..388c551ed11e9d06ea1c25b6553d47a8d668953a 100644
---- a/include/linux/mmc/card.h
-+++ b/include/linux/mmc/card.h
-@@ -269,6 +269,8 @@ struct mmc_card {
- #define MMC_QUIRK_TRIM_BROKEN	(1<<12)		/* Skip trim */
- #define MMC_QUIRK_BROKEN_HPI	(1<<13)		/* Disable broken HPI support */
- 
-+#define MMC_QUIRK_ERASE_BROKEN	(1<<31)		/* Skip erase */
-+
- 	bool			reenable_cmdq;	/* Re-enable Command Queue */
- 
- 	unsigned int		erase_size;	/* erase size in sectors */
-
-From c8b7e3062f047e73581ea9467b79a0c7ca70282c Mon Sep 17 00:00:00 2001
+From c686be8337997ea04650b45945ea66a6ac0043e3 Mon Sep 17 00:00:00 2001
 From: Yasunari Takiguchi <Yasunari.Takiguchi@sony.com>
 Date: Fri, 14 Apr 2017 10:43:57 +0100
-Subject: [PATCH 113/173] This is the driver for Sony CXD2880 DVB-T2/T tuner +
+Subject: [PATCH 112/126] This is the driver for Sony CXD2880 DVB-T2/T tuner +
  demodulator. It includes the CXD2880 driver and the CXD2880 SPI adapter. The
  current CXD2880 driver version is 1.4.1 - 1.0.1 released on April 13, 2017.
 
@@ -114913,10 +116433,10 @@ Signed-off-by: Satoshi Watanabe <Satoshi.C.Watanabe@sony.com>
  create mode 100644 drivers/media/spi/cxd2880-spi.c
 
 diff --git a/drivers/media/dvb-frontends/Kconfig b/drivers/media/dvb-frontends/Kconfig
-index 3a260b82b3e8b15e8d26425ca1e9e6665e1ca1d9..6831f4a49c18e58aff7fc70cb1cd46f1701c52c0 100644
+index 2631d0e0a024d4989d8ff14e3fc91f714753f756..f2910083263931e4d6035f170ae27f82a41df163 100644
 --- a/drivers/media/dvb-frontends/Kconfig
 +++ b/drivers/media/dvb-frontends/Kconfig
-@@ -519,6 +519,8 @@ config DVB_GP8PSK_FE
+@@ -546,6 +546,8 @@ config DVB_GP8PSK_FE
  	depends on DVB_CORE
  	default DVB_USB_GP8PSK
  
@@ -114926,10 +116446,10 @@ index 3a260b82b3e8b15e8d26425ca1e9e6665e1ca1d9..6831f4a49c18e58aff7fc70cb1cd46f1
  	depends on DVB_CORE
  
 diff --git a/drivers/media/dvb-frontends/Makefile b/drivers/media/dvb-frontends/Makefile
-index 3fccaf34ef520acf4207710dbf15fd7c08cc62fa..d298c79546999f80a788309824fd6545b2d25ff7 100644
+index f45f6a4a437142226399142e0667850e214719d6..e6b387284f6f26e9677757979763f6c1c170a4f1 100644
 --- a/drivers/media/dvb-frontends/Makefile
 +++ b/drivers/media/dvb-frontends/Makefile
-@@ -126,3 +126,4 @@ obj-$(CONFIG_DVB_HORUS3A) += horus3a.o
+@@ -129,3 +129,4 @@ obj-$(CONFIG_DVB_HORUS3A) += horus3a.o
  obj-$(CONFIG_DVB_ASCOT2E) += ascot2e.o
  obj-$(CONFIG_DVB_HELENE) += helene.o
  obj-$(CONFIG_DVB_ZD1301_DEMOD) += zd1301_demod.o
@@ -130947,10 +132467,10 @@ index 0000000000000000000000000000000000000000..82e122349055be817eb74ed5bbcd7560
 +MODULE_AUTHOR("Sony Semiconductor Solutions Corporation");
 +MODULE_LICENSE("GPL v2");
 
-From 2572d44289de83da22f0c5537264db7ab390d054 Mon Sep 17 00:00:00 2001
+From 30d5793af3e03a3556b8bd1418fc31db40cffd81 Mon Sep 17 00:00:00 2001
 From: Eric Anholt <eric@anholt.net>
 Date: Wed, 14 Sep 2016 09:18:09 +0100
-Subject: [PATCH 114/173] raspberrypi-firmware: Define the MBOX channel in the
+Subject: [PATCH 113/126] raspberrypi-firmware: Define the MBOX channel in the
  header.
 
 Signed-off-by: Eric Anholt <eric@anholt.net>
@@ -130972,10 +132492,10 @@ index c819c21b0158a59c1308882e5a40e3f3fe73cbdf..de2a3dcd562beb752266eaf0070e5586
  
  enum rpi_firmware_property_status {
 
-From 6a1197ebcdaf028b90367012c289167371d085c8 Mon Sep 17 00:00:00 2001
+From b3b354f72d8938ea6792846557e29471a6b81d00 Mon Sep 17 00:00:00 2001
 From: Eric Anholt <eric@anholt.net>
 Date: Wed, 14 Sep 2016 09:16:19 +0100
-Subject: [PATCH 115/173] raspberrypi-firmware: Export the general transaction
+Subject: [PATCH 114/126] raspberrypi-firmware: Export the general transaction
  function.
 
 The vc4-firmware-kms module is going to be doing the MBOX FB call.
@@ -131019,10 +132539,10 @@ index de2a3dcd562beb752266eaf0070e55861d553f5f..dc7fd58afd5dddebf9b17065bb069a1d
  
  #endif /* __SOC_RASPBERRY_FIRMWARE_H__ */
 
-From ca0b875af245f0577d38b589bd7c32680ef13e0c Mon Sep 17 00:00:00 2001
+From dd1120be1bbf472f3381d061b88150190e107dd4 Mon Sep 17 00:00:00 2001
 From: Eric Anholt <eric@anholt.net>
 Date: Wed, 14 Sep 2016 08:39:33 +0100
-Subject: [PATCH 116/173] drm/vc4: Add a mode for using the closed firmware for
+Subject: [PATCH 115/126] drm/vc4: Add a mode for using the closed firmware for
  display.
 
 Signed-off-by: Eric Anholt <eric@anholt.net>
@@ -131031,8 +132551,8 @@ Signed-off-by: Eric Anholt <eric@anholt.net>
  drivers/gpu/drm/vc4/vc4_crtc.c         |  17 +
  drivers/gpu/drm/vc4/vc4_drv.c          |   1 +
  drivers/gpu/drm/vc4/vc4_drv.h          |   7 +
- drivers/gpu/drm/vc4/vc4_firmware_kms.c | 657 +++++++++++++++++++++++++++++++++
- 5 files changed, 683 insertions(+)
+ drivers/gpu/drm/vc4/vc4_firmware_kms.c | 656 +++++++++++++++++++++++++++++++++
+ 5 files changed, 682 insertions(+)
  create mode 100644 drivers/gpu/drm/vc4/vc4_firmware_kms.c
 
 diff --git a/drivers/gpu/drm/vc4/Makefile b/drivers/gpu/drm/vc4/Makefile
@@ -131048,7 +132568,7 @@ index 25bd5d30415df55e4715334a597ca1e7b3012bd7..e365d1f4d816762b2251f489e3b8fcc3
  	vc4_gem.o \
  	vc4_hdmi.o \
 diff --git a/drivers/gpu/drm/vc4/vc4_crtc.c b/drivers/gpu/drm/vc4/vc4_crtc.c
-index a12cc7ea99b608f2f36ffb24475c4561060d08c3..58ee7945cfcb6b62ea7550814aae4741b8812080 100644
+index ce1e3b9e14c9ac2e676ad760f653fd6d7091f964..2e9f75ed8b67727aef6ca94bb0c8a6fab0f5370c 100644
 --- a/drivers/gpu/drm/vc4/vc4_crtc.c
 +++ b/drivers/gpu/drm/vc4/vc4_crtc.c
 @@ -164,6 +164,9 @@ bool vc4_crtc_get_scanoutpos(struct drm_device *dev, unsigned int crtc_id,
@@ -131061,7 +132581,7 @@ index a12cc7ea99b608f2f36ffb24475c4561060d08c3..58ee7945cfcb6b62ea7550814aae4741
  	/* preempt_disable_rt() should go right here in PREEMPT_RT patchset. */
  
  	/* Get optional system timestamp before query. */
-@@ -668,8 +671,15 @@ static void vc4_crtc_atomic_flush(struct drm_crtc *crtc,
+@@ -682,8 +685,15 @@ static void vc4_crtc_atomic_flush(struct drm_crtc *crtc,
  
  static int vc4_enable_vblank(struct drm_crtc *crtc)
  {
@@ -131077,7 +132597,7 @@ index a12cc7ea99b608f2f36ffb24475c4561060d08c3..58ee7945cfcb6b62ea7550814aae4741
  	CRTC_WRITE(PV_INTEN, PV_INT_VFP_START);
  
  	return 0;
-@@ -677,8 +687,15 @@ static int vc4_enable_vblank(struct drm_crtc *crtc)
+@@ -691,8 +701,15 @@ static int vc4_enable_vblank(struct drm_crtc *crtc)
  
  static void vc4_disable_vblank(struct drm_crtc *crtc)
  {
@@ -131094,10 +132614,10 @@ index a12cc7ea99b608f2f36ffb24475c4561060d08c3..58ee7945cfcb6b62ea7550814aae4741
  }
  
 diff --git a/drivers/gpu/drm/vc4/vc4_drv.c b/drivers/gpu/drm/vc4/vc4_drv.c
-index c6b487c3d2b7645b0ae249f0ce40f4795c80bf1f..51eeca16fcfe8df6ade44376dcb9ef66eeeddee5 100644
+index 1c96edcb302be825cb3aeb438ab9a59c63fb6052..8555069607e1f3b735be3132320dacef2e66e8f8 100644
 --- a/drivers/gpu/drm/vc4/vc4_drv.c
 +++ b/drivers/gpu/drm/vc4/vc4_drv.c
-@@ -314,6 +314,7 @@ static struct platform_driver *const component_drivers[] = {
+@@ -317,6 +317,7 @@ static struct platform_driver *const component_drivers[] = {
  	&vc4_dsi_driver,
  	&vc4_hvs_driver,
  	&vc4_crtc_driver,
@@ -131106,10 +132626,10 @@ index c6b487c3d2b7645b0ae249f0ce40f4795c80bf1f..51eeca16fcfe8df6ade44376dcb9ef66
  };
  
 diff --git a/drivers/gpu/drm/vc4/vc4_drv.h b/drivers/gpu/drm/vc4/vc4_drv.h
-index df22698d62ee5ca89f00bcd42b10a6862506a4cf..e2d16a9316e255bce00b38b6734b73efc354db77 100644
+index 87f2d8e5c1346c1ccab7292c4c80dc553c48438d..9d5e35ea5a7c9f134ec6e661b0056b47df9719ef 100644
 --- a/drivers/gpu/drm/vc4/vc4_drv.h
 +++ b/drivers/gpu/drm/vc4/vc4_drv.h
-@@ -14,6 +14,9 @@
+@@ -32,6 +32,9 @@ enum vc4_kernel_bo_type {
  struct vc4_dev {
  	struct drm_device *dev;
  
@@ -131119,7 +132639,7 @@ index df22698d62ee5ca89f00bcd42b10a6862506a4cf..e2d16a9316e255bce00b38b6734b73ef
  	struct vc4_hdmi *hdmi;
  	struct vc4_hvs *hvs;
  	struct vc4_v3d *v3d;
-@@ -515,6 +518,10 @@ int vc4_dsi_debugfs_regs(struct seq_file *m, void *unused);
+@@ -539,6 +542,10 @@ int vc4_dsi_debugfs_regs(struct seq_file *m, void *unused);
  /* vc4_fence.c */
  extern const struct dma_fence_ops vc4_fence_ops;
  
@@ -131132,10 +132652,10 @@ index df22698d62ee5ca89f00bcd42b10a6862506a4cf..e2d16a9316e255bce00b38b6734b73ef
  void vc4_gem_destroy(struct drm_device *dev);
 diff --git a/drivers/gpu/drm/vc4/vc4_firmware_kms.c b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
 new file mode 100644
-index 0000000000000000000000000000000000000000..7dd233eed677c1689492ab95bc86475330d2d63b
+index 0000000000000000000000000000000000000000..78c34305935501248b1ca548a1ee01753b8fa099
 --- /dev/null
 +++ b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
-@@ -0,0 +1,657 @@
+@@ -0,0 +1,656 @@
 +/*
 + * Copyright (C) 2016 Broadcom
 + *
@@ -131402,7 +132922,7 @@ index 0000000000000000000000000000000000000000..7dd233eed677c1689492ab95bc864753
 +	plane = &vc4_plane->base;
 +	ret = drm_universal_plane_init(dev, plane, 0xff,
 +				       &vc4_plane_funcs,
-+				       primary ? &xrgb8888 : &argb8888, 1,
++				       primary ? &xrgb8888 : &argb8888, 1, NULL,
 +				       type, NULL);
 +
 +	if (type == DRM_PLANE_TYPE_PRIMARY) {
@@ -131431,11 +132951,11 @@ index 0000000000000000000000000000000000000000..7dd233eed677c1689492ab95bc864753
 +	/* Everyting is handled in the planes. */
 +}
 +
-+static void vc4_crtc_disable(struct drm_crtc *crtc)
++static void vc4_crtc_disable(struct drm_crtc *crtc, struct drm_crtc_state *old_state)
 +{
 +}
 +
-+static void vc4_crtc_enable(struct drm_crtc *crtc)
++static void vc4_crtc_enable(struct drm_crtc *crtc, struct drm_crtc_state *old_state)
 +{
 +}
 +
@@ -131508,8 +133028,8 @@ index 0000000000000000000000000000000000000000..7dd233eed677c1689492ab95bc864753
 +
 +static const struct drm_crtc_helper_funcs vc4_crtc_helper_funcs = {
 +	.mode_set_nofb = vc4_crtc_mode_set_nofb,
-+	.disable = vc4_crtc_disable,
-+	.enable = vc4_crtc_enable,
++	.atomic_disable = vc4_crtc_disable,
++	.atomic_enable = vc4_crtc_enable,
 +	.atomic_check = vc4_crtc_atomic_check,
 +	.atomic_flush = vc4_crtc_atomic_flush,
 +};
@@ -131584,7 +133104,6 @@ index 0000000000000000000000000000000000000000..7dd233eed677c1689492ab95bc864753
 +}
 +
 +static const struct drm_connector_funcs vc4_fkms_connector_funcs = {
-+	.dpms = drm_atomic_helper_connector_dpms,
 +	.detect = vc4_fkms_connector_detect,
 +	.fill_modes = drm_helper_probe_single_connector_modes,
 +	.destroy = vc4_fkms_connector_destroy,
@@ -131794,10 +133313,10 @@ index 0000000000000000000000000000000000000000..7dd233eed677c1689492ab95bc864753
 +	},
 +};
 
-From 8d12d4e3904b051c0df8fcfa3aa5dedc93ec6e6c Mon Sep 17 00:00:00 2001
+From c082cb7ffa9d26f212c801212cfba6fa8d2b9979 Mon Sep 17 00:00:00 2001
 From: Eric Anholt <eric@anholt.net>
 Date: Wed, 1 Feb 2017 17:09:18 -0800
-Subject: [PATCH 117/173] drm/vc4: Name the primary and cursor planes in fkms.
+Subject: [PATCH 116/126] drm/vc4: Name the primary and cursor planes in fkms.
 
 This makes debugging nicer, compared to trying to remember what the
 IDs are.
@@ -131808,23 +133327,23 @@ Signed-off-by: Eric Anholt <eric@anholt.net>
  1 file changed, 1 insertion(+), 1 deletion(-)
 
 diff --git a/drivers/gpu/drm/vc4/vc4_firmware_kms.c b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
-index 7dd233eed677c1689492ab95bc86475330d2d63b..e6097046fb25361bc61d657083d95b634232aabc 100644
+index 78c34305935501248b1ca548a1ee01753b8fa099..d9a5551d01a2155e3df1bbbd78a1ee2b961be946 100644
 --- a/drivers/gpu/drm/vc4/vc4_firmware_kms.c
 +++ b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
 @@ -265,7 +265,7 @@ static struct drm_plane *vc4_fkms_plane_init(struct drm_device *dev,
  	ret = drm_universal_plane_init(dev, plane, 0xff,
  				       &vc4_plane_funcs,
- 				       primary ? &xrgb8888 : &argb8888, 1,
+ 				       primary ? &xrgb8888 : &argb8888, 1, NULL,
 -				       type, NULL);
 +				       type, primary ? "primary" : "cursor");
  
  	if (type == DRM_PLANE_TYPE_PRIMARY) {
  		vc4_plane->fbinfo =
 
-From f561f2b6efcfec7d3daae3b9c3288533d192c6d6 Mon Sep 17 00:00:00 2001
+From 96539df86339240be282586f5530c8f902202e4a Mon Sep 17 00:00:00 2001
 From: Eric Anholt <eric@anholt.net>
 Date: Wed, 1 Feb 2017 17:10:09 -0800
-Subject: [PATCH 118/173] drm/vc4: Add DRM_DEBUG_ATOMIC for the insides of
+Subject: [PATCH 117/126] drm/vc4: Add DRM_DEBUG_ATOMIC for the insides of
  fkms.
 
 Trying to debug weston on fkms involved figuring out what calls I was
@@ -131836,7 +133355,7 @@ Signed-off-by: Eric Anholt <eric@anholt.net>
  1 file changed, 26 insertions(+)
 
 diff --git a/drivers/gpu/drm/vc4/vc4_firmware_kms.c b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
-index e6097046fb25361bc61d657083d95b634232aabc..72d0b9cffe3d2997d69040c46f4aee11e22aa213 100644
+index d9a5551d01a2155e3df1bbbd78a1ee2b961be946..e372666af0119b1876bad5167e6d0ff8945d1b80 100644
 --- a/drivers/gpu/drm/vc4/vc4_firmware_kms.c
 +++ b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
 @@ -101,6 +101,11 @@ static int vc4_plane_set_primary_blank(struct drm_plane *plane, bool blank)
@@ -131894,10 +133413,10 @@ index e6097046fb25361bc61d657083d95b634232aabc..72d0b9cffe3d2997d69040c46f4aee11
  				    RPI_FIRMWARE_SET_CURSOR_STATE,
  				    &packet_state,
 
-From 59e5aba1a8af1803c655cfec60ba4ef0fda99424 Mon Sep 17 00:00:00 2001
+From 129eb65435ce463b55fa85e1f35f0fba55778d43 Mon Sep 17 00:00:00 2001
 From: Eric Anholt <eric@anholt.net>
 Date: Thu, 2 Feb 2017 09:42:18 -0800
-Subject: [PATCH 119/173] drm/vc4: Fix sending of page flip completion events
+Subject: [PATCH 118/126] drm/vc4: Fix sending of page flip completion events
  in FKMS mode.
 
 In the rewrite of vc4_crtc.c for fkms, I dropped the part of the
@@ -131913,7 +133432,7 @@ Signed-off-by: Eric Anholt <eric@anholt.net>
  1 file changed, 15 insertions(+)
 
 diff --git a/drivers/gpu/drm/vc4/vc4_firmware_kms.c b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
-index 72d0b9cffe3d2997d69040c46f4aee11e22aa213..185f9bd3c1b2d47d0c1fc5293db4199bd8963023 100644
+index e372666af0119b1876bad5167e6d0ff8945d1b80..4d7b7f218cbbc9e7abcaa37743978060b73fbdd1 100644
 --- a/drivers/gpu/drm/vc4/vc4_firmware_kms.c
 +++ b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
 @@ -336,6 +336,21 @@ static int vc4_crtc_atomic_check(struct drm_crtc *crtc,
@@ -131939,10 +133458,10 @@ index 72d0b9cffe3d2997d69040c46f4aee11e22aa213..185f9bd3c1b2d47d0c1fc5293db4199b
  
  static void vc4_crtc_handle_page_flip(struct vc4_crtc *vc4_crtc)
 
-From 86905ab00857eb22f1eb8909858ba2e7e3a9165a Mon Sep 17 00:00:00 2001
+From 9b8c66c804be7aa2207577a844915cad68ea041c Mon Sep 17 00:00:00 2001
 From: popcornmix <popcornmix@gmail.com>
 Date: Tue, 18 Apr 2017 21:43:46 +0100
-Subject: [PATCH 120/173] vc4_fkms: Apply firmware overscan offset to hardware
+Subject: [PATCH 119/126] vc4_fkms: Apply firmware overscan offset to hardware
  cursor
 
 ---
@@ -131950,7 +133469,7 @@ Subject: [PATCH 120/173] vc4_fkms: Apply firmware overscan offset to hardware
  1 file changed, 17 insertions(+)
 
 diff --git a/drivers/gpu/drm/vc4/vc4_firmware_kms.c b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
-index 185f9bd3c1b2d47d0c1fc5293db4199bd8963023..072f377b7423ee603d73ace2bf6d620f00204862 100644
+index 4d7b7f218cbbc9e7abcaa37743978060b73fbdd1..d170775ccc985637ff018804f510a5003933c9ec 100644
 --- a/drivers/gpu/drm/vc4/vc4_firmware_kms.c
 +++ b/drivers/gpu/drm/vc4/vc4_firmware_kms.c
 @@ -39,6 +39,7 @@ struct vc4_crtc {
@@ -131982,7 +133501,7 @@ index 185f9bd3c1b2d47d0c1fc5293db4199bd8963023..072f377b7423ee603d73ace2bf6d620f
  	ret = rpi_firmware_property(vc4->firmware,
  				    RPI_FIRMWARE_SET_CURSOR_STATE,
  				    &packet_state,
-@@ -642,6 +650,15 @@ static int vc4_fkms_bind(struct device *dev, struct device *master, void *data)
+@@ -641,6 +649,15 @@ static int vc4_fkms_bind(struct device *dev, struct device *master, void *data)
  	if (ret)
  		goto err_destroy_connector;
  
@@ -131999,1031 +133518,10 @@ index 185f9bd3c1b2d47d0c1fc5293db4199bd8963023..072f377b7423ee603d73ace2bf6d620f
  
  	return 0;
 
-From 4a5fef4b0d90416a76e64de8f4dbc2d75924894f Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Tue, 16 May 2017 14:39:49 +0100
-Subject: [PATCH 121/173] mmc: Change downstream MMC driver CONFIG option
-
-The upstream SDHOST driver has now claimed CONFIG_MMC_BCM2835, which
-clashes with the downstream MMC driver. Rename the downstream option to
-CONFIG_MMC_BCM2835_MMC.
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- drivers/mmc/host/Kconfig  | 4 ++--
- drivers/mmc/host/Makefile | 2 +-
- 2 files changed, 3 insertions(+), 3 deletions(-)
-
-diff --git a/drivers/mmc/host/Kconfig b/drivers/mmc/host/Kconfig
-index 64bd7825131d3dcb003e7ece581b8d599a717b31..d47cce77c0551d78fa51f50e2c8086f26c7b9e56 100644
---- a/drivers/mmc/host/Kconfig
-+++ b/drivers/mmc/host/Kconfig
-@@ -4,7 +4,7 @@
- 
- comment "MMC/SD/SDIO Host Controller Drivers"
- 
--config MMC_BCM2835
-+config MMC_BCM2835_MMC
- 	tristate "MMC support on BCM2835"
- 	depends on MACH_BCM2708 || MACH_BCM2709 || ARCH_BCM2835
- 	help
-@@ -16,7 +16,7 @@ config MMC_BCM2835
- 
- config MMC_BCM2835_DMA
- 	bool "DMA support on BCM2835 Arasan controller"
--	depends on MMC_BCM2835
-+	depends on MMC_BCM2835_MMC
- 	help
- 	  Enable DMA support on the Arasan SDHCI controller in Broadcom 2708
- 	  based chips.
-diff --git a/drivers/mmc/host/Makefile b/drivers/mmc/host/Makefile
-index cd3a47d8965958ccf3ac3d186a05bbd437494154..9ba643d3b2e12960f5ce4b0eb5d75c1c360980ce 100644
---- a/drivers/mmc/host/Makefile
-+++ b/drivers/mmc/host/Makefile
-@@ -18,7 +18,7 @@ obj-$(CONFIG_MMC_SDHCI_S3C)	+= sdhci-s3c.o
- obj-$(CONFIG_MMC_SDHCI_SIRF)   	+= sdhci-sirf.o
- obj-$(CONFIG_MMC_SDHCI_F_SDH30)	+= sdhci_f_sdh30.o
- obj-$(CONFIG_MMC_SDHCI_SPEAR)	+= sdhci-spear.o
--obj-$(CONFIG_MMC_BCM2835)	+= bcm2835-mmc.o
-+obj-$(CONFIG_MMC_BCM2835_MMC)	+= bcm2835-mmc.o
- obj-$(CONFIG_MMC_BCM2835_SDHOST)	+= bcm2835-sdhost.o
- obj-$(CONFIG_MMC_WBSD)		+= wbsd.o
- obj-$(CONFIG_MMC_AU1X)		+= au1xmmc.o
-
-From 451c7dce838d727f0e9d6ad48ccdff3e8365a20e Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Tue, 16 May 2017 19:34:52 +0100
-Subject: [PATCH 122/173] config: Add CONFIG_I2C_ROBOTFUZZ_OSIF
-
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index 93cdfa4ce3e7d3ff9f437a05a9ee6bcf4b895a20..4afeb9120a1d8411648c9ac685665aeb395af448 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -614,6 +614,7 @@ CONFIG_I2C_MUX_PCA954x=m
- CONFIG_I2C_BCM2708=m
- CONFIG_I2C_BCM2835=m
- CONFIG_I2C_GPIO=m
-+CONFIG_I2C_ROBOTFUZZ_OSIF=m
- CONFIG_SPI=y
- CONFIG_SPI_BCM2835=m
- CONFIG_SPI_BCM2835AUX=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index 29fd2abc2cbfcaed37cb630b5edffaa5b4994f6e..05d6d108cb2d013588ccc971c83dcd212308f230 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -610,6 +610,7 @@ CONFIG_I2C_MUX_PCA954x=m
- CONFIG_I2C_BCM2708=m
- CONFIG_I2C_BCM2835=m
- CONFIG_I2C_GPIO=m
-+CONFIG_I2C_ROBOTFUZZ_OSIF=m
- CONFIG_SPI=y
- CONFIG_SPI_BCM2835=m
- CONFIG_SPI_BCM2835AUX=m
-
-From e9a21552d4dbd7a939b72176dab7d056724fdf8b Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Thu, 18 May 2017 11:40:43 +0100
-Subject: [PATCH 123/173] config: Add FB_TFT_ST7789V module
-
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index 4afeb9120a1d8411648c9ac685665aeb395af448..cdf0206ea890c3843542f8f1db546e93e9a1f8ba 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -1138,6 +1138,7 @@ CONFIG_FB_TFT_SSD1306=m
- CONFIG_FB_TFT_SSD1331=m
- CONFIG_FB_TFT_SSD1351=m
- CONFIG_FB_TFT_ST7735R=m
-+CONFIG_FB_TFT_ST7789V=m
- CONFIG_FB_TFT_TINYLCD=m
- CONFIG_FB_TFT_TLS8204=m
- CONFIG_FB_TFT_UC1701=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index 05d6d108cb2d013588ccc971c83dcd212308f230..54175b3c558e89d56b7d65752bccc6bdaebcfd5a 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -1145,6 +1145,7 @@ CONFIG_FB_TFT_SSD1306=m
- CONFIG_FB_TFT_SSD1331=m
- CONFIG_FB_TFT_SSD1351=m
- CONFIG_FB_TFT_ST7735R=m
-+CONFIG_FB_TFT_ST7789V=m
- CONFIG_FB_TFT_TINYLCD=m
- CONFIG_FB_TFT_TLS8204=m
- CONFIG_FB_TFT_UC1701=m
-
-From 65838dba857839a2f18ea265152747eaf9738da9 Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Thu, 18 May 2017 15:36:46 +0100
-Subject: [PATCH 124/173] staging: bcm2835-audio: Fix memory corruption
-
-I'm all for fixing memory leaks, but freeing a block while it is still
-being used is a recipe for hard-to-debug kernel exeptions.
-
-1) There is already a vchi method for freeing the instance, so use it.
-2) Only call it on error, and then only before initted is false.
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
-Fixes: 0adbfd4694c2 ("staging: bcm2835-audio: fix memory leak in bcm2835_audio_open_connection()")
----
- drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
-diff --git a/drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c b/drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c
-index 5f3d8f2339e34834d11edfa8de1d5819e3e32b4f..89f96f3c02805f4114ec9b488e18d00e1f348239 100644
---- a/drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c
-+++ b/drivers/staging/vc04_services/bcm2835-audio/bcm2835-vchiq.c
-@@ -409,6 +409,7 @@ static int bcm2835_audio_open_connection(struct bcm2835_alsa_stream *alsa_stream
- 			LOG_ERR("%s: failed to connect VCHI instance (ret=%d)\n",
- 				__func__, ret);
- 
-+			vchi_disconnect(vchi_instance);
- 			ret = -EIO;
- 			goto err_free_mem;
- 		}
-@@ -431,7 +432,6 @@ static int bcm2835_audio_open_connection(struct bcm2835_alsa_stream *alsa_stream
- 	LOG_DBG(" success !\n");
- 	ret = 0;
- err_free_mem:
--	kfree(vchi_instance);
- 
- 	return ret;
- }
-
-From 65e912f0f3280b6facb6f9e89747c498cb38d706 Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Mon, 15 May 2017 16:40:05 +0100
-Subject: [PATCH 125/173] config: Add CONFIG_TOUCHSCREEN_GOODIX
-
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 -
- 2 files changed, 1 insertion(+), 1 deletion(-)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index cdf0206ea890c3843542f8f1db546e93e9a1f8ba..2624359759f0318290287c6201cf7e511367128d 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -566,6 +566,7 @@ CONFIG_INPUT_TOUCHSCREEN=y
- CONFIG_TOUCHSCREEN_ADS7846=m
- CONFIG_TOUCHSCREEN_EGALAX=m
- CONFIG_TOUCHSCREEN_EDT_FT5X06=m
-+CONFIG_TOUCHSCREEN_GOODIX=m
- CONFIG_TOUCHSCREEN_RPI_FT5406=m
- CONFIG_TOUCHSCREEN_USB_COMPOSITE=m
- CONFIG_TOUCHSCREEN_STMPE=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index 54175b3c558e89d56b7d65752bccc6bdaebcfd5a..1d2d27cb950b5e799370b7ca557f4bcb2508169b 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -560,7 +560,6 @@ CONFIG_JOYSTICK_RPISENSE=m
- CONFIG_INPUT_TOUCHSCREEN=y
- CONFIG_TOUCHSCREEN_ADS7846=m
- CONFIG_TOUCHSCREEN_EGALAX=m
--CONFIG_TOUCHSCREEN_EDT_FT5X06=m
- CONFIG_TOUCHSCREEN_GOODIX=m
- CONFIG_TOUCHSCREEN_RPI_FT5406=m
- CONFIG_TOUCHSCREEN_USB_COMPOSITE=m
-
-From 128dd2e40b0ddd9e1259a063cd9d3aac04d289d6 Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Tue, 16 May 2017 15:58:00 +0100
-Subject: [PATCH 126/173] config: Add CONFIG_TOUCHSCREEN_EDT_FT5X06
-
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index 2624359759f0318290287c6201cf7e511367128d..e1855e95ad612c5c615da8edd90b9b6cfd4e0807 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -567,6 +567,7 @@ CONFIG_TOUCHSCREEN_ADS7846=m
- CONFIG_TOUCHSCREEN_EGALAX=m
- CONFIG_TOUCHSCREEN_EDT_FT5X06=m
- CONFIG_TOUCHSCREEN_GOODIX=m
-+CONFIG_TOUCHSCREEN_EDT_FT5X06=m
- CONFIG_TOUCHSCREEN_RPI_FT5406=m
- CONFIG_TOUCHSCREEN_USB_COMPOSITE=m
- CONFIG_TOUCHSCREEN_STMPE=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index 1d2d27cb950b5e799370b7ca557f4bcb2508169b..de0b998202e23eec39fafce0e8cd346e68817f6c 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -561,6 +561,7 @@ CONFIG_INPUT_TOUCHSCREEN=y
- CONFIG_TOUCHSCREEN_ADS7846=m
- CONFIG_TOUCHSCREEN_EGALAX=m
- CONFIG_TOUCHSCREEN_GOODIX=m
-+CONFIG_TOUCHSCREEN_EDT_FT5X06=m
- CONFIG_TOUCHSCREEN_RPI_FT5406=m
- CONFIG_TOUCHSCREEN_USB_COMPOSITE=m
- CONFIG_TOUCHSCREEN_STMPE=m
-
-From d9e51f8dfd5eee9e765b27ae146f0ad190eca7c1 Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Mon, 22 May 2017 13:35:28 +0100
-Subject: [PATCH 127/173] config: Add CONFIG_IPV6_SIT_6RD
-
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index e1855e95ad612c5c615da8edd90b9b6cfd4e0807..43928722d8f751b137d40ac22ae672bc6282c091 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -106,6 +106,7 @@ CONFIG_IPV6_ROUTER_PREF=y
- CONFIG_INET6_AH=m
- CONFIG_INET6_ESP=m
- CONFIG_INET6_IPCOMP=m
-+CONFIG_IPV6_SIT_6RD=y
- CONFIG_IPV6_TUNNEL=m
- CONFIG_IPV6_MULTIPLE_TABLES=y
- CONFIG_IPV6_SUBTREES=y
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index de0b998202e23eec39fafce0e8cd346e68817f6c..c4d82bec0aefc191c6049500fbeda6ea0a47f590 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -101,6 +101,7 @@ CONFIG_IPV6_ROUTER_PREF=y
- CONFIG_INET6_AH=m
- CONFIG_INET6_ESP=m
- CONFIG_INET6_IPCOMP=m
-+CONFIG_IPV6_SIT_6RD=y
- CONFIG_IPV6_TUNNEL=m
- CONFIG_IPV6_MULTIPLE_TABLES=y
- CONFIG_IPV6_SUBTREES=y
-
-From ec2378c3a78dff7313dc551eb857e74cb36e5bd2 Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Mon, 22 May 2017 15:28:27 +0100
-Subject: [PATCH 128/173] config: Add CONFIG_IPV6_ROUTE_INFO
-
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index 43928722d8f751b137d40ac22ae672bc6282c091..ba89462cf80f17e6275c1e7912d754d672d4c68d 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -103,6 +103,7 @@ CONFIG_TCP_CONG_ADVANCED=y
- CONFIG_TCP_CONG_BBR=m
- CONFIG_IPV6=m
- CONFIG_IPV6_ROUTER_PREF=y
-+CONFIG_IPV6_ROUTE_INFO=y
- CONFIG_INET6_AH=m
- CONFIG_INET6_ESP=m
- CONFIG_INET6_IPCOMP=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index c4d82bec0aefc191c6049500fbeda6ea0a47f590..7d3522df2b28e53cb63a0813168918792b65becb 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -98,6 +98,7 @@ CONFIG_TCP_CONG_ADVANCED=y
- CONFIG_TCP_CONG_BBR=m
- CONFIG_IPV6=m
- CONFIG_IPV6_ROUTER_PREF=y
-+CONFIG_IPV6_ROUTE_INFO=y
- CONFIG_INET6_AH=m
- CONFIG_INET6_ESP=m
- CONFIG_INET6_IPCOMP=m
-
-From 30f1a565079205ce4c5d797b03f62001d5b1e119 Mon Sep 17 00:00:00 2001
-From: P33M <p33m@github.com>
-Date: Thu, 25 May 2017 16:04:53 +0100
-Subject: [PATCH 129/173] dwc_otg: make periodic scheduling behave properly for
- FS buses
-
-If the root port is in full-speed mode, transfer times at 12mbit/s
-would be calculated but matched against high-speed quotas.
-
-Reinitialise hcd->frame_usecs[i] on each port enable event so that
-full-speed bandwidth can be tracked sensibly.
-
-Also, don't bother using the FIQ for transfers when in full-speed
-mode - at the slower bus speed, interrupt frequency is reduced by
-an order of magnitude.
-
-Related issue: https://github.com/raspberrypi/linux/issues/2020
----
- drivers/usb/host/dwc_otg/dwc_otg_hcd.c       | 15 ++++++++++-----
- drivers/usb/host/dwc_otg/dwc_otg_hcd.h       |  7 +++++--
- drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c  |  4 ++++
- drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c | 19 ++++++++++++-------
- 4 files changed, 31 insertions(+), 14 deletions(-)
-
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-index a2dc6337836b2719f4c954edeeb2a71301931b04..38bf5fc792d32352f9e208e0e90f968599b9bc31 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-@@ -926,8 +926,6 @@ static void dwc_otg_hcd_free(dwc_otg_hcd_t * dwc_otg_hcd)
- 	DWC_FREE(dwc_otg_hcd);
- }
- 
--int init_hcd_usecs(dwc_otg_hcd_t *_hcd);
--
- int dwc_otg_hcd_init(dwc_otg_hcd_t * hcd, dwc_otg_core_if_t * core_if)
- {
- 	struct device *dev = dwc_otg_hcd_to_dev(hcd);
-@@ -1429,6 +1427,7 @@ static void assign_and_init_hc(dwc_otg_hcd_t * hcd, dwc_otg_qh_t * qh)
- 
- /**
-  * fiq_fsm_transaction_suitable() - Test a QH for compatibility with the FIQ
-+ * @hcd:	Pointer to the dwc_otg_hcd struct
-  * @qh:	pointer to the endpoint's queue head
-  *
-  * Transaction start/end control flow is grafted onto the existing dwc_otg
-@@ -1438,8 +1437,14 @@ static void assign_and_init_hc(dwc_otg_hcd_t * hcd, dwc_otg_qh_t * qh)
-  * Returns: 0 for unsuitable, 1 implies the FIQ can be enabled for this transaction.
-  */
- 
--int fiq_fsm_transaction_suitable(dwc_otg_qh_t *qh)
-+int fiq_fsm_transaction_suitable(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh)
- {
-+	/* There is little benefit in using the FIQ to perform transfers if
-+	 * the root port is not in high-speed mode.
-+	 */
-+	if (hcd->flags.b.port_speed != DWC_HPRT0_PRTSPD_HIGH_SPEED)
-+		return 0;
-+
- 	if (qh->do_split) {
- 		switch (qh->ep_type) {
- 		case UE_CONTROL:
-@@ -2218,7 +2223,7 @@ static void process_periodic_channels(dwc_otg_hcd_t * hcd)
- 			continue;
- 		}
- 
--		if (fiq_fsm_enable && fiq_fsm_transaction_suitable(qh)) {
-+		if (fiq_fsm_enable && fiq_fsm_transaction_suitable(hcd, qh)) {
- 			if (qh->do_split)
- 				fiq_fsm_queue_split_transaction(hcd, qh);
- 			else
-@@ -2355,7 +2360,7 @@ static void process_non_periodic_channels(dwc_otg_hcd_t * hcd)
- 		qh = DWC_LIST_ENTRY(hcd->non_periodic_qh_ptr, dwc_otg_qh_t,
- 				    qh_list_entry);
- 
--		if(fiq_fsm_enable && fiq_fsm_transaction_suitable(qh)) {
-+		if(fiq_fsm_enable && fiq_fsm_transaction_suitable(hcd, qh)) {
- 			fiq_fsm_queue_split_transaction(hcd, qh);
- 		} else {
- 			status = queue_transaction(hcd, qh->channel,
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd.h b/drivers/usb/host/dwc_otg/dwc_otg_hcd.h
-index 7f7e9eaffd6a3c3d898855562fbec11289f77f53..5ed8dccf03959a610849aa6c8946ca745dbae207 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_hcd.h
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd.h
-@@ -410,7 +410,8 @@ struct dwc_otg_hcd {
- 			unsigned port_suspend_change:1;
- 			unsigned port_over_current_change:1;
- 			unsigned port_l1_change:1;
--			unsigned reserved:26;
-+			unsigned port_speed:2;
-+			unsigned reserved:24;
- 		} b;
- 	} flags;
- 
-@@ -629,7 +630,7 @@ int dwc_otg_hcd_allocate_port(dwc_otg_hcd_t * hcd, dwc_otg_qh_t *qh);
- void dwc_otg_hcd_release_port(dwc_otg_hcd_t * dwc_otg_hcd, dwc_otg_qh_t *qh);
- 
- extern int fiq_fsm_queue_transaction(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh);
--extern int fiq_fsm_transaction_suitable(dwc_otg_qh_t *qh);
-+extern int fiq_fsm_transaction_suitable(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh);
- extern void dwc_otg_cleanup_fiq_channel(dwc_otg_hcd_t *hcd, uint32_t num);
- 
- /** @} */
-@@ -823,6 +824,8 @@ static inline uint16_t dwc_micro_frame_num(uint16_t frame)
- 	return frame & 0x7;
- }
- 
-+extern void init_hcd_usecs(dwc_otg_hcd_t *_hcd);
-+
- void dwc_otg_hcd_save_data_toggle(dwc_hc_t * hc,
- 				  dwc_otg_hc_regs_t * hc_regs,
- 				  dwc_otg_qtd_t * qtd);
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c
-index a4355afc77b68718fdaba6c5d4be257dadc75036..c8f52709a7d24974c0a38dcf1708f91073e96b0e 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd_intr.c
-@@ -515,6 +515,10 @@ int32_t dwc_otg_hcd_handle_port_intr(dwc_otg_hcd_t * dwc_otg_hcd)
- 			dwc_otg_host_if_t *host_if =
- 			    dwc_otg_hcd->core_if->host_if;
- 
-+			dwc_otg_hcd->flags.b.port_speed = hprt0.b.prtspd;
-+			if (microframe_schedule)
-+				init_hcd_usecs(dwc_otg_hcd);
-+
- 			/* Every time when port enables calculate
- 			 * HFIR.FrInterval
- 			 */
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c
-index 85a6d431ca54b47dc10573aa72d1ad69d06f2e36..4b1dd9de99e9e08b2e006fb5f8a7ef92f20c2553 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c
-@@ -408,13 +408,17 @@ const unsigned short max_uframe_usecs[]={ 100, 100, 100, 100, 100, 100, 30, 0 };
- /*
-  * called from dwc_otg_hcd.c:dwc_otg_hcd_init
-  */
--int init_hcd_usecs(dwc_otg_hcd_t *_hcd)
-+void init_hcd_usecs(dwc_otg_hcd_t *_hcd)
- {
- 	int i;
--	for (i=0; i<8; i++) {
--		_hcd->frame_usecs[i] = max_uframe_usecs[i];
-+	if (_hcd->flags.b.port_speed == DWC_HPRT0_PRTSPD_FULL_SPEED) {
-+		_hcd->frame_usecs[0] = 900;
-+		for (i = 1; i < 8; i++)
-+			_hcd->frame_usecs[i] = 0;
-+	} else {
-+		for (i = 0; i < 8; i++)
-+			_hcd->frame_usecs[i] = max_uframe_usecs[i];
- 	}
--	return 0;
- }
- 
- static int find_single_uframe(dwc_otg_hcd_t * _hcd, dwc_otg_qh_t * _qh)
-@@ -541,8 +545,9 @@ static int find_uframe(dwc_otg_hcd_t * _hcd, dwc_otg_qh_t * _qh)
- 	int ret;
- 	ret = -1;
- 
--	if (_qh->speed == USB_SPEED_HIGH) {
--		/* if this is a hs transaction we need a full frame */
-+	if (_qh->speed == USB_SPEED_HIGH ||
-+		_hcd->flags.b.port_speed == DWC_HPRT0_PRTSPD_FULL_SPEED) {
-+		/* if this is a hs transaction we need a full frame - or account for FS usecs */
- 		ret = find_single_uframe(_hcd, _qh);
- 	} else {
- 		/* if this is a fs transaction we may need a sequence of frames */
-@@ -627,7 +632,7 @@ static int schedule_periodic(dwc_otg_hcd_t * hcd, dwc_otg_qh_t * qh)
- 	if (status) {
- 		DWC_INFO("%s: Insufficient periodic bandwidth for "
- 			    "periodic transfer.\n", __func__);
--		return status;
-+		return -DWC_E_NO_SPACE;
- 	}
- 	status = check_max_xfer_size(hcd, qh);
- 	if (status) {
-
-From 513a113092ed066fbe36cfc3c08389deb1c04acf Mon Sep 17 00:00:00 2001
-From: P33M <p33m@github.com>
-Date: Fri, 26 May 2017 12:50:31 +0100
-Subject: [PATCH 130/173] dwc_otg: fiq_fsm: Make isochronous compatibility
- checks work properly
-
-Get rid of the spammy printk and local pointer mangling.
-Also, there is a nominal benefit for using fiq_fsm for isochronous
-transfers in FS mode (~1.1k IRQs per second vs 2.1k IRQs per second)
-so remove the root port speed check.
----
- drivers/usb/host/dwc_otg/dwc_otg_hcd.c | 24 ++++++------------------
- 1 file changed, 6 insertions(+), 18 deletions(-)
-
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-index 38bf5fc792d32352f9e208e0e90f968599b9bc31..71834cf365e67d7ad995bba7869216c4091c3a74 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-@@ -1439,12 +1439,6 @@ static void assign_and_init_hc(dwc_otg_hcd_t * hcd, dwc_otg_qh_t * qh)
- 
- int fiq_fsm_transaction_suitable(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh)
- {
--	/* There is little benefit in using the FIQ to perform transfers if
--	 * the root port is not in high-speed mode.
--	 */
--	if (hcd->flags.b.port_speed != DWC_HPRT0_PRTSPD_HIGH_SPEED)
--		return 0;
--
- 	if (qh->do_split) {
- 		switch (qh->ep_type) {
- 		case UE_CONTROL:
-@@ -1462,28 +1456,22 @@ int fiq_fsm_transaction_suitable(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh)
- 		}
- 	} else if (qh->ep_type == UE_ISOCHRONOUS) {
- 		if (fiq_fsm_mask & (1 << 2)) {
--			/* HS ISOCH support. We test for compatibility:
-+			/* ISOCH support. We test for compatibility:
- 			 * - DWORD aligned buffers
- 			 * - Must be at least 2 transfers (otherwise pointless to use the FIQ)
- 			 * If yes, then the fsm enqueue function will handle the state machine setup.
- 			 */
- 			dwc_otg_qtd_t *qtd = DWC_CIRCLEQ_FIRST(&qh->qtd_list);
- 			dwc_otg_hcd_urb_t *urb = qtd->urb;
--			struct dwc_otg_hcd_iso_packet_desc (*iso_descs)[0] = &urb->iso_descs;
--			int nr_iso_frames = urb->packet_count;
-+			dwc_dma_t ptr;
- 			int i;
--			uint32_t ptr;
- 
--			if (nr_iso_frames < 2)
-+			if (urb->packet_count < 2)
- 				return 0;
--			for (i = 0; i < nr_iso_frames; i++) {
--				ptr = urb->dma + iso_descs[i]->offset;
--				if (ptr & 0x3) {
--					printk_ratelimited("%s: Non-Dword aligned isochronous frame offset."
--							" Cannot queue FIQ-accelerated transfer to device %d endpoint %d\n",
--							__FUNCTION__, qh->channel->dev_addr, qh->channel->ep_num);
-+			for (i = 0; i < urb->packet_count; i++) {
-+				ptr = urb->dma + urb->iso_descs[i].offset;
-+				if (ptr & 0x3)
- 					return 0;
--				}
- 			}
- 			return 1;
- 		}
-
-From 179f3d51610b2d63525037a97c7a41e2a3dec0b5 Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Mon, 12 Jun 2017 13:05:43 +0100
-Subject: [PATCH 131/173] config: Add CONFIG_CAN_GS_USB
-
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index ba89462cf80f17e6275c1e7912d754d672d4c68d..fd6d3980bc003801a6868e6098f3868a2544573f 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -362,6 +362,7 @@ CONFIG_CAN=m
- CONFIG_CAN_VCAN=m
- CONFIG_CAN_SLCAN=m
- CONFIG_CAN_MCP251X=m
-+CONFIG_CAN_GS_USB=m
- CONFIG_IRDA=m
- CONFIG_IRLAN=m
- CONFIG_IRNET=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index 7d3522df2b28e53cb63a0813168918792b65becb..bf0d3fd830a0a0cc9443ef52e7f167eb704ed152 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -357,6 +357,7 @@ CONFIG_CAN=m
- CONFIG_CAN_VCAN=m
- CONFIG_CAN_SLCAN=m
- CONFIG_CAN_MCP251X=m
-+CONFIG_CAN_GS_USB=m
- CONFIG_IRDA=m
- CONFIG_IRLAN=m
- CONFIG_IRNET=m
-
-From 0334f3d7c7cf1025d9939521423c78b276df45c2 Mon Sep 17 00:00:00 2001
-From: P33M <p33m@github.com>
-Date: Mon, 12 Jun 2017 16:10:03 +0100
-Subject: [PATCH 132/173] dwc_otg: add module parameter int_ep_interval_min
-
-Add a module parameter (defaulting to ignored) that clamps the polling rate
-of high-speed Interrupt endpoints to a minimum microframe interval.
-
-The parameter is modifiable at runtime as it is used when activating new
-endpoints (such as on device connect).
----
- drivers/usb/host/dwc_otg/dwc_otg_driver.c    |  6 +++++-
- drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c | 25 ++++++++++++-------------
- 2 files changed, 17 insertions(+), 14 deletions(-)
-
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_driver.c b/drivers/usb/host/dwc_otg/dwc_otg_driver.c
-index cb060a7179a3eec791506ed2779b553cad9841b0..95943e07528276b26b51ea2d57a1f433f280aaef 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_driver.c
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_driver.c
-@@ -249,6 +249,7 @@ uint16_t nak_holdoff = 8;
- 
- unsigned short fiq_fsm_mask = 0x0F;
- 
-+unsigned short int_ep_interval_min = 0;
- /**
-  * This function shows the Driver Version.
-  */
-@@ -1398,7 +1399,10 @@ MODULE_PARM_DESC(fiq_fsm_mask, "Bitmask of transactions to perform in the FIQ.\n
- 					"Bit 1 : Periodic split transactions\n"
- 					"Bit 2 : High-speed multi-transfer isochronous\n"
- 					"All other bits should be set 0.");
--
-+module_param(int_ep_interval_min, ushort, 0644);
-+MODULE_PARM_DESC(int_ep_interval_min, "Clamp high-speed Interrupt endpoints to a minimum polling interval.\n"
-+					"0..1 = Use endpoint default\n"
-+					"2..n = Minimum interval n microframes. Use powers of 2.\n");
- 
- /** @page "Module Parameters"
-  *
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c
-index 4b1dd9de99e9e08b2e006fb5f8a7ef92f20c2553..fe8e8f841f03660c2ad49ab8e66193bec62558d3 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd_queue.c
-@@ -43,6 +43,7 @@
- #include "dwc_otg_regs.h"
- 
- extern bool microframe_schedule;
-+extern unsigned short int_ep_interval_min;
- 
- /**
-  * Free each QTD in the QH's QTD-list then free the QH.  QH should already be
-@@ -218,21 +219,19 @@ void qh_init(dwc_otg_hcd_t * hcd, dwc_otg_qh_t * qh, dwc_otg_hcd_urb_t * urb)
- 						    SCHEDULE_SLOP);
- 		qh->interval = urb->interval;
- 
--#if 0
--		/* Increase interrupt polling rate for debugging. */
--		if (qh->ep_type == UE_INTERRUPT) {
--			qh->interval = 8;
--		}
--#endif
- 		hprt.d32 = DWC_READ_REG32(hcd->core_if->host_if->hprt0);
--		if ((hprt.b.prtspd == DWC_HPRT0_PRTSPD_HIGH_SPEED) &&
--		    ((dev_speed == USB_SPEED_LOW) ||
--		     (dev_speed == USB_SPEED_FULL))) {
--			qh->interval *= 8;
--			qh->sched_frame |= 0x7;
--			qh->start_split_frame = qh->sched_frame;
-+		if (hprt.b.prtspd == DWC_HPRT0_PRTSPD_HIGH_SPEED) {
-+			if (dev_speed == USB_SPEED_LOW ||
-+					dev_speed == USB_SPEED_FULL) {
-+				qh->interval *= 8;
-+				qh->sched_frame |= 0x7;
-+				qh->start_split_frame = qh->sched_frame;
-+			} else if (int_ep_interval_min >= 2 &&
-+					qh->interval < int_ep_interval_min &&
-+					qh->ep_type == UE_INTERRUPT) {
-+				qh->interval = int_ep_interval_min;
-+			}
- 		}
--
- 	}
- 
- 	DWC_DEBUGPL(DBG_HCD, "DWC OTG HCD QH Initialized\n");
-
-From a016915f594e2e4e5fe411b6e9a70fd4aed38223 Mon Sep 17 00:00:00 2001
-From: P33M <p33m@github.com>
-Date: Tue, 20 Jun 2017 13:44:01 +0100
-Subject: [PATCH 133/173] dwc_otg: fiq_fsm: Add non-periodic TT exclusivity
- constraints
-
-Certain hub types do not discriminate between pipe direction (IN or OUT)
-when considering non-periodic transfers. Therefore these hubs get confused
-if multiple transfers are issued in different directions with the same
-device address and endpoint number.
-
-Constrain queuing non-periodic split transactions so they are performed
-serially in such cases.
-
-Related: https://github.com/raspberrypi/linux/issues/2024
----
- drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c | 32 ++++++++++++++++++
- drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h |  2 ++
- drivers/usb/host/dwc_otg/dwc_otg_hcd.c     | 53 ++++++++++++++++++++++++++++--
- 3 files changed, 85 insertions(+), 2 deletions(-)
-
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c
-index 208252645c09d1d17bf07673989f91b7f4b3ef7a..0163e9cf620ba58df36a872b82cea92734baada6 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.c
-@@ -191,6 +191,32 @@ static void notrace fiq_fsm_setup_csplit(struct fiq_state *st, int n)
- 	mb();
- }
- 
-+/**
-+ * fiq_fsm_restart_np_pending() - Restart a single non-periodic contended transfer
-+ * @st: Pointer to the channel's state
-+ * @num_channels: Total number of host channels
-+ * @orig_channel: Channel index of completed transfer
-+ *
-+ * In the case where an IN and OUT transfer are simultaneously scheduled to the
-+ * same device/EP, inadequate hub implementations will misbehave. Once the first
-+ * transfer is complete, a pending non-periodic split can then be issued.
-+ */
-+static void notrace fiq_fsm_restart_np_pending(struct fiq_state *st, int num_channels, int orig_channel)
-+{
-+	int i;
-+	int dev_addr = st->channel[orig_channel].hcchar_copy.b.devaddr;
-+	int ep_num = st->channel[orig_channel].hcchar_copy.b.epnum;
-+	for (i = 0; i < num_channels; i++) {
-+		if (st->channel[i].fsm == FIQ_NP_SSPLIT_PENDING &&
-+			st->channel[i].hcchar_copy.b.devaddr == dev_addr &&
-+			st->channel[i].hcchar_copy.b.epnum == ep_num) {
-+			st->channel[i].fsm = FIQ_NP_SSPLIT_STARTED;
-+			fiq_fsm_restart_channel(st, i, 0);
-+			break;
-+		}
-+	}
-+}
-+
- static inline int notrace fiq_get_xfer_len(struct fiq_state *st, int n)
- {
- 	/* The xfersize register is a bit wonky. For IN transfers, it decrements by the packet size. */
-@@ -870,6 +896,9 @@ static int notrace noinline fiq_fsm_do_hcintr(struct fiq_state *state, int num_c
- 				st->fsm = FIQ_NP_SPLIT_HS_ABORTED;
- 			}
- 		}
-+		if (st->fsm != FIQ_NP_IN_CSPLIT_RETRY) {
-+			fiq_fsm_restart_np_pending(state, num_channels, n);
-+		}
- 		break;
- 
- 	case FIQ_NP_OUT_CSPLIT_RETRY:
-@@ -919,6 +948,9 @@ static int notrace noinline fiq_fsm_do_hcintr(struct fiq_state *state, int num_c
- 				st->fsm = FIQ_NP_SPLIT_HS_ABORTED;
- 			}
- 		}
-+		if (st->fsm != FIQ_NP_OUT_CSPLIT_RETRY) {
-+			fiq_fsm_restart_np_pending(state, num_channels, n);
-+		}
- 		break;
- 
- 	/* Periodic split states (except isoc out) */
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h
-index 0a1ddf3f89f45ca75b8880722fbc22cbdc9f4a2f..ed088f34f210e9a337ab9b80fff0cf9e9b0241ea 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_fiq_fsm.h
-@@ -178,6 +178,8 @@ enum fiq_fsm_state {
- 	/* Nonperiodic state groups */
- 	FIQ_NP_SSPLIT_STARTED = 1,
- 	FIQ_NP_SSPLIT_RETRY = 2,
-+	/* TT contention - working around hub bugs */
-+	FIQ_NP_SSPLIT_PENDING = 33,
- 	FIQ_NP_OUT_CSPLIT_RETRY = 3,
- 	FIQ_NP_IN_CSPLIT_RETRY = 4,
- 	FIQ_NP_SPLIT_DONE = 5,
-diff --git a/drivers/usb/host/dwc_otg/dwc_otg_hcd.c b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-index 71834cf365e67d7ad995bba7869216c4091c3a74..7710370b30363e3170bf9bf522597c5f41dfb908 100644
---- a/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-+++ b/drivers/usb/host/dwc_otg/dwc_otg_hcd.c
-@@ -1572,6 +1572,45 @@ int fiq_fsm_setup_periodic_dma(dwc_otg_hcd_t *hcd, struct fiq_channel_state *st,
- 	}
- }
- 
-+/**
-+ * fiq_fsm_np_tt_contended() - Avoid performing contended non-periodic transfers
-+ * @hcd: Pointer to the dwc_otg_hcd struct
-+ * @qh: Pointer to the endpoint's queue head
-+ *
-+ * Certain hub chips don't differentiate between IN and OUT non-periodic pipes
-+ * with the same endpoint number. If transfers get completed out of order
-+ * (disregarding the direction token) then the hub can lock up
-+ * or return erroneous responses.
-+ *
-+ * Returns 1 if initiating the transfer would cause contention, 0 otherwise.
-+ */
-+int fiq_fsm_np_tt_contended(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh)
-+{
-+	int i;
-+	struct fiq_channel_state *st;
-+	int dev_addr = qh->channel->dev_addr;
-+	int ep_num = qh->channel->ep_num;
-+	for (i = 0; i < hcd->core_if->core_params->host_channels; i++) {
-+		if (i == qh->channel->hc_num)
-+			continue;
-+		st = &hcd->fiq_state->channel[i];
-+		switch (st->fsm) {
-+		case FIQ_NP_SSPLIT_STARTED:
-+		case FIQ_NP_SSPLIT_RETRY:
-+		case FIQ_NP_SSPLIT_PENDING:
-+		case FIQ_NP_OUT_CSPLIT_RETRY:
-+		case FIQ_NP_IN_CSPLIT_RETRY:
-+			if (st->hcchar_copy.b.devaddr == dev_addr &&
-+				st->hcchar_copy.b.epnum == ep_num)
-+				return 1;
-+			break;
-+		default:
-+			break;
-+		}
-+	}
-+	return 0;
-+}
-+
- /*
-  * Pushing a periodic request into the queue near the EOF1 point
-  * in a microframe causes erroneous behaviour (frmovrun) interrupt.
-@@ -1894,7 +1933,12 @@ int fiq_fsm_queue_split_transaction(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh)
- 	switch (hc->ep_type) {
- 		case UE_CONTROL:
- 		case UE_BULK:
--			st->fsm = FIQ_NP_SSPLIT_STARTED;
-+			if (fiq_fsm_np_tt_contended(hcd, qh)) {
-+				st->fsm = FIQ_NP_SSPLIT_PENDING;
-+				start_immediate = 0;
-+			} else {
-+				st->fsm = FIQ_NP_SSPLIT_STARTED;
-+			}
- 			break;
- 		case UE_ISOCHRONOUS:
- 			if (hc->ep_is_in) {
-@@ -1918,7 +1962,12 @@ int fiq_fsm_queue_split_transaction(dwc_otg_hcd_t *hcd, dwc_otg_qh_t *qh)
- 			break;
- 		case UE_INTERRUPT:
- 			if (fiq_fsm_mask & 0x8) {
--				st->fsm = FIQ_NP_SSPLIT_STARTED;
-+				if (fiq_fsm_np_tt_contended(hcd, qh)) {
-+					st->fsm = FIQ_NP_SSPLIT_PENDING;
-+					start_immediate = 0;
-+				} else {
-+					st->fsm = FIQ_NP_SSPLIT_STARTED;
-+				}
- 			} else if (start_immediate) {
- 					st->fsm = FIQ_PER_SSPLIT_STARTED;
- 			} else {
-
-From 7d234795e354ec54b088e8f3d3b1ee0db815722d Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Fri, 26 May 2017 13:03:41 +0100
-Subject: [PATCH 134/173] BCM270X_DT: Add midi-uart1 overlay
-
-Add a scaler to the ttyS0 clock so that requesting 38400 baud results
-in an approximately 31250 baud signal. This is analagous to
-midi-uart0, except for ttyS0, which may be useful on Pi3 and also
-may avoid an issue with ttyAMA0 failing to synchronise to an active
-data stream.
-
-See: https://www.raspberrypi.org/forums/viewtopic.php?f=107&t=183860
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- arch/arm/boot/dts/overlays/Makefile               |  1 +
- arch/arm/boot/dts/overlays/README                 |  7 ++++
- arch/arm/boot/dts/overlays/midi-uart1-overlay.dts | 43 +++++++++++++++++++++++
- 3 files changed, 51 insertions(+)
- create mode 100644 arch/arm/boot/dts/overlays/midi-uart1-overlay.dts
-
-diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
-index e2f66a55dc5afe13d690c2c17827054ac94b7168..e0ff5793f124fce73732e175bfca424f0a97b632 100644
---- a/arch/arm/boot/dts/overlays/Makefile
-+++ b/arch/arm/boot/dts/overlays/Makefile
-@@ -56,6 +56,7 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
- 	mcp2515-can1.dtbo \
- 	mcp3008.dtbo \
- 	midi-uart0.dtbo \
-+	midi-uart1.dtbo \
- 	mmc.dtbo \
- 	mz61581.dtbo \
- 	pi3-act-led.dtbo \
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index e2a803e5180cf78d67b6723cfd2f6d3b2b54e53b..ec9e7b1941678796facf625b3770c20ed0b15b25 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -864,6 +864,13 @@ Load:   dtoverlay=midi-uart0
- Params: <None>
- 
- 
-+Name:   midi-uart1
-+Info:   Configures UART1 (ttyS0) so that a requested 38.4kbaud actually gets
-+        31.25kbaud, the frequency required for MIDI
-+Load:   dtoverlay=midi-uart1
-+Params: <None>
-+
-+
- Name:   mmc
- Info:   Selects the bcm2835-mmc SD/MMC driver, optionally with overclock
- Load:   dtoverlay=mmc,<param>=<val>
-diff --git a/arch/arm/boot/dts/overlays/midi-uart1-overlay.dts b/arch/arm/boot/dts/overlays/midi-uart1-overlay.dts
-new file mode 100644
-index 0000000000000000000000000000000000000000..e0bc410acbff3a7a175dd5d53b3ab0d0802e8239
---- /dev/null
-+++ b/arch/arm/boot/dts/overlays/midi-uart1-overlay.dts
-@@ -0,0 +1,43 @@
-+/dts-v1/;
-+/plugin/;
-+
-+#include <dt-bindings/clock/bcm2835-aux.h>
-+
-+/*
-+ * Fake a higher clock rate to get a larger divisor, and thereby a lower
-+ * baudrate. The real clock is 48MHz, which we scale so that requesting
-+ * 38.4kHz results in an actual 31.25kHz.
-+ *
-+ *   48000000*38400/31250 = 58982400
-+ */
-+
-+/{
-+	compatible = "brcm,bcm2835";
-+
-+	fragment@0 {
-+		target-path = "/clocks";
-+		__overlay__ {
-+			midi_clk: clock@5 {
-+				compatible = "fixed-factor-clock";
-+				#clock-cells = <0>;
-+				clocks = <&aux BCM2835_AUX_CLOCK_UART>;
-+				clock-mult = <38400>;
-+				clock-div  = <31250>;
-+			};
-+		};
-+	};
-+
-+	fragment@1 {
-+		target = <&uart1>;
-+		__overlay__ {
-+			clocks = <&midi_clk>;
-+		};
-+	};
-+
-+	fragment@2 {
-+		target = <&aux>;
-+		__overlay__ {
-+			clock-output-names = "aux_uart", "aux_spi1", "aux_spi2";
-+		};
-+	};
-+};
-
-From 5dfe95ff49ef769f8d7674639e0c4561f50b847b Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Sat, 20 May 2017 22:10:14 +0100
-Subject: [PATCH 135/173] overlays: README: remove vestigial SDIO parameters
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- arch/arm/boot/dts/overlays/README | 24 ++----------------------
- 1 file changed, 2 insertions(+), 22 deletions(-)
-
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index ec9e7b1941678796facf625b3770c20ed0b15b25..499cd1920fd373702cfbc9f6e0fcaebca8a47cfc 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -1203,19 +1203,9 @@ Name:   sdio
- Info:   Selects the bcm2835-sdhost SD/MMC driver, optionally with overclock,
-         and enables SDIO via GPIOs 22-27.
- Load:   dtoverlay=sdio,<param>=<val>
--Params: overclock_50            SD Clock (in MHz) to use when the MMC framework
--                                requests 50MHz
--
--        sdio_overclock          SDIO Clock (in MHz) to use when the MMC
-+Params: sdio_overclock          SDIO Clock (in MHz) to use when the MMC
-                                 framework requests 50MHz
- 
--        force_pio               Disable DMA support (default off)
--
--        pio_limit               Number of blocks above which to use DMA
--                                (default 1)
--
--        debug                   Enable debug output (default off)
--
-         poll_once               Disable SDIO-device polling every second
-                                 (default on: polling once at boot-time)
- 
-@@ -1226,19 +1216,9 @@ Name:   sdio-1bit
- Info:   Selects the bcm2835-sdhost SD/MMC driver, optionally with overclock,
-         and enables 1-bit SDIO via GPIOs 22-25.
- Load:   dtoverlay=sdio-1bit,<param>=<val>
--Params: overclock_50            SD Clock (in MHz) to use when the MMC framework
--                                requests 50MHz
--
--        sdio_overclock          SDIO Clock (in MHz) to use when the MMC
-+Params: sdio_overclock          SDIO Clock (in MHz) to use when the MMC
-                                 framework requests 50MHz
- 
--        force_pio               Disable DMA support (default off)
--
--        pio_limit               Number of blocks above which to use DMA
--                                (default 1)
--
--        debug                   Enable debug output (default off)
--
-         poll_once               Disable SDIO-device polling every second
-                                 (default on: polling once at boot-time)
- 
-
-From eaf3d7aa7038a5f1b13fd2b62cd0674f915824d4 Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Tue, 27 Jun 2017 15:07:14 +0100
-Subject: [PATCH 136/173] SQUASH: mmc: Apply ERASE_BROKEN quirks correctly
-
-Squash with: mmc: Add MMC_QUIRK_ERASE_BROKEN for some cards
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- drivers/mmc/core/quirks.h | 9 +++------
- 1 file changed, 3 insertions(+), 6 deletions(-)
-
-diff --git a/drivers/mmc/core/quirks.h b/drivers/mmc/core/quirks.h
-index 05c8d7381fff5ae88531129d9a5ddd554bddb43e..c9d5d644688c1509d7febcff0322fbaba0a842d6 100644
---- a/drivers/mmc/core/quirks.h
-+++ b/drivers/mmc/core/quirks.h
-@@ -94,12 +94,9 @@ static const struct mmc_fixup mmc_blk_fixups[] = {
- 	 *  On some Kingston SD cards, multiple erases of less than 64
- 	 *  sectors can cause corruption.
- 	 */
--	MMC_FIXUP("SD16G", 0x41, 0x3432, add_quirk_mmc,
--		  MMC_QUIRK_ERASE_BROKEN),
--	MMC_FIXUP("SD32G", 0x41, 0x3432, add_quirk_mmc,
--		  MMC_QUIRK_ERASE_BROKEN),
--	MMC_FIXUP("SD64G", 0x41, 0x3432, add_quirk_mmc,
--		  MMC_QUIRK_ERASE_BROKEN),
-+	MMC_FIXUP("SD16G", 0x41, 0x3432, add_quirk, MMC_QUIRK_ERASE_BROKEN),
-+	MMC_FIXUP("SD32G", 0x41, 0x3432, add_quirk, MMC_QUIRK_ERASE_BROKEN),
-+	MMC_FIXUP("SD64G", 0x41, 0x3432, add_quirk, MMC_QUIRK_ERASE_BROKEN),
- 
- 	END_FIXUP
- };
-
-From 5e831629bc1d7eefbe3a98bea00f0758a9fb1990 Mon Sep 17 00:00:00 2001
+From a0e95cee6a8f5d8f1f2a54bc2afea0cd135a7da7 Mon Sep 17 00:00:00 2001
 From: Matthias Reichl <hias@horus.com>
 Date: Sun, 7 May 2017 11:34:26 +0200
-Subject: [PATCH 137/173] ASoC: bcm2835: Add support for TDM modes
+Subject: [PATCH 120/126] ASoC: bcm2835: Add support for TDM modes
 
 bcm2835 supports arbitrary positioning of channel data within
 a frame and thus is capable of supporting TDM modes. Since
@@ -133425,10 +133923,10 @@ index 56df7d8a43d0aac055a91b0d24aca8e1b4e308e4..dcacf7f83c9371df539a788ea33fedcf
  	dev->dev = &pdev->dev;
  	dev_set_drvdata(&pdev->dev, dev);
 
-From a6b31aa9fe739751f7f3990027408f1a6bde3cf0 Mon Sep 17 00:00:00 2001
+From edeccfa7b56e7b0d57573ba9c0e4f3db29422c0f Mon Sep 17 00:00:00 2001
 From: Matthias Reichl <hias@horus.com>
 Date: Sun, 7 May 2017 15:30:50 +0200
-Subject: [PATCH 138/173] ASoC: bcm2835: Support left/right justified and DSP
+Subject: [PATCH 121/126] ASoC: bcm2835: Support left/right justified and DSP
  modes
 
 DSP modes and left/right justified modes can be supported
@@ -133674,10 +134172,10 @@ index dcacf7f83c9371df539a788ea33fedcf97d64690..3a706fda4f39e42efbe12f19d87af9b1
  }
  
 
-From 44e6d969cd8d8978d9d6e96cfde02566954ea6d9 Mon Sep 17 00:00:00 2001
+From d88f66a688fe461b28e634ffa6bac86604eecf4d Mon Sep 17 00:00:00 2001
 From: Matthias Reichl <hias@horus.com>
 Date: Sun, 7 May 2017 16:19:54 +0200
-Subject: [PATCH 139/173] ASoC: bcm2835: Support additional samplerates up to
+Subject: [PATCH 122/126] ASoC: bcm2835: Support additional samplerates up to
  384kHz
 
 Sample rates are only restricted by the capabilities of the
@@ -133720,10 +134218,10 @@ index 3a706fda4f39e42efbe12f19d87af9b100a348a5..43f5715a0d5dda851731ecf7ff27e76c
  				| SNDRV_PCM_FMTBIT_S24_LE
  				| SNDRV_PCM_FMTBIT_S32_LE
 
-From 35185a071e2e90872f7ccc8ba5110949300ce6fd Mon Sep 17 00:00:00 2001
+From 9f847f27cb484bb01d64a217d52b6cf8f88d811f Mon Sep 17 00:00:00 2001
 From: Matthias Reichl <hias@horus.com>
 Date: Sun, 7 May 2017 16:24:57 +0200
-Subject: [PATCH 140/173] ASoC: bcm2835: Enforce full symmetry
+Subject: [PATCH 123/126] ASoC: bcm2835: Enforce full symmetry
 
 bcm2835's configuration registers can't be changed when a stream
 is running, which means asymmetric configurations aren't supported.
@@ -133759,3189 +134257,136 @@ index 43f5715a0d5dda851731ecf7ff27e76c48fb6e57..2e449d7173fcecbcd647f90a26bd58b6
  
  static bool bcm2835_i2s_volatile_reg(struct device *dev, unsigned int reg)
 
-From 45e973ed24dd64930b942ecfe824904f561cc00e Mon Sep 17 00:00:00 2001
-From: Matthias Reichl <hias@horus.com>
-Date: Thu, 6 Jul 2017 18:52:16 +0200
-Subject: [PATCH 141/173] config: add missing arizona regulator modules
-
-In kernel 4.12 CONFIG_REGULATOR_ARIZONA was replaced by 2 separate
-options for LDO1 and MICSUPP regulators. Enable these, they are
-needed by the Cirrus Logic Audio Card.
-
-Also regenerate configs with make savedefconfig to get rid of
-the duplicated CONFIG_TOUCHSCREEN_EDT_FT5X06 entry.
-
-Signed-off-by: Matthias Reichl <hias@horus.com>
----
- arch/arm/configs/bcm2709_defconfig | 3 ++-
- arch/arm/configs/bcmrpi_defconfig  | 2 ++
- 2 files changed, 4 insertions(+), 1 deletion(-)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index fd6d3980bc003801a6868e6098f3868a2544573f..95da3daaf33c7cfab76f6af397e058e9ed8d998f 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -568,7 +568,6 @@ CONFIG_JOYSTICK_RPISENSE=m
- CONFIG_INPUT_TOUCHSCREEN=y
- CONFIG_TOUCHSCREEN_ADS7846=m
- CONFIG_TOUCHSCREEN_EGALAX=m
--CONFIG_TOUCHSCREEN_EDT_FT5X06=m
- CONFIG_TOUCHSCREEN_GOODIX=m
- CONFIG_TOUCHSCREEN_EDT_FT5X06=m
- CONFIG_TOUCHSCREEN_RPI_FT5406=m
-@@ -671,6 +670,8 @@ CONFIG_MFD_ARIZONA_SPI=m
- CONFIG_MFD_WM5102=y
- CONFIG_REGULATOR=y
- CONFIG_REGULATOR_FIXED_VOLTAGE=m
-+CONFIG_REGULATOR_ARIZONA_LDO1=m
-+CONFIG_REGULATOR_ARIZONA_MICSUPP=m
- CONFIG_MEDIA_SUPPORT=m
- CONFIG_MEDIA_CAMERA_SUPPORT=y
- CONFIG_MEDIA_ANALOG_TV_SUPPORT=y
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index bf0d3fd830a0a0cc9443ef52e7f167eb704ed152..06d0520e332f21afaa27ac112c0eee6c36a9a9df 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -663,6 +663,8 @@ CONFIG_MFD_ARIZONA_SPI=m
- CONFIG_MFD_WM5102=y
- CONFIG_REGULATOR=y
- CONFIG_REGULATOR_FIXED_VOLTAGE=m
-+CONFIG_REGULATOR_ARIZONA_LDO1=m
-+CONFIG_REGULATOR_ARIZONA_MICSUPP=m
- CONFIG_MEDIA_SUPPORT=m
- CONFIG_MEDIA_CAMERA_SUPPORT=y
- CONFIG_MEDIA_ANALOG_TV_SUPPORT=y
-
-From 023dc39250043ccc51c52feac97e463813042707 Mon Sep 17 00:00:00 2001
-From: Matt Flax <flatmax@flatmax.org>
-Date: Tue, 4 Apr 2017 19:20:59 +1000
-Subject: [PATCH 142/173] Audioinjector : make the octo and pi sound cards have
- different driver names
-
-This patch gives the audioinjector octo and pi soundcards different driver
-names. This allows both the be loaded without clashing.
----
- sound/soc/bcm/audioinjector-octo-soundcard.c | 2 +-
- sound/soc/bcm/audioinjector-pi-soundcard.c   | 2 +-
- 2 files changed, 2 insertions(+), 2 deletions(-)
-
-diff --git a/sound/soc/bcm/audioinjector-octo-soundcard.c b/sound/soc/bcm/audioinjector-octo-soundcard.c
-index dcf403ab37639ba79e38278d7e4b1ade452c292a..49115c8e20ce1a2ba5a99feb8983a1cafb052ca2 100644
---- a/sound/soc/bcm/audioinjector-octo-soundcard.c
-+++ b/sound/soc/bcm/audioinjector-octo-soundcard.c
-@@ -324,7 +324,7 @@ MODULE_DEVICE_TABLE(of, audioinjector_octo_of_match);
- 
- static struct platform_driver audioinjector_octo_driver = {
- 	.driver	= {
--		.name			= "audioinjector-audio",
-+		.name			= "audioinjector-octo",
- 		.owner			= THIS_MODULE,
- 		.of_match_table = audioinjector_octo_of_match,
- 	},
-diff --git a/sound/soc/bcm/audioinjector-pi-soundcard.c b/sound/soc/bcm/audioinjector-pi-soundcard.c
-index ef54e0f07ea03f59e9957b5d98f3e7fdc998e469..491906bbf446826e55dd843f28e4860f48e908b8 100644
---- a/sound/soc/bcm/audioinjector-pi-soundcard.c
-+++ b/sound/soc/bcm/audioinjector-pi-soundcard.c
-@@ -177,7 +177,7 @@ MODULE_DEVICE_TABLE(of, audioinjector_pi_soundcard_of_match);
- 
- static struct platform_driver audioinjector_pi_soundcard_driver = {
-        .driver         = {
--		.name   = "audioinjector-audio",
-+		.name   = "audioinjector-stereo",
- 		.owner  = THIS_MODULE,
- 		.of_match_table = audioinjector_pi_soundcard_of_match,
-        },
-
-From d7ddfc8a6b3f9fce8c4ebc1b5f99219d2cc93289 Mon Sep 17 00:00:00 2001
-From: Matt Flax <flatmax@flatmax.org>
-Date: Tue, 4 Apr 2017 19:23:04 +1000
-Subject: [PATCH 143/173] Audioinjector octo : Make the playback and capture
- symmetric
-
-This patch ensures that the sample rate and channel count of the audioinjector
-octo sound card are symmetric.
----
- sound/soc/bcm/audioinjector-octo-soundcard.c | 2 ++
- 1 file changed, 2 insertions(+)
-
-diff --git a/sound/soc/bcm/audioinjector-octo-soundcard.c b/sound/soc/bcm/audioinjector-octo-soundcard.c
-index 49115c8e20ce1a2ba5a99feb8983a1cafb052ca2..5e79f4eff93a21ed3495c77a90f73525695cb3d5 100644
---- a/sound/soc/bcm/audioinjector-octo-soundcard.c
-+++ b/sound/soc/bcm/audioinjector-octo-soundcard.c
-@@ -204,6 +204,8 @@ static struct snd_soc_dai_link audioinjector_octo_dai[] = {
- 		.codec_dai_name = "cs42448",
- 		.ops = &audioinjector_octo_ops,
- 		.init = audioinjector_octo_dai_init,
-+		.symmetric_rates = 1,
-+		.symmetric_channels = 1,
- 	},
- };
- 
-
-From 9d033a4fbcf7494550753f3d2d978300b6a9c9aa Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Sun, 23 Apr 2017 19:36:53 +0100
-Subject: [PATCH 144/173] BCM270X_DT: Add bme280 and bmp180 to i2c-sensor
- overlay
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- arch/arm/boot/dts/overlays/README                 | 11 +++++++++--
- arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts | 15 +++++++++++++++
- 2 files changed, 24 insertions(+), 2 deletions(-)
-
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index 499cd1920fd373702cfbc9f6e0fcaebca8a47cfc..d32a31cbf4a4382ddfc1b38018ef3ff0ff445145 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -652,9 +652,16 @@ Name:   i2c-sensor
- Info:   Adds support for a number of I2C barometric pressure and temperature
-         sensors on i2c_arm
- Load:   dtoverlay=i2c-sensor,<param>=<val>
--Params: bmp085                  Select the Bosch sensortronic BMP085
-+Params: addr                    Set the address for the BME280 and BMP280 (0x76
-+                                or 0x77 - default 0x76)
- 
--        bmp280                  Select the Bosch sensortronic BMP280
-+        bme280                  Select the Bosch Sensortronic BME280
-+
-+        bmp085                  Select the Bosch Sensortronic BMP085
-+
-+        bmp180                  Select the Bosch Sensortronic BMP180
-+
-+        bmp280                  Select the Bosch Sensortronic BMP280
- 
-         lm75                    Select the Maxim LM75 temperature sensor
- 
-diff --git a/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-index 606b2d5012abf2e85712be631c42ea40a0b512c5..e23e34b32a0a8927c14203d7384e800878627347 100644
---- a/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-+++ b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-@@ -12,6 +12,12 @@
- 			#size-cells = <0>;
- 			status = "okay";
- 
-+			bme280: bme280@76 {
-+				compatible = "bosch,bme280";
-+				reg = <0x76>;
-+				status = "disable";
-+			};
-+
- 			bmp085: bmp085@77 {
- 				compatible = "bosch,bmp085";
- 				reg = <0x77>;
-@@ -19,6 +25,12 @@
- 				status = "disable";
- 			};
- 
-+			bmp180: bmp180@77 {
-+				compatible = "bosch,bmp180";
-+				reg = <0x77>;
-+				status = "disable";
-+			};
-+
- 			bmp280: bmp280@76 {
- 				compatible = "bosch,bmp280";
- 				reg = <0x76>;
-@@ -40,7 +52,10 @@
- 	};
- 
- 	__overrides__ {
-+		addr =  <&bme280>,"reg:0", <&bmp280>,"reg:0";
-+		bme280 = <&bme280>,"status";
- 		bmp085 = <&bmp085>,"status";
-+		bmp180 = <&bmp180>,"status";
- 		bmp280 = <&bmp280>,"status";
- 		lm75 = <&lm75>,"status";
- 		lm75addr = <&lm75>,"reg:0";
-
-From bc28b940403b534e37ded263719bf201b6552eab Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Sun, 23 Apr 2017 19:38:06 +0100
-Subject: [PATCH 145/173] config: Add CONFIG_BMP280 (and CONFIG_BMP280_I2C)
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index 95da3daaf33c7cfab76f6af397e058e9ed8d998f..c86d93a0b103cf812f502088f31ec222f4dea90a 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -1170,6 +1170,7 @@ CONFIG_MCP320X=m
- CONFIG_MCP3422=m
- CONFIG_DHT11=m
- CONFIG_HTU21=m
-+CONFIG_BMP280=m
- CONFIG_PWM_BCM2835=m
- CONFIG_PWM_PCA9685=m
- CONFIG_RASPBERRYPI_FIRMWARE=y
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index 06d0520e332f21afaa27ac112c0eee6c36a9a9df..515f335d2a638de60d07a45df19ce52a7579f9ca 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -1176,6 +1176,7 @@ CONFIG_MCP320X=m
- CONFIG_MCP3422=m
- CONFIG_DHT11=m
- CONFIG_HTU21=m
-+CONFIG_BMP280=m
- CONFIG_PWM_BCM2835=m
- CONFIG_PWM_PCA9685=m
- CONFIG_RASPBERRYPI_FIRMWARE=y
-
-From 05b3c24c5689b336a7b3114e08bb75ff07df5507 Mon Sep 17 00:00:00 2001
-From: Scott Ellis <scott@jumpnowtek.com>
-Date: Tue, 25 Apr 2017 10:46:09 -0400
-Subject: [PATCH 146/173] config: Enable TI TMP102 temp sensor module
+From a8512606094e188ab129777e1f1294458ead4a6d Mon Sep 17 00:00:00 2001
+From: Andrei Gherzan <andrei@gherzan.com>
+Date: Mon, 5 Jun 2017 16:40:38 +0100
+Subject: [PATCH 124/126] dma-bcm2708: Fix module compilation of
+ CONFIG_DMA_BCM2708
 
-Signed-off-by: Scott Ellis <scott@jumpnowtek.com>
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
+bcm2708-dmaengine.c defines functions like bcm_dma_start which are
+defined as well in dma-bcm2708.h as inline versions when
+CONFIG_DMA_BCM2708 is not defined. This works fine when
+CONFIG_DMA_BCM2708 is built in, but when it is selected as module build
+fails with redefinition errors because in the build system when
+CONFIG_DMA_BCM2708 is selected as module, the macro becomes
+CONFIG_DMA_BCM2708_MODULE.
 
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index c86d93a0b103cf812f502088f31ec222f4dea90a..5f5830fb19c497895c3e6d6e3a47e961fc84e09a 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -659,6 +659,7 @@ CONFIG_SENSORS_SHT21=m
- CONFIG_SENSORS_SHTC1=m
- CONFIG_SENSORS_ADS1015=m
- CONFIG_SENSORS_INA2XX=m
-+CONFIG_SENSORS_TMP102=m
- CONFIG_THERMAL=y
- CONFIG_BCM2835_THERMAL=y
- CONFIG_WATCHDOG=y
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index 515f335d2a638de60d07a45df19ce52a7579f9ca..bfda35e4c4bce99b5125eab80f97c73a159de969 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -652,6 +652,7 @@ CONFIG_SENSORS_SHT21=m
- CONFIG_SENSORS_SHTC1=m
- CONFIG_SENSORS_ADS1015=m
- CONFIG_SENSORS_INA2XX=m
-+CONFIG_SENSORS_TMP102=m
- CONFIG_THERMAL=y
- CONFIG_BCM2835_THERMAL=y
- CONFIG_WATCHDOG=y
+This patch makes the header use CONFIG_DMA_BCM2708_MODULE too when
+available.
 
-From e70fd08d60935d04026931c60a6ebc7115e1fe2c Mon Sep 17 00:00:00 2001
-From: Scott Ellis <scott@jumpnowtek.com>
-Date: Tue, 25 Apr 2017 13:05:42 -0400
-Subject: [PATCH 147/173] BCM270X_DT: Add tmp102 to i2c sensor overlay
+Fixes https://github.com/raspberrypi/linux/issues/2056
 
-Signed-off-by: Scott Ellis <scott@jumpnowtek.com>
+Signed-off-by: Andrei Gherzan <andrei@gherzan.com>
 ---
- arch/arm/boot/dts/overlays/README                 |  9 +++++++--
- arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts | 11 +++++++++--
- 2 files changed, 16 insertions(+), 4 deletions(-)
+ include/linux/platform_data/dma-bcm2708.h | 4 ++--
+ 1 file changed, 2 insertions(+), 2 deletions(-)
 
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index d32a31cbf4a4382ddfc1b38018ef3ff0ff445145..4171208933e675a5a3a7e17f8b15447f30a11887 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -652,16 +652,18 @@ Name:   i2c-sensor
- Info:   Adds support for a number of I2C barometric pressure and temperature
-         sensors on i2c_arm
- Load:   dtoverlay=i2c-sensor,<param>=<val>
--Params: addr                    Set the address for the BME280 and BMP280 (0x76
--                                or 0x77 - default 0x76)
-+Params: addr                    Set the address for the BME280, BMP280 or
-+                                TMP102
- 
-         bme280                  Select the Bosch Sensortronic BME280
-+                                Valid addresses 0x76-0x77, default 0x76
- 
-         bmp085                  Select the Bosch Sensortronic BMP085
- 
-         bmp180                  Select the Bosch Sensortronic BMP180
- 
-         bmp280                  Select the Bosch Sensortronic BMP280
-+                                Valid addresses 0x76-0x77, default 0x76
- 
-         lm75                    Select the Maxim LM75 temperature sensor
- 
-@@ -671,6 +673,9 @@ Params: addr                    Set the address for the BME280 and BMP280 (0x76
-         si7020                  Select the Silicon Labs Si7013/20/21 humidity/
-                                 temperature sensor
- 
-+        tmp102                  Select the Texas Instruments TMP102 temp sensor
-+                                Valid addresses 0x48-0x4b, default 0x48
-+
- 
- Name:   i2c0-bcm2708
- Info:   Enable the i2c_bcm2708 driver for the i2c0 bus. Not all pin combinations
-diff --git a/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-index e23e34b32a0a8927c14203d7384e800878627347..e86a13f92c3f75c14fa4425cdfb081d6795ff76a 100644
---- a/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-+++ b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-@@ -1,4 +1,4 @@
--// Definitions for I2C based sensors using the Industrial IO interface.
-+// Definitions for I2C based sensors using the Industrial IO or HWMON interface.
- /dts-v1/;
- /plugin/;
- 
-@@ -48,11 +48,17 @@
- 				reg = <0x40>;
- 				status = "disable";
- 			};
-+
-+			tmp102: tmp102@48 {
-+				compatible = "ti,tmp102";
-+				reg = <0x48>;
-+				status = "disable";
-+			};
- 		};
- 	};
+diff --git a/include/linux/platform_data/dma-bcm2708.h b/include/linux/platform_data/dma-bcm2708.h
+index c5bfff2765be4606077e6c8af73040ec13ee8974..6ca874d332a8bc666b1c9576ac51f479b98de14d 100644
+--- a/include/linux/platform_data/dma-bcm2708.h
++++ b/include/linux/platform_data/dma-bcm2708.h
+@@ -75,7 +75,7 @@ struct bcm2708_dma_cb {
+ struct scatterlist;
+ struct platform_device;
  
- 	__overrides__ {
--		addr =  <&bme280>,"reg:0", <&bmp280>,"reg:0";
-+		addr =  <&bme280>,"reg:0", <&bmp280>,"reg:0", <&tmp102>,"reg:0";
- 		bme280 = <&bme280>,"status";
- 		bmp085 = <&bmp085>,"status";
- 		bmp180 = <&bmp180>,"status";
-@@ -60,5 +66,6 @@
- 		lm75 = <&lm75>,"status";
- 		lm75addr = <&lm75>,"reg:0";
- 		si7020 = <&si7020>,"status";
-+		tmp102 = <&tmp102>,"status";
- 	};
- };
-
-From 80ff6ff1ba623da4a2e680a4ea641d47ad00c93d Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Mon, 8 May 2017 16:43:40 +0100
-Subject: [PATCH 148/173] irq_bcm2836: Send event when onlining sleeping cores
-
-In order to reduce power consumption and bus traffic, it is sensible
-for secondary cores to enter a low-power idle state when waiting to
-be started. The wfe instruction causes a core to wait until an event
-or interrupt arrives before continuing to the next instruction.
-The sev instruction sends a wakeup event to the other cores, so call
-it from bcm2836_smp_boot_secondary, the function that wakes up the
-waiting cores during booting.
-
-It is harmless to use this patch without the corresponding change
-adding wfe to the ARMv7/ARMv8-32 stubs, but if the stubs are updated
-and this patch is not applied then the other cores will sleep forever.
-
-See: https://github.com/raspberrypi/linux/issues/1989
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- drivers/irqchip/irq-bcm2836.c | 3 +++
- 1 file changed, 3 insertions(+)
-
-diff --git a/drivers/irqchip/irq-bcm2836.c b/drivers/irqchip/irq-bcm2836.c
-index 9a7ee04ee0d9b7aa734cf3159ed59c19a338de0d..014f13f89eb896f5cfc75ed9891787d0490baa4b 100644
---- a/drivers/irqchip/irq-bcm2836.c
-+++ b/drivers/irqchip/irq-bcm2836.c
-@@ -248,6 +248,9 @@ static int __init bcm2836_smp_boot_secondary(unsigned int cpu,
- 	writel(secondary_startup_phys,
- 	       intc.base + LOCAL_MAILBOX3_SET0 + 16 * cpu);
+-#ifdef CONFIG_DMA_BCM2708
++#if defined(CONFIG_DMA_BCM2708) || defined(CONFIG_DMA_BCM2708_MODULE)
  
-+	dsb(sy); /* Ensure write has completed before waking the other CPUs */
-+	sev();
-+
+ int bcm_sg_suitable_for_dma(struct scatterlist *sg_ptr, int sg_len);
+ void bcm_dma_start(void __iomem *dma_chan_base, dma_addr_t control_block);
+@@ -138,6 +138,6 @@ static inline int bcm_dmaman_remove(struct platform_device *pdev)
  	return 0;
  }
  
-
-From ae1b61f594b8a110ee91f13b30bedf6eea13ff4e Mon Sep 17 00:00:00 2001
-From: Ahmet Inan <inan@distec.de>
-Date: Mon, 15 May 2017 17:10:53 +0200
-Subject: [PATCH 149/173] overlays: Add Goodix overlay
-
-Add support for I2C connected Goodix gt9271 multiple touch controller using
-GPIOs 4 and 17 (pins 7 and 11 on GPIO header) for interrupt and reset.
-
-Signed-off-by: Ahmet Inan <inan@distec.de>
----
- arch/arm/boot/dts/overlays/Makefile           |  1 +
- arch/arm/boot/dts/overlays/README             |  8 +++++
- arch/arm/boot/dts/overlays/goodix-overlay.dts | 46 +++++++++++++++++++++++++++
- 3 files changed, 55 insertions(+)
- create mode 100644 arch/arm/boot/dts/overlays/goodix-overlay.dts
-
-diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
-index e0ff5793f124fce73732e175bfca424f0a97b632..ddf431837b619f99beb8df45a2714c112e02273c 100644
---- a/arch/arm/boot/dts/overlays/Makefile
-+++ b/arch/arm/boot/dts/overlays/Makefile
-@@ -25,6 +25,7 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
- 	enc28j60.dtbo \
- 	enc28j60-spi2.dtbo \
- 	fe-pi-audio.dtbo \
-+	goodix.dtbo \
- 	googlevoicehat-soundcard.dtbo \
- 	gpio-ir.dtbo \
- 	gpio-poweroff.dtbo \
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index 4171208933e675a5a3a7e17f8b15447f30a11887..dc391ac88f738c9a711b01a87561c94733745457 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -459,6 +459,14 @@ Load:   dtoverlay=fe-pi-audio
- Params: <None>
- 
+-#endif /* CONFIG_DMA_BCM2708 */
++#endif /* CONFIG_DMA_BCM2708 || CONFIG_DMA_BCM2708_MODULE */
  
-+Name:   goodix
-+Info:   Enables I2C connected Goodix gt9271 multiple touch controller using
-+        GPIOs 4 and 17 (pins 7 and 11 on GPIO header) for interrupt and reset.
-+Load:   dtoverlay=goodix,<param>=<val>
-+Params: interrupt               GPIO used for interrupt (default 4)
-+        reset                   GPIO used for reset (default 17)
-+
-+
- Name:   googlevoicehat-soundcard
- Info:   Configures the Google voiceHAT soundcard
- Load:   dtoverlay=googlevoicehat-soundcard
-diff --git a/arch/arm/boot/dts/overlays/goodix-overlay.dts b/arch/arm/boot/dts/overlays/goodix-overlay.dts
-new file mode 100644
-index 0000000000000000000000000000000000000000..084f74042ed6379ebd9281374d5391a7e23a431e
---- /dev/null
-+++ b/arch/arm/boot/dts/overlays/goodix-overlay.dts
-@@ -0,0 +1,46 @@
-+// Device tree overlay for I2C connected Goodix gt9271 multiple touch controller
-+/dts-v1/;
-+/plugin/;
-+
-+/ {
-+	compatible = "brcm,bcm2708";
-+
-+	fragment@0 {
-+		target = <&gpio>;
-+		__overlay__ {
-+			goodix_pins: goodix_pins {
-+				brcm,pins = <4 17>; // interrupt and reset
-+				brcm,function = <0 0>; // in
-+				brcm,pull = <2 2>; // pull-up
-+			};
-+		};
-+	};
-+
-+	fragment@1 {
-+		target = <&i2c1>;
-+		__overlay__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			gt9271: gt9271@14 {
-+				compatible = "goodix,gt9271";
-+				reg = <0x14>;
-+				pinctrl-names = "default";
-+				pinctrl-0 = <&goodix_pins>;
-+				interrupt-parent = <&gpio>;
-+				interrupts = <4 2>; // high-to-low edge triggered
-+				irq-gpios = <&gpio 4 0>; // Pin7 on GPIO header
-+				reset-gpios = <&gpio 17 0>; // Pin11 on GPIO header
-+			};
-+		};
-+	};
-+
-+	__overrides__ {
-+		interrupt = <&goodix_pins>,"brcm,pins:0",
-+			<&gt9271>,"interrupts:0",
-+			<&gt9271>,"irq-gpios:4";
-+		reset = <&goodix_pins>,"brcm,pins:4",
-+			<&gt9271>,"reset-gpios:4";
-+	};
-+};
+ #endif /* _PLAT_BCM2708_DMA_H */
 
-From c183f774a63c80cae7889f78d070eb5ce325cf9b Mon Sep 17 00:00:00 2001
-From: chenzhiwo <chenzhiwo@139.com>
-Date: Wed, 17 May 2017 16:34:57 +0800
-Subject: [PATCH 150/173] Add device tree overlay for GPIO connected rotary
- encoder. See Documentation/input/rotary-encoder.txt for more information.
+From 7f1645c35c73959bed7193c5a045ba7c96aff1ee Mon Sep 17 00:00:00 2001
+From: popcornmix <popcornmix@gmail.com>
+Date: Fri, 25 Aug 2017 19:18:13 +0100
+Subject: [PATCH 125/126] cache: export clean and invalidate
 
 ---
- arch/arm/boot/dts/overlays/Makefile                |  1 +
- arch/arm/boot/dts/overlays/README                  |  9 +++++
- .../boot/dts/overlays/rotary-encoder-overlay.dts   | 43 ++++++++++++++++++++++
- 3 files changed, 53 insertions(+)
- create mode 100644 arch/arm/boot/dts/overlays/rotary-encoder-overlay.dts
+ arch/arm/mm/cache-v6.S | 4 ++--
+ arch/arm/mm/cache-v7.S | 4 ++--
+ 2 files changed, 4 insertions(+), 4 deletions(-)
 
-diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
-index ddf431837b619f99beb8df45a2714c112e02273c..6853e3575f001522a402e7eb31933d32fbac581d 100644
---- a/arch/arm/boot/dts/overlays/Makefile
-+++ b/arch/arm/boot/dts/overlays/Makefile
-@@ -76,6 +76,7 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
- 	pwm-2chan.dtbo \
- 	qca7000.dtbo \
- 	raspidac3.dtbo \
-+	rotary-encoder.dtbo \
- 	rpi-backlight.dtbo \
- 	rpi-cirrus-wm5102.dtbo \
- 	rpi-dac.dtbo \
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index dc391ac88f738c9a711b01a87561c94733745457..f7e11387e535ce2dba8272798a023963315685b6 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -1122,6 +1122,15 @@ Load:   dtoverlay=raspidac3
- Params: <None>
- 
- 
-+Name:   rotary-encoder
-+Info:   Overlay for GPIO connected rotary encoder.
-+Load:   dtoverlay=rotary-encoder,<param>=<val>
-+Params: rotary0_pin_a           GPIO connected to rotary encoder channel A
-+                                (default 4).
-+        rotary0_pin_b           GPIO connected to rotary encoder channel B
-+                                (default 17).
-+
-+
- Name:   rpi-backlight
- Info:   Raspberry Pi official display backlight driver
- Load:   dtoverlay=rpi-backlight
-diff --git a/arch/arm/boot/dts/overlays/rotary-encoder-overlay.dts b/arch/arm/boot/dts/overlays/rotary-encoder-overlay.dts
-new file mode 100644
-index 0000000000000000000000000000000000000000..c0c6bccff60cc15d9a9bf59d2c7cba41eb9c1cdc
---- /dev/null
-+++ b/arch/arm/boot/dts/overlays/rotary-encoder-overlay.dts
-@@ -0,0 +1,43 @@
-+// Device tree overlay for GPIO connected rotary encoder.
-+/dts-v1/;
-+/plugin/;
-+
-+/ {
-+	compatible = "brcm,bcm2708";
-+
-+	fragment@0 {
-+		target = <&gpio>;
-+		__overlay__ {
-+			rotary0_pins: rotary0_pins {
-+				brcm,pins = <4 17>; /* gpio 4 17 */
-+				brcm,function = <0 0>; /* input */
-+				brcm,pull = <2 2>; /* pull-up */
-+			};
-+
-+		};
-+	};
-+
-+	fragment@1 {
-+		target-path = "/";
-+		__overlay__ {
-+			rotary0: rotary@0 {
-+					compatible = "rotary-encoder";
-+					status = "okay";
-+					pinctrl-names = "default";
-+					pinctrl-0 = <&rotary0_pins>;
-+					gpios = <&gpio 4 0>, <&gpio 17 0>;
-+					linux,axis = <0>; /* REL_X */
-+					rotary-encoder,encoding = "gray";
-+					rotary-encoder,relative-axis;
-+			};
-+		};
-+
-+	};  
-+
-+	__overrides__ {
-+		rotary0_pin_a = <&rotary0>,"gpios:4",
-+				<&rotary0_pins>,"brcm,pins:0";
-+		rotary0_pin_b = <&rotary0>,"gpios:16",
-+				<&rotary0_pins>,"brcm,pins:4";
-+	};  
-+};
+diff --git a/arch/arm/mm/cache-v6.S b/arch/arm/mm/cache-v6.S
+index 24659952c2784de64a53dc2e889ab616bd19b12b..1ee5bc3a101884132a65adae32d6ef7417667ffc 100644
+--- a/arch/arm/mm/cache-v6.S
++++ b/arch/arm/mm/cache-v6.S
+@@ -201,7 +201,7 @@ ENTRY(v6_flush_kern_dcache_area)
+  *	- start   - virtual start address of region
+  *	- end     - virtual end address of region
+  */
+-v6_dma_inv_range:
++ENTRY(v6_dma_inv_range)
+ #ifdef CONFIG_DMA_CACHE_RWFO
+ 	ldrb	r2, [r0]			@ read for ownership
+ 	strb	r2, [r0]			@ write for ownership
+@@ -246,7 +246,7 @@ v6_dma_inv_range:
+  *	- start   - virtual start address of region
+  *	- end     - virtual end address of region
+  */
+-v6_dma_clean_range:
++ENTRY(v6_dma_clean_range)
+ 	bic	r0, r0, #D_CACHE_LINE_SIZE - 1
+ 1:
+ #ifdef CONFIG_DMA_CACHE_RWFO
+diff --git a/arch/arm/mm/cache-v7.S b/arch/arm/mm/cache-v7.S
+index de78109d002db1a5e7c94a6c1bc8bb94161d07b8..4c850aa3af2b2439fced4e130441329a724fb370 100644
+--- a/arch/arm/mm/cache-v7.S
++++ b/arch/arm/mm/cache-v7.S
+@@ -349,7 +349,7 @@ ENDPROC(v7_flush_kern_dcache_area)
+  *	- start   - virtual start address of region
+  *	- end     - virtual end address of region
+  */
+-v7_dma_inv_range:
++ENTRY(v7_dma_inv_range)
+ 	dcache_line_size r2, r3
+ 	sub	r3, r2, #1
+ 	tst	r0, r3
+@@ -377,7 +377,7 @@ ENDPROC(v7_dma_inv_range)
+  *	- start   - virtual start address of region
+  *	- end     - virtual end address of region
+  */
+-v7_dma_clean_range:
++ENTRY(v7_dma_clean_range)
+ 	dcache_line_size r2, r3
+ 	sub	r3, r2, #1
+ 	bic	r0, r0, r3
 
-From 9c1c2351c13ce7b2d20de04a438125bb0d75734d Mon Sep 17 00:00:00 2001
-From: Anton Onishchenko <tony.o.developer@gmail.com>
-Date: Tue, 23 May 2017 18:55:46 +0300
-Subject: [PATCH 151/173] mpu6050 device tree overlay (#2031)
+From dc7a0ebdc9f143f0750b6dd9c1a4054a2df5abc8 Mon Sep 17 00:00:00 2001
+From: popcornmix <popcornmix@gmail.com>
+Date: Tue, 19 Sep 2017 17:28:05 +0100
+Subject: [PATCH 126/126] fixup! Improve __copy_to_user and __copy_from_user
+ performance
 
-Add overlay and config options for InvenSense MPU6050 6-axis motion
-detector.
 ---
- arch/arm/boot/dts/overlays/Makefile            |  1 +
- arch/arm/boot/dts/overlays/README              |  6 ++++++
- arch/arm/boot/dts/overlays/mpu6050-overlay.dts | 28 ++++++++++++++++++++++++++
- arch/arm/configs/bcm2709_defconfig             |  3 +--
- arch/arm/configs/bcmrpi_defconfig              |  3 +--
- 5 files changed, 37 insertions(+), 4 deletions(-)
- create mode 100644 arch/arm/boot/dts/overlays/mpu6050-overlay.dts
+ arch/arm/lib/memset_rpi.S | 5 +++++
+ 1 file changed, 5 insertions(+)
 
-diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
-index 6853e3575f001522a402e7eb31933d32fbac581d..c95b37f0a4c72160421f44819c5f29246d3352f9 100644
---- a/arch/arm/boot/dts/overlays/Makefile
-+++ b/arch/arm/boot/dts/overlays/Makefile
-@@ -59,6 +59,7 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
- 	midi-uart0.dtbo \
- 	midi-uart1.dtbo \
- 	mmc.dtbo \
-+	mpu6050.dtbo \
- 	mz61581.dtbo \
- 	pi3-act-led.dtbo \
- 	pi3-disable-bt.dtbo \
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index f7e11387e535ce2dba8272798a023963315685b6..d560490c2661c3396d37315bbb9b2d9e93b5ac15 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -898,6 +898,12 @@ Params: overclock_50            Clock (in MHz) to use when the MMC framework
-                                 requests 50MHz
- 
- 
-+Name:   mpu6050
-+Info:   Overlay for i2c connected mpu6050 imu
-+Load:   dtoverlay=mpu6050,<param>=<val>
-+Params: interrupt               GPIO pin for interrupt (default 4)
-+
-+
- Name:   mz61581
- Info:   MZ61581 display by Tontec
- Load:   dtoverlay=mz61581,<param>=<val>
-diff --git a/arch/arm/boot/dts/overlays/mpu6050-overlay.dts b/arch/arm/boot/dts/overlays/mpu6050-overlay.dts
-new file mode 100644
-index 0000000000000000000000000000000000000000..06037969c3abba270b3cad45875342f3c730506e
---- /dev/null
-+++ b/arch/arm/boot/dts/overlays/mpu6050-overlay.dts
-@@ -0,0 +1,28 @@
-+// Definitions for MPU6050
-+/dts-v1/;
-+/plugin/;
-+
-+/ {
-+        compatible = "brcm,bcm2708";
-+
-+        fragment@0 {
-+                target = <&i2c1>;
-+                __overlay__ {
-+                        #address-cells = <1>;
-+                        #size-cells = <0>;
-+                        status = "okay";
-+                        clock-frequency = <400000>;
-+
-+                        mpu6050: mpu6050@68 {
-+                                compatible = "invensense,mpu6050";
-+                                reg = <0x68>;
-+                                interrupt-parent = <&gpio>;
-+                                interrupts = <4 1>;
-+                        };
-+                };
-+        };
-+
-+        __overrides__ {
-+                interrupt = <&mpu6050>,"interrupts:0";
-+        };
-+};
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index 5f5830fb19c497895c3e6d6e3a47e961fc84e09a..b310e13042b20c709a8139d0b3973c3ed5f283cf 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -1164,13 +1164,12 @@ CONFIG_RASPBERRYPI_POWER=y
- CONFIG_EXTCON=m
- CONFIG_EXTCON_ARIZONA=m
- CONFIG_IIO=m
--CONFIG_IIO_BUFFER=y
- CONFIG_IIO_BUFFER_CB=m
--CONFIG_IIO_KFIFO_BUF=m
- CONFIG_MCP320X=m
- CONFIG_MCP3422=m
- CONFIG_DHT11=m
- CONFIG_HTU21=m
-+CONFIG_INV_MPU6050_I2C=m
- CONFIG_BMP280=m
- CONFIG_PWM_BCM2835=m
- CONFIG_PWM_PCA9685=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index bfda35e4c4bce99b5125eab80f97c73a159de969..a9841b71a4b633a81392c533578845d62f6aa78f 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -1170,13 +1170,12 @@ CONFIG_RASPBERRYPI_POWER=y
- CONFIG_EXTCON=m
- CONFIG_EXTCON_ARIZONA=m
- CONFIG_IIO=m
--CONFIG_IIO_BUFFER=y
- CONFIG_IIO_BUFFER_CB=m
--CONFIG_IIO_KFIFO_BUF=m
- CONFIG_MCP320X=m
- CONFIG_MCP3422=m
- CONFIG_DHT11=m
- CONFIG_HTU21=m
-+CONFIG_INV_MPU6050_I2C=m
- CONFIG_BMP280=m
- CONFIG_PWM_BCM2835=m
- CONFIG_PWM_PCA9685=m
-
-From 3bcb0faa9c3c8d30eb78355ee4897c551a2b5ab4 Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Wed, 31 May 2017 09:33:55 +0100
-Subject: [PATCH 152/173] config: Adding SENSOR_JC42
-
-The jc42 module supports a number of I2C-based temperature
-sensor modules.
-
-[ DM_RAID0 config lost because now selected by DM_RAID ]
-
-See: https://github.com/raspberrypi/linux/issues/2046
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index b310e13042b20c709a8139d0b3973c3ed5f283cf..00845b52952479976b4fdfdc94a16a366d82ae7d 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -654,6 +654,7 @@ CONFIG_POWER_RESET=y
- CONFIG_POWER_RESET_GPIO=y
- CONFIG_BATTERY_DS2760=m
- CONFIG_HWMON=m
-+CONFIG_SENSORS_JC42=m
- CONFIG_SENSORS_LM75=m
- CONFIG_SENSORS_SHT21=m
- CONFIG_SENSORS_SHTC1=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index a9841b71a4b633a81392c533578845d62f6aa78f..2ba46a28c2e7b21a401cc3544353937eca44218d 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -647,6 +647,7 @@ CONFIG_POWER_RESET=y
- CONFIG_POWER_RESET_GPIO=y
- CONFIG_BATTERY_DS2760=m
- CONFIG_HWMON=m
-+CONFIG_SENSORS_JC42=m
- CONFIG_SENSORS_LM75=m
- CONFIG_SENSORS_SHT21=m
- CONFIG_SENSORS_SHTC1=m
-
-From 0b1e677ecc506655be6c22dd09851ad6ddd69982 Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Wed, 31 May 2017 15:27:39 +0100
-Subject: [PATCH 153/173] BCM270X_DT: Improve i2c-sensor and i2c-rtc overlay
-
-Use the "__dormant__" feature to permit multiple instances of each
-overlay, which is more useful now that changing the "reg" property
-also changes the node address. Although the overlay grows slightly,
-when applied only the requested node is included.
-
-Usage does not change, except that the "lm75addr" parameter of the
-i2c-sensor overlay has been deprecated in favour of the generic
-"addr" parameter.
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- arch/arm/boot/dts/overlays/README                 |   8 +-
- arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts    | 127 ++++++++++++++++++----
- arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts |  87 ++++++++++++---
- 3 files changed, 179 insertions(+), 43 deletions(-)
-
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index d560490c2661c3396d37315bbb9b2d9e93b5ac15..ce8706a8aa88c36b0dee95c56ee58b4a524b8b43 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -660,8 +660,8 @@ Name:   i2c-sensor
- Info:   Adds support for a number of I2C barometric pressure and temperature
-         sensors on i2c_arm
- Load:   dtoverlay=i2c-sensor,<param>=<val>
--Params: addr                    Set the address for the BME280, BMP280 or
--                                TMP102
-+Params: addr                    Set the address for the BME280, BMP280, TMP102
-+                                or LM75
- 
-         bme280                  Select the Bosch Sensortronic BME280
-                                 Valid addresses 0x76-0x77, default 0x76
-@@ -674,9 +674,9 @@ Params: addr                    Set the address for the BME280, BMP280 or
-                                 Valid addresses 0x76-0x77, default 0x76
- 
-         lm75                    Select the Maxim LM75 temperature sensor
-+                                Valid addresses 0x48-0x4f, default 0x4f
- 
--        lm75addr                Choose the address for the LM75 (0x48-0x4f -
--                                default 0x4f)
-+        lm75addr                Deprecated - use addr parameter instead
- 
-         si7020                  Select the Silicon Labs Si7013/20/21 humidity/
-                                 temperature sensor
-diff --git a/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts b/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts
-index 1efcf0b712c9c5c19210545002ac1f0931db58f5..6140f172a86b8731782f938f76cb5dac9f28b662 100644
---- a/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts
-+++ b/arch/arm/boot/dts/overlays/i2c-rtc-overlay.dts
-@@ -7,7 +7,7 @@
- 
- 	fragment@0 {
- 		target = <&i2c_arm>;
--		__overlay__ {
-+		__dormant__ {
- 			#address-cells = <1>;
- 			#size-cells = <0>;
- 			status = "okay";
-@@ -17,61 +17,142 @@
- 				reg = <0x69>;
- 				abracon,tc-diode = "standard";
- 				abracon,tc-resistor = <0>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@1 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
- 			ds1307: ds1307@68 {
- 				compatible = "maxim,ds1307";
- 				reg = <0x68>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@2 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
- 			ds1339: ds1339@68 {
- 				compatible = "dallas,ds1339";
- 				trickle-resistor-ohms = <0>;
- 				reg = <0x68>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@3 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			ds3231: ds3231@68 {
-+				compatible = "maxim,ds3231";
-+				reg = <0x68>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@4 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
- 			mcp7940x: mcp7940x@6f {
- 				compatible = "microchip,mcp7940x";
- 				reg = <0x6f>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@5 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
- 			mcp7941x: mcp7941x@6f {
- 				compatible = "microchip,mcp7941x";
- 				reg = <0x6f>;
--				status = "disable";
--			};
--			ds3231: ds3231@68 {
--				compatible = "maxim,ds3231";
--				reg = <0x68>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@6 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
- 			pcf2127: pcf2127@51 {
- 				compatible = "nxp,pcf2127";
- 				reg = <0x51>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@7 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
- 			pcf8523: pcf8523@68 {
- 				compatible = "nxp,pcf8523";
- 				reg = <0x68>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@8 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
- 			pcf8563: pcf8563@51 {
- 				compatible = "nxp,pcf8563";
- 				reg = <0x51>;
--				status = "disable";
-+				status = "okay";
- 			};
- 		};
- 	};
-+
- 	__overrides__ {
--		abx80x = <&abx80x>,"status";
--		ds1307 = <&ds1307>,"status";
--		ds1339 = <&ds1339>,"status";
--		ds3231 = <&ds3231>,"status";
--		mcp7940x = <&mcp7940x>,"status";
--		mcp7941x = <&mcp7941x>,"status";
--		pcf2127 = <&pcf2127>,"status";
--		pcf8523 = <&pcf8523>,"status";
--		pcf8563 = <&pcf8563>,"status";
-+		abx80x = <0>,"+0";
-+		ds1307 = <0>,"+1";
-+		ds1339 = <0>,"+2";
-+		ds3231 = <0>,"+3";
-+		mcp7940x = <0>,"+4";
-+		mcp7941x = <0>,"+5";
-+		pcf2127 = <0>,"+6";
-+		pcf8523 = <0>,"+7";
-+		pcf8563 = <0>,"+8";
- 		trickle-diode-type = <&abx80x>,"abracon,tc-diode";
- 		trickle-resistor-ohms = <&ds1339>,"trickle-resistor-ohms:0",
- 					<&abx80x>,"abracon,tc-resistor";
-diff --git a/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-index e86a13f92c3f75c14fa4425cdfb081d6795ff76a..d2f0008addfadac8f6ed774a6e4f3f97871c0d61 100644
---- a/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-+++ b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-@@ -7,7 +7,7 @@
- 
- 	fragment@0 {
- 		target = <&i2c_arm>;
--		__overlay__ {
-+		__dormant__ {
- 			#address-cells = <1>;
- 			#size-cells = <0>;
- 			status = "okay";
-@@ -15,57 +15,112 @@
- 			bme280: bme280@76 {
- 				compatible = "bosch,bme280";
- 				reg = <0x76>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@1 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
- 
- 			bmp085: bmp085@77 {
- 				compatible = "bosch,bmp085";
- 				reg = <0x77>;
- 				default-oversampling = <3>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@2 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
- 
- 			bmp180: bmp180@77 {
- 				compatible = "bosch,bmp180";
- 				reg = <0x77>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@3 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
- 
- 			bmp280: bmp280@76 {
- 				compatible = "bosch,bmp280";
- 				reg = <0x76>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@4 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
- 
- 			lm75: lm75@4f {
- 				compatible = "lm75";
- 				reg = <0x4f>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@5 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
- 
- 			si7020: si7020@40 {
- 				compatible = "si7020";
- 				reg = <0x40>;
--				status = "disable";
-+				status = "okay";
- 			};
-+		};
-+	};
-+
-+	fragment@6 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
- 
- 			tmp102: tmp102@48 {
- 				compatible = "ti,tmp102";
- 				reg = <0x48>;
--				status = "disable";
-+				status = "okay";
- 			};
- 		};
- 	};
- 
- 	__overrides__ {
--		addr =  <&bme280>,"reg:0", <&bmp280>,"reg:0", <&tmp102>,"reg:0";
--		bme280 = <&bme280>,"status";
--		bmp085 = <&bmp085>,"status";
--		bmp180 = <&bmp180>,"status";
--		bmp280 = <&bmp280>,"status";
--		lm75 = <&lm75>,"status";
-+		addr =  <&bme280>,"reg:0", <&bmp280>,"reg:0", <&tmp102>,"reg:0",
-+			<&lm75>,"reg:0";
-+		bme280 = <0>,"+0";
-+		bmp085 = <0>,"+1";
-+		bmp180 = <0>,"+2";
-+		bmp280 = <0>,"+3";
-+		lm75 = <0>,"+4";
- 		lm75addr = <&lm75>,"reg:0";
--		si7020 = <&si7020>,"status";
--		tmp102 = <&tmp102>,"status";
-+		si7020 = <0>,"+5";
-+		tmp102 = <0>,"+6";
- 	};
- };
-
-From 52595ff8c04eae49d88eaf32b9d74cab4b898773 Mon Sep 17 00:00:00 2001
-From: Stefan Tatschner <rumpelsepp@sevenbyte.org>
-Date: Mon, 29 May 2017 21:46:16 +0200
-Subject: [PATCH 154/173] Add device tree config for htu21
-
-See: https://github.com/raspberrypi/linux/pull/2041
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- arch/arm/boot/dts/overlays/README                 |  2 ++
- arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts | 26 ++++++++++++++++++-----
- 2 files changed, 23 insertions(+), 5 deletions(-)
-
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index ce8706a8aa88c36b0dee95c56ee58b4a524b8b43..bce02c82f3438995e5a74080876391f758bfe27b 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -673,6 +673,8 @@ Params: addr                    Set the address for the BME280, BMP280, TMP102
-         bmp280                  Select the Bosch Sensortronic BMP280
-                                 Valid addresses 0x76-0x77, default 0x76
- 
-+        htu21                   Select the HTU21 temperature and humidity sensor
-+
-         lm75                    Select the Maxim LM75 temperature sensor
-                                 Valid addresses 0x48-0x4f, default 0x4f
- 
-diff --git a/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-index d2f0008addfadac8f6ed774a6e4f3f97871c0d61..17c27e3b666a7a83619471b50c63bb93836653c5 100644
---- a/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-+++ b/arch/arm/boot/dts/overlays/i2c-sensor-overlay.dts
-@@ -73,6 +73,21 @@
- 			#size-cells = <0>;
- 			status = "okay";
- 
-+			htu21: htu21@40 {
-+				compatible = "htu21";
-+				reg = <0x40>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@5 {
-+		target = <&i2c_arm>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
- 			lm75: lm75@4f {
- 				compatible = "lm75";
- 				reg = <0x4f>;
-@@ -81,7 +96,7 @@
- 		};
- 	};
- 
--	fragment@5 {
-+	fragment@6 {
- 		target = <&i2c_arm>;
- 		__dormant__ {
- 			#address-cells = <1>;
-@@ -96,7 +111,7 @@
- 		};
- 	};
- 
--	fragment@6 {
-+	fragment@7 {
- 		target = <&i2c_arm>;
- 		__dormant__ {
- 			#address-cells = <1>;
-@@ -118,9 +133,10 @@
- 		bmp085 = <0>,"+1";
- 		bmp180 = <0>,"+2";
- 		bmp280 = <0>,"+3";
--		lm75 = <0>,"+4";
-+		htu21 = <0>,"+4";
-+		lm75 = <0>,"+5";
- 		lm75addr = <&lm75>,"reg:0";
--		si7020 = <0>,"+5";
--		tmp102 = <0>,"+6";
-+		si7020 = <0>,"+6";
-+		tmp102 = <0>,"+7";
- 	};
- };
-
-From f216bda69d0eda5a267c97047826989a4512e711 Mon Sep 17 00:00:00 2001
-From: sandeepal <alsandeep@cem-solutions.net>
-Date: Fri, 2 Jun 2017 18:59:46 +0530
-Subject: [PATCH 155/173] Allo Digione Driver (#2048)
-
-Driver for the Allo Digione soundcard
----
- arch/arm/boot/dts/overlays/Makefile                |   1 +
- arch/arm/boot/dts/overlays/README                  |   6 +
- .../arm/boot/dts/overlays/allo-digione-overlay.dts |  44 ++++
- arch/arm/configs/bcm2709_defconfig                 |   1 +
- arch/arm/configs/bcmrpi_defconfig                  |   1 +
- sound/soc/bcm/Kconfig                              |   7 +
- sound/soc/bcm/Makefile                             |   2 +
- sound/soc/bcm/allo-digione.c                       | 268 +++++++++++++++++++++
- 8 files changed, 330 insertions(+)
- create mode 100644 arch/arm/boot/dts/overlays/allo-digione-overlay.dts
- create mode 100644 sound/soc/bcm/allo-digione.c
-
-diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
-index c95b37f0a4c72160421f44819c5f29246d3352f9..eca81982c0f19988abd05165fc62a80d26f539cb 100644
---- a/arch/arm/boot/dts/overlays/Makefile
-+++ b/arch/arm/boot/dts/overlays/Makefile
-@@ -8,6 +8,7 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
- 	ads7846.dtbo \
- 	akkordion-iqdacplus.dtbo \
- 	allo-boss-dac-pcm512x-audio.dtbo \
-+	allo-digione.dtbo \
- 	allo-piano-dac-pcm512x-audio.dtbo \
- 	allo-piano-dac-plus-pcm512x-audio.dtbo \
- 	at86rf233.dtbo \
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index bce02c82f3438995e5a74080876391f758bfe27b..19df6883be4277240283d5f63f27e34a22a2eec5 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -287,6 +287,12 @@ Params: 24db_digital_gain       Allow gain to be applied via the PCM512x codec
-                                 slave"
- 
- 
-+Name:   allo-digione
-+Info:   Configures the Allo Digione audio card
-+Load:   dtoverlay=allo-digione
-+Params: <None>
-+
-+
- Name:   allo-piano-dac-pcm512x-audio
- Info:   Configures the Allo Piano DAC (2.0/2.1) audio cards.
-         (NB. This initial support is for 2.0 channel audio ONLY! ie. stereo.
-diff --git a/arch/arm/boot/dts/overlays/allo-digione-overlay.dts b/arch/arm/boot/dts/overlays/allo-digione-overlay.dts
-new file mode 100644
-index 0000000000000000000000000000000000000000..101277a11a24e9b3eb441c44c3f19c61836fe77c
---- /dev/null
-+++ b/arch/arm/boot/dts/overlays/allo-digione-overlay.dts
-@@ -0,0 +1,44 @@
-+// Definitions for Allo DigiOne
-+/dts-v1/;
-+/plugin/;
-+
-+/ {
-+	compatible = "brcm,bcm2708";
-+
-+	fragment@0 {
-+		target = <&i2s>;
-+		__overlay__ {
-+			status = "okay";
-+		};
-+	};
-+
-+	fragment@1 {
-+		target = <&i2c1>;
-+		__overlay__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			wm8804@3b {
-+				#sound-dai-cells = <0>;
-+				compatible = "wlf,wm8804";
-+				reg = <0x3b>;
-+				PVDD-supply = <&vdd_3v3_reg>;
-+				DVDD-supply = <&vdd_3v3_reg>;
-+				status = "okay";
-+				wlf,reset-gpio = <&gpio 17 0>;
-+			};
-+		};
-+	};
-+
-+	fragment@2 {
-+		target = <&sound>;
-+		__overlay__ {
-+			compatible = "allo,allo-digione";
-+			i2s-controller = <&i2s>;
-+			status = "okay";
-+			clock44-gpio = <&gpio 5 0>;
-+			clock48-gpio = <&gpio 6 0>;
-+		};
-+	};
-+};
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index 00845b52952479976b4fdfdc94a16a366d82ae7d..d2838cde4019be5f6faf0a70038c6365df9e6dde 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -892,6 +892,7 @@ CONFIG_SND_BCM2708_SOC_DIONAUDIO_LOCO_V2=m
- CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC=m
- CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC_PLUS=m
- CONFIG_SND_BCM2708_SOC_ALLO_BOSS_DAC=m
-+CONFIG_SND_BCM2708_SOC_ALLO_DIGIONE=m
- CONFIG_SND_BCM2708_SOC_FE_PI_AUDIO=m
- CONFIG_SND_PISOUND=m
- CONFIG_SND_SOC_ADAU1701=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index 2ba46a28c2e7b21a401cc3544353937eca44218d..efdb0fbc1b07c7b679cb20d8c1270c77d5d3c684 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -885,6 +885,7 @@ CONFIG_SND_BCM2708_SOC_DIONAUDIO_LOCO_V2=m
- CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC=m
- CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC_PLUS=m
- CONFIG_SND_BCM2708_SOC_ALLO_BOSS_DAC=m
-+CONFIG_SND_BCM2708_SOC_ALLO_DIGIONE=m
- CONFIG_SND_BCM2708_SOC_FE_PI_AUDIO=m
- CONFIG_SND_PISOUND=m
- CONFIG_SND_SOC_ADAU1701=m
-diff --git a/sound/soc/bcm/Kconfig b/sound/soc/bcm/Kconfig
-index 355bdeb25f81d15593f78df0e87a48404908ca4b..381d32bb9deb3cf2c531e2a4563418cd6eb9d505 100644
---- a/sound/soc/bcm/Kconfig
-+++ b/sound/soc/bcm/Kconfig
-@@ -176,6 +176,13 @@ config SND_BCM2708_SOC_ALLO_BOSS_DAC
- 	help
- 	  Say Y or M if you want to add support for Allo Boss DAC.
- 
-+config SND_BCM2708_SOC_ALLO_DIGIONE 
-+        tristate "Support for Allo DigiOne"
-+	depends on SND_BCM2708_SOC_I2S || SND_BCM2835_SOC_I2S
-+	select SND_SOC_PCM512x_I2C
-+	help
-+	  Say Y or M if you want to add support for Allo DigiOne.
-+
- config SND_BCM2708_SOC_FE_PI_AUDIO
- 	tristate "Support for Fe-Pi-Audio"
- 	depends on SND_BCM2708_SOC_I2S || SND_BCM2835_SOC_I2S
-diff --git a/sound/soc/bcm/Makefile b/sound/soc/bcm/Makefile
-index 72e1620fa4038035804cf3b2a09c6b12e7ae0fe1..53ea8229d7ac2065176983385dd7ba85ee3915ea 100644
---- a/sound/soc/bcm/Makefile
-+++ b/sound/soc/bcm/Makefile
-@@ -34,6 +34,7 @@ snd-soc-dionaudio-loco-v2-objs := dionaudio_loco-v2.o
- snd-soc-allo-boss-dac-objs := allo-boss-dac.o
- snd-soc-allo-piano-dac-objs := allo-piano-dac.o
- snd-soc-allo-piano-dac-plus-objs := allo-piano-dac-plus.o
-+snd-soc-allo-digione-objs := allo-digione.o
- snd-soc-pisound-objs := pisound.o
- snd-soc-fe-pi-audio-objs := fe-pi-audio.o
- 
-@@ -60,5 +61,6 @@ obj-$(CONFIG_SND_BCM2708_SOC_DIONAUDIO_LOCO_V2) += snd-soc-dionaudio-loco-v2.o
- obj-$(CONFIG_SND_BCM2708_SOC_ALLO_BOSS_DAC) += snd-soc-allo-boss-dac.o
- obj-$(CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC) += snd-soc-allo-piano-dac.o
- obj-$(CONFIG_SND_BCM2708_SOC_ALLO_PIANO_DAC_PLUS) += snd-soc-allo-piano-dac-plus.o
-+obj-$(CONFIG_SND_BCM2708_SOC_ALLO_DIGIONE) += snd-soc-allo-digione.o
- obj-$(CONFIG_SND_PISOUND) += snd-soc-pisound.o
- obj-$(CONFIG_SND_BCM2708_SOC_FE_PI_AUDIO) += snd-soc-fe-pi-audio.o
-diff --git a/sound/soc/bcm/allo-digione.c b/sound/soc/bcm/allo-digione.c
-new file mode 100644
-index 0000000000000000000000000000000000000000..e3664e44c699d0102120ecf99e8b780a4505ebad
---- /dev/null
-+++ b/sound/soc/bcm/allo-digione.c
-@@ -0,0 +1,268 @@
-+/*
-+ * ASoC Driver for Allo DigiOne
-+ *
-+ * Author: Baswaraj <jaikumar@cemsolutions.net>
-+ *	   Copyright 2017
-+ * based on code by Daniel Matuschek <info@crazy-audio.com>
-+ * based on code by Florian Meier <florian.meier@koalo.de>
-+ *
-+ * This program is free software; you can redistribute it and/or
-+ * modify it under the terms of the GNU General Public License
-+ * version 2 as published by the Free Software Foundation.
-+ *
-+ * This program is distributed in the hope that it will be useful, but
-+ * WITHOUT ANY WARRANTY; without even the implied warranty of
-+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
-+ * General Public License for more details.
-+ */
-+
-+#include <linux/module.h>
-+#include <linux/platform_device.h>
-+
-+#include <sound/core.h>
-+#include <sound/pcm.h>
-+#include <sound/pcm_params.h>
-+#include <sound/soc.h>
-+#include <sound/jack.h>
-+#include <linux/gpio/consumer.h>
-+
-+#include "../codecs/wm8804.h"
-+
-+static short int auto_shutdown_output = 0;
-+module_param(auto_shutdown_output, short,
-+		S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
-+MODULE_PARM_DESC(auto_shutdown_output, "Shutdown SP/DIF output if playback is stopped");
-+
-+#define CLK_44EN_RATE 22579200UL
-+#define CLK_48EN_RATE 24576000UL
-+
-+static struct gpio_desc *snd_allo_clk44gpio;
-+static struct gpio_desc *snd_allo_clk48gpio;
-+
-+static int samplerate = 44100;
-+
-+static uint32_t snd_allo_digione_enable_clock(int sample_rate)
-+{
-+	switch (sample_rate) {
-+	case 11025:
-+	case 22050:
-+	case 44100:
-+	case 88200:
-+	case 176400:
-+		gpiod_set_value_cansleep(snd_allo_clk44gpio, 1);
-+		gpiod_set_value_cansleep(snd_allo_clk48gpio, 0);
-+		return CLK_44EN_RATE;
-+	default:
-+		gpiod_set_value_cansleep(snd_allo_clk48gpio, 1);
-+		gpiod_set_value_cansleep(snd_allo_clk44gpio, 0);
-+		return CLK_48EN_RATE;
-+	}
-+}
-+
-+
-+static int snd_allo_digione_init(struct snd_soc_pcm_runtime *rtd)
-+{
-+	struct snd_soc_codec *codec = rtd->codec;
-+
-+	/* enable TX output */
-+	snd_soc_update_bits(codec, WM8804_PWRDN, 0x4, 0x0);
-+
-+	return 0;
-+}
-+
-+static int snd_allo_digione_startup(struct snd_pcm_substream *substream)
-+{
-+	/* turn on digital output */
-+	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-+	struct snd_soc_codec *codec = rtd->codec;
-+	snd_soc_update_bits(codec, WM8804_PWRDN, 0x3c, 0x00);
-+	return 0;
-+}
-+
-+static void snd_allo_digione_shutdown(struct snd_pcm_substream *substream)
-+{
-+	/* turn off output */
-+	if (auto_shutdown_output) {
-+		/* turn off output */
-+		struct snd_soc_pcm_runtime *rtd = substream->private_data;
-+		struct snd_soc_codec *codec = rtd->codec;
-+		snd_soc_update_bits(codec, WM8804_PWRDN, 0x3c, 0x3c);
-+	}
-+}
-+
-+static int snd_allo_digione_hw_params(struct snd_pcm_substream *substream,
-+				       struct snd_pcm_hw_params *params)
-+{
-+	struct snd_soc_pcm_runtime *rtd = substream->private_data;
-+	struct snd_soc_dai *codec_dai = rtd->codec_dai;
-+	struct snd_soc_codec *codec = rtd->codec;
-+	struct snd_soc_dai *cpu_dai = rtd->cpu_dai;
-+
-+	int sysclk = 27000000; /* This is fixed on this board */
-+
-+	long mclk_freq = 0;
-+	int mclk_div = 1;
-+	int sampling_freq = 1;
-+
-+	int ret;
-+
-+	samplerate = params_rate(params);
-+
-+	if (samplerate <= 96000) {
-+		mclk_freq = samplerate * 256;
-+		mclk_div = WM8804_MCLKDIV_256FS;
-+	} else {
-+		mclk_freq = samplerate * 128;
-+		mclk_div = WM8804_MCLKDIV_128FS;
-+	}
-+
-+	sysclk = snd_allo_digione_enable_clock(samplerate);
-+	
-+	switch (samplerate) {
-+		case 32000:
-+			sampling_freq=0x03;
-+			break;
-+		case 44100:
-+			sampling_freq=0x00;
-+			break;
-+		case 48000:
-+			sampling_freq=0x02;
-+			break;
-+		case 88200:
-+			sampling_freq=0x08;
-+			break;
-+		case 96000:
-+			sampling_freq=0x0a;
-+			break;
-+		case 176400:
-+			sampling_freq=0x0c;
-+			break;
-+		case 192000:
-+			sampling_freq=0x0e;
-+			break;
-+		default:
-+			dev_err(codec->dev,
-+			"Failed to set WM8804 SYSCLK, unsupported samplerate %d\n",
-+			samplerate);
-+	}
-+
-+	snd_soc_dai_set_clkdiv(codec_dai, WM8804_MCLK_DIV, mclk_div);
-+	snd_soc_dai_set_pll(codec_dai, 0, 0, sysclk, mclk_freq);
-+
-+	ret = snd_soc_dai_set_sysclk(codec_dai, WM8804_TX_CLKSRC_PLL,
-+					sysclk, SND_SOC_CLOCK_OUT);
-+
-+	if (ret < 0) {
-+		dev_err(codec->dev,
-+		"Failed to set WM8804 SYSCLK: %d\n", ret);
-+		return ret;
-+	}
-+
-+	/* Enable TX output */
-+	snd_soc_update_bits(codec, WM8804_PWRDN, 0x4, 0x0);
-+
-+	/* Power on */
-+	snd_soc_update_bits(codec, WM8804_PWRDN, 0x9, 0);
-+
-+	/* set sampling frequency status bits */
-+	snd_soc_update_bits(codec, WM8804_SPDTX4, 0x0f, sampling_freq);
-+
-+	return snd_soc_dai_set_bclk_ratio(cpu_dai, 64);
-+}
-+
-+/* machine stream operations */
-+static struct snd_soc_ops snd_allo_digione_ops = {
-+	.hw_params	= snd_allo_digione_hw_params,
-+        .startup	= snd_allo_digione_startup,
-+        .shutdown	= snd_allo_digione_shutdown,
-+};
-+
-+static struct snd_soc_dai_link snd_allo_digione_dai[] = {
-+{
-+	.name		= "Allo DigiOne",
-+	.stream_name	= "Allo DigiOne HiFi",
-+	.cpu_dai_name	= "bcm2708-i2s.0",
-+	.codec_dai_name	= "wm8804-spdif",
-+	.platform_name	= "bcm2708-i2s.0",
-+	.codec_name	= "wm8804.1-003b",
-+	.dai_fmt	= SND_SOC_DAIFMT_I2S |
-+			  SND_SOC_DAIFMT_NB_NF |
-+			  SND_SOC_DAIFMT_CBM_CFM,
-+	.ops		= &snd_allo_digione_ops,
-+	.init		= snd_allo_digione_init,
-+},
-+};
-+
-+/* audio machine driver */
-+static struct snd_soc_card snd_allo_digione = {
-+	.name         = "snd_allo_digione",
-+	.driver_name  = "AlloDigiOne",
-+	.owner        = THIS_MODULE,
-+	.dai_link     = snd_allo_digione_dai,
-+	.num_links    = ARRAY_SIZE(snd_allo_digione_dai),
-+};
-+
-+static int snd_allo_digione_probe(struct platform_device *pdev)
-+{
-+	int ret = 0;
-+
-+	snd_allo_digione.dev = &pdev->dev;
-+
-+	if (pdev->dev.of_node) {
-+	    struct device_node *i2s_node;
-+	    struct snd_soc_dai_link *dai = &snd_allo_digione_dai[0];
-+	    i2s_node = of_parse_phandle(pdev->dev.of_node,
-+					"i2s-controller", 0);
-+
-+	    if (i2s_node) {
-+		dai->cpu_dai_name = NULL;
-+		dai->cpu_of_node = i2s_node;
-+		dai->platform_name = NULL;
-+		dai->platform_of_node = i2s_node;
-+	    }
-+
-+	    snd_allo_clk44gpio =
-+		devm_gpiod_get(&pdev->dev, "clock44", GPIOD_OUT_LOW);
-+	    if (IS_ERR(snd_allo_clk44gpio))
-+		dev_err(&pdev->dev, "devm_gpiod_get() failed\n");
-+
-+	    snd_allo_clk48gpio =
-+		devm_gpiod_get(&pdev->dev, "clock48", GPIOD_OUT_LOW);
-+	    if (IS_ERR(snd_allo_clk48gpio))
-+		dev_err(&pdev->dev, "devm_gpiod_get() failed\n");
-+	}
-+
-+	ret = snd_soc_register_card(&snd_allo_digione);
-+	if (ret && ret != -EPROBE_DEFER)
-+		dev_err(&pdev->dev, "snd_soc_register_card() failed: %d\n",
-+			ret);
-+
-+	return ret;
-+}
-+
-+static int snd_allo_digione_remove(struct platform_device *pdev)
-+{
-+	return snd_soc_unregister_card(&snd_allo_digione);
-+}
-+
-+static const struct of_device_id snd_allo_digione_of_match[] = {
-+	{ .compatible = "allo,allo-digione", },
-+	{},
-+};
-+MODULE_DEVICE_TABLE(of, snd_allo_digione_of_match);
-+
-+static struct platform_driver snd_allo_digione_driver = {
-+	.driver = {
-+		.name		= "snd-allo-digione",
-+		.owner		= THIS_MODULE,
-+		.of_match_table	= snd_allo_digione_of_match,
-+	},
-+	.probe  = snd_allo_digione_probe,
-+	.remove = snd_allo_digione_remove,
-+};
-+
-+module_platform_driver(snd_allo_digione_driver);
-+
-+MODULE_AUTHOR("Baswaraj <jaikumar@cem-solutions.net>");
-+MODULE_DESCRIPTION("ASoC Driver for Allo DigiOne");
-+MODULE_LICENSE("GPL v2");
-
-From f8b82a9b4a3c6441b44117532d48a136e80ad45e Mon Sep 17 00:00:00 2001
-From: Andrei Gherzan <andrei@gherzan.com>
-Date: Mon, 5 Jun 2017 16:40:38 +0100
-Subject: [PATCH 156/173] dma-bcm2708: Fix module compilation of
- CONFIG_DMA_BCM2708
-
-bcm2708-dmaengine.c defines functions like bcm_dma_start which are
-defined as well in dma-bcm2708.h as inline versions when
-CONFIG_DMA_BCM2708 is not defined. This works fine when
-CONFIG_DMA_BCM2708 is built in, but when it is selected as module build
-fails with redefinition errors because in the build system when
-CONFIG_DMA_BCM2708 is selected as module, the macro becomes
-CONFIG_DMA_BCM2708_MODULE.
-
-This patch makes the header use CONFIG_DMA_BCM2708_MODULE too when
-available.
-
-Fixes https://github.com/raspberrypi/linux/issues/2056
-
-Signed-off-by: Andrei Gherzan <andrei@gherzan.com>
----
- include/linux/platform_data/dma-bcm2708.h | 4 ++--
- 1 file changed, 2 insertions(+), 2 deletions(-)
-
-diff --git a/include/linux/platform_data/dma-bcm2708.h b/include/linux/platform_data/dma-bcm2708.h
-index c5bfff2765be4606077e6c8af73040ec13ee8974..6ca874d332a8bc666b1c9576ac51f479b98de14d 100644
---- a/include/linux/platform_data/dma-bcm2708.h
-+++ b/include/linux/platform_data/dma-bcm2708.h
-@@ -75,7 +75,7 @@ struct bcm2708_dma_cb {
- struct scatterlist;
- struct platform_device;
- 
--#ifdef CONFIG_DMA_BCM2708
-+#if defined(CONFIG_DMA_BCM2708) || defined(CONFIG_DMA_BCM2708_MODULE)
- 
- int bcm_sg_suitable_for_dma(struct scatterlist *sg_ptr, int sg_len);
- void bcm_dma_start(void __iomem *dma_chan_base, dma_addr_t control_block);
-@@ -138,6 +138,6 @@ static inline int bcm_dmaman_remove(struct platform_device *pdev)
- 	return 0;
- }
- 
--#endif /* CONFIG_DMA_BCM2708 */
-+#endif /* CONFIG_DMA_BCM2708 || CONFIG_DMA_BCM2708_MODULE */
- 
- #endif /* _PLAT_BCM2708_DMA_H */
-
-From 80c2c56f8363ee02686636240a31a304da2a15e9 Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Tue, 20 Jun 2017 17:51:47 +0100
-Subject: [PATCH 157/173] bcm2835-cpufreq: Change licence to GPLv2
-
-Signed-off-by: Eben Upton <eben.upton@broadcom.com>
-Signed-off-by: Dom Cobley <dom@raspberrypi.com>
----
- drivers/cpufreq/bcm2835-cpufreq.c | 36 ++++++++++++++----------------------
- 1 file changed, 14 insertions(+), 22 deletions(-)
-
-diff --git a/drivers/cpufreq/bcm2835-cpufreq.c b/drivers/cpufreq/bcm2835-cpufreq.c
-index 414fbdc10dfbfc6e4bb47870a7af3fd5780f9c9a..99345969b0e4d651fd9033d67de2febb13fc0892 100644
---- a/drivers/cpufreq/bcm2835-cpufreq.c
-+++ b/drivers/cpufreq/bcm2835-cpufreq.c
-@@ -1,25 +1,17 @@
--/*****************************************************************************
--* Copyright 2011 Broadcom Corporation.  All rights reserved.
--*
--* Unless you and Broadcom execute a separate written software license
--* agreement governing use of this software, this software is licensed to you
--* under the terms of the GNU General Public License version 2, available at
--* http://www.broadcom.com/licenses/GPLv2.php (the "GPL").
--*
--* Notwithstanding the above, under no circumstances may you combine this
--* software in any way with any other Broadcom software provided under a
--* license other than the GPL, without Broadcom's express prior written
--* consent.
--*****************************************************************************/
--
--/*****************************************************************************
--* FILENAME: bcm2835-cpufreq.h
--* DESCRIPTION: This driver dynamically manages the CPU Frequency of the ARM
--* processor. Messages are sent to Videocore either setting or requesting the
--* frequency of the ARM in order to match an appropiate frequency to the current
--* usage of the processor. The policy which selects the frequency to use is
--* defined in the kernel .config file, but can be changed during runtime.
--*****************************************************************************/
-+/*
-+ * Copyright 2011 Broadcom Corporation.
-+ *
-+ * This program is free software; you can redistribute it and/or
-+ * modify it under the terms of the GNU General Public License
-+ * as published by the Free Software Foundation; version 2
-+ * of the License.
-+ *
-+ * This driver dynamically manages the CPU Frequency of the ARM
-+ * processor. Messages are sent to Videocore either setting or requesting the
-+ * frequency of the ARM in order to match an appropiate frequency to the current
-+ * usage of the processor. The policy which selects the frequency to use is
-+ * defined in the kernel .config file, but can be changed during runtime.
-+ */
- 
- /* ---------- INCLUDES ---------- */
- #include <linux/kernel.h>
-
-From e94077bd011f60fc34f14a722f088d9842102162 Mon Sep 17 00:00:00 2001
-From: Eric Anholt <eric@anholt.net>
-Date: Wed, 21 Jun 2017 09:03:51 -0700
-Subject: [PATCH 158/173] bcm2708: Drop CMA alignment from FKMS mode as well.
-
-I dropped it from KMS mode in d88274d88ed81de1ade8e18e4c0ed91792ec82ea
-and should have done both of them at that time.
-
-Signed-off-by: Eric Anholt <eric@anholt.net>
----
- arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts | 10 +++++-----
- 1 file changed, 5 insertions(+), 5 deletions(-)
-
-diff --git a/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts b/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts
-index 95a595a35cb4fbb707bf4b18161f6a46860aa4ae..36fbf6c8c2e612a6dc5aa02d77cc8173098c16ca 100644
---- a/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts
-+++ b/arch/arm/boot/dts/overlays/vc4-fkms-v3d-overlay.dts
-@@ -11,35 +11,35 @@
- 	fragment@0 {
- 		target-path = "/chosen";
- 		__overlay__ {
--			bootargs = "cma=256M@256M";
-+			bootargs = "cma=256M";
- 		};
- 	};
- 
- 	fragment@1 {
- 		target-path = "/chosen";
- 		__dormant__ {
--			bootargs = "cma=192M@256M";
-+			bootargs = "cma=192M";
- 		};
- 	};
- 
- 	fragment@2 {
- 		target-path = "/chosen";
- 		__dormant__ {
--			bootargs = "cma=128M@128M";
-+			bootargs = "cma=128M";
- 		};
- 	};
- 
- 	fragment@3 {
- 		target-path = "/chosen";
- 		__dormant__ {
--			bootargs = "cma=96M@128M";
-+			bootargs = "cma=96M";
- 		};
- 	};
- 
- 	fragment@4 {
- 		target-path = "/chosen";
- 		__dormant__ {
--			bootargs = "cma=64M@64M";
-+			bootargs = "cma=64M";
- 		};
- 	};
- 
-
-From fc3cb5a0158c0a950571fe0d7612558f5385ce2f Mon Sep 17 00:00:00 2001
-From: Steve Conner <connermcsteve@gmail.com>
-Date: Thu, 29 Jun 2017 15:56:19 +0100
-Subject: [PATCH 159/173] New i2c-rtc-gpio device overlay (#2092)
-
-Created new i2c-rtc-gpio device overlay by combining i2c-rtc and i2c-gpio. Tested with PCF2127 on CM3.
----
- arch/arm/boot/dts/overlays/Makefile                |   1 +
- arch/arm/boot/dts/overlays/README                  |  41 +++++
- .../arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts | 183 +++++++++++++++++++++
- 3 files changed, 225 insertions(+)
- create mode 100644 arch/arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts
-
-diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
-index eca81982c0f19988abd05165fc62a80d26f539cb..8a3131f5a4bc90d4a597b416416953e8e49d41ec 100644
---- a/arch/arm/boot/dts/overlays/Makefile
-+++ b/arch/arm/boot/dts/overlays/Makefile
-@@ -42,6 +42,7 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
- 	i2c-mux.dtbo \
- 	i2c-pwm-pca9685a.dtbo \
- 	i2c-rtc.dtbo \
-+	i2c-rtc-gpio.dtbo \
- 	i2c-sensor.dtbo \
- 	i2c0-bcm2708.dtbo \
- 	i2c1-bcm2708.dtbo \
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index 19df6883be4277240283d5f63f27e34a22a2eec5..a69e3a0d8dce1633598dd3cd8e00cad9509eee03 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -662,6 +662,47 @@ Params: abx80x                  Select one of the ABx80x family:
-                                 source
- 
- 
-+Name:   i2c-rtc-gpio
-+Info:   Adds support for a number of I2C Real Time Clock devices
-+        using the software i2c controller
-+Load:   dtoverlay=i2c-rtc-gpio,<param>=<val>
-+Params: abx80x                  Select one of the ABx80x family:
-+                                  AB0801, AB0803, AB0804, AB0805,
-+                                  AB1801, AB1803, AB1804, AB1805
-+
-+        ds1307                  Select the DS1307 device
-+
-+        ds1339                  Select the DS1339 device
-+
-+        ds3231                  Select the DS3231 device
-+
-+        mcp7940x                Select the MCP7940x device
-+
-+        mcp7941x                Select the MCP7941x device
-+
-+        pcf2127                 Select the PCF2127 device
-+
-+        pcf8523                 Select the PCF8523 device
-+
-+        pcf8563                 Select the PCF8563 device
-+
-+        trickle-diode-type      Diode type for trickle charge - "standard" or
-+                                "schottky" (ABx80x only)
-+
-+        trickle-resistor-ohms   Resistor value for trickle charge (DS1339,
-+                                ABx80x)
-+
-+        wakeup-source           Specify that the RTC can be used as a wakeup
-+                                source
-+
-+        i2c_gpio_sda            GPIO used for I2C data (default "23")
-+
-+        i2c_gpio_scl            GPIO used for I2C clock (default "24")
-+
-+        i2c_gpio_delay_us       Clock delay in microseconds
-+                                (default "2" = ~100kHz)
-+
-+
- Name:   i2c-sensor
- Info:   Adds support for a number of I2C barometric pressure and temperature
-         sensors on i2c_arm
-diff --git a/arch/arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts b/arch/arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts
-new file mode 100644
-index 0000000000000000000000000000000000000000..8415e6081428fba9a47682964174fc023cfd2b0c
---- /dev/null
-+++ b/arch/arm/boot/dts/overlays/i2c-rtc-gpio-overlay.dts
-@@ -0,0 +1,183 @@
-+// Definitions for several I2C based Real Time Clocks
-+// Available through i2c-gpio
-+/dts-v1/;
-+/plugin/;
-+
-+/ {
-+	compatible = "brcm,bcm2708";
-+
-+	fragment@0 {
-+		target-path = "/";
-+		__overlay__ {
-+			i2c_gpio: i2c-gpio-rtc@0 {
-+				compatible = "i2c-gpio";
-+				gpios = <&gpio 23 0 /* sda */
-+					 &gpio 24 0 /* scl */
-+					>;
-+				i2c-gpio,delay-us = <2>;        /* ~100 kHz */
-+				#address-cells = <1>;
-+				#size-cells = <0>;
-+			};
-+		};
-+	};
-+
-+	fragment@1 {
-+		target = <&i2c_gpio>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			abx80x: abx80x@69 {
-+				compatible = "abracon,abx80x";
-+				reg = <0x69>;
-+				abracon,tc-diode = "standard";
-+				abracon,tc-resistor = <0>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@2 {
-+		target = <&i2c_gpio>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			ds1307: ds1307@68 {
-+				compatible = "maxim,ds1307";
-+				reg = <0x68>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@3 {
-+		target = <&i2c_gpio>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			ds1339: ds1339@68 {
-+				compatible = "dallas,ds1339";
-+				trickle-resistor-ohms = <0>;
-+				reg = <0x68>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@4 {
-+		target = <&i2c_gpio>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			ds3231: ds3231@68 {
-+				compatible = "maxim,ds3231";
-+				reg = <0x68>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@5 {
-+		target = <&i2c_gpio>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			mcp7940x: mcp7940x@6f {
-+				compatible = "microchip,mcp7940x";
-+				reg = <0x6f>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@6 {
-+		target = <&i2c_gpio>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			mcp7941x: mcp7941x@6f {
-+				compatible = "microchip,mcp7941x";
-+				reg = <0x6f>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@7 {
-+		target = <&i2c_gpio>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			pcf2127: pcf2127@51 {
-+				compatible = "nxp,pcf2127";
-+				reg = <0x51>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@8 {
-+		target = <&i2c_gpio>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			pcf8523: pcf8523@68 {
-+				compatible = "nxp,pcf8523";
-+				reg = <0x68>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	fragment@9 {
-+		target = <&i2c_gpio>;
-+		__dormant__ {
-+			#address-cells = <1>;
-+			#size-cells = <0>;
-+			status = "okay";
-+
-+			pcf8563: pcf8563@51 {
-+				compatible = "nxp,pcf8563";
-+				reg = <0x51>;
-+				status = "okay";
-+			};
-+		};
-+	};
-+
-+	__overrides__ {
-+		abx80x = <0>,"+1";
-+		ds1307 = <0>,"+2";
-+		ds1339 = <0>,"+3";
-+		ds3231 = <0>,"+4";
-+		mcp7940x = <0>,"+5";
-+		mcp7941x = <0>,"+6";
-+		pcf2127 = <0>,"+7";
-+		pcf8523 = <0>,"+8";
-+		pcf8563 = <0>,"+9";
-+		trickle-diode-type = <&abx80x>,"abracon,tc-diode";
-+		trickle-resistor-ohms = <&ds1339>,"trickle-resistor-ohms:0",
-+					<&abx80x>,"abracon,tc-resistor";
-+		wakeup-source = <&ds1339>,"wakeup-source?",
-+				<&ds3231>,"wakeup-source?",
-+				<&mcp7940x>,"wakeup-source?",
-+					<&mcp7941x>,"wakeup-source?";
-+		i2c_gpio_sda = <&i2c_gpio>,"gpios:4";
-+		i2c_gpio_scl = <&i2c_gpio>,"gpios:16";
-+		i2c_gpio_delay_us = <&i2c_gpio>,"i2c-gpio,delay-us:0";
-+	};
-+};
-
-From 8764e8f87f6ee8a31c0ee25485b48e61797c6b8a Mon Sep 17 00:00:00 2001
-From: Allo <sparky-dev@allo.com>
-Date: Mon, 3 Jul 2017 15:45:20 +0530
-Subject: [PATCH 160/173] PianoPlus: Dual Mono & Dual Stereo features added
- (#2069)
-
----
- sound/soc/bcm/allo-piano-dac-plus.c | 160 +++++++++++++++++++++++++++++++-----
- 1 file changed, 141 insertions(+), 19 deletions(-)
-
-diff --git a/sound/soc/bcm/allo-piano-dac-plus.c b/sound/soc/bcm/allo-piano-dac-plus.c
-index 56e43f98846b41e487b3089813f7edc3c08517eb..d4e99e3c6a383d92fb0cf9e8c1cd1e7657358d49 100644
---- a/sound/soc/bcm/allo-piano-dac-plus.c
-+++ b/sound/soc/bcm/allo-piano-dac-plus.c
-@@ -36,6 +36,7 @@ struct dsp_code {
- 
- struct glb_pool {
- 	struct mutex lock;
-+	unsigned int dual_mode;
- 	unsigned int set_lowpass;
- 	unsigned int set_mode;
- 	unsigned int set_rate;
-@@ -47,8 +48,8 @@ bool glb_mclk;
- 
- static struct gpio_desc *mute_gpio[2];
- 
--
- static const char * const allo_piano_mode_texts[] = {
-+	"None",
- 	"2.0",
- 	"2.1",
- 	"2.2",
-@@ -57,6 +58,15 @@ static const char * const allo_piano_mode_texts[] = {
- static const SOC_ENUM_SINGLE_DECL(allo_piano_mode_enum,
- 		0, 0, allo_piano_mode_texts);
- 
-+static const char * const allo_piano_dual_mode_texts[] = {
-+	"None",
-+	"Dual-Mono",
-+	"Dual-Stereo",
-+};
-+
-+static const SOC_ENUM_SINGLE_DECL(allo_piano_dual_mode_enum,
-+		0, 0, allo_piano_dual_mode_texts);
-+
- static const char * const allo_piano_dsp_low_pass_texts[] = {
- 	"60",
- 	"70",
-@@ -82,10 +92,10 @@ static int __snd_allo_piano_dsp_program(struct snd_soc_pcm_runtime *rtd,
- 		unsigned int mode, unsigned int rate, unsigned int lowpass)
- {
- 	const struct firmware *fw;
--	char firmware_name[60];
--	int ret = 0, dac = 0;
- 	struct snd_soc_card *card = rtd->card;
- 	struct glb_pool *glb_ptr = card->drvdata;
-+	char firmware_name[60];
-+	int ret = 0, dac = 0;
- 
- 	if (rate <= 46000)
- 		rate = 44100;
-@@ -100,26 +110,35 @@ static int __snd_allo_piano_dsp_program(struct snd_soc_pcm_runtime *rtd,
- 	else
- 		rate = 192000;
- 
--	if ((lowpass > 14) || (lowpass < 0))
--		lowpass = 3;
--	if ((mode > 2) || (mode < 0))
--		mode = 0;
-+	if (lowpass > 14)
-+		glb_ptr->set_lowpass = lowpass = 3;
-+
-+	if (mode > 3)
-+		glb_ptr->set_mode = mode = 0;
-+
-+	if (mode > 0)
-+		glb_ptr->dual_mode = 0;
- 
- 	/* same configuration loaded */
- 	if ((rate == glb_ptr->set_rate) && (lowpass == glb_ptr->set_lowpass)
- 			&& (mode == glb_ptr->set_mode))
- 		return 0;
- 
--	if (mode == 0) { /* 2.0 */
--		snd_soc_write(rtd->codec_dais[1]->codec,
--				PCM512x_MUTE, 0x11);
-+	switch (mode) {
-+	case 0: /* None */
-+		return 1;
-+
-+	case 1: /* 2.0 */
-+		snd_soc_write(rtd->codec_dais[0]->codec, PCM512x_MUTE, 0x00);
-+		snd_soc_write(rtd->codec_dais[1]->codec, PCM512x_MUTE, 0x11);
- 		glb_ptr->set_rate = rate;
- 		glb_ptr->set_mode = mode;
- 		glb_ptr->set_lowpass = lowpass;
- 		return 1;
--	} else {
--		snd_soc_write(rtd->codec_dais[1]->codec,
--				PCM512x_MUTE, 0x00);
-+
-+	default:
-+		snd_soc_write(rtd->codec_dais[0]->codec, PCM512x_MUTE, 0x00);
-+		snd_soc_write(rtd->codec_dais[1]->codec, PCM512x_MUTE, 0x00);
- 	}
- 
- 	for (dac = 0; dac < rtd->num_codecs; dac++) {
-@@ -128,13 +147,13 @@ static int __snd_allo_piano_dsp_program(struct snd_soc_pcm_runtime *rtd,
- 		int i = 1;
- 
- 		if (dac == 0) { /* high */
--			sprintf(firmware_name,
-+			snprintf(firmware_name, sizeof(firmware_name),
- 				"allo/piano/2.2/allo-piano-dsp-%d-%d-%d.bin",
- 				rate, ((lowpass * 10) + 60), dac);
- 		} else { /* low */
--			sprintf(firmware_name,
-+			snprintf(firmware_name, sizeof(firmware_name),
- 				"allo/piano/2.%d/allo-piano-dsp-%d-%d-%d.bin",
--				mode, rate, ((lowpass * 10) + 60), dac);
-+				(mode - 1), rate, ((lowpass * 10) + 60), dac);
- 		}
- 
- 		dev_info(codec->dev, "Dsp Firmware File Name: %s\n",
-@@ -199,6 +218,80 @@ static int snd_allo_piano_dsp_program(struct snd_soc_pcm_runtime *rtd,
- 	return ret;
- }
- 
-+static int snd_allo_piano_dual_mode_get(struct snd_kcontrol *kcontrol,
-+		struct snd_ctl_elem_value *ucontrol)
-+{
-+	struct snd_soc_card *card = snd_kcontrol_chip(kcontrol);
-+	struct glb_pool *glb_ptr = card->drvdata;
-+
-+	ucontrol->value.integer.value[0] = glb_ptr->dual_mode;
-+
-+	return 0;
-+}
-+
-+static int snd_allo_piano_dual_mode_put(struct snd_kcontrol *kcontrol,
-+		struct snd_ctl_elem_value *ucontrol)
-+{
-+	struct snd_soc_card *card = snd_kcontrol_chip(kcontrol);
-+	struct glb_pool *glb_ptr = card->drvdata;
-+	struct snd_soc_pcm_runtime *rtd;
-+	struct snd_card *snd_card_ptr = card->snd_card;
-+	struct snd_kcontrol *kctl;
-+	struct soc_mixer_control *mc;
-+	unsigned int left_val = 0;
-+
-+	rtd = snd_soc_get_pcm_runtime(card, card->dai_link[0].name);
-+
-+	if (ucontrol->value.integer.value[0] > 0) {
-+		glb_ptr->dual_mode = ucontrol->value.integer.value[0];
-+		glb_ptr->set_mode = 0;
-+	} else if (ucontrol->value.integer.value[0] <= 0) {
-+		if (glb_ptr->set_mode <= 0) {
-+			glb_ptr->dual_mode = 1;
-+			glb_ptr->set_mode = 0;
-+		}
-+	} else {
-+		glb_ptr->dual_mode = 0;
-+		return 0;
-+	}
-+
-+	if (glb_ptr->dual_mode == 1) {
-+		snd_soc_write(rtd->codec_dais[0]->codec, PCM512x_MUTE, 0x01);
-+		snd_soc_write(rtd->codec_dais[1]->codec, PCM512x_MUTE, 0x10);
-+		snd_soc_write(rtd->codec_dais[0]->codec,
-+				PCM512x_DIGITAL_VOLUME_3, 0xff);
-+
-+		list_for_each_entry(kctl, &snd_card_ptr->controls, list) {
-+			if (!strncmp(kctl->id.name, "Digital Playback Volume",
-+					sizeof(kctl->id.name))) {
-+				mc = (struct soc_mixer_control *)
-+					kctl->private_value;
-+				mc->rreg = mc->reg;
-+				break;
-+			}
-+		}
-+	} else {
-+		left_val = snd_soc_read(rtd->codec_dais[0]->codec,
-+						PCM512x_DIGITAL_VOLUME_2);
-+		list_for_each_entry(kctl, &snd_card_ptr->controls, list) {
-+			if (!strncmp(kctl->id.name, "Digital Playback Volume",
-+					sizeof(kctl->id.name))) {
-+				mc = (struct soc_mixer_control *)
-+					kctl->private_value;
-+				mc->rreg = PCM512x_DIGITAL_VOLUME_3;
-+				break;
-+			}
-+		}
-+
-+		snd_soc_write(rtd->codec_dais[0]->codec,
-+				PCM512x_DIGITAL_VOLUME_3, left_val);
-+		snd_soc_write(rtd->codec_dais[0]->codec, PCM512x_MUTE, 0x00);
-+		snd_soc_write(rtd->codec_dais[1]->codec, PCM512x_MUTE, 0x00);
-+	}
-+
-+	return 0;
-+}
-+
- static int snd_allo_piano_mode_get(struct snd_kcontrol *kcontrol,
- 		struct snd_ctl_elem_value *ucontrol)
- {
-@@ -215,8 +308,30 @@ static int snd_allo_piano_mode_put(struct snd_kcontrol *kcontrol,
- 	struct snd_soc_card *card = snd_kcontrol_chip(kcontrol);
- 	struct snd_soc_pcm_runtime *rtd;
- 	struct glb_pool *glb_ptr = card->drvdata;
-+	struct snd_card *snd_card_ptr = card->snd_card;
-+	struct snd_kcontrol *kctl;
-+	struct soc_mixer_control *mc;
-+	unsigned int left_val = 0;
- 
- 	rtd = snd_soc_get_pcm_runtime(card, card->dai_link[0].name);
-+
-+	if ((glb_ptr->dual_mode == 1) &&
-+			(ucontrol->value.integer.value[0] > 0)) {
-+		left_val = snd_soc_read(rtd->codec_dais[0]->codec,
-+						PCM512x_DIGITAL_VOLUME_2);
-+		list_for_each_entry(kctl, &snd_card_ptr->controls, list) {
-+			if (!strncmp(kctl->id.name, "Digital Playback Volume",
-+					sizeof(kctl->id.name))) {
-+				mc = (struct soc_mixer_control *)
-+					kctl->private_value;
-+				mc->rreg = PCM512x_DIGITAL_VOLUME_3;
-+				break;
-+			}
-+		}
-+		snd_soc_write(rtd->codec_dais[0]->codec,
-+				PCM512x_DIGITAL_VOLUME_3, left_val);
-+	}
-+
- 	return(snd_allo_piano_dsp_program(rtd,
- 				ucontrol->value.integer.value[0],
- 				glb_ptr->set_rate, glb_ptr->set_lowpass));
-@@ -344,6 +459,11 @@ static const struct snd_kcontrol_new allo_piano_controls[] = {
- 			snd_allo_piano_mode_get,
- 			snd_allo_piano_mode_put),
- 
-+	SOC_ENUM_EXT("Dual Mode Route",
-+			allo_piano_dual_mode_enum,
-+			snd_allo_piano_dual_mode_get,
-+			snd_allo_piano_dual_mode_put),
-+
- 	SOC_ENUM_EXT("Lowpass Route", allo_piano_enum,
- 			snd_allo_piano_lowpass_get,
- 			snd_allo_piano_lowpass_put),
-@@ -472,7 +592,7 @@ static int snd_allo_piano_dac_hw_params(
- 					PCM512x_RATE_DET_4);
- 		if (val < 0) {
- 			dev_err(rtd->codec_dais[dac]->codec->dev,
--					"Failed to read register PCM512x_RATE_DET_4\n");
-+				"Failed to read register PCM512x_RATE_DET_4\n");
- 			return val;
- 		}
- 
-@@ -482,7 +602,7 @@ static int snd_allo_piano_dac_hw_params(
- 					PCM512x_SREF_BCK);
- 
- 			dev_info(rtd->codec_dais[dac]->codec->dev,
--					"Setting BCLK as input clock & Enable PLL\n");
-+				"Setting BCLK as input clock & Enable PLL\n");
- 		} else {
- 			snd_soc_write(rtd->codec_dais[dac]->codec,
- 					PCM512x_PLL_EN,
-@@ -493,7 +613,7 @@ static int snd_allo_piano_dac_hw_params(
- 					PCM512x_SREF_SCK);
- 
- 			dev_info(rtd->codec_dais[dac]->codec->dev,
--					"Setting SCLK as input clock & disabled PLL\n");
-+				"Setting SCLK as input clock & disabled PLL\n");
- 		}
- 	}
- 
-@@ -504,6 +624,7 @@ static int snd_allo_piano_dac_hw_params(
- 			dev_warn(card->dev, "Failed to set volume limit: %d\n",
- 				ret);
- 	}
-+
- 	ret = snd_allo_piano_dsp_program(rtd, glb_ptr->set_mode, rate,
- 						glb_ptr->set_lowpass);
- 	if (ret < 0)
-@@ -521,6 +642,7 @@ static int snd_allo_piano_dac_prepare(
- 	struct snd_soc_card *card = rtd->card;
- 
- 	snd_allo_piano_gpio_unmute(card);
-+
- 	return 0;
- }
- 
-
-From d5506bfa946eb2799dd9ffb8b904ff801651ffb7 Mon Sep 17 00:00:00 2001
-From: Matthijs Kooijman <matthijs@stdin.nl>
-Date: Sun, 9 Jul 2017 15:15:22 +0200
-Subject: [PATCH 161/173] overlays: Add gpio-shutdown overlay (#2103)
-
-This overlay facilitates the addition of a powerbutton by converting
-GPIO edges into KEY_POWER keypresses, which can be handled by
-systemd-logind to shut down the system.
-
-Signed-off-by: Matthijs Kooijman <matthijs@stdin.nl>
----
- arch/arm/boot/dts/overlays/Makefile                |  1 +
- arch/arm/boot/dts/overlays/README                  | 32 +++++++++
- .../boot/dts/overlays/gpio-shutdown-overlay.dts    | 80 ++++++++++++++++++++++
- 3 files changed, 113 insertions(+)
- create mode 100644 arch/arm/boot/dts/overlays/gpio-shutdown-overlay.dts
-
-diff --git a/arch/arm/boot/dts/overlays/Makefile b/arch/arm/boot/dts/overlays/Makefile
-index 8a3131f5a4bc90d4a597b416416953e8e49d41ec..c50b1dfa9d7334df47ce087f9d2a7a816afa05ba 100644
---- a/arch/arm/boot/dts/overlays/Makefile
-+++ b/arch/arm/boot/dts/overlays/Makefile
-@@ -30,6 +30,7 @@ dtbo-$(CONFIG_ARCH_BCM2835) += \
- 	googlevoicehat-soundcard.dtbo \
- 	gpio-ir.dtbo \
- 	gpio-poweroff.dtbo \
-+	gpio-shutdown.dtbo \
- 	hifiberry-amp.dtbo \
- 	hifiberry-dac.dtbo \
- 	hifiberry-dacplus.dtbo \
-diff --git a/arch/arm/boot/dts/overlays/README b/arch/arm/boot/dts/overlays/README
-index a69e3a0d8dce1633598dd3cd8e00cad9509eee03..e6d777a601c91d192bc5713f9a73e1a2d4d708ef 100644
---- a/arch/arm/boot/dts/overlays/README
-+++ b/arch/arm/boot/dts/overlays/README
-@@ -508,6 +508,38 @@ Params: gpiopin                 GPIO for signalling (default 26)
-                                 will also cause the pin to go low.
- 
- 
-+Name:   gpio-shutdown
-+Info:   Initiates a shutdown when GPIO pin changes. The given GPIO pin
-+        is configured as an input key that generates KEY_POWER events.
-+        This event is handled by systemd-logind by initiating a
-+        shutdown. Systemd versions older than 225 need an udev rule
-+        enable listening to the input device:
-+
-+                ACTION!="REMOVE", SUBSYSTEM=="input", KERNEL=="event*", \
-+                        SUBSYSTEMS=="platform", DRIVERS=="gpio-keys", \
-+                        ATTRS{keys}=="116", TAG+="power-switch"
-+
-+        This overlay only handles shutdown. After shutdown, the system
-+        can be powered up again by driving GPIO3 low. The default
-+        configuration uses GPIO3 with a pullup, so if you connect a
-+        button between GPIO3 and GND (pin 5 and 6 on the 40-pin header),
-+        you get a shutdown and power-up button.
-+Load:   dtoverlay=gpio-shutdown,<param>=<val>
-+Params: gpio_pin                GPIO pin to trigger on (default 3)
-+
-+        active_low              When this is 1 (active low), a falling
-+                                edge generates a key down event and a
-+                                rising edge generates a key up event.
-+                                When this is 0 (active high), this is
-+                                reversed. The default is 1 (active low).
-+
-+        gpio_pull               Desired pull-up/down state (off, down, up)
-+                                Default is "up".
-+
-+                                Note that the default pin (GPIO3) has an
-+                                external pullup.
-+
-+
- Name:   hifiberry-amp
- Info:   Configures the HifiBerry Amp and Amp+ audio cards
- Load:   dtoverlay=hifiberry-amp
-diff --git a/arch/arm/boot/dts/overlays/gpio-shutdown-overlay.dts b/arch/arm/boot/dts/overlays/gpio-shutdown-overlay.dts
-new file mode 100644
-index 0000000000000000000000000000000000000000..863fb395c8539734b658682b900e1fbd96c9443e
---- /dev/null
-+++ b/arch/arm/boot/dts/overlays/gpio-shutdown-overlay.dts
-@@ -0,0 +1,80 @@
-+// Definitions for gpio-poweroff module
-+/dts-v1/;
-+/plugin/;
-+
-+// This overlay sets up an input device that generates KEY_POWER events
-+// when a given GPIO pin changes. It defaults to using GPIO3, which can
-+// also be used to wake up (start) the Rpi again after shutdown. Since
-+// wakeup is active-low, this defaults to active-low with a pullup
-+// enabled, but all of this can be changed using overlay parameters (but
-+// note that GPIO3 has an external pullup on at least some boards).
-+
-+/ {
-+	compatible = "brcm,bcm2708";
-+
-+	fragment@0 {
-+		// Configure the gpio pin controller
-+		target = <&gpio>;
-+		__overlay__ {
-+			// Define a pinctrl state, that sets up the gpio
-+			// as an input with a pullup enabled. This does
-+			// not take effect by itself, only when referenced
-+			// by a "pinctrl client", as is done below. See:
-+			//   https://www.kernel.org/doc/Documentation/devicetree/bindings/pinctrl/pinctrl-bindings.txt
-+			//   https://www.kernel.org/doc/Documentation/devicetree/bindings/pinctrl/brcm,bcm2835-gpio.txt
-+			pin_state: shutdown_button_pins {
-+				brcm,pins = <3>; // gpio number
-+				brcm,function = <0>; // 0 = input, 1 = output
-+				brcm,pull = <2>; // 0 = none, 1 = pull down, 2 = pull up
-+			};
-+		};
-+	};
-+	fragment@1 {
-+		// Add a new device to the /soc devicetree node
-+		target-path = "/soc";
-+		__overlay__ {
-+			shutdown_button {
-+				// Let the gpio-keys driver handle this device. See:
-+				// https://www.kernel.org/doc/Documentation/devicetree/bindings/input/gpio-keys.txt
-+				compatible = "gpio-keys";
-+
-+				// Declare a single pinctrl state (referencing the one declared above) and name it
-+				// default, so it is activated automatically.
-+				pinctrl-names = "default";
-+				pinctrl-0 = <&pin_state>;
-+
-+				// Enable this device
-+				status = "okay";
-+
-+				// Define a single key, called "shutdown" that monitors the gpio and sends KEY_POWER
-+				// (keycode 116, see
-+				// https://github.com/torvalds/linux/blob/v4.12/include/uapi/linux/input-event-codes.h#L190)
-+				button: shutdown {
-+					label = "shutdown";
-+					linux,code = <116>; // KEY_POWER
-+					gpios = <&gpio 3 1>;
-+				};
-+			};
-+		};
-+	};
-+
-+	// This defines parameters that can be specified when loading
-+	// the overlay. Each foo = line specifies one parameter, named
-+	// foo. The rest of the specification gives properties where the
-+	// parameter value is inserted into (changing the values above
-+	// or adding new ones).
-+	__overrides__ {
-+		// Allow overriding the GPIO number.
-+		gpio_pin = <&button>,"gpios:4",
-+		           <&pin_state>,"brcm,pins:0";
-+
-+		// Allow changing the internal pullup/down state. 0 = none, 1 = pulldown, 2 = pullup
-+		// Note that GPIO3 and GPIO2 are the I2c pins and have an external pullup (at least
-+                // on some boards).
-+		gpio_pull = <&pin_state>,"brcm,pull:0";
-+
-+		// Allow setting the active_low flag. 0 = active high, 1 = active low
-+		active_low = <&button>,"gpios:8";
-+	};
-+
-+};
-
-From a1cc7e0ae96efd623d7d54ba1d55fa213fb9c8c2 Mon Sep 17 00:00:00 2001
-From: Matthias Reichl <github@hias.horus.com>
-Date: Mon, 10 Jul 2017 11:05:17 +0200
-Subject: [PATCH 162/173] config: enable generic S/PDIF codec drivers (#2104)
-
-These drivers can be used as dummy ADC/DAC drivers for
-attaching general codecs that don't need to be configured.
-
-This option will build 2 additional drivers, spdif_receiver
-and spdif_transmitter.
-
-Since these drivers have DT bindings they are handy for quick
-testing of I2S peripherals with simple-audio-card.
-
-eg:
-
-fragment@0 {
-    target-path = "/";
-    __overlay__ {
-        dummy_receiver: spdif-receiver {
-            #address-cells = <0>;
-            #size-cells = <0>;
-            #sound-dai-cells = <0>;
-            compatible = "linux,spdif-dir";
-            status = "okay";
-        };
-    };
-};
-
-Signed-off-by: Matthias Reichl <hias@horus.com>
----
- arch/arm/configs/bcm2709_defconfig | 1 +
- arch/arm/configs/bcmrpi_defconfig  | 1 +
- 2 files changed, 2 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index d2838cde4019be5f6faf0a70038c6365df9e6dde..6f49e2b69f0cb27154dd26eba20eabdde2d60052 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -898,6 +898,7 @@ CONFIG_SND_PISOUND=m
- CONFIG_SND_SOC_ADAU1701=m
- CONFIG_SND_SOC_ADAU7002=m
- CONFIG_SND_SOC_AK4554=m
-+CONFIG_SND_SOC_SPDIF=m
- CONFIG_SND_SOC_WM8804_I2C=m
- CONFIG_SND_SIMPLE_CARD=m
- CONFIG_HIDRAW=y
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index efdb0fbc1b07c7b679cb20d8c1270c77d5d3c684..472a330439a19ac5d4f70c22059f015816823694 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -891,6 +891,7 @@ CONFIG_SND_PISOUND=m
- CONFIG_SND_SOC_ADAU1701=m
- CONFIG_SND_SOC_ADAU7002=m
- CONFIG_SND_SOC_AK4554=m
-+CONFIG_SND_SOC_SPDIF=m
- CONFIG_SND_SOC_WM8804_I2C=m
- CONFIG_SND_SIMPLE_CARD=m
- CONFIG_HIDRAW=y
-
-From bba1b7cbb27a7284d6733d26a4d2e704d7f5f5d6 Mon Sep 17 00:00:00 2001
-From: Bilal Amarni <bamarni@users.noreply.github.com>
-Date: Wed, 24 May 2017 10:52:50 +0200
-Subject: [PATCH 163/173] [ARM64] enable drivers for GPIO expander and vcio
-
----
- arch/arm64/configs/bcmrpi3_defconfig | 3 +++
- 1 file changed, 3 insertions(+)
-
-diff --git a/arch/arm64/configs/bcmrpi3_defconfig b/arch/arm64/configs/bcmrpi3_defconfig
-index 4d85c231c5ea0244e1b05fb4a5e3c8fd3e651ddf..9dcb58a519d041fadae99c81a7bda621b2a49f12 100644
---- a/arch/arm64/configs/bcmrpi3_defconfig
-+++ b/arch/arm64/configs/bcmrpi3_defconfig
-@@ -575,6 +575,8 @@ CONFIG_SERIO_RAW=m
- CONFIG_GAMEPORT=m
- CONFIG_GAMEPORT_NS558=m
- CONFIG_GAMEPORT_L4=m
-+CONFIG_BRCM_CHAR_DRIVERS=y
-+CONFIG_BCM_VCIO=y
- # CONFIG_BCM2835_DEVGPIOMEM is not set
- # CONFIG_BCM2835_SMI_DEV is not set
- # CONFIG_LEGACY_PTYS is not set
-@@ -609,6 +611,7 @@ CONFIG_PPS=m
- CONFIG_PPS_CLIENT_LDISC=m
- CONFIG_PPS_CLIENT_GPIO=m
- CONFIG_GPIO_SYSFS=y
-+CONFIG_GPIO_BCM_EXP=y
- CONFIG_GPIO_BCM_VIRT=y
- CONFIG_GPIO_ARIZONA=m
- CONFIG_GPIO_STMPE=y
-
-From 0497442c11084d7658140f1d0c12e1366a08bf10 Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Fri, 14 Jul 2017 12:59:55 +0100
-Subject: [PATCH 164/173] bcm2835-mmc: Fix DMA usage
-
-The previous change ("bcm2835-mmc: Only claim one DMA channel")
-used an incorrect variable, the effect of which was to prevent
-DMA from being used at all. Fix that bug by using the right
-variable.
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- drivers/mmc/host/bcm2835-mmc.c | 6 +++---
- 1 file changed, 3 insertions(+), 3 deletions(-)
-
-diff --git a/drivers/mmc/host/bcm2835-mmc.c b/drivers/mmc/host/bcm2835-mmc.c
-index 4fe8d1fe44578fbefcd48f8c327ba3d03f3d0a2a..981db05de1ff52a83550e41ab362eecf99cafa29 100644
---- a/drivers/mmc/host/bcm2835-mmc.c
-+++ b/drivers/mmc/host/bcm2835-mmc.c
-@@ -1354,14 +1354,14 @@ static int bcm2835_mmc_add_host(struct bcm2835_host *host)
- 		if (ret == 0) {
- 			host->dma_cfg_rx = cfg;
- 
--			host->use_dma = true;
-+			host->have_dma = true;
- 		} else {
- 			pr_err("%s: unable to configure DMA channel. "
--			       "Faling back to PIO\n",
-+			       "Falling back to PIO\n",
- 			       mmc_hostname(mmc));
- 			dma_release_channel(host->dma_chan_rxtx);
- 			host->dma_chan_rxtx = NULL;
--			host->use_dma = false;
-+			host->have_dma = false;
- 		}
- 	}
- #endif
-
-From d44a3ce8b3a6a47686f34b6dcc20fc990c5411bc Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Sun, 16 Jul 2017 21:39:16 +0100
-Subject: [PATCH 165/173] BCM270X_DT: Use the upstream thermal-zones DT node
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- arch/arm/boot/dts/bcm2708-rpi.dtsi | 30 ++++++------------------------
- 1 file changed, 6 insertions(+), 24 deletions(-)
-
-diff --git a/arch/arm/boot/dts/bcm2708-rpi.dtsi b/arch/arm/boot/dts/bcm2708-rpi.dtsi
-index 29dde110e769082a24640d3c7284afb8e99b226c..8cc83a350d02bb485f7a4fcb129df9e00fb3f958 100644
---- a/arch/arm/boot/dts/bcm2708-rpi.dtsi
-+++ b/arch/arm/boot/dts/bcm2708-rpi.dtsi
-@@ -90,30 +90,6 @@
- 		sound: sound {
- 			status = "disabled";
- 		};
--
--		thermal-zones {
--			cpu_thermal: cpu-thermal {
--				polling-delay-passive = <0>;
--				polling-delay = <1000>;
--
--				thermal-sensors = <&thermal>;
--
--				/* No trips
--				trips {
--					cpu-crit {
--						temperature	= <80000>;
--						hysteresis	= <0>;
--						type		= "critical";
--					};
--				};
--				*/
--
--				coefficients = <(-538)	407000>;
--
--				cooling-maps {
--				};
--			};
--		};
- 	};
- 
- 	__overrides__ {
-@@ -172,3 +148,9 @@ sdhost_pins: &sdhost_gpio48 {
- &fb {
- 	status = "okay";
- };
-+
-+&cpu_thermal {
-+	coefficients = <(-538)	407000>;
-+
-+	/delete-node/ trips;
-+};
-
-From 755af56f608bde7a8c4bb223f72a2945503c753b Mon Sep 17 00:00:00 2001
-From: Conn <connogriofa@gmail.com>
-Date: Mon, 17 Jul 2017 03:25:43 +0100
-Subject: [PATCH 166/173] config: enhance DualShock3 controller support
-
-Enable rumble support in Sony HID & HID battery strength.
----
- arch/arm/configs/bcm2709_defconfig | 2 ++
- arch/arm/configs/bcmrpi_defconfig  | 2 ++
- 2 files changed, 4 insertions(+)
-
-diff --git a/arch/arm/configs/bcm2709_defconfig b/arch/arm/configs/bcm2709_defconfig
-index 6f49e2b69f0cb27154dd26eba20eabdde2d60052..62909413e1d625a1d33559d965ee8707ca57ba91 100644
---- a/arch/arm/configs/bcm2709_defconfig
-+++ b/arch/arm/configs/bcm2709_defconfig
-@@ -901,6 +901,7 @@ CONFIG_SND_SOC_AK4554=m
- CONFIG_SND_SOC_SPDIF=m
- CONFIG_SND_SOC_WM8804_I2C=m
- CONFIG_SND_SIMPLE_CARD=m
-+CONFIG_HID_BATTERY_STRENGTH=y
- CONFIG_HIDRAW=y
- CONFIG_UHID=m
- CONFIG_HID_A4TECH=m
-@@ -943,6 +944,7 @@ CONFIG_HID_PICOLCD=m
- CONFIG_HID_ROCCAT=m
- CONFIG_HID_SAMSUNG=m
- CONFIG_HID_SONY=m
-+CONFIG_SONY_FF=y
- CONFIG_HID_SPEEDLINK=m
- CONFIG_HID_SUNPLUS=m
- CONFIG_HID_GREENASIA=m
-diff --git a/arch/arm/configs/bcmrpi_defconfig b/arch/arm/configs/bcmrpi_defconfig
-index 472a330439a19ac5d4f70c22059f015816823694..e0dd8723047ff488e81a03ef42fdbc68c43dc721 100644
---- a/arch/arm/configs/bcmrpi_defconfig
-+++ b/arch/arm/configs/bcmrpi_defconfig
-@@ -894,6 +894,7 @@ CONFIG_SND_SOC_AK4554=m
- CONFIG_SND_SOC_SPDIF=m
- CONFIG_SND_SOC_WM8804_I2C=m
- CONFIG_SND_SIMPLE_CARD=m
-+CONFIG_HID_BATTERY_STRENGTH=y
- CONFIG_HIDRAW=y
- CONFIG_UHID=m
- CONFIG_HID_A4TECH=m
-@@ -936,6 +937,7 @@ CONFIG_HID_PICOLCD=m
- CONFIG_HID_ROCCAT=m
- CONFIG_HID_SAMSUNG=m
- CONFIG_HID_SONY=m
-+CONFIG_SONY_FF=y
- CONFIG_HID_SPEEDLINK=m
- CONFIG_HID_SUNPLUS=m
- CONFIG_HID_GREENASIA=m
-
-From 000bbf308083a5facd5fa5022a941683550d561d Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Wed, 19 Jul 2017 15:20:50 +0100
-Subject: [PATCH 167/173] overlays: i2c1-bcm2708: Don't overwrite i2c1 pins
- node
-
-It is bad practise to overwrite an entire node in an overlay. Instead,
-target the node and overwrite any properties that need changing.
-
-See: https://github.com/raspberrypi/linux/pull/2118
-
-Suggested-by: soodvarun78 <soodvarun78@gmail.com>
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- arch/arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts | 17 +++++++----------
- 1 file changed, 7 insertions(+), 10 deletions(-)
-
-diff --git a/arch/arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts b/arch/arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts
-index e303b9c61c82a28eab7b48f6b085661574d5a849..7c69047bcd88a5c900dddd08e60ad0750b96d785 100644
---- a/arch/arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts
-+++ b/arch/arm/boot/dts/overlays/i2c1-bcm2708-overlay.dts
-@@ -20,18 +20,15 @@
-    };
- 
-    fragment@1 {
--      target = <&gpio>;
--      __overlay__ {
--         i2c1_pins: i2c1 {
--            brcm,pins = <2 3>;
--            brcm,function = <4>; /* alt0 */
--         };
-+      target = <&i2c1_pins>;
-+         pins: __overlay__ {
-+         brcm,pins = <2 3>;
-+         brcm,function = <4>; /* alt 0 */
-       };
-    };
--
-    __overrides__ {
--      sda1_pin = <&i2c1_pins>,"brcm,pins:0";
--      scl1_pin = <&i2c1_pins>,"brcm,pins:4";
--      pin_func = <&i2c1_pins>,"brcm,function:0";
-+      sda1_pin = <&pins>,"brcm,pins:0";
-+      scl1_pin = <&pins>,"brcm,pins:4";
-+      pin_func = <&pins>,"brcm,function:0";
-    };
- };
-
-From ea1f4704015786c01fbfd270f3a11bf5f550cc13 Mon Sep 17 00:00:00 2001
-From: Phil Elwell <phil@raspberrypi.org>
-Date: Tue, 18 Jul 2017 15:30:48 +0100
-Subject: [PATCH 168/173] bcm2835-mmc: Prevent DMA race condition
-
-The end of a read operation is triggered by the completion of the DMA
-transfer, but writes are complete when the data IRQ is raised. The
-bcm2835-mmc driver contains a race between the handling of the DMA
-completion interrupt and the submission of the next request. Fix the
-race by deferring the completion of the request until the DMA
-transfer finishes.
-
-Signed-off-by: Phil Elwell <phil@raspberrypi.org>
----
- drivers/mmc/host/bcm2835-mmc.c | 12 +++++++++++-
- 1 file changed, 11 insertions(+), 1 deletion(-)
-
-diff --git a/drivers/mmc/host/bcm2835-mmc.c b/drivers/mmc/host/bcm2835-mmc.c
-index 981db05de1ff52a83550e41ab362eecf99cafa29..c4a5e992c6fb4a40b933239350ed4bfc8fb40155 100644
---- a/drivers/mmc/host/bcm2835-mmc.c
-+++ b/drivers/mmc/host/bcm2835-mmc.c
-@@ -115,6 +115,7 @@ struct bcm2835_host {
- 
- 	bool					have_dma;
- 	bool					use_dma;
-+	bool					wait_for_dma;
- 	/*end of DMA part*/
- 
- 	int						max_delay;	/* maximum length of time spent waiting */
-@@ -341,6 +342,8 @@ static void bcm2835_mmc_dma_complete(void *param)
- 
- 	spin_lock_irqsave(&host->lock, flags);
- 
-+	host->use_dma = false;
-+
- 	if (host->data && !(host->data->flags & MMC_DATA_WRITE)) {
- 		/* otherwise handled in SDHCI IRQ */
- 		dma_chan = host->dma_chan_rxtx;
-@@ -351,6 +354,9 @@ static void bcm2835_mmc_dma_complete(void *param)
- 		     dir_data);
- 
- 		bcm2835_mmc_finish_data(host);
-+	} else if (host->wait_for_dma) {
-+		host->wait_for_dma = false;
-+		tasklet_schedule(&host->finish_tasklet);
- 	}
- 
- 	spin_unlock_irqrestore(&host->lock, flags);
-@@ -690,6 +696,7 @@ void bcm2835_mmc_send_command(struct bcm2835_host *host, struct mmc_command *cmd
- 	mod_timer(&host->timer, timeout);
- 
- 	host->cmd = cmd;
-+	host->use_dma = false;
- 
- 	bcm2835_mmc_prepare_data(host, cmd);
- 
-@@ -759,8 +766,11 @@ static void bcm2835_mmc_finish_data(struct bcm2835_host *host)
- 		}
- 
- 		bcm2835_mmc_send_command(host, data->stop);
--	} else
-+	} else if (host->use_dma) {
-+		host->wait_for_dma = true;
-+	} else {
- 		tasklet_schedule(&host->finish_tasklet);
-+	}
- }
- 
- static void bcm2835_mmc_finish_command(struct bcm2835_host *host)
-
-From 680b71b741156963a7bafea1f8a8e1a35d2c1219 Mon Sep 17 00:00:00 2001
-From: =?UTF-8?q?Sven=20K=C3=B6hler?= <sven.koehler@gmail.com>
-Date: Mon, 7 Aug 2017 18:49:20 +0200
-Subject: [PATCH 169/173] Fix dependencies broken since driver was renamed
-
----
- drivers/mmc/host/Kconfig | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
-diff --git a/drivers/mmc/host/Kconfig b/drivers/mmc/host/Kconfig
-index d47cce77c0551d78fa51f50e2c8086f26c7b9e56..dc41121c101e2ac6fe000fe2ab556561a340b78f 100644
---- a/drivers/mmc/host/Kconfig
-+++ b/drivers/mmc/host/Kconfig
-@@ -25,7 +25,7 @@ config MMC_BCM2835_DMA
- 
- config MMC_BCM2835_PIO_DMA_BARRIER
- 	int "Block count limit for PIO transfers"
--	depends on MMC_BCM2835 && MMC_BCM2835_DMA
-+	depends on MMC_BCM2835_MMC && MMC_BCM2835_DMA
- 	range 0 256
- 	default 2
- 	help
-
-From 0e7c5fbfb2d9173f593a8fefe4bbd727b8de361f Mon Sep 17 00:00:00 2001
-From: Eric Anholt <eric@anholt.net>
-Date: Thu, 18 Dec 2014 16:07:15 -0800
-Subject: [PATCH 170/173] mm: Remove the PFN busy warning
-
-See commit dae803e165a11bc88ca8dbc07a11077caf97bbcb -- the warning is
-expected sometimes when using CMA.  However, that commit still spams
-my kernel log with these warnings.
-
-Signed-off-by: Eric Anholt <eric@anholt.net>
----
- mm/page_alloc.c | 2 --
- 1 file changed, 2 deletions(-)
-
-diff --git a/mm/page_alloc.c b/mm/page_alloc.c
-index 1423da8dd16f5bdc83e20ddf6665b2022a9a6492..6ce930c02160d55dc4eee1e7197a5efa6ba7d44a 100644
---- a/mm/page_alloc.c
-+++ b/mm/page_alloc.c
-@@ -7692,8 +7692,6 @@ int alloc_contig_range(unsigned long start, unsigned long end,
- 
- 	/* Make sure the range is really isolated. */
- 	if (test_pages_isolated(outer_start, end, false)) {
--		pr_info_ratelimited("%s: [%lx, %lx) PFNs busy\n",
--			__func__, outer_start, end);
- 		ret = -EBUSY;
- 		goto done;
- 	}
-
-From 3349f1df8142f5463d3a856483691b10eb44e016 Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Fri, 25 Aug 2017 19:18:13 +0100
-Subject: [PATCH 171/173] cache: export clean and invalidate
-
----
- arch/arm/mm/cache-v6.S | 4 ++--
- arch/arm/mm/cache-v7.S | 4 ++--
- 2 files changed, 4 insertions(+), 4 deletions(-)
-
-diff --git a/arch/arm/mm/cache-v6.S b/arch/arm/mm/cache-v6.S
-index 24659952c2784de64a53dc2e889ab616bd19b12b..1ee5bc3a101884132a65adae32d6ef7417667ffc 100644
---- a/arch/arm/mm/cache-v6.S
-+++ b/arch/arm/mm/cache-v6.S
-@@ -201,7 +201,7 @@ ENTRY(v6_flush_kern_dcache_area)
-  *	- start   - virtual start address of region
-  *	- end     - virtual end address of region
-  */
--v6_dma_inv_range:
-+ENTRY(v6_dma_inv_range)
- #ifdef CONFIG_DMA_CACHE_RWFO
- 	ldrb	r2, [r0]			@ read for ownership
- 	strb	r2, [r0]			@ write for ownership
-@@ -246,7 +246,7 @@ v6_dma_inv_range:
-  *	- start   - virtual start address of region
-  *	- end     - virtual end address of region
-  */
--v6_dma_clean_range:
-+ENTRY(v6_dma_clean_range)
- 	bic	r0, r0, #D_CACHE_LINE_SIZE - 1
- 1:
- #ifdef CONFIG_DMA_CACHE_RWFO
-diff --git a/arch/arm/mm/cache-v7.S b/arch/arm/mm/cache-v7.S
-index de78109d002db1a5e7c94a6c1bc8bb94161d07b8..4c850aa3af2b2439fced4e130441329a724fb370 100644
---- a/arch/arm/mm/cache-v7.S
-+++ b/arch/arm/mm/cache-v7.S
-@@ -349,7 +349,7 @@ ENDPROC(v7_flush_kern_dcache_area)
-  *	- start   - virtual start address of region
-  *	- end     - virtual end address of region
-  */
--v7_dma_inv_range:
-+ENTRY(v7_dma_inv_range)
- 	dcache_line_size r2, r3
- 	sub	r3, r2, #1
- 	tst	r0, r3
-@@ -377,7 +377,7 @@ ENDPROC(v7_dma_inv_range)
-  *	- start   - virtual start address of region
-  *	- end     - virtual end address of region
+diff --git a/arch/arm/lib/memset_rpi.S b/arch/arm/lib/memset_rpi.S
+index 70674158d76cd38d8d70c987aa54a6b477e4fa91..2ca0d3618515497c9a9b101176bf9fbacb829d13 100644
+--- a/arch/arm/lib/memset_rpi.S
++++ b/arch/arm/lib/memset_rpi.S
+@@ -52,6 +52,9 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
   */
--v7_dma_clean_range:
-+ENTRY(v7_dma_clean_range)
- 	dcache_line_size r2, r3
- 	sub	r3, r2, #1
- 	bic	r0, r0, r3
-
-From d0795818dbfcdb270b5c3b9d3bdccd29b1208d5d Mon Sep 17 00:00:00 2001
-From: Olivier Schonken <olivier.schonken@gmail.com>
-Date: Mon, 28 Aug 2017 10:52:32 +0200
-Subject: [PATCH 172/173] Fix DTB overlay compilation for arm64 broadcom
-
-The dts-dirs variable was overwritten by the assignment of the
-stingray directory after the overlays directory, thus no overlays
-were being built
-
-Signed-off-by: Olivier Schonken <olivier.schonken@gmail.com>
----
- arch/arm64/boot/dts/broadcom/Makefile | 2 +-
- 1 file changed, 1 insertion(+), 1 deletion(-)
-
-diff --git a/arch/arm64/boot/dts/broadcom/Makefile b/arch/arm64/boot/dts/broadcom/Makefile
-index 97af2ececc52ca3aad7b84dc2fdb5c269a45bde0..3b76320112196a1fce7a0941c696fd1ec43b817f 100644
---- a/arch/arm64/boot/dts/broadcom/Makefile
-+++ b/arch/arm64/boot/dts/broadcom/Makefile
-@@ -11,7 +11,7 @@ dtb-$(CONFIG_ARCH_BCM2835) += bcm2710-rpi-3-b.dtb
- 
- dts-dirs += ../overlays
- 
--dts-dirs	:= stingray
-+dts-dirs	+= stingray
- always		:= $(dtb-y)
- subdir-y	:= $(dts-dirs)
- clean-files	:= *.dtb
-
-From 80d497d63c3cb89e861723360e653fb2d7750940 Mon Sep 17 00:00:00 2001
-From: popcornmix <popcornmix@gmail.com>
-Date: Fri, 25 Aug 2017 19:18:26 +0100
-Subject: [PATCH 173/173] vcsm: Provide new ioctl to clean/invalidate a 2D
- block
-
----
- drivers/char/broadcom/vc_sm/vmcs_sm.c  | 92 ++++++++++++++++++++++++++++++++--
- include/linux/broadcom/vmcs_sm_ioctl.h | 16 ++++++
- 2 files changed, 105 insertions(+), 3 deletions(-)
-
-diff --git a/drivers/char/broadcom/vc_sm/vmcs_sm.c b/drivers/char/broadcom/vc_sm/vmcs_sm.c
-index fd2ca788dcd56b1702454d71b7bedd4203179500..d49e39566d521c95a96375c556516e444d52b6a0 100644
---- a/drivers/char/broadcom/vc_sm/vmcs_sm.c
-+++ b/drivers/char/broadcom/vc_sm/vmcs_sm.c
-@@ -142,6 +142,7 @@ struct SM_RESOURCE_T {
- 	struct list_head map_list;	/* Maps associated with a resource. */
- 
- 	struct SM_PRIV_DATA_T *private;
-+	bool map;		/* whether to map pages up front */
- };
- 
- /* Private file data associated with each opened device.
-@@ -1376,6 +1377,20 @@ static int vc_sm_mmap(struct file *file, struct vm_area_struct *vma)
- 	vcsm_vma_open(vma);
- 	resource->res_stats[MAP]++;
- 	vmcs_sm_release_resource(resource, 0);
-+
-+	if (resource->map) {
-+		/* We don't use vmf->pgoff since that has the fake offset */
-+		unsigned long addr;
-+		for (addr = vma->vm_start; addr < vma->vm_end; addr += PAGE_SIZE) {
-+			/* Finally, remap it */
-+			unsigned long pfn = (unsigned long)resource->res_base_mem & 0x3FFFFFFF;
-+			pfn += mm_vc_mem_phys_addr;
-+			pfn += addr - vma->vm_start;
-+			pfn >>= PAGE_SHIFT;
-+			ret = vm_insert_pfn(vma, addr, pfn);
-+		}
-+	}
-+
- 	return 0;
- 
- error:
-@@ -1394,10 +1409,18 @@ int vc_sm_ioctl_alloc(struct SM_PRIV_DATA_T *private,
- 	struct SM_RESOURCE_T *resource;
- 	VC_SM_ALLOC_T alloc = { 0 };
- 	VC_SM_ALLOC_RESULT_T result = { 0 };
-+	enum vmcs_sm_cache_e cached = ioparam->cached;
-+	bool map = false;
-+
-+	/* flag to requst buffer is mapped up front, rather than lazily */
-+	if (cached & 0x80 ) {
-+		map = true;
-+		cached &= ~0x80;
-+	}
- 
- 	/* Setup our allocation parameters */
--	alloc.type = ((ioparam->cached == VMCS_SM_CACHE_VC)
--		      || (ioparam->cached ==
-+	alloc.type = ((cached == VMCS_SM_CACHE_VC)
-+		      || (cached ==
- 			  VMCS_SM_CACHE_BOTH)) ? VC_SM_ALLOC_CACHED :
- 	    VC_SM_ALLOC_NON_CACHED;
- 	alloc.base_unit = ioparam->size;
-@@ -1455,7 +1478,8 @@ int vc_sm_ioctl_alloc(struct SM_PRIV_DATA_T *private,
- 	resource->res_handle = result.res_handle;
- 	resource->res_base_mem = result.res_mem;
- 	resource->res_size = alloc.base_unit * alloc.num_unit;
--	resource->res_cached = ioparam->cached;
-+	resource->res_cached = cached;
-+	resource->map = map;
- 
- 	/* Kernel/user GUID.  This global identifier is used for mmap'ing the
- 	 * allocated region from user space, it is passed as the mmap'ing
-@@ -2790,6 +2814,68 @@ static long vc_sm_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
- 			}
- 		}
- 		break;
-+	/* Flush/Invalidate the cache for a given mapping. */
-+	case VMCS_SM_CMD_CLEAN_INVALID2:
-+		{
-+				int i, j;
-+				struct vmcs_sm_ioctl_clean_invalid2 ioparam;
-+				struct vmcs_sm_ioctl_clean_invalid_block *block = NULL;
-+
-+				/* Get parameter data. */
-+				if (copy_from_user(&ioparam,
-+						   (void *)arg, sizeof(ioparam)) != 0) {
-+					pr_err("[%s]: failed to copy-from-user header for cmd %x\n",
-+							__func__, cmdnr);
-+					ret = -EFAULT;
-+					goto out;
-+				}
-+				block = kzalloc(ioparam.op_count * sizeof(struct vmcs_sm_ioctl_clean_invalid_block), GFP_KERNEL);
-+				if (!block) {
-+					ret = -EFAULT;
-+					goto out;
-+				}
-+				if (copy_from_user(block,
-+						   (void *)(arg + sizeof(ioparam)), ioparam.op_count * sizeof(struct vmcs_sm_ioctl_clean_invalid_block)) != 0) {
-+					pr_err("[%s]: failed to copy-from-user payload for cmd %x\n",
-+							__func__, cmdnr);
-+					ret = -EFAULT;
-+					goto out;
-+				}
-+
-+				for (i=0; i<ioparam.op_count; i++) {
-+					struct vmcs_sm_ioctl_clean_invalid_block *op = block + i;
-+					for (j = 0; j < op->block_count; ++j) {
-+
-+
-+						extern void v6_dma_inv_range(void *start, void *end);
-+						extern void v6_dma_clean_range(void *start, void *end);
-+						unsigned long base = (unsigned long)op->start_address + j * op->inter_block_stride;
-+						unsigned long end = base + op->block_size;
-+						/* L1/L2 cache clean */
-+						if (op->invalidate_mode & 2) {
-+#if defined(CONFIG_CPU_CACHE_V7)
-+							extern void v7_dma_clean_range(void *start, void *end);
-+							v7_dma_clean_range((void *)base, (void *)end);
-+#elif defined(CONFIG_CPU_CACHE_V6)
-+							extern void v6_dma_clean_range(void *start, void *end);
-+							v6_dma_clean_range((void *)base, (void *)end);
-+#endif
-+						/* L1/L2 cache invalidate */
-+						}
-+						if (op->invalidate_mode & 1) {
-+#if defined(CONFIG_CPU_CACHE_V7)
-+							extern void v7_dma_inv_range(void *start, void *end);
-+							v7_dma_inv_range((void *)base, (void *)end);
-+#elif defined(CONFIG_CPU_CACHE_V6)
-+							extern void v6_dma_inv_range(void *start, void *end);
-+							v6_dma_inv_range((void *)base, (void *)end);
-+#endif
-+						}
-+					}
-+				}
-+				kfree(block);
-+			}
-+		break;
- 
- 	default:
- 		{
-diff --git a/include/linux/broadcom/vmcs_sm_ioctl.h b/include/linux/broadcom/vmcs_sm_ioctl.h
-index 334f36d0d697b047df2922b5f2db67f38cf76564..2de7f1f41070689c99cad3bd43d117458549cb51 100644
---- a/include/linux/broadcom/vmcs_sm_ioctl.h
-+++ b/include/linux/broadcom/vmcs_sm_ioctl.h
-@@ -62,6 +62,7 @@ enum vmcs_sm_cmd_e {
- 	VMCS_SM_CMD_HOST_WALK_PID_MAP,
- 
- 	VMCS_SM_CMD_CLEAN_INVALID,
-+	VMCS_SM_CMD_CLEAN_INVALID2,
- 
- 	VMCS_SM_CMD_LAST	/* Do no delete */
- };
-@@ -175,6 +176,18 @@ struct vmcs_sm_ioctl_clean_invalid {
- 	} s[8];
- };
- 
-+struct vmcs_sm_ioctl_clean_invalid2 {
-+	uint8_t op_count;
-+	uint8_t zero[3];
-+	struct vmcs_sm_ioctl_clean_invalid_block {
-+		uint16_t invalidate_mode;
-+		uint16_t block_count;
-+		void *   start_address;
-+		uint32_t block_size;
-+		uint32_t inter_block_stride;
-+	} s[0];
-+};
-+
- /* IOCTL numbers */
- #define VMCS_SM_IOCTL_MEM_ALLOC\
- 	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_ALLOC,\
-@@ -206,6 +219,9 @@ struct vmcs_sm_ioctl_clean_invalid {
- #define VMCS_SM_IOCTL_MEM_CLEAN_INVALID\
- 	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_CLEAN_INVALID,\
- 	 struct vmcs_sm_ioctl_clean_invalid)
-+#define VMCS_SM_IOCTL_MEM_CLEAN_INVALID2\
-+	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_CLEAN_INVALID2,\
-+	 struct vmcs_sm_ioctl_clean_invalid2)
- 
- #define VMCS_SM_IOCTL_SIZE_USR_HDL\
- 	_IOR(VMCS_SM_MAGIC_TYPE, VMCS_SM_CMD_SIZE_USR_HANDLE,\
+ ENTRY(mmioset)
+ ENTRY(memset)
++ENTRY(__memset32)
++ENTRY(__memset64)
++
+         S       .req    a1
+         DAT0    .req    a2
+         N       .req    a3
+@@ -119,5 +122,7 @@ ENTRY(memset)
+         .unreq  DAT1
+         .unreq  DAT2
+         .unreq  DAT3
++ENDPROC(__memset64)
++ENDPROC(__memset32)
+ ENDPROC(memset)
+ ENDPROC(mmioset)

From 70e45cbbbb3a566b1299f7ae6a4e18265a39c493 Mon Sep 17 00:00:00 2001
From: MilhouseVH <milhouseVH.github@nmacleod.com>
Date: Thu, 21 Sep 2017 04:35:39 +0100
Subject: [PATCH 3/7] config: update options for linux-4.14-rc1

---
 projects/Generic/linux/linux.x86_64.conf       | 145 +++++++++++++++----------
 projects/RPi/devices/RPi/linux/linux.arm.conf  | 113 +++++++++++--------
 projects/RPi/devices/RPi2/linux/linux.arm.conf | 113 +++++++++++--------
 3 files changed, 219 insertions(+), 152 deletions(-)

diff --git a/projects/Generic/linux/linux.x86_64.conf b/projects/Generic/linux/linux.x86_64.conf
index 5d3d56ee3ab..111c45afce2 100644
--- a/projects/Generic/linux/linux.x86_64.conf
+++ b/projects/Generic/linux/linux.x86_64.conf
@@ -1,6 +1,6 @@
 #
 # Automatically generated file; DO NOT EDIT.
-# Linux/x86 4.13.0 Kernel Configuration
+# Linux/x86_64 4.14.0-rc1 Kernel Configuration
 #
 CONFIG_64BIT=y
 CONFIG_X86_64=y
@@ -215,6 +215,7 @@ CONFIG_ELF_CORE=y
 # CONFIG_PCSPKR_PLATFORM is not set
 CONFIG_BASE_FULL=y
 CONFIG_FUTEX=y
+CONFIG_FUTEX_PI=y
 CONFIG_EPOLL=y
 CONFIG_SIGNALFD=y
 CONFIG_TIMERFD=y
@@ -244,6 +245,7 @@ CONFIG_SLUB=y
 # CONFIG_SLOB is not set
 CONFIG_SLAB_MERGE_DEFAULT=y
 # CONFIG_SLAB_FREELIST_RANDOM is not set
+# CONFIG_SLAB_FREELIST_HARDENED is not set
 CONFIG_SLUB_CPU_PARTIAL=y
 # CONFIG_SYSTEM_DATA_VERIFICATION is not set
 # CONFIG_PROFILING is not set
@@ -283,6 +285,7 @@ CONFIG_HAVE_HARDLOCKUP_DETECTOR_PERF=y
 CONFIG_HAVE_PERF_REGS=y
 CONFIG_HAVE_PERF_USER_STACK_DUMP=y
 CONFIG_HAVE_ARCH_JUMP_LABEL=y
+CONFIG_HAVE_RCU_TABLE_FREE=y
 CONFIG_ARCH_HAVE_NMI_SAFE_CMPXCHG=y
 CONFIG_HAVE_ALIGNED_STRUCT_PAGE=y
 CONFIG_HAVE_CMPXCHG_LOCAL=y
@@ -307,6 +310,7 @@ CONFIG_HAVE_ARCH_TRANSPARENT_HUGEPAGE=y
 CONFIG_HAVE_ARCH_TRANSPARENT_HUGEPAGE_PUD=y
 CONFIG_HAVE_ARCH_HUGE_VMAP=y
 CONFIG_HAVE_ARCH_SOFT_DIRTY=y
+CONFIG_HAVE_MOD_ARCH_SPECIFIC=y
 CONFIG_MODULES_USE_ELF_RELA=y
 CONFIG_HAVE_IRQ_EXIT_ON_IRQ_STACK=y
 CONFIG_ARCH_HAS_ELF_RANDOMIZE=y
@@ -430,7 +434,7 @@ CONFIG_X86_FAST_FEATURE_TESTS=y
 # CONFIG_X86_X2APIC is not set
 CONFIG_X86_MPPARSE=y
 # CONFIG_GOLDFISH is not set
-# CONFIG_INTEL_RDT_A is not set
+# CONFIG_INTEL_RDT is not set
 # CONFIG_X86_EXTENDED_PLATFORM is not set
 CONFIG_X86_INTEL_LPSS=y
 CONFIG_X86_AMD_PLATFORM_DEVICE=y
@@ -502,9 +506,12 @@ CONFIG_MICROCODE_AMD=y
 CONFIG_MICROCODE_OLD_INTERFACE=y
 CONFIG_X86_MSR=y
 CONFIG_X86_CPUID=y
+# CONFIG_X86_5LEVEL is not set
 CONFIG_ARCH_PHYS_ADDR_T_64BIT=y
 CONFIG_ARCH_DMA_ADDR_T_64BIT=y
 CONFIG_X86_DIRECT_GBPAGES=y
+CONFIG_ARCH_HAS_MEM_ENCRYPT=y
+# CONFIG_AMD_MEM_ENCRYPT is not set
 CONFIG_NUMA=y
 # CONFIG_AMD_NUMA is not set
 CONFIG_X86_64_ACPI_NUMA=y
@@ -537,6 +544,7 @@ CONFIG_MEMORY_BALLOON=y
 CONFIG_BALLOON_COMPACTION=y
 CONFIG_COMPACTION=y
 CONFIG_MIGRATION=y
+CONFIG_ARCH_ENABLE_THP_MIGRATION=y
 CONFIG_PHYS_ADDR_T_64BIT=y
 CONFIG_BOUNCE=y
 CONFIG_VIRT_TO_BUS=y
@@ -609,6 +617,7 @@ CONFIG_CMDLINE="root=/dev/ram0 rdinit=/init usbcore.autosuspend=-1"
 # CONFIG_CMDLINE_OVERRIDE is not set
 CONFIG_MODIFY_LDT_SYSCALL=y
 CONFIG_HAVE_LIVEPATCH=y
+CONFIG_ARCH_HAS_ADD_PAGES=y
 CONFIG_ARCH_ENABLE_MEMORY_HOTPLUG=y
 CONFIG_USE_PERCPU_NUMA_NODE_ID=y
 
@@ -898,7 +907,6 @@ CONFIG_IPV6_NDISC_NODETYPE=y
 CONFIG_NET_PTP_CLASSIFY=y
 # CONFIG_NETWORK_PHY_TIMESTAMPING is not set
 CONFIG_NETFILTER=y
-# CONFIG_NETFILTER_DEBUG is not set
 CONFIG_NETFILTER_ADVANCED=y
 CONFIG_BRIDGE_NETFILTER=m
 
@@ -1168,6 +1176,7 @@ CONFIG_DNS_RESOLVER=y
 # CONFIG_VSOCKETS is not set
 # CONFIG_NETLINK_DIAG is not set
 # CONFIG_MPLS is not set
+# CONFIG_NET_NSH is not set
 # CONFIG_HSR is not set
 # CONFIG_NET_SWITCHDEV is not set
 # CONFIG_NET_L3_MASTER_DEV is not set
@@ -1190,7 +1199,6 @@ CONFIG_NET_FLOW_LIMIT=y
 # CONFIG_NET_DROP_MONITOR is not set
 # CONFIG_HAMRADIO is not set
 # CONFIG_CAN is not set
-# CONFIG_IRDA is not set
 CONFIG_BT=m
 CONFIG_BT_BREDR=y
 CONFIG_BT_RFCOMM=m
@@ -1204,6 +1212,7 @@ CONFIG_BT_LE=y
 # CONFIG_BT_LEDS is not set
 # CONFIG_BT_SELFTEST is not set
 # CONFIG_BT_DEBUGFS is not set
+CONFIG_BT_LEGACY_IOCTL=y
 
 #
 # Bluetooth device drivers
@@ -1325,10 +1334,8 @@ CONFIG_PNP=y
 #
 CONFIG_PNPACPI=y
 CONFIG_BLK_DEV=y
-# CONFIG_BLK_DEV_NULL_BLK is not set
 # CONFIG_BLK_DEV_FD is not set
 # CONFIG_BLK_DEV_PCIESSD_MTIP32XX is not set
-# CONFIG_BLK_CPQ_CISS_DA is not set
 # CONFIG_BLK_DEV_DAC960 is not set
 # CONFIG_BLK_DEV_UMEM is not set
 # CONFIG_BLK_DEV_COW_COMMON is not set
@@ -1706,7 +1713,6 @@ CONFIG_B44=y
 CONFIG_B44_PCI_AUTOSELECT=y
 CONFIG_B44_PCICORE_AUTOSELECT=y
 CONFIG_B44_PCI=y
-# CONFIG_BCMGENET is not set
 CONFIG_BNX2=y
 CONFIG_CNIC=y
 CONFIG_TIGON3=y
@@ -1738,6 +1744,7 @@ CONFIG_ULI526X=y
 CONFIG_NET_VENDOR_EZCHIP=y
 # CONFIG_NET_VENDOR_EXAR is not set
 # CONFIG_NET_VENDOR_HP is not set
+# CONFIG_NET_VENDOR_HUAWEI is not set
 CONFIG_NET_VENDOR_INTEL=y
 CONFIG_E100=y
 CONFIG_E1000=y
@@ -1849,6 +1856,7 @@ CONFIG_MARVELL_PHY=y
 # CONFIG_NATIONAL_PHY is not set
 # CONFIG_QSEMI_PHY is not set
 CONFIG_REALTEK_PHY=y
+# CONFIG_ROCKCHIP_PHY is not set
 # CONFIG_SMSC_PHY is not set
 # CONFIG_STE10XP is not set
 # CONFIG_TERANETICS_PHY is not set
@@ -2317,6 +2325,7 @@ CONFIG_SERIO_LIBPS2=y
 # CONFIG_SERIO_ALTERA_PS2 is not set
 # CONFIG_SERIO_PS2MULT is not set
 # CONFIG_SERIO_ARC_PS2 is not set
+# CONFIG_SERIO_GPIO_PS2 is not set
 # CONFIG_USERIO is not set
 # CONFIG_GAMEPORT is not set
 
@@ -2412,7 +2421,6 @@ CONFIG_I2C_MUX=m
 # CONFIG_I2C_MUX_LTC4306 is not set
 # CONFIG_I2C_MUX_PCA9541 is not set
 # CONFIG_I2C_MUX_PCA954x is not set
-# CONFIG_I2C_MUX_PINCTRL is not set
 # CONFIG_I2C_MUX_REG is not set
 # CONFIG_I2C_MUX_MLXCPLD is not set
 CONFIG_I2C_HELPER_AUTO=y
@@ -2525,7 +2533,9 @@ CONFIG_PINCTRL_BAYTRAIL=y
 CONFIG_PINCTRL_CHERRYVIEW=y
 # CONFIG_PINCTRL_BROXTON is not set
 # CONFIG_PINCTRL_CANNONLAKE is not set
+# CONFIG_PINCTRL_DENVERTON is not set
 # CONFIG_PINCTRL_GEMINILAKE is not set
+# CONFIG_PINCTRL_LEWISBURG is not set
 # CONFIG_PINCTRL_SUNRISEPOINT is not set
 CONFIG_GPIOLIB=y
 CONFIG_GPIO_ACPI=y
@@ -2790,10 +2800,6 @@ CONFIG_SSB_DRIVER_PCICORE_POSSIBLE=y
 CONFIG_SSB_DRIVER_PCICORE=y
 # CONFIG_SSB_DRIVER_GPIO is not set
 CONFIG_BCMA_POSSIBLE=y
-
-#
-# Broadcom specific AMBA
-#
 CONFIG_BCMA=m
 CONFIG_BCMA_HOST_PCI_POSSIBLE=y
 CONFIG_BCMA_HOST_PCI=y
@@ -2811,6 +2817,7 @@ CONFIG_MFD_CORE=y
 # CONFIG_PMIC_ADP5520 is not set
 # CONFIG_MFD_AAT2870_CORE is not set
 # CONFIG_MFD_BCM590XX is not set
+# CONFIG_MFD_BD9571MWV is not set
 # CONFIG_MFD_AXP20X_I2C is not set
 # CONFIG_MFD_CROS_EC is not set
 # CONFIG_PMIC_DA903X is not set
@@ -2871,6 +2878,7 @@ CONFIG_MFD_RTSX_USB=y
 # CONFIG_MFD_TPS65086 is not set
 # CONFIG_MFD_TPS65090 is not set
 # CONFIG_MFD_TPS65217 is not set
+# CONFIG_MFD_TPS68470 is not set
 # CONFIG_MFD_TI_LP873X is not set
 # CONFIG_MFD_TPS65218 is not set
 # CONFIG_MFD_TPS6586X is not set
@@ -2889,6 +2897,41 @@ CONFIG_MFD_RTSX_USB=y
 # CONFIG_MFD_WM8350_I2C is not set
 # CONFIG_MFD_WM8994 is not set
 # CONFIG_REGULATOR is not set
+CONFIG_RC_CORE=m
+CONFIG_RC_MAP=m
+CONFIG_RC_DECODERS=y
+CONFIG_LIRC=m
+CONFIG_IR_LIRC_CODEC=m
+CONFIG_IR_NEC_DECODER=m
+CONFIG_IR_RC5_DECODER=m
+CONFIG_IR_RC6_DECODER=m
+CONFIG_IR_JVC_DECODER=m
+CONFIG_IR_SONY_DECODER=m
+CONFIG_IR_SANYO_DECODER=m
+CONFIG_IR_SHARP_DECODER=m
+CONFIG_IR_MCE_KBD_DECODER=m
+CONFIG_IR_XMP_DECODER=m
+CONFIG_RC_DEVICES=y
+CONFIG_RC_ATI_REMOTE=m
+CONFIG_IR_ENE=m
+# CONFIG_IR_HIX5HD2 is not set
+CONFIG_IR_IMON=m
+CONFIG_IR_MCEUSB=m
+CONFIG_IR_ITE_CIR=m
+CONFIG_IR_FINTEK=m
+CONFIG_IR_NUVOTON=m
+CONFIG_IR_REDRAT3=m
+CONFIG_IR_STREAMZAP=m
+CONFIG_IR_WINBOND_CIR=m
+CONFIG_IR_IGORPLUGUSB=m
+CONFIG_IR_IGUANA=m
+CONFIG_IR_TTUSBIR=m
+# CONFIG_RC_LOOPBACK is not set
+# CONFIG_IR_GPIO_CIR is not set
+# CONFIG_IR_GPIO_TX is not set
+CONFIG_IR_SERIAL=m
+CONFIG_IR_SERIAL_TRANSMITTER=y
+# CONFIG_IR_SIR is not set
 CONFIG_MEDIA_SUPPORT=m
 
 #
@@ -2899,7 +2942,6 @@ CONFIG_MEDIA_ANALOG_TV_SUPPORT=y
 CONFIG_MEDIA_DIGITAL_TV_SUPPORT=y
 # CONFIG_MEDIA_RADIO_SUPPORT is not set
 # CONFIG_MEDIA_SDR_SUPPORT is not set
-CONFIG_MEDIA_RC_SUPPORT=y
 # CONFIG_MEDIA_CEC_SUPPORT is not set
 # CONFIG_MEDIA_CONTROLLER is not set
 CONFIG_VIDEO_DEV=m
@@ -2926,40 +2968,6 @@ CONFIG_DVB_MAX_ADAPTERS=8
 #
 # Media drivers
 #
-CONFIG_RC_CORE=m
-CONFIG_RC_MAP=m
-CONFIG_RC_DECODERS=y
-CONFIG_LIRC=m
-CONFIG_IR_LIRC_CODEC=m
-CONFIG_IR_NEC_DECODER=m
-CONFIG_IR_RC5_DECODER=m
-CONFIG_IR_RC6_DECODER=m
-CONFIG_IR_JVC_DECODER=m
-CONFIG_IR_SONY_DECODER=m
-CONFIG_IR_SANYO_DECODER=m
-CONFIG_IR_SHARP_DECODER=m
-CONFIG_IR_MCE_KBD_DECODER=m
-CONFIG_IR_XMP_DECODER=m
-CONFIG_RC_DEVICES=y
-CONFIG_RC_ATI_REMOTE=m
-CONFIG_IR_ENE=m
-# CONFIG_IR_HIX5HD2 is not set
-CONFIG_IR_IMON=m
-CONFIG_IR_MCEUSB=m
-CONFIG_IR_ITE_CIR=m
-CONFIG_IR_FINTEK=m
-CONFIG_IR_NUVOTON=m
-CONFIG_IR_REDRAT3=m
-CONFIG_IR_STREAMZAP=m
-CONFIG_IR_WINBOND_CIR=m
-CONFIG_IR_IGORPLUGUSB=m
-CONFIG_IR_IGUANA=m
-CONFIG_IR_TTUSBIR=m
-# CONFIG_RC_LOOPBACK is not set
-# CONFIG_IR_GPIO_CIR is not set
-CONFIG_IR_SERIAL=m
-CONFIG_IR_SERIAL_TRANSMITTER=y
-# CONFIG_IR_SIR is not set
 CONFIG_MEDIA_USB_SUPPORT=y
 
 #
@@ -3124,6 +3132,7 @@ CONFIG_DVB_MANTIS=m
 # CONFIG_DVB_HOPPER is not set
 CONFIG_DVB_NGENE=m
 CONFIG_DVB_DDBRIDGE=m
+# CONFIG_DVB_DDBRIDGE_MSIENABLE is not set
 CONFIG_DVB_SMIPCIE=m
 # CONFIG_V4L_PLATFORM_DRIVERS is not set
 # CONFIG_V4L_MEM2MEM_DRIVERS is not set
@@ -3257,7 +3266,10 @@ CONFIG_MEDIA_TUNER_QM1D1C0042=m
 CONFIG_DVB_STB0899=m
 CONFIG_DVB_STB6100=m
 CONFIG_DVB_STV090x=m
+CONFIG_DVB_STV0910=m
 CONFIG_DVB_STV6110x=m
+CONFIG_DVB_STV6111=m
+CONFIG_DVB_MXL5XX=m
 CONFIG_DVB_M88DS3103=m
 
 #
@@ -3371,6 +3383,7 @@ CONFIG_DVB_TUNER_DIB0090=m
 # SEC control devices for DVB-S
 #
 CONFIG_DVB_DRX39XYJ=m
+CONFIG_DVB_LNBH25=m
 CONFIG_DVB_LNBP21=m
 CONFIG_DVB_LNBP22=m
 CONFIG_DVB_ISL6405=m
@@ -3783,7 +3796,6 @@ CONFIG_SND_SOC_INTEL_BYT_CHT_DA7213_MACH=m
 CONFIG_SND_SOC_INTEL_BYT_CHT_ES8316_MACH=m
 CONFIG_SND_SOC_INTEL_BYT_CHT_NOCODEC_MACH=m
 CONFIG_SND_SOC_INTEL_KBL_RT5663_MAX98927_MACH=m
-CONFIG_SND_SOC_INTEL_KBL_RT5663_RT5514_MAX98927_MACH=m
 CONFIG_SND_SOC_INTEL_SKYLAKE=m
 # CONFIG_SND_SOC_INTEL_SKL_RT286_MACH is not set
 # CONFIG_SND_SOC_INTEL_SKL_NAU88L25_SSM4567_MACH is not set
@@ -3822,6 +3834,7 @@ CONFIG_SND_SOC_I2C_AND_SPI=y
 # CONFIG_SND_SOC_CS4270 is not set
 # CONFIG_SND_SOC_CS4271_I2C is not set
 # CONFIG_SND_SOC_CS42XX8_I2C is not set
+# CONFIG_SND_SOC_CS43130 is not set
 # CONFIG_SND_SOC_CS4349 is not set
 # CONFIG_SND_SOC_CS53L30 is not set
 CONFIG_SND_SOC_DA7213=m
@@ -3843,7 +3856,6 @@ CONFIG_SND_SOC_MAX98927=m
 # CONFIG_SND_SOC_PCM3168A_I2C is not set
 # CONFIG_SND_SOC_PCM512x_I2C is not set
 CONFIG_SND_SOC_RL6231=m
-CONFIG_SND_SOC_RT5514=m
 # CONFIG_SND_SOC_RT5616 is not set
 # CONFIG_SND_SOC_RT5631 is not set
 CONFIG_SND_SOC_RT5640=m
@@ -3870,6 +3882,7 @@ CONFIG_SND_SOC_SPDIF=m
 CONFIG_SND_SOC_TS3A227E=m
 # CONFIG_SND_SOC_WM8510 is not set
 # CONFIG_SND_SOC_WM8523 is not set
+# CONFIG_SND_SOC_WM8524 is not set
 # CONFIG_SND_SOC_WM8580 is not set
 # CONFIG_SND_SOC_WM8711 is not set
 # CONFIG_SND_SOC_WM8728 is not set
@@ -4208,7 +4221,6 @@ CONFIG_USB_SERIAL_PL2303=m
 # CONFIG_USB_ULPI_BUS is not set
 # CONFIG_UWB is not set
 CONFIG_MMC=y
-# CONFIG_MMC_DEBUG is not set
 CONFIG_MMC_BLOCK=y
 CONFIG_MMC_BLOCK_MINORS=32
 # CONFIG_SDIO_UART is not set
@@ -4217,6 +4229,7 @@ CONFIG_MMC_BLOCK_MINORS=32
 #
 # MMC/SD/SDIO Host Controller Drivers
 #
+# CONFIG_MMC_DEBUG is not set
 CONFIG_MMC_SDHCI=y
 CONFIG_MMC_SDHCI_PCI=y
 # CONFIG_MMC_RICOH_MMC is not set
@@ -4243,6 +4256,7 @@ CONFIG_LEDS_CLASS_FLASH=y
 #
 # LED drivers
 #
+# CONFIG_LEDS_AS3645A is not set
 # CONFIG_LEDS_LM3530 is not set
 # CONFIG_LEDS_LM3642 is not set
 # CONFIG_LEDS_PCA9532 is not set
@@ -4391,6 +4405,7 @@ CONFIG_DMADEVICES=y
 CONFIG_DMA_ENGINE=y
 CONFIG_DMA_VIRTUAL_CHANNELS=m
 CONFIG_DMA_ACPI=y
+# CONFIG_ALTERA_MSGDMA is not set
 CONFIG_INTEL_IDMA64=m
 CONFIG_INTEL_IOATDMA=m
 # CONFIG_QCOM_HIDMA_MGMT is not set
@@ -4442,6 +4457,7 @@ CONFIG_VIRTIO_MMIO=y
 # CONFIG_HYPERV is not set
 # CONFIG_HYPERV_TSCPAGE is not set
 CONFIG_STAGING=y
+# CONFIG_IRDA is not set
 # CONFIG_PRISM2_USB is not set
 # CONFIG_COMEDI is not set
 CONFIG_RTL8192U=m
@@ -4449,6 +4465,7 @@ CONFIG_RTL8192U=m
 CONFIG_RTL8723BS=m
 CONFIG_R8712U=m
 # CONFIG_R8188EU is not set
+# CONFIG_R8822BE is not set
 CONFIG_RTS5208=y
 # CONFIG_VT6655 is not set
 CONFIG_VT6656=m
@@ -4586,12 +4603,20 @@ CONFIG_PCC=y
 #
 
 #
+# Amlogic SoC drivers
+#
+
+#
 # Broadcom SoC drivers
 #
 
 #
 # i.MX SoC drivers
 #
+
+#
+# Qualcomm SoC drivers
+#
 # CONFIG_SUNXI_SRAM is not set
 # CONFIG_SOC_TI is not set
 # CONFIG_PM_DEVFREQ is not set
@@ -4606,8 +4631,9 @@ CONFIG_ARM_GIC_MAX_NR=1
 CONFIG_RESET_CONTROLLER=y
 # CONFIG_RESET_ATH79 is not set
 # CONFIG_RESET_BERLIN is not set
-# CONFIG_RESET_GEMINI is not set
+# CONFIG_RESET_HSDK_V1 is not set
 # CONFIG_RESET_IMX7 is not set
+# CONFIG_RESET_LANTIQ is not set
 # CONFIG_RESET_LPC18XX is not set
 # CONFIG_RESET_MESON is not set
 # CONFIG_RESET_PISTACHIO is not set
@@ -4645,10 +4671,6 @@ CONFIG_THUNDERBOLT=m
 CONFIG_NVMEM=y
 # CONFIG_STM is not set
 # CONFIG_INTEL_TH is not set
-
-#
-# FPGA Configuration Support
-#
 # CONFIG_FPGA is not set
 
 #
@@ -4682,6 +4704,7 @@ CONFIG_EFI_RUNTIME_WRAPPERS=y
 # CONFIG_EFI_CAPSULE_LOADER is not set
 # CONFIG_EFI_TEST is not set
 CONFIG_APPLE_PROPERTIES=y
+# CONFIG_RESET_ATTACK_MITIGATION is not set
 CONFIG_EFI_DEV_PATH_PARSER=y
 
 #
@@ -4823,6 +4846,7 @@ CONFIG_SQUASHFS_ZLIB=y
 CONFIG_SQUASHFS_LZ4=y
 CONFIG_SQUASHFS_LZO=y
 CONFIG_SQUASHFS_XZ=y
+CONFIG_SQUASHFS_ZSTD=y
 # CONFIG_SQUASHFS_4K_DEVBLK_SIZE is not set
 # CONFIG_SQUASHFS_EMBEDDED is not set
 CONFIG_SQUASHFS_FRAGMENT_CACHE_SIZE=3
@@ -4959,8 +4983,7 @@ CONFIG_DEBUG_FS=y
 # CONFIG_HEADERS_CHECK is not set
 # CONFIG_DEBUG_SECTION_MISMATCH is not set
 CONFIG_SECTION_MISMATCH_WARN_ONLY=y
-CONFIG_ARCH_WANT_FRAME_POINTERS=y
-# CONFIG_FRAME_POINTER is not set
+CONFIG_FRAME_POINTER=y
 # CONFIG_STACK_VALIDATION is not set
 # CONFIG_DEBUG_FORCE_WEAK_PER_CPU is not set
 CONFIG_MAGIC_SYSRQ=y
@@ -5181,6 +5204,9 @@ CONFIG_OPTIMIZE_INLINING=y
 # CONFIG_DEBUG_NMI_SELFTEST is not set
 CONFIG_X86_DEBUG_FPU=y
 # CONFIG_PUNIT_ATOM_DEBUG is not set
+CONFIG_FRAME_POINTER_UNWINDER=y
+# CONFIG_ORC_UNWINDER is not set
+# CONFIG_GUESS_UNWINDER is not set
 
 #
 # Security options
@@ -5400,6 +5426,7 @@ CONFIG_CRC32_SLICEBY8=y
 # CONFIG_CRC7 is not set
 CONFIG_LIBCRC32C=m
 # CONFIG_CRC8 is not set
+CONFIG_XXHASH=y
 # CONFIG_AUDIT_ARCH_COMPAT_GENERIC is not set
 # CONFIG_RANDOM32_SELFTEST is not set
 CONFIG_ZLIB_INFLATE=y
@@ -5407,6 +5434,8 @@ CONFIG_ZLIB_DEFLATE=y
 CONFIG_LZO_COMPRESS=y
 CONFIG_LZO_DECOMPRESS=y
 CONFIG_LZ4_DECOMPRESS=y
+CONFIG_ZSTD_COMPRESS=y
+CONFIG_ZSTD_DECOMPRESS=y
 CONFIG_XZ_DEC=y
 # CONFIG_XZ_DEC_X86 is not set
 # CONFIG_XZ_DEC_POWERPC is not set
@@ -5445,5 +5474,5 @@ CONFIG_SG_POOL=y
 CONFIG_ARCH_HAS_SG_CHAIN=y
 CONFIG_ARCH_HAS_PMEM_API=y
 CONFIG_ARCH_HAS_UACCESS_FLUSHCACHE=y
-CONFIG_ARCH_HAS_MMIO_FLUSH=y
 CONFIG_SBITMAP=y
+# CONFIG_STRING_SELFTEST is not set
diff --git a/projects/RPi/devices/RPi/linux/linux.arm.conf b/projects/RPi/devices/RPi/linux/linux.arm.conf
index 839c0a7c84c..842eea2ed2a 100644
--- a/projects/RPi/devices/RPi/linux/linux.arm.conf
+++ b/projects/RPi/devices/RPi/linux/linux.arm.conf
@@ -1,6 +1,6 @@
 #
 # Automatically generated file; DO NOT EDIT.
-# Linux/arm 4.13.0 Kernel Configuration
+# Linux/arm 4.14.0-rc1 Kernel Configuration
 #
 CONFIG_ARM=y
 CONFIG_ARM_HAS_SG_CHAIN=y
@@ -169,6 +169,7 @@ CONFIG_BUG=y
 CONFIG_ELF_CORE=y
 CONFIG_BASE_FULL=y
 CONFIG_FUTEX=y
+CONFIG_FUTEX_PI=y
 CONFIG_EPOLL=y
 CONFIG_SIGNALFD=y
 CONFIG_TIMERFD=y
@@ -197,6 +198,7 @@ CONFIG_SLUB=y
 # CONFIG_SLOB is not set
 CONFIG_SLAB_MERGE_DEFAULT=y
 # CONFIG_SLAB_FREELIST_RANDOM is not set
+# CONFIG_SLAB_FREELIST_HARDENED is not set
 # CONFIG_SYSTEM_DATA_VERIFICATION is not set
 # CONFIG_PROFILING is not set
 CONFIG_TRACEPOINTS=y
@@ -566,7 +568,6 @@ CONFIG_CPU_FREQ_GOV_ONDEMAND=y
 # CPU frequency scaling drivers
 #
 # CONFIG_CPUFREQ_DT is not set
-# CONFIG_ARM_DB8500_CPUFREQ is not set
 # CONFIG_ARM_KIRKWOOD_CPUFREQ is not set
 CONFIG_ARM_BCM2835_CPUFREQ=y
 # CONFIG_QORIQ_CPUFREQ is not set
@@ -713,7 +714,6 @@ CONFIG_IPV6_NDISC_NODETYPE=y
 # CONFIG_NET_PTP_CLASSIFY is not set
 # CONFIG_NETWORK_PHY_TIMESTAMPING is not set
 CONFIG_NETFILTER=y
-# CONFIG_NETFILTER_DEBUG is not set
 CONFIG_NETFILTER_ADVANCED=y
 CONFIG_BRIDGE_NETFILTER=m
 
@@ -983,6 +983,7 @@ CONFIG_DNS_RESOLVER=y
 # CONFIG_VSOCKETS is not set
 # CONFIG_NETLINK_DIAG is not set
 # CONFIG_MPLS is not set
+# CONFIG_NET_NSH is not set
 # CONFIG_HSR is not set
 # CONFIG_NET_SWITCHDEV is not set
 # CONFIG_NET_L3_MASTER_DEV is not set
@@ -1001,7 +1002,6 @@ CONFIG_BQL=y
 # CONFIG_NET_DROP_MONITOR is not set
 # CONFIG_HAMRADIO is not set
 # CONFIG_CAN is not set
-# CONFIG_IRDA is not set
 CONFIG_BT=m
 CONFIG_BT_BREDR=y
 CONFIG_BT_RFCOMM=m
@@ -1013,6 +1013,7 @@ CONFIG_BT_LE=y
 # CONFIG_BT_LEDS is not set
 # CONFIG_BT_SELFTEST is not set
 # CONFIG_BT_DEBUGFS is not set
+CONFIG_BT_LEGACY_IOCTL=y
 
 #
 # Bluetooth device drivers
@@ -1030,7 +1031,6 @@ CONFIG_BT_HCIUART_H4=y
 # CONFIG_BT_HCIUART_ATH3K is not set
 CONFIG_BT_HCIUART_3WIRE=y
 # CONFIG_BT_HCIUART_INTEL is not set
-CONFIG_BT_HCIUART_BCM=y
 # CONFIG_BT_HCIUART_QCA is not set
 # CONFIG_BT_HCIUART_AG6XX is not set
 # CONFIG_BT_HCIUART_MRVL is not set
@@ -1088,7 +1088,7 @@ CONFIG_DST_CACHE=y
 CONFIG_GRO_CELLS=y
 # CONFIG_NET_DEVLINK is not set
 CONFIG_MAY_USE_DEVLINK=y
-CONFIG_HAVE_CBPF_JIT=y
+CONFIG_HAVE_EBPF_JIT=y
 
 #
 # Device Drivers
@@ -1367,6 +1367,7 @@ CONFIG_FIXED_PHY=y
 # CONFIG_NATIONAL_PHY is not set
 # CONFIG_QSEMI_PHY is not set
 # CONFIG_REALTEK_PHY is not set
+# CONFIG_ROCKCHIP_PHY is not set
 # CONFIG_SMSC_PHY is not set
 # CONFIG_STE10XP is not set
 # CONFIG_TERANETICS_PHY is not set
@@ -1728,6 +1729,7 @@ CONFIG_SERIO_SERPORT=y
 # CONFIG_SERIO_PS2MULT is not set
 # CONFIG_SERIO_ARC_PS2 is not set
 # CONFIG_SERIO_APBPS2 is not set
+# CONFIG_SERIO_GPIO_PS2 is not set
 # CONFIG_USERIO is not set
 # CONFIG_GAMEPORT is not set
 
@@ -1933,6 +1935,7 @@ CONFIG_PINCTRL_BCM2835=y
 CONFIG_ARCH_HAVE_CUSTOM_GPIO_H=y
 CONFIG_GPIOLIB=y
 CONFIG_OF_GPIO=y
+CONFIG_GPIOLIB_IRQCHIP=y
 # CONFIG_DEBUG_GPIO is not set
 CONFIG_GPIO_SYSFS=y
 
@@ -2003,6 +2006,7 @@ CONFIG_W1_SLAVE_THERM=m
 # CONFIG_W1_SLAVE_DS2413 is not set
 # CONFIG_W1_SLAVE_DS2406 is not set
 # CONFIG_W1_SLAVE_DS2423 is not set
+# CONFIG_W1_SLAVE_DS2805 is not set
 # CONFIG_W1_SLAVE_DS2431 is not set
 # CONFIG_W1_SLAVE_DS2433 is not set
 # CONFIG_W1_SLAVE_DS2438 is not set
@@ -2010,7 +2014,6 @@ CONFIG_W1_SLAVE_THERM=m
 # CONFIG_W1_SLAVE_DS2780 is not set
 # CONFIG_W1_SLAVE_DS2781 is not set
 # CONFIG_W1_SLAVE_DS28E04 is not set
-# CONFIG_W1_SLAVE_BQ27000 is not set
 # CONFIG_POWER_AVS is not set
 CONFIG_POWER_RESET=y
 # CONFIG_POWER_RESET_BRCMKONA is not set
@@ -2032,6 +2035,7 @@ CONFIG_POWER_SUPPLY=y
 # CONFIG_BATTERY_BQ27XXX is not set
 # CONFIG_BATTERY_MAX17040 is not set
 # CONFIG_BATTERY_MAX17042 is not set
+# CONFIG_BATTERY_MAX1721X is not set
 # CONFIG_CHARGER_MAX8903 is not set
 # CONFIG_CHARGER_LP8727 is not set
 # CONFIG_CHARGER_GPIO is not set
@@ -2243,10 +2247,6 @@ CONFIG_SSB_SDIOHOST_POSSIBLE=y
 # CONFIG_SSB_DEBUG is not set
 # CONFIG_SSB_DRIVER_GPIO is not set
 CONFIG_BCMA_POSSIBLE=y
-
-#
-# Broadcom specific AMBA
-#
 CONFIG_BCMA=m
 CONFIG_BCMA_BLOCKIO=y
 # CONFIG_BCMA_HOST_SOC is not set
@@ -2267,6 +2267,7 @@ CONFIG_MFD_CORE=y
 # CONFIG_MFD_ATMEL_FLEXCOM is not set
 # CONFIG_MFD_ATMEL_HLCDC is not set
 # CONFIG_MFD_BCM590XX is not set
+# CONFIG_MFD_BD9571MWV is not set
 # CONFIG_MFD_AXP20X_I2C is not set
 # CONFIG_MFD_CROS_EC is not set
 # CONFIG_MFD_ASIC3 is not set
@@ -2396,6 +2397,36 @@ CONFIG_REGULATOR_ARIZONA_MICSUPP=m
 # CONFIG_REGULATOR_TPS65132 is not set
 # CONFIG_REGULATOR_TPS6524X is not set
 # CONFIG_REGULATOR_VCTRL is not set
+CONFIG_RC_CORE=m
+CONFIG_RC_MAP=m
+CONFIG_RC_DECODERS=y
+CONFIG_LIRC=m
+CONFIG_IR_LIRC_CODEC=m
+CONFIG_IR_NEC_DECODER=m
+CONFIG_IR_RC5_DECODER=m
+CONFIG_IR_RC6_DECODER=m
+CONFIG_IR_JVC_DECODER=m
+CONFIG_IR_SONY_DECODER=m
+CONFIG_IR_SANYO_DECODER=m
+CONFIG_IR_SHARP_DECODER=m
+CONFIG_IR_MCE_KBD_DECODER=m
+CONFIG_IR_XMP_DECODER=m
+CONFIG_RC_DEVICES=y
+CONFIG_RC_ATI_REMOTE=m
+# CONFIG_IR_HIX5HD2 is not set
+CONFIG_IR_IMON=m
+CONFIG_IR_MCEUSB=m
+CONFIG_IR_REDRAT3=m
+# CONFIG_IR_SPI is not set
+CONFIG_IR_STREAMZAP=m
+CONFIG_IR_IGORPLUGUSB=m
+CONFIG_IR_IGUANA=m
+CONFIG_IR_TTUSBIR=m
+# CONFIG_RC_LOOPBACK is not set
+CONFIG_IR_GPIO_CIR=m
+# CONFIG_IR_GPIO_TX is not set
+# CONFIG_IR_SERIAL is not set
+# CONFIG_IR_SIR is not set
 CONFIG_MEDIA_SUPPORT=m
 
 #
@@ -2406,7 +2437,6 @@ CONFIG_MEDIA_ANALOG_TV_SUPPORT=y
 CONFIG_MEDIA_DIGITAL_TV_SUPPORT=y
 CONFIG_MEDIA_RADIO_SUPPORT=y
 # CONFIG_MEDIA_SDR_SUPPORT is not set
-CONFIG_MEDIA_RC_SUPPORT=y
 # CONFIG_MEDIA_CEC_SUPPORT is not set
 # CONFIG_MEDIA_CONTROLLER is not set
 CONFIG_VIDEO_DEV=m
@@ -2430,35 +2460,6 @@ CONFIG_DVB_MAX_ADAPTERS=8
 #
 # Media drivers
 #
-CONFIG_RC_CORE=m
-CONFIG_RC_MAP=m
-CONFIG_RC_DECODERS=y
-CONFIG_LIRC=m
-CONFIG_IR_LIRC_CODEC=m
-CONFIG_IR_NEC_DECODER=m
-CONFIG_IR_RC5_DECODER=m
-CONFIG_IR_RC6_DECODER=m
-CONFIG_IR_JVC_DECODER=m
-CONFIG_IR_SONY_DECODER=m
-CONFIG_IR_SANYO_DECODER=m
-CONFIG_IR_SHARP_DECODER=m
-CONFIG_IR_MCE_KBD_DECODER=m
-CONFIG_IR_XMP_DECODER=m
-CONFIG_RC_DEVICES=y
-CONFIG_RC_ATI_REMOTE=m
-# CONFIG_IR_HIX5HD2 is not set
-CONFIG_IR_IMON=m
-CONFIG_IR_MCEUSB=m
-CONFIG_IR_REDRAT3=m
-# CONFIG_IR_SPI is not set
-CONFIG_IR_STREAMZAP=m
-CONFIG_IR_IGORPLUGUSB=m
-CONFIG_IR_IGUANA=m
-CONFIG_IR_TTUSBIR=m
-# CONFIG_RC_LOOPBACK is not set
-CONFIG_IR_GPIO_CIR=m
-# CONFIG_IR_SERIAL is not set
-# CONFIG_IR_SIR is not set
 CONFIG_MEDIA_USB_SUPPORT=y
 
 #
@@ -2874,6 +2875,7 @@ CONFIG_DRM_PANEL_BRIDGE=y
 # CONFIG_DRM_I2C_ADV7511 is not set
 # CONFIG_DRM_STI is not set
 CONFIG_DRM_VC4=m
+# CONFIG_DRM_VC4_HDMI_CEC is not set
 # CONFIG_DRM_ARCPGU is not set
 # CONFIG_DRM_MXSFB is not set
 # CONFIG_DRM_TINYDRM is not set
@@ -3099,6 +3101,7 @@ CONFIG_SND_SOC_CS4265=m
 # CONFIG_SND_SOC_CS4271_SPI is not set
 CONFIG_SND_SOC_CS42XX8=m
 CONFIG_SND_SOC_CS42XX8_I2C=m
+# CONFIG_SND_SOC_CS43130 is not set
 # CONFIG_SND_SOC_CS4349 is not set
 # CONFIG_SND_SOC_CS53L30 is not set
 # CONFIG_SND_SOC_DIO2125 is not set
@@ -3149,6 +3152,7 @@ CONFIG_SND_SOC_TAS5713=m
 CONFIG_SND_SOC_WM5102=m
 # CONFIG_SND_SOC_WM8510 is not set
 # CONFIG_SND_SOC_WM8523 is not set
+# CONFIG_SND_SOC_WM8524 is not set
 # CONFIG_SND_SOC_WM8580 is not set
 # CONFIG_SND_SOC_WM8711 is not set
 # CONFIG_SND_SOC_WM8728 is not set
@@ -3474,7 +3478,6 @@ CONFIG_USB_SERIAL_PL2303=m
 # CONFIG_USB_ULPI_BUS is not set
 # CONFIG_UWB is not set
 CONFIG_MMC=y
-# CONFIG_MMC_DEBUG is not set
 CONFIG_PWRSEQ_EMMC=y
 CONFIG_PWRSEQ_SIMPLE=y
 CONFIG_MMC_BLOCK=y
@@ -3489,6 +3492,7 @@ CONFIG_MMC_BCM2835_MMC=y
 CONFIG_MMC_BCM2835_DMA=y
 CONFIG_MMC_BCM2835_PIO_DMA_BARRIER=2
 CONFIG_MMC_BCM2835_SDHOST=y
+# CONFIG_MMC_DEBUG is not set
 # CONFIG_MMC_ARMMMCI is not set
 CONFIG_MMC_SDHCI=y
 CONFIG_MMC_SDHCI_PLTFM=y
@@ -3516,6 +3520,7 @@ CONFIG_LEDS_CLASS_FLASH=y
 # LED drivers
 #
 # CONFIG_LEDS_AAT1290 is not set
+# CONFIG_LEDS_AS3645A is not set
 # CONFIG_LEDS_BCM6328 is not set
 # CONFIG_LEDS_BCM6358 is not set
 # CONFIG_LEDS_LM3530 is not set
@@ -3687,6 +3692,7 @@ CONFIG_DMADEVICES=y
 CONFIG_DMA_ENGINE=y
 CONFIG_DMA_VIRTUAL_CHANNELS=y
 CONFIG_DMA_OF=y
+# CONFIG_ALTERA_MSGDMA is not set
 # CONFIG_AMBA_PL08X is not set
 CONFIG_DMA_BCM2835=y
 # CONFIG_FSL_EDMA is not set
@@ -3723,6 +3729,7 @@ CONFIG_SYNC_FILE=y
 #
 # CONFIG_HYPERV_TSCPAGE is not set
 CONFIG_STAGING=y
+# CONFIG_IRDA is not set
 # CONFIG_PRISM2_USB is not set
 # CONFIG_COMEDI is not set
 # CONFIG_RTLLIB is not set
@@ -3762,6 +3769,7 @@ CONFIG_SND_BCM2835=m
 # USB Power Delivery and Type-C drivers
 #
 # CONFIG_TYPEC_TCPM is not set
+# CONFIG_PI433 is not set
 # CONFIG_GOLDFISH is not set
 # CONFIG_CHROME_PLATFORMS is not set
 CONFIG_CLKDEV_LOOKUP=y
@@ -3771,6 +3779,7 @@ CONFIG_COMMON_CLK=y
 #
 # Common Clock Framework
 #
+# CONFIG_CLK_HSDK is not set
 # CONFIG_COMMON_CLK_SI5351 is not set
 # CONFIG_COMMON_CLK_SI514 is not set
 # CONFIG_COMMON_CLK_SI570 is not set
@@ -3821,6 +3830,10 @@ CONFIG_BCM2835_MBOX=y
 #
 
 #
+# Amlogic SoC drivers
+#
+
+#
 # Broadcom SoC drivers
 #
 CONFIG_RASPBERRYPI_POWER=y
@@ -3829,6 +3842,10 @@ CONFIG_RASPBERRYPI_POWER=y
 #
 # i.MX SoC drivers
 #
+
+#
+# Qualcomm SoC drivers
+#
 # CONFIG_SUNXI_SRAM is not set
 # CONFIG_SOC_TI is not set
 # CONFIG_PM_DEVFREQ is not set
@@ -3852,8 +3869,9 @@ CONFIG_ARM_GIC_MAX_NR=1
 CONFIG_RESET_CONTROLLER=y
 # CONFIG_RESET_ATH79 is not set
 # CONFIG_RESET_BERLIN is not set
-# CONFIG_RESET_GEMINI is not set
+# CONFIG_RESET_HSDK_V1 is not set
 # CONFIG_RESET_IMX7 is not set
+# CONFIG_RESET_LANTIQ is not set
 # CONFIG_RESET_LPC18XX is not set
 # CONFIG_RESET_MESON is not set
 # CONFIG_RESET_PISTACHIO is not set
@@ -3884,10 +3902,6 @@ CONFIG_RESET_CONTROLLER=y
 CONFIG_NVMEM=y
 # CONFIG_STM is not set
 # CONFIG_INTEL_TH is not set
-
-#
-# FPGA Configuration Support
-#
 # CONFIG_FPGA is not set
 
 #
@@ -4040,6 +4054,7 @@ CONFIG_SQUASHFS_ZLIB=y
 CONFIG_SQUASHFS_LZ4=y
 CONFIG_SQUASHFS_LZO=y
 CONFIG_SQUASHFS_XZ=y
+CONFIG_SQUASHFS_ZSTD=y
 # CONFIG_SQUASHFS_4K_DEVBLK_SIZE is not set
 # CONFIG_SQUASHFS_EMBEDDED is not set
 CONFIG_SQUASHFS_FRAGMENT_CACHE_SIZE=3
@@ -4538,6 +4553,7 @@ CONFIG_CRC32_SLICEBY8=y
 # CONFIG_CRC7 is not set
 CONFIG_LIBCRC32C=m
 # CONFIG_CRC8 is not set
+CONFIG_XXHASH=y
 # CONFIG_AUDIT_ARCH_COMPAT_GENERIC is not set
 # CONFIG_RANDOM32_SELFTEST is not set
 CONFIG_ZLIB_INFLATE=y
@@ -4545,6 +4561,8 @@ CONFIG_ZLIB_DEFLATE=m
 CONFIG_LZO_COMPRESS=m
 CONFIG_LZO_DECOMPRESS=y
 CONFIG_LZ4_DECOMPRESS=y
+CONFIG_ZSTD_COMPRESS=m
+CONFIG_ZSTD_DECOMPRESS=y
 CONFIG_XZ_DEC=y
 # CONFIG_XZ_DEC_X86 is not set
 # CONFIG_XZ_DEC_POWERPC is not set
@@ -4579,4 +4597,5 @@ CONFIG_FONT_8x16=y
 CONFIG_SG_POOL=y
 CONFIG_ARCH_HAS_SG_CHAIN=y
 CONFIG_SBITMAP=y
+# CONFIG_STRING_SELFTEST is not set
 # CONFIG_VIRTUALIZATION is not set
diff --git a/projects/RPi/devices/RPi2/linux/linux.arm.conf b/projects/RPi/devices/RPi2/linux/linux.arm.conf
index de511e3c2c9..d55270e56ae 100644
--- a/projects/RPi/devices/RPi2/linux/linux.arm.conf
+++ b/projects/RPi/devices/RPi2/linux/linux.arm.conf
@@ -1,6 +1,6 @@
 #
 # Automatically generated file; DO NOT EDIT.
-# Linux/arm 4.13.0 Kernel Configuration
+# Linux/arm 4.14.0-rc1 Kernel Configuration
 #
 CONFIG_ARM=y
 CONFIG_ARM_HAS_SG_CHAIN=y
@@ -175,6 +175,7 @@ CONFIG_BUG=y
 CONFIG_ELF_CORE=y
 CONFIG_BASE_FULL=y
 CONFIG_FUTEX=y
+CONFIG_FUTEX_PI=y
 CONFIG_EPOLL=y
 CONFIG_SIGNALFD=y
 CONFIG_TIMERFD=y
@@ -203,6 +204,7 @@ CONFIG_SLUB=y
 # CONFIG_SLOB is not set
 CONFIG_SLAB_MERGE_DEFAULT=y
 # CONFIG_SLAB_FREELIST_RANDOM is not set
+# CONFIG_SLAB_FREELIST_HARDENED is not set
 CONFIG_SLUB_CPU_PARTIAL=y
 # CONFIG_SYSTEM_DATA_VERIFICATION is not set
 # CONFIG_PROFILING is not set
@@ -649,7 +651,6 @@ CONFIG_CPU_FREQ_GOV_ONDEMAND=y
 #
 # CONFIG_CPUFREQ_DT is not set
 # CONFIG_ARM_BIG_LITTLE_CPUFREQ is not set
-# CONFIG_ARM_DB8500_CPUFREQ is not set
 # CONFIG_ARM_KIRKWOOD_CPUFREQ is not set
 CONFIG_ARM_BCM2835_CPUFREQ=y
 # CONFIG_QORIQ_CPUFREQ is not set
@@ -799,7 +800,6 @@ CONFIG_IPV6_NDISC_NODETYPE=y
 # CONFIG_NET_PTP_CLASSIFY is not set
 # CONFIG_NETWORK_PHY_TIMESTAMPING is not set
 CONFIG_NETFILTER=y
-# CONFIG_NETFILTER_DEBUG is not set
 CONFIG_NETFILTER_ADVANCED=y
 CONFIG_BRIDGE_NETFILTER=m
 
@@ -1069,6 +1069,7 @@ CONFIG_DNS_RESOLVER=y
 # CONFIG_VSOCKETS is not set
 # CONFIG_NETLINK_DIAG is not set
 # CONFIG_MPLS is not set
+# CONFIG_NET_NSH is not set
 # CONFIG_HSR is not set
 # CONFIG_NET_SWITCHDEV is not set
 # CONFIG_NET_L3_MASTER_DEV is not set
@@ -1091,7 +1092,6 @@ CONFIG_NET_FLOW_LIMIT=y
 # CONFIG_NET_DROP_MONITOR is not set
 # CONFIG_HAMRADIO is not set
 # CONFIG_CAN is not set
-# CONFIG_IRDA is not set
 CONFIG_BT=m
 CONFIG_BT_BREDR=y
 CONFIG_BT_RFCOMM=m
@@ -1103,6 +1103,7 @@ CONFIG_BT_LE=y
 # CONFIG_BT_LEDS is not set
 # CONFIG_BT_SELFTEST is not set
 # CONFIG_BT_DEBUGFS is not set
+CONFIG_BT_LEGACY_IOCTL=y
 
 #
 # Bluetooth device drivers
@@ -1120,7 +1121,6 @@ CONFIG_BT_HCIUART_H4=y
 # CONFIG_BT_HCIUART_ATH3K is not set
 CONFIG_BT_HCIUART_3WIRE=y
 # CONFIG_BT_HCIUART_INTEL is not set
-CONFIG_BT_HCIUART_BCM=y
 # CONFIG_BT_HCIUART_QCA is not set
 # CONFIG_BT_HCIUART_AG6XX is not set
 # CONFIG_BT_HCIUART_MRVL is not set
@@ -1178,7 +1178,7 @@ CONFIG_DST_CACHE=y
 CONFIG_GRO_CELLS=y
 # CONFIG_NET_DEVLINK is not set
 CONFIG_MAY_USE_DEVLINK=y
-CONFIG_HAVE_CBPF_JIT=y
+CONFIG_HAVE_EBPF_JIT=y
 
 #
 # Device Drivers
@@ -1458,6 +1458,7 @@ CONFIG_FIXED_PHY=y
 # CONFIG_NATIONAL_PHY is not set
 # CONFIG_QSEMI_PHY is not set
 # CONFIG_REALTEK_PHY is not set
+# CONFIG_ROCKCHIP_PHY is not set
 # CONFIG_SMSC_PHY is not set
 # CONFIG_STE10XP is not set
 # CONFIG_TERANETICS_PHY is not set
@@ -1819,6 +1820,7 @@ CONFIG_SERIO_SERPORT=y
 # CONFIG_SERIO_PS2MULT is not set
 # CONFIG_SERIO_ARC_PS2 is not set
 # CONFIG_SERIO_APBPS2 is not set
+# CONFIG_SERIO_GPIO_PS2 is not set
 # CONFIG_USERIO is not set
 # CONFIG_GAMEPORT is not set
 
@@ -2024,6 +2026,7 @@ CONFIG_PINCTRL_BCM2835=y
 CONFIG_ARCH_HAVE_CUSTOM_GPIO_H=y
 CONFIG_GPIOLIB=y
 CONFIG_OF_GPIO=y
+CONFIG_GPIOLIB_IRQCHIP=y
 # CONFIG_DEBUG_GPIO is not set
 CONFIG_GPIO_SYSFS=y
 
@@ -2095,6 +2098,7 @@ CONFIG_W1_SLAVE_THERM=m
 # CONFIG_W1_SLAVE_DS2413 is not set
 # CONFIG_W1_SLAVE_DS2406 is not set
 # CONFIG_W1_SLAVE_DS2423 is not set
+# CONFIG_W1_SLAVE_DS2805 is not set
 # CONFIG_W1_SLAVE_DS2431 is not set
 # CONFIG_W1_SLAVE_DS2433 is not set
 # CONFIG_W1_SLAVE_DS2438 is not set
@@ -2102,7 +2106,6 @@ CONFIG_W1_SLAVE_THERM=m
 # CONFIG_W1_SLAVE_DS2780 is not set
 # CONFIG_W1_SLAVE_DS2781 is not set
 # CONFIG_W1_SLAVE_DS28E04 is not set
-# CONFIG_W1_SLAVE_BQ27000 is not set
 # CONFIG_POWER_AVS is not set
 CONFIG_POWER_RESET=y
 # CONFIG_POWER_RESET_BRCMKONA is not set
@@ -2127,6 +2130,7 @@ CONFIG_POWER_SUPPLY=y
 # CONFIG_BATTERY_BQ27XXX is not set
 # CONFIG_BATTERY_MAX17040 is not set
 # CONFIG_BATTERY_MAX17042 is not set
+# CONFIG_BATTERY_MAX1721X is not set
 # CONFIG_CHARGER_MAX8903 is not set
 # CONFIG_CHARGER_LP8727 is not set
 # CONFIG_CHARGER_GPIO is not set
@@ -2338,10 +2342,6 @@ CONFIG_SSB_SDIOHOST_POSSIBLE=y
 # CONFIG_SSB_DEBUG is not set
 # CONFIG_SSB_DRIVER_GPIO is not set
 CONFIG_BCMA_POSSIBLE=y
-
-#
-# Broadcom specific AMBA
-#
 CONFIG_BCMA=m
 CONFIG_BCMA_BLOCKIO=y
 # CONFIG_BCMA_HOST_SOC is not set
@@ -2362,6 +2362,7 @@ CONFIG_MFD_CORE=y
 # CONFIG_MFD_ATMEL_FLEXCOM is not set
 # CONFIG_MFD_ATMEL_HLCDC is not set
 # CONFIG_MFD_BCM590XX is not set
+# CONFIG_MFD_BD9571MWV is not set
 # CONFIG_MFD_AXP20X_I2C is not set
 # CONFIG_MFD_CROS_EC is not set
 # CONFIG_MFD_ASIC3 is not set
@@ -2492,6 +2493,36 @@ CONFIG_REGULATOR_ARIZONA_MICSUPP=m
 # CONFIG_REGULATOR_TPS65132 is not set
 # CONFIG_REGULATOR_TPS6524X is not set
 # CONFIG_REGULATOR_VCTRL is not set
+CONFIG_RC_CORE=m
+CONFIG_RC_MAP=m
+CONFIG_RC_DECODERS=y
+CONFIG_LIRC=m
+CONFIG_IR_LIRC_CODEC=m
+CONFIG_IR_NEC_DECODER=m
+CONFIG_IR_RC5_DECODER=m
+CONFIG_IR_RC6_DECODER=m
+CONFIG_IR_JVC_DECODER=m
+CONFIG_IR_SONY_DECODER=m
+CONFIG_IR_SANYO_DECODER=m
+CONFIG_IR_SHARP_DECODER=m
+CONFIG_IR_MCE_KBD_DECODER=m
+CONFIG_IR_XMP_DECODER=m
+CONFIG_RC_DEVICES=y
+CONFIG_RC_ATI_REMOTE=m
+# CONFIG_IR_HIX5HD2 is not set
+CONFIG_IR_IMON=m
+CONFIG_IR_MCEUSB=m
+CONFIG_IR_REDRAT3=m
+# CONFIG_IR_SPI is not set
+CONFIG_IR_STREAMZAP=m
+CONFIG_IR_IGORPLUGUSB=m
+CONFIG_IR_IGUANA=m
+CONFIG_IR_TTUSBIR=m
+# CONFIG_RC_LOOPBACK is not set
+CONFIG_IR_GPIO_CIR=m
+# CONFIG_IR_GPIO_TX is not set
+# CONFIG_IR_SERIAL is not set
+# CONFIG_IR_SIR is not set
 CONFIG_MEDIA_SUPPORT=m
 
 #
@@ -2502,7 +2533,6 @@ CONFIG_MEDIA_ANALOG_TV_SUPPORT=y
 CONFIG_MEDIA_DIGITAL_TV_SUPPORT=y
 CONFIG_MEDIA_RADIO_SUPPORT=y
 # CONFIG_MEDIA_SDR_SUPPORT is not set
-CONFIG_MEDIA_RC_SUPPORT=y
 # CONFIG_MEDIA_CEC_SUPPORT is not set
 # CONFIG_MEDIA_CONTROLLER is not set
 CONFIG_VIDEO_DEV=m
@@ -2526,35 +2556,6 @@ CONFIG_DVB_MAX_ADAPTERS=8
 #
 # Media drivers
 #
-CONFIG_RC_CORE=m
-CONFIG_RC_MAP=m
-CONFIG_RC_DECODERS=y
-CONFIG_LIRC=m
-CONFIG_IR_LIRC_CODEC=m
-CONFIG_IR_NEC_DECODER=m
-CONFIG_IR_RC5_DECODER=m
-CONFIG_IR_RC6_DECODER=m
-CONFIG_IR_JVC_DECODER=m
-CONFIG_IR_SONY_DECODER=m
-CONFIG_IR_SANYO_DECODER=m
-CONFIG_IR_SHARP_DECODER=m
-CONFIG_IR_MCE_KBD_DECODER=m
-CONFIG_IR_XMP_DECODER=m
-CONFIG_RC_DEVICES=y
-CONFIG_RC_ATI_REMOTE=m
-# CONFIG_IR_HIX5HD2 is not set
-CONFIG_IR_IMON=m
-CONFIG_IR_MCEUSB=m
-CONFIG_IR_REDRAT3=m
-# CONFIG_IR_SPI is not set
-CONFIG_IR_STREAMZAP=m
-CONFIG_IR_IGORPLUGUSB=m
-CONFIG_IR_IGUANA=m
-CONFIG_IR_TTUSBIR=m
-# CONFIG_RC_LOOPBACK is not set
-CONFIG_IR_GPIO_CIR=m
-# CONFIG_IR_SERIAL is not set
-# CONFIG_IR_SIR is not set
 CONFIG_MEDIA_USB_SUPPORT=y
 
 #
@@ -2970,6 +2971,7 @@ CONFIG_DRM_PANEL_BRIDGE=y
 # CONFIG_DRM_I2C_ADV7511 is not set
 # CONFIG_DRM_STI is not set
 CONFIG_DRM_VC4=m
+# CONFIG_DRM_VC4_HDMI_CEC is not set
 # CONFIG_DRM_ARCPGU is not set
 # CONFIG_DRM_MXSFB is not set
 # CONFIG_DRM_TINYDRM is not set
@@ -3195,6 +3197,7 @@ CONFIG_SND_SOC_CS4265=m
 # CONFIG_SND_SOC_CS4271_SPI is not set
 CONFIG_SND_SOC_CS42XX8=m
 CONFIG_SND_SOC_CS42XX8_I2C=m
+# CONFIG_SND_SOC_CS43130 is not set
 # CONFIG_SND_SOC_CS4349 is not set
 # CONFIG_SND_SOC_CS53L30 is not set
 # CONFIG_SND_SOC_DIO2125 is not set
@@ -3245,6 +3248,7 @@ CONFIG_SND_SOC_TAS5713=m
 CONFIG_SND_SOC_WM5102=m
 # CONFIG_SND_SOC_WM8510 is not set
 # CONFIG_SND_SOC_WM8523 is not set
+# CONFIG_SND_SOC_WM8524 is not set
 # CONFIG_SND_SOC_WM8580 is not set
 # CONFIG_SND_SOC_WM8711 is not set
 # CONFIG_SND_SOC_WM8728 is not set
@@ -3570,7 +3574,6 @@ CONFIG_USB_SERIAL_PL2303=m
 # CONFIG_USB_ULPI_BUS is not set
 # CONFIG_UWB is not set
 CONFIG_MMC=y
-# CONFIG_MMC_DEBUG is not set
 CONFIG_PWRSEQ_EMMC=y
 CONFIG_PWRSEQ_SIMPLE=y
 CONFIG_MMC_BLOCK=y
@@ -3585,6 +3588,7 @@ CONFIG_MMC_BCM2835_MMC=y
 CONFIG_MMC_BCM2835_DMA=y
 CONFIG_MMC_BCM2835_PIO_DMA_BARRIER=2
 CONFIG_MMC_BCM2835_SDHOST=y
+# CONFIG_MMC_DEBUG is not set
 # CONFIG_MMC_ARMMMCI is not set
 CONFIG_MMC_SDHCI=y
 CONFIG_MMC_SDHCI_PLTFM=y
@@ -3612,6 +3616,7 @@ CONFIG_LEDS_CLASS_FLASH=y
 # LED drivers
 #
 # CONFIG_LEDS_AAT1290 is not set
+# CONFIG_LEDS_AS3645A is not set
 # CONFIG_LEDS_BCM6328 is not set
 # CONFIG_LEDS_BCM6358 is not set
 # CONFIG_LEDS_LM3530 is not set
@@ -3784,6 +3789,7 @@ CONFIG_DMADEVICES=y
 CONFIG_DMA_ENGINE=y
 CONFIG_DMA_VIRTUAL_CHANNELS=y
 CONFIG_DMA_OF=y
+# CONFIG_ALTERA_MSGDMA is not set
 # CONFIG_AMBA_PL08X is not set
 CONFIG_DMA_BCM2835=y
 # CONFIG_FSL_EDMA is not set
@@ -3820,6 +3826,7 @@ CONFIG_SYNC_FILE=y
 #
 # CONFIG_HYPERV_TSCPAGE is not set
 CONFIG_STAGING=y
+# CONFIG_IRDA is not set
 # CONFIG_PRISM2_USB is not set
 # CONFIG_COMEDI is not set
 # CONFIG_RTLLIB is not set
@@ -3859,6 +3866,7 @@ CONFIG_SND_BCM2835=m
 # USB Power Delivery and Type-C drivers
 #
 # CONFIG_TYPEC_TCPM is not set
+# CONFIG_PI433 is not set
 # CONFIG_GOLDFISH is not set
 # CONFIG_CHROME_PLATFORMS is not set
 CONFIG_CLKDEV_LOOKUP=y
@@ -3868,6 +3876,7 @@ CONFIG_COMMON_CLK=y
 #
 # Common Clock Framework
 #
+# CONFIG_CLK_HSDK is not set
 # CONFIG_COMMON_CLK_SI5351 is not set
 # CONFIG_COMMON_CLK_SI514 is not set
 # CONFIG_COMMON_CLK_SI570 is not set
@@ -3920,6 +3929,10 @@ CONFIG_BCM2835_MBOX=y
 #
 
 #
+# Amlogic SoC drivers
+#
+
+#
 # Broadcom SoC drivers
 #
 CONFIG_RASPBERRYPI_POWER=y
@@ -3928,6 +3941,10 @@ CONFIG_RASPBERRYPI_POWER=y
 #
 # i.MX SoC drivers
 #
+
+#
+# Qualcomm SoC drivers
+#
 # CONFIG_SUNXI_SRAM is not set
 # CONFIG_SOC_TI is not set
 # CONFIG_PM_DEVFREQ is not set
@@ -3951,8 +3968,9 @@ CONFIG_ARM_GIC_MAX_NR=1
 CONFIG_RESET_CONTROLLER=y
 # CONFIG_RESET_ATH79 is not set
 # CONFIG_RESET_BERLIN is not set
-# CONFIG_RESET_GEMINI is not set
+# CONFIG_RESET_HSDK_V1 is not set
 # CONFIG_RESET_IMX7 is not set
+# CONFIG_RESET_LANTIQ is not set
 # CONFIG_RESET_LPC18XX is not set
 # CONFIG_RESET_MESON is not set
 # CONFIG_RESET_PISTACHIO is not set
@@ -3983,10 +4001,6 @@ CONFIG_RESET_CONTROLLER=y
 CONFIG_NVMEM=y
 # CONFIG_STM is not set
 # CONFIG_INTEL_TH is not set
-
-#
-# FPGA Configuration Support
-#
 # CONFIG_FPGA is not set
 
 #
@@ -4141,6 +4155,7 @@ CONFIG_SQUASHFS_ZLIB=y
 CONFIG_SQUASHFS_LZ4=y
 CONFIG_SQUASHFS_LZO=y
 CONFIG_SQUASHFS_XZ=y
+CONFIG_SQUASHFS_ZSTD=y
 # CONFIG_SQUASHFS_4K_DEVBLK_SIZE is not set
 # CONFIG_SQUASHFS_EMBEDDED is not set
 CONFIG_SQUASHFS_FRAGMENT_CACHE_SIZE=3
@@ -4652,6 +4667,7 @@ CONFIG_CRC32_SLICEBY8=y
 # CONFIG_CRC7 is not set
 CONFIG_LIBCRC32C=m
 # CONFIG_CRC8 is not set
+CONFIG_XXHASH=y
 # CONFIG_AUDIT_ARCH_COMPAT_GENERIC is not set
 # CONFIG_RANDOM32_SELFTEST is not set
 CONFIG_ZLIB_INFLATE=y
@@ -4659,6 +4675,8 @@ CONFIG_ZLIB_DEFLATE=m
 CONFIG_LZO_COMPRESS=m
 CONFIG_LZO_DECOMPRESS=y
 CONFIG_LZ4_DECOMPRESS=y
+CONFIG_ZSTD_COMPRESS=m
+CONFIG_ZSTD_DECOMPRESS=y
 CONFIG_XZ_DEC=y
 # CONFIG_XZ_DEC_X86 is not set
 # CONFIG_XZ_DEC_POWERPC is not set
@@ -4694,4 +4712,5 @@ CONFIG_FONT_8x16=y
 CONFIG_SG_POOL=y
 CONFIG_ARCH_HAS_SG_CHAIN=y
 CONFIG_SBITMAP=y
+# CONFIG_STRING_SELFTEST is not set
 # CONFIG_VIRTUALIZATION is not set

From 42cabab7f072a95d75ca040c94ad86de7fe6a8eb Mon Sep 17 00:00:00 2001
From: MilhouseVH <milhouseVH.github@nmacleod.com>
Date: Thu, 21 Sep 2017 04:35:39 +0100
Subject: [PATCH 4/7] linux: update MCE customer code restriction in rc6 patch

---
 ...moved-MCE-customer-code-restriction-in-rc6-decode.patch | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/packages/linux/patches/default/linux-057-Removed-MCE-customer-code-restriction-in-rc6-decode.patch b/packages/linux/patches/default/linux-057-Removed-MCE-customer-code-restriction-in-rc6-decode.patch
index 6b09bc0073b..381c5825125 100644
--- a/packages/linux/patches/default/linux-057-Removed-MCE-customer-code-restriction-in-rc6-decode.patch
+++ b/packages/linux/patches/default/linux-057-Removed-MCE-customer-code-restriction-in-rc6-decode.patch
@@ -1,5 +1,7 @@
---- linux/drivers/media/rc/ir-rc6-decoder.c	2012-11-25 22:08:13.148418669 -0800
-+++ linux.patch/drivers/media/rc/ir-rc6-decoder.c	2012-11-25 22:07:48.864417975 -0800
+diff --git a/drivers/media/rc/ir-rc6-decoder.c b/drivers/media/rc/ir-rc6-decoder.c
+index 5d0d2fe..3d8cc1a 100644
+--- a/drivers/media/rc/ir-rc6-decoder.c
++++ b/drivers/media/rc/ir-rc6-decoder.c
 @@ -39,7 +39,6 @@
  #define RC6_STARTBIT_MASK	0x08	/* for the header bits */
  #define RC6_6A_MCE_TOGGLE_MASK	0x8000	/* for the body bits */
@@ -8,19 +10,19 @@
  #ifndef CHAR_BIT
  #define CHAR_BIT 8	/* Normally in <limits.h> */
  #endif
-@@ -257,14 +256,9 @@ again:
+@@ -252,14 +251,9 @@ static int ir_rc6_decode(struct rc_dev *dev, struct ir_raw_event ev)
  				toggle = 0;
  				break;
  			case 32:
 -				if ((scancode & RC6_6A_LCC_MASK) == RC6_6A_MCE_CC) {
--					protocol = RC_TYPE_RC6_MCE;
+-					protocol = RC_PROTO_RC6_MCE;
 -					toggle = !!(scancode & RC6_6A_MCE_TOGGLE_MASK);
 -					scancode &= ~RC6_6A_MCE_TOGGLE_MASK;
 -				} else {
--					protocol = RC_TYPE_RC6_6A_32;
+-					protocol = RC_PROTO_RC6_6A_32;
 -					toggle = 0;
 -				}
-+				protocol = RC_TYPE_RC6_MCE;
++				protocol = RC_PROTO_RC6_MCE;
 +				toggle = !!(scancode & RC6_6A_MCE_TOGGLE_MASK);
 +				scancode &= ~RC6_6A_MCE_TOGGLE_MASK;
  				break;

From 829d4cefaeaec98a2964546b7b5f2cd0bf64bfd6 Mon Sep 17 00:00:00 2001
From: MilhouseVH <milhouseVH.github@nmacleod.com>
Date: Thu, 21 Sep 2017 04:35:39 +0100
Subject: [PATCH 5/7] linux: fix GPL licence issue in kernel breaking
 xf86-video-nvidia

https://lkml.org/lkml/2017/9/15/499
---
 ...ACPI_HANDLE-encapsulate-fwnode_operations.patch | 68 ++++++++++++++++++++++
 1 file changed, 68 insertions(+)
 create mode 100644 packages/linux/patches/default/linux-999-unbreak-ACPI_HANDLE-encapsulate-fwnode_operations.patch

diff --git a/packages/linux/patches/default/linux-999-unbreak-ACPI_HANDLE-encapsulate-fwnode_operations.patch b/packages/linux/patches/default/linux-999-unbreak-ACPI_HANDLE-encapsulate-fwnode_operations.patch
new file mode 100644
index 00000000000..d83ba025f63
--- /dev/null
+++ b/packages/linux/patches/default/linux-999-unbreak-ACPI_HANDLE-encapsulate-fwnode_operations.patch
@@ -0,0 +1,68 @@
+---
+ drivers/acpi/property.c | 13 +++++++++++++
+ include/acpi/acpi_bus.h | 18 ++++--------------
+ 2 files changed, 17 insertions(+), 14 deletions(-)
+
+diff --git a/drivers/acpi/property.c b/drivers/acpi/property.c
+index c1c216163de3..1e3c2517a1ac 100644
+--- a/drivers/acpi/property.c
++++ b/drivers/acpi/property.c
+@@ -1293,3 +1293,16 @@ static int acpi_fwnode_graph_parse_endpoint(const struct fwnode_handle *fwnode,
+ DECLARE_ACPI_FWNODE_OPS(acpi_device_fwnode_ops);
+ DECLARE_ACPI_FWNODE_OPS(acpi_data_fwnode_ops);
+ const struct fwnode_operations acpi_static_fwnode_ops;
++
++bool is_acpi_device_node(const struct fwnode_handle *fwnode)
++{
++	return !IS_ERR_OR_NULL(fwnode) &&
++		fwnode->ops == &acpi_device_fwnode_ops;
++}
++EXPORT_SYMBOL(is_acpi_device_node);
++
++bool is_acpi_data_node(const struct fwnode_handle *fwnode)
++{
++	return !IS_ERR_OR_NULL(fwnode) && fwnode->ops == &acpi_data_fwnode_ops;
++}
++EXPORT_SYMBOL(is_acpi_data_node);
+diff --git a/include/acpi/acpi_bus.h b/include/acpi/acpi_bus.h
+index dedf9d789166..fa1505292f6c 100644
+--- a/include/acpi/acpi_bus.h
++++ b/include/acpi/acpi_bus.h
+@@ -399,17 +399,12 @@ extern const struct fwnode_operations acpi_device_fwnode_ops;
+ extern const struct fwnode_operations acpi_data_fwnode_ops;
+ extern const struct fwnode_operations acpi_static_fwnode_ops;
+ 
++bool is_acpi_device_node(const struct fwnode_handle *fwnode);
++bool is_acpi_data_node(const struct fwnode_handle *fwnode);
++
+ static inline bool is_acpi_node(const struct fwnode_handle *fwnode)
+ {
+-	return !IS_ERR_OR_NULL(fwnode) &&
+-		(fwnode->ops == &acpi_device_fwnode_ops
+-		 || fwnode->ops == &acpi_data_fwnode_ops);
+-}
+-
+-static inline bool is_acpi_device_node(const struct fwnode_handle *fwnode)
+-{
+-	return !IS_ERR_OR_NULL(fwnode) &&
+-		fwnode->ops == &acpi_device_fwnode_ops;
++	return (is_acpi_device_node(fwnode) || is_acpi_data_node(fwnode));
+ }
+ 
+ #define to_acpi_device_node(__fwnode)					\
+@@ -422,11 +417,6 @@ static inline bool is_acpi_device_node(const struct fwnode_handle *fwnode)
+ 			NULL;						\
+ 	})
+ 
+-static inline bool is_acpi_data_node(const struct fwnode_handle *fwnode)
+-{
+-	return !IS_ERR_OR_NULL(fwnode) && fwnode->ops == &acpi_data_fwnode_ops;
+-}
+-
+ #define to_acpi_data_node(__fwnode)					\
+ 	({								\
+ 		typeof(__fwnode) __to_acpi_data_node_fwnode = __fwnode;	\
+-- 
+2.14.1
+
+  
\ No newline at end of file

From 541b36c511e715c2169ec625c2eff35f04677552 Mon Sep 17 00:00:00 2001
From: MilhouseVH <milhouseVH.github@nmacleod.com>
Date: Thu, 21 Sep 2017 04:35:39 +0100
Subject: [PATCH 6/7] xf86-video-nvidia: add fix for kernel 4.14.0 and 384.69

---
 .../xf86-video-nvidia-001-fix-4.14.0-kernel.patch  | 59 ++++++++++++++++++++++
 1 file changed, 59 insertions(+)
 create mode 100644 packages/x11/driver/xf86-video-nvidia/patches/xf86-video-nvidia-001-fix-4.14.0-kernel.patch

diff --git a/packages/x11/driver/xf86-video-nvidia/patches/xf86-video-nvidia-001-fix-4.14.0-kernel.patch b/packages/x11/driver/xf86-video-nvidia/patches/xf86-video-nvidia-001-fix-4.14.0-kernel.patch
new file mode 100644
index 00000000000..8111c6cea40
--- /dev/null
+++ b/packages/x11/driver/xf86-video-nvidia/patches/xf86-video-nvidia-001-fix-4.14.0-kernel.patch
@@ -0,0 +1,59 @@
+diff --git a/kernel/nvidia-drm/nvidia-drm-crtc.c b/kernel/nvidia-drm/nvidia-drm-crtc.c
+index 4d9bdf3..e2f4f46 100644
+--- a/kernel/nvidia-drm/nvidia-drm-crtc.c
++++ b/kernel/nvidia-drm/nvidia-drm-crtc.c
+@@ -162,7 +162,8 @@ static void nvidia_crtc_disable(struct drm_crtc *crtc)
+ 
+ }
+ 
+-static void nvidia_crtc_enable(struct drm_crtc *crtc)
++static void nvidia_crtc_enable(struct drm_crtc *crtc,
++                               struct drm_crtc_state *old_state)
+ {
+ 
+ }
+@@ -170,7 +171,7 @@ static void nvidia_crtc_enable(struct drm_crtc *crtc)
+ static const struct drm_crtc_helper_funcs nv_crtc_helper_funcs = {
+     .prepare    = nvidia_crtc_prepare,
+     .commit     = nvidia_crtc_commit,
+-    .enable     = nvidia_crtc_enable,
++    .atomic_enable     = nvidia_crtc_enable,
+     .disable    = nvidia_crtc_disable,
+     .mode_fixup = nvidia_crtc_mode_fixup,
+ };
+@@ -223,10 +224,9 @@ static struct drm_plane *nvidia_plane_create
+         dev,
+         plane, crtc_mask, funcs,
+         formats, formats_count,
++        NULL,
+         plane_type
+-#if defined(NV_DRM_INIT_FUNCTIONS_HAVE_NAME_ARG)
+         , NULL
+-#endif
+         );
+ 
+     if (ret != 0)
+@@ -354,9 +354,7 @@ struct drm_crtc *nvidia_drm_add_crtc(struct drm_device *dev, NvU32 head)
+                                     &nv_crtc->base,
+                                     primary_plane, cursor_plane,
+                                     &nv_crtc_funcs
+-#if defined(NV_DRM_INIT_FUNCTIONS_HAVE_NAME_ARG)
+                                     , NULL
+-#endif
+                                     );
+ 
+     if (ret != 0)
+diff --git a/kernel/nvidia-drm/nvidia-drm-encoder.c b/kernel/nvidia-drm/nvidia-drm-encoder.c
+index 9d3a267..512182c 100644
+--- a/kernel/nvidia-drm/nvidia-drm-encoder.c
++++ b/kernel/nvidia-drm/nvidia-drm-encoder.c
+@@ -150,9 +150,7 @@ nvidia_encoder_new(struct drm_device *dev,
+     ret = drm_encoder_init(dev,
+                            &nv_encoder->base, &nv_encoder_funcs,
+                            nvkms_connector_signal_to_drm_encoder_signal(format)
+-#if defined(NV_DRM_INIT_FUNCTIONS_HAVE_NAME_ARG)
+                            , NULL
+-#endif
+                            );
+ 
+     if (ret != 0)

From cb4dde0c1c2be3a62eae6b384f2020f427f58e35 Mon Sep 17 00:00:00 2001
From: MilhouseVH <milhouseVH.github@nmacleod.com>
Date: Thu, 21 Sep 2017 04:35:39 +0100
Subject: [PATCH 7/7] xf86-video-nvidia-legacy: add fix for kernel 4.14.0 and
 340.104

---
 ...xf86-video-nvidia-legacy-0010-kernel-4.14.patch | 37 ++++++++++++++++++++++
 1 file changed, 37 insertions(+)
 create mode 100644 packages/x11/driver/xf86-video-nvidia-legacy/patches/xf86-video-nvidia-legacy-0010-kernel-4.14.patch

diff --git a/packages/x11/driver/xf86-video-nvidia-legacy/patches/xf86-video-nvidia-legacy-0010-kernel-4.14.patch b/packages/x11/driver/xf86-video-nvidia-legacy/patches/xf86-video-nvidia-legacy-0010-kernel-4.14.patch
new file mode 100644
index 00000000000..9aae52c82c2
--- /dev/null
+++ b/packages/x11/driver/xf86-video-nvidia-legacy/patches/xf86-video-nvidia-legacy-0010-kernel-4.14.patch
@@ -0,0 +1,37 @@
+From 5c9e8a994fe8529388ab159e0aa371c75bc3d17b Mon Sep 17 00:00:00 2001
+From: MilhouseVH <milhouseVH.github@nmacleod.com>
+Date: Thu, 21 Sep 2017 04:22:12 +0100
+Subject: [PATCH] drm/pci: drm_pci_init/exit now deprecated
+
+As per: https://github.com/torvalds/linux/commit/10631d724deff712343d96dd3017cd323349f761
+
+Use legacy variant, as pci_[un]register_driver currently fails.
+---
+ kernel/nv-drm.c | 4 ++--
+ 1 file changed, 2 insertions(+), 2 deletions(-)
+
+diff --git a/kernel/nv-drm.c b/kernel/nv-drm.c
+index 2aa7cc8..23df996 100644
+--- a/kernel/nv-drm.c
++++ b/kernel/nv-drm.c
+@@ -173,7 +173,7 @@ int __init nv_drm_init(
+ {
+     int ret = 0;
+ #if defined(NV_DRM_AVAILABLE)
+-    ret = drm_pci_init(&nv_drm_driver, pci_driver);
++    ret = drm_legacy_pci_init(&nv_drm_driver, pci_driver);
+ #endif
+     return ret;
+ }
+@@ -183,7 +183,7 @@ void nv_drm_exit(
+ )
+ {
+ #if defined(NV_DRM_AVAILABLE)
+-    drm_pci_exit(&nv_drm_driver, pci_driver);
++    drm_legacy_pci_exit(&nv_drm_driver, pci_driver);
+ #endif
+ }
+ 
+-- 
+2.7.4
+
